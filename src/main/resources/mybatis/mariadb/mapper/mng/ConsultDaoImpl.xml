<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : SiteApplyDaoImpl.xml
	Description : 사이트 신청 관리
-->
<mapper namespace="com.kbrainc.plum.mng.consult.model.ConsultDao">

    <!-- 기관정보 목록 조회 -->
    <select id="selectConsultList" parameterType="ConsultVo" resultType="ConsultVo">
        /* ConsultDao.selectConsultList */
        <include refid="PaginationMapper.header"/>
                SELECT 
                   A.CNSLTNGID
                   ,A.INSTID
                   ,A.USERID
                   ,A.USER_NM
                   ,A.PRGRM_NM
                   ,A.CNSLTNG_KND_CD
                   ,A.HOPE_DE1
                   ,A.HOPE_DE1_AM_PM_CD
                   ,A.HOPE_DE2
                   ,A.HOPE_DE2_AM_PM_CD
                   ,A.PRGRM
                   ,A.LDR
                   ,A.SFTYMNG
                   ,A.ETC
                   ,A.FILEGRPID
                   ,A.CNSTNTID
                   ,A.STTS_CD
                   ,A.SRVYID
                   ,A.MDFCN_DT
                   ,A.MDFRID
                   ,A.REG_DT
                   ,A.RGTRID
                   ,B.INST_NM  AS instnm
                   ,C.NM AS cnsltngNm
                   ,D.VST_DE +' '+D.VST_BGNG_DT+'~'+D.VST_END_DT AS visitDt
                  FROM
                    TB_ASS_CNSLTNG A
                    INNER JOIN TB_CMM_INST B
                    ON A.INSTID = B.INSTID 
                    INNER JOIN TB_CMM_USER C
                    ON A.CNSLTNGID = A.USERID
                    LEFT OUTER JOIN TB_ASS_CNSLTNG_RSLT D
                    ON A.CNSLTNGID  =D.CNSLTNGID 
                 WHERE 1=1
                <if test="searchKeyword != null and searchKeyword != '' and searchType == 'instNm'">
                   AND A.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
                </if>
                <if test="searchKeyword != null and searchKeyword != '' and searchType == 'domn'">
                   AND A.DOMN LIKE CONCAT('%',#{searchKeyword},'%')
                </if>
                <if test="searchKeyword != null and searchKeyword != '' and searchType == 'instCd'">
                   AND B.INST_CD LIKE CONCAT('%',#{searchKeyword},'%')
                </if>
                <if test="searchAplySttsCd != null and searchAplySttsCd != '' ">
                   AND A.APLY_STTS_CD = #{searchAplySttsCd}
                </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 사이트 신청 정보 상세 조회 -->
    <select id="selectConsultInfo" parameterType="ConsultVo" resultType="ConsultVo">
           /* ConsultDao.selectConsultInfo */
               SELECT 
                A.APLYID
                ,A.INSTID
                ,A.INST_NM
                ,A.INST_CNTCT
                ,A.INST_EML
                ,A.USERID
                ,D.NM AS APLCNT_NM
                ,A.ZIP
                ,A.ADDR
                ,A.ADDR_DTL
                ,A.DOMN
                ,A.CN
                ,A.CPYRHT
                ,A.APLY_DT
                ,A.APLY_STTS_CD
                ,A.AUTZRID
                ,A.LOGO_FILEID
                ,A.MDFCN_DT
                ,A.MDFRID
                ,A.REG_DT
                ,A.RGTRID
                ,B.INST_CD 
                ,C.FILE_IDNTFC_KEY
              FROM 
                TB_CMM_SITE_APLY A
                INNER JOIN TB_CMM_INST B
                ON A.INSTID = B.INSTID
                LEFT OUTER JOIN TB_CMM_FILE C
                ON A.LOGO_FILEID = C.FILEID
                INNER JOIN TB_CMM_USER D
                ON A.USERID = D.USERID 
              WHERE 1=1    
                AND A.APLYID = #{aplyid}  
    </select>
    
    <!-- 신청 승인 상태 수정--> 
    <update id="updateConsultStatus" parameterType="ConsultVo" >
         /* ConsultDao.updateSiteApplyStatus */
        UPDATE TB_CMM_SITE_APLY 
           SET
               APLY_STTS_CD       = #{aplySttsCd}                     
               ,AUTZRID           = #{user.userid}                         
               ,MDFCN_DT          = NOW()                         
               ,MDFRID            = #{user.userid}                
         WHERE 1=1
           AND APLYID = #{aplyid}
    </update>
    
            
        
</mapper>