<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : LendDaoImpl.xml
	Description : 교구관리 
-->
<mapper namespace="com.kbrainc.plum.mng.lend.model.LendDao">

   <!-- 대여 목록 호출 --> 
   <select id="selectLendList" parameterType="LendVo" resultType="LendVo">
          /* LendDao.selectLendList */
          <include refid="PaginationMapper.header"/>
              SELECT 
                   A.RCRITID
                  ,A.RCRIT_NM
                  ,A.BGNG_DT
                  ,A.END_DT
                  ,A.LMT_CD
                  ,A.PACKAGEID
                  ,A.DTL_CN
                  ,A.MVP_URL
                  ,A.MVP_PSTN_CD
                  ,A.ATENT_MTTR
                  ,A.RPRS_IMG_FILEID
                  ,A.DTL_IMG_FILEGRPID
                  ,A.MAP_FILEGRPID
                  ,A.EDU_PHOTO_FILEGRPID
                  ,A.OPER_YN
                  ,A.MDFCN_DT
                  ,A.MDFRID
                  ,A.REG_DT
                  ,A.RGTRID
                  ,B.ACNT AS RGTR_ACNT
               FROM 
                 TB_THA_PACKAGE_LEND_RCRIT A
                 INNER JOIN TB_CMM_USER B
                 ON A.RGTRID = B.USERID
              WHERE 1=1 
           <if test="searchKeyword != null and searchKeyword != '' and searchType == 'lendNm'">
              AND RCRIT_NM LIKE CONCAT('%',#{searchKeyword},'%')
           </if>
           <if test="searchKeyword != null and searchKeyword != '' and searchType == 'lendNo'">
              AND RCRITID = #{searchKeyword}
           </if>
           <if test="searchStartDt != null and searchStartDt != '' ">
              AND date_format(BGNG_DT, '%Y-%m-%d'  )  <![CDATA[>=]]> #{searchStartDt}
           </if>
           
           <if test="searchEndDt != null and searchEndDt != '' ">
              AND date_format(END_DT, '%Y-%m-%d'  )  <![CDATA[<=]]> #{searchEndDt}
           </if>
         <include refid="PaginationMapper.footer"/>
   </select>
   <!-- 대여 등록-->
   <insert id="insertLend" parameterType="LendVo" useGeneratedKeys="true" keyProperty="rcritid" >
        /* LendDao.insertLend */
        INSERT INTO TB_THA_PACKAGE_LEND_RCRIT (
            RCRIT_NM                   
            ,BGNG_DT                    
            ,END_DT                     
            ,PACKAGEID                     
            ,LMT_CD                     
            ,DTL_CN                     
            ,MVP_URL                    
            ,MVP_PSTN_CD                
            ,ATENT_MTTR                 
            ,RPRS_IMG_FILEID            
            ,DTL_IMG_FILEGRPID          
            ,MAP_FILEGRPID              
            ,EDU_PHOTO_FILEGRPID        
            ,OPER_YN        
            ,MDFCN_DT                   
            ,MDFRID                     
            ,REG_DT                     
            ,RGTRID                     
        )VALUES(                 
            #{rcritNm           }        
            ,#{bgngDt            }        
            ,#{endDt             }        
            ,#{packageid         }        
            ,#{lmtCd             }        
            ,#{dtlCn             }        
            ,#{mvpUrl            }        
            ,#{mvpPstnCd         }        
            ,#{atentMttr         }        
            ,#{rprsImgFileid     }        
            ,#{dtlImgFilegrpid   }        
            ,#{mapFilegrpid      }        
            ,#{eduPhotoFilegrpid }
            ,#{operYn }
            ,NOW()
            ,#{user.userid       }
            ,NOW()
            ,#{user.userid       }
        )
   </insert>
   <!-- 대여 차시 등록-->
   <insert id="insertLendRnd" parameterType="LendRndVo" useGeneratedKeys="true" keyProperty="rndid" >
        /* LendDao.insertLendRnd */
        INSERT INTO TB_THA_PACKAGE_LEND_RND (
            RCRITID       
            ,ORDR          
            ,BGNG_DE       
            ,END_DE        
            ,QNTY        
            ,MDFCN_DT      
            ,MDFRID        
            ,REG_DT        
            ,RGTRID                             
        )VALUES(
             #{rcritid    }       
            ,#{ordr       }    
            ,#{bgngDe     }    
            ,#{endDe      }
            ,#{qnty       }
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
        )
   </insert>
   <!-- 대여 차시 꾸러미 등록-->
   <insert id="insertRndPackageindvd" parameterType="LendRndVo"  >
        /* LendDao.insertTchaid */
        INSERT INTO TB_THA_PACKAGE_LEND_RND_PACKAGEINDVD (
             RNDID
            ,PACKAGEINDVDID
            ,REG_DT        
            ,RGTRID                             
        )VALUES
        <foreach item="item" collection="lendRndPackageindvdids" separator=",">
         (
            #{rndid    }
           ,#{item        }
           ,NOW()
           ,#{user.userid }
          )
        </foreach>
   </insert>
   <!-- 대여 수정 -->
   <update id="udateLend" parameterType="LendVo" >
        /* LendDao.udateLend */
        UPDATE TB_THA_PACKAGE_LEND_RCRIT 
           SET
           <if test="rcritNm != null and rcritNm != ''">
            RCRIT_NM             =  #{rcritNm           },             
           </if>
           <if test='bgngDt != null '>
            BGNG_DT              =  #{bgngDt            },             
            </if>             
           <if test='endDt != null '>
            END_DT               =  #{endDt             },             
            </if>             
           <if test="lmtCd != null and lmtCd != ''">
            LMT_CD               =  #{lmtCd             },             
            </if>             
           <if test="packageid != null and packageid != ''">
            PACKAGEID            =  #{packageid         },             
            </if>             
           <if test="dtlCn != null and dtlCn != ''">
            DTL_CN               =  #{dtlCn             },             
            </if>             
           <if test="mvpUrl != null and mvpUrl != ''">
            MVP_URL              =  #{mvpUrl            },             
            </if>             
           <if test="mvpPstnCd != null and mvpPstnCd != ''">
            MVP_PSTN_CD          =  #{mvpPstnCd         },             
            </if>             
           <if test="atentMttr != null and atentMttr != ''">
            ATENT_MTTR           =  #{atentMttr         },             
            </if>             
           <if test="rprsImgFileid != null and rprsImgFileid != ''">
            RPRS_IMG_FILEID      =  #{rprsImgFileid     },             
            </if>             
           <if test="dtlImgFilegrpid != null and dtlImgFilegrpid != ''">
            DTL_IMG_FILEGRPID    =  #{dtlImgFilegrpid   },             
            </if>             
           <if test="mapFilegrpid != null and mapFilegrpid != ''">
            MAP_FILEGRPID        =  #{mapFilegrpid      },             
            </if>             
           <if test="eduPhotoFilegrpid != null and eduPhotoFilegrpid != ''">
            EDU_PHOTO_FILEGRPID  =  #{eduPhotoFilegrpid },
            </if>             
           <if test="operYn != null and operYn != ''">
            OPER_YN  =  #{operYn },
            </if>             
            MDFCN_DT             =  NOW()                ,             
            MDFRID               =  #{user.userid       }
       WHERE RCRITID = #{rcritid}             
   </update>
   <!-- 대여 삭제 -->
   <update id="deleteLend" parameterType="LendVo" >
        /* LendDao.udateLend */
        DELETE FROM  TB_THA_PACKAGE_LEND_RCRIT
        WHERE RCRITID IN(
            <foreach item="rcritid" collection="deleteIds" separator=",">
               #{rcritid}
            </foreach>
        ) 
   </update>
   <!-- 대여 차시 삭제 -->
   <update id="deleteLendRnd" parameterType="LendRndVo" >
        /* LendDao.deleteLendRnd */
        DELETE FROM  TB_THA_PACKAGE_LEND_RND
        WHERE  RCRITID IN(
            <foreach item="rcritid" collection="deleteIds" separator=",">
               #{rcritid}
            </foreach>
        ) 
   </update>
   <!-- 대여 차시 꾸러미 일괄 삭제 -->
   <update id="deleteLendRndPackageindvd" parameterType="LendRndVo" >
        /* LendDao.deleteLendRndPackageindvd */
        DELETE FROM  TB_THA_PACKAGE_LEND_RND_PACKAGEINDVD
        WHERE RNDID IN(
                   SELECT RNDID FROM TB_THA_PACKAGE_LEND_RND WHERE  RCRITID IN(
                    <foreach item="rcritid" collection="deleteIds" separator=",">
                       #{rcritid}
                    </foreach>
                   ) 
              )
   </update>
   
   <!-- 대여 상세 정보  --> 
   <select id="selectLend" parameterType="LendVo" resultType="LendVo">
        /* LendDao.selectLend */
             SELECT 
                 A.RCRITID
                 ,A.RCRIT_NM
                 ,A.BGNG_DT
                 ,A.PACKAGEID
                 ,A.END_DT
                 ,A.LMT_CD
                 ,A.DTL_CN
                 ,A.MVP_URL
                 ,A.MVP_PSTN_CD
                 ,A.ATENT_MTTR
                 ,IFNULL(A.RPRS_IMG_FILEID,0) RPRS_IMG_FILEID 
                 ,A.DTL_IMG_FILEGRPID
                 ,A.MAP_FILEGRPID
                 ,A.EDU_PHOTO_FILEGRPID
                 ,A.OPER_YN
                 ,A.MDFCN_DT
                 ,A.MDFRID
                 ,A.REG_DT
                 ,A.RGTRID
                 ,B.TYPE_CD 
                 ,B.EDU_TYPE_CD
                 ,B.PACKAGE_NM 
                 ,B.TEAM_CMPSTN_CD
                 ,C.EDU_SBJCT_CD
                 ,C.EDU_SBJCT_CD_NM
                 ,D.EDU_TRGT_CD
                 ,D.EDU_TRGT_CD_NM
               FROM 
                 TB_THA_PACKAGE_LEND_RCRIT A
                 INNER JOIN TB_THA_PACKAGE B
                 ON A.PACKAGEID = B.PACKAGEID
                 INNER JOIN (
                     SELECT
                        A.PACKAGEID
                        ,CONCAT(D.CD_NM ,'-',GROUP_CONCAT(C.CD_NM)) EDU_SBJCT_CD_NM 
                        ,GROUP_CONCAT(C.CD) EDU_SBJCT_CD 
                      FROM 
                        TB_THA_PACKAGE A 
                        INNER JOIN TB_THA_PACKAGE_EDU_SBJCT_MAPNG B
                        ON A.PACKAGEID = B.PACKAGEID
                        INNER JOIN  TB_CMM_CD C
                        ON B.EDU_SBJCT_CD = C.CD
                        INNER JOIN  TB_CMM_CD D
                        ON C.UPPR_CD  = D.CD
                        GROUP BY A.PACKAGEID
                 ) C
                 ON B.PACKAGEID = C.PACKAGEID
                 INNER JOIN (
                    SELECT
                          A.PACKAGEID 
                         ,GROUP_CONCAT(C.CD_NM) EDU_TRGT_CD_NM 
                         ,GROUP_CONCAT(C.CD) EDU_TRGT_CD 
                      FROM 
                        TB_THA_PACKAGE A 
                        INNER JOIN TB_THA_PACKAGE_EDU_TRGT_MAPNG B
                        ON A.PACKAGEID = B.PACKAGEID
                        INNER JOIN  TB_CMM_CD C
                        ON B.EDU_TRGT_CD  = C.CD
                        GROUP BY A.PACKAGEID
                 ) D
                 ON B.PACKAGEID = D.PACKAGEID
              WHERE 1=1
                AND RCRITID = #{rcritid}
   </select>
   
   <!-- 대여 차시 상세 리스트  --> 
   <select id="selectLendRndList" parameterType="LendRndVo" resultType="LendRndVo">
        /* LendDao.selectLendRndList */
        SELECT 
            A.RNDID
            ,A.RCRITID
            ,A.ORDR
            ,A.BGNG_DE
            ,A.END_DE 
            ,A.QNTY 
            ,A.MDFCN_DT
            ,A.MDFRID
            ,A.REG_DT
            ,A.RGTRID
            ,IFNULL(C.totalCnt,0) totalCnt 
         FROM 
           TB_THA_PACKAGE_LEND_RND A
           INNER JOIN TB_THA_PACKAGE_LEND_RCRIT B
           ON A.RCRITID = B.RCRITID 
           LEFT OUTER JOIN (
                SELECT
                    A.PACKAGEID 
                    ,count(PACKAGEINDVDID) totalCnt
                  FROM 
                    TB_THA_PACKAGEINDVD A
                   GROUP BY A.PACKAGEID
           ) C ON B.PACKAGEID = C.PACKAGEID
        WHERE 1=1  
          AND A.RCRITID = #{rcritid}
          ORDER BY ORDR ASC
   </select>
   
   <!-- 대여 차시 꾸러미 상세 리스트  --> 
   <select id="selectLendRndPackageindvdList" parameterType="LendRndVo" resultType="LendRndPackageindvdVo">
        /* LendDao.selectLendList */
       SELECT
            A.RNDID
           ,A.PACKAGEINDVDID
           ,A.REG_DT
           ,A.RGTRID
           ,B.PACKAGEINDVD_NM 
           ,B.INDVDNO 
         FROM 
           TB_THA_PACKAGE_LEND_APLY_DLIVY A
           INNER JOIN TB_THA_PACKAGEINDVD B
           ON A.PACKAGEINDVDID =B.PACKAGEINDVDID 
        WHERE 1=1 
          AND A.RNDID = #{rndid}
   </select>
   <!-- 꾸러미 개체 호출 --> 
   <select id="selectPackageindvdList" parameterType="PackageindvdVo" resultType="PackageindvdVo">
          /* PackageDao.selectPackageindvdList */
          <include refid="PaginationMapper.header"/>
             SELECT 
                 A.PACKAGEINDVDID
                 ,A.INDVDNO
                 ,A.PACKAGEINDVD_NM
                 ,A.PACKAGEID
                 ,A.STTS_CD
                 ,A.PRDUCT_STTS_CD
                 ,A.USE_YN
                 ,A.MDFCN_DT
                 ,A.MDFRID
                 ,A.REG_DT
                 ,A.RGTRID
                 ,B.NM  AS REG_NM
                 ,C.TYPE_CD 
                 ,C.EDU_TYPE_CD  
                 ,E.DLIVY_PRCS_DT
                 ,F.END_DE 
               FROM 
                 TB_THA_PACKAGEINDVD A
                 INNER JOIN TB_CMM_USER B
                 ON A.RGTRID = B.USERID 
                 INNER JOIN TB_THA_PACKAGE C
                 ON A.PACKAGEID = C.PACKAGEID
                 LEFT OUTER JOIN (
                   SELECT 
                       A.PACKAGEINDVDID
                       ,IFNULL(MAX(A.RNDID),0) AS RNDID
                     FROM       
                       TB_THA_PACKAGE_LEND_APLY_DLIVY A
                       GROUP BY A.PACKAGEINDVDID
                 ) D
                 ON A.PACKAGEINDVDID = D.PACKAGEINDVDID
                 LEFT OUTER  JOIN TB_THA_PACKAGE_LEND_APLY_DLIVY E
                 ON E.RNDID = D.RNDID
                 LEFT OUTER  JOIN TB_THA_PACKAGE_LEND_RND F
                 ON E.RNDID = F.RNDID      
            WHERE 1=1
          <if test="searchKeyword != null and searchKeyword != '' and searchType == 'nm'">
              AND A.PACKAGEINDVD_NM LIKE CONCAT('%',#{searchKeyword},'%')
           </if>
           <if test="searchTypeCd != null and searchTypeCd != '' ">
              AND C.TYPE_CD = #{searchTypeCd}
           </if>
           <if test="searchEduTypeCd != null and searchEduTypeCd != '' ">
              AND C.EDU_TYPE_CD = #{searchEduTypeCd}
           </if>
           <if test="searchSttsCd != null and searchSttsCd != '' ">
              AND A.STTS_CD = #{searchSttsCd}
           </if>
         <include refid="PaginationMapper.footer"/>
   </select>
   <!-- 꾸러미 개체 대여 신청여부 확인  --> 
   <select id="selectLendApplyYn" parameterType="LendRndVo" resultType="String">
             /* PackageDao.selectLendApplyYn */
              SELECT
                 CASE 
                   WHEN COUNT(A.APLYID) > 0 THEN 'Y'
                   ELSE 'N'
                 END AS ISAPLLYED
              FROM
                TB_THA_PACKAGE_LEND_APLY A
                INNER JOIN TB_THA_PACKAGE_LEND_RND B
                ON A.RNDID = B.RNDID 
                INNER JOIN TB_THA_PACKAGE_LEND_RCRIT C
                ON B.RCRITID = C.RCRITID
                WHERE D.RCRITID  IN(
                    <foreach item="rcritid" collection="deleteIds" separator=",">
                       #{rcritid}
                    </foreach>
                ) 
  </select>
  <!-- 꾸러미 목록 호출 --> 
  <select id="selectPackageList" parameterType="PackageVo" resultType="PackageVo">
          /* PackageDao.selectPackageList */
          SELECT
                A.PACKAGEID
               ,A.PACKAGE_NM
               ,A.TYPE_CD
               ,A.EDU_TYPE_CD
               ,A.TEAM_CMPSTN_CD
               ,A.MDFCN_DT
               ,A.MDFRID
               ,A.REG_DT
               ,A.RGTRID
               ,B.packageindvdCnt
            FROM 
               TB_THA_PACKAGE A
               LEFT OUTER JOIN (
                   SELECT 
                        PACKAGEID
                        ,COUNT(PACKAGEID) packageindvdCnt
                     FROM 
                        TB_THA_PACKAGEINDVD
                     GROUP BY PACKAGEID
               ) B 
               ON A.PACKAGEID = B.PACKAGEID
           WHERE 1=1
            <if test='packageid != null and packageid != ""'>
             AND A.PACKAGEID = #{packageid}
            </if>
  </select>
  <!-- 꾸러미 대여 중복 체크 --> 
  <select id="checkPackageDuplicationYn" parameterType="LendVo" resultType="String">
          /* PackageDao.checkPackageDuplicationYn */
            SELECT
               IFNULL(MAX( CASE WHEN (C.BGNG_DE <![CDATA[>=]]> A.BGNG_DE AND C.BGNG_DE <![CDATA[<=]]> A.END_DE)
                                 OR (C.END_DE  <![CDATA[>=]]> A.BGNG_DE AND C.END_DE  <![CDATA[<=]]> A.END_DE)
                                 THEN 'Y'
                            ELSE 'N'
                     END),'N')  AS ISDUPLICATE
            FROM
              TB_THA_PACKAGE_LEND_RND A
              INNER JOIN TB_THA_PACKAGE_LEND_RCRIT B
              ON A.RCRITID = B.RCRITID
              INNER JOIN (
              <foreach item="item" collection="lendRndList" separator="UNION ALL">
                 SELECT
                    #{packageid} PACKAGEID
                    ,#{item.bgngDe} BGNG_DE
                    ,#{item.endDe} END_DE
              </foreach>
              ) C
              ON B.PACKAGEID = C.PACKAGEID 
           WHERE 1=1
             AND B.PACKAGEID = #{packageid}
            <if test='rcritid != null and rcritid != ""'>
             AND B.RCRITID <![CDATA[<>]]> #{rcritid}
            </if>
   </select>
   
  <!--****** 꾸러미 대여 신청 관리**********--> 
  <!-- 대여 신청 목록 호출 --> 
  <select id="selectLendAplyList" parameterType="LendAplyVo" resultType="LendAplyVo">
          /* LendDao.selectLendAplyList */
          <include refid="PaginationMapper.header"/>
            SELECT
               A.APLYID
               ,D.INST_NM 
               ,E.NM  AS APLCNT_NM
               ,A.APLCNTID
               ,A.TELNO 
               ,A.EML 
               ,C.RCRIT_NM 
               ,C.BGNG_DT 
               ,C.END_DT
               ,C.RCRITID 
               ,A.PACKAGEID 
               ,B.RNDID 
               ,B.ORDR  
               ,A.QNTY 
               ,A.LEND_BGNG_DE 
               ,A.LEND_END_DE
               ,A.STTS_CD
               ,A.DLVY_STTS_CD 
               ,A.REG_DT
               ,A.DLVY_ZIP 
               ,A.DLVY_ADDR 
               ,A.DLVY_ADDR_DTL 
               ,A.RVW_SCR 
               ,A.RVW_CN 
               ,A.RVW_REG_DT 
               ,G.WRHOUSNG_CNT
               ,A.INSTID 
               ,F.PACKAGE_NM
               ,H.DLIVY_PRCS_DT
               ,H.WRHOUSNG_PRCS_DT
             FROM
               TB_THA_PACKAGE_LEND_APLY A
               INNER JOIN TB_THA_PACKAGE_LEND_RND B
               ON A.RNDID = B.RNDID
               INNER JOIN TB_THA_PACKAGE_LEND_RCRIT C
               ON B.RCRITID = C.RCRITID
               INNER JOIN TB_CMM_INST D
               ON A.INSTID  = D.INSTID 
               INNER JOIN TB_CMM_USER E
               ON A.APLCNTID  = E.USERID  
               INNER JOIN TB_THA_PACKAGE F
               ON A.PACKAGEID = F.PACKAGEID
               LEFT OUTER JOIN (
                       SELECT
                       A.RNDID
                       ,(A.QNTY -  IFNULL(B.RESERVATION_CNT,0)) AS WRHOUSNG_CNT
                     FROM
                       TB_THA_PACKAGE_LEND_RND A
                       LEFT OUTER JOIN(
                           SELECT 
                               A.RNDID -- 차시 아이디
                               , IFNULL(SUM(A.QNTY),0) AS RESERVATION_CNT
                             FROM 
                               TB_THA_PACKAGE_LEND_APLY A
                            WHERE 1=1 
                              AND A.STTS_CD = '231102'
                              GROUP BY A.RNDID
                       ) B
                       ON A.RNDID = B.RNDID
              ) G
              ON A.RNDID = G.RNDID
              LEFT OUTER JOIN TB_THA_PACKAGE_LEND_APLY_DLIVY H
              ON H.APLYID = A.APLYID
            WHERE 1=1
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'nm'">
               AND E.NM  LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'instNm'">
               AND D.INST_NM   LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'email'">
               AND A.EML   LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'addr'">
               AND (A.DLVY_ADDR   LIKE CONCAT('%',#{searchKeyword},'%') or A.DLVY_ADDR_DTL   LIKE CONCAT('%',#{searchKeyword},'%') )
            </if>
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'package'">
               AND F.PACKAGE_NM  LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchRcritid != null and searchRcritid != '' ">
               AND C.RCRITID = #{searchRcritid}
            </if>
            <if test="searchPackageid != null and searchPackageid != '' ">
               AND A.PACKAGEID = #{searchPackageid}
            </if>
            <if test="searchSttsCd != null and searchSttsCd != '' ">
               AND A.STTS_CD = #{searchSttsCd}
            </if>
            <if test="searchDlvySttsCd != null and searchDlvySttsCd != '' ">
                <choose>
                    <when test='searchDlvySttsCd == "none"'>
                     AND A.DLVY_STTS_CD IS NULL     
                    </when>
                    <otherwise>
                     AND A.DLVY_STTS_CD = #{searchDlvySttsCd}     
                    </otherwise>
                </choose>
            </if>
            <if test="searchStrtDt != null and searchStrtDt != '' ">
               AND A.LEND_BGNG_DE  <![CDATA[>=]]> #{searchStrtDt}
            </if>
            <if test="searchEndDt != null and searchEndDt != '' ">
               AND A.LEND_END_DE  <![CDATA[<=]]> #{searchEndDt}
            </if>
            <if test="searchRndid != null and searchRndid != '' ">
               AND B.RNDID = #{searchRndid}
            </if>

          <include refid="PaginationMapper.footer"/>
    </select>
    <!-- 대여 모집 목록 호출 -->
    <select id="selectLendRcritList" parameterType="LendVo" resultType="LendVo">
          /* PackageDao.selectLendRcritList */
          SELECT  
              RCRITID
              ,RCRIT_NM
              ,PACKAGEID
              ,BGNG_DT
              ,END_DT
              ,LMT_CD
              ,DTL_CN
              ,MVP_URL
              ,MVP_PSTN_CD
              ,ATENT_MTTR
              ,RPRS_IMG_FILEID
              ,DTL_IMG_FILEGRPID
              ,MAP_FILEGRPID
              ,EDU_PHOTO_FILEGRPID
              ,OPER_YN
              ,MDFCN_DT
              ,MDFRID
              ,REG_DT
              ,RGTRID
            FROM 
              TB_THA_PACKAGE_LEND_RCRIT
    </select>
    <!-- 대여 신청 재고 및 차시 별 수량 등 체크  -->
    <select id="checkRndStockOver" parameterType="LendAplyVo" resultType="map">
      /* PackageDao.selectLendRcritList */
      WITH RND_LIMIT_CNT AS (
             SELECT 
                 B.RNDID 
                 ,CASE WHEN LMT_CD = ('225101' OR '225102') THEN 1
                       ELSE 2
                  END RND_LIMIT
                 ,CASE WHEN LMT_CD = ('225101' OR '225103') THEN 1
                       ELSE 2
                  END PACKAGEINDVD_LIMIT
                 ,SUM(CASE WHEN C.STTS_CD = '231102' THEN C.QNTY 
                        ELSE 0
                  END) AS RESERVATION_CNT
                 ,B.QNTY AS TOTAL_CNT
               FROM 
                TB_THA_PACKAGE_LEND_RCRIT A
                INNER JOIN  TB_THA_PACKAGE_LEND_RND B
                ON A.RCRITID = B.RCRITID 
                INNER JOIN TB_THA_PACKAGE_LEND_APLY C
                ON B.RNDID = C.RNDID 
              WHERE 1=1
                AND B.RNDID IN (SELECT RNDID FROM TB_THA_PACKAGE_LEND_APLY WHERE APLYID IN(
                    <foreach item="item" collection="aplyids" separator=",">
                       #{item}
                    </foreach>
                   ))
                GROUP BY B.RNDID
             )
             , RND_REQUEST_CHEKC AS(
                SELECT 
                     A.RNDID  AS RNDID
                     ,SUM(IFNULL(A.QNTY,0)) AS REQUESTQNTY
                     ,B.QNTY 
                     ,GROUP_CONCAT( A.APLYID ) APLYIDS
                     ,C.TOTAL_CNT
                     ,C.TOTAL_CNT - C.RESERVATION_CNT AS RESERVED_CNT
                   FROM
                     TB_THA_PACKAGE_LEND_APLY A
                     INNER JOIN TB_THA_PACKAGE_LEND_RND B
                     ON A.RNDID = B.RNDID
                     LEFT OUTER JOIN RND_LIMIT_CNT C
                     ON A.RNDID = C.RNDID 
                  WHERE 1=1 
                    AND A.APLYID IN (
                        <foreach item="item" collection="aplyids" separator=",">
                           #{item}
                        </foreach>
                    )
                    AND A.STTS_CD = '231101'
                  GROUP BY RNDID      
              )
             , INST_REQUEST_CHECK AS(
                 SELECT 
                     A.RNDID  
                     ,A.INSTID
                     ,SUM(IFNULL(A.QNTY,0)) AS REQUESTQNTY
                     ,B.QNTY 
                     ,GROUP_CONCAT( A.APLYID ) APLYIDS
                     ,C.TOTAL_CNT - C.RESERVATION_CNT AS RESERVED_CNT
                     ,C.PACKAGEINDVD_LIMIT
                     ,IFNULL((SELECT SUM(QNTY) FROM TB_THA_PACKAGE_LEND_APLY WHERE STTS_CD = '231102' AND RNDID = B.RNDID AND A.INSTID = INSTID),0) AS INST_RESERVATION_CNT
                   FROM
                     TB_THA_PACKAGE_LEND_APLY A
                     INNER JOIN TB_THA_PACKAGE_LEND_RND B
                     ON A.RNDID = B.RNDID
                     LEFT OUTER JOIN RND_LIMIT_CNT C
                     ON A.RNDID = C.RNDID 
                  WHERE 1=1 
                    AND A.STTS_CD = '231101'
                    AND A.APLYID IN (
                        <foreach item="item" collection="aplyids" separator=",">
                           #{item}
                        </foreach>
                    )
                  GROUP BY RNDID , A.INSTID   
              )
              SELECT
                 (SELECT 
                      MAX(CASE WHEN RESERVED_CNT - REQUESTQNTY <![CDATA[<]]> 0 THEN 'Y' ELSE 'N'END) FROM  RND_REQUEST_CHEKC
                  ) AS isOverRequestCntPerTotalRndstock
                ,(SELECT 
                      MAX(CASE WHEN RESERVED_CNT - REQUESTQNTY <![CDATA[<]]> 0 THEN 'Y' ELSE 'N'END) FROM  INST_REQUEST_CHECK A
                 ) AS isOverInstRequestcntPerRndstock
                ,(SELECT 
                      MAX(CASE WHEN INST_RESERVATION_CNT +  REQUESTQNTY > PACKAGEINDVD_LIMIT THEN 'Y' ELSE 'N' END) FROM  INST_REQUEST_CHECK A
                 ) AS isOverInstRequestcntPerRndLimit
   
    </select>
    
    <!-- 대여 신청 일괄 상태 변경-->
    <update id="updateLendAplyStts" parameterType="LendAplyVo" >
          /* LendDao.updateLendAplyStts */
          UPDATE TB_THA_PACKAGE_LEND_APLY
            SET 
            STTS_CD = #{sttsCd},
            <if test="rejectRsn != null and rejectRsn != '' ">
            REJECT_RSN = #{rejectRsn},
            </if>
            <choose>
              <when test="sttsCd != null and sttsCd == '231102'">
                DLVY_STTS_CD = '230101',
              </when>
              <otherwise>
                DLVY_STTS_CD = null,
              </otherwise>
            </choose>  
            MDFCN_DT = NOW(),  
            MDFRID   = #{user.userid}     
        WHERE APLYID IN (
                  SELECT 
                      A.APLYID
                    FROM 
                       TB_THA_PACKAGE_LEND_APLY A
                      WHERE 1=1
                        AND (DLVY_STTS_CD != '230102' OR DLVY_STTS_CD IS NULL )
                        AND STTS_CD != #{sttsCd}
                        AND A.APLYID IN (
                            <foreach item="item" collection="aplyids" separator=",">
                               #{item}
                            </foreach>
                        )
               )
    </update>
    <!-- 대여 신청 상세 호출 --> 
    <select id="selectLendAplyInfo" parameterType="LendAplyVo" resultType="LendAplyVo">
            /* LendDao.selectLendAplyInfo */
            SELECT 
                A.APLYID
                ,A.APLCNTID
                ,A.INSTID
                ,A.RNDID
                ,A.PACKAGEID
                ,A.QNTY
                ,A.LEND_BGNG_DE
                ,A.LEND_END_DE
                ,A.STTS_CD
                ,A.DLVY_STTS_CD
                ,A.APLCNT_NM
                ,A.INST_NM
                ,A.TELNO
                ,A.EML
                ,A.EDU_CNT
                ,A.EDU_NOPE
                ,A.GRP_NM
                ,A.CTPRVN_CD
                ,A.RECPTR
                ,A.RECPTR_TELNO
                ,A.RECPTR_EML
                ,A.DLVY_ZIP
                ,A.DLVY_ADDR
                ,A.DLVY_ADDR_DTL
                ,A.HDRY_INST_CD
                ,A.INVCNO_DLIVY
                ,A.INVCNO_WRHOUSNG
                ,A.RVW_SCR
                ,A.RVW_CN
                ,A.RVW_FILEGRPID
                ,A.RVW_REG_DT
                ,A.REJECT_RSN
                ,A.MDFCN_DT
                ,A.MDFRID
                ,A.REG_DT
                ,A.RGTRID
                ,B.ORDR 
                ,B.RCRITID
                ,C.INST_TYPE_CD
                ,D.CTPRVN_NM AS CTPRVN_CD_NM
                ,E.PACKAGE_NM 
                ,F.RCRIT_NM 
              FROM 
                TB_THA_PACKAGE_LEND_APLY A
                INNER JOIN TB_THA_PACKAGE_LEND_RND B
                ON A.RNDID = B.RNDID 
                INNER JOIN TB_CMM_INST C
                ON A.INSTID = C.INSTID 
                LEFT OUTER  JOIN TB_CMM_ADDR_CTPRVN D
                ON A.CTPRVN_CD = D.CTPRVN_CD
                INNER JOIN TB_THA_PACKAGE E
                ON A.PACKAGEID = E.PACKAGEID 
                INNER JOIN TB_THA_PACKAGE_LEND_RCRIT F 
                ON B.RCRITID  = F.RCRITID 
            WHERE 1=1
              AND APLYID = #{aplyid}
    </select>
    <!-- 대여 출고 목록 호출 --> 
    <select id="selectLendAplyDlvyList" parameterType="LendAplyVo" resultType="LendAplyDlivyVo">
            /* LendDao.selectLendAplyDlvyList */
            SELECT 
                A.APLYID
               ,A.RNDID
               ,A.PACKAGEINDVDID
               ,A.DLIVY_PRCS_DT
               ,A.WRHOUSNG_PRCS_DT
               ,A.DLIVY_PICID
               ,A.WRHOUSNG_PICID
               ,A.REG_DT
               ,A.RGTRID
               ,B.PACKAGEINDVD_NM  
               ,B.INDVDNO 
             FROM 
               TB_THA_PACKAGE_LEND_APLY_DLIVY A
               INNER JOIN TB_THA_PACKAGEINDVD B 
               ON A.PACKAGEINDVDID = B.PACKAGEINDVDID 
            WHERE 1=1 
              AND APLYID = #{aplyid}
    </select>
    <!-- 대여 신청 수정   -->    
    <update id="updateLendAply"  parameterType="LendAplyVo"  >
        /* LendDao.updateLendAply */
        UPDATE TB_THA_PACKAGE_LEND_APLY
          SET
          <if test="instid != null and instid != ''">
             INSTID         = #{instid       },
          </if>
          <if test="packageid != null and packageid != ''">
             PACKAGEID      = #{packageid    },
          </if>
          <if test="qnty != null and qnty != ''">
             QNTY           = #{qnty         },
          </if>
          <if test="lendBgngDe != null and lendBgngDe != ''">
             LEND_BGNG_DE   = #{lendBgngDe   },
          </if>
          <if test="lendEndDe != null and lendEndDe != ''">
             LEND_END_DE    = #{lendEndDe    },
          </if>
          <if test="rejectRsn != null and rejectRsn != ''">
             REJECT_RSN     = #{rejectRsn    },
          </if>
          <if test="sttsCd != null and sttsCd != ''">
            STTS_CD = #{sttsCd},
          </if>  
          <if test="dlvySttsCd != null and dlvySttsCd != ''">
             DLVY_STTS_CD   = #{dlvySttsCd   },
          </if>
          <if test="aplcntNm != null and aplcntNm != ''">
             APLCNT_NM      = #{aplcntNm     },
          </if>
          <if test="instNm != null and instNm != ''">
             INST_NM        = #{instNm       },
          </if>
          <if test="telno != null and telno != ''">
             TELNO          = #{telno        },
          </if>
          <if test="eml != null and eml != ''">
             EML            = #{eml          },
          </if>
          <if test="eduCnt != null and eduCnt != ''">
             EDU_CNT        = #{eduCnt       },
          </if>
          <if test="eduNope != null and eduNope != ''">
             EDU_NOPE       = #{eduNope      },
          </if>
          <if test="grpNm != null and grpNm != ''">
             GRP_NM         = #{grpNm        },
          </if>
          <if test="ctprvnCd != null and ctprvnCd != ''">
             CTPRVN_CD      = #{ctprvnCd     },
          </if>
          <if test="recptr != null and recptr != ''">
             RECPTR         = #{recptr       },
          </if>
          <if test="recptrTelno != null and recptrTelno != ''">
             RECPTR_TELNO   = #{recptrTelno  },
          </if>
          <if test="recptrEml != null and recptrEml != ''">
             RECPTR_EML     = #{recptrEml    },
          </if>
          <if test="dlvyZip != null and dlvyZip != ''">
             DLVY_ZIP       = #{dlvyZip      },
          </if>
          <if test="dlvyAddr != null and dlvyAddr != ''">
             DLVY_ADDR      = #{dlvyAddr     },
          </if>
          <if test="dlvyAddrDtl != null and dlvyAddrDtl != ''">
             DLVY_ADDR_DTL  = #{dlvyAddrDtl  },
          </if>
          <if test="hdryInstCd != null and hdryInstCd != ''">
             HDRY_INST_CD   = #{hdryInstCd   },
          </if>
          <if test="invcnoDlivy != null and invcnoDlivy != ''">
            INVCNO_DLIVY = #{invcnoDlivy   },  
          </if>  
          <if test="invcnoWrhousng != null and invcnoWrhousng != ''">
            INVCNO_WRHOUSNG = #{invcnoWrhousng},  
          </if>  
          <if test="rvwScr != null and rvwScr != ''">
            RVW_SCR = #{rvwScr        },  
          </if>  
          <if test='rvwCn != null and rvwCn != ""'>
            RVW_CN = #{rvwCn         },  
          </if>  
          <if test="rvwFilegrpid != null and rvwFilegrpid != 0">
            RVW_FILEGRPID = #{rvwFilegrpid  },  
          </if>  
          <if test="rvwCn != null and rvwCn != ''">
            RVW_REG_DT = NOW(),  
          </if>  
            MDFCN_DT = NOW()            ,  
            MDFRID  = #{user.userid   }     
        WHERE APLYID = #{aplyid}     
    </update>
    
    <!--************* 모바일 출고 관리****************-->
    <!-- 대여 모집 차시 목록 호출 (검색용)-->
    <select id="selectLendRcritRndList" parameterType="LendVo" resultType="LendVo">
          /* LendDao.selectLendRcritRndList */
            SELECT  
               A.RCRITID
              ,A.RCRIT_NM
              ,B.RNDID 
              ,B.ORDR 
              ,A.PACKAGEID
              ,A.BGNG_DT
              ,A.END_DT
              ,A.LMT_CD
            FROM 
              TB_THA_PACKAGE_LEND_RCRIT A
              INNER JOIN  TB_THA_PACKAGE_LEND_RND B
              ON A.RCRITID = B.RCRITID
    </select>
    <!-- 꾸러미개체 목록 호출 (검색용)-->
    <select id="searchPackageindvdList" parameterType="PackageindvdVo" resultType="PackageindvdVo">
          /* LendDao.searchPackageindvdList */
             SELECT 
                 PACKAGEINDVDID
                 ,INDVDNO
                 ,PACKAGEINDVD_NM
                 ,PACKAGEID
                 ,STTS_CD
                 ,PRDUCT_STTS_CD
                 ,USE_YN
                 ,MDFCN_DT
                 ,MDFRID
                 ,REG_DT
                 ,RGTRID
               FROM 
                 TB_THA_PACKAGEINDVD
              WHERE 1=1 
                AND USE_YN = 'Y'
                AND PACKAGEID = #{packageid}
              <if test="packageindvdid != null and packageindvdid != ''">
                AND PACKAGEINDVDID = #{packageindvdid}
              </if>
              <if test="packageindvdids != null and packageindvdids != ''">
                AND PACKAGEINDVDID NOT IN (
                  <foreach item="packageindvdid" collection="packageindvdids" separator=",">
                      #{packageindvdid}
                  </foreach>
                )
              </if>
   </select>
   <!-- 대여 신청 출고 등록-->
   <insert id="insertLendAplyDlivy" parameterType="LendAplyVo" >
        /* LendDao.insertLendAplyDlivy */
        INSERT INTO TB_THA_PACKAGE_LEND_APLY_DLIVY (
             APLYID
             ,RNDID
             ,PACKAGEINDVDID
             ,DLIVY_PRCS_DT
             ,DLIVY_PICID
             ,REG_DT
             ,RGTRID
        )VALUES
        <foreach item="packageindvdid" collection="packageindvdids" separator=",">
        (
              #{aplyid        }
             ,#{rndid         }
             ,#{packageindvdid}
             ,NOW()
             ,#{user.userid }
             ,NOW()
             ,#{user.userid }
        )
        </foreach>
   </insert>
   <!-- 꾸러미 개체 입출고 상태 수정-->
   <update id="updatePackageindvdStts" parameterType="LendAplyVo"  >
        /* LendDao.updatePackageindvdStts */
        UPDATE TB_THA_PACKAGEINDVD
           SET
              <if test="packSttsCd != null and packSttsCd != ''">
              STTS_CD         = #{packSttsCd          },
              </if>
              MDFCN_DT        = NOW(),
              MDFRID          = #{user.userid }
         WHERE PACKAGEINDVDID IN (
                 <foreach item="packageindvdid" collection="packageindvdids" separator=",">
                 #{packageindvdid}
                 </foreach>
         )
   </update>

   <!--**************입고 관리 **************-->
   <!-- 대여 신청 출고 수정 -->
   <update id="updateLendAplyDlivy" parameterType="LendAplyDlivyVo" >
        /* LendDao.updateLendAplyDlivy */
        UPDATE TB_THA_PACKAGE_LEND_APLY_DLIVY
           SET
             DLIVY_PRCS_DT  = NOW(),
             DLIVY_PICID    = #{user.userid }
         WHERE APLYID = #{aplyid        }
           AND RNDID  = #{rndid         }
           AND PACKAGEINDVDID = #{packageindvdid}

   </update>
   <!-- 꾸러미 개체 점검 등록-->
   <insert id="insertLendPackageindvdChck" parameterType="LendPackageindvdChckVo" useGeneratedKeys="true" keyProperty="chckid">
         /* LendDao.insertLendPackageindvdChck */
         INSERT INTO TB_THA_PACKAGEINDVD_CHCK(
                FORMID
                ,APLYID
                ,RNDID
                ,PACKAGEINDVDID
                ,ABNRMLID
                ,CHCK_CD
                ,PICID
                ,CHCK_DE
                ,MDFCN_DT
                ,MDFRID
                ,REG_DT
                ,RGTRID
             )VALUES(
                 #{formid        }
                ,#{aplyid        }
                ,#{rndid         }
                ,#{packageindvdid}
                ,#{abnrmlid      }
                ,#{chckCd        }
                ,#{user.userid   }
                ,#{chckDe        }
                ,NOW()
                ,#{user.userid   }
                ,NOW()
                ,#{user.userid   }
             )
   </insert>
   <!-- 꾸러미 개체 점검 답변 등록-->
   <insert id="insertLendPackageindvdChckAns" parameterType="LendPackageindvdChckVo" >
        /* LendDao.insertLendPackageindvdChckAns */
        INSERT INTO TB_THA_PACKAGEINDVD_CHCK_ANS(
              CHCKID
              ,ARTCLID
              ,TCHAIDID
              ,EXID
              ,EX_CN
              ,ACTN_MTTR
              ,MDFCN_DT
              ,MDFRID
              ,REG_DT
              ,RGTRID
           )VALUES
           <foreach item="item" collection="lendPackageindvdChkAnsList" separator=",">
           (
              #{chckid   }
              ,#{item.artclid  }
              ,#{item.tchaidid }
              ,#{item.exid     }
              ,#{item.exCn    }
              ,#{item.actnMttr}
              ,NOW()
              ,#{user.userid   }
              ,NOW()
              ,#{user.userid   }
           )
           </foreach>
   </insert>
   <!-- 입고 확인 꾸러미 개체 목록 호출-->
   <select id="selectLendPackageindvdList" parameterType="LendAplyVo" resultType="LendAplyVo">
          /* LendDao.selectLendPackageindvdList */
        <if test='packageindvdid == null or packageindvdid == "" or packageindvdid == 0 '>
          <include refid="PaginationMapper.header"/>
        </if>
         SELECT
             D.RCRIT_NM
             ,A.APLYID
             ,A.PACKAGEINDVDID
             ,B.RNDID
             ,B.LEND_BGNG_DE
             ,B.LEND_END_DE
             ,C.ORDR
             ,B.DLVY_ADDR
             ,B.DLVY_ADDR_DTL
             ,B.PACKAGEID
             ,E.PACKAGEINDVD_NM AS PACKAGE_NM
             ,E.INDVDNO
             ,A.WRHOUSNG_PRCS_DT
             ,B.STTS_CD
             ,B.DLVY_STTS_CD
             ,A.REG_DT
             ,F.INSTID
             ,F.INST_NM
          FROM
            TB_THA_PACKAGE_LEND_APLY_DLIVY A
            INNER JOIN  TB_THA_PACKAGE_LEND_APLY B
            ON A.APLYID = B.APLYID
            INNER JOIN TB_THA_PACKAGE_LEND_RND C
            ON A.RNDID = C.RNDID
            INNER JOIN TB_THA_PACKAGE_LEND_RCRIT D
            ON C.RCRITID = D.RCRITID
            INNER JOIN TB_THA_PACKAGEINDVD E
            ON A.PACKAGEINDVDID = E.PACKAGEINDVDID
            INNER JOIN TB_CMM_INST F
            ON B.INSTID = F.INSTID
        WHERE 1=1
          AND B.STTS_CD = '231102'
          AND B.DLVY_STTS_CD  = '230102'
          AND A.WRHOUSNG_PRCS_DT IS NULL
          AND A.WRHOUSNG_PICID IS NULL
           <if test="searchKeyword != null and searchKeyword != '' and searchType == 'nm'">
              AND D.RCRIT_NM LIKE CONCAT('%',#{searchKeyword},'%')
           </if>
           <if test="searchKeyword != null and searchKeyword != '' and searchType == 'number'">
              AND E.INDVDNO = #{searchKeyword}
           </if>
           <if test="packageindvdid != null and packageindvdid != '' ">
              AND A.PACKAGEINDVDID = #{packageindvdid}
              ORDER BY A.REG_DT DESC
           </if>

        <if test='packageindvdid == null or packageindvdid == "" or packageindvdid == 0 '>
            <include refid="PaginationMapper.footer"/>
        </if>
   </select>
   <!-- 교구 점검 양식 문항/보기 리스트 호출  -->
   <select id="selectFormExidList" parameterType="map" resultType="map">
          /* LendDao.selectFormExidList */
          SELECT
              B.ARTCLID artclid
              ,B.FORMID formid
              ,B.ORDR   ordr
              ,B.CN     cn
              ,group_concat(concat(C.ORDR,'/',C.EXID,'/',C.CN) ORDER BY C.ORDR ASC) excn
            FROM
              TB_THA_PACKAGEINDVD_CHCK_FORM A
              INNER JOIN TB_THA_PACKAGEINDVD_CHCK_ARTCL B
              ON A.FORMID = B.FORMID
              INNER JOIN TB_THA_PACKAGEINDVD_CHCK_ARTCL_EX C
              ON B.ARTCLID = C.ARTCLID
           WHERE 1=1
             AND A.FORMID  = #{formid}
             GROUP BY B.ARTCLID
             ORDER BY B.ORDR ASC
   </select>
   <!-- 꾸러미 개체 점검 교구 등록 -->
   <insert id="insertPackageindvdChckTchaid" parameterType="LendPackageindvdChckVo" >
          /* LendDao.packageindvdChckTchaid */
          INSERT INTO TB_THA_PACKAGEINDVD_CHCK_TCHAID(
                TCHAIDID
                ,CHCKID
                ,QNTY
                ,CMPNT
                ,MDFCN_DT
                ,MDFRID
                ,REG_DT
                ,RGTRID
           )VALUES
           <foreach item="item" collection="lendPackageindvdChckTchaidList" separator=",">
           (
               #{item.tchaidid}
              ,#{chckid     }
              ,#{item.qnty  }
              ,#{item.cmpnt }
              ,NOW()
              ,#{user.userid}
              ,NOW()
              ,#{user.userid}
           )
           </foreach>
   </insert>
   <!-- 대여 신청 입고 수정 -->
   <update id="updateLendAplyWrhousng" parameterType="LendPackageindvdChckVo" >
        /* LendDao.updateLendAplyWrhousng */
        UPDATE TB_THA_PACKAGE_LEND_APLY_DLIVY
           SET
             WRHOUSNG_PRCS_DT  = NOW(),
             WRHOUSNG_PICID    = #{user.userid }
         WHERE APLYID = #{aplyid}
           AND RNDID  = #{rndid }
           AND PACKAGEINDVDID = #{packageindvdid}
   </update>
   <!-- 대여차시 별 이미 승인 된 꾸러미 개체 여부 확인 -->
   <select id="isThereRndPackageindvdYn" parameterType="PackageindvdVo" resultType="String">
       SELECT
          CASE WHEN  COUNT(A.PACKAGEINDVDID) > 0 THEN 'Y'
               ELSE 'N'
          END
         FROM
           TB_THA_PACKAGE_LEND_APLY_DLIVY A
        WHERE 1=1
          AND A.RNDID = #{rndid}
          AND A.PACKAGEINDVDID = #{packageindvdid}
   </select>

    <!-- 삭제한 꾸러미 출고 삭제 -->
    <delete id="deleteLendAplyDlivy" parameterType="LendAplyVo">
        /* LendDao.deleteLendAplyDlivy */
        DELETE FROM TB_THA_PACKAGE_LEND_APLY_DLIVY
        WHERE APLYID = #{aplyid}
          AND RNDID = #{rndid}
    </delete>

   <!-- 입고 확인 꾸러미 개체 목록 호출-->
   <select id="selectHealthChckPackageindvdList" parameterType="LendAplyVo" resultType="LendAplyVo">
        /* LendDao.selectHealthChckPackageindvdList */
        <include refid="PaginationMapper.header"/>
         SELECT
             D.RCRIT_NM
             ,A.APLYID
             ,A.PACKAGEINDVDID
             ,B.RNDID
             ,B.LEND_BGNG_DE
             ,B.LEND_END_DE
             ,C.ORDR
             ,B.DLVY_ADDR
             ,B.DLVY_ADDR_DTL
             ,B.PACKAGEID
             ,E.PACKAGEINDVD_NM AS PACKAGE_NM
             ,E.INDVDNO
             ,A.WRHOUSNG_PRCS_DT
             ,B.STTS_CD
             ,B.DLVY_STTS_CD
             ,A.REG_DT
             ,F.INSTID
             ,F.INST_NM
          FROM
            TB_THA_PACKAGE_LEND_APLY_DLIVY A
            INNER JOIN  TB_THA_PACKAGE_LEND_APLY B
            ON A.APLYID = B.APLYID
            INNER JOIN TB_THA_PACKAGE_LEND_RND C
            ON A.RNDID = C.RNDID
            INNER JOIN TB_THA_PACKAGE_LEND_RCRIT D
            ON C.RCRITID = D.RCRITID
            INNER JOIN TB_THA_PACKAGEINDVD E
            ON A.PACKAGEINDVDID = E.PACKAGEINDVDID
            INNER JOIN TB_CMM_INST F
            ON B.INSTID = F.INSTID
        WHERE 1=1
          AND B.STTS_CD = '231102'
          AND B.DLVY_STTS_CD  = '230102'
          AND A.WRHOUSNG_PRCS_DT IS NULL
          AND A.WRHOUSNG_PICID IS NULL
           <if test="searchKeyword != null and searchKeyword != '' and searchType == 'nm'">
              AND D.RCRIT_NM LIKE CONCAT('%',#{searchKeyword},'%')
           </if>
           <if test="searchKeyword != null and searchKeyword != '' and searchType == 'number'">
              AND E.INDVDNO = #{searchKeyword}
           </if>
           <if test="packageindvdid != null and packageindvdid != '' ">
              AND A.PACKAGEINDVDID = #{packageindvdid}
              ORDER BY A.REG_DT DESC
           </if>

           <include refid="PaginationMapper.footer"/>
   </select>

   <!-- 위생체크용 꾸러미 개체 목록 호출-->
   <select id="selectPackageindvdListForHealthChck" parameterType="PackageindvdVo" resultType="PackageindvdVo">
        /* LendDao.selectPackageindvdListForHealthChck */
           <if test='packageindvdid == null or packageindvdid == "" or packageindvdid == 0 '>
                <include refid="PaginationMapper.header"/>
           </if>
             SELECT
                 PACKAGEINDVDID
                 ,INDVDNO
                 ,PACKAGEINDVD_NM
                 ,PACKAGEID
                 ,STTS_CD
                 ,PRDUCT_STTS_CD
                 ,USE_YN
                 ,MDFCN_DT
                 ,MDFRID
                 ,REG_DT
                 ,RGTRID
               FROM
                 tb_tha_packageindvd
              WHERE 1=1
                AND USE_YN = 'Y'
             <if test="searchKeyword != null and searchKeyword != '' and searchType == 'nm'">
                AND PACKAGEINDVD_NM LIKE CONCAT('%',#{searchKeyword},'%')
             </if>
             <if test="searchKeyword != null and searchKeyword != '' and searchType == 'number'">
                AND INDVDNO = #{searchKeyword}
             </if>
             <if test="packageindvdid != null and packageindvdid != '' ">
                AND PACKAGEINDVDID = #{packageindvdid}
             </if>

           <if test='packageindvdid == null or packageindvdid == "" or packageindvdid == 0 '>
                <include refid="PaginationMapper.footer"/>
           </if>
     </select>

</mapper>