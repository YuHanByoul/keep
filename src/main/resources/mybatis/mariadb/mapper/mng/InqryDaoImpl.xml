<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : InqryDaoImpl.xml
	Description : 1:1문의
-->
<mapper namespace="com.kbrainc.plum.mng.inqry.model.InqryDao">

	<!-- 1:1문의리스트 가져옴 -->
	<select id="selectInqryList" parameterType="InqryVo" resultType="InqryVo">
		/* InqryDao.selectInqryList */
		<include refid="PaginationMapper.header"/>
		SELECT A.INQRYID /*문의글 일련번호*/
		      ,A.TITLE /*제목*/
		      ,E.NM /*작성자*/
			  ,A.INQRY_CL_CD /* 문의 분류 코드 */
		      ,A.STTS_CD AS INQRY_STTS_CD /*상태*/
		      ,A.REG_DT AS REG_DT /*작성일*/
			  ,D.NM AS OPETR_NM /*처리자*/
			  ,CASE WHEN B.OPETRID = #{user.userid} THEN 'Y' ELSE 'N' END ASSIGN_YN
        FROM TB_CMM_INQRY A
            LEFT OUTER JOIN TB_CMM_INQRY_ANSWR B ON A.INQRYID = B.INQRYID
            LEFT OUTER JOIN TB_CMM_USER D ON B.OPETRID = D.USERID
		    INNER JOIN TB_CMM_USER E ON E.USERID = A.USERID
		 WHERE 1=1 
			AND A.DEL_YN = 'N'
		<if test="searchKeyword != null and searchKeyword != ''">
			<if test="searchType == 'title'">
				AND A.TITLE LIKE CONCAT('%',#{searchKeyword},'%')
			</if>
			<if test="searchType == 'cntnts'">
				AND A.CNTNTS LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
			<if test="searchType == 'nm'">
				AND E.NM LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
			<if test="searchType == 'id'">
				AND E.ACNT LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
		</if>

		<if test="inqrySttsCd != null and inqrySttsCd != ''">
			AND A.STTS_CD = #{inqrySttsCd}
		</if>

		<if test="inqryClCd != null and inqryClCd != ''">
			AND A.INQRY_CL_CD = #{inqryClCd}
		</if>

		<include refid="PaginationMapper.footer"/>
	</select>
	
	<!-- 1:1문의 정보를 가져옴 -->
	<select id="selectInqryInfo" parameterType="InqryVo" resultType="InqryVo">
		/* InqryDao.selectInqryInfo */
	    SELECT A.INQRYID /*문의글 일련번호*/
	          ,A.USERID /*작성자 일련번호*/
			  ,A.TITLE /*제목*/
			  ,A.CNTNTS /*내용*/
			  ,C.NM /*작성자명*/
	          ,C.ACNT /*작성자 아이디명*/
	          ,D.INST_NM /*기관명*/
			  ,A.FILEGRPID
			  ,F.FILEID
			  ,F.ORGINL_FILE_NM AS FILE_NM
			  ,F.FILE_SIZE
	          ,a.INQRY_CL_CD
	    	  ,A.STTS_CD AS INQRY_STTS_CD
	    	  ,A.REG_DT
        FROM TB_CMM_INQRY A
        	LEFT OUTER JOIN TB_CMM_FILE F ON A.FILEGRPID = F.FILEGRPID AND F.ORD=1
		    INNER JOIN TB_CMM_USER C ON C.USERID = A.USERID
			LEFT OUTER JOIN TB_CMM_INST D ON D.INSTID = C.INSTID
        WHERE
            A.INQRYID = #{inqryid}
	</select>
	
	<!-- 1:1문의 답변정보를 가져옴 -->
	<select id="selectInqryAnswrInfo" parameterType="InqryAnswrVo" resultType="InqryAnswrVo">
		/* InqryDao.selectInqryAnswrInfo */
		SELECT
		    A.INQRYID
		    ,A.ANSWRID
			,A.TITLE
			,A.CNTNTS
			,B.NM AS OPETR_NM
		    ,A.FILEGRPID
			,A.REG_DT
			,A.ANS_DE
        FROM TB_CMM_INQRY_ANSWR A
    		LEFT OUTER JOIN TB_CMM_USER B ON A.OPETRID = B.USERID
        WHERE A.INQRYID = #{inqryid}
        LIMIT 1
	</select>
	
	<!-- 1:1문의답변 등록 -->
	<insert id="insertInqryAnswr" parameterType="InqryAnswrVo">
		/* InqryDao.insertInqryAnswr */
		INSERT INTO TB_CMM_INQRY_ANSWR
		( INQRYID
		, TITLE
		, CNTNTS
		, FILEGRPID
		, OPETRID
		, MDFCN_DT
		, MDFRID
		, REG_DT
		, RGTRID
		<if test="inqrySttsCd == '103104' or inqrySttsCd == '103103'">
		, ANSCMPTN_DT
		, ANS_DE
		</if>
		) VALUES(
		 #{inqryid}
	     ,#{title}
	     ,#{cntnts}
	     ,#{filegrpid}
	     ,#{user.userid}
	     ,NOW()
	     ,#{user.userid}
	     ,NOW()
	     ,#{user.userid}
 		 <if test="inqrySttsCd == '103104' or inqrySttsCd == '103103'">
 		 ,NOW()
		 ,DATE_FORMAT(NOW(), '%Y-%m-%d')
		 </if>
	   )
	</insert>

	<!-- 1:1문의답변 수정 -->
	<update id="updateInqryAnswr" parameterType="InqryAnswrVo">
		/* InqryDao.updateInqryAnswr */
		UPDATE TB_CMM_INQRY_ANSWR
		   SET INQRYID = #{inqryid}
		      ,TITLE = #{title}
		      ,CNTNTS = #{cntnts}
		   	  ,MDFCN_DT = NOW()
		      ,FILEGRPID = #{filegrpid}
		   	  ,MDFRID =  #{user.userid}
		 WHERE ANSWRID = #{answrid}
	</update>

	<select id="selectAttachFileList"  parameterType="FileVo" resultType="FileVo">
	    /* InqryDao.selectAttachFileList */
		SELECT 
			A.FILEID,
			A.FILEGRPID,
			A.FILE_IDNTFC_KEY,
			A.FILE_PATH,
			A.SAVE_FILE_NM,
			A.ORGINL_FILE_NM,
			A.FILE_EXTSN,
			A.FILE_SIZE,
			A.ORD,
			A.REG_DT,
			A.RGTRID
		FROM TB_CMM_FILE A
	   WHERE 1=1
	  	 AND A.FILEGRPID = #{filegrpid}
	</select>

	<update id="deleteInqryInfo">
		UPDATE TB_CMM_INQRY
			SET DEL_YN = 'Y'
			,MDFCN_DT = NOW()
			,MDFRID = #{userVo.userid}
		WHERE INQRYID IN
			(
			<foreach item="inqryId" collection="deleteInqryIds"  separator=",">
				#{inqryId}
			</foreach>
			)
	</update>

	<update id="updateInqrySttsCd" parameterType="InqryAnswrVo">
		UPDATE TB_CMM_INQRY
			SET STTS_CD = #{inqrySttsCd}
		WHERE INQRYID = #{inqryid}
	</update>

	<select id="selectTelInqryList" resultType="TelInqryVo">
		<include refid="PaginationMapper.header"/>
		SELECT
			TELINQRYID
			, A.CLSF_CD
			, A.USERID
			, A.PICID
			, B.NM AS PIC_NM
			, A.USER_NM
			, A.CNTCT
			, A.EML
			, A.RCPT_DT
			, A.STTS_CD
			, A.CN
			, A.ANS
			, A.MDFCN_DT
			, A.MDFRID
			, A.REG_DT
			, A.RGTRID
			, CASE WHEN A.PICID = #{user.userid} THEN 'Y' ELSE 'N' END ASSIGN_YN
		FROM TB_CMM_TELINQRY A
			LEFT OUTER JOIN TB_CMM_USER B ON B.USERID = A.PICID
			LEFT OUTER JOIN TB_CMM_USER C ON C.USERID = A.USERID
		WHERE 1=1
		<if test="searchKeyword != null and searchKeyword != ''">
			<if test="searchType == 'cn'">
				AND A.CN LIKE CONCAT('%',#{searchKeyword},'%')
			</if>
			<if test="searchType == 'ans'">
				AND A.ANS LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
			<if test="searchType == 'nm'">
				AND A.USER_NM LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
			<if test="searchType == 'acnt'">
				AND C.ACNT LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
		</if>
		<if test="clsfCd != null and clsfCd != ''">
			AND A.CLSF_CD = #{clsfCd}
		</if>
		<if test="sttsCd != null and sttsCd != ''">
			AND A.STTS_CD = #{sttsCd}
		</if>
		<include refid="PaginationMapper.footer"/>
	</select>

	<select id="selectTelInqryInfo" resultType="TelInqryVo">
		SELECT TELINQRYID
			 , A.CLSF_CD
			 , A.USERID
			 , A.PICID
			 , B.NM AS PICNM
			 , A.USER_NM
			 , A.CNTCT
			 , A.EML
			 , A.RCPT_DT
			 , A.STTS_CD
			 , A.CN
			 , A.ANS
			 , A.MDFCN_DT
			 , A.MDFRID
			 , A.REG_DT
			 , A.RGTRID
			 , A.STTS_CD AS OLD_STTS_CD
			 , A.ANSCMPTN_DT
		FROM TB_CMM_TELINQRY A
			LEFT OUTER JOIN TB_CMM_USER B ON B.USERID = A.PICID
		WHERE TELINQRYID = #{telinqryid}
	</select>

	<insert id="insertTelInqry" useGeneratedKeys="true" keyProperty="telinqryid" parameterType="TelInqryVo">
		INSERT INTO TB_CMM_TELINQRY(
			CLSF_CD
			<if test="#{userid} != null">
			,USERID
			</if>
			,PICID
			,USER_NM
			,CNTCT
			,EML
			,RCPT_DT
			,STTS_CD
			,CN
			,ANS
			,MDFCN_DT
			,MDFRID
			,REG_DT
			,RGTRID
			<if test="sttsCd == '123102' or sttsCd == '123101'">
			,ANSCMPTN_DT
			,ANS_DE
			</if>
		) VALUES(
			#{clsfCd}
			<if test="#{userid} != null">
			,#{userid}
			</if>
			,#{user.userid}
			,#{userNm}
			,#{cntct}
			,#{eml}
			,#{rcptDt}
			,#{sttsCd}
			,#{cn}
			,#{ans}
			,NOW()
			,#{user.userid}
			,NOW()
			,#{user.userid}
			<if test="sttsCd == '123102' or sttsCd = '123101'">
			,NOW()
			,DATE_FORMAT(NOW(),'%Y-%m-%d')
			</if>
		)
	</insert>

	<update id="updateTelInqry">
		UPDATE TB_CMM_TELINQRY
		SET
		    CLSF_CD = #{clsfCd}
			, USERID = #{userid}
			, USER_NM = #{userNm}
			, CNTCT = #{cntct}
			, EML = #{eml}
			, STTS_CD = #{sttsCd}
			, CN = #{cn}
		  	, ANS = #{ans}
			, MDFCN_DT = NOW()
			, MDFRID = #{user.userid}
		WHERE
		    TELINQRYID = #{telinqryid}
	</update>

	<select id="selectMemberList" resultType="PopupMemberVo">
		<include refid="PaginationMapper.header"/>
		SELECT
		    A.USERID
			,A.NM
			,A.ACNT
			,A.MOBLPHON
			,A.EML
			,A.REG_DT
		FROM TB_CMM_USER A
		WHERE 1=1
		  AND A.DEL_YN = 'N'
		  AND A.STTS_CD <![CDATA[<>]]>  '9'
		<if test="searchKeyword != null and searchKeyword != '' and searchType == 'nm'">
			AND A.NM LIKE CONCAT('%',#{searchKeyword},'%')
		</if>
		<if test="searchKeyword != null and searchKeyword != '' and searchType == 'acnt'">
			AND A.ACNT LIKE CONCAT('%',#{searchKeyword},'%')
		</if>
		<if test="searchKeyword != null and searchKeyword != '' and searchType == 'moblphon'">
			AND A.MOBLPHON LIKE CONCAT('%',#{searchKeyword},'%')
		</if>
		<if test="searchKeyword != null and searchKeyword != '' and searchType == 'eml'">
			AND A.EML LIKE CONCAT('%',#{searchKeyword},'%')
		</if>
		<choose>
			<when test='searchInst2 == "N"'>
				AND A.INSTID IS NULL
			</when>
			<otherwise>
				<bind name="searchInstValue" value="searchInst2" />
				<include refid="SearchMapper.instLmtCondition">
					<property name="tableAlias" value="A" />
				</include>
			</otherwise>
		</choose>
		<include refid="PaginationMapper.footer"/>

	</select>
	<!--1:1문의 담당자 목록-->
	<select id="selectInqryManagerList" resultType="ManagerVo">
		SELECT
			A.INQRYID
		 	, A.USERID
		 	, B.NM
			, B.ACNT
		FROM TB_CMM_INQRY_PIC A
				 INNER JOIN TB_CMM_USER B ON A.USERID = B.USERID
		WHERE INQRYID = #{inqryid}
	</select>

	<!--전화문의 담당자 목록-->
	<select id="selectTelInqryManagerList" resultType="ManagerVo">
		SELECT
			A.TELINQRYID
			, A.USERID
			, B.NM
			, B.ACNT
		FROM TB_CMM_TELINQRY_PIC A
				 INNER JOIN TB_CMM_USER B ON A.USERID = B.USERID
		WHERE TELINQRYID = #{telinqryid}
	</select>

	<!--1:1문의 담당자 지정 등록-->
	<insert id="insertInqryManager" parameterType="InqryAnswrVo">
		INSERT INTO TB_CMM_INQRY_PIC(
		INQRYID,
		USERID,
		MDFCN_DT,
		MDFRID,
		REG_DT,
		RGTRID
		) VALUES
		<foreach item="id" collection="managerId"  separator=",">
			(
			#{inqryid}
			,#{id}
			,NOW()
			,#{user.userid}
			,NOW()
			,#{user.userid}
			)
		</foreach>
	</insert>

	<!--전화문의 담당자 지정 등록-->
	<insert id="insertTelInqryManager" parameterType="TelInqryVo">
		INSERT INTO TB_CMM_TELINQRY_PIC(
		TELINQRYID,
		USERID,
		MDFCN_DT,
		MDFRID,
		REG_DT,
		RGTRID
		) VALUES
		<foreach item="id" collection="managerId"  separator=",">
			(
			#{telinqryid}
			,#{id}
			,NOW()
			,#{user.userid}
			,NOW()
			,#{user.userid}
			)
		</foreach>
	</insert>

	<delete id="deleteInqryManager">
		DELETE FROM TB_CMM_INQRY_PIC WHERE INQRYID = #{inqryid}
	</delete>

	<delete id="deleteTelInqryManager">
		DELETE FROM TB_CMM_TELINQRY_PIC WHERE TELINQRYID=#{telinqryid}
	</delete>


</mapper>