<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : InqryDaoImpl.xml
	Description : 1:1문의
-->
<mapper namespace="com.kbrainc.plum.mng.inqry.model.InqryDao">

	<!-- 1:1문의리스트 가져옴 -->
	<select id="selectInqryList" parameterType="InqryVo" resultType="InqryVo">
		/* InqryDao.selectInqryList */
		<include refid="PaginationMapper.header"/>
		SELECT A.INQRYID
		      ,A.TITLE
		      ,E.NM
		      ,C.CD_NM AS INQRY_CL_NM
		      ,A.REG_DT AS REG_D
		      ,A.REGUSERID
			  ,D.NM AS OPETR_NM
		      ,B.REG_DT AS ANSWR_D
        FROM TB_INQRY A 
            LEFT OUTER JOIN TB_INQRY_ANSWR B ON A.INQRYID = B.INQRYID
            LEFT OUTER JOIN TB_USER D ON B.OPETRID = D.USERID
		    INNER JOIN (SELECT CD, CD_NM FROM TB_CD WHERE CDGRPID = #{cdgrpid}) C ON A.INQRY_CL_CD = C.CD
		    INNER JOIN TB_USER E ON E.USERID = A.USERID
		 WHERE 1=1 
		<if test="inqry_cl_cd != null and inqry_cl_cd != ''">
			AND C.CD = #{inqry_cl_cd}
		</if>
		<if test="searchAnswrYn != null and searchAnswrYn != ''">
			<if test="searchAnswrYn == 'Y'.toString()">
			    AND B.OPETRID IS NOT NULL
			</if>
			<if test="searchAnswrYn == 'N'.toString()">
				AND B.OPETRID IS NULL
			</if>
		</if>
		<if test="searchStartDay != null and searchStartDay != ''">
			AND A.REG_DT >= #{searchStartDay}
		</if>
		<if test="searchEndDay != null and searchEndDay != ''">
			AND A.REG_DT <![CDATA[<]]> CONCAT(#{searchEndDay}, ' 23:59:59')
		</if>
		<if test="nm != null and nm != ''">
			AND E.NM LIKE CONCAT('%', #{nm}, '%')
		</if>
		<if test="title != null and title != ''">
			AND A.TITLE LIKE CONCAT('%', #{title}, '%')
		</if>
		<include refid="PaginationMapper.footer"/>
	</select>
	
	<!-- 1:1문의 정보를 가져옴 -->
	<select id="selectInqryInfo" parameterType="InqryVo" resultType="InqryVo">
		/* InqryDao.selectInqryInfo */
	    SELECT A.INQRYID
	          ,A.userid
			  ,C.EMAIL
			  ,C.MOBNO
			  ,A.PRIPLCY_AGRE_YN
			  ,A.TITLE
			  ,A.CNTNTS
			  ,C.NM
			  ,A.FILEGRPID
			  ,F.FILEID
			  ,F.ORGINL_FILE_NM AS FILE_NM
			  ,F.FILE_SIZE
			  ,B.CD_NM AS INQRY_CL_NM
			  ,C.USER_SE_CD
			  ,A.REG_DT
        FROM TB_INQRY A
        	LEFT OUTER JOIN TB_FILE F ON A.FILEGRPID = F.FILEGRPID AND F.ORD=1
            INNER JOIN (SELECT CD, CD_NM FROM TB_CD WHERE CDGRPID = #{cdgrpid}) B ON A.INQRY_CL_CD = B.CD
		    INNER JOIN TB_USER C ON C.USERID = A.USERID
        WHERE
            A.INQRYID = #{inqryid}
	</select>
	
	<!-- 1:1문의 답변정보를 가져옴 -->
	<select id="selectInqryAnswrInfo" parameterType="InqryAnswrVo" resultType="InqryAnswrVo">
		/* InqryDao.selectInqryAnswrInfo */
		SELECT A.INQRYID
		      ,A.ANSWRID
			  ,A.TITLE
			  ,A.CNTNTS
			  ,B.NM AS OPETR_NM
			  ,A.REG_DT
        FROM TB_INQRY_ANSWR A
		    ,TB_USER B		    
        WHERE A.INQRYID = #{inqryid}
          AND A.OPETRID = B.USERID
        LIMIT 1
	</select>
	
	<!-- 1:1문의답변 등록 -->
	<insert id="insertInqryAnswr" parameterType="InqryAnswrVo">
		/* InqryDao.insertInqryAnswr */
		INSERT INTO TB_INQRY_ANSWR
		           (INQRYID
		           ,TITLE
		           ,CNTNTS
		           ,OPETRID
		           ,UPDT_DT
		           ,UPDTUSERID
		           ,REG_DT
		           ,REGUSERID)
		     VALUES
		           (#{inqryid}
		           ,#{title}
		           ,#{cntnts}
		           ,#{user.userid}
		           ,NOW()
		           ,#{user.userid}
		           ,NOW()
		           ,#{user.userid})
	</insert>
	
	<!-- 1:1문의답변 수정 -->
	<update id="updateInqryAnswr" parameterType="InqryAnswrVo">
		/* InqryDao.updateInqryAnswr */
		UPDATE TB_INQRY_ANSWR
		   SET INQRYID = #{inqryid}
		      ,TITLE = #{title}
		      ,CNTNTS = #{cntnts}
		      ,UPDT_DT = NOW()
		      ,UPDTUSERID =  #{user.userid}
		 WHERE ANSWRID = #{answrid}
	</update>
	
	<!-- 1:1문의답변 삭제 -->
	<delete id="deleteInqryAnswr" parameterType="InqryAnswrVo">
		/* InqryDao.deleteInqryAnswr */
		DELETE FROM TB_INQRY_ANSWR WHERE ANSWRID = #{answrid}
	</delete>
	
	<select id="selectAttachFileList"  parameterType="FileVo" resultType="FileVo">
	    /* InqryDao.selectAttachFileList */
		SELECT 
			A.FILEID,
			A.FILEGRPID,
			A.FILE_IDNTFC_KEY,
			A.FILE_PATH,
			A.SAVE_FILE_NM,
			A.ORGINL_FILE_NM,
			A.FILE_EXTSN,
			A.FILE_SIZE,
			A.ORD,
			A.REG_DT,
			A.REGUSERID
		FROM TB_FILE A
	   WHERE 1=1
	  	 AND A.FILEGRPID = #{filegrpid}
	</select>
</mapper>