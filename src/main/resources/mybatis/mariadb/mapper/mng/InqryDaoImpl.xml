<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : InqryDaoImpl.xml
	Description : 1:1문의
-->
<mapper namespace="com.kbrainc.plum.mng.inqry.model.InqryDao">

	<!-- 1:1문의리스트 가져옴 -->
	<select id="selectInqryList" parameterType="InqryVo" resultType="InqryVo">
		/* InqryDao.selectInqryList */
		<include refid="PaginationMapper.header"/>
		SELECT A.INQRYID /*문의글 일련번호*/
		      ,A.TITLE /*제목*/
		      ,E.NM /*작성자*/
		      ,F.CD_NM AS INQRY_STTS_CD /*상태*/
		      ,C.CD_NM AS INQRY_CL_NM /*분류*/
		      ,A.REG_DT AS REG_DT /*작성일*/
			  ,D.NM AS OPETR_NM /*처리자*/
        FROM TB_CMM_INQRY A
            LEFT OUTER JOIN TB_CMM_INQRY_ANSWR B ON A.INQRYID = B.INQRYID
            LEFT OUTER JOIN TB_CMM_USER D ON B.OPETRID = D.USERID
		    INNER JOIN (SELECT CD, CD_NM FROM TB_CMM_CD WHERE CDGRPID = #{cdgrpid}) C ON A.INQRY_CL_CD = C.CD
            INNER JOIN (SELECT CD, CD_NM FROM TB_CMM_CD WHERE CDGRPID = '103') F ON A.STTS_CD = F.CD
		    INNER JOIN TB_CMM_USER E ON E.USERID = A.USERID
		 WHERE 1=1 
			AND A.DEL_YN = 'N'
		<if test="searchKeyword != null and searchKeyword != ''">
			<if test="searchType == 'title'">
				AND A.TITLE LIKE CONCAT('%',#{searchKeyword},'%')
			</if>
			<if test="searchType == 'cntnts'">
				AND A.CNTNTS LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
			<if test="searchType == 'nm'">
				AND E.NM LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
			<if test="searchType == 'id'">
				AND E.ACNT LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
		</if>

		<if test="inqrySttsCd != null and inqrySttsCd != ''">
			AND F.CD = #{inqrySttsCd}
		</if>

		<if test="inqryClCd != null and inqryClCd != ''">
			AND C.CD = #{inqryClCd}
		</if>

		<include refid="PaginationMapper.footer"/>
	</select>
	
	<!-- 1:1문의 정보를 가져옴 -->
	<select id="selectInqryInfo" parameterType="InqryVo" resultType="InqryVo">
		/* InqryDao.selectInqryInfo */
	    SELECT A.INQRYID /*문의글 일련번호*/
	          ,A.USERID /*작성자 일련번호*/
			  ,A.TITLE /*제목*/
			  ,A.CNTNTS /*내용*/
			  ,C.NM /*작성자명*/
	          ,C.ACNT /*작성자 아이디명*/
	          ,D.INST_NM /*기관명*/
			  ,A.FILEGRPID
			  ,F.FILEID
			  ,F.ORGINL_FILE_NM AS FILE_NM
			  ,F.FILE_SIZE
			  ,B.CD_NM AS INQRY_CL_NM /*분류*/
	    	  ,A.STTS_CD AS INQRY_STTS_CD
	    	  ,A.REG_DT
        FROM TB_CMM_INQRY A
        	LEFT OUTER JOIN TB_CMM_FILE F ON A.FILEGRPID = F.FILEGRPID AND F.ORD=1
            INNER JOIN (SELECT CD, CD_NM FROM TB_CMM_CD WHERE CDGRPID = #{cdgrpid}) B ON A.INQRY_CL_CD = B.CD
		    INNER JOIN TB_CMM_USER C ON C.USERID = A.USERID
			LEFT OUTER JOIN TB_CMM_INST D ON D.INSTID = A.INSTID
        WHERE
            A.INQRYID = #{inqryid}
	</select>
	
	<!-- 1:1문의 답변정보를 가져옴 -->
	<select id="selectInqryAnswrInfo" parameterType="InqryAnswrVo" resultType="InqryAnswrVo">
		/* InqryDao.selectInqryAnswrInfo */
		SELECT A.INQRYID
		      ,A.ANSWRID
			  ,A.TITLE
			  ,A.CNTNTS
			  ,B.NM AS OPETR_NM
			  ,A.REG_DT
        FROM TB_CMM_INQRY_ANSWR A
    		LEFT OUTER JOIN TB_CMM_USER B ON A.OPETRID = B.USERID
        WHERE A.INQRYID = #{inqryid}
        LIMIT 1
	</select>
	
	<!-- 1:1문의답변 등록 -->
	<insert id="insertInqryAnswr" parameterType="InqryAnswrVo">
		/* InqryDao.insertInqryAnswr */
		INSERT INTO TB_CMM_INQRY_ANSWR
		           (INQRYID
		           ,TITLE
		           ,CNTNTS
		           ,OPETRID
		           ,MDFCN_DT
		           ,MDFRID
		           ,REG_DT
		           ,RGTRID)
		     VALUES
		           (#{inqryid}
		           ,#{title}
		           ,#{cntnts}
		           ,#{user.userid}
		           ,NOW()
		           ,#{user.userid}
		           ,NOW()
		           ,#{user.userid})
	</insert>
	
	<!-- 1:1문의답변 수정 -->
	<update id="updateInqryAnswr" parameterType="InqryAnswrVo">
		/* InqryDao.updateInqryAnswr */
		UPDATE TB_CMM_INQRY_ANSWR
		   SET INQRYID = #{inqryid}
		      ,TITLE = #{title}
		      ,CNTNTS = #{cntnts}
		   	  ,MDFCN_DT = NOW()
		   	  ,MDFRID =  #{user.userid}
		 WHERE ANSWRID = #{answrid}
	</update>

	<select id="selectAttachFileList"  parameterType="FileVo" resultType="FileVo">
	    /* InqryDao.selectAttachFileList */
		SELECT 
			A.FILEID,
			A.FILEGRPID,
			A.FILE_IDNTFC_KEY,
			A.FILE_PATH,
			A.SAVE_FILE_NM,
			A.ORGINL_FILE_NM,
			A.FILE_EXTSN,
			A.FILE_SIZE,
			A.ORD,
			A.REG_DT,
			A.RGTRID
		FROM TB_CMM_FILE A
	   WHERE 1=1
	  	 AND A.FILEGRPID = #{filegrpid}
	</select>

	<update id="deleteInqryInfo">
		UPDATE TB_CMM_INQRY
			SET DEL_YN = 'Y'
			,MDFCN_DT = NOW()
			,MDFRID = #{userVo.userid}
		WHERE INQRYID IN
			(
			<foreach item="inqryId" collection="deleteInqryIds"  separator=",">
				#{inqryId}
			</foreach>
			)
	</update>

	<update id="updateInqrySttsCd" parameterType="InqryAnswrVo">
		UPDATE TB_CMM_INQRY
			SET STTS_CD = #{inqrySttsCd}
		WHERE INQRYID = #{inqryid}
	</update>

</mapper>