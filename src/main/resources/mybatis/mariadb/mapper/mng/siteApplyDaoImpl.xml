<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : SiteApplyDaoImpl.xml
	Description : 사이트 신청 관리
-->
<mapper namespace="com.kbrainc.plum.mng.siteApply.model.SiteApplyDao">

    <!-- 기관정보 목록 조회 -->
    <select id="selectSiteApplyList" parameterType="SiteApplyVo" resultType="SiteApplyVo">
        /* SiteApplyDao.selectSiteApplyList */
        <include refid="PaginationMapper.header"/>
              SELECT 
                A.APLYID
                ,A.INSTID
                ,A.INST_NM
                ,A.INST_CNTCT
                ,A.INST_EML
                ,A.USERID
                ,A.APLCNT_NM
                ,A.ZIP
                ,A.ADDR
                ,A.ADDR_DTL
                ,A.DOMN
                ,A.CN
                ,A.CPYRHT
                ,A.APLY_DT
                ,A.APLY_STTS_CD
                ,A.AUTZRID
                ,A.LOGO_FILEID
                ,A.MDFCN_DT
                ,A.MDFRID
                ,A.REG_DT
                ,A.RGTRID
                ,B.INST_CD 
              FROM 
                TB_CMM_SITE_APLY A
                INNER JOIN TB_CMM_INST B
                ON A.INSTID = B.INSTID 
              WHERE 1=1
                <if test="searchKeyword != null and searchKeyword != '' and searchType == 'instNm'">
                   AND A.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
                </if>
                <if test="searchKeyword != null and searchKeyword != '' and searchType == 'domn'">
                   AND A.DOMN LIKE CONCAT('%',#{searchKeyword},'%')
                </if>
                <if test="searchKeyword != null and searchKeyword != '' and searchType == 'instCd'">
                   AND B.INST_CD LIKE CONCAT('%',#{searchKeyword},'%')
                </if>
                <if test="searchAplySttsCd != null and searchAplySttsCd != '' ">
                   AND A.APLY_STTS_CD = #{searchAplySttsCd}
                </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 사이트 신청 정보 상세 조회 -->
    <select id="selectSiteApplyInfo" parameterType="SiteApplyVo" resultType="SiteApplyVo">
           /* SiteApplyDao.selectSiteApplyInfo */
               SELECT 
                A.APLYID
                ,A.INSTID
                ,A.INST_NM
                ,A.INST_CNTCT
                ,A.INST_EML
                ,A.USERID
                ,D.NM AS APLCNT_NM
                ,A.ZIP
                ,A.ADDR
                ,A.ADDR_DTL
                ,A.DOMN
                ,A.CN
                ,A.CPYRHT
                ,A.APLY_DT
                ,A.APLY_STTS_CD
                ,A.AUTZRID
                ,A.LOGO_FILEID
                ,A.MDFCN_DT
                ,A.MDFRID
                ,A.REG_DT
                ,A.RGTRID
                ,B.INST_CD 
                ,C.FILE_IDNTFC_KEY
              FROM 
                TB_CMM_SITE_APLY A
                INNER JOIN TB_CMM_INST B
                ON A.INSTID = B.INSTID
                LEFT OUTER JOIN TB_CMM_FILE C
                ON A.LOGO_FILEID = C.FILEID
                INNER JOIN TB_CMM_USER D
                ON A.USERID = D.USERID 
              WHERE 1=1    
                AND A.APLYID = #{aplyid}  
    </select>
    
    <!-- 신청 승인 상태 수정--> 
    <update id="updateSiteApplyStatus" parameterType="SiteApplyVo" >
         /* SiteApplyDao.updateSiteApplyStatus */
        UPDATE TB_CMM_SITE_APLY 
           SET
               APLY_STTS_CD       = #{aplySttsCd}                     
               ,AUTZRID           = #{user.userid}                         
               ,MDFCN_DT          = NOW()                         
               ,MDFRID            = #{user.userid}                
         WHERE 1=1
           AND APLYID = #{aplyid}
    </update>
    
    <!-- 사이트 신청 메뉴 조회 -->
    <select id="selectSiteApplyMenuList" parameterType="SiteApplyVo" resultType="SiteApplyMenuVo">
         /* SiteApplyDao.selectSiteApplyMenuList */
           SELECT
              A.APLYID 
              ,A.APLY_MENU_CD 
              ,B.CD_NM AS aplyMenuCdNm
              ,B.OPTN1
              ,IF (B.OPTN2 = 'required','Y','N') AS requiredYn
              ,IF (B.OPTN3 = 'show','Y','N') AS showYn
             FROM
              TB_CMM_SITE_APLY_MENU A
              INNER JOIN (
                 SELECT 
                   CD
                   ,CD_NM
                   ,OPTN1
                   ,OPTN2
                   ,OPTN3
                  FROM
                   TB_CMM_CD 
                 WHERE 1=1
                   AND CDGRPID = 124
                   AND OPTN3 ='show'  
              ) B ON A.APLY_MENU_CD = B.CD
              WHERE 1=1 
                AND A.APLYID = #{aplyid}
               ORDER BY A.APLY_MENU_CD  
    </select>            
        
</mapper>