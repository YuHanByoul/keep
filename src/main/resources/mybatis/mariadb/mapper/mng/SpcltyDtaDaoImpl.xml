<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!--
	SQL File Name : SpcltyDtaDaoImpl.xml
	Description : 전문자료 관리
-->
<mapper namespace="com.kbrainc.plum.mng.spcltyDta.model.SpcltyDtaDao">
    <select id="selectSpcltyDtaList" resultType="com.kbrainc.plum.mng.spcltyDta.model.SpcltyDtaVo">
        <include refid="PaginationMapper.header"/>
        SELECT A.DTAID
        , A.YY
        , B.CLSF_CD
        , A.WRITR
        , A.TTL
        , A.REG_DT
        , A.HITS
        , A.DEL_YN
        FROM TB_CMM_SPCLTY_DTA A
        INNER JOIN
        (
            SELECT TCSDC.DTAID, GROUP_CONCAT(TCC.CD_NM) CLSF_CD
            FROM TB_CMM_SPCLTY_DTA_CLSF TCSDC
            INNER JOIN TB_CMM_CD TCC
            ON TCSDC.CLSF_CD = TCC.CD
            GROUP BY TCSDC.DTAID
        ) B
            ON B.DTAID = A.DTAID
        WHERE 1=1
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test="searchType == 'ttl'">
                    AND A.TTL LIKE CONCAT('%', #{searchKeyword}, '%')
                </when>
                <when test="searchType == 'cn'">
                    AND A.CN LIKE CONCAT('%', #{searchKeyword}, '%')
                </when>
                <otherwise>
                    AND (A.CN LIKE CONCAT('%', #{searchKeyword}, '%') OR A.TTL LIKE CONCAT('%', #{searchKeyword}, '%'))
                </otherwise>
            </choose>
        </if>

        <if test="yy != null and yy != ''">
            AND A.YY = #{yy}
        </if>

        <if test="writr != null and writr != ''">
            AND A.WRITR LIKE CONCAT('%', #{writr}, '%')
        </if>

        <if test="searchClsfCdNm != null and searchClsfCdNm != ''">
            AND B.CLSF_CD LIKE CONCAT('%',#{searchClsfCdNm}, '%')
        </if>

        <if test="searchBgngDt != null and searchBgngDt != ''">
            AND DATE_FORMAT(A.REG_DT, '%Y-%m-%d') <![CDATA[>=]]> #{searchBgngDt}
        </if>

        <if test="searchEndDt != null and searchEndDt != ''">
            AND DATE_FORMAT(A.REG_DT, '%Y-%m-%d') <![CDATA[<=]]> #{searchEndDt}
        </if>

        <include refid="PaginationMapper.footer"/>
    </select>

    <select id="selectSpcltyDta" resultType="com.kbrainc.plum.mng.spcltyDta.model.SpcltyDtaVo">
        SELECT
            A.DTAID
            , A.YY
            , A.WRITR
            , A.TTL
            , A.CN
            , A.PDF_FILEGRPID
            , A.ATCH_FILEGRPID
            , A.CPYRHT_CD
            , A.REG_DT
            , A.RGTRID
            , A.MDFCN_DT
            , A.DEL_YN
            , B.CLSF_CD
            , C.NM AS RGTR_NM
            , C.ACNT AS RGTR_ACNT
        FROM
            TB_CMM_SPCLTY_DTA A
        INNER JOIN
        (
            SELECT DTAID, GROUP_CONCAT(CLSF_CD) CLSF_CD
            FROM TB_CMM_SPCLTY_DTA_CLSF
            GROUP BY DTAID
        ) B
            ON A.DTAID = B.DTAID
        INNER JOIN TB_CMM_USER C
            ON A.RGTRID = C.USERID
        WHERE A.DTAID = #{dtaid}
    </select>

    <insert id="insertSpcltyDta" useGeneratedKeys="true" keyProperty="dtaid">
        INSERT INTO TB_CMM_SPCLTY_DTA (
            YY
            , WRITR
            , TTL
            , CN
            , PDF_FILEGRPID
            , ATCH_FILEGRPID
            , CPYRHT_CD
            , HITS
            , DEL_YN
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{yy}
            , #{writr}
            , #{ttl}
            , #{cn}
            , #{pdfFilegrpid}
            , #{atchFilegrpid}
            , #{cpyrhtCd}
            , 0
            , 'N'
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>

    <insert id="insertSpcltyDtaClsfMapping">
        INSERT INTO TB_CMM_SPCLTY_DTA_CLSF (
            DTAID
            , CLSF_CD
            , REG_DT
            , RGTRID
        ) VALUES
        <foreach collection="clsfCds" item="clsfCd" separator=",">
            (
            #{dtaid}
            , #{clsfCd}
            , NOW()
            , #{user.userid}
            )
        </foreach>
    </insert>

    <update id="updateSpcltyDta">
        UPDATE TB_CMM_SPCLTY_DTA
        SET
            YY = #{yy}
            , WRITR = #{writr}
            , TTL = #{ttl}
            , CN = #{cn}
            , PDF_FILEGRPID = #{pdfFilegrpid}
            , ATCH_FILEGRPID = #{atchFilegrpid}
            , CPYRHT_CD = #{cpyrhtCd}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE DTAID = #{dtaid}
    </update>

    <update id="deleteSpcltyDta">
        UPDATE TB_CMM_SPCLTY_DTA
        SET
            DEL_YN = 'Y'
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE
            DTAID IN
            <foreach collection="deleteDtaids" item="dtaid" separator="," open="(" close=")">
                #{dtaid}
            </foreach>
    </update>

    <delete id="deleteSpcltyDtaClsfMapping" >
        DELETE FROM TB_CMM_SPCLTY_DTA_CLSF
        WHERE DTAID = #{dtaid}
    </delete>

</mapper>