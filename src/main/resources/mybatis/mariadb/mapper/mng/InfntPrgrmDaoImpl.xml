<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : InfntPrgrmDaoImpl.xml
	Description : 환경교육 NOW -> 교육프로그램관리
-->
<mapper namespace="com.kbrainc.plum.mng.prtpn.infntPrgrm.model.InfntPrgrmDao">
    
    <!-- 교육프로그램 관리 게시글 목록 조회 -->
    <select id="selectInfntPrgrmList" parameterType="InfntPrgrmVo" resultType="InfntPrgrmVo">
        /* InfntPrgrmDao.selectInfntPrgrmList */
        <include refid="PaginationMapper.header"/>
        SELECT 
        A.PRGRMID
        , A.CLSSRMID
        , B.CLSSRM_NM
        , B.EDU_TYPE_CD
        , A.EDU_YR
        , A.PRGRM_NM
        -- , C.CLSF_CD
        , CONCAT((SELECT A.CD_NM FROM TB_CMM_CD A WHERE A.CD = F.UPPR_CD), '  <![CDATA[>]]> ', F.CD_NM) AS CLSF_NM
        , A.EDU_NOPE
        , A.EDU_HR_MNT
        , E.CD_NM AS RCPT_MTHD_NM
        , A.RCPT_MTHD_CD
        , A.EDU_EXPLN
        , A.MTTRAT
        , A.EDU_INTRCN_FILEID
        , A.EDU_PHOTO_FILEID
        , A.MON_YN
        , A.TUES_YN
        , A.WED_YN
        , A.THUR_YN
        , A.FRI_YN
        , A.SAT_YN
        , A.SUN_YN
        , CASE WHEN A.USE_YN = 'Y' THEN '사용' ELSE '미사용' END AS USE_YN
        -- , D.TRGT_CD
        ,(SELECT GROUP_CONCAT(TB.CD_NM SEPARATOR',') FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG TA, TB_CMM_CD TB WHERE TA.PRGRMID = A.PRGRMID and TA.TRGT_CD = TB.CD) AS TRGT_NM
        , A.MDFCN_DT
        , A.MDFRID
        , A.REG_DT
        , A.RGTRID
        FROM TB_EDU_INFNT_PRGRM A
        LEFT OUTER JOIN TB_EDU_CLSSRM B ON A.CLSSRMID = B.CLSSRMID 
        LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_CLSF_MAPNG C ON A.PRGRMID = C.PRGRMID
        -- LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TRGT_MAPNG D ON A.PRGRMID = D.PRGRMID
        LEFT OUTER JOIN TB_CMM_CD E ON E.CD = A.RCPT_MTHD_CD
        LEFT OUTER JOIN TB_CMM_CD F ON F.CD = C.CLSF_CD
        WHERE
        1=1
            <if test="searchKeyword != null and searchKeyword != ''">
            AND A.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchEduYr != null and searchEduYr != ''">
            AND A.EDU_YR = #{searchEduYr}
            </if>
            <if test="searchClssrmId != null and searchClssrmId != ''">
            AND A.CLSSRMID = #{searchClssrmId}
            </if>
            <if test="searchClsfCd != null and searchClsfCd != ''">
            AND C.CLSF_CD = #{searchClsfCd}
            </if>
            <if test="searchRcptMthdCd != null and searchRcptMthdCd != ''">
            AND A.RCPT_MTHD_CD = #{searchRcptMthdCd}
            </if>
            <if test="searchUseYn != null and searchUseYn != ''">
            AND A.USE_YN = #{searchUseYn}
            </if>                                    
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 교육프로그램 관리 게시글 등록 --> 
    <insert id="insertInfntPrgrm" parameterType="InfntPrgrmVo" useGeneratedKeys="true" keyProperty="prgrmId">
        /* InfntPrgrmDao.insertInfntPrgrm */
        INSERT INTO TB_EDU_INFNT_PRGRM (
            CLSSRMID
            , EDU_YR
            , PRGRM_NM
            , EDU_NOPE
            , EDU_HR_MNT
            , RCPT_MTHD_CD
            , EDU_EXPLN
            , MTTRAT
            , EDU_INTRCN_FILEID
            , EDU_PHOTO_FILEID
            , MON_YN
            , TUES_YN
            , WED_YN
            , THUR_YN
            , FRI_YN
            , SAT_YN
            , SUN_YN
            , USE_YN
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        )VALUES(
            #{clssrmId}
            ,#{eduYr}
            ,#{prgrmNm}
            ,#{eduNope}
            ,#{eduHrMnt}
            ,#{rcptMthdCd}
            ,#{eduExpln}
            ,#{mttrat}
            ,#{eduIntrcnFileid}
            ,#{eduPhotoFileid}
            ,#{monYn}
            ,#{tuesYn}
            ,#{wedYn}
            ,#{thurYn}
            ,#{friYn}
            ,#{satYn}
            ,#{sunYn}
            ,#{useYn}
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
        )
    </insert>
    <!-- 교육프로그램 분류 매핑 등록 --> 
    <insert id="insertInfntPrgrmClsfMapng" parameterType="InfntPrgrmVo" keyProperty="InfntPrgrmVo">
        /* InfntPrgrmDao.insertInfntPrgrmClsfMapng */
        INSERT INTO TB_EDU_INFNT_PRGRM_CLSF_MAPNG (
            PRGRMID
            , CLSF_CD
            , REG_DT
            , RGTRID
        )VALUES(
            #{prgrmId}
            ,#{clsfCd}
            ,NOW()
            ,#{user.userid}
        )
    </insert>
    <!-- 교육프로그램 대상 매핑 등록 --> 
    <insert id="insertInfntPrgrmTrgtMapng" parameterType="InfntPrgrmVo" keyProperty="InfntPrgrmVo">
        /* InfntPrgrmDao.insertInfntPrgrmTrgtMapng */
        INSERT INTO TB_EDU_INFNT_PRGRM_TRGT_MAPNG (
            PRGRMID
            , TRGT_CD
            , REG_DT
            , RGTRID
        )VALUES(
            #{prgrmId}
            ,#{trgtCd}
            ,NOW()
            ,#{user.userid}
        )
    </insert>
    <!-- 교육프로그램 회차 등록 --> 
    <insert id="insertInfntPrgrmTme" parameterType="InfntPrgrmVo" keyProperty="InfntPrgrmVo">
        /* InfntPrgrmDao.insertInfntPrgrmTme */
        <foreach collection="infntPrgrmVoList" item="item" index="index" separator=";">
        INSERT INTO TB_EDU_INFNT_PRGRM_TME (
            PRGRMID
            , TME_NM
            , MON_YN
            , TUES_YN
            , WED_YN
            , THUR_YN
            , FRI_YN
            , SAT_YN
            , SUN_YN
            , BGNG_TM
            , END_TM
            , ORDR
            , USE_YN
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        )VALUES(
            #{item.prgrmId}
            ,#{item.tmeNm}
            ,#{item.tmeMonYn}
            ,#{item.tmeTuesYn}
            ,#{item.tmeWedYn}
            ,#{item.tmeThurYn}
            ,#{item.tmeFriYn}
            ,#{item.tmeSatYn}
            ,#{item.tmeSunYn}
            ,#{item.bgngTm}
            ,#{item.endTm}
            ,#{item.ordr}
            ,#{item.useYn}
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
        )            
        </foreach>            
    </insert>    
        
    <!-- 교육프로그램 관리 상세조회 -->
    <select id="selectInfntPrgrmInfo" parameterType="InfntPrgrmVo" resultType="InfntPrgrmVo"> 
        /* InfntPrgrmDao.selectInfntPrgrmInfo */
        SELECT 
            A.PRGRMID
            , A.CLSSRMID
            , B.CLSSRM_NM
            , B.EDU_TYPE_CD
            , A.EDU_YR
            , A.PRGRM_NM
            ,(SELECT GROUP_CONCAT(TB.CD SEPARATOR',') FROM TB_EDU_MVMN_PRGRM_CLSF_MAPNG TA, TB_CMM_CD TB WHERE TA.PRGRMID = A.PRGRMID and TA.CLSF_CD = TB.CD) AS CLSF_CD
            , A.EDU_NOPE
            , A.EDU_HR_MNT
            , A.RCPT_MTHD_CD
            , A.EDU_EXPLN
            , A.MTTRAT
            , A.EDU_INTRCN_FILEID
            , A.EDU_PHOTO_FILEID
            , A.MON_YN
            , A.TUES_YN
            , A.WED_YN
            , A.THUR_YN
            , A.FRI_YN
            , A.SAT_YN
            , A.SUN_YN
            , A.USE_YN
            ,(SELECT GROUP_CONCAT(TB.CD SEPARATOR',') FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG TA, TB_CMM_CD TB WHERE TA.PRGRMID = A.PRGRMID and TA.TRGT_CD = TB.CD) AS TRGT_CD
            , A.MDFCN_DT
            , A.MDFRID
            , A.REG_DT
            , A.RGTRID
            FROM TB_EDU_INFNT_PRGRM A
            LEFT OUTER JOIN TB_EDU_CLSSRM B ON A.CLSSRMID = B.CLSSRMID 
            LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_CLSF_MAPNG C ON A.PRGRMID = C.PRGRMID
            -- LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TRGT_MAPNG D ON A.PRGRMID = D.PRGRMID
            LEFT OUTER JOIN TB_CMM_CD E ON E.CD = A.RCPT_MTHD_CD
            LEFT OUTER JOIN TB_CMM_CD F ON F.CD = C.CLSF_CD      
       WHERE A.PRGRMID = #{prgrmId}
    </select>
    
    <!-- 교육프로그램관리 게시글 수정 -->
    <update id="updateInfntPrgrm" parameterType="InfntPrgrmVo" keyProperty="InfntPrgrmVo">
        /* InfntPrgrmDao.updateInfntPrgrm */
        UPDATE TB_EDU_INFNT_PRGRM SET
                CLSSRMID                        = #{clssrmId}
                , EDU_YR                        = #{eduYr}
                , PRGRM_NM                      = #{prgrmNm}
                , EDU_NOPE                      = #{eduNope}
                , EDU_HR_MNT                    = #{eduHrMnt}
                , RCPT_MTHD_CD                  = #{rcptMthdCd}
                , EDU_EXPLN                     = #{eduExpln}
                , MTTRAT                        = #{mttrat}
                , EDU_INTRCN_FILEID             = #{eduIntrcnFileid}
                , EDU_PHOTO_FILEID              = #{eduPhotoFileid}
                , MON_YN                        = #{monYn}
                , TUES_YN                       = #{tuesYn}
                , WED_YN                        = #{wedYn}
                , THUR_YN                       = #{thurYn}
                , FRI_YN                        = #{friYn}
                , SAT_YN                        = #{satYn}
                , SUN_YN                        = #{sunYn}
                , USE_YN                        = #{useYn}
                , MDFCN_DT                      = NOW()
                , MDFRID                        = #{user.userid}
         WHERE PRGRMID                          = #{prgrmId}
    </update>    
    
    <!-- 교육프로그램 분류 매핑 수정 -->
    <update id="updateInfntPrgrmClsfMapng" parameterType="InfntPrgrmVo" keyProperty="InfntPrgrmVo">
        /* InfntPrgrmDao.updateInfntPrgrmClsfMapng */
        UPDATE TB_EDU_INFNT_PRGRM_CLSF_MAPNG SET
                CLSF_CD                         = #{clsfCd}
                , REG_DT                        = NOW()
                , MDFRID                        = #{user.userid}
         WHERE PRGRMID                          = #{prgrmId}
    </update>
    
    <!-- 교육프로그램 대상 매핑 수정 -->
    <update id="updateInfntPrgrmTrgtMapng" parameterType="InfntPrgrmVo" keyProperty="InfntPrgrmVo">
        /* InfntPrgrmDao.updateInfntPrgrmTrgtMapng */
        UPDATE TB_EDU_INFNT_PRGRM_TRGT_MAPNG SET
                TRGT_CD                         = #{trgtCd}
                , REG_DT                        = NOW()
                , MDFRID                        = #{user.userid}
         WHERE PRGRMID                          = #{prgrmId}
    </update>
        
    <!-- 교육프로그램 회차 수정 -->
    <update id="updateInfntPrgrmTme" parameterType="InfntPrgrmVo" keyProperty="InfntPrgrmVo">
        /* InfntPrgrmDao.updateInfntPrgrmTme */
        UPDATE TB_EDU_INFNT_PRGRM_TME SET
                PRGRMID                         = #{prgrmId}        
                , TME_NM                        = #{tmeNm}         
                , MON_YN                        = #{monYn}         
                , TUES_YN                       = #{tuesYn}        
                , WED_YN                        = #{wedYn}         
                , THUR_YN                       = #{thurYn}        
                , FRI_YN                        = #{friYn}         
                , SAT_YN                        = #{satYn}         
                , SUN_YN                        = #{sunYn}         
                , BGNG_TM                       = #{bgngTm}        
                , END_TM                        = #{endTm}         
                , ORDR                          = #{ordr}          
                , USE_YN                        = #{useYn}         
                , MDFCN_DT                      = NOW()            
                , MDFRID                        = #{user.userid}   
         WHERE TMEID                            = #{tmeId}
    </update>  
    
    <!-- 교육대상 저장 -->
    <insert id="insertTrgtCd" parameterType="InfntPrgrmVo" >
         /* InfntPrgrmDao.insertTrgtCd */
         INSERT INTO TB_EDU_INFNT_PRGRM_TRGT_MAPNG(
              PRGRMID
              ,TRGT_CD
              ,REG_DT
              ,RGTRID
         )VALUES
          <foreach item="item" collection="trgtCds"  separator=",">
           (
             #{prgrmId}
             ,#{item}
             ,NOW()
             ,#{user.userid}
            )
          </foreach>
    </insert>
    
    <!-- 교육주제 저장 -->
    <insert id="insertClsfCd" parameterType="InfntPrgrmVo" >
         /* InfntPrgrmDao.insertClsfCd */
         INSERT INTO TB_EDU_INFNT_PRGRM_CLSF_MAPNG(
              PRGRMID
              ,CLSF_CD
              ,REG_DT
              ,RGTRID
         )VALUES
          <foreach item="item" collection="clsfCds"  separator=",">
           (
             #{prgrmId}
             ,#{item}
             ,NOW()
             ,#{user.userid}
            )
          </foreach>
    </insert>     
    
    <!-- 교육대상 삭제 -->
    <insert id="deleteTrgtCd" parameterType="InfntPrgrmVo" >
         /* InfntPrgrmDao.deleteTrgtCd */
         DELETE FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG
         WHERE 1=1
           AND PRGRMID = #{prgrmId}
    </insert>     
    
    <!-- 교육주제 삭제 -->
    <insert id="deleteClsfCd" parameterType="InfntPrgrmVo" >
         /* InfntPrgrmDao.deleteClsfCd */
         DELETE FROM TB_EDU_INFNT_PRGRM_CLSF_MAPNG
         WHERE 1=1
           AND PRGRMID = #{prgrmId}
    </insert>     

    <!-- 교육프로그램 관리 회차 목록 조회 -->
    <select id="selectInfntPrgrmTmeList" parameterType="InfntPrgrmVo" resultType="InfntPrgrmVo">
        /* InfntPrgrmDao.selectInfntPrgrmTmeList */
        <include refid="PaginationMapper.header"/>
        SELECT 
        A.PRGRMID
        , A.TME_NM        
        , A.MON_YN
        , A.TUES_YN
        , A.WED_YN
        , A.THUR_YN
        , A.FRI_YN
        , A.SAT_YN
        , A.SUN_YN
        , A.BGNG_TM
        , A.END_TM
        , A.ORDR
        , A.USE_YN
        , A.MDFCN_DT
        , A.MDFRID
        , A.REG_DT
        , A.RGTRID        
        FROM TB_EDU_INFNT_PRGRM_TME A
        WHERE
        1=1
        <choose>
            <when test="prgrmId != null">
                AND A.PRGRMID = #{prgrmId}
            </when>
            <otherwise>            
            </otherwise>
        </choose>        
        <include refid="PaginationMapper.footer"/>
    </select>    
</mapper>