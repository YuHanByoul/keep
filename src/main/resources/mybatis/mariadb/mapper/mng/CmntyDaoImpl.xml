<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : CmntyDaoImpl.xml
	Description : 커뮤니티 관리
-->
<mapper namespace="com.kbrainc.plum.mng.cmnty.model.CmntyDao">
    
    <!-- 커뮤니티 목록 조회 -->
    <select id="selectCmntyList" parameterType="CmntyVo" resultType="CmntyVo">
        /* CmntyDao.selectCmntyList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.CMNTYID
            , A.CMNTY_NM
            , A.ESTERID
            , C.ACNT
            , C.NM
            , COUNT(B.USERID) AS MBR_CNT
            , A.OPER_YN
            , A.REG_DT            
        FROM
            TB_CMT_CMNTY A            
        LEFT OUTER JOIN
            TB_CMT_CMNTY_MBR B ON (B.CMNTYID = A.CMNTYID)
        INNER JOIN (
            SELECT 
                USERID
                , ACNT
                , NM 
            FROM 
                TB_CMM_USER
        ) C ON (C.USERID = A.ESTERID) 
        WHERE 
            1 = 1
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'cmntyNm'">
            AND A.CMNTY_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'nm'">
            AND C.NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'acnt'">
            AND C.ACNT LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchOperYn != null and searchOperYn != ''">
            AND A.OPER_YN = #{searchOperYn}
        </if>
        GROUP BY
            A.CMNTYID
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 커뮤니티 정보 조회 -->
    <select id="selectCmntyInfo" parameterType="CmntyVo" resultType="CmntyVo">
        /* CmntyDao.selectCmntyInfo */
        SELECT
            A.CMNTYID
            , A.CMNTY_NM
            , A.CMNTY_INTRCN
            , A.ESTERID
            , A.JOINAPRVMTHD_CD
            , A.RLS_YN
            , A.SRCH_EXPSR_YN
            , A.OPER_YN
            , A.CMNTY_LOGO_FILEID
        FROM
            TB_CMT_CMNTY A
        WHERE 
            A.CMNTYID = #{cmntyid}
    </select>
    
    <!-- 커뮤니티 게시판 템플릿 목록 조회 -->
    <select id="selectCmntyCtgryList" parameterType="CmntyCtgryVo" resultType="CmntyCtgryVo">
        /* CmntyDao.selectCmntyCtgryList */
        SELECT
            A.CMNTYID
            , A.CMNTY_BBS_TMPLATID
            , A.ORDR
        FROM
            TB_CMT_CMNTY_CTGRY A
        WHERE 
            A.CMNTYID = #{cmntyid}
        ORDER BY 
            A.ORDR
    </select>
    
    <!-- 커뮤니티 회원 목록 조회 -->
    <select id="selectCmntyMbrList" parameterType="CmntyMbrVo" resultType="CmntyMbrVo">
        /* CmntyDao.selectCmntyMbrList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.CMNTYID
            , B.ACNT
            , B.NM
            , A.MBR_STTS_CD
            , A.AUTHRT_CD
            , A.JOIN_APLY_DT
            , A.JOIN_APRV_DT
            , A.REG_DT
        FROM
            TB_CMT_CMNTY_MBR A            
        INNER JOIN (
            SELECT 
                USERID
                , ACNT
                , NM 
            FROM 
                TB_CMM_USER
        ) B ON (B.USERID = A.USERID)
        WHERE 
            A.CMNTYID = #{cmntyid}
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 커뮤니티 게시글 목록 조회 -->
    <select id="selectCmntyPstList" parameterType="CmntyPstVo" resultType="CmntyPstVo">
        /* CmntyDao.selectCmntyPstList */
        <include refid="PaginationMapper.header"/>
        SELECT 
            A.PSTID
            , A.BBSID
            , A.TTL
            , A.REG_DT
            , A.RGTRID
            , B.ACNT
            , B.NM
        FROM 
            TB_CMT_CMNTY_PST A
        INNER JOIN (
            SELECT 
                USERID
                , ACNT
                , NM 
            FROM 
                TB_CMM_USER
        ) B ON (B.USERID = A.RGTRID)
        WHERE
            A.DEL_YN = 'N' 
            AND A.BBSID = (
                SELECT 
                    BBSID 
                FROM 
                    TB_CMT_CMNTY_BBS 
                WHERE CMNTYID = #{cmntyid} 
                    AND CMNTY_BBS_TMPLATID = #{cmntyBbsTmplatid}
            )
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 커뮤니티 게시글 정보 조회 -->
    <select id="selectCmntyPstInfo"  parameterType="CmntyPstVo" resultType ="CmntyPstVo" >
        /* CmntyDao.selectCmntyPstInfo */
        SELECT 
            A.PSTID
            , A.BBSID
            , A.BBS_CLSFID
            , A.TTL
            , A.CN
            , A.PARNTS_PSTID
            , A.GRP
            , A.DPTH
            , A.SORTORDR
            , A.HITS
            , A.FX_NTC_YN
            , A.FX_NTC_BGNG_DT
            , A.FX_NTC_END_DT
            , A.LGN_YN
            , A.FILEGRPID
            , B.ACNT
            , B.NM
        FROM
            TB_CMT_CMNTY_PST A
        INNER JOIN (
            SELECT 
                USERID
                , ACNT
                , NM 
            FROM 
                TB_CMM_USER
        ) B ON (B.USERID = A.RGTRID)    
        WHERE 
            A.PSTID = #{pstid}
    </select>
    
    <!-- 커뮤니티 게시글 삭제(논리) -->
    <update id="deleteCmntyPst" parameterType="CmntyPstVo">
        /* QestnrDao.deleteCmntyPst */
        UPDATE TB_CMT_CMNTY_PST SET
            DEL_YN = 'Y'
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE
            PSTID IN
        <foreach item="item" collection="deletePstids" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </update>
    
    <!-- 커뮤니티 댓글 목록 조회 -->
    <select id="selectCmntyCmntList" parameterType="CmntyPstVo" resultType="CmntyCmntVo">
        /* CmntyDao.selectCmntyCmntList */
        <include refid="PaginationMapper.header"/>
        SELECT 
              A.CMNTID
              , A.CN
              , A.PARNTS_CMNTID
              , A.CMNT_GRP
              , A.DPTH
              , A.SORTORDR
              , A.RLS_YN
              , A.DEL_YN
              , A.REG_DT
              , B.ACNT
              , B.NM
        FROM 
            TB_CMT_CMNTY_CMNT A
        INNER JOIN (
            SELECT 
                USERID
                , ACNT
                , NM 
            FROM 
                TB_CMM_USER
        ) B ON (B.USERID = A.RGTRID)
        WHERE
            A.PSTID = #{pstid}
        <include refid="PaginationMapper.footer"/>
    </select>
    
        <!-- 커뮤니티 댓글 삭제(논리) -->
    <update id="deleteCmntyCmnt" parameterType="CmntyCmntVo">
        /* QestnrDao.deleteCmntyCmnt */
        UPDATE TB_CMT_CMNTY_CMNT SET
            DEL_YN = 'Y'
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE
            CMNTID = #{cmntid}
    </update>
    
</mapper>