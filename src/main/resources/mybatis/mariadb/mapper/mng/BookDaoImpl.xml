<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : BookDaoImpl.xml
	Description : 콘텐츠 관리
-->
<mapper namespace="com.kbrainc.plum.mng.book.model.BookDao">
    
    <!-- 우수환경도서 관리 목록 조회 -->
    <select id="selectBookList" parameterType="BookVo" resultType="BookVo">
        /* BookDao.selectBookList */
        <include refid="PaginationMapper.header"/>
        SELECT 
           A.*
          FROM 
          (
           SELECT
                A.BOOKID
                , A.TTL
                , GROUP_CONCAT(B2.CD_NM, ' > ', B1.CD_NM) AS EDU_SBJCT_CD_NM
                , A.EDU_TRGT_CD 
                , A.PLSCMPN
                , A.RPRS_IMG_FILEID
                , E.FILEGRPID
                , A.WRITR
                , NVL(A.HITS,0) AS HITS
                , A.CN
                , A.REG_DT
                , A.DEL_YN
                ,GROUP_CONCAT(B.EDU_SBJCT_CD) AS EDUSBJCTCD 
                ,GROUP_CONCAT(DISTINCT  LEFT(B.EDU_SBJCT_CD,6)) AS UPPR_EDUSBJCTCD
            FROM
                TB_CMM_BOOK A
                LEFT OUTER JOIN tb_cmm_book_sbjct B ON A.BOOKID = B.BOOKID 
                LEFT OUTER JOIN TB_CMM_CD B1 ON B.EDU_SBJCT_CD = B1.CD
                LEFT OUTER JOIN TB_CMM_CD B2 ON B1.UPPR_CD = B2.CD
                LEFT OUTER JOIN TB_CMM_FILE E ON A.RPRS_IMG_FILEID = E.FILEID
              GROUP BY A.BOOKID
             ) A
            WHERE 1=1
            <!-- 키워드 -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchTtl'">
            AND A.TTL LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchCn'">
            AND A.CN LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchTtlCn'">
            AND (A.TTL LIKE CONCAT('%',#{searchKeyword},'%') OR A.CN LIKE CONCAT('%',#{searchKeyword},'%'))
            </if>
            
            <!-- 교육주제 -->
            <if test="searchManinEduSbjctCd != null and searchManinEduSbjctCd != ''">
            AND UPPR_EDUSBJCTCD LIKE CONCAT('%',#{searchManinEduSbjctCd},'%')
            </if>
            <if test="searchMdleEduSbjctCd != null and searchMdleEduSbjctCd != ''">
            AND EDUSBJCTCD  LIKE CONCAT('%',#{searchMdleEduSbjctCd},'%')
            </if>
            
            <!-- 교육대상 -->
            <if test="searchEduTrgtCd != null and searchEduTrgtCd != ''">
            AND EDU_TRGT_CD = #{searchEduTrgtCd}
            </if>
            
            <!-- 출판사 -->
            <if test="searchPlscmpn != null and searchPlscmpn != ''">
            AND A.PLSCMPN LIKE CONCAT('%',#{searchPlscmpn},'%')
            </if>
            
            <!-- 등록일(시작일, 종료일) -->
            <if test="startDt != null and startDt != ''">
            <![CDATA[
                AND DATE(A.REG_DT) >= #{startDt}
            ]]>
            </if>
            <if test="endDt != null and endDt != ''">
            <![CDATA[
                AND DATE(A.REG_DT) <= #{endDt}
            ]]>
            </if>            
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 우수환경도서 관리 상세조회 -->
    <select id="selectBookInfo" parameterType="BookVo" resultType="BookVo"> 
        /* BookDao.selectBookInfo */
        SELECT
            A.BOOKID
            , A.EDU_TRGT_CD
            , A.WRITR
            , A.WRITR_PICTR
            , A.PLSCMPN
            , A.AMT
            , A.TTL
            , A.CN
            , A.CPYRHT_CD
            , DATE(A.REG_DT) AS REG_DT
            , A.RGTRID
            , CONCAT(F.ACNT,'(',F.NM,')') AS rgtridNm
            , A.RPRS_IMG_FILEID
            , E.FILEGRPID
            , E.FILE_IDNTFC_KEY      
            , E.ORGINL_FILE_NM
            , A.ATCH_FILEGRPID
            , A.DEL_YN
        FROM
            TB_CMM_BOOK A
            LEFT OUTER JOIN TB_CMM_FILE E ON A.RPRS_IMG_FILEID = E.FILEID
            LEFT OUTER JOIN TB_CMM_USER F ON A.RGTRID = F.USERID
        WHERE BOOKID = #{bookid}
    </select>
    <!-- 우수환경도서 관리 게시글 등록 --> 
    <insert id="insertBook" parameterType="BookVo" keyProperty="bookid" useGeneratedKeys="true">
        /* BookDao.insertBook */
        INSERT INTO TB_CMM_BOOK (
             EDU_TRGT_CD
            , WRITR
            , WRITR_PICTR
            , PLSCMPN
            , AMT
            , TTL
            , CN
            , RPRS_IMG_FILEID
            , ATCH_FILEGRPID
            , CPYRHT_CD
            , DEL_YN
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        )VALUES(
            #{eduTrgtCd}
            ,#{writr}
            ,#{writrPictr}
            ,#{plscmpn}
            ,#{amt}
            ,#{ttl}
            ,#{cn}
            ,#{rprsImgFileid}
            ,#{atchFilegrpid}
            ,#{cpyrhtCd}
            ,'N'
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
        )
    </insert>

    <!-- 우수환경도서 관리 게시글 수정 --> 
    <update id="updateBook" parameterType="BookVo" >
         /* BookDao.updateBook */
          UPDATE TB_CMM_BOOK SET
               EDU_TRGT_CD      = #{eduTrgtCd}
              ,WRITR            = #{writr}
              ,WRITR_PICTR      = #{writrPictr}
              ,PLSCMPN          = #{plscmpn}
              ,AMT              = #{amt}
              ,TTL              = #{ttl}
              ,CN               = #{cn}
              ,RPRS_IMG_FILEID  = #{rprsImgFileid}
              ,ATCH_FILEGRPID   = #{atchFilegrpid}
              ,CPYRHT_CD        = #{cpyrhtCd}
              ,MDFCN_DT         = NOW()
              ,MDFRID           = #{user.userid}
           WHERE BOOKID = #{bookid}
    </update>
    
    <!-- 우수환경도서 관리 게시글 삭제 -->
    <delete id="deleteBook" parameterType="BookVo">
        /* BookDao.deleteBook */
       UPDATE TB_CMM_BOOK SET
               DEL_YN           = 'Y'
              ,MDFCN_DT         = NOW()
              ,MDFRID           = #{user.userid}
        WHERE BOOKID IN (
        <foreach item="item" collection="bookids" separator=",">
           #{item}
        </foreach>
        )
    </delete>
    
    <!-- 우수환경도서 교육 주제 리스트 호출  -->
    <select id="selectBookSbjctList" parameterType="BookVo" resultType="BookSbjctVo"> 
        /* BookDao.selectBookSbjctList */
        SELECT
            A.BOOKID
            ,A.EDU_SBJCT_CD
            ,A.REG_DT
            ,A.RGTRID
        FROM
            TB_CMM_BOOK_SBJCT A
        WHERE BOOKID = #{bookid}
    </select>
    <!-- 우수환경도서 교육 주제 삭제 -->
    <delete id="deleteBookSbjct" parameterType="BookVo">
        /* BookDao.deleteBookSbjct */
        DELETE FROM TB_CMM_BOOK_SBJCT
        WHERE BOOKID IN (
            <foreach item="item" collection="bookids"  separator=",">
            #{item}
            </foreach>
        )
    </delete>
    <!-- 우수환경도서 교육 주제 등록 -->
    <insert id="insertBookSbjct" parameterType="BookVo">
        /* BookDao.insertBookSbjct */
        INSERT INTO TB_CMM_BOOK_SBJCT(
            BOOKID
            ,EDU_SBJCT_CD
            ,REG_DT
            ,RGTRID
        )VALUES
         <foreach item="item" collection="eduSbjctCds"  separator=",">
            (
            #{bookid}
            ,#{item}
            ,NOW()
            ,#{user.userid}
            )
         </foreach>
    </insert>
    
</mapper>