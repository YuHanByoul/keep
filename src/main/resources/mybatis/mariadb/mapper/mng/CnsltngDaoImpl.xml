<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : CnsltngDaoDaoImpl.xml
	Description : 컨설팅 관리
-->
<mapper namespace="com.kbrainc.plum.mng.cnsltng.model.CnsltngDao">

    <!-- 컨설팅 정보 목록 조회 -->
    <select id="selectCnsltngList" parameterType="CnsltngVo" resultType="CnsltngVo">
        /* ConsultDao.selectCnsltngList */
        <include refid="PaginationMapper.header"/>
                SELECT 
                    A.CNSLTNGID
                    ,A.INSTID
                    ,A.USERID
                    ,A.USER_NM
                    ,A.PRGRM_NM
                    ,A.CNSLTNG_KND_CD
                    ,A.HOPE_DE1
                    ,A.HOPE_DE1_AM_PM_CD
                    ,A.HOPE_DE2
                    ,A.HOPE_DE2_AM_PM_CD
                    ,A.PRGRM
                    ,A.LDR
                    ,A.SFTYMNG
                    ,A.ETC
                    ,A.FILEGRPID
                    ,A.STTS_CD
                    ,A.SRVYID
                    ,A.MDFCN_DT
                    ,A.MDFRID
                    ,A.REG_DT
                    ,A.RGTRID
                    ,B.INST_NM AS instNm
                    ,D.VST_DE
                    ,D.VST_BGNG_DT 
                    ,D.VST_END_DT
                    ,E.CNSTNT_NM
                 FROM 
                    TB_ASS_CNSLTNG A
                    INNER JOIN TB_CMM_INST B
                    ON A.INSTID = B.INSTID 
                    LEFT OUTER JOIN TB_ASS_CNSLTNG_RSLT D
                    ON A.CNSLTNGID = D.CNSLTNGID         
                    LEFT OUTER JOIN (
                        SELECT 
                            A.CNSLTNGID
                            ,group_concat(B.NM) AS CNSTNT_NM 
                          FROM 
                            TB_ASS_CNSLTNG_CNSTNT A
                            INNER JOIN TB_CMM_USER B
                            ON A.CNSTNTID = B.USERID
                        GROUP BY A.CNSLTNGID
                    ) E ON A.CNSLTNGID = E.CNSLTNGID
                 WHERE 1=1
                 
                <if test="searchInstNm != null and searchInstNm != '' ">
                   AND B.INST_NM LIKE CONCAT('%',#{searchInstNm},'%')
                </if>
                <if test="searchPrgrmNm != null and searchPrgrmNm != '' ">
                   AND A.PRGRM_NM LIKE CONCAT('%',#{searchPrgrmNm},'%')
                </if>
                
                <if test="searchCsltngKndCd != null and searchCsltngKndCd != '' ">
                   AND A.CNSLTNG_KND_CD = #{searchCsltngKndCd} 
                </if>
                <if test="searchSttsCd != null and searchSttsCd != '' ">
                   AND A.STTS_CD = #{searchSttsCd}
                </if>
                
                <if test="searchRegStrtDt != null and searchRegStrtDt != ''">
                    AND A.REG_DT >= CAST(CONCAT(#{searchRegStrtDt},' 00:00:00') AS DATETIME) 
                </if>
                <if test="searchRegEndDt != null and searchRegEndDt != ''">
                    AND A.REG_DT <![CDATA[<=]]> CAST(CONCAT(#{searchRegEndDt},' 23:59:59') AS DATETIME)
                </if>
                
                <if test="searchHopeStrtDt != null and searchHopeStrtDt != ''">
                    AND D.VST_DE <![CDATA[>=]]> #{searchHopeStrtDt} 
                </if>
                <if test="searchHopeEndDt != null and searchHopeEndDt != ''">
                    AND D.VST_DE <![CDATA[<=]]> #{searchHopeEndDt}
                </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 컨설팅 정보 상세 조회 -->
    <select id="selectCnsltngtInfo" parameterType="CnsltngVo" resultType="CnsltngVo">
           /* ConsultDao.selectCnsltngtInfo */
                SELECT 
                   A.CNSLTNGID
                   ,A.INSTID
                   ,A.USERID
                   ,A.USER_NM
                   ,A.PRGRM_NM
                   ,A.CNSLTNG_KND_CD
                   ,A.HOPE_DE1
                   ,A.HOPE_DE1_AM_PM_CD
                   ,A.HOPE_DE2
                   ,A.HOPE_DE2_AM_PM_CD
                   ,A.PRGRM
                   ,A.LDR
                   ,A.SFTYMNG
                   ,A.ETC
                   ,A.FILEGRPID
                   ,A.STTS_CD
                   ,A.SRVYID
                   ,A.MDFCN_DT
                   ,A.MDFRID
                   ,A.REG_DT
                   ,A.RGTRID
                   ,B.INST_NM AS instNm
                   ,D.VST_DE
                   ,D.VST_BGNG_DT 
                   ,D.VST_END_DT 
                   ,A.PIC_TELNO    
                   ,A.PIC_EML     
                   ,A.ADDR       
                   ,A.ADDR_DTL   
                   ,A.INST_TELNO 
                   ,B.INST_TYPE_CD 
                FROM 
                   TB_ASS_CNSLTNG A
                   INNER JOIN TB_CMM_INST B
                   ON A.INSTID = B.INSTID 
                   LEFT OUTER JOIN TB_ASS_CNSLTNG_RSLT D
                   ON A.CNSLTNGID = D.CNSLTNGID
                   INNER JOIN TB_CMM_INST E
                   ON A.INSTID = E.INSTID 
                WHERE 1=1
                  AND A.CNSLTNGID = #{cnsltngid}  
    </select>
    
    <!-- 컨설팅 담당자 정보 조회 -->
    <select id="selectCnstntList" parameterType="CnsltngVo" resultType="CnsltngVo">
       /* CnsltngDao.selectCnstntList */
       SELECT 
           A.CNSLTNGID
           ,A.CNSTNTID
           ,A.MDFCN_DT
           ,A.MDFRID
           ,A.REG_DT
           ,A.RGTRID
           ,B.NM AS cnstntNm
           ,B.MOBLPHON AS cnstntMoblphon
           ,B.EML AS cnstntEml
           ,B.ACNT AS cnstntAcnt
        FROM 
           TB_ASS_CNSLTNG_CNSTNT A
           INNER JOIN TB_CMM_USER B
           ON A.CNSTNTID = B.USERID
        WHERE 1=1
          AND A.CNSLTNGID = #{cnsltngid}  
    </select>
    
    <!-- 신청 설문 및 담당컨설턴트 수정--> 
    <update id="updateCnsltng" parameterType="CnsltngVo" >
        /* CnsltngDao.updateCnsltng */
        UPDATE TB_ASS_CNSLTNG
           SET
            <if test="sttsCd != null and sttsCd != ''">
            STTS_CD    = #{sttsCd},
            </if>
            <if test="srvyid != null and srvyid != ''">
            SRVYID    = #{srvyid},                     
            </if>
            MDFCN_DT  = NOW(),                         
            MDFRID    = #{user.userid}                
         WHERE 1=1
           AND CNSLTNGID = #{cnsltngid}
    </update>
    
    <!-- 담당컨설턴트 등록--> 
    <insert id="insertCnsltnt" parameterType="CnsltngVo" >
        /* CnsltngDao.insertCnsltnt */
        INSERT INTO TB_ASS_CNSLTNG_CNSTNT (
            CNSLTNGID,
            CNSTNTID,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID 
        ) VALUES 
        <foreach item="item" collection="cnstntids" separator=",">
        (
            #{cnsltngid},
            #{item},
            NOW(),
            #{user.userid      },
            NOW(),
            #{user.userid      }
        )
        </foreach>
    </insert>
    
    <!-- 담당컨설턴트  삭제--> 
    <insert id="deleteCnsltnt" parameterType="CnsltngVo" >
        /* CnsltngDao.deleteCnsltnt */
        DELETE FROM TB_ASS_CNSLTNG_CNSTNT 
        WHERE 1=1
          AND CNSTNTID = #{cnstntid}
          AND CNSLTNGID = #{cnsltngid}  
    </insert>
    <!-- 담당컨설턴트 일괄 삭제--> 
    <insert id="deleteCnsltntAll" parameterType="CnsltngVo" >
        /* CnsltngDao.deleteCnsltntAll */
        DELETE FROM TB_ASS_CNSLTNG_CNSTNT 
        WHERE 1=1
          AND CNSLTNGID = #{cnsltngid}  
    </insert>
    
    <!-- 컨설팅 담당자 목록 조회 -->
    <select id="selectCnsltngExprtList" parameterType="CnsltngExprtVo" resultType="CnsltngExprtVo">
        /* CnsltngDao.selectCnsltngExprtList */
        <include refid="PaginationMapper.header"/>
                SELECT 
                  A.USERID
                  , B.ACNT
                  , B.NM 
                  , B.EML 
                  , B.MOBLPHON 
                  , C.CRTFCT_NM
                  , D.RGN_CD
                  , D.RGN_NM
                  , E.SBJCT_CD
                  , E.SBJCT_NM
                FROM 
                   TB_ASS_EXPRT A 
                   INNER JOIN TB_CMM_USER B
                   ON A.USERID = B.USERID 
                   LEFT OUTER JOIN (
                       SELECT 
                           A.USERID
                           ,GROUP_CONCAT(CRTFCT_NM) AS CRTFCT_NM 
                        FROM 
                           TB_ASS_EXPRT_CRTFCT A
                       GROUP BY A.USERID
                   ) C
                   ON A.USERID = C.USERID
                   LEFT OUTER JOIN (
                       SELECT 
                          A.USERID
                          ,GROUP_CONCAT(B.SIGNGU_NM) AS RGN_NM
                          -- ,GROUP_CONCAT(A.RGN_CD) AS RGN_CD
                          ,GROUP_CONCAT(DISTINCT B.CTPRVN_CD)AS RGN_CD
                         FROM 
                          TB_ASS_EXPRT_ACTVT_SCOPE A
                          INNER JOIN TB_CMM_ADDR_SIGNGU B
                          ON A.RGN_CD  = B.SIGNGU_CD
                          GROUP BY A.USERID
                   )D ON A.USERID = D.USERID 
                   LEFT OUTER JOIN (
                        SELECT
                           A.USERID
                          ,GROUP_CONCAT(B.CD_NM) AS SBJCT_NM
                          ,GROUP_CONCAT(B.CD) AS SBJCT_CD 
                         FROM 
                          TB_ASS_EXPRT_SBJCT A
                          INNER JOIN TB_CMM_CD B
                          ON A.SBJCT_CD  =B.CD 
                         GROUP BY A.USERID
                   )E ON A.USERID = E.USERID 
                 WHERE 1=1
                <if test="searchNm != null and searchNm != '' ">
                   AND (ACNT LIKE CONCAT('%',#{searchNm},'%') OR NM LIKE CONCAT('%',#{searchNm},'%'))
                </if>
                <if test="searchCrtfctNm != null and searchCrtfctNm != '' ">
                   AND CRTFCT_NM LIKE CONCAT('%',#{searchCrtfctNm},'%')
                </if>
                <if test="searchSbjctCd != null and searchSbjctCd != '' ">
                   AND SBJCT_CD LIKE CONCAT('%',#{searchSbjctCd},'%')
                </if>
                <if test="searchRgnCd != null and searchRgnCd != '' ">
                   AND RGN_CD LIKE CONCAT('%',#{searchRgnCd},'%')
                </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 컨설팅 담당자 그룹 목록 조회 -->
    <select id="selectCnsltngExprtGrpList" parameterType="CnsltngExprtGrpVo" resultType="CnsltngExprtGrpVo">
        /* CnsltngDao.selectCnsltngExprtGrpList */
        <include refid="PaginationMapper.header"/>
           SELECT 
               A.GRP_ID 
               ,C.GRP_NM 
               ,group_concat(B.NM) AS GRP_EXPRT_NM
               ,group_concat(B.USERID) AS GRP_EXPRT_IDS
               ,group_concat(concat(B.USERID,',',B.NM,'(',B.ACNT,')|',B.EML,'|',B.MOBLPHON) SEPARATOR ':' ) AS GRP_EXPRT_STR
               ,COUNT(B.USERID) AS GRP_EXPRT_CNT
               ,C.USE_YN 
               ,C.REG_DT 
             FROM
               TB_ASS_EXPRT_GRP_MAPNG A
               INNER JOIN TB_CMM_USER B
               ON A.USERID = B.USERID
               INNER JOIN TB_ASS_EXPRT_GRP C
               ON A.GRP_ID = C.GRP_ID
            WHERE 1=1 
            <if test="searchGrpNm != null and searchGrpNm != '' ">
             AND C.GRP_NM LIKE CONCAT('%',#{searchGrpNm},'%')
            </if>
            GROUP BY A.GRP_ID  
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 지역 리스트 호출 -->
    <select id="selectAddrCtprvnList" parameterType="map" resultType="map">
        /* CnsltngDao.selectAddrCtprvnList */
        SELECT 
           CTPRVN_CD as ctprvnCd
           ,CTPRVN_NM as ctprvnNm 
          FROM 
            TB_CMM_ADDR_CTPRVN
         ORDER BY CTPRVN_CD ASC
    </select>
    
    <!-- 컨설팅 현재 담당자 리스트 호출 -->
    <select id="selectCurrentExprtList" parameterType="CnsltngVo" resultType="String">
        /* CnsltngDao.selectCurrentExprtList */
        SELECT 
           CNSTNTID 
          FROM 
           TB_ASS_CNSLTNG_CNSTNT         
         WHERE 1=1 
           AND CNSLTNGID = #{cnsltngid} 
    </select>
    
    <!-- 컨설팅 현재 담당자 리스트 호출 -->
    <select id="selectExprtGrpUserIdList" parameterType="CnsltngVo" resultType="String">
        /* CnsltngDao.selectExprtGrpUserIdList */
        SELECT 
           USERID
          FROM 
           TB_ASS_EXPRT_GRP_MAPNG         
         WHERE 1=1
           AND GRP_ID  = #{grpId} 
    </select>
    
    <!-- 컨설팅 설문 리스트 호출 -->
    <select id="selectCnsltngSrvyList" parameterType="SrvyVo" resultType="SrvyVo">
       /* CnsltngDao.selectCnsltngSrvyList */
         SELECT
            A.SRVYID
            , A.QESTNRID
            , A.SRVY_NM
            , A.USE_YN
            , A.REG_DT
            , A.BGNG_DE
            , A.END_DE
            , B.QESTNR_NM
        FROM
            TB_CMM_SRVY A
        LEFT OUTER JOIN
            TB_CMM_QESTNR B ON (B.QESTNRID = A.QESTNRID)
        WHERE 1=1
          AND A.USE_YN = 'Y'
          AND B.QESTNR_KND_CD = '110102' 
    </select>
    
    <!-- 컨설팅 리스트 엑셀 다운로드 -->
    <select id="selectCnsltngExcelList" parameterType="CnsltngVo" resultType="CnsltngVo">
        /* ConsultDao.selectCnsltngExcelList */
               SELECT 
                    A.CNSLTNGID
                    ,A.INSTID
                    ,A.USERID
                    ,A.USER_NM
                    ,A.PRGRM_NM
                    ,A.CNSLTNG_KND_CD
                    ,A.HOPE_DE1
                    ,A.HOPE_DE1_AM_PM_CD
                    ,A.HOPE_DE2
                    ,A.HOPE_DE2_AM_PM_CD
                    ,A.PRGRM
                    ,A.LDR
                    ,A.SFTYMNG
                    ,A.ETC
                    ,A.FILEGRPID
                    ,A.STTS_CD
                    ,A.SRVYID
                    ,A.MDFCN_DT
                    ,A.MDFRID
                    ,A.REG_DT
                    ,A.RGTRID
                    ,B.INST_NM AS instNm
                    ,D.VST_DE
                    ,D.VST_BGNG_DT 
                    ,D.VST_END_DT
                    ,E.CNSTNT_NM
                 FROM 
                    TB_ASS_CNSLTNG A
                    INNER JOIN TB_CMM_INST B
                    ON A.INSTID = B.INSTID 
                    LEFT OUTER JOIN TB_ASS_CNSLTNG_RSLT D
                    ON A.CNSLTNGID = D.CNSLTNGID         
                    LEFT OUTER JOIN (
                        SELECT 
                            A.CNSLTNGID
                            ,group_concat(B.NM) AS CNSTNT_NM 
                          FROM 
                            TB_ASS_CNSLTNG_CNSTNT A
                            INNER JOIN TB_CMM_USER B
                            ON A.CNSTNTID = B.USERID
                        GROUP BY A.CNSLTNGID
                    ) E ON A.CNSLTNGID = E.CNSLTNGID
                 WHERE 1=1
                <if test="searchInstNm != null and searchInstNm != '' ">
                   AND B.INST_NM LIKE CONCAT('%',#{searchInstNm},'%')
                </if>
                <if test="searchPrgrmNm != null and searchPrgrmNm != '' ">
                   AND A.PRGRM_NM LIKE CONCAT('%',#{searchPrgrmNm},'%')
                </if>
                <if test="searchCsltngKndCd != null and searchCsltngKndCd != '' ">
                   AND A.CNSLTNG_KND_CD = #{searchCsltngKndCd} 
                </if>
                <if test="searchSttsCd != null and searchSttsCd != '' ">
                   AND A.STTS_CD = #{searchSttsCd}
                </if>
                <if test="searchRegStrtDt != null and searchRegStrtDt != ''">
                    AND A.REG_DT <![CDATA[>=]]> CAST(CONCAT(#{searchRegStrtDt},' 23:59:59') AS DATETIME)
                </if>
                <if test="searchRegEndDt != null and searchRegEndDt != ''">
                    AND A.REG_DT <![CDATA[<]]> CAST(CONCAT(#{searchRegEndDt},' 23:59:59') AS DATETIME)
                </if>
                <if test="searchHopeStrtDt != null and searchHopeStrtDt != ''">
                    AND D.VST_DE <![CDATA[>=]]> CAST(CONCAT(#{searchHopeStrtDt},' 23:59:59') AS DATETIME) 
                </if>
                <if test="searchHopeEndDt != null and searchHopeEndDt != ''">
                    AND D.VST_DE <![CDATA[<]]> CAST(CONCAT(#{searchHopeEndDt},' 23:59:59') AS DATETIME)
                </if>
    </select>
    <!-- 컨설팅 결과정보 상세 조회 -->
    <select id="selectCnsltngtResult" parameterType="CnsltngResultVo" resultType="CnsltngResultVo">
             /* ConsultDao.selectCnsltngtResult */
             SELECT 
                   A.CNSLTNGID
                   ,A.PRGRM_NM
                   ,A.CNSLTNG_KND_CD
                   ,A.STTS_CD
                   ,A.MDFCN_DT
                   ,A.MDFRID
                   ,A.REG_DT AS REQ_DT
                   ,A.RGTRID
                   ,A.HOPE_DE1 
                   ,A.HOPE_DE2
                   ,A.USER_NM 
                   ,A.SRVYID 
                   ,B.VST_DE
                   ,B.VST_BGNG_DT 
                   ,B.VST_END_DT
                   ,B.GNRLZOPNN
                   ,B.DSTNCTN
                   ,B.DSTNCTN_RMRK
                   ,B.OPER_MNG
                   ,B.OPER_MNG_RMRK
                   ,B.EVL_SYS
                   ,B.EVL_SYS_RMRK
                   ,B.LDR
                   ,B.LDR_RMRK
                   ,B.SFTY_MNG
                   ,B.SFTY_MNG_RMRK
                   ,B.ETC
                   ,B.ETC_RMRK
                   ,B.FILEGRPID
                   ,B.TMPR_SAVE_YN
                   ,B.REG_DT 
                   ,C.CNSTNT_NM
                   ,D.INST_NM 
                FROM 
                   TB_ASS_CNSLTNG A
                   LEFT OUTER JOIN TB_ASS_CNSLTNG_RSLT B
                   ON A.CNSLTNGID = B.CNSLTNGID
                   LEFT OUTER JOIN (
                        SELECT 
                            A.CNSLTNGID
                            ,group_concat(B.NM) AS CNSTNT_NM 
                          FROM 
                            TB_ASS_CNSLTNG_CNSTNT A
                            INNER JOIN TB_CMM_USER B
                            ON A.CNSTNTID = B.USERID
                        GROUP BY A.CNSLTNGID
                    ) C ON A.CNSLTNGID = C.CNSLTNGID
                    INNER JOIN TB_CMM_INST D
                    ON A.INSTID = D.INSTID 
                WHERE 1=1
                  AND A.CNSLTNGID = #{cnsltngid}  
    </select>
    
    <!-- 담당컨설턴트 등록--> 
    <insert id="mergeCnsltngRslt" parameterType="CnsltngResultVo" >
        /* CnsltngDao.mergeCnsltngRslt */
        INSERT INTO TB_ASS_CNSLTNG_RSLT (
            CNSLTNGID
            ,VST_DE
            ,VST_BGNG_DT
            ,VST_END_DT
            ,GNRLZOPNN
            ,DSTNCTN
            ,DSTNCTN_RMRK
            ,OPER_MNG
            ,OPER_MNG_RMRK
            ,EVL_SYS
            ,EVL_SYS_RMRK
            ,LDR
            ,LDR_RMRK
            ,SFTY_MNG
            ,SFTY_MNG_RMRK
            ,ETC
            ,ETC_RMRK
            ,FILEGRPID
            ,TMPR_SAVE_YN
            ,MDFCN_DT
            ,MDFRID
            ,REG_DT
            ,RGTRID  
        ) VALUES (
             #{cnsltngid  }
            ,#{vstDe      }
            ,#{vstBgngDate}
            ,#{vstEndDate }
            ,#{gnrlzopnn  }
            ,#{dstnctn    }
            ,#{dstnctnRmrk}
            ,#{operMng    }
            ,#{operMngRmrk}
            ,#{evlSys     }
            ,#{evlSysRmrk }
            ,#{ldr        }
            ,#{ldrRmrk    }
            ,#{sftyMng    }
            ,#{sftyMngRmrk}
            ,#{etc        }
            ,#{etcRmrk    }
            ,#{filegrpid  }
            ,#{tmprSaveYn }
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
        )
        ON DUPLICATE KEY UPDATE
            VST_DE         = #{vstDe      }  
            ,VST_BGNG_DT   = #{vstBgngDate}  
            ,VST_END_DT    = #{vstEndDate }  
            ,GNRLZOPNN     = #{gnrlzopnn  }  
            ,DSTNCTN       = #{dstnctn    }  
            ,DSTNCTN_RMRK  = #{dstnctnRmrk}  
            ,OPER_MNG      = #{operMng    }  
            ,OPER_MNG_RMRK = #{operMngRmrk}  
            ,EVL_SYS       = #{evlSys     }  
            ,EVL_SYS_RMRK  = #{evlSysRmrk }  
            ,LDR           = #{ldr        }  
            ,LDR_RMRK      = #{ldrRmrk    }  
            ,SFTY_MNG      = #{sftyMng    }  
            ,SFTY_MNG_RMRK = #{sftyMngRmrk}  
            ,ETC           = #{etc        }  
            ,ETC_RMRK      = #{etcRmrk    }  
            ,FILEGRPID     = #{filegrpid  }  
            ,TMPR_SAVE_YN  = #{tmprSaveYn }  
            ,MDFCN_DT      = NOW()           
            ,MDFRID        = #{user.userid}  
    </insert>
    
    <!-- 컨설팅 설문정보 상세 조회 -->
    <select id="selectCnsltngtSrvyResult" parameterType="CnsltngVo" resultType="map">
          /* CnsltngDao.mergeCnsltngRslt */
          SELECT 
              C.CN 
              ,C.QITEMID
              ,D.EXSTR
              ,IFNULL(F.ANS,0) AS ANS 
              ,IFNULL(E.OPNN_CN,'') AS OPNN_CN 
              ,C.ORDR
              ,IFNULL(E.REG_DT,'') AS REG_DT
            FROM 
              TB_CMM_SRVY A
              INNER JOIN TB_CMM_QESTNR B
              ON A.QESTNRID = B.QESTNRID 
              INNER JOIN TB_CMM_QESTNR_QITEM C
              ON B.QESTNRID = C.QESTNRID 
              INNER JOIN (
                    SELECT 
                        QITEMID
                        ,GROUP_CONCAT(concat(EX.EX_NO,'/',EX.CN) ORDER BY EX_NO) AS EXSTR
                     FROM 
                        TB_CMM_QESTNR_QITEM_EX EX
                       GROUP BY QITEMID 
              ) D
              ON C.QITEMID = D.QITEMID
              LEFT OUTER JOIN TB_CMM_SRVY_SBMSN E
              ON A.SRVYID = E.SRVYID  AND E.CNSLTNGID = #{cnsltngid}  
              LEFT OUTER JOIN TB_CMM_SRVY_SBMSN_ANS F
              ON C.QITEMID = F.QITEMID  
           WHERE 1=1
             AND A.USE_YN ='Y'
             AND A.SRVYID = #{srvyid}
             ORDER BY C.ORDR
       </select>
       
</mapper>
