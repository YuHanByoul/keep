<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : TchaidRvwDaoImpl.xml
	Description : 교구후기관리
-->
<mapper namespace="com.kbrainc.plum.mng.tchaidRvw.model.TchaidRvwDao">
    
    <!-- 교구후기관리 게시글 목록 조회 -->
    <select id="selectTchaidRvwList" parameterType="TchaidRvwVo" resultType="TchaidRvwVo">
        /* TchaidRvwDao.selectTchaidRvwList */
        <include refid="PaginationMapper.header"/>
            SELECT
            	*
            FROM
            	(SELECT 
                   '대여' AS TYPE
                   , 'L' AS TYPE_CD
                   , A.APLYID
                   , 0 TCHAIDID
                   , B.ACNT AS APLCNTID
                   , A.APLCNT_NM AS APLCNTNM
                   , A.INST_NM
                   , E.RCRIT_NM AS RCRITNM
                   , A.RVW_SCR AS RVWSCR
                   , A.RVW_CN
                   , A.RVW_FILEGRPID
                   , DATE(A.RVW_REG_DT) AS RVWREGDT 
                 FROM
                     TB_THA_PACKAGE_LEND_APLY A
                     LEFT OUTER JOIN TB_CMM_USER 
                     B ON A.APLCNTID = B.USERID
                     LEFT OUTER JOIN TB_THA_PACKAGE_LEND_RND D 
                     ON A.RNDID = D.RNDID
                     LEFT OUTER JOIN TB_THA_PACKAGE_LEND_RCRIT E 
                     ON D.RCRITID = E.RCRITID
                     LEFT OUTER JOIN TB_THA_PACKAGE G 
                     ON A.PACKAGEID = G.PACKAGEID
                 WHERE 1=1
                   AND A.RVW_SCR IS NOT NULL
                   AND A.RVW_CN  IS NOT NULL
                   AND A.RVW_REG_DT IS NOT NULL
                   AND A.STTS_CD = '231102'
                   AND A.DLVY_STTS_CD ='230102'
                 
            	 UNION ALL

            	 SELECT
            		 '공동구매'
                   , 'J' AS TYPE_CD                     
            	   , A.ORDERID AS APLYID
            	   , E.TCHAIDID
            	   , B.ACNT AS APLCNTID
            	   , B.NM AS APLCNT_NM
            	   , INST_NM
            	   , D.JNTPURCHS_NM AS RCRITNM
            	   , A.RVW_SCR
            	   , A.RVW_CN
            	   , A.RVW_FILEGRPID
            	   , DATE(A.RVW_REG_DT)
            	 FROM
            		 TB_THA_TCHAID_JNTPURCHS_ORDER A
            		 LEFT OUTER JOIN (SELECT USERID, ACNT, NM FROM TB_CMM_USER) B ON A.USERID = B.USERID
            		 LEFT OUTER JOIN (SELECT ORDERID, JNTPURCHSID, TCHAIDID FROM TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS) C ON A.ORDERID = C.ORDERID
            		 LEFT OUTER JOIN (SELECT JNTPURCHSID, JNTPURCHSNO, JNTPURCHS_NM FROM TB_THA_TCHAID_JNTPURCHS) D ON C.JNTPURCHSID = D.JNTPURCHSID
            		 LEFT OUTER JOIN (SELECT TCHAIDID, TCHAID_NM FROM TB_THA_TCHAID) E ON C.TCHAIDID = E.TCHAIDID
            	 WHERE 1=1
            	   AND STTS_CD = 181100
                   AND RVW_SCR IS NOT NULL
                   AND RVW_CN  IS NOT NULL
                   AND RVW_REG_DT IS NOT NULL
                 GROUP BY APLYID                     
                ) TB1
            WHERE 1=1
            
                <if test="searchType != null and searchType != '' and searchType == 'lend'">
                 AND TYPE_CD = 'L'
                </if>
                <if test="searchType != null and searchType != '' and searchType == 'jntpurchs'">
                 AND TYPE_CD = 'J'
                </if>
                <if test="searchRcritNm != null and searchRcritNm != '' ">
                AND RCRITNM LIKE CONCAT('%',#{searchRcritNm},'%')
                </if>
                <if test="searchScr != null and searchScr != ''">
                AND RVWSCR = #{searchScr}
                </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 교구후기관리 게시글 상세조회 -->
    <select id="selectTchaidRvwInfo" parameterType="TchaidRvwVo" resultType="TchaidRvwVo"> 
        /* TchaidRvwDao.selectTchaidRvwInfo */
            SELECT
                *
            FROM
                (SELECT
                     '대여' AS TYPE
                   , A.APLYID
                   , 0 TCHAIDID
                   , B.ACNT AS APLCNTID
                   , A.APLCNT_NM
                   , A.INST_NM
                   , E.RCRIT_NM
                   , G.PACKAGE_NM AS PRODUCT_NM
                   , A.RVW_SCR
                   , A.RVW_CN
                   , A.RVW_FILEGRPID
                   , DATE(A.RVW_REG_DT) AS RVW_REG_DT
                 FROM
                     TB_THA_PACKAGE_LEND_APLY A
                     LEFT OUTER JOIN TB_CMM_USER 
                     B ON A.APLCNTID = B.USERID
                     LEFT OUTER JOIN TB_THA_PACKAGE_LEND_RND D 
                     ON A.RNDID = D.RNDID
                     LEFT OUTER JOIN TB_THA_PACKAGE_LEND_RCRIT E 
                     ON D.RCRITID = E.RCRITID
                     LEFT OUTER JOIN TB_THA_PACKAGE G 
                     ON A.PACKAGEID = G.PACKAGEID
                 WHERE 1=1
                   AND A.RVW_SCR IS NOT NULL
                   AND A.RVW_CN  IS NOT NULL
                   AND A.RVW_REG_DT IS NOT NULL
                   AND A.STTS_CD = '231102'
                   AND A.DLVY_STTS_CD ='230102'
                 
                 UNION ALL

                 SELECT
                     '공동구매'
                   , A.ORDERID AS APLYID
                   , C.TCHAIDID
                   , B.ACNT AS APLCNTID
                   , B.NM AS APLCNT_NM
                   , INST_NM
                   , D.JNTPURCHS_NM AS RCRIT_NM
                   , E.TCHAID_NM AS PRODUCT_NM
                   , A.RVW_SCR
                   , A.RVW_CN
                   , A.RVW_FILEGRPID
                   , DATE(A.RVW_REG_DT)
                 FROM
            		 TB_THA_TCHAID_JNTPURCHS_ORDER A
            		 LEFT OUTER JOIN (SELECT USERID, ACNT, NM FROM TB_CMM_USER) B ON A.USERID = B.USERID
            		 LEFT OUTER JOIN (SELECT ORDERID, JNTPURCHSID, TCHAIDID FROM TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS) C ON A.ORDERID = C.ORDERID
            		 LEFT OUTER JOIN (SELECT JNTPURCHSID, JNTPURCHSNO, JNTPURCHS_NM FROM TB_THA_TCHAID_JNTPURCHS) D ON C.JNTPURCHSID = D.JNTPURCHSID
            		 LEFT OUTER JOIN (SELECT TCHAIDID, TCHAID_NM FROM TB_THA_TCHAID) E ON C.TCHAIDID = E.TCHAIDID
                 WHERE
                     STTS_CD = 181100
                 GROUP BY APLYID
                )TB1
            WHERE
                TB1.APLYID = #{aplyid}
                AND TB1.TYPE = #{type}
    </select>
    
    <!-- 교구후기관리 게시글 수정 -->
    <update id="updateTchaidRvw" parameterType="TchaidRvwVo" keyProperty="userid">
        /* TchaidRvwDao.updateTchaidRvw */
        <if test="type == '대여'">
        UPDATE TB_THA_PACKAGE_LEND_APLY SET
                RVW_CN                 = #{rvwCn} 
                ,MDFCN_DT               = NOW() 
                ,MDFRID                 = #{user.userid}
         WHERE APLYID = #{aplyid}
        </if>        
        <if test="type == '공동구매'">
        UPDATE TB_THA_TCHAID_JNTPURCHS_ORDER SET
                RVW_CN                 = #{rvwCn} 
                ,MDFCN_DT               = NOW() 
                ,MDFRID                 = #{user.userid}
         WHERE ORDERID = #{aplyid}     
        </if>
    </update>
    
    <!-- 교구후기관리 게시글 삭제 -->
    <delete id="deleteTchaidRvw" parameterType="TchaidRvwVo">
        /* TchaidRvwDao.deleteTchaidRvw */
         UPDATE TB_THA_TCHAID_JNTPURCHS_ORDER SET
                RVW_CN    = null 
                ,RVW_SCR  = null 
                ,RVW_CN   = null
                ,RVW_FILEGRPID = null
                ,RVW_REG_DT = null
                ,MDFCN_DT = NOW() 
                ,MDFRID   = #{user.userid}
        WHERE ORDERID IN 
        <foreach item="item" collection="orderids"  open="(" close=")" separator=",">
        #{item}
        </foreach>
    </delete>
    
    <!-- 교구대여 후기 삭제 -->
    <delete id="deleteLendAplyRvw" parameterType="TchaidRvwVo">
        /* TchaidRvwDao.deleteLendAplyRvw */
         UPDATE TB_THA_PACKAGE_LEND_APLY SET
                RVW_CN    = null 
                ,RVW_SCR  = null 
                ,RVW_CN   = null
                ,RVW_FILEGRPID = null
                ,RVW_REG_DT = null
                ,MDFCN_DT = NOW() 
                ,MDFRID   = #{user.userid}
         WHERE APLYID IN 
             <foreach item="item" collection="lendAplyids"  open="(" close=")" separator=",">
                #{item}
             </foreach>
    </delete>
    
</mapper>