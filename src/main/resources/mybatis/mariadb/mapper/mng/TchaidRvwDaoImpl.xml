<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : TchaidRvwDaoImpl.xml
	Description : 교구후기관리
-->
<mapper namespace="com.kbrainc.plum.mng.tchaidRvw.model.TchaidRvwDao">
    
    <!-- 교구후기관리 게시글 목록 조회 -->
    <select id="selectTchaidRvwList" parameterType="TchaidRvwVo" resultType="TchaidRvwVo">
        /* TchaidRvwDao.selectTchaidRvwList */
        <include refid="PaginationMapper.header"/>
            SELECT
            	*
            FROM
            	(SELECT
            		 '대여' AS TYPE
            	   , A.APLYID
            	   , H.TCHAIDID
            	   , B.ACNT AS APLCNTID
            	   , A.APLCNT_NM
            	   , INST_NM
            	   , E.RCRIT_NM
            	   , A.RVW_SCR
            	   , A.RVW_CN
            	   , A.RVW_FILEGRPID
            	   , DATE(A.RVW_REG_DT) AS RVW_REG_DT
            	 FROM
            		 TB_THA_PACKAGE_LEND_APLY A
            		 LEFT OUTER JOIN (SELECT USERID, ACNT, NM FROM TB_CMM_USER) B ON A.APLCNTID = B.USERID
            		 LEFT OUTER JOIN (SELECT APLYID, RNDID, PACKAGEINDVDID FROM TB_THA_PACKAGE_LEND_APLY_DLIVY) C ON A.APLYID = C.APLYID
            		 LEFT OUTER JOIN (SELECT RNDID, RCRITID FROM TB_THA_PACKAGE_LEND_RND) D ON C.RNDID = D.RNDID
            		 LEFT OUTER JOIN (SELECT RCRITID, RCRIT_NM FROM TB_THA_PACKAGE_LEND_RCRIT) E ON D.RCRITID = E.RCRITID
            		 LEFT OUTER JOIN (SELECT PACKAGEINDVDID, PACKAGEID FROM TB_THA_PACKAGEINDVD) F ON C.PACKAGEINDVDID = F.PACKAGEINDVDID
            		 LEFT OUTER JOIN (SELECT PACKAGEID, PACKAGE_NM FROM TB_THA_PACKAGE) G ON F.PACKAGEID = G.PACKAGEID
                     LEFT OUTER JOIN (SELECT PACKAGEID, TCHAIDID FROM TB_THA_PACKAGE_TCHAID_CMPSTN) H ON G.PACKAGEID = H.PACKAGEID
            	 WHERE
            		 STTS_CD = 1

            	 UNION ALL

            	 SELECT
            		 '공동구매'
            	   , A.ORDERID AS APLYID
            	   , E.TCHAIDID
            	   , B.ACNT AS APLCNTID
            	   , B.NM AS APLCNT_NM
            	   , INST_NM
            	   , D.JNTPURCHS_NM AS RCRIT_NM
            	   , A.RVW_SCR
            	   , A.RVW_CN
            	   , A.RVW_FILEGRPID
            	   , DATE(A.RVW_REG_DT)
            	 FROM
            		 TB_THA_TCHAID_JNTPURCHS_ORDER A
            		 LEFT OUTER JOIN (SELECT USERID, ACNT, NM FROM TB_CMM_USER) B ON A.USERID = B.USERID
            		 LEFT OUTER JOIN (SELECT ORDERID, JNTPURCHSID, TCHAIDID FROM TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS) C ON A.ORDERID = C.ORDERID
            		 LEFT OUTER JOIN (SELECT JNTPURCHSID, JNTPURCHSNO, JNTPURCHS_NM FROM TB_THA_TCHAID_JNTPURCHS) D ON C.JNTPURCHSID = D.JNTPURCHSID
            		 LEFT OUTER JOIN (SELECT TCHAIDID, TCHAID_NM FROM TB_THA_TCHAID) E ON C.TCHAIDID = E.TCHAIDID
            	 WHERE
            		 STTS_CD = 181100
                ) TB1
            WHERE
                1=1
                <if test="searchKeyword != null and searchKeyword != '' and searchType == 'oxprNm'">
                AND OXPR_NM LIKE CONCAT('%',#{searchKeyword},'%')
                </if>
                <if test="searchKeyword != null and searchKeyword != '' and searchType == 'ttl'">
                AND TTL LIKE CONCAT('%',#{searchKeyword},'%')
                </if>
                <if test="searchCd != null and searchCd != ''">
                AND CLSF_CD = #{searchCd}
                </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 교구후기관리 게시글 상세조회 -->
    <select id="selectTchaidRvwInfo" parameterType="TchaidRvwVo" resultType="TchaidRvwVo"> 
        /* TchaidRvwDao.selectTchaidRvwInfo */
            SELECT
                *
            FROM
                (SELECT
                     '대여' AS TYPE
                   , A.APLYID
                   , H.TCHAIDID
                   , B.ACNT AS APLCNTID
                   , A.APLCNT_NM
                   , INST_NM
                   , E.RCRIT_NM
                   , G.PACKAGE_NM AS PRODUCT_NM
                   , A.RVW_SCR
                   , A.RVW_CN
                   , A.RVW_FILEGRPID
                   , DATE(A.RVW_REG_DT) AS RVW_REG_DT
                 FROM
            		 TB_THA_PACKAGE_LEND_APLY A
            		 LEFT OUTER JOIN (SELECT USERID, ACNT, NM FROM TB_CMM_USER) B ON A.APLCNTID = B.USERID
            		 LEFT OUTER JOIN (SELECT APLYID, RNDID, PACKAGEINDVDID FROM TB_THA_PACKAGE_LEND_APLY_DLIVY) C ON A.APLYID = C.APLYID
            		 LEFT OUTER JOIN (SELECT RNDID, RCRITID FROM TB_THA_PACKAGE_LEND_RND) D ON C.RNDID = D.RNDID
            		 LEFT OUTER JOIN (SELECT RCRITID, RCRIT_NM FROM TB_THA_PACKAGE_LEND_RCRIT) E ON D.RCRITID = E.RCRITID
            		 LEFT OUTER JOIN (SELECT PACKAGEINDVDID, PACKAGEID FROM TB_THA_PACKAGEINDVD) F ON C.PACKAGEINDVDID = F.PACKAGEINDVDID
            		 LEFT OUTER JOIN (SELECT PACKAGEID, PACKAGE_NM FROM TB_THA_PACKAGE) G ON F.PACKAGEID = G.PACKAGEID
                     LEFT OUTER JOIN (SELECT PACKAGEID, TCHAIDID FROM TB_THA_PACKAGE_TCHAID_CMPSTN) H ON G.PACKAGEID = H.PACKAGEID
                 WHERE
                     STTS_CD = 1

                 UNION ALL

                 SELECT
                     '공동구매'
                   , A.ORDERID AS APLYID
                   , C.TCHAIDID
                   , B.ACNT AS APLCNTID
                   , B.NM AS APLCNT_NM
                   , INST_NM
                   , D.JNTPURCHS_NM AS RCRIT_NM
                   , E.TCHAID_NM AS PRODUCT_NM
                   , A.RVW_SCR
                   , A.RVW_CN
                   , A.RVW_FILEGRPID
                   , DATE(A.RVW_REG_DT)
                 FROM
            		 TB_THA_TCHAID_JNTPURCHS_ORDER A
            		 LEFT OUTER JOIN (SELECT USERID, ACNT, NM FROM TB_CMM_USER) B ON A.USERID = B.USERID
            		 LEFT OUTER JOIN (SELECT ORDERID, JNTPURCHSID, TCHAIDID FROM TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS) C ON A.ORDERID = C.ORDERID
            		 LEFT OUTER JOIN (SELECT JNTPURCHSID, JNTPURCHSNO, JNTPURCHS_NM FROM TB_THA_TCHAID_JNTPURCHS) D ON C.JNTPURCHSID = D.JNTPURCHSID
            		 LEFT OUTER JOIN (SELECT TCHAIDID, TCHAID_NM FROM TB_THA_TCHAID) E ON C.TCHAIDID = E.TCHAIDID
                 WHERE
                     STTS_CD = 181100
                )TB1
            WHERE
                TB1.APLYID = #{aplyid}
                AND TB1.TCHAIDID = #{tchaidid}
                AND TB1.TYPE = #{type}
    </select>
    
    <!-- 교구후기관리 게시글 수정 -->
    <update id="updateTchaidRvw" parameterType="TchaidRvwVo" keyProperty="userid">
        /* TchaidRvwDao.updateTchaidRvw */
        UPDATE TB_THA_TCHAID_JNTPURCHS_RVW SET
                CN                 = #{cn} 
                ,WRT_DE                 = #{wrtDe} 
                ,MDFCN_DT               = NOW() 
                ,MDFRID                 = #{user.userid}
         WHERE RVWID = #{rvwid}
    </update>
    
    <!-- 교구후기관리 게시글 삭제 -->
    <delete id="deleteTchaidRvw" parameterType="java.util.ArrayList">
        /* TchaidRvwDao.deleteTchaidRvw */
		DELETE FROM TB_THA_TCHAID_JNTPURCHS_RVW 
        WHERE RVWID IN 
        <foreach item="item" collection="array" index="rvwid" open="(" close=")" separator=",">
        #{item}
        </foreach>
    </delete>
    
</mapper>