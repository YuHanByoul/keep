<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : CmpntDaoImpl.xml
	Description : 구성품관리 
-->
<mapper namespace="com.kbrainc.plum.mng.cmpnt.model.CmpntDao">

   <!-- 구성품 목록 호출 --> 
   <select id="selectCmpntList" parameterType="CmpntVo" resultType="CmpntVo">
          /* CmpntDao.selectCmpntList */
          <include refid="PaginationMapper.header"/>
          SELECT 
            CMPNTID
            ,CMPNT_NM
            ,QNTY_INVNTRY
            ,MDFCN_DT
            ,MDFRID
            ,REG_DT
            ,RGTRID
          FROM 
            TB_THA_TCHAID_CMPNT
         WHERE 1=1
           <if test="searchKeyword != null and searchKeyword != '' and searchType == 'nm'">
              AND CMPNT_NM LIKE CONCAT('%',#{searchKeyword},'%')
           </if>
         <include refid="PaginationMapper.footer"/>
   </select>
   <!-- 구성품 입고 내역 호출 --> 
   <select id="selectCmpntWrhousngList" parameterType="CmpntWrhousngVo" resultType="CmpntWrhousngVo">
          /* CmpntDao.selectCmpntWrhousngList */
          <include refid="PaginationMapper.header"/>
          SELECT 
               A.WRHOUSNGID
              ,A.CMPNTID
              ,A.WRHOUSNGDE
              ,A.QNTY
              ,A.RMRK
              ,A.REG_DT
              ,A.RGTRID
              ,B.NM
            FROM    
               TB_THA_CMPNT_WRHOUSNG A
               INNER JOIN TB_CMM_USER B
               ON A.RGTRID = B.USERID
           WHERE 1=1 
             AND CMPNTID = #{cmpntid}
        <include refid="PaginationMapper.footer"/>
   </select>
   
   <!-- 구성품 상세 정보  --> 
   <select id="selectCmpnt" parameterType="CmpntVo" resultType="CmpntVo">
          /* CmpntDao.selectCmpnt */
          SELECT 
            CMPNTID
            ,CMPNT_NM
            ,QNTY_INVNTRY
            ,MDFCN_DT
            ,MDFRID
            ,REG_DT
            ,RGTRID
          FROM 
            TB_THA_TCHAID_CMPNT
         WHERE 1=1
         AND CMPNTID = #{cmpntid}
   </select>
   
   
   <!-- 구성품 등록 --> 
   <insert id="insertCmpnt" parameterType="CmpntVo" >
        /* CmpntDao.insertCmpnt */
        INSERT INTO TB_THA_TCHAID_CMPNT (
            CMPNT_NM
            ,QNTY_INVNTRY
            ,MDFCN_DT
            ,MDFRID
            ,REG_DT
            ,RGTRID
        )VALUES(
             #{cmpntNm     }
            ,#{qntyInvntry }
            ,NOW()
            ,#{user.userid  }
            ,NOW()
            ,#{user.userid  }
        )
   </insert>
   <!-- 구성품 입고 등록 --> 
   <insert id="insertCmpntWrhousng" parameterType="CmpntWrhousngVo" >
        /* CmpntDao.insertCmpntWrhousng */
        INSERT INTO TB_THA_CMPNT_WRHOUSNG (
              CMPNTID
              ,WRHOUSNGDE
              ,QNTY
              ,RMRK
              ,REG_DT
              ,RGTRID
        )VALUES(
               #{cmpntid    }
              ,#{wrhousngde }
              ,#{qnty       }
              ,#{rmrk       }
              ,NOW()
              ,#{user.userid  }
        )
   </insert>
   <!-- 구성품 수정 --> 
   <update id="updateCmpnt" parameterType="CmpntVo" >
        /* CmpntDao.insertCmpnt */
        UPDATE TB_THA_TCHAID_CMPNT
           SET
            <if test="cmpntNm != null and cmpntNm != '' ">
            CMPNT_NM     = #{cmpntNm     },
            </if>
            QNTY_INVNTRY = (SELECT IFNULL(SUM(QNTY) ,0) FROM TB_THA_CMPNT_WRHOUSNG WHERE CMPNTID = #{cmpntid}),   
            MDFCN_DT     = NOW(),             
            MDFRID       = #{user.userid  }  
         WHERE 1=1 
           AND CMPNTID = #{cmpntid}
  </update>
  
</mapper>