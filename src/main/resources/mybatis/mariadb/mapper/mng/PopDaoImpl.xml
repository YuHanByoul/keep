<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kbrainc.plum.mng.pop.model.PopDao">

    <insert id="insertPopUpNtc" parameterType="PopUpNtcVo">
        /* PopDaoImpl.insertPopUpNtc */
        INSERT into TB_CMM_POPUPNTC
        (
            title            
            ,cntnts           
            ,expsr_lc_cd      
            ,menuid           
            ,siteid           
            ,login_need_yn    
            ,popup_type_cd    
            ,strt_dt           
            ,end_dt            
            ,width_size       
            ,vrticl_size       
            ,top_lc           
            ,left_lc          
            ,ntc_trgt_cd      
            ,ntc_trgt_roleid  
            ,mdfcn_dt          
            ,mdfrid       
            ,reg_dt           
            ,rgtrid        
        )VALUES(
             #{title           } 
            ,#{cntnts          } 
            ,#{expsrLcCd     } 
            ,#{menuid          } 
            ,#{siteid          } 
            ,#{loginNeedYn   } 
            ,#{popupTypeCd   } 
            ,#{strtDt         } 
            ,#{endDt          } 
            ,#{widthSize      } 
            ,#{vrticlSize      } 
            ,#{topLc          } 
            ,#{leftLc         } 
            ,#{ntcTrgtCd     } 
            ,#{ntcTrgtRoleid }  
            ,NOW() 
            ,#{user.userid     } 
            ,NOW() 
            ,#{user.userid     }
        )
    
    </insert>
    
   <update id="updatePopUpNtc" parameterType="PopUpNtcVo">
        /* PopDaoImpl.updatePopUpNtc */
        UPDATE TB_CMM_POPUPNTC
          SET
            title             =  #{title           } 
            ,cntnts           =  #{cntnts          } 
            ,expsr_lc_cd      =  #{expsrLcCd     } 
            ,menuid           =  #{menuid          } 
            ,siteid           =  #{siteid          } 
            ,login_need_yn    =  #{loginNeedYn   } 
            ,popup_type_cd    =  #{popupTypeCd   } 
            ,strt_dt          =  #{strtDt         } 
            ,end_dt           =  #{endDt          } 
            ,width_size       =  #{widthSize      } 
            ,vrticl_size       =  #{vrticlSize      } 
            ,top_lc           =  #{topLc          } 
            ,left_lc          =  #{leftLc         } 
            ,ntc_trgt_cd      =  #{ntcTrgtCd     } 
            ,ntc_trgt_roleid  =  #{ntcTrgtRoleid } 
            ,mdfcn_dt          =  NOW()           
            ,mdfrid       =  #{user.userid     }
        WHERE  popupntcid = #{popupntcid}
   </update>
    
    
 <select id="selectPopUpNtcList"  parameterType="PopUpNtcVo" resultType="PopUpNtcVo" >
    /* PopDaoImpl.selectPopUpNtcList */
   <include refid="PaginationMapper.header"/>
    SELECT 
      A.POPUPNTCID                 popupntcid   
     ,A.TITLE                      title         
     ,A.CNTNTS                     cntnts         
     ,A.expsr_lc_cd  
     ,A.MENUID                     menuid     
     ,A.SITEID                     sitid     
     ,A.LOGIN_NEED_YN              login_need_yn
     ,A.POPUP_TYPE_CD              popup_type_cd   
     ,A.STRT_DT                    strt_dt
     ,A.END_DT                     end_dt
     ,A.WIDTH_SIZE                 width_size
     ,A.VRTICL_SIZE                 vrticl_size
     ,A.TOP_LC                     top_lc
     ,A.LEFT_LC                    left_lc         
     ,A.NTC_TRGT_CD                ntc_trgt_cd          
     ,A.ntc_trgt_roleid            ntc_trgt_roleid 
     ,CONVERT(A.MDFCN_DT, CHAR(10)) mdfcn_dt         
     ,A.MDFRID      
     ,A.REG_DT          
     ,A.RGTRID
     ,B.NM                         upd_nm
     ,CASE 
        WHEN STRT_DT <![CDATA[> ]]> CONVERT(NOW(), CHAR(10))  THEN '대기'
        WHEN END_DT  <![CDATA[< ]]> CONVERT(NOW(), CHAR(10))  THEN '만료'
        ELSE '진행'
      END pop_sts
   FROM  
    TB_CMM_POPUPNTC A,
    TB_CMM_USER B
   WHERE 1=1
         AND A.MDFRID = B.USERID
        <if test="serachSiteid != null and serachSiteid !='' ">
         AND A.SITEID = #{serachSiteid}
        </if>
        <if test="searchExpsrLcCd != null and searchExpsrLcCd.trim()!= ''">
         AND A.EXPSR_LC_CD = #{searchExpsrLcCd}
        </if>
        
        <if test="searchType != null and searchType.trim() == 'title' and searchKeyword !='' "> 
         AND A.TITLE LIKE '%'+#{searchKeyword}+'%'
        </if>
        
        <if test="searchType != null and searchType.trim() == 'cntnts' and searchKeyword !='' ">
         AND A.CNTNTS LIke '%'+#{searchKeyword}+'%'
        </if>
        
        <if test='searchTermSttsCd != null and searchTermSttsCd == "1"'>
          AND CONVERT(NOW(), CHAR(10)) BETWEEN STRT_DT AND END_DT 
        </if>
        <if test='searchTermSttsCd != null and searchTermSttsCd == "2"'>
          AND STRT_DT <![CDATA[> ]]>  CONVERT(NOW(), CHAR(10)) 
        </if>
        <if test='searchTermSttsCd != null and searchTermSttsCd == "3"'>
          AND END_DT  <![CDATA[< ]]>  CONVERT(NOW(), CHAR(10)) 
        </if>
    <include refid="PaginationMapper.footer"/>
   </select>
   
   <select id="selectPopUpNtc"  parameterType="PopUpNtcVo" resultType="PopUpNtcVo" > 
         /* PopDaoImpl.selectPopUpNtc */
          SELECT
            title            
            ,cntnts           
            ,expsr_lc_cd      
            ,a.menuid           
            ,a.siteid           
            ,login_need_yn    
            ,popup_type_cd    
            ,strt_dt           
            ,end_dt            
            ,width_size       
            ,vrticl_size       
            ,top_lc           
            ,left_lc          
            ,ntc_trgt_cd      
            ,ntc_trgt_roleid
            ,popupntcid
            ,b.NM  role_nm
            ,c.nm  menu_nm
          FROM 
            TB_CMM_POPUPNTC a
           left outer join 
            tb_cmm_role b
            on (a.ntc_trgt_roleid = b.ROLEID)
           left outer join
            tb_cmm_menu c
            on (a.MENUID=c.MENUID)
          WHERE 1=1
            AND popupntcid = #{popupntcid}  
   </select>
   
   <delete id="deletePopUpNtc"  parameterType="PopUpNtcVo">
   /* PopDaoImpl.deletePopUpNtc */
      DELETE FROM TB_CMM_POPUPNTC
      WHERE POPUPNTCID = #{popupntcid}
  </delete>
   
  <select id="getDataForCommnonPopup"  parameterType="PopUpNtcVo" resultType="PopUpNtcVo" >
         /* PopDaoImpl.getDataForCommnonPopup */
          SELECT
            title            
            ,cntnts           
            ,expsr_lc_cd      
            ,menuid           
            ,siteid           
            ,login_need_yn    
            ,popup_type_cd    
            ,strt_dt           
            ,end_dt            
            ,width_size       
            ,vrticl_size       
            ,top_lc           
            ,left_lc          
            ,ntc_trgt_cd      
            ,ntc_trgt_roleid
            ,popupntcid
          FROM 
            TB_CMM_POPUPNTC a
          WHERE 1=1
            AND (NTC_TRGT_CD ='T' OR (NTC_TRGT_CD ='R' AND NTC_TRGT_ROLEID = #{user.roleInfo.roleid})) 
            AND STRT_DT <![CDATA[<= ]]> CONVERT(NOW(), CHAR(10))
            AND END_DT  <![CDATA[>= ]]> CONVERT(NOW(), CHAR(10))
            AND SITEID = #{siteid} 
            <if test="expsrLcCd != null and expsrLcCd.trim()!= ''">
	         AND expsr_lc_cd = #{expsrLcCd}
	        </if>
            <if test="menuid != null and menuid != 0 ">
             AND menuid = #{menuid}
	        </if>
            <if test='user == null or user.userid == null or  user.userid != "" '>
             AND LOGIN_NEED_YN = 'N'
	        </if>
  </select>
  
  <select id="selectPopUpNtcRoleList"  parameterType="PopUpNtcVo" resultType="RoleVo" >
        /* PopDaoImpl.selectPopUpNtcRoleList */
        <![CDATA[
            SELECT
                A.ROLEID ,  
                A.NM  ,
                A.TRGT_INST_CD ,
                A.TRGT_RGN_CD 
            FROM TB_CMM_ROLE A
            WHERE 1=1
        ]]>
        <if test='user.roleInfo.trgtInstCd == "S"'>
            AND TRGT_INST_CD != 'A'
        </if>
        ORDER BY ORD
   </select>
  
  
</mapper>