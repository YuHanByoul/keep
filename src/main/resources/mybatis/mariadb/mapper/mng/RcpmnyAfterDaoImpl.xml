<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : RcpmnyAfterDaoImpl.xml
	Description : 입금 후
-->
<mapper namespace="com.kbrainc.plum.mng.rcpmnyAfter.model.RcpmnyAfterDao">

    <!-- 예약내역 목록 조회 -->
    <select id="selectRcpmnyAfterList" parameterType="ResveReqstVo" resultType="ResveReqstVo">
        /* RcpmnyAfterDao.selectRcpmnyAfterList */
        <include refid="PaginationMapper.header"/>
        SELECT
          A.APLYID
          ,A.APLY_DT
          ,A.STLM_STTS_CD
          ,A.APLY_STTS_CD
          ,A.APLCNTID
          ,A.APLCNT_NM
          ,A.AMT
          ,A.DPST_BANK_CD
          ,A.DPST_AMT
          ,A.RFND_DMND_AMT
          ,A.RFND_AMT
          ,A.RFND_REJECT_RSN_CD 
          ,A.MDFCN_DT
          ,A.DPST_IDNTY_DT
          ,C.INSTID
          ,C.INST_NM
          ,B.BGNG_DT
          ,B.END_DT
          ,B.ALLDAY_YN
          ,E.SPCE_NM
          ,F.FCLT_NM
          ,G.ACNT
          ,G.NM
          ,A.REG_DT
        FROM
          TB_FCL_SPCE_APLY A
          INNER JOIN (SELECT B.APLYID, D.SPCEID, MIN(D.BGNG_DT) AS BGNG_DT, B.ALLDAY_YN,
          CASE
          WHEN B.ALLDAY_YN = 'N' THEN MAX(D.END_DT)
          ELSE MAX(D.BGNG_DT) END AS END_DT
          FROM TB_FCL_APLY_RSVTDE B
          LEFT JOIN TB_FCL_SPCE_RSVTDE D ON B.RSVTDEID = D.RSVTDEID
          GROUP BY APLYID) B
          ON A.APLYID = B.APLYID
          INNER JOIN TB_FCL_SPCE E
          ON B.SPCEID = E.SPCEID
          INNER JOIN TB_FCL_FCLT F
          ON E.FCLTID = F.FCLTID
          INNER JOIN TB_CMM_INST C
          ON F.INSTID = C.INSTID
          LEFT OUTER JOIN TB_CMM_USER G ON A.APLCNTID = G.USERID
        WHERE 1=1
          AND STLM_STTS_CD IN('161102')
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('spceNm')">
            AND E.SPCE_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('fcltNm')">
            AND F.FCLT_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('instNm')">
            AND C.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('acnt')">
            AND G.ACNT LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('aplcntNm')">
            AND A.APLCNT_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchAplySttsCd != null and searchAplySttsCd != ''">
            AND A.APLY_STTS_CD = #{searchAplySttsCd}
        </if>
        <if test="searchStlmSttsCd != null and searchStlmSttsCd != ''">
            AND A.STLM_STTS_CD = #{searchStlmSttsCd}
        </if>
        <if test="searchBgngDt != null and searchBgngDt != '' and searchEndDt != null and searchEndDt != '' ">
            AND A.DPST_IDNTY_DT <![CDATA[>=]]> CONCAT(#{searchBgngDt},' 00:00:00')  AND  A.DPST_IDNTY_DT <![CDATA[<=]]> CONCAT(#{searchEndDt},' 23:59:59') 
        </if>
        <!-- 타메뉴에서 상세 진입시  -->
        <if test="selectedApplyid  != null and selectedApplyid != ''">
            AND A.APLYID = #{selectedApplyid}
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 입금 확인 취소 처리 -->
    <update id="updateDsptCheckCancel" parameterType="ResveReqstVo">
        /* RcpmnyAfterDao.updateDsptCheckCancel */
        UPDATE TB_FCL_SPCE_APLY SET
              DPST_DE             = null
              ,APLY_STTS_CD       = '160101'
              ,STLM_STTS_CD       = '161101'
              ,DPST_AMT           = null
              ,CNCL_RSN_CD        = null         
              ,RSVT_CNCL_RSN      = null 
              ,RFND_REJECT_RSN_CD = null 
              ,RFND_REJECT_RSN    = null 
              ,MDFCN_DT           = NOW()
              ,MDFRID             = #{user.userid}
        WHERE 1=1
          <if test="aplyid  != null and aplyid != ''">
           AND APLYID = #{aplyid}
          </if>
          <if test="aplyids  != null and aplyids != ''">
          AND APLYID IN (
             SELECT APLYID FROM TB_FCL_SPCE_APLY WHERE APLY_STTS_CD != '160103'  AND APLYID IN (
            <foreach item="aplyid" collection="aplyids" separator=",">
               #{aplyid}
            </foreach>
             )
            )
         </if>
    </update>

    <!-- 환불요청 처리 -->
    <update id="updateRefnd" parameterType="ResveReqstVo" >
        /* RcpmnyAfterDao.updateRefnd */
        UPDATE TB_FCL_SPCE_APLY SET
              RFND_DMND_AMT          = #{rfndDmndAmt}
              ,RFND_DMND_DT          = NOW()
              ,APLY_STTS_CD          = '160103'
              ,STLM_STTS_CD          = '161103'
              ,CNCL_RSN_CD           = '215101' -- 관리자 처리시 : 예약 취소 요청 건으로 입력                 
              ,CNCL_DT               = NOW() -- 관리자 처리시 : 예약 취소 요청 건으로 입력                 
              ,RSVT_CNCL_RSN         = null 
              ,RFND_REJECT_RSN_CD    = null 
              ,RFND_REJECT_RSN       = null 
              ,RFND_BANK_CD          = #{rfndBankCd}
              ,RFND_BACNT            = #{rfndBacnt}
              ,RFND_PYR_NM           = #{rfndPyrNm}
              ,RFND_DMND_DT          = NOW()
              ,MDFRID                = #{user.userid}
              ,MDFCN_DT              = NOW()
        WHERE APLYID = #{aplyid}
    </update>
</mapper>