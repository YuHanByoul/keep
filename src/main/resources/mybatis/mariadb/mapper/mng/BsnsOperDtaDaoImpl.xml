<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<!--
	SQL File Name : BsnsOperDtaDaoImpl.xml
	Description : 사업운영자료 관리
-->
<mapper namespace="com.kbrainc.plum.mng.bsnsOperDta.model.BsnsOperDtaDao">
    <select id="selectBsnsOperDtaList" resultType="com.kbrainc.plum.mng.bsnsOperDta.model.BsnsOperDtaVo">
        <include refid="PaginationMapper.header"/>
            SELECT
                A.DTAID
                , A.TTL
                , C.INST_NM
                , A.REG_DT
                , A.HITS
                , B.CLSF_CD
                , A.DEL_YN
            FROM TB_CMM_BSNS_OPER_DTA A
            INNER JOIN
                (
                    SELECT TCBODCM.DTAID, GROUP_CONCAT(TCC.CD_NM) CLSF_CD
                    FROM TB_CMM_BSNS_OPER_DTA_CLSF_MAPNG TCBODCM
                    INNER JOIN TB_CMM_CD TCC
                        ON TCBODCM.CLSF_CD = TCC.CD
                    GROUP BY TCBODCM.DTAID
                ) B
                ON B.DTAID = A.DTAID
            INNER JOIN TB_CMM_INST C
                ON A.INSTID = C.INSTID
            WHERE 1=1
            <if test="searchKeyword != null and searchKeyword != ''">
                <choose>
                    <when test="searchType == 'ttl'">
                        AND A.TTL LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="searchType == 'cn'">
                        AND A.CN LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <otherwise>
                        AND (A.TTL LIKE CONCAT('%', #{searchKeyword}, '%') OR A.CN LIKE CONCAT('%', #{searchKeyword}, '%'))
                    </otherwise>
                </choose>
            </if>

            <if test="searchInstNm != null and searchInstNm !=''">
                AND C.INST_NM LIKE CONCAT('%', #{searchInstNm}, '%')
            </if>

            <if test="searchClsfCdNm != null and searchClsfCdNm != ''">
                AND B.CLSF_CD LIKE CONCAT('%', #{searchClsfCdNm} ,'%')
            </if>

            <if test="searchBgngDt != null and searchBgngDt != ''">
                AND DATE_FORMAT(A.REG_DT, '%Y-%m-%d') <![CDATA[>=]]> #{searchBgngDt}
            </if>
            <if test="searchEndDt != null and searchEndDt != ''">
                AND DATE_FORMAT(A.REG_DT, '%Y-%m-%d') <![CDATA[<=]]> #{searchEndDt}
            </if>
        <include refid="PaginationMapper.footer"/>
    </select>

    <select id="selectBsnsOperDta" resultType="com.kbrainc.plum.mng.bsnsOperDta.model.BsnsOperDtaVo">
        SELECT
            A.DTAID
             , A.YY
             , A.INSTID
             , C.INST_NM
             , A.TTL
             , A.CN
             , A.REG_DT
             , A.DEL_YN
             , A.MDFCN_DT
             , A.PDF_FILEID
             , A.ATCH_FILEGRPID
             , A.CPYRHT_CD
             , A.HITS
             , A.RGTRID
             , B.CLSF_CD
             , D.NM AS RGTR_NM
             , D.ACNT AS RGTR_ACNT
        FROM TB_CMM_BSNS_OPER_DTA A
        INNER JOIN
        (
             SELECT DTAID, GROUP_CONCAT(CLSF_CD) CLSF_CD
             FROM TB_CMM_BSNS_OPER_DTA_CLSF_MAPNG
             GROUP BY DTAID
        ) B
            ON B.DTAID = A.DTAID
        INNER JOIN TB_CMM_INST C
            ON A.INSTID = C.INSTID
        INNER JOIN TB_CMM_USER D
            ON A.RGTRID = D.USERID
        WHERE A.DTAID = #{dtaid}
    </select>

    <insert id="insertBsnsOperDta" useGeneratedKeys="true" keyProperty="dtaid">
        INSERT INTO TB_CMM_BSNS_OPER_DTA(
            YY
            , INSTID
            , INST_NM
            , TTL
            , CN
            , DEL_YN
            , PDF_FILEID
            , ATCH_FILEGRPID
            , CPYRHT_CD
            , HITS
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        )
        VALUES(
            #{yy}
            , #{instid}
            , #{instNm}
            , #{ttl}
            , #{cn}
            , 'N'
            , #{pdfFileid}
            , #{atchFilegrpid}
            , #{cpyrhtCd}
            , 0
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>

    <update id="updateBsnsOperDta">
        UPDATE TB_CMM_BSNS_OPER_DTA
        SET
            YY = #{yy}
            , INSTID = #{instid}
            , INST_NM = #{instNm}
            , TTL = #{ttl}
            , CN = #{cn}
            , PDF_FILEID = #{pdfFileid}
            , ATCH_FILEGRPID = #{atchFilegrpid}
            , CPYRHT_CD = #{cpyrhtCd}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE DTAID = #{dtaid}
    </update>

    <update id="deleteBsnsOperDta">
        UPDATE TB_CMM_BSNS_OPER_DTA
        SET
            DEL_YN = 'Y'
            MDFCN_DT = NOW()
            MDFRID = #{user.userid}
        WHERE
            DTAID IN
            <foreach collection="deleteDtaids" item="dtaid" separator="," open="(" close=")">
                #{dtaid}
            </foreach>
    </update>

    <insert id="insertBsnsOperDtaClsfMapping">
        INSERT INTO TB_CMM_BSNS_OPER_DTA_CLSF_MAPNG
        (
             DTAID
             , CLSF_CD
             , REG_DT
             , RGTRID
         ) VALUES
           <foreach collection="clsfCds" item="clsfCd" separator=",">
           (
               #{dtaid}
               , #{clsfCd}
               , NOW()
               , #{user.userid}
           )
           </foreach>
    </insert>

    <delete id="deleteBsnsOperDtaClsfMapping">
        DELETE FROM TB_CMM_BSNS_OPER_DTA_CLSF_MAPNG
        WHERE DTAID = #{dtaid}
    </delete>

</mapper>