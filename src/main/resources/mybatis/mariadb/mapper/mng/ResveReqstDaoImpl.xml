<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : ResveReqstDaoImpl.xml
	Description : 시설예약
-->
<mapper namespace="com.kbrainc.plum.mng.resveReqst.model.ResveReqstDao">

    <!-- 예약내역 목록 조회 -->
    <select id="selectResveReqstList" parameterType="ResveReqstVo" resultType="ResveReqstVo">
        /* ResveReqstDao.selectResveReqstList */
        <include refid="PaginationMapper.header"/>
        SELECT
          A.APLYID
          ,A.APLY_DT
          ,A.STLM_STTS_CD
          ,A.APLY_STTS_CD
          ,A.APLCNTID
          ,A.APLCNT_NM
          ,A.AMT
          ,A.DPST_BANK_CD
          ,A.DPST_AMT
          ,A.RFND_DMND_AMT
          ,A.RFND_AMT
          ,A.RFND_REJECT_RSN_CD 
          ,A.MDFCN_DT
          ,C.INSTID
          ,C.INST_NM
          ,B.BGNG_DT
          ,B.END_DT
          ,B.ALLDAY_YN
          ,E.SPCE_NM
          ,F.FCLT_NM
          ,G.ACNT
          ,G.NM
        FROM
          TB_FCL_SPCE_APLY A
          INNER JOIN (SELECT B.APLYID, D.SPCEID, MIN(D.BGNG_DT) AS BGNG_DT, B.ALLDAY_YN,
          CASE
          WHEN B.ALLDAY_YN = 'N' THEN MAX(D.END_DT)
          ELSE MAX(D.BGNG_DT) END AS END_DT
          FROM TB_FCL_APLY_RSVTDE B
          LEFT JOIN TB_FCL_SPCE_RSVTDE D ON B.RSVTDEID = D.RSVTDEID
          GROUP BY APLYID) B
          ON A.APLYID = B.APLYID
          INNER JOIN TB_FCL_SPCE E
          ON B.SPCEID = E.SPCEID
          INNER JOIN TB_FCL_FCLT F
          ON E.FCLTID = F.FCLTID
          INNER JOIN TB_CMM_INST C
          ON F.INSTID = C.INSTID
          LEFT OUTER JOIN TB_CMM_USER G ON A.APLCNTID = G.USERID
        WHERE 1=1
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('spceNm')">
            AND E.SPCE_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('fcltNm')">
            AND F.FCLT_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('instNm')">
            AND C.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('acnt')">
            AND G.ACNT LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('aplcntNm')">
            AND A.APLCNT_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchAplySttsCd != null and searchAplySttsCd != ''">
            AND A.APLY_STTS_CD = #{searchAplySttsCd}
        </if>
        <if test="searchStlmSttsCd != null and searchStlmSttsCd != ''">
            AND A.STLM_STTS_CD = #{searchStlmSttsCd}
        </if>
        <if test="searchBgngDt != null and searchBgngDt != '' and searchEndDt != null and searchEndDt != '' ">
               AND(
                    (date_format(BGNG_DT, '%Y-%m-%d'  ) <![CDATA[<=]]> #{searchBgngDt} AND date_format(BGNG_DT, '%Y-%m-%d'  ) <![CDATA[>=]]> #{searchEndDt} )OR 
                    (date_format(END_DT, '%Y-%m-%d'  ) <![CDATA[>=]]> #{searchBgngDt}  AND date_format(END_DT, '%Y-%m-%d'  ) <![CDATA[<=]]> #{searchEndDt}  )
                 )
        </if>
        <if test='user.roleInfo.trgtInstCd == "S"'>
           AND C.INSTID = #{user.instid}
        </if>
        <!-- 상태 변경 전 조회 -->
        <if test="selectedApplyid  != null and selectedApplyid != ''">
            AND A.APLYID = #{selectedApplyid}
        </if>  
        <!-- 상태 변경 전 조회 -->
        <if test="aplyids  != null and aplyids != ''">
            AND A.APLYID IN (
            <foreach item="aplyid" collection="aplyids" separator=",">
               #{aplyid}
            </foreach>
            )
        </if>  
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 예약내역 상세조회 -->
    <select id="selectResveReqstInfo" parameterType="ResveReqstVo" resultType="ResveReqstVo">
        /* ResveReqstDao.selectResveReqstInfo */
        SELECT
            A.APLYID
             ,A.APLY_DT
             ,A.STLM_STTS_CD
             ,A.APLY_STTS_CD
             ,A.APLCNTID
             ,A.APLCNT_NM
             ,A.APLCNT_MOBLPHON
             ,A.APLCNT_EML
             ,A.CNCL_DT
             ,A.RFND_DMND_DT
             ,A.PYR_NM
             ,A.DPST_BANK_CD
             ,A.DPST_BACNT
             ,A.DPST_AMT
             ,A.DPST_DE
             ,A.DPST_IDNTY_DT
             ,A.RFND_DMND_AMT
             ,A.RFND_BANK_CD
             ,A.RFND_BACNT
             ,A.RFND_PYR_NM
             ,A.RFND_AMT
             ,A.RFND_DE
             ,A.NOPE_ADULT
             ,A.NOPE_CHIL
             ,A.NOPE_INFNT
             ,A.UTZTN_PRPS
             ,A.AMT
             ,A.RSVT_CNCL_RSN
             ,A.RFND_REJECT_RSN_CD 
             ,C.INSTID
             ,C.INST_NM
             ,B.RESVE_DT
             ,E.SPCE_NM
             ,F.FCLT_NM
             ,F.BACNT_NO
             ,F.DPSTR_NM
             ,G.CD_NM AS INST_TYPE_CD_NM
             ,'예약신청' AS PAY_STTUS
             ,'입금대기' AS REQST_STTUS
             ,CASE WHEN IFNULL(I.ROLECD,'U') = 'U' AND H.INSTID IS NOT NULL THEN '기업회원'
                   WHEN IFNULL(I.ROLECD,'U') = 'U' AND H.INSTID IS NULL THEN '개인회원'
                   ELSE '관리자'
            END AS ROLECDNM
             ,H.NM
             ,H.MOBLPHON
             ,H.EML
             ,H.ACNT
             ,IFNULL(J.INST_NM, '-') AS USER_INST_NM
             ,STLM_MTHD_CD
        FROM
            TB_FCL_SPCE_APLY A
            INNER JOIN (
                   SELECT 
                       A.APLYID
                       ,B.SPCEID
                       ,GROUP_CONCAT(
                         CONCAT(B.DE,' ',(CASE WHEN B.ALLDAY_YN ='N' THEN CONCAT (DATE_FORMAT(B.BGNG_DT,'%H시%i분'),' ~ ',DATE_FORMAT(B.END_DT,'%H시%i분')) ELSE '숙박'END),' (',FORMAT(B.AMT,0),'원)')
                       SEPARATOR  '/' ) AS RESVE_DT  
                     FROM 
                       TB_FCL_APLY_RSVTDE A
                       LEFT JOIN TB_FCL_SPCE_RSVTDE B 
                       ON A.RSVTDEID = B.RSVTDEID
                    WHERE A.APLYID = #{aplyid}
                    GROUP BY APLYID
            ) B ON A.APLYID = B.APLYID
            INNER JOIN TB_FCL_SPCE E
            ON B.SPCEID = E.SPCEID
            INNER JOIN TB_FCL_FCLT F
            ON E.FCLTID = F.FCLTID
            INNER JOIN TB_CMM_INST C
            ON F.INSTID = C.INSTID
            LEFT OUTER JOIN TB_CMM_CD G ON C.INST_TYPE_CD = G.CD
            LEFT OUTER JOIN TB_CMM_USER H ON A.APLCNTID = H.USERID
            LEFT OUTER JOIN (
                SELECT
                    A.USERID
                     ,CASE WHEN INSTR(GROUP_CONCAT(A.ROLEID),'1') > 0 OR INSTR(GROUP_CONCAT(A.ROLEID),'5') > 0 THEN 'A'
                           ELSE 'U'
                    END AS ROLECD
                FROM
                    TB_CMM_ROLE_USER A
                   ,TB_CMM_ROLE B
                WHERE 1=1
                  AND A.ROLEID = B.ROLEID
                GROUP BY USERID
            ) I
            ON(H.USERID = I.USERID)
            LEFT OUTER JOIN TB_CMM_INST J ON H.INSTID = J.INSTID
        WHERE 1=1
          AND A.APLYID = #{aplyid}
    </select>

    <!-- 예약내역 수정 -->
    <update id="updateResveReqst" parameterType="ResveReqstVo" keyProperty="aplyid">
        /* ResveReqstDao.updateResveReqst */
        UPDATE TB_FCL_SPCE_APLY SET
            APLCNT_NM        = #{aplcntNm}
            ,APLCNT_MOBLPHON = #{aplcntMoblphon}
            ,APLCNT_EML      = #{aplcntEml}
            ,NOPE_ADULT      = #{nopeAdult}
            ,NOPE_CHIL       = #{nopeChil}
            ,NOPE_INFNT      = #{nopeInfnt}
            ,UTZTN_PRPS      = #{utztnPrps}
            ,DPST_AMT        = #{dpstAmt}
            ,PYR_NM          = #{pyrNm}
            ,DPST_DE         = #{dpstDe}
            ,RFND_AMT        = #{rfndAmt}
            ,RFND_DE         = #{rfndDe}
            ,RFND_BANK_CD    = #{rfndBankCd}
            ,RFND_BACNT      = #{rfndBacnt}
            ,RFND_PYR_NM     = #{rfndPyrNm}
            ,MDFCN_DT        = NOW()
            ,MDFRID          = #{user.userid}
        WHERE APLYID = #{aplyid}
    </update>

    <!-- 상태변경이력 목록 조회 -->
    <select id="selectResveReqstHstryList" parameterType="ResveReqstVo" resultType="ResveReqstVo">
        /* ResveReqstDao.selectResveReqstHstryList */
        <include refid="PaginationMapper.header"/>
        SELECT
        A.HSTRYID
        , A.APLYID
        , A.RCPT_NO
        , A.APLCNTID
        , A.INSTID
        , A.APLCNT_NM
        , A.APLCNT_MOBLPHON
        , A.APLCNT_EML
        , A.NOPE_ADULT
        , A.NOPE_CHIL
        , A.NOPE_INFNT
        , A.UTZTN_PRPS
        , A.AMT
        , A.DPST_AMT
        , A.RFND_DMND_AMT
        , A.RFND_AMT
        , A.STLM_MTHD_CD
        , A.DPST_BACNT
        , A.PYR_NM
        , A.APLY_DT
        , A.DPST_BANK_CD
        , A.DPST_DE
        , A.DPST_IDNTY_DT
        , A.CNCL_RSN_CD
        , A.CNCL_DT
        , A.RFND_DMND_DT
        , A.RFND_DE
        , A.RFND_CMPTN_DT
        , A.RFND_BANK_CD
        , A.RFND_BACNT
        , A.RFND_PYR_NM
        , A.APLY_STTS_CD
        , A.STLM_STTS_CD
        , A.RSVT_CNCL_RSN
        , A.RFND_REJECT_RSN
        , A.RFND_REJECT_RSN_CD
        , A.MDFCN_DT
        , A.MDFRID
        , A.REG_DT
        , A.RGTRID
        , A1.CD_NM AS APLY_STTS_CD_NM
        , A2.CD_NM AS STLM_STTS_CD_NM
        , B.ALLDAY_YN
        , G.ACNT
        , G.NM
        FROM TB_FCL_SPCE_APLY_HSTRY A
        INNER JOIN (
        SELECT
        CD
        , CD_NM
        FROM
        TB_CMM_CD
        WHERE
        CDGRPID = 160
        ) A1 ON (A.APLY_STTS_CD = A1.CD)
        INNER JOIN (
        SELECT
        CD
        , CD_NM
        FROM
        TB_CMM_CD
        WHERE
        CDGRPID = 161
        ) A2 ON (A.STLM_STTS_CD = A2.CD)
        INNER JOIN (SELECT B.APLYID, D.SPCEID, MIN(D.BGNG_DT) AS BGNG_DT, B.ALLDAY_YN,
        CASE
        WHEN B.ALLDAY_YN = 'N' THEN MAX(D.END_DT)
        ELSE MAX(D.BGNG_DT) END AS END_DT
        FROM TB_FCL_APLY_RSVTDE B
        LEFT JOIN TB_FCL_SPCE_RSVTDE D ON B.RSVTDEID = D.RSVTDEID
        GROUP BY APLYID) B
        ON A.APLYID = B.APLYID
        INNER JOIN TB_FCL_SPCE E
        ON B.SPCEID = E.SPCEID
        INNER JOIN TB_FCL_FCLT F
        ON E.FCLTID = F.FCLTID
        INNER JOIN TB_CMM_INST C
        ON F.INSTID = C.INSTID
        LEFT OUTER JOIN TB_CMM_USER G ON A.MDFRID = G.USERID
        WHERE 1=1
        AND A.APLYID = #{aplyid}
        <include refid="PaginationMapper.footer"/>
    </select>


    <!-- 상태변경이력 사유 조회 -->
    <select id="selectHstryInfo" parameterType="ResveReqstVo" resultType="ResveReqstVo">
        /* ResveReqstDao.selectHstryInfo */
        SELECT CASE
                   WHEN A.STLM_STTS_CD = 161101 AND A.APLY_STTS_CD = 160101 THEN '' /* 입금대기 - 예약신청 */
                   WHEN A.STLM_STTS_CD = 161101 AND A.APLY_STTS_CD = 160103 THEN A.RSVT_CNCL_RSN /* 입금대기 - 예약취소 - 예약취소사유 */
                   WHEN A.STLM_STTS_CD = 161102 AND A.APLY_STTS_CD = 160102 THEN A.RFND_REJECT_RSN /* 입금완료 - 예약승인 */
                   WHEN A.STLM_STTS_CD = 161103 AND A.APLY_STTS_CD = 160103 THEN '' /* 환불요청 - 예약취소 */
                   WHEN A.STLM_STTS_CD = 161104 AND A.APLY_STTS_CD = 160103 THEN '' /* 환불완료 - 예약취소 */
                   WHEN A.STLM_STTS_CD = 161102 AND A.APLY_STTS_CD = 160102
                       THEN A.RFND_REJECT_RSN /* 환불완료 - 예약취소 - 환불완료취소 - 환불완료취소사유 and 환불완료취소사유코드 */
                   ELSE ''
                   END AS CHG_RSN,
               APLY_STTS_CD,
               STLM_STTS_CD
        FROM TB_FCL_SPCE_APLY_HSTRY A
        WHERE 1 = 1
          AND HSTRYID = #{hstryid}
    </select>

    <!-- 상태변경이력 추가 -->
    <insert id="insertHstry" parameterType="ResveReqstVo" keyProperty="userid">
        /* ResveReqstDao.insertHstry */
        INSERT INTO TB_FCL_SPCE_APLY_HSTRY(
              APLYID
              ,RCPT_NO
              ,APLCNTID
              ,INSTID
              ,APLCNT_NM
              ,APLCNT_MOBLPHON
              ,APLCNT_EML
              ,NOPE_ADULT
              ,NOPE_CHIL
              ,NOPE_INFNT
              ,UTZTN_PRPS
              ,AMT
              ,DPST_AMT
              ,RFND_DMND_AMT
              ,RFND_AMT
              ,STLM_MTHD_CD
              ,DPST_BANK_CD
              ,DPST_BACNT
              ,PYR_NM
              ,APLY_DT
              ,DPST_DE
              ,DPST_IDNTY_DT
              ,CNCL_DT
              ,RFND_DMND_DT
              ,RFND_DE
              ,RFND_CMPTN_DT
              ,RFND_BANK_CD
              ,RFND_BACNT
              ,RFND_PYR_NM
              ,APLY_STTS_CD
              ,STLM_STTS_CD
              ,CNCL_RSN_CD
              ,RSVT_REJECT_RSN
              ,RSVT_CNCL_RSN
              ,RFND_REJECT_RSN_CD
              ,RFND_REJECT_RSN
              ,MDFCN_DT
              ,MDFRID 
              ,REG_DT
              ,RGTRID  
        )
        SELECT
              APLYID
              ,RCPT_NO
              ,APLCNTID
              ,INSTID
              ,APLCNT_NM
              ,APLCNT_MOBLPHON
              ,APLCNT_EML
              ,NOPE_ADULT
              ,NOPE_CHIL
              ,NOPE_INFNT
              ,UTZTN_PRPS
              ,AMT
              ,DPST_AMT
              ,RFND_DMND_AMT
              ,RFND_AMT
              ,STLM_MTHD_CD
              ,DPST_BANK_CD
              ,DPST_BACNT
              ,PYR_NM
              ,APLY_DT
              ,DPST_DE
              ,DPST_IDNTY_DT
              ,CNCL_DT
              ,RFND_DMND_DT
              ,RFND_DE
              ,RFND_CMPTN_DT
              ,RFND_BANK_CD
              ,RFND_BACNT
              ,RFND_PYR_NM
              ,APLY_STTS_CD
              ,STLM_STTS_CD
              ,CNCL_RSN_CD
              ,RSVT_REJECT_RSN
              ,RSVT_CNCL_RSN
              ,RFND_REJECT_RSN_CD
              ,RFND_REJECT_RSN
              ,MDFCN_DT
              ,MDFRID 
              ,NOW()
              ,#{user.userid}
        FROM TB_FCL_SPCE_APLY
       WHERE 1=1
         <if test="aplyid  != null and aplyid != ''">
          AND APLYID = #{aplyid}
         </if>
         <if test="aplyids  != null and aplyids != ''">
          AND APLYID IN (
              <foreach item="aplyid" collection="aplyids" separator=",">
               #{aplyid}
              </foreach>
             )
          </if>
    </insert>
</mapper>