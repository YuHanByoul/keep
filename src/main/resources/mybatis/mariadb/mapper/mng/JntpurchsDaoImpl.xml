<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : JntpurchsDaoImpl.xml
    Description : 공동구매관리
-->
<mapper namespace="com.kbrainc.plum.mng.jntpurchs.model.JntpurchsDao">
    
    <!-- 공동구매모집 목록 조회 -->
    <select id="selectJntpurchsList" parameterType="JntpurchsVo" resultType="JntpurchsVo">
        /* JntpurchsDao.selectJntpurchsList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.JNTPURCHSID
            , A.JNTPURCHSNO
            , A.JNTPURCHS_NM
            , GROUP_CONCAT(C.TCHAID_NM SEPARATOR ', ') AS TCHAID_NM
            , A.BGNG_DT
            , A.END_DT
            , CASE WHEN NOW() <![CDATA[>]]> A.END_DT THEN '모집종료' WHEN A.STTS_CD <![CDATA[=]]> '172104' THEN '일시중지'
              WHEN NOW() <![CDATA[<]]> A.BGNG_DT THEN '모집대기' 
              WHEN A.QNTY_WHOL_LMT_YN <![CDATA[=]]> 'Y' AND D.ORDER_QNTY <![CDATA[>=]]> A.QNTY_WHOL THEN '재고소진'
              ELSE '모집중' END AS STTS_CD_NM
            , E.ACNT
            , F.INST_NM
            , A.REG_DT
        FROM
            TB_THA_TCHAID_JNTPURCHS A
        LEFT OUTER JOIN
            TB_THA_TCHAID_JNTPURCHS_GOODS B ON (B.JNTPURCHSID = A.JNTPURCHSID)
        LEFT OUTER JOIN
            TB_THA_TCHAID C ON (C.TCHAIDID = B.TCHAIDID)
        LEFT OUTER JOIN (
            SELECT
                JNTPURCHSID
                , SUM(QNTY) AS ORDER_QNTY
                FROM (
                    SELECT
                        B.JNTPURCHSID
                        , B.QNTY
                    FROM
                        TB_THA_TCHAID_JNTPURCHS_ORDER A
                    LEFT OUTER JOIN
                        TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS B ON (B.ORDERID = A.ORDERID)
                    WHERE
                        A.STTS_CD = '181100'
                    GROUP BY
                        A.ORDERID
                        , B.JNTPURCHSID
            ) ORDR
            GROUP BY
                JNTPURCHSID
        ) D ON (D.JNTPURCHSID = A.JNTPURCHSID)
        INNER JOIN (
            SELECT
                USERID
                , INSTID
                , ACNT
            FROM
                TB_CMM_USER
        ) E ON (E.USERID = A.RGTRID)
        LEFT OUTER JOIN
          TB_CMM_INST F ON (F.INSTID = E.INSTID)
        WHERE
            A.STTS_CD != -1
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'jntpurchsNm'">
            AND A.JNTPURCHS_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'jntpurchsNo'">
            AND A.JNTPURCHSNO LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchSttsCd != null and searchSttsCd != '' and searchSttsCd == '172100'">
            AND NOW() <![CDATA[<]]> A.BGNG_DT
        </if>
        <if test="searchSttsCd != null and searchSttsCd != '' and searchSttsCd == '172101'">
            AND (NOW() <![CDATA[>=]]> A.BGNG_DT AND NOW() <![CDATA[<=]]> A.END_DT) 
        </if>
        <if test="searchSttsCd != null and searchSttsCd != '' and searchSttsCd == '172102'">
            AND NOW() <![CDATA[>]]> A.END_DT
        </if>
        <if test="searchSttsCd != null and searchSttsCd != '' and searchSttsCd == '172103'">
            AND (A.QNTY_WHOL_LMT_YN <![CDATA[=]]> 'Y' AND D.ORDER_QNTY <![CDATA[>=]]> A.QNTY_WHOL)
        </if>
        <if test="searchSttsCd != null and searchSttsCd != '' and searchSttsCd == '172104'">
            AND (NOW() <![CDATA[>=]]> A.BGNG_DT AND NOW() <![CDATA[<=]]> A.END_DT AND A.STTS_CD = '172104')
        </if>
        <if test="searchInstType != null and searchInstType != '' and searchInstType == 'epa'">
            AND F.INST_CD = 'epa'
        </if>
        <if test="searchInstType != null and searchInstType != '' and searchInstType == 'other'">
            AND (F.INST_CD != 'epa' OR F.INST_CD IS NULL)
        </if>
        <if test="searchBgngDt != null and searchBgngDt != ''">
            AND A.BGNG_DT <![CDATA[>=]]> CONCAT(#{searchBgngDt}, ' 00:00:00')
        </if>
        <if test="searchEndDt != null and searchEndDt != ''">
            AND A.END_DT <![CDATA[<=]]> CONCAT(#{searchEndDt}, ' 23:59:59')
        </if>
        GROUP BY
            B.JNTPURCHSID
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 공동구매모집 등록 -->
    <insert id="insertJntpurchs" parameterType="JntpurchsVo" useGeneratedKeys="true" keyProperty="jntpurchsid">
        /* JntpurchsDao.insertJntpurchs */
        INSERT INTO TB_THA_TCHAID_JNTPURCHS (
            JNTPURCHSNO
            , JNTPURCHS_NM
            , STTS_CD
            , QNTY_WHOL
            , QNTY_WHOL_LMT_YN
            , QNTY_LMT
            , QNTY_LMT_YN
            , BGNG_DT
            , END_DT
            , DTL_CN
            , MVP_URL
            , MVP_PSTN_CD
            , RPRS_IMG_FILEID
            , DTL_IMG_FILEGRPID
            , MAP_FILEGRPID
            , EDU_PHOTO_FILEGRPID
            , ATENT_MTTR
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            (SELECT CONCAT('GP-', IFNULL(MAX(LPAD(JNTPURCHSID + 1, 3, '0')), LPAD('1', 3, '0'))) FROM TB_THA_TCHAID_JNTPURCHS AS A)
            , #{jntpurchsNm}
            , #{sttsCd}
            , #{qntyWhol}
            , #{qntyWholLmtYn}
            , #{qntyLmt}
            , #{qntyLmtYn}
            , #{bgngDtStr}
            , #{endDtStr}
            , #{dtlCn}
            , #{mvpUrl}
            , #{mvpPstnCd}
            , #{rprsImgFileid}
            , #{dtlImgFilegrpid}
            , #{mapFilegrpid}
            , #{eduPhotoFilegrpid}
            , #{atentMttr}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 공동구매 상품 등록 -->
    <insert id="insertJntpurchsGoods" parameterType="JntpurchsTchaidVo" >
        /* JntpurchsDao.insertJntpurchsGoods */
        INSERT INTO TB_THA_TCHAID_JNTPURCHS_GOODS (
            JNTPURCHSID
            , TCHAIDID
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{jntpurchsid}
            , #{tchaidid}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 공동구매 금액 등록 -->
    <insert id="insertJntpurchsAmt" parameterType="JntpurchsAmtVo" >
        /* JntpurchsDao.insertJntpurchsAmt */
        INSERT INTO TB_THA_TCHAID_JNTPURCHS_AMT (
            JNTPURCHSID
            , QNTY_BGNG
            , QNTY_END
            , AMT
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{jntpurchsid}
            , #{qntyBgng}
            , #{qntyEnd}
            , #{amt}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 교구 목록 조회 -->
    <select id="selectTchaidList" parameterType="JntpurchsTchaidVo" resultType="JntpurchsTchaidVo">
        /* JntpurchsDao.selectTchaidList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.TCHAIDID
            , A.TCHAID_TYPE_CD
            , CONCAT('TA-', LPAD(A.TCHAIDID, 4, '0')) AS TCHAID_NO
            , A.TCHAID_NM
            , A.EDU_TYPE_CD
            , A.TEAM_CMPSTN_CD
            , A.REG_DT
        FROM
            TB_THA_TCHAID A
        WHERE 
            1 = 1
        <if test="searchTchaidKeyword != null and searchTchaidKeyword != '' and searchTchaidType == 'tchaidNm'">
            AND A.TCHAID_NM LIKE CONCAT('%',#{searchTchaidKeyword},'%')
        </if>
        <if test="searchTchaidKeyword != null and searchTchaidKeyword != '' and searchTchaidType == 'tchaidNo'">
            AND CONCAT('TA-', LPAD(A.TCHAIDID, 4, '0')) LIKE CONCAT('%',#{searchTchaidKeyword},'%')
        </if>
        <if test="searchEduTypeCd != null and searchEduTypeCd != ''">
            AND A.EDU_TYPE_CD = #{searchEduTypeCd}
        </if>
        <if test="searchTchaidTypeCd != null and searchTchaidTypeCd != ''">
            AND A.TCHAID_TYPE_CD = #{searchTchaidTypeCd}
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 공동구매모집 상세 정보 조회 -->
    <select id="selectJntpurchsInfo" parameterType="JntpurchsVo" resultType="JntpurchsVo">
        /* JntpurchsDao.selectJntpurchsInfo */
        SELECT
            A.JNTPURCHSID
            , A.JNTPURCHSNO
            , A.JNTPURCHS_NM
            , A.QNTY_WHOL
            , A.QNTY_WHOL_LMT_YN
            , A.QNTY_LMT
            , A.QNTY_LMT_YN
            , DATE_FORMAT(A.BGNG_DT, '%Y-%m-%d %H:%i:%s') AS BGNG_DT_STR
            , DATE_FORMAT(A.END_DT, '%Y-%m-%d %H:%i:%s') AS END_DT_STR
            , A.BGNG_DT
            , A.END_DT
            , A.DTL_CN
            , A.MVP_URL
            , A.MVP_PSTN_CD
            , A.RPRS_IMG_FILEID
            , A.DTL_IMG_FILEGRPID
            , A.MAP_FILEGRPID
            , A.EDU_PHOTO_FILEGRPID
            , A.ATENT_MTTR
            , IFNULL(B.ORDER_QNTY, 0) AS ORDER_QNTY
            , CASE WHEN NOW() <![CDATA[>]]> A.END_DT THEN '모집종료' WHEN A.STTS_CD <![CDATA[=]]> '172104' THEN '일시중지'
              WHEN NOW() <![CDATA[<]]> A.BGNG_DT THEN '모집대기' 
              WHEN A.QNTY_WHOL_LMT_YN <![CDATA[=]]> 'Y' AND B.ORDER_QNTY <![CDATA[>=]]> A.QNTY_WHOL THEN '재고소진'
              ELSE '모집중' END AS STTS_CD_NM
        FROM
            TB_THA_TCHAID_JNTPURCHS A
        LEFT OUTER JOIN (
            SELECT
                SUM(QNTY) AS ORDER_QNTY
            FROM (
                SELECT
                    B.JNTPURCHSID
                    , B.QNTY
                FROM
                    TB_THA_TCHAID_JNTPURCHS_ORDER A
                LEFT OUTER JOIN
                    TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS B ON (B.ORDERID = A.ORDERID)
                WHERE
                    A.STTS_CD = '181100'
                    AND B.JNTPURCHSID = #{jntpurchsid}
                GROUP BY
                    A.ORDERID
                    , B.JNTPURCHSID
            ) ORDR
            GROUP BY
                JNTPURCHSID
        ) B ON 1 = 1
        WHERE
            A.JNTPURCHSID = #{jntpurchsid}
    </select>
    
    <!-- 공동구매모집 상품 정보 조회 -->
    <select id="selectGoodsList" parameterType="JntpurchsTchaidVo" resultType="JntpurchsTchaidVo">
        /* JntpurchsDao.selectGoodsList */
        SELECT
            B.TCHAIDID
            , CONCAT('TA-', LPAD(B.TCHAIDID, 4, '0')) AS TCHAID_NO
            , B.TCHAID_NM
        FROM
            TB_THA_TCHAID_JNTPURCHS_GOODS A
        LEFT OUTER JOIN
            TB_THA_TCHAID B ON (B.TCHAIDID = A.TCHAIDID)
        WHERE
            JNTPURCHSID = #{jntpurchsid}
        ORDER BY
            B.REG_DT DESC
    </select>
    
    <!-- 공동구매모집 수량별 가격 정보 조회 -->
    <select id="selectAmtList" parameterType="JntpurchsAmtVo" resultType="JntpurchsAmtVo">
        /* JntpurchsDao.selectAmtList */
        SELECT
            AMTID
            , QNTY_BGNG
            , QNTY_END
            , AMT
        FROM
            TB_THA_TCHAID_JNTPURCHS_AMT
        WHERE
            JNTPURCHSID = #{jntpurchsid}
        ORDER BY
            AMTID
    </select>
    
    <!-- 공동구매모집 신청 여부 조회 -->
    <select id="isExistOrder" parameterType="JntpurchsVo" resultType="JntpurchsVo">
        /* JntpurchsDao.isExistOrder */
        SELECT
          CASE WHEN COUNT(ORDERID) = 0 THEN 'N' ELSE 'Y' END AS IS_EXIST_ORDER
        FROM
          TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS
        WHERE
          JNTPURCHSID = #{jntpurchsid}
    </select>
    
    <!-- 공동구매모집 정보 업데이트 -->
    <update id="updateJntpurchs" parameterType="JntpurchsVo">
        /* JntpurchsDao.updateJntpurchs */
        UPDATE TB_THA_TCHAID_JNTPURCHS SET
            JNTPURCHS_NM = #{jntpurchsNm}
            , STTS_CD = #{sttsCd}
            , QNTY_WHOL = #{qntyWhol}
            , QNTY_WHOL_LMT_YN = #{qntyWholLmtYn}
            , QNTY_LMT = #{qntyLmt}
            , QNTY_LMT_YN = #{qntyLmtYn}
            , BGNG_DT = #{bgngDtStr}
            , END_DT = #{endDtStr}
            , DTL_CN = #{dtlCn}
            , MVP_URL = #{mvpUrl}
            , MVP_PSTN_CD = #{mvpPstnCd}
            , RPRS_IMG_FILEID = #{rprsImgFileid}
            , DTL_IMG_FILEGRPID = #{dtlImgFilegrpid}
            , MAP_FILEGRPID = #{mapFilegrpid}
            , EDU_PHOTO_FILEGRPID = #{eduPhotoFilegrpid}
            , ATENT_MTTR = #{atentMttr}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE 
            JNTPURCHSID = #{jntpurchsid}
    </update>
    
    <!-- 공동구매 모집상태 업데이트 -->
    <update id="updateJntpurchsStts" parameterType="JntpurchsVo">
        UPDATE TB_THA_TCHAID_JNTPURCHS SET
            STTS_CD = #{sttsCd}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE 
            JNTPURCHSID = #{jntpurchsid}
    </update>
    
    <!-- 공동구매모집 정보 삭제 -->
    <update id="deleteJntpurchs" parameterType="JntpurchsVo">
        UPDATE TB_THA_TCHAID_JNTPURCHS SET
            STTS_CD = '-1'
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE 
            JNTPURCHSID = #{jntpurchsid}
    </update>
    
    <!-- 공동구매모집 상품 일괄 삭제 -->
    <delete id="deleteGoods" parameterType="JntpurchsVo">
        /* JntpurchsDao.deleteGoods */
        DELETE 
            FROM TB_THA_TCHAID_JNTPURCHS_GOODS
        WHERE 
            JNTPURCHSID = #{jntpurchsid}
    </delete>
    
    <!-- 공동구매모집 수량별 가격 정보 일괄 삭제 -->
    <delete id="deleteAmt" parameterType="JntpurchsVo">
        /* JntpurchsDao.deleteGoods */
        DELETE 
            FROM TB_THA_TCHAID_JNTPURCHS_AMT
        WHERE 
            JNTPURCHSID = #{jntpurchsid}
    </delete>
    
    <!-- 공동구매신청 목록 조회 -->
    <select id="selectJntpurchsOrderList" parameterType="JntpurchsOrderVo" resultType="JntpurchsOrderVo">
        /* JntpurchsDao.selectJntpurchsOrderList */
        <include refid="PaginationMapper.header"/>
        SELECT
            B.JNTPURCHSID
            , D.JNTPURCHS_NM
            , E.ACNT
            , E.NM
            , IFNULL(F.INST_NM, "-") AS INST_NM
            , A.ORDERNO
            , GROUP_CONCAT(C.TCHAID_NM SEPARATOR ', ') AS TCHAID_NM
            , B.QNTY
            , A.STTS_CD
            , A.REG_DT
            , DATE_FORMAT(A.REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT_STR
        FROM
            TB_THA_TCHAID_JNTPURCHS_ORDER A
        LEFT OUTER JOIN
            TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS B ON (B.ORDERID = A.ORDERID)
        LEFT OUTER JOIN
            TB_THA_TCHAID C ON (C.TCHAIDID = B.TCHAIDID)
        LEFT OUTER JOIN
            TB_THA_TCHAID_JNTPURCHS D ON (D.JNTPURCHSID = B.JNTPURCHSID)
        INNER JOIN (
            SELECT
                USERID
                , NM
                , ACNT
            FROM
                TB_CMM_USER
        ) E ON (E.USERID = A.USERID)
        LEFT OUTER JOIN
            TB_CMM_INST F ON (F.INSTID = A.INSTID)
        WHERE 1 = 1
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'jntpurchsNm'">
            AND D.JNTPURCHS_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'jntpurchsNo'">
            AND D.JNTPURCHSNO LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchOrderKeyword != null and searchOrderKeyword != '' and searchOrderType == 'acnt'">
            AND E.ACNT LIKE CONCAT('%',#{searchOrderKeyword},'%')
        </if>
        <if test="searchOrderKeyword != null and searchOrderKeyword != '' and searchOrderType == 'nm'">
            AND E.NM LIKE CONCAT('%',#{searchOrderKeyword},'%')
        </if>
        <if test="searchOrderKeyword != null and searchOrderKeyword != '' and searchOrderType == 'instNm'">
            AND F.INST_NM LIKE CONCAT('%',#{searchOrderKeyword},'%')
        </if>
        <if test="searchSttsCd != null and searchSttsCd != ''">
            AND A.STTS_CD = #{searchSttsCd}
        </if>
        <if test="searchRegDt != null and searchRegDt !=''">
            AND DATE_FORMAT(A.REG_DT, '%Y-%m-%d') = #{searchRegDt}
        </if>
        GROUP BY
            A.ORDERID
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 공동구매신청 상세 정보 조회 -->
    <select id="selectJntpurchsOrderInfo" parameterType="JntpurchsOrderVo" resultType="JntpurchsOrderVo">
        /* JntpurchsDao.selectJntpurchsOrderInfo */
        SELECT
            A.ORDERID
            , D.JNTPURCHS_NM
            , D.JNTPURCHSNO
            , D.BGNG_DT
            , D.END_DT
            , (SELECT CD_NM FROM TB_CMM_CD WHERE CD = D.STTS_CD) AS JNTPURCHS_STTS_CD_NM
            , A.ORDERNO
            , A.STTS_CD
            , GROUP_CONCAT(CONCAT(C.TCHAID_NM, CONCAT('(TA-', LPAD(B.TCHAIDID, 3, '0'), ')')) SEPARATOR ', ') AS TCHAID_NM
            , B.QNTY
            , B.AMT
            , E.ACNT
            , CASE WHEN E.INSTID IS NOT NULL THEN 'C' ELSE 'U' END USER_TYPE
            , A.INST_NM
            , (SELECT CD_NM FROM TB_CMM_CD WHERE CD = F.INST_TYPE_CD) AS INST_TYPE_CD_NM
            , A.TELNO
            , A.EML
            , A.RECPTR
            , A.RECPTR_TELNO
            , A.RECPTR_EML
            , A.DLVY_ADDR
            , A.DLVY_ADDR_DTL
        FROM
            TB_THA_TCHAID_JNTPURCHS_ORDER A
        LEFT OUTER JOIN
            TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS B ON (B.ORDERID = A.ORDERID)
        LEFT OUTER JOIN
            TB_THA_TCHAID C ON (C.TCHAIDID = B.TCHAIDID)
        LEFT OUTER JOIN
            TB_THA_TCHAID_JNTPURCHS D ON (D.JNTPURCHSID = B.JNTPURCHSID)
        INNER JOIN (
            SELECT
                USERID
                , NM
                , ACNT
                , INSTID
            FROM
                TB_CMM_USER
        ) E ON (E.USERID = A.USERID)
        LEFT OUTER JOIN
            TB_CMM_INST F ON (F.INSTID = A.INSTID)
        WHERE
            B.JNTPURCHSID = #{jntpurchsid}
        GROUP BY
            B.JNTPURCHSID
    </select>
    
    <!-- 공동구매신청 정보 업데이트 -->
    <update id="updateJntpurchsOrder" parameterType="JntpurchsOrderVo">
        /* JntpurchsDao.updateJntpurchsOrder */
        UPDATE TB_THA_TCHAID_JNTPURCHS_ORDER SET
            STTS_CD = #{sttsCd}
            , RECPTR = #{recptr}
            , RECPTR_TELNO = #{recptrTelno}
            , RECPTR_EML = #{recptrEml}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE 
            ORDERID = #{orderid}
    </update>
    
</mapper>