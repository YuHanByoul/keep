<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : InfntAplyDaoImpl.xml
	Description : 참여신청관리 -> 교육신청관리
-->
<mapper namespace="com.kbrainc.plum.mng.prtpn.infntAply.model.InfntAplyDao">
    
    <!-- 교육신청 관리 게시글 목록 조회 -->
    <select id="selectInfntAplyList" parameterType="InfntAplyVo" resultType="InfntAplyVo">
        /* InfntAplyDao.selectInfntAplyList */
        SELECT 
          C.PRGRM_SCHDLID
        , SUBSTRING_INDEX(C.YM, '-', 1) EDU_YR  
        , SUBSTRING_INDEX(C.YM, '-', -1) EDU_MM
        , D.PRGRMID
        , E.PRGRM_NM
        , E.EDU_NOPE
        , C.CLSSRMID
        , L.CD_NM AS RCPT_MTHD_NM
        , F.CLSSRM_NM
        , COUNT(G.STTS_CD) APLY_CMPLT_CNT
        , COUNT(H.STTS_CD) WTNG_APLY_CNT
        , COUNT(I.STTS_CD) WTNG_APPRV_CNT
        , COUNT(J.STTS_CD) CNCL_APLY_CNT
        , COUNT(K.STTS_CD) DNL_APPRV_CNT
        FROM TB_EDU_INFNT_PRGRM_SCHDL C 
        LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TME_SCHDL B ON B.PRGRM_SCHDLID = C.PRGRM_SCHDLID 
        LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_SCHDL_PRGRM D ON D.PRGRM_SCHDLID = C.PRGRM_SCHDLID
        LEFT OUTER JOIN TB_EDU_INFNT_PRGRM E ON E.PRGRMID = D.PRGRMID
        LEFT OUTER JOIN TB_EDU_CLSSRM F ON F.CLSSRMID = C.CLSSRMID        
        LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_APLY G ON (G.STTS_CD = '180101' AND G.TME_SCHDLID = B.TME_SCHDLID)
        LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_APLY H ON (G.STTS_CD = '180102' AND H.TME_SCHDLID = B.TME_SCHDLID)
        LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_APLY I ON (G.STTS_CD = '180103' AND I.TME_SCHDLID = B.TME_SCHDLID)
        LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_APLY J ON (G.STTS_CD = '180104' AND J.TME_SCHDLID = B.TME_SCHDLID)
        LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_APLY K ON (G.STTS_CD = '180105' AND K.TME_SCHDLID = B.TME_SCHDLID)
        LEFT OUTER JOIN TB_CMM_CD L ON L.CD = E.RCPT_MTHD_CD
        WHERE
        1=1
            <if test="searchKeyword != null and searchKeyword != ''">
            AND E.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchEduYr != null and searchEduYr != ''">
            AND SUBSTRING_INDEX(C.YM, '-', 1) = #{searchEduYr}
            </if>
            <if test="searchClssrmId != null and searchClssrmId != ''">
            AND A.CLSSRMID = #{searchClssrmId}
            </if>
            <if test="searchClssrmMm != null and searchClssrmMm != ''">
            AND SUBSTRING_INDEX(C.YM, '-', 2) = #{searchClssrmMm}
            </if>
            <if test="searchRcptMthdCd != null and searchRcptMthdCd != ''">
            AND A.RCPT_MTHD_CD = #{searchRcptMthdCd}
            </if>
            <if test="searchSttsCd != null and searchSttsCd != ''">
            AND A.STTS_CD = #{searchSttsCd}
            </if>
        GROUP BY C.PRGRM_SCHDLID, C.YM, D.PRGRMID, E.PRGRM_NM, E.EDU_NOPE, C.CLSSRMID, L.CD_NM, F.CLSSRM_NM                                        
    </select>
    
    <!-- 교육신청 관리 게시글 등록 --> 
    <insert id="insertInfntAply" parameterType="InfntAplyVo" useGeneratedKeys="true" keyProperty="aplyId">
        /* InfntAplyDao.insertInfntAply */
        INSERT INTO TB_EDU_INFNT_PRGRM (
            CLSSRMID
            , EDU_YR
            , PRGRM_NM
            , EDU_NOPE
            , EDU_HR_MNT
            , RCPT_MTHD_CD
            , EDU_EXPLN
            , MTTRAT
            , EDU_INTRCN_FILEID
            , EDU_PHOTO_FILEID
            , MON_YN
            , TUES_YN
            , WED_YN
            , THUR_YN
            , FRI_YN
            , SAT_YN
            , SUN_YN
            , USE_YN
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        )VALUES(
            #{clssrmId}
            ,#{eduYr}
            ,#{aplyNm}
            ,#{eduNope}
            ,#{eduHrMnt}
            ,#{rcptMthdCd}
            ,#{eduExpln}
            ,#{mttrat}
            ,#{eduIntrcnFileid}
            ,#{eduPhotoFileid}
            ,#{monYn}
            ,#{tuesYn}
            ,#{wedYn}
            ,#{thurYn}
            ,#{friYn}
            ,#{satYn}
            ,#{sunYn}
            ,#{useYn}
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
        )
    </insert>
    
    <insert id="insertInfntAplyCopy" parameterType="InfntAplyVo" useGeneratedKeys="true" keyProperty="aplyId">
        /* InfntAplyDao.insertInfntAply */
        INSERT INTO TB_EDU_INFNT_PRGRM (
            CLSSRMID
            , EDU_YR
            , PRGRM_NM
            , EDU_NOPE
            , EDU_HR_MNT
            , RCPT_MTHD_CD
            , EDU_EXPLN
            , MTTRAT
            , EDU_INTRCN_FILEID
            , EDU_PHOTO_FILEID
            , MON_YN
            , TUES_YN
            , WED_YN
            , THUR_YN
            , FRI_YN
            , SAT_YN
            , SUN_YN
            , USE_YN
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        )
        SELECT
            CLSSRMID
            , DATE_FORMAT(NOW(),'%Y') 
            , CONCAT('(복사-', DATE_FORMAT(NOW(),'%Y'),')',PRGRM_NM)
            , EDU_NOPE
            , EDU_HR_MNT
            , RCPT_MTHD_CD
            , EDU_EXPLN
            , MTTRAT
            , EDU_INTRCN_FILEID
            , EDU_PHOTO_FILEID
            , MON_YN
            , TUES_YN
            , WED_YN
            , THUR_YN
            , FRI_YN
            , SAT_YN
            , SUN_YN
            , USE_YN
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
        FROM  TB_EDU_INFNT_PRGRM       
        WHERE PRGRMID = #{copyAplyId}
    </insert>
    
    <insert id="insertInfntAplyClsfMapngCopy" parameterType="InfntAplyVo" keyProperty="InfntAplyVo">
        /* InfntAplyDao.insertInfntAplyClsfMapngCopy */
        INSERT INTO TB_EDU_INFNT_PRGRM_CLSF_MAPNG (
            PRGRMID
            , CLSF_CD
            , REG_DT
            , RGTRID
        )
        SELECT
            #{aplyId}
            , CLSF_CD 
            ,NOW()
            ,#{user.userid}
        FROM  TB_EDU_INFNT_PRGRM_CLSF_MAPNG       
        WHERE PRGRMID = #{copyAplyId}
    </insert>

    <insert id="insertInfntAplyTrgtMapngCopy" parameterType="InfntAplyVo" keyProperty="InfntAplyVo">
        /* InfntAplyDao.insertInfntAplyTrgtMapngCopy */
        INSERT INTO TB_EDU_INFNT_PRGRM_TRGT_MAPNG (
            PRGRMID
            , TRGT_CD
            , REG_DT
            , RGTRID
        )
        SELECT
            #{aplyId}
            , TRGT_CD 
            ,NOW()
            ,#{user.userid}
        FROM  TB_EDU_INFNT_PRGRM_TRGT_MAPNG       
        WHERE PRGRMID = #{copyAplyId}
    </insert>
    
         
    <!-- 교육신청 분류 매핑 등록 --> 
    <insert id="insertInfntAplyClsfMapng" parameterType="InfntAplyVo" keyProperty="InfntAplyVo">
        /* InfntAplyDao.insertInfntAplyClsfMapng */
        INSERT INTO TB_EDU_INFNT_PRGRM_CLSF_MAPNG (
            PRGRMID
            , CLSF_CD
            , REG_DT
            , RGTRID
        )VALUES(
            #{aplyId}
            ,#{clsfCd}
            ,NOW()
            ,#{user.userid}
        )
    </insert>
    <!-- 교육신청 대상 매핑 등록 --> 
    <insert id="insertInfntAplyTrgtMapng" parameterType="InfntAplyVo" keyProperty="InfntAplyVo">
        /* InfntAplyDao.insertInfntAplyTrgtMapng */
        INSERT INTO TB_EDU_INFNT_PRGRM_TRGT_MAPNG (
            PRGRMID
            , TRGT_CD
            , REG_DT
            , RGTRID
        )VALUES(
            #{aplyId}
            ,#{trgtCd}
            ,NOW()
            ,#{user.userid}
        )
    </insert>
    <!-- 교육신청 회차 등록 --> 
    <insert id="insertInfntAplyTme" parameterType="InfntAplyVo" keyProperty="InfntAplyVo">
        /* InfntAplyDao.insertInfntAplyTme */
        <foreach collection="infntAplyVoList" item="item" index="index" separator=";">
        INSERT INTO TB_EDU_INFNT_PRGRM_TME (
            PRGRMID
            , TME_NM
            , MON_YN
            , TUES_YN
            , WED_YN
            , THUR_YN
            , FRI_YN
            , SAT_YN
            , SUN_YN
            , BGNG_TM
            , END_TM
            , ORDR
            , USE_YN
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        )VALUES(
            #{item.aplyId}
            ,#{item.tmeNm}
            ,#{item.tmeMonYn}
            ,#{item.tmeTuesYn}
            ,#{item.tmeWedYn}
            ,#{item.tmeThurYn}
            ,#{item.tmeFriYn}
            ,#{item.tmeSatYn}
            ,#{item.tmeSunYn}
            ,#{item.bgngTm}
            ,#{item.endTm}
            ,#{item.ordr}
            ,#{item.useYn}
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
        )            
        </foreach>            
    </insert>    
        
    <!-- 교육신청 관리 상세조회 -->
    <select id="selectInfntAplyInfo" parameterType="InfntAplyVo" resultType="InfntAplyVo"> 
        /* InfntAplyDao.selectInfntAplyInfo */
        SELECT 
            A.PRGRMID
            , A.CLSSRMID
            , B.CLSSRM_NM
            , B.EDU_TYPE_CD
            , A.EDU_YR
            , A.PRGRM_NM
            ,(SELECT GROUP_CONCAT(CLSF_CD SEPARATOR',') FROM TB_EDU_INFNT_PRGRM_CLSF_MAPNG  WHERE PRGRMID = #{aplyId} ) AS CLSF_CD
            , A.EDU_NOPE
            , A.EDU_HR_MNT
            , A.RCPT_MTHD_CD
            , A.EDU_EXPLN
            , A.MTTRAT                        
            , A.EDU_INTRCN_FILEID
            , C.FILEGRPID EDU_INTRCN_FILEGRPID
            , C.FILE_IDNTFC_KEY EDU_INTRCN_FILE_IDNTFC_KEY
            , C.ORGINL_FILE_NM EDU_INTRCN_ORGINL_FILE_NM
            , A.EDU_PHOTO_FILEID
            , D.FILEGRPID EDU_PHOTO_FILEGRPID
            , D.FILE_IDNTFC_KEY EDU_PHOTO_FILE_IDNTFC_KEY
            , D.ORGINL_FILE_NM EDU_PHOTO_ORGINL_FILE_NM
            , A.MON_YN
            , A.TUES_YN
            , A.WED_YN
            , A.THUR_YN
            , A.FRI_YN
            , A.SAT_YN
            , A.SUN_YN
            , A.USE_YN
            ,(SELECT GROUP_CONCAT(TRGT_CD SEPARATOR',') FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG  WHERE PRGRMID = #{aplyId} ) AS TRGT_CD
            , A.MDFCN_DT
            , A.MDFRID
            , A.REG_DT
            , A.RGTRID
            FROM TB_EDU_INFNT_PRGRM A
            LEFT OUTER JOIN TB_EDU_CLSSRM B ON A.CLSSRMID = B.CLSSRMID
            LEFT OUTER JOIN TB_CMM_FILE C ON A.EDU_INTRCN_FILEID = C.FILEID       
            LEFT OUTER JOIN TB_CMM_FILE D ON A.EDU_PHOTO_FILEID = D.FILEID
       WHERE A.PRGRMID = #{aplyId}
    </select>
    
    <!-- 교육신청관리 게시글 수정 -->
    <update id="updateInfntAply" parameterType="InfntAplyVo" keyProperty="InfntAplyVo">
        /* InfntAplyDao.updateInfntAply */
        UPDATE TB_EDU_INFNT_PRGRM SET
                CLSSRMID                        = #{clssrmId}
                , EDU_YR                        = #{eduYr}
                , PRGRM_NM                      = #{aplyNm}
                , EDU_NOPE                      = #{eduNope}
                , EDU_HR_MNT                    = #{eduHrMnt}
                , RCPT_MTHD_CD                  = #{rcptMthdCd}
                , EDU_EXPLN                     = #{eduExpln}
                , MTTRAT                        = #{mttrat}
                , EDU_INTRCN_FILEID             = #{eduIntrcnFileid}
                , EDU_PHOTO_FILEID              = #{eduPhotoFileid}
                , MON_YN                        = #{monYn}
                , TUES_YN                       = #{tuesYn}
                , WED_YN                        = #{wedYn}
                , THUR_YN                       = #{thurYn}
                , FRI_YN                        = #{friYn}
                , SAT_YN                        = #{satYn}
                , SUN_YN                        = #{sunYn}
                , USE_YN                        = #{useYn}
                , MDFCN_DT                      = NOW()
                , MDFRID                        = #{user.userid}
         WHERE PRGRMID                          = #{aplyId}
    </update>    
    
    <!-- 교육신청 분류 매핑 수정 -->
    <update id="updateInfntAplyClsfMapng" parameterType="InfntAplyVo" keyProperty="InfntAplyVo">
        /* InfntAplyDao.updateInfntAplyClsfMapng */
        UPDATE TB_EDU_INFNT_PRGRM_CLSF_MAPNG SET
                CLSF_CD                         = #{clsfCd}
                , REG_DT                        = NOW()
                , MDFRID                        = #{user.userid}
         WHERE PRGRMID                          = #{aplyId}
    </update>
    
    <!-- 교육신청 대상 매핑 수정 -->
    <update id="updateInfntAplyTrgtMapng" parameterType="InfntAplyVo" keyProperty="InfntAplyVo">
        /* InfntAplyDao.updateInfntAplyTrgtMapng */
        UPDATE TB_EDU_INFNT_PRGRM_TRGT_MAPNG SET
                TRGT_CD                         = #{trgtCd}
                , REG_DT                        = NOW()
                , MDFRID                        = #{user.userid}
         WHERE PRGRMID                          = #{aplyId}
    </update>
        
    <!-- 교육신청 회차 수정 -->
    <update id="updateInfntAplyTme" parameterType="InfntAplyVo" keyProperty="InfntAplyVo">
        /* InfntAplyDao.updateInfntAplyTme */
        UPDATE TB_EDU_INFNT_PRGRM_TME SET
                PRGRMID                         = #{aplyId}        
                , TME_NM                        = #{tmeNm}         
                , MON_YN                        = #{monYn}         
                , TUES_YN                       = #{tuesYn}        
                , WED_YN                        = #{wedYn}         
                , THUR_YN                       = #{thurYn}        
                , FRI_YN                        = #{friYn}         
                , SAT_YN                        = #{satYn}         
                , SUN_YN                        = #{sunYn}         
                , BGNG_TM                       = #{bgngTm}        
                , END_TM                        = #{endTm}         
                , ORDR                          = #{ordr}          
                , USE_YN                        = #{useYn}         
                , MDFCN_DT                      = NOW()            
                , MDFRID                        = #{user.userid}   
         WHERE TMEID                            = #{tmeId}
    </update>  
    
    <!-- 교육대상 저장 -->
    <insert id="insertTrgtCd" parameterType="InfntAplyVo" >
         /* InfntAplyDao.insertTrgtCd */
         INSERT INTO TB_EDU_INFNT_PRGRM_TRGT_MAPNG(
              PRGRMID
              ,TRGT_CD
              ,REG_DT
              ,RGTRID
         )VALUES
          <foreach item="item" collection="trgtCds"  separator=",">
           (
             #{aplyId}
             ,#{item}
             ,NOW()
             ,#{user.userid}
            )
          </foreach>
    </insert>
    
    <!-- 교육주제 저장 -->
    <insert id="insertClsfCd" parameterType="InfntAplyVo" >
         /* InfntAplyDao.insertClsfCd */
         INSERT INTO TB_EDU_INFNT_PRGRM_CLSF_MAPNG(
              PRGRMID
              ,CLSF_CD
              ,REG_DT
              ,RGTRID
         )VALUES
          <foreach item="item" collection="clsfCds"  separator=",">
           (
             #{aplyId}
             ,#{item}
             ,NOW()
             ,#{user.userid}
            )
          </foreach>
    </insert>     
    
    <!-- 교육대상 삭제 -->
    <insert id="deleteTrgtCd" parameterType="InfntAplyVo" >
         /* InfntAplyDao.deleteTrgtCd */
         DELETE FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG
         WHERE 1=1
           AND PRGRMID = #{aplyId}
    </insert>     
    
    <!-- 교육주제 삭제 -->
    <insert id="deleteClsfCd" parameterType="InfntAplyVo" >
         /* InfntAplyDao.deleteClsfCd */
         DELETE FROM TB_EDU_INFNT_PRGRM_CLSF_MAPNG
         WHERE 1=1
           AND PRGRMID = #{aplyId}
    </insert>     

    <!-- 교육신청 관리 회차 목록 조회 -->
    <select id="selectInfntAplyTmeList" parameterType="InfntAplyVo" resultType="InfntAplyVo">
        /* InfntAplyDao.selectInfntAplyTmeList */
        <include refid="PaginationMapper.header"/>
        SELECT 
        A.PRGRMID
        , A.TME_NM        
        , A.MON_YN
        , A.TUES_YN
        , A.WED_YN
        , A.THUR_YN
        , A.FRI_YN
        , A.SAT_YN
        , A.SUN_YN
        , A.BGNG_TM
        , A.END_TM
        , A.ORDR
        , A.USE_YN
        , A.MDFCN_DT
        , A.MDFRID
        , A.REG_DT
        , A.RGTRID        
        FROM TB_EDU_INFNT_PRGRM_TME A
        WHERE
        1=1
        <choose>
            <when test="aplyId != null">
                AND A.PRGRMID = #{aplyId}
            </when>
            <otherwise>            
            </otherwise>
        </choose>        
        <include refid="PaginationMapper.footer"/>
    </select>    
</mapper>