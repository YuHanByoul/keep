<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : ClclnDsctnDaoImpl.xml
    Description : 체험환경교육 지원사업 -> 정산관리 -> 정산내역관리
-->
<mapper namespace="com.kbrainc.plum.mng.clclnMng.clclnDsctn.model.ClclnDsctnDao">
    
    <!-- 정산내역관리 목록 조회 -->
    <select id="selectClclnDsctnList" parameterType="ClclnDsctnVo" resultType="ClclnDsctnVo">
        /* ClclnDsctnDao.selectClclnDsctnList */
        <include refid="PaginationMapper.header"/>
        WITH t1 AS (
            SELECT Z.PCNTSTID, COUNT(DISTINCT X.APLYID) APLY_CNT FROM TB_SPB_EXCUT_DSCTN Y 
            LEFT OUTER JOIN TB_SPB_APLY X ON X.APLYID = Y.APLYID 
            LEFT OUTER JOIN TB_SPB_PCNTST Z ON Z.PCNTSTID = X.PCNTSTID 
            WHERE 1=1 
            GROUP BY X.PCNTSTID 
        ),   t2 AS (
            SELECT Z.PCNTSTID, COUNT(X.APLYID) APLY_CNT FROM TB_SPB_PCNTST Z 
            LEFT OUTER JOIN TB_SPB_APLY X ON X.PCNTSTID = Z.PCNTSTID 
            WHERE 1=1
            GROUP BY X.PCNTSTID
        )         
        SELECT 
          A.DSCTNID
        , C.FLD_CD
        , D.CD_NM FLD_NM  
        , C.PCNTSTID
        , C.PCNTST_NM
        , CASE WHEN NOW() BETWEEN C.EXCCLC_REPORT_BGNG_DT AND C.EXCCLC_REPORT_END_DT THEN '제출중' 
               WHEN NOW() <![CDATA[<]]> C.EXCCLC_REPORT_BGNG_DT THEN '제출전'
               ELSE '마감' END EXCCLC_STTS_DESC
        , CONCAT(C.EXCCLC_REPORT_BGNG_DT, ' ~ ', C.EXCCLC_REPORT_END_DT) EXCCLC_REPORT_DATE_DESC
        , t2.APLY_CNT SLCTN_CNT
        , CONCAT(t1.APLY_CNT,'/',t2.APLY_CNT) EXCCLC_CNT_DESC
        , B.REG_DT
        FROM TB_SPB_PCNTST C
        LEFT OUTER JOIN TB_SPB_APLY B ON B.PCNTSTID = C.PCNTSTID
        LEFT OUTER JOIN TB_CMM_CD D ON D.CD = C.FLD_CD
        LEFT OUTER JOIN TB_SPB_APLY E ON  E.APLYID = B.APLYID AND E.SLCTN_STTS_CD = '193102'
        LEFT OUTER JOIN TB_SPB_EXCUT_DSCTN A ON A.APLYID = B.APLYID
        LEFT OUTER JOIN t1 ON t1.PCNTSTID = C.PCNTSTID
        LEFT OUTER JOIN t2 ON t2.PCNTSTID = C.PCNTSTID
        WHERE E.SLCTN_STTS_CD = '193102'
        <if test="searchKeyword != null and searchKeyword != ''">
        AND E.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchFldCd != null and searchFldCd != ''">
        AND C.FLD_CD = #{searchFldCd}
        </if>
        <if test="searchPcntstNm != null and searchPcntstNm != ''">
        AND C.PCNTST_NM = #{searchPcntstNm}
        </if>
        <if test="searchStartExcclcReportDt != null and searchStartExcclcReportDt != ''">
        AND #{searchStartExcclcReportDt} BETWEEN C.EXCCLC_REPORT_BGNG_DT AND C.EXCCLC_REPORT_END_DT
        </if>
        <if test="searchEndExcclcReportDt != null and searchEndExcclcReportDt != ''">
        AND #{searchEndExcclcReportDt} BETWEEN C.EXCCLC_REPORT_BGNG_DT AND C.EXCCLC_REPORT_END_DT
        </if>
        <if test="searchSttsCd != null and searchSttsCd != '' and searchSttsCd == '200101'">
        AND NOW() <![CDATA[<]]> C.EXCCLC_REPORT_BGNG_DT
        </if>
        <if test="searchSttsCd != null and searchSttsCd != '' and searchSttsCd == '200102'">
        AND NOW() BETWEEN C.EXCCLC_REPORT_BGNG_DT AND C.EXCCLC_REPORT_END_DT
        </if>
        GROUP BY C.PCNTSTID            
        <include refid="PaginationMapper.footer"/>        
    </select>
    
    <!-- 정산내역관리 상세목록 조회 -->
    <select id="selectClclnDsctnDetailList" parameterType="ClclnDsctnVo" resultType="ClclnDsctnVo">
        /* ClclnDsctnDao.selectClclnDsctnDetailList */
        <include refid="PaginationMapper.header"/>
        WITH t1 AS (
            SELECT APLYID, SUM(COALESCE(AMT,0)) TOT_AMT FROM TB_SPB_EXCUT_DSCTN WHERE 1=1 AND SE_CD = '210102' GROUP BY APLYID
        ),   t2 AS (
            SELECT APLYID, SUM(COALESCE(AMT,0)) INT_AMT FROM TB_SPB_EXCUT_DSCTN WHERE 1=1 AND SE_CD = '210101' AND UTZTN_SECD = '214101' GROUP BY APLYID
        ),   t3 AS (
            SELECT APLYID, SUM(COALESCE(AMT,0)) CASHB_AMT FROM TB_SPB_EXCUT_DSCTN WHERE 1=1 AND SE_CD = '210101' AND UTZTN_SECD = '214102' GROUP BY APLYID
        ),   t4 AS (
            SELECT APLYID, SUM(COALESCE(AMT,0)) ETC_DPST_AMT FROM TB_SPB_EXCUT_DSCTN WHERE 1=1 AND SE_CD = '210101' AND UTZTN_SECD = '214103' GROUP BY APLYID
        ) 
        SELECT 
            B.PCNTSTID
          , E.RCPTNO  
          , IFNULL(B.EXCCLC_STTS_CD,'203101') SBMSN_STTS_CD
          , B.INST_NM          
          , B.APLCNT_NM
          , B.PRGRM_NM
          , A.ATCH_FILEGRPID
          , COALESCE(t1.TOT_AMT,0) TOT_AMT
          , COALESCE(t2.INT_AMT,0) INT_AMT
          , COALESCE(t3.CASHB_AMT,0) CASHB_AMT
          , COALESCE(t4.ETC_DPST_AMT,0) ETC_DPST_AMT
          , COALESCE(E.TOT_AMT,0) - (COALESCE(t1.TOT_AMT,0) - COALESCE(t4.ETC_DPST_AMT,0)) BLNC_AMT
          , CASE WHEN A.ATCH_FILEGRPID IS NULL THEN '미첨부' ELSE '첨부' END ATCH_FILE_YN 
          , B.REG_DT
          , B.MDFCN_DT
          , B.APLYID  
        FROM TB_SPB_APLY B 
        LEFT OUTER JOIN (SELECT APLYID, ATCH_FILEGRPID FROM TB_SPB_EXCUT_DSCTN GROUP BY APLYID) A ON A.APLYID = B.APLYID
        LEFT OUTER JOIN TB_SPB_PCNTST C ON C.PCNTSTID = B.PCNTSTID
        LEFT OUTER JOIN (SELECT PCNTSTID, DELVRYID FROM TB_SPB_DELVRY GROUP BY PCNTSTID) D ON D.PCNTSTID = C.PCNTSTID
        LEFT OUTER JOIN (SELECT APLYID, DELVRYID, DELVRY_APLYID, RCPTNO, SUM(COALESCE(TOT_AMT,0)) TOT_AMT FROM TB_SPB_DELVRY_APLY GROUP BY APLYID, DELVRYID) E ON E.APLYID = A.APLYID AND E.DELVRYID = D.DELVRYID
        LEFT OUTER JOIN t1 ON t1.APLYID = A.APLYID
        LEFT OUTER JOIN t2 ON t2.APLYID = A.APLYID
        LEFT OUTER JOIN t3 ON t3.APLYID = A.APLYID
        LEFT OUTER JOIN t4 ON t4.APLYID = A.APLYID
        WHERE B.PCNTSTID = #{pcntstid}
            <if test="searchSbmsnSttsCd != null and searchSbmsnSttsCd != ''">
            AND B.EXCCLC_STTS_CD = #{searchSbmsnSttsCd}
            </if>
            <!-- 키워드.전체 -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == ''">
                AND (B.INST_NM LIKE CONCAT('%',#{searchKeyword},'%') OR B.USERID LIKE CONCAT('%',#{searchKeyword},'%') OR B.APLCNT_NM LIKE CONCAT('%',#{searchKeyword},'%'))
            </if>
            <!-- 키워드.기관명 -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchInstNm'">
                AND B.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
            </if>        
            <!-- 키워드.신청자ID -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchUserId'">
                AND B.USERID LIKE CONCAT('%',#{searchKeyword},'%')
            </if>        
            <!-- 키워드.신청자명 -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchUserNm'">
                AND B.APLCNT_NM LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchAttchYn != null and searchAttchYn != ''">
                <choose>
                    <when test="searchAttchYn == 'Y'">
                        AND A.ATCH_FILEGRPID IS NOT NULL
                    </when>
                    <otherwise>
                        AND A.ATCH_FILEGRPID IS NULL
                    </otherwise>
                </choose>
            </if>
            -- GROUP BY E.RCPTNO
        <include refid="PaginationMapper.footer"/>        
    </select>    

    <!-- 정산내역관리 상세목록 정보 조회 -->
    <select id="selectClclnDsctnDetailInfo" parameterType="ClclnDsctnVo" resultType="ClclnDsctnVo">
        /* ClclnDsctnDao.selectClclnDsctnDetailInfo */
        WITH t1 AS (
            SELECT APLYID, SUM(COALESCE(AMT,0)) TOT_AMT FROM TB_SPB_EXCUT_DSCTN WHERE 1=1 AND SE_CD = '210102' GROUP BY APLYID
        ),   t2 AS (
            SELECT APLYID, SUM(COALESCE(AMT,0)) INT_AMT FROM TB_SPB_EXCUT_DSCTN WHERE 1=1 AND SE_CD = '210101' AND UTZTN_SECD = '214101' GROUP BY APLYID
        ),   t3 AS (
            SELECT APLYID, SUM(COALESCE(AMT,0)) CASHB_AMT FROM TB_SPB_EXCUT_DSCTN WHERE 1=1 AND SE_CD = '210101' AND UTZTN_SECD = '214102' GROUP BY APLYID
        ),   t4 AS (
            SELECT APLYID, SUM(COALESCE(AMT,0)) ETC_DPST_AMT FROM TB_SPB_EXCUT_DSCTN WHERE 1=1 AND SE_CD = '210101' AND UTZTN_SECD = '214103' GROUP BY APLYID
        ) 
        SELECT 
            E.RCPTNO  
          , B.PCNTSTID  
          , IFNULL(B.EXCCLC_STTS_CD,'203101') SBMSN_STTS_CD
          , B.INST_NM          
          , B.APLCNT_NM
          , B.PRGRM_NM
          , E.TOT_AMT BGT_AMT
          , COALESCE(t1.TOT_AMT,0) - COALESCE(t4.ETC_DPST_AMT, 0) AS EXPND_AMT
          , COALESCE(E.TOT_AMT,0) - (COALESCE(t1.TOT_AMT,0) - COALESCE(t4.ETC_DPST_AMT,0)) AS IMPL_BLNC_AMT
          , COALESCE(t2.INT_AMT,0) + COALESCE(t3.CASHB_AMT,0) AS INT_CASHB_AMT 
          , COALESCE(E.TOT_AMT,0) - (COALESCE(t1.TOT_AMT,0) - COALESCE(t4.ETC_DPST_AMT,0)) + (COALESCE(t2.INT_AMT,0) + COALESCE(t3.CASHB_AMT,0)) AS IMPL_BLNC_INT_AMT
          , A.MDFCN_DT SBMSN_DT
          , J.CD_NM AS SBMSN_STTS_NM
          , A.APLYID  
          , A.ATCH_FILEGRPID ATCH_FILEID
          , K.FILEGRPID ATCH_FILEGRPID
          , K.FILE_IDNTFC_KEY ATCH_FILE_IDNTFC_KEY
          , K.ORGINL_FILE_NM ATCH_ORGINL_FILE_NM
        FROM TB_SPB_EXCUT_DSCTN A 
        LEFT OUTER JOIN TB_SPB_APLY B ON B.APLYID = A.APLYID
        LEFT OUTER JOIN TB_SPB_PCNTST C ON C.PCNTSTID = B.PCNTSTID
        LEFT OUTER JOIN TB_SPB_DELVRY D ON D.PCNTSTID = C.PCNTSTID        
        LEFT OUTER JOIN TB_SPB_DELVRY_APLY E ON E.APLYID = A.APLYID AND E.DELVRYID = D.DELVRYID 
        LEFT OUTER JOIN TB_SPB_DELVRY_APLY_COMPUT F ON F.DELVRY_APLYID = E.DELVRY_APLYID 
        LEFT OUTER JOIN TB_SPB_REQRE_BGT G ON G.APLYID = A.APLYID
        LEFT OUTER JOIN t1 ON t1.APLYID = A.APLYID
        LEFT OUTER JOIN t2 ON t2.APLYID = A.APLYID
        LEFT OUTER JOIN t3 ON t3.APLYID = A.APLYID
        LEFT OUTER JOIN t4 ON t4.APLYID = A.APLYID
        LEFT OUTER JOIN TB_CMM_CD J ON J.CD = IFNULL(B.EXCCLC_STTS_CD,'203101')
        LEFT OUTER JOIN TB_CMM_FILE K ON A.ATCH_FILEGRPID = K.FILEID
        WHERE B.PCNTSTID = #{pcntstid}
         AND  A.APLYID = #{aplyid}
         <choose>
             <when test="rcptno != 'null' and rcptno != ''">
                 AND  E.RCPTNO = #{rcptno}
             </when>
             <otherwise>
                 AND  E.RCPTNO IS NULL
             </otherwise>
         </choose>
        GROUP BY E.RCPTNO
    </select>  
    
    <!-- 정산내역관리 상세정보 집행내역 개요서 리스트 조회 -->
    <select id="selectClclnDsctnDetailOutlList" parameterType="ClclnDsctnVo" resultType="ClclnDsctnVo">
        /* ClclnDsctnDao.selectClclnDsctnDetailOutlList */
        WITH t1 AS (
            SELECT APLYID, ARTCL_CD, SUM(COALESCE(AMT,0)) AS EXPND_AMT FROM TB_SPB_EXCUT_DSCTN WHERE APLYID = #{aplyid} GROUP BY ARTCL_CD
        ),   t2 AS (
            SELECT APLYID, ARTCL_CD, COUNT(ARTCL_CD) AS IMPL_CNT FROM TB_SPB_EXCUT_DSCTN WHERE APLYID = #{aplyid} GROUP BY ARTCL_CD
        ),   t3 AS (
        SELECT 
             D.UPPR_CD
            ,(SELECT X.CD_NM FROM TB_CMM_CD X WHERE X.CD = D.UPPR_CD) AS UPPR_NM
            , A.EXPITM_CD
            , D.CD_NM EXPITM_NM
            , COALESCE(A.AMT,0) BGT_AMT
            , COALESCE(t1.EXPND_AMT,0) EXPND_AMT
            , t2.IMPL_CNT
            , COALESCE(A.AMT,0) - COALESCE(t1.EXPND_AMT,0) AS IMPL_BLNC_AMT
            , ROUND((COALESCE(t1.EXPND_AMT,0) / COALESCE(A.AMT,0)) * 100) IMPL_RT   
        FROM (
            SELECT COMPUTID, EXPITM_CD, AMT, CN, ORDR, DELVRY_APLYID
              FROM TB_SPB_DELVRY_APLY_COMPUT
            ) A 
        LEFT OUTER JOIN ( 
            SELECT DELVRY_APLYID, APLYID, DELVRYID, TOT_AMT
              FROM TB_SPB_DELVRY_APLY
            ) B ON B.DELVRY_APLYID = A.DELVRY_APLYID 
        LEFT OUTER JOIN TB_SPB_EXCUT_DSCTN C ON C.APLYID = B.APLYID
        LEFT OUTER JOIN TB_CMM_CD D ON D.CD = A.EXPITM_CD
        LEFT OUTER JOIN t1 ON t1.APLYID = B.APLYID AND t1.ARTCL_CD = A.EXPITM_CD
        LEFT OUTER JOIN t2 ON t2.APLYID = B.APLYID AND t2.ARTCL_CD = A.EXPITM_CD
        WHERE B.APLYID = #{aplyid}       
        GROUP BY B.APLYID, A.EXPITM_CD ORDER BY A.EXPITM_CD
        )
        SELECT 
              t3.UPPR_CD
            , t3.UPPR_NM
            , t3.EXPITM_CD
            , t3.EXPITM_NM
            , COALESCE(t3.BGT_AMT,0) BGT_AMT
            , COALESCE(t3.EXPND_AMT,0) EXPND_AMT
            , COALESCE(t3.IMPL_CNT,0) IMPL_CNT
            , COALESCE(t3.IMPL_BLNC_AMT,0) IMPL_BLNC_AMT
            , COALESCE(t3.IMPL_RT,0) IMPL_RT
            , COALESCE(t4.BGT_AMT_RP,0) BGT_AMT_RP
            , COALESCE(t4.EXPND_AMT_RP,0) EXPND_AMT_RP
            , COALESCE(t4.IMPL_CNT_RP,0) IMPL_CNT_RP
            , COALESCE(t4.IMPL_BLNC_AMT_RP,0) IMPL_BLNC_AMT_RP
            , COALESCE(t4.IMPL_RT_RP,0) IMPL_RT_RP
        FROM t3
        LEFT OUTER JOIN (SELECT UPPR_CD
                              , SUM(COALESCE(BGT_AMT,0)) BGT_AMT_RP 
                              , SUM(COALESCE(EXPND_AMT,0)) EXPND_AMT_RP
                              , SUM(COALESCE(IMPL_CNT,0)) IMPL_CNT_RP
                              , SUM(COALESCE(IMPL_BLNC_AMT,0)) IMPL_BLNC_AMT_RP
                              , ROUND((SUM(COALESCE(EXPND_AMT,0)) / SUM(COALESCE(BGT_AMT,0))) * 100) IMPL_RT_RP
                           FROM t3 
                           GROUP BY UPPR_CD WITH ROLLUP) t4 ON t4.UPPR_CD = t3.UPPR_CD         
    </select>          

    <!-- 정산내역관리 상세정보 집행상세내역 개요서 리스트 조회 -->
    <select id="selectClclnDsctnDetailOutlDtlList" parameterType="ClclnDsctnVo" resultType="ClclnDsctnVo">
        /* ClclnDsctnDao.selectClclnDsctnDetailOutlDtlList */
        SELECT 
              A.DSCTNID
            , A.SE_CD -- 입금, 출금
            , B.CD_NM SE_NM
            , A.UTZTN_SECD -- 이자,캐쉬백,기타입금액
            , C.CD_NM UTZTN_SENM -- 이자,캐쉬백,기타입금액
            , A.DPST_SECD -- 입금대기,입금취소,입금완료
            , A.DE -- 일자
            , COALESCE(A.AMT,0) AMT
            , (SELECT X.CD_NM FROM TB_CMM_CD X WHERE X.CD = E.UPPR_CD) AS UPPR_NM
            , A.ARTCL_CD -- 비목코드
            , A.ARTCL_NM -- 세부항목
            , A.USE_PRPS -- 사용목적
            , A.DSCTN -- 내역
            , A.PRUF_KND_CD -- 증빙_종류_코드
            , A.ATCH_FILEGRPID -- 첨부_파일그룹아이디
            , A.INSTID -- 기관아이디
            , A.USERID -- 사용자아이디
            , A.MDFCN_DT
            , A.MDFRID
            , A.REG_DT
            , A.RGTRID
            , A.APLYID  -- 신청ID 
        FROM TB_SPB_EXCUT_DSCTN A
        LEFT OUTER JOIN TB_CMM_CD B ON B.CD = A.SE_CD
        LEFT OUTER JOIN TB_CMM_CD C ON C.CD = A.UTZTN_SECD
        LEFT OUTER JOIN TB_CMM_CD D ON D.CD = A.DPST_SECD
        LEFT OUTER JOIN TB_CMM_CD E ON E.CD = A.ARTCL_CD
        WHERE A.APLYID = #{aplyid}       
    </select>  
    
    <!-- 정산내역관리 상세목록 제출상태 수정 -->
    <update id="updateClclnDsctnComplete" parameterType="ClclnDsctnVo" keyProperty="ClclnDsctnVo">
        /* ClclnDsctnDao.updateClclnDsctnComplete */
        UPDATE TB_SPB_APLY SET
                  EXCCLC_STTS_CD                = '203102'
                , MDFCN_DT                      = NOW()
                , MDFRID                        = #{user.userid}
         WHERE APLYID                           = #{completeAplyId}
    </update>        

    <!-- 정산내역관리 보완요청 목록 조회 -->
    <select id="selectExcclcSplmntList" parameterType="SupplementVo" resultType="SupplementVo">
        /* ClclnDsctnDao.selectSplmntList */
        <include refid="PaginationMapper.header"/>
        SELECT
            SPLMNTID
            , APLYID
            , DMND_CN
            , RQSTRID
            , ANS_CN
            , ANSWRRID
            , DMND_DT
            , ANS_DT
            , ANS_STTS_CD
            , B.CD_NM AS ANS_STTS_NM
            , A.MDFCN_DT
            , A.MDFRID
            , A.REG_DT
            , A.RGTRID
        FROM
            TB_SPB_EXCCLC_SPLMNT A
            LEFT OUTER JOIN TB_CMM_CD B ON A.ANS_STTS_CD = B.CD
        WHERE APLYID = #{aplyid}
        <if test="splmntid != null and splmntid != ''">
        AND SPLMNTID = #{splmntid}
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 정산내역관리 보완요청 -->
    <insert id="insertExcclcSplmnt" parameterType="SupplementVo" useGeneratedKeys="true" keyProperty="splmntid">
        /* ClclnDsctnDao.insertSplmnt */
        INSERT INTO TB_SPB_EXCCLC_SPLMNT (
            SPLMNTID
            , APLYID
            , DMND_CN
            , RQSTRID
            , DMND_DT
            , ANS_STTS_CD
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{splmntid}
            , #{aplyid}
            , #{dmndCn}
            , #{user.userid}
            , NOW()
            , #{ansSttsCd}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>

    <!-- 정산내역관리 보완요청 수정 -->
    <update id="updateExcclcSplmnt" parameterType="SupplementVo">
        /* ClclnDsctnDao.updateSplmnt */
        UPDATE TB_SPB_EXCCLC_SPLMNT SET
            ANS_CN = #{ansCn}
            , ANS_STTS_CD = #{ansSttsCd}
            , ANS_DT = NOW()
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE SPLMNTID = #{splmntid}
    </update>            
</mapper>