<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : EduInstDaoImpl.xml
	Description : 사회환경교육기관 지정 > 신청/결과관리
-->
<mapper namespace="com.kbrainc.plum.mng.eduInst.model.EduInstDao">
    
    <!-- 신청/결과관리 목록 검색 조건 -->
    <sql id="eduInstSearchCondition">
        <if test="searchCtprvn != null and searchCtprvn != ''">
        AND A.CTPRVN_CD = #{searchCtprvn}
        </if>
        <!-- 키워드.프로그램명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchRcptno'">
        AND A.RCPTNO LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 키워드.기관명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchInstNm'">
        AND A.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchSttsCd != null and searchSttsCd != ''">
        AND A.STTS_CD = #{searchSttsCd}
        </if>
        <if test="searchRegDt != null and searchRegDt !=''">
        AND DATE_FORMAT(A.REG_DT, '%Y-%m-%d') = #{searchRegDt}
        </if>
    </sql>
    
    <!-- 신청/결과관리 목록 조회 -->
    <select id="selectInstDsgnList" parameterType="EduInstVo" resultType="EduInstVo">
        /* EduInstDao.selectInstDsgnList */
        <if test="excelYn != 'Y'.toString()">
            <include refid="PaginationMapper.header"/>
        </if>
        SELECT A.APLYID
            , A.RCPTNO
            , A.INSTID
            , A.APLCNTID
            , A.APLCNT_NM
            , C.INST_TYPE_CD
            , (SELECT CD_NM FROM TB_CMM_CD WHERE CD = C.INST_TYPE_CD) AS INST_TYPE_NM
            , A.INST_NM
            , A.CTPRVN_CD
            , ADDR.CTPRVN_NM
            , A.STTS_CD
            , (SELECT CD_NM FROM TB_CMM_CD WHERE CD = A.STTS_CD) AS STTS_NM
            , B.SPLMNTID
            , B.ANS_STTS_CD
            , (SELECT CD_NM FROM TB_CMM_CD WHERE CD = B.ANS_STTS_CD) AS ANS_STTS_NM
            , A.REG_DT
            , A.RGTRID
        FROM TB_SEE_ENV_EDU_INST A
        LEFT OUTER JOIN TB_SEE_APLY_SPLMNT B ON A.APLYID = B.APLYID
        LEFT OUTER JOIN TB_CMM_INST C ON A.INSTID =C.INSTID
        LEFT OUTER JOIN TB_CMM_ADDR_CTPRVN ADDR ON A.CTPRVN_CD = ADDR.CTPRVN_CD
        WHERE 1=1
        <include refid="eduInstSearchCondition"/>
        <if test="excelYn != 'Y'.toString()">
            <include refid="PaginationMapper.footer"/>
        </if>
    </select>
    
   <select id="selectInstDsgnInfo" parameterType="EduInstVo" resultType="EduInstVo">
        /* EduInstDao.selectInstDsgnInfo*/
         SELECT
            A.APLYID             /*신청아이디*/
          , A.RCPTNO             /*접수번호*/
          , A.INSTID             /*기관아이디*/
          , A.APLCNTID           /*신청자아이디*/
          , A.APLCNT_NM          /*신청자_이름*/
          , A.APLCNT_EML         /*신청자_이메일*/
          , A.APLCNT_MOBLPHON    /*신청자_휴대폰*/
          , A.INST_NM            /*기관_이름*/
          , A.INST_EML           /*기관_이메일*/
          , A.INST_CNTCT         /*기관_연락처*/
          , A.CTPRVN_CD          /*시도_코드*/
          , ADDR.CTPRVN_NM       /*시도_명*/
          , A.RPRSV_BRDT         /*대표자_생년월일*/
          , B.RPRSV_NM
          , A.ATCH_FILEGRPID FILEGRPID /*첨부_파일그룹아이디*/
          , A.DSGNNO             /*지정번호*/
          , A.DSGN_DE            /*지정_일자*/
          , A.AUTZRID            /*승인자아이디*/
          , A.ISSU_DE            /*발급_일자*/
          , A.ISGN_DE            /*재발급_일자*/
          , A.STTS_CD            /*상태_코드*/
          , A.MDFCN_DT           /*수정_일시*/
          , A.MDFRID             /*수정자아이디*/
          , A.REG_DT             /*등록_일시*/
          , A.RGTRID             /*등록자아이디*/
          , B.RGN_CD
          , B.INST_TYPE_CD
          , (SELECT CD_NM FROM TB_CMM_CD WHERE CD = B.INST_TYPE_CD) AS INST_TYPE_NM
          , B.ADDR INST_ADDR
          , B.ADDR_DTL INST_ADDR_DTL
          , B.BRNO
        FROM TB_SEE_ENV_EDU_INST A
        LEFT OUTER JOIN TB_CMM_INST B ON A.INSTID =B.INSTID
        LEFT OUTER JOIN TB_CMM_ADDR_CTPRVN ADDR ON A.CTPRVN_CD = ADDR.CTPRVN_CD
        WHERE A.APLYID = #{aplyid}
    </select>    
    <!-- 지정 내역 등록 -->
    <insert id="insertDsgnDsctnSttsCd" parameterType="EduInstVo">
        /* EduInstDao.insertDsgnDsctnSttsCd */
        INSERT INTO TB_SEE_DSGN_DSCTN (
            APLYID
            , STTS_CD
            , DSGNNO
            <if test="dsctnSttsCd == '248104'">
            , DSGN_DE
            </if>
            <if test="dsctnSttsCd == '248105'">
            , DSGN_CNCL_DE
            </if>
            , PRCRID
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        )
        SELECT 
            A.APLYID
            ,#{dsctnSttsCd}
            ,A.DSGNNO
            <if test="dsctnSttsCd == '248104'">
            ,DATE_FORMAT(NOW(), '%Y-%m-%d')
            </if>
            <if test="dsctnSttsCd == '248105'">
            ,DATE_FORMAT(NOW(), '%Y-%m-%d')
            </if>
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
          FROM TB_SEE_ENV_EDU_INST A
         WHERE A.APLYID = #{aplyid} 
    </insert>

    <!-- 상태 코드 변경 -->
    <update id="updateSttsCd" parameterType="EduInstVo">
        /* EduInstDao.updateSttsCd */
        UPDATE TB_SEE_ENV_EDU_INST SET
        STTS_CD = #{sttsCd}
        WHERE APLYID = #{aplyid} 
    </update>
        
    <!-- 지정내역 조회. -->
    <select id="selectDsgnDsctn" parameterType="EduInstVo" resultType="EduInstVo">
        SELECT
            DSCTNID
            , APLYID
            , STTS_CD
            , DSGNNO
            , DSGN_DE
            , DSGN_CNCL_DE
            , PRCRID
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        FROM
            TB_SEE_DSGN_DSCTN
        WHERE
            APLYID = #{aplyid}
    </select>
    
    <!-- 지정번호 조회 -->
    <select id="selectDsgnNo" parameterType="EduInstVo" resultType="EduInstVo">
       SELECT
            CASE WHEN COUNT(A.APLYID) = 0
                 THEN CONCAT(DATE_FORMAT(NOW(), '%Y'), '-', (SELECT CTPRVN_CD FROM TB_SEE_ENV_EDU_INST WHERE APLYID = ${aplyid}), '-', '001')
                 ELSE CONCAT(DATE_FORMAT(NOW(), '%Y'), '-', (SELECT CTPRVN_CD FROM TB_SEE_ENV_EDU_INST WHERE APLYID = ${aplyid}), '-' ,LPAD(COUNT(A.APLYID)+1,3,0))
            END    AS DSGN_NO
          , CASE WHEN DSGN_DE IS NULL THEN DATE_FORMAT(NOW(), '%Y-%m-%d') ELSE DSGN_DE END DSGN_DE
          , ${aplyid} AS APLYID
          , A.DSCTNID 
          , A.DSGN_CNCL_DE 
        FROM TB_SEE_DSGN_DSCTN A
        WHERE A.APLYID = ${aplyid}
    </select>     
    
    <!-- 지정내역 상세 조회 -->
    <select id="selectDsgnDsctnInfo" parameterType="EduInstVo" resultType="EduInstVo">
        SELECT
            DSCTNID
            , APLYID
            , STTS_CD
            , DSGNNO
            , CASE WHEN DSGN_DE IS NULL THEN DATE_FORMAT(NOW(), '%Y-%m-%d') ELSE DSGN_DE END DSGN_DE
            , DSGN_CNCL_DE
            , PRCRID
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        FROM
            TB_SEE_DSGN_DSCTN
        WHERE 1=1
        AND APLYID = #{aplyid}
        AND DSCTNID = #{dsctnid}
    </select>

    <!-- 지정번호 조회 -->
    <select id="selectDsgnNoDupChk" parameterType="EduInstVo" resultType="int">
        SELECT
            COUNT(1) AS cnt
        FROM
            TB_SEE_DSGN_DSCTN
        WHERE
            APLYID = #{aplyid}
        AND
            DSGNNO = #{dsgnNo}
    </select>
        
    <!-- 지정 내역 저장 -->
    <insert id="insertDsgnDsctn" parameterType="EduInstVo" >
        /* EduInstDao.insertDsgnDsctn*/
        INSERT
        INTO TB_SEE_DSGN_DSCTN
        (
            APLYID
          , STTS_CD
          , DSGNNO
          , DSGN_DE
          , PRCRID
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES
        (
            #{aplyid}
          , #{sttsCd}
          , #{dsgnNo}
          , #{dsgnDe}
          , #{user.userid}
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        );
    </insert>

    <!-- 지정정보 변경 -->
    <update id="updateDsgnDsctn" parameterType="EduInstVo" >
    /* EduInstDao.updateDsgnDsctn*/
        UPDATE
            TB_SEE_DSGN_DSCTN
        SET
            DSGN_NO           = #{dsgnNo}
          , DSGN_DE           = #{dsgnDe}
          , STTS_CD           = #{sttsCd}
          , PRCRID            = #{user.userid}
          , MDFCN_DT          = NOW()
          , MDFRID            = #{user.userid}
        WHERE
            APLYID = #{aplyid}
        AND DSCTNID = #{dsctnid}
    </update>

    <!-- 신청정보 탭 저장 -->
    <update id="updateInstDsgnInfo" parameterType="EduInstVo">
        /* EduInstDao.updateInstDsgnInfo */
        UPDATE
            TB_SEE_ENV_EDU_INST
        SET
            APLCNTID = #{aplcntid}
            , APLCNT_NM = #{aplcntNm}
            , APLCNT_EML = #{aplcntEml}
            , APLCNT_MOBLPHON = #{aplcntMoblphon}
            , RPRSV_BRDT = #{rprsvBrdt}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE
            APLYID = #{aplyid}
    </update>        
    
    <!-- 운영계획 개요 조회 -->
    <select id="selectOperPlan" parameterType="EduInstVo" resultType="EduInstVo">
        /* EduInstDao.selectOperPlan*/
        SELECT
            A.APLYID            /*신청아이디*/
          , B.APLYID    AS PLAN_KEY
          , B.MAIN_BSNS         /*주요_사업*/
          , B.OPER_MTHD         /*운영_방법*/
          , B.OPER_PLAN         /*운영_계획*/
          , B.MNG_PLAN          /*관리_계획*/
          , B.BGT_PLAN          /*예산_계획*/
          , B.EXPC_EFFECT       /*기대_효과*/
          , B.ETC_DTA           /*기타_자료*/
          , B.ATCH_FILEGRPID    /*첨부_파일그룹아이디*/
          , B.MDFCN_DT          /*수정_일시*/
          , B.MDFRID            /*수정자아이디*/
          , B.REG_DT            /*등록_일시*/
          , B.RGTRID            /*등록자아이디*/
        FROM
            TB_SEE_ENV_EDU_INST A
        LEFT OUTER JOIN
            TB_SEE_OPER_PLAN B ON A.APLYID = B.APLYID
        WHERE A.APLYID =#{aplyid}
    </select>

     <!-- 운영계획 등록 -->
    <insert id="insertOperPlan" parameterType="EduInstVo" useGeneratedKeys="true" keyProperty="aplyid">
        /* EduInstDao.insertOperPlan*/
        INSERT INTO TB_SEE_OPER_PLAN
        (
            APLYID
          , MAIN_BSNS
          , OPER_MTHD
          , OPER_PLAN
          , MNG_PLAN
          , BGT_PLAN
          , EXPC_EFFECT
          , ETC_DTA
          , ATCH_FILEGRPID
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES
        (
            #{aplyid       }
          , #{mainBsns     }
          , #{operMthd     }
          , #{operPlan     }
          , #{mngPlan      }
          , #{bgtPlan      }
          , #{expcEffect   }
          , #{etcDta       }
          , #{atchFilegrpid}
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        )
    </insert>

    <!-- 운영계획 수정 -->
    <update id="updateOperPlan" parameterType="EduInstVo" useGeneratedKeys="true" keyProperty="aplyid">
        /* EduInstDao.updateOperPlan*/
        UPDATE TB_SEE_OPER_PLAN SET
              MAIN_BSNS      = #{mainBsns}       /*주요사업*/
            , OPER_MTHD      = #{operMthd}       /*운영방법*/
            , OPER_PLAN      = #{operPlan}       /*운영계획*/
            , MNG_PLAN       = #{mngPlan}        /*관리계획*/
            , BGT_PLAN       = #{bgtPlan}        /*예산계획*/
            , EXPC_EFFECT    = #{expcEffect}     /*기대효과*/
            , ETC_DTA        = #{etcDta}         /*기타자료*/
            , ATCH_FILEGRPID = #{atchFilegrpid}  /*첨부파일그룹아이디*/
            , MDFCN_DT       = NOW()             /*수정일시*/
            , MDFRID         = #{user.userid}    /*수정자아이디*/
        WHERE APLYID = #{aplyid}    /*신청아이디*/
    </update>

    <!-- 추진일정 목록 조회 -->
    <select id="selectSchdlList" parameterType="EduInstVo" resultType="SchdlVo">
        /* EduInstDao.selectSchdlList*/
        SELECT
            A.APLYID
          , B.SCHDLID     /*일정아이디*/
          , B.DE          /*일자*/
          , B.HR          /*시간*/
          , B.EDU_CRS     /*교육_과정*/
          , B.DTL_CN      /*세부_내용*/
          , B.EDU_TRGT    /*교육_대상*/
          , B.MDFCN_DT    /*수정_일시*/
          , B.MDFRID      /*수정자아이디*/
          , B.REG_DT      /*등록_일시*/
          , B.RGTRID      /*등록자아이디*/
        FROM
            TB_SEE_ENV_EDU_INST A
        LEFT OUTER JOIN
            TB_SEE_SCHDL B ON A.APLYID = B.APLYID
        WHERE A.APLYID = #{aplyid}
    </select>

    <!-- 추진일정 등록 -->
    <insert id="insertPropSchdl" parameterType="EduInstVo">
        /* EduInstDao.insertPropSchdl*/
        INSERT INTO TB_SEE_SCHDL
        (
            APLYID
          , DE
          , HR
          , EDU_CRS
          , DTL_CN
          , EDU_TRGT
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        )VALUES(
            #{aplyid }
          , #{de     }
          , #{hr     }
          , #{eduCrs }
          , #{dtlCn  }
          , #{eduTrgt}
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        )
    </insert>

    <!-- 추진일정 목록 삭제 -->
    <delete id="deletePropSchdl" parameterType="EduInstVo" >
        /* EduInstDao.deletePropSchdl*/
        DELETE FROM
            TB_SEE_SCHDL
        WHERE APLYID = #{aplyid}
    </delete>

    <!-- 교육전문인력 목록 조회 -->
    <select id="selectEduExprtList" parameterType="EduInstVo" resultType="EduExprtVo">
        /* EduInstDao.selectExprtList*/
        SELECT
            A.APLYID          /* 신청아이디 */
          , B.EXPRTID         /* 전문가아이디 */
          , B.SE_CD           /* 구분_코드 */
          , B.NM              /* 이름 */
          , B.BRDT            /* 생년월일 */
          , B.CHRGTASK        /* 담당업무 */
          , B.CRTFCT          /* 자격증 */
          , B.HDOF_BGNG_DE    /* 재직_시작_일자 */
          , B.HDOF_END_DE     /* 재직_종료_일자 */
          , CASE WHEN LENGTH(B.HDOF_BGNG_DE) <![CDATA[>=]]> 10 THEN CONCAT(B.HDOF_BGNG_DE, ' - ', B.HDOF_END_DE) ELSE CASE WHEN LENGTH(B.HDOF_END_DE) <![CDATA[>=]]> 10 THEN CONCAT(B.HDOF_BGNG_DE, ' - ', B.HDOF_END_DE) ELSE NULL END END AS HDOF_DE
          , B.CAREER          /* 경력 */
          , B.ATCH_FILEGRPID  /* 첨부_파일그룹아이디 */
          , B.MDFCN_DT        /* 수정_일시 */
          , B.MDFRID          /* 수정자아이디 */
          , B.REG_DT          /* 등록_일시 */
          , B.RGTRID          /* 등록자아이디 */
        FROM
            TB_SEE_ENV_EDU_INST A
        LEFT OUTER JOIN
            TB_SEE_EXPRT B ON A.APLYID  =B.APLYID
        WHERE A.APLYID = #{aplyid}
    </select>

    <!-- 교육전문인력 등록 -->
    <insert id="insertEduExprt" parameterType="EduExprtVo">
        /* EduInstDao.insertEduExprt*/
        INSERT INTO TB_SEE_EXPRT
        (
            APLYID
          , SE_CD
          , NM
          , BRDT
          , CHRGTASK
          , CRTFCT
          , HDOF_BGNG_DE
          , HDOF_END_DE
          , CAREER
          , ATCH_FILEGRPID
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES
        (
            #{aplyid       }
          , #{seCd         }
          , #{nm           }
          , #{brdt         }
          , #{chrgtask     }
          , #{crtfct       }
          , #{hdofBgngDe   }
          , #{hdofEndDe    }
          , #{career       }
          , #{atchFilegrpid}
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        )
    </insert>

    <!-- 추진일정 목록 삭제 -->
    <delete id="deleteEduExprt" parameterType="EduInstVo" >
        /* EduInstDao.deleteEduExprt*/
        DELETE FROM
            TB_SEE_EXPRT
        WHERE APLYID = #{aplyid}
    </delete>


    <!-- 교육프로그램 목록 조회 -->
    <select id="selectSeePrgrmList" parameterType="EduInstVo" resultType="SeePrgrmVo">
        /* EduInstDao.selectSeePrgrmList*/
        SELECT
            A.APLYID
          , B.PRGRMID
          , B.PRGRM_NM
          , B.RFRNC_PRGRMID
          , B.EDU_SBJCT
          , B.EDU_TRGT
          , B.EDU_NOPE
          , B.EDU_MTHD
          , B.EDU_RND
          , B.EDU_PLC
          , B.ETRFEE
          , B.PRGRM_STTS_CD
          , B.MDFCN_DT
          , B.MDFRID
          , B.REG_DT
          , B.RGTRID
        FROM
            TB_SEE_ENV_EDU_INST A
        LEFT OUTER JOIN
            TB_SEE_PRGRM B ON A.APLYID = B.APLYID
        WHERE  1=1
        AND A.APLYID = #{aplyid}
    </select>

    <!-- 교육프로그램 등록 -->
    <insert id="insertSeePrgrm" parameterType="SeePrgrmVo">
        /* EduInstDao.insertSeePrgrm */
        INSERT INTO TB_SEE_PRGRM
        (
             APLYID
           , PRGRM_NM
           , RFRNC_PRGRMID
           , EDU_SBJCT
           , EDU_TRGT
           , EDU_NOPE
           , EDU_MTHD
           , EDU_RND
           , EDU_PLC
           , ETRFEE
           , PRGRM_STTS_CD
           , MDFCN_DT
           , MDFRID
           , REG_DT
           , RGTRID
        )VALUES
        (
             #{aplyid      }
           , #{prgrmNm     }
           , #{rfrncPrgrmid}
           , #{eduSbjct    }
           , #{eduTrgt     }
           , #{eduNope     }
           , #{eduMthd     }
           , #{eduRnd      }
           , #{eduPlc      }
           , #{etrfee      }
           , #{prgrmSttsCd }
           , NOW()
           , #{user.userid}
           , NOW()
           , #{user.userid}

        )
    </insert>

    <!-- 교육프로그램 삭제 -->
    <delete id="deleteSeePrgrm" parameterType="SeePrgrmVo" >
        /* EduInstDao.deleteSeePrgrm */
        DELETE FROM
            TB_SEE_PRGRM
        WHERE APLYID = #{aplyid}
    </delete>

    <!-- 지정프로그램 목록 조회 -->
    <select id="selectDsgnPrgrmList" parameterType="EduInstVo" resultType="SeePrgrmVo">
        /* EduInstDao.selectDsgnPrgrmList*/
        <include refid="PaginationMapper.header"/>
        SELECT
            PRGRMID     AS RFRNC_PRGRMID
          , PRGRM_NM    AS RFRNC_PRGRM_NM
          , DSGN_NO
          , MDFCN_DT
        FROM TB_ASS_PRGRM
        WHERE STTS_CD = '111111' 
        AND   APLCNTID = #{aplcntid}
        <if test="searchPrgrmNm!= null and searchPrgrmNm != '' ">
            AND PRGRM_NM LIKE CONCAT('%',#{searchPrgrmNm},'%')
        </if>
        <if test="searchDsgnNo!= null and searchDsgnNo != '' ">
            AND DSGN_NO LIKE CONCAT('%',#{searchDsgnNo},'%')
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 교육시설 조회-->
    <select id="selectSeeFclt" parameterType="EduInstVo" resultType="EduInstVo">
        /* EduInstDao.selectSeeFclt*/
        SELECT
            A.APLYID
          , A.STTS_CD
          , B.APLYID    AS FCLT_KEY
          , B.RENT_YN
          , B.RENT_PRD
          , B.TOTAR
          , B.STY_FCLT_HOLD_YN
          , B.STY_FCLT_AR
          , B.STY_FCLT_NOPE
          , B.MDFCN_DT
          , B.MDFRID
          , B.REG_DT
          , B.RGTRID
        FROM
            TB_SEE_ENV_EDU_INST A
        LEFT OUTER JOIN
            TB_SEE_FCLT B ON A.APLYID = B.APLYID
        WHERE 1=1
        AND A.APLYID = #{aplyid}
    </select>

    <!-- 시설 강의실 목록 조회-->
    <select id="selectLctrumList" parameterType="EduInstVo" resultType="LctrumVo">
        /* EduInstDao.selectLctrumList*/
        SELECT
            A.APLYID
          , B.LCTRUMID
          , B.APLYID
          , B.SE_CD
          , B.NM
          , B.AR
          , B.NOPE
        FROM
            TB_SEE_ENV_EDU_INST A
        LEFT OUTER JOIN
            TB_SEE_FCLT_LCTRUM  B ON A.APLYID = B.APLYID
        WHERE 1=1
        AND A.APLYID = #{aplyid}
        <if test="seCd!= null and seCd != '' ">
            AND B.SE_CD = #{seCd}
        </if>
    </select>

    <!-- 시설 강의실 등록 -->
    <insert id="insertFcltLctrum" parameterType="LctrumVo">
        /* EduInstDao.insertFcltLctrum */
        INSERT INTO TB_SEE_FCLT_LCTRUM
        (
            APLYID
          , SE_CD
          , NM
          , AR
          , NOPE
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
          ) VALUES (
            #{aplyid }
          , #{seCd   }
          , #{nm     }
          , #{ar     }
          , #{nope   }
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid }
          )
    </insert>

    <!-- 시설 강의실 삭제 -->
    <delete id="deleteFcltLctrum" parameterType="EduInstVo">
        DELETE FROM TB_SEE_FCLT_LCTRUM
        WHERE APLYID = #{aplyid}
    </delete>

    <!-- 교육시설 설비 목록 조회-->
    <select id="selectFcltEqpList" parameterType="EduInstVo" resultType="EqpVo">
        /* EduInstDao.selectFcltEqpList*/
        SELECT
            A.APLYID
          , B.EQPID
          , B.APLYID
          , B.NM
          , B.QNTY
          , B.PRCUSE_MTHD
          , B.RMRK
          , B.MDFCN_DT
          , B.MDFRID
          , B.REG_DT
          , B.RGTRID
        FROM
            TB_SEE_ENV_EDU_INST A
        LEFT OUTER JOIN
            TB_SEE_FCLT_EQP B ON A.APLYID = B.APLYID
        WHERE 1=1
        AND   A.APLYID = #{aplyid}
    </select>

    <!-- 시설 설비 등록 -->
    <insert id="insertFcltEqp" parameterType="EqpVo">
        /* EduInstDao.insertFcltEqp*/
        INSERT INTO TB_SEE_FCLT_EQP
        (
            APLYID
          , NM
          , QNTY
          , PRCUSE_MTHD
          , RMRK
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES (
            #{aplyid    }
          , #{nm        }
          , #{qnty      }
          , #{prcuseMthd}
          , #{rmrk      }
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid }
        )
    </insert>

    <!-- 교육프로그램 삭제 -->
    <delete id="deleteFcltEqp" parameterType="EduInstVo" >
        /* EduInstDao.deleteFcltEqp */
        DELETE FROM
            TB_SEE_FCLT_EQP
        WHERE APLYID = #{aplyid}
    </delete>

    <!-- 시설 설비 등록 -->
    <insert id="insertSeeFclt" parameterType="EduInstVo">
        INSERT INTO TB_SEE_FCLT(
            APLYID
          , RENT_YN
          , RENT_PRD
          , TOTAR
          , STY_FCLT_HOLD_YN
          , STY_FCLT_AR
          , STY_FCLT_NOPE
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        )VALUES(
            #{aplyid       }
          , #{rentYn       }
          , #{rentPrd      }
          , #{totar        }
          , #{styFcltHoldYn}
          , #{styFcltAr    }
          , #{styFcltNope  }
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        )
    </insert>

    <!-- 시설 설비 수정 -->
    <update id="updateSeeFclt" parameterType="EduInstVo">
        /* EduInstDao.updateSeeFclt*/
        UPDATE TB_SEE_FCLT SET
            RENT_YN             = #{rentYn       }
          , RENT_PRD            = #{rentPrd      }
          , TOTAR               = #{totar        }
          , STY_FCLT_HOLD_YN    = #{styFcltHoldYn}
          , STY_FCLT_AR         = #{styFcltAr    }
          , STY_FCLT_NOPE       = #{styFcltNope  }
          , MDFCN_DT            = NOW()
          , MDFRID              = #{user.userid}
        WHERE 1=1
        AND APLYID = #{aplyid}
    </update>
            
    <!-- 담당자 목록 조회 -->
    <select id="selectUserList" parameterType="EduReqUserVo" resultType="EduReqUserVo">
        /* EduInstDao.selectUserList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.USERID
          , A.INSTID
          , A.ACNT
          , A.NM AS USER_NM
          , A.MOBLPHON AS APLCNT_TELNO
          , A.EML AS APLCNT_EML
          , B.INST_NM
          , B.RPRSV_NM 
          , B.TELNO AS APLY_INST_TELNO
          , B.INST_TYPE_CD 
          , B.HMPG 
          , B.BRNO AS REG_NO
          , B.ZIP AS INST_ZIP
          , B.ADDR AS INST_ADDR
          , B.ADDR_DTL AS INST_ADDR_DTL
          , B.RGN_CD 
          , (SELECT COUNT(*) FROM TB_SPB_APLY WHERE PCNTSTID = #{pcntstid} AND A.USERID = USERID) AS APLY_CNT
        FROM
        TB_CMM_USER A
        LEFT OUTER JOIN TB_CMM_INST B ON A.INSTID = B.INSTID
        WHERE 1=1
        <choose>
            <when test="fldCd == '173105' or fldCd == '173106'">
            AND IFNULL(A.INSTID, '') = ''
            </when>
            <otherwise>
            AND IFNULL(A.INSTID, '') != ''
            </otherwise>
        </choose>
        <if test="instid != null and instid != ''">
        AND A.INSTID = #{instid}
        </if>
        <if test="searchCondition != null and searchCondition != ''">
            <if test="searchKeywordType == 'userNm'">
        AND A.NM LIKE CONCAT('%',#{searchCondition},'%')
            </if>
            <if test="searchKeywordType == 'instNm'">
        AND B.INST_NM LIKE CONCAT('%',#{searchCondition},'%')
            </if>
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 보완요청 목록 조회 -->
    <select id="selectSplmntList" parameterType="EduSupplementVo" resultType="EduSupplementVo">
        /* EduInstDao.selectSplmntList */
        <include refid="PaginationMapper.header"/>
        SELECT
            SPLMNTID
            , APLYID
            , DMND_CN
            , RQSTRID
            , ANS_CN
            , ANSWRRID
            , DMND_DT
            , ANS_DT
            , ANS_STTS_CD
            , B.CD_NM AS ANS_STTS_NM
            , A.MDFCN_DT
            , A.MDFRID
            , A.REG_DT
            , A.RGTRID
        FROM
            TB_SEE_APLY_SPLMNT A
            LEFT OUTER JOIN TB_CMM_CD B ON A.ANS_STTS_CD = B.CD
        WHERE APLYID = #{aplyid}
        <if test="splmntid != null and splmntid != ''">
        AND SPLMNTID = #{splmntid}
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 보완요청 -->
    <insert id="insertSplmnt" parameterType="EduSupplementVo" useGeneratedKeys="true" keyProperty="splmntid">
        /* EduInstDao.insertSplmnt */
        INSERT INTO TB_SEE_APLY_SPLMNT (
            SPLMNTID
            , APLYID
            , DMND_CN
            , RQSTRID
            , DMND_DT
            , ANS_STTS_CD
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{splmntid}
            , #{aplyid}
            , #{dmndCn}
            , #{user.userid}
            , NOW()
            , #{ansSttsCd}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>

    <!-- 보완요청 수정 -->
    <update id="updateSplmnt" parameterType="EduSupplementVo">
        /* EduInstDao.updateSplmnt */
        UPDATE TB_SEE_APLY_SPLMNT SET
            DMND_CN = #{dmndCn}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE SPLMNTID = #{splmntid}
    </update>
</mapper>