<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : AsgsysSrngDaoImpl.xml
    Description : 지정제심사 관리
-->
<mapper namespace="com.kbrainc.plum.mng.asgsysSrng.model.AsgsysSrngDao">


    <!-- 지정신청 목록 조회. -->
    <select id="selectDsgnAplyList" parameterType="AsgsysSrngVo" resultType="AsgsysSrngVo">
        /* AsgsysSrngDao.selectDsgnAplyList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.PRGRM_NM
          , A.PRGRMID
          , A.INST_NM
          , A.STTS_CD
          , A.APLY_DT
          , A.REG_DT
          , B.SRNG_STTS_CD
          , C.SRGN_STTS_CD
          , C.VST_DE
          , C.VST_HR
          , C.VST_MNT
        FROM
            TB_ASS_PRGRM A
        LEFT OUTER JOIN
        (   SELECT
                PRGRMID
              , SRNG_STTS_CD
            FROM
                TB_ASS_PRGRM_JDGS LIMIT 0,1 ) B ON A.PRGRMID  = B.PRGRMID
        LEFT OUTER JOIN
        (   SELECT
                PRGRMID
              , SRGN_STTS_CD
              , VST_DE
              , VST_HR
              , VST_MNT
            FROM
                TB_ASS_SPRTGRP_SRNG LIMIT 0,1 ) C ON A.PRGRMID  = C.PRGRMID
        LEFT OUTER JOIN
        TB_CMM_INST D ON A.INSTID  = D.INSTID
        WHERE 1=1
        <!-- 키워드.프로그램명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchPrgrmNm'">
            AND A.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 키워드.기관명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchInstNm'">
            AND A.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 키워드.사업자번호 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'brno'">
            AND D.BRNO LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 진행상태  -->
        <if test="searchSttsCd != null and searchSttsCd != ''">
            AND A.STTS_CD = #{searchSttsCd}
        </if>
        <!-- 신청일 검색시작일  -->
        <if test="searchAplyStartDt != null and searchAplyStartDt != ''">
            AND A.APLY_DT >= #{searchAplyStartDt}
        </if>
        <!-- 신청일 검색종료일  -->
        <if test="searchAplyEndDt  != null and searchAplyEndDt != ''">
            AND A.APLY_DT <![CDATA[<]]> CAST(CONCAT(#{searchAplyEndDt},' 23:59:59') AS DATETIME)
        </if>
        <!-- 심사위원 심사상태-->
        <if test="searchSrngSttsCd != null and searchSrngSttsCd != ''">
            AND B.SRNG_STTS_CD = #{searchSrngSttsCd}
        </if>
        <!-- 지원단 심사상태-->
        <if test="searchSrgnSttsCd != null and searchSrgnSttsCd != ''">
            AND C.SRGN_STTS_CD = #{searchSrgnSttsCd }
        </if>
        <!-- 현장점검지정일 시작일-->
        <if test="searchChckDsgnStartDt != null and searchChckDsgnStartDt != ''">
            AND C.VST_DE >= #{searchChckDsgnStartDt}
        </if>
        <!-- 현장점검지정일 종료일-->
        <if test="searchChckDsgnEndDt != null and searchChckDsgnEndDt != ''">
            AND C.VST_DE <![CDATA[<]]> CAST(CONCAT(#{searchChckDsgnEndDt},' 23:59:59') AS DATETIME)
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 지정신청상세 조회. -->
    <select id="selectDsgnAplyDtlInfo" parameterType="AsgsysSrngVo" resultType="AsgsysSrngVo">
    SELECT
        INSTID              /* 기관아이디 */
      , APLCNTID            /* 신청자아이디 */
      , APLCNT_NM           /* 신청자_이름 */
      , APLCNT_EML          /* 신청자_이메일 */
      , APLCNT_MOBLPHON     /* 신청자_휴대폰 */
      , INST_NM             /* 기관_이름 */
      , INST_EML            /* 기관_이메일 */
      , INST_CNTCT          /* 기관_연락처 */
      , INST_HMPG           /* 기관_홈페이지 */
      , INST_TYPE_CD        /* 기관_유형_코드 */
      , INST_RGN_CD         /* 기관_지역_코드 */
      , INST_ZIP            /* 기관_우편번호 */
      , INST_ADDR           /* 기관_주소 */
      , INST_DTLADDR        /* 기관_상세주소 */
      , PRGRM_NM            /* 프로그램_이름 */
      , FILEGRPID           /* 파일그룹아이디 */
      , STTS_CD             /* 상태_코드 */
      , DSGN_CYCL           /* 지정_차수 */
      , DSGN_NO             /* 지정_번호 */
      , DSGN_DE             /* 지정_일자 */
      , DSGN_BGNG_DE        /* 지정_시작_일자 */
      , DSGN_END_DE         /* 지정_종료_일자 */
      , AUTZRID             /* 승인자아이디 */
      , CHKLSTID            /* 체크리스트아이디 */
      , CNSLTNG_PRGRS_YN    /* 컨설팅__진행_여부 */
      , CNSLTNGID           /* 컨설텅아이디 */
      , APLY_DT             /* 신청_일시 */
      , MDFCN_DT            /* 수정_일시 */
      , MDFRID              /* 수정자아이디 */
      , REG_DT              /* 등록_일시 */
      , RGTRID              /* 등록자아이디 */
    FROM TB_ASS_PRGRM
    WHERE 1=1
    AND PRGRMID = #{prgrmid}

    </select>

    <!-- 지정제 프로그램 등록 -->
    <insert id="insertPrgrm" parameterType="AsgsysSrngVo" >
    /* AsgsysSrngDao.insertPrgrm */
    INSERT INTO
        TB_ASS_PRGRM (
            PRGRMID,
          , INSTID
          , APLCNTID
          , APLCNT_NM
          , APLCNT_EML
          , APLCNT_MOBLPHON
          , INST_NM
          , INST_EML
          , INST_CNTCT
          , INST_HMPG
          , INST_TYPE_CD
          , INST_RGN_CD
          , INST_ZIP
          , INST_ADDR
          , INST_DTLADDR
          , PRGRM_NM
          , FILEGRPID
          , STTS_CD
          , DSGN_CYCL
          , DSGN_NO
          , DSGN_DE
          , DSGN_BGNG_DE
          , DSGN_END_DE
          , AUTZRID
          , CHKLSTID
          , CNSLTNG_PRGRS_YN
          , CNSLTNGID
          , APLY_DT
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
    ) VALUES(
            #{prgrmid       }
          , #{instid        }
          , #{aplcntid      }
          , #{aplcntNm      }
          , #{aplcntEml     }
          , #{aplcntMoblphon}
          , #{instNm        }
          , #{instEml       }
          , #{instCntct     }
          , #{instHmpg      }
          , #{instTypeCd    }
          , #{instRgnCd     }
          , #{instZip       }
          , #{instAddr      }
          , #{instDtladdr   }
          , #{prgrmNm       }
          , #{filegrpid     }
          , #{sttsCd        }
          , #{dsgnCycl      }
          , #{dsgnNo        }
          , #{dsgnDe        }
          , #{dsgnBgngDe    }
          , #{dsgnEndDe     }
          , #{autzrid       }
          , #{chklstid      }
          , #{cnsltngPrgrsYn}
          , #{cnsltngid     }
          , #{aplyDt        }
          , NOW()
          , #{mdfrid        }
          , NOW()
          , #{rgtrid        }
    )
    </insert>

    <!-- 지정제 프로그램 수정 -->
    <update id="updatePrgrm" parameterType="AsgsysSrngVo" >
    /* AsgsysSrngDao.updatePrgrm */
    UPDATE TB_ASS_PRGRM SET
        INSTID              = #{instid        }    /* 기관아이디 */
      , APLCNTID            = #{aplcntid      }    /* 신청자아이디 */
      , APLCNT_NM           = #{aplcntNm      }    /* 신청자_이름 */
      , APLCNT_EML          = #{aplcntEml     }    /* 신청자_이메일 */
      , APLCNT_MOBLPHON     = #{aplcntMoblphon}    /* 신청자_휴대폰 */
      , INST_NM             = #{instNm        }    /* 기관_이름 */
      , INST_EML            = #{instEml       }    /* 기관_이메일 */
      , INST_CNTCT          = #{instCntct     }    /* 기관_연락처 */
      , INST_HMPG           = #{instHmpg      }    /* 기관_홈페이지 */
      , INST_TYPE_CD        = #{instTypeCd    }    /* 기관_유형_코드 */
      , INST_RGN_CD         = #{instRgnCd     }    /* 기관_지역_코드 */
      , INST_ZIP            = #{instZip       }    /* 기관_우편번호 */
      , INST_ADDR           = #{instAddr      }    /* 기관_주소 */
      , INST_DTLADDR        = #{instDtladdr   }    /* 기관_상세주소 */
      , PRGRM_NM            = #{prgrmNm       }    /* 프로그램_이름 */
      , FILEGRPID           = #{filegrpid     }    /* 파일그룹아이디 */
      , STTS_CD             = #{sttsCd        }    /* 상태_코드 */
      , DSGN_CYCL           = #{dsgnCycl      }    /* 지정_차수 */
      , DSGN_NO             = #{dsgnNo        }    /* 지정_번호 */
      , DSGN_DE             = #{dsgnDe        }    /* 지정_일자 */
      , DSGN_BGNG_DE        = #{dsgnBgngDe    }    /* 지정_시작_일자 */
      , DSGN_END_DE         = #{dsgnEndDe     }    /* 지정_종료_일자 */
      , AUTZRID             = #{autzrid       }    /* 승인자아이디 */
      , CHKLSTID            = #{chklstid      }    /* 체크리스트아이디 */
      , CNSLTNG_PRGRS_YN    = #{cnsltngPrgrsYn}    /* 컨설팅__진행_여부 */
      , CNSLTNGID           = #{cnsltngid     }    /* 컨설텅아이디 */
      , APLY_DT             = #{aplyDt        }    /* 신청_일시 */
      , MDFCN_DT            = NOW()                /* 수정_일시 */
      , MDFRID              = #{mdfrid        }    /* 수정자아이디 */
      , REG_DT              = NOW()                /* 등록_일시 */
      , RGTRID              = #{rgtrid        }    /* 등록자아이디 */
    WHERE PRGRMID = #{prgrmid}
    </update>

    <!-- 지정신청 진행상태 수정 -->
    <update id="updatePrgrSttsCd" parameterType="AsgsysSrngVo" >
    UPDATE TB_ASS_PRGRM SET
        STTS_CD = #{sttsCd}    /* 상태_코드 */
    WHERE PRGRMID = #{prgrmid}
    </update>

</mapper>