<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : MobileAsgsysSrngDaoImpl.xml
	Description : 모바일 지정제사업관리 지원단심사
-->
<mapper namespace="com.kbrainc.plum.mng.mobileAsgsysSrng.model.MobileAsgsysSrngDao">

    <!-- 지원단심사 프로그램 목록 조회 -->
    <select id="selectAsgsysSrngList" parameterType="MobileAsgsysSrngVo" resultType="MobileAsgsysSrngVo">
        /* MobileAsgsysSrngDao.selectAsgsysSrngList*/
        SELECT
            A.PRGRMID
          , A.PRGRM_NM
          , B.SRGN_STTS_CD  AS SRGN_STTS
          , NVL(A.INST_NM, '-') AS INST_NM
          , NVL(CONCAT(B.VST_DE, ' ', B.VST_HR, ':', B.VST_MNT), '-') AS VST_DT
          , DATE_FORMAT(B.REG_DT, '%Y-%m-%d') AS REG_DT
        FROM
            TB_ASS_PRGRM A
                LEFT OUTER JOIN TB_ASS_SPRTGRP_SRNG B ON A.PRGRMID = B.PRGRMID
        WHERE
              1 = 1
            AND B.SPRTGRPID = #{user.userid}
        
            <!-- 신청일 검색시작일  -->
            <if test="searchYear != null and searchYear != ''">
                AND YEAR(A.APLY_DT) >= #{searchYear} AND #{searchYear} >= YEAR(A.APLY_DT)
            </if>
            
            <!-- 심사위원 심사상태-->
            <if test="searchSrngStts != null and searchSrngStts != ''">
                AND D.SRNG_STTS_CD = #{searchSrngStts}
            </if>
        
        ORDER BY B.REG_DT DESC
    </select>

    <!-- 지원단심사 프로그램 상세 조회 -->
    <select id="selectAsgsysSrngInfo" parameterType="MobileAsgsysSrngVo" resultType="MobileAsgsysSrngVo">
        /* MobileAsgsysSrngDao.selectAsgsysSrngInfo*/
        SELECT
            A.PRGRMID
          , A.PRGRM_NM /* 프로그램명 */
          , A.INST_NM /* 기관명 */
          , A.CHKLSTID
          , B.SPRTGRPID
          , DATE_FORMAT(CONCAT(B.VST_DE, ' ', B.VST_HR, ':', B.VST_MNT), '%Y-%m-%d %H:%i') AS VST_DT
          , CASE
                WHEN C.STY_YN = 'Y' THEN CONCAT('숙박 / ', C.STY_NIGHT, '박 ', C.STY_DAYTM, '일')
                WHEN C.STY_YN = 'N' THEN '비숙박'
            END AS STY_YN
          , C.EDU_PHOTO_FILEGRPID
          , OPERFRMCD.CD_NM AS OPER_FRM
          , CASE
                WHEN D.BFR_CERT_YN = 'Y' THEN '사전인증 완료'
                WHEN D.BFR_CERT_YN = 'N' THEN '사전인증 미완료'
                WHEN D.BFR_CERT_YN IS NULL THEN '사전인증 미완료'
            END AS BFR_CERT_YN
          , D.FILEGRPID
          , D.BFR_CERT_FILEGRPID
          , G.SBMSNID
          , H.SBMSNID AS APLCNT_SBMSNID
          , G.CHKLST_RSLT_CN
          , B.SRNG_OPNN
        FROM
            TB_ASS_PRGRM A
                LEFT OUTER JOIN TB_ASS_SPRTGRP_SRNG B ON A.PRGRMID = B.PRGRMID
                LEFT OUTER JOIN TB_ASS_PRGRM_DSTNCTN C ON A.PRGRMID = C.PRGRMID
                LEFT OUTER JOIN TB_ASS_SFTY_MNG D ON A.PRGRMID = D.PRGRMID
                LEFT OUTER JOIN
                (
                SELECT
                    PRGRMID
                  , SBMSNID
                  , CHKLSTID
                  , CHKLST_RSLT_CN
                  , SCR
                FROM
                    TB_ASS_CHKLST_SBMSN
                WHERE
                    SBMSN_SE_CD = '242102'
                ) G ON A.PRGRMID = G.PRGRMID
                LEFT OUTER JOIN
                (
                SELECT
                    PRGRMID
                  , SBMSNID
                  , CHKLSTID
                  , CHKLST_RSLT_CN
                  , SCR
                  , USERID
                FROM
                    TB_ASS_CHKLST_SBMSN
                WHERE
                    SBMSN_SE_CD = '242101'
                ) H ON A.PRGRMID = H.PRGRMID AND A.APLCNTID = H.USERID /*자가진단*/
        
                LEFT OUTER JOIN TB_CMM_CD OPERFRMCD ON C.OPER_FRM_CD = OPERFRMCD.CD
        WHERE 1=1
          AND  A.PRGRMID = #{prgrmid}
    </select>
    
    <!-- 지원단 심사 상세 수정 -->
    <update id="updateAsgsysSrng" parameterType="MobileAsgsysSrngVo">
        /* MobileAsgsysSrngDao.updateAsgsysSrng */
        UPDATE TB_ASS_SPRTGRP_SRNG SET
            VST_DE                   = DATE_FORMAT(#{vstDt}, '%Y-%m-%d')
            , VST_HR                 = DATE_FORMAT(#{vstDt}, '%H') 
            , VST_MNT                = DATE_FORMAT(#{vstDt}, '%i') 
            , MDFCN_DT               = NOW() 
            , MDFRID                 = #{user.userid}
         WHERE PRGRMID = #{prgrmid}
    </update>
    
        <!-- 지원단심사 체크리스트 조회 -->
    <select id="selectCheckList" parameterType="MobileAsgsysSrngVo" resultType="MobileAsgsysSrngVo">
        /* MobileAsgsysSrngDao.selectCheckList*/
        WITH
            RECURSIVE
            CODE_CTE(LV1KEY, LV2KEY, CN, TREE_ORD, QITEMID, CNT) AS (
            SELECT
                IFNULL(UPPR_CD, '') AS LV1KEY
              , CD AS SE_CD
              , CONCAT(CD_NM) AS CN
              , CASE
                    WHEN UPPR_CD = 0 THEN 1
                    ELSE 2
                END AS TREE_ORD
              , 0 AS QITEMID
              , NVL(B.CNT, 0) AS CNT
            FROM
                TB_CMM_CD A
                    LEFT OUTER JOIN (
                                    SELECT
                                        D.SE_CD
                                      , COUNT(D.SE_CD) AS CNT
                                    FROM
                                        TB_ASS_PRGRM A
                                            LEFT OUTER JOIN TB_ASS_CHKLST B ON A.CHKLSTID = B.CHKLSTID
                                            LEFT OUTER JOIN TB_ASS_CHKLST_QITEM_MAPNG C ON B.CHKLSTID = C.CHKLSTID
                                            LEFT OUTER JOIN TB_ASS_CHKLST_QITEM D ON C.QITEMID = D.QITEMID
                                    WHERE
                                          1 = 1
                                      AND A.PRGRMID = #{prgrmid}
                                      AND D.USE_YN = 'Y'
                                    GROUP BY D.SE_CD
                                    ) B ON A.CD = B.SE_CD
            WHERE
                  1 = 1
              AND CDGRPID != 'G0001'
              AND CDGRPID = '140'
        
            UNION ALL
        
            SELECT
                IFNULL(UPPR_CD, '') AS LV1KEY
              , CD AS SE_CD
              , CD_NM AS SE_NM
              , 3 AS TREE_ORD
              , D.QITEMID AS QITEMID
              , D.CNT AS CNT
            FROM
                (
                SELECT
                    (
                    SELECT
                        UPPR_CD
                    FROM
                        TB_CMM_CD
                    WHERE
                        D.SE_CD = CD
                    ) AS UPPR_CD
                  , D.SE_CD AS CD
                  , D.CN AS CD_NM
                  , C.ORDR AS ORD
                  , C.QITEMID
                  , 0 AS CNT
                FROM
                    TB_ASS_PRGRM A
                        LEFT OUTER JOIN TB_ASS_CHKLST B ON A.CHKLSTID = B.CHKLSTID
                        LEFT OUTER JOIN TB_ASS_CHKLST_QITEM_MAPNG C ON B.CHKLSTID = C.CHKLSTID
                        LEFT OUTER JOIN TB_ASS_CHKLST_QITEM D ON C.QITEMID = D.QITEMID
                WHERE
                      1 = 1
                  AND A.PRGRMID = #{prgrmid}
                  AND D.USE_YN = 'Y'
                ) D
                    JOIN CODE_CTE C
            WHERE
                UPPR_CD = C.LV2KEY
            )
        SELECT
            A.LV1KEY
          , A.LV2KEY
          , A.CN
          , A.QITEMID
          , A.TREE_ORD
          , A.CNT
          , B.ALTM
          , B.SCR
          , B.ORDR
          , B.APLCNT_SCR
        FROM
            CODE_CTE A
                LEFT OUTER JOIN (
                                SELECT
                                    C.QITEMID
                                  , D.SE_CD
                                  , D.CN
                                  , D.IDNTY_MTTR
                                  , D.ALTM
                                  , D.USE_YN
                                  , B.CHKLSTID
                                  , C.ORDR
                                  , E.SCR
                                  , F.SCR AS APLCNT_SCR
                                FROM
                                    TB_ASS_PRGRM A
                                        LEFT OUTER JOIN TB_ASS_CHKLST B ON A.CHKLSTID = B.CHKLSTID
                                        LEFT OUTER JOIN TB_ASS_CHKLST_QITEM_MAPNG C ON B.CHKLSTID = C.CHKLSTID
                                        LEFT OUTER JOIN TB_ASS_CHKLST_QITEM D ON C.QITEMID = D.QITEMID
                                        LEFT OUTER JOIN
                                        (
                                        SELECT
                                            C.SBMSNID
                                          , C.QITEMID
                                          , C.SCR
                                        FROM
                                            TB_ASS_PRGRM A
                                                LEFT OUTER JOIN TB_ASS_CHKLST_SBMSN B ON A.PRGRMID = B.PRGRMID
                                                LEFT OUTER JOIN TB_ASS_CHKLST_ANS C ON B.SBMSNID = C.SBMSNID
                                        WHERE
                                              A.PRGRMID = #{prgrmid}
                                          AND B.SBMSN_SE_CD = 242102
                                        ) E ON (D.QITEMID = E.QITEMID)
                                        LEFT OUTER JOIN
                                        (
                                        SELECT
                                            C.SBMSNID
                                          , C.QITEMID
                                          , C.SCR
                                        FROM
                                            TB_ASS_PRGRM A
                                                LEFT OUTER JOIN TB_ASS_CHKLST_SBMSN B ON A.PRGRMID = B.PRGRMID
                                                LEFT OUTER JOIN TB_ASS_CHKLST_ANS C ON B.SBMSNID = C.SBMSNID
                                        WHERE
                                              A.PRGRMID = 163
                                          AND B.SBMSN_SE_CD = 242101
                                        ) F ON D.QITEMID = F.QITEMID
                                WHERE
                                    A.PRGRMID = #{prgrmid}
                                ) B ON (A.QITEMID = B.QITEMID)
        ORDER BY LV2KEY, TREE_ORD, B.ORDR
    </select>
    
    <!-- 지원단 심사 수정 -->
    <update id="updateSprtgrpSrng">
        /* MobileAsgsysSrngDao.updateSprtgrpSrng*/
        UPDATE TB_ASS_SPRTGRP_SRNG
        SET
            SRNG_OPNN    = #{srngOpnn}
          , SRGN_STTS_CD = #{srgnSttsCd}
          , MDFCN_DT     = NOW()
          , MDFRID       = #{user.userid}
        WHERE
            PRGRMID = #{prgrmid}
    </update>
    
    <!-- 체크리스트 제출 수정 -->
    <update id="updateChkLstSbmsn">
        /* MobileAsgsysSrngDao.updateChkLstSbmsn*/
        UPDATE TB_ASS_CHKLST_SBMSN
        SET
            SBMSN_SE_CD    = #{sbmsnSeCd}
          , SBMSN_STTS_CD  = #{sbmsnSttsCd}
          , USER_IP        = #{userIp}
          , SCR            = #{totScr}
          , CHKLST_RSLT_CN = #{chklstRsltCn}
          , MDFCN_DT       = NOW()
          , MDFRID         = #{user.userid}
        WHERE
            SBMSNID = #{sbmsnid}        
    </update>
    
    <!-- 체크리스트 답변 수정 -->
    <update id="updateChkLstAns">
        /* MobileAsgsysSrngDao.updateChkLstAns*/
        <foreach item="item" collection="chkLst"  separator=";">
        UPDATE TB_ASS_CHKLST_ANS
        SET
            SE_CD    = #{item.seCd}
          , CN       = #{item.cn}
          , SCR      = #{item.scr}
          , ORDR     = #{item.ordr}
          , MDFCN_DT = NOW()
          , MDFRID   = #{user.userid}
        WHERE
              SBMSNID = #{sbmsnid}
          AND QITEMID = #{item.qitemid}
        </foreach>
    </update>
    
    <!-- 체크리스트 구분 순서 답변 수정 -->
    <update id="updateChkLstSeOrdrAns">
        /* MobileAsgsysSrngDao.updateChkLstSeOrdrAns*/
        <foreach item="item" collection="chklstSeOrdrAns"  separator=";">
        UPDATE TB_ASS_CHKLST_SE_ORDR_ANS
        SET
            SE_CD    = #{item.seCd}
          , ORDR     = #{item.ordr}
          , MDFCN_DT = NOW()
          , MDFRID   = #{user.userid}
        WHERE
              SBMSNID = #{sbmsnid}
          AND SE_CD = #{item.seCd}
        </foreach>
    </update>
    
    <!-- 체크리스트 제출 등록 -->
    <insert id="insertChkLstSbmsn" parameterType="MobileAsgsysSrngVo" useGeneratedKeys="true" keyProperty="sbmsnid">
        /* MobileAsgsysSrngDao.insertChkLstSbmsn*/
        INSERT INTO
            TB_ASS_CHKLST_SBMSN
            (
                CHKLSTID
            ,   PRGRMID
            ,   USERID
            ,   SBMSN_SE_CD
            ,   SBMSN_DT
            ,   SBMSN_STTS_CD
            ,   USER_IP
            ,   SCR
            ,   CHKLST_RSLT_CN
            ,   MDFCN_DT
            ,   MDFRID
            ,   REG_DT
            ,   RGTRID
            )
        VALUES
            (
                #{chklstid}
            ,   #{prgrmid}
            ,   #{user.userid}
            ,   #{sbmsnSeCd}
            ,   NOW()
            ,   #{sbmsnSttsCd}
            ,   #{userIp}
            ,   #{totScr}
            ,   #{chklstRsltCn}
            ,   NOW()
            ,   #{user.userid}
            ,   NOW()
            ,   #{user.userid}
            )        
    </insert>
    
    <!-- 체크리스트 답변 등록 -->
    <insert id="insertChkLstAns">
        /* MobileAsgsysSrngDao.insertChkLstAns*/
        INSERT INTO
            TB_ASS_CHKLST_ANS
            (
                SBMSNID
            ,   QITEMID
            ,   SE_CD
            ,   CN
            ,   SCR
            ,   ORDR
            ,   MDFCN_DT
            ,   MDFRID
            ,   REG_DT
            ,   RGTRID
            )
        VALUES
        <foreach item="item" collection="chkLst"  separator=",">
            (
                #{sbmsnid}
            ,   #{item.qitemid}
            ,   #{item.seCd}
            ,   #{item.cn}
            ,   #{item.scr}
            ,   #{item.ordr}
            ,   NOW()
            ,   #{user.userid}
            ,   NOW()
            ,   #{user.userid}
            )
        </foreach>            
    </insert>
    
    <!-- 체크리스트 구분 순서 답변 등록 -->
    <insert id="insertChkLstSeOrdrAns">
        /* MobileAsgsysSrngDao.insertChkLstSeOrdrAns*/
        INSERT INTO
            TB_ASS_CHKLST_SE_ORDR_ANS
            (
                SBMSNID
            ,   SE_CD
            ,   ORDR
            ,   MDFCN_DT
            ,   MDFRID
            ,   REG_DT
            ,   RGTRID
            )
        VALUES
        <foreach item="item" collection="chklstSeOrdrAns"  separator=",">
            (
                #{sbmsnid}
            ,   #{item.seCd}
            ,   #{item.ordr}
            ,   NOW()
            ,   #{user.userid}
            ,   NOW()
            ,   #{user.userid}
            )
        </foreach>    
    </insert>
    
</mapper>