<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : SiteDaoImpl.xml
	Description : 사이트 관리
-->
<mapper namespace="com.kbrainc.plum.mng.site.model.SiteDao">

    <!-- 사이트 목록 -->
    <select id="selectSiteList" parameterType="SiteVo" resultType="SiteVo">
        /* SiteDao.selectSiteList */
        <include refid="PaginationMapper.header"/>
        SELECT
            S.SITEID,
            S.SITE_NM,
            S.SYS_SE_CD,
            S.SYS_KND_CD,
            S.USE_YN,
            S.REG_DT,
            S.MDFCN_DT,
            S.INSTID,
            I.INST_NM,
            I.INST_CD,
            (SELECT GROUP_CONCAT(DMN) FROM TB_CMM_SITE_DMN WHERE SITEID = S.SITEID) AS DOMAINS
        FROM 
            TB_CMM_SITE S INNER JOIN TB_CMM_INST I ON S.INSTID = I.INSTID
            <if test='searchType != null and searchType != "" and searchKeyword != null and searchKeyword != ""'>
                <if test='searchType == "instnm"'>
                AND I.INST_NM LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
                <if test='searchType == "instcd"'>
                AND I.INST_CD LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
            </if>
        WHERE 
            1=1
            <if test='useYn != null and useYn != ""'>
            AND S.USE_YN = #{useYn}
            </if>
            <if test='sysSeCd != null and sysSeCd != ""'>
            AND S.SYS_SE_CD = #{sysSeCd}
            </if>
            <if test='sysKndCd != null and sysKndCd != ""'>
            AND S.SYS_KND_CD = #{sysKndCd}
            </if>
            <if test='searchType != null and searchType != "" and searchKeyword != null and searchKeyword != ""'>
                <if test='searchType == "sitenm"'>
                AND S.SITE_NM LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
                <if test='searchType == "dmn"'>
                AND S.SITEID IN(
                    SELECT 
                        SITEID
                    FROM
                        TB_CMM_SITE_DMN
                    WHERE
                        DMN LIKE CONCAT('%', #{searchKeyword}, '%')
                )
                </if>
            </if>

        <include refid="PaginationMapper.footer"/>    
    </select>
    
    <!-- 사이트 등록 -->
    <insert id="insertSite" parameterType="SiteVo" useGeneratedKeys="true" keyProperty="siteid">
        /* SiteDao.insertSite */
        INSERT INTO TB_CMM_SITE (
            SITE_NM,
            SYS_SE_CD,
            SYS_KND_CD,
            INSTID,
            LOGO_FILEID,
            CPYRHT,
            USE_YN,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        ) VALUES (
            #{siteNm},
            #{sysSeCd},
            #{sysKndCd},
            #{instid},
            #{logoFileid},
            #{cpyrht},
            #{useYn},
            NOW(),
            #{mdfrid},
            NOW(),
            #{rgtrid}
        )
    </insert>
    
    <!-- 사이트 정보를 구한다. 도메인 포함. -->
    <select id="selectSiteInfo" parameterType="Integer" resultType="SiteVo">
        /* SiteDao.selectSiteInfo */
        SELECT 
            SITEID,
            SITE_NM,
            SYS_SE_CD,
            SYS_KND_CD,
            INSTID,
            LOGO_FILEID,
            CPYRHT,
            USE_YN,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        FROM TB_CMM_SITE S
        WHERE
            SITEID = #{siteid}
    </select>
    
    <!-- 사이트 정보를 수정한다. -->
    <update id="updateSite" parameterType="SiteVo">
        /* SiteDao.updateSite */
        UPDATE 
            TB_CMM_SITE
        SET
            SITE_NM = #{siteNm},
            SYS_SE_CD = #{sysSeCd},
            SYS_KND_CD = #{sysKndCd},
            LOGO_FILEID = #{logoFileid},
            CPYRHT = #{cpyrht},
            USE_YN = #{useYn},
            MDFCN_DT = NOW(),
            MDFRID = #{mdfrid}
        WHERE
            SITEID = #{siteid}
    </update>

    <!-- 사이트 등록 -->
    <insert id="insertSiteDomains" parameterType="SiteDomainVo">
        /* SiteDao.insertSiteDomain */
        INSERT INTO TB_CMM_SITE_DMN (
            DMN,
            SITEID,            
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        ) VALUES
        <foreach item="item" collection="dmns"  separator=",">
        (
            #{item},
            #{siteid},
            NOW(),
            #{user.userid},
            NOW(),
            #{user.userid}
        )
        </foreach>    
    </insert>
    
    <!-- 사이트 도메인을 삭제한다. -->
    <update id="deleteSiteDomain" parameterType="SiteDomainVo">
        /* SiteDao.deleteSiteDomain */
        DELETE FROM TB_CMM_SITE_DMN WHERE SITEID = #{siteid}
    </update>
    
    <!-- 사이트에 대한 도메인 목록을 구한다. -->
    <select id="selectSiteDomainList" parameterType="SiteVo" resultType="SiteDomainVo" >
        /* SiteDao.selectSiteDomainList */
        SELECT
            DMN,
            DMN_DC,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        FROM
            TB_CMM_SITE_DMN
        WHERE
            SITEID = #{siteid}
    </select>   

    <!-- 저장하려는 도메인과 중복되는 도메인을 조회한다. -->
    <select id="selectSameSiteDomains" parameterType="SiteDomainVo" resultType="SiteDomainVo" >
        /* SiteDao.selectSameSiteDomains */
        SELECT GROUP_CONCAT(DMN) DOMAINS
        FROM TB_CMM_SITE_DMN
        WHERE SITEID != #{siteid}
        AND DMN IN
        <foreach item="item" collection="dmns" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select> 
    
    <!-- 기관회원의 기관관리자 역할 부여 -->
    <insert id="insertInstRoleUser" parameterType="SiteVo">
        /* SiteDao.insertInstRoleUser */
        INSERT INTO TB_CMM_ROLE_USER (ROLEID, USERID, ROLE_STRT_DD, ROLE_END_DD, MDFCN_DT, MDFRID, REG_DT, RGTRID)
        SELECT
            R.ROLEID, U.USERID, DATE_FORMAT(NOW(), '%Y-%m-%d'), '9999-12-31', NOW(), #{mdfrid}, NOW(), #{mdfrid}
        FROM
            TB_CMM_ROLE R CROSS JOIN TB_CMM_USER U ON U.INSTID = #{instid}
            LEFT OUTER JOIN TB_CMM_ROLE_USER T ON R.ROLEID = T.ROLEID AND U.USERID = T.USERID
        WHERE 
            R.KND_CD = 'M'
        AND R.USE_YN = 'Y'
        AND T.ROLEID IS NULL
    </insert>
    
    <!-- 기관회원의 기관관리자 역할 회수 -->
    <delete id="deleteInstRoleUser" parameterType="SiteVo">
        /* SiteDao.deleteInstRoleUser */
        DELETE 
            TB_CMM_ROLE_USER
        FROM 
            TB_CMM_ROLE_USER,
            (
                SELECT 
                R.ROLEID, U.USERID
            FROM
                TB_CMM_ROLE R CROSS JOIN TB_CMM_USER U ON U.INSTID = #{instid}
            WHERE
                R.KND_CD = 'M'
            ) B
        WHERE 
            TB_CMM_ROLE_USER.ROLEID = B.ROLEID
        AND TB_CMM_ROLE_USER.USERID = B.USERID
    </delete>
    
</mapper>