<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : SiteDaoImpl.xml
	Description : 사이트 관리
-->
<mapper namespace="com.kbrainc.plum.mng.site.model.SiteDao">

    <!-- 사이트 목록 -->
    <select id="selectSiteList" parameterType="SiteVo" resultType="SiteVo">
        /* SiteDao.selectSiteList */
        <include refid="PaginationMapper.header"/>
        SELECT
            S.SITEID,
            S.SITE_NM,
            S.SYS_SE_CD,
            S.USE_YN,
            S.REG_DT,
            S.MDFCN_DT,
            S.INSTID,
            I.INST_NM,
            I.INST_CD,
            (SELECT GROUP_CONCAT(DMN) FROM TB_CMM_SITE_DMN WHERE SITEID = S.SITEID) AS DOMAINS
        FROM 
            TB_CMM_SITE S INNER JOIN TB_CMM_INST I ON S.INSTID = I.INSTID
            <if test='searchType != null and searchType != "" and searchKeyword != null and searchKeyword != ""'>
                <if test='searchType == "instnm"'>
                AND I.INST_NM LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
                <if test='searchType == "instcd"'>
                AND I.INST_CD LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
            </if>
        WHERE 
            1=1
            <if test='useYn != null and useYn != ""'>
            AND S.USE_YN = #{useYn}
            </if>
            <if test='sysSeCd != null and sysSeCd != ""'>
            AND S.SYS_SE_CD = #{sysSeCd}
            </if>
            <if test='searchType != null and searchType != "" and searchKeyword != null and searchKeyword != ""'>
                <if test='searchType == "sitenm"'>
                AND S.SITE_NM LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
                <if test='searchType == "dmn"'>
                AND S.SITEID IN(
                    SELECT 
                        SITEID
                    FROM
                        TB_CMM_SITE_DMN
                    WHERE
                        DMN LIKE CONCAT('%', #{searchKeyword}, '%')
                )
                </if>
            </if>

        <include refid="PaginationMapper.footer"/>    
    </select>
    
    <!-- 사이트 등록 -->
    <insert id="insertSite" parameterType="SiteVo" useGeneratedKeys="true" keyProperty="siteid">
        /* SiteDao.insertSite */
        INSERT INTO TB_CMM_SITE (
            SITE_NM,
            SYS_SE_CD,
            USE_YN,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        ) VALUES (
            #{siteNm},
            #{sysSeCd},
            #{useYn},
            NOW(),
            #{mdfrid},
            NOW(),
            #{rgtrid}
        )
    </insert>
    
    <!-- 사이트 정보를 구한다. 도메인 포함. -->
    <select id="selectSiteInfo" parameterType="Integer" resultType="SiteVo">
        /* SiteDao.selectSiteInfo */
        SELECT 
            SITEID,
            SITE_NM,
            SYS_SE_CD,
            USE_YN,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID,
            (SELECT GROUP_CONCAT(DMN) FROM TB_CMM_SITE_DMN WHERE SITEID = S.SITEID) AS DOMAINS
        FROM TB_CMM_SITE S
        WHERE
            SITEID = #{siteid}
    </select>
    
    <!-- 사이트 정보를 수정한다. -->
    <update id="updateSite" parameterType="SiteVo">
        /* SiteDao.updateSite */
        UPDATE 
            TB_CMM_SITE
        SET
            SITE_NM = #{siteNm},
            SYS_SE_CD = #{sysSeCd},
            USE_YN = #{useYn},
            MDFCN_DT = NOW(),
            MDFRID = #{mdfrid}
        WHERE
            SITEID = #{siteid}
    </update>
    
    <!-- 사이트를 삭제한다. -->
    <update id="deleteSite" parameterType="Integer">
        /* SiteDao.deleteSite */
        DELETE FROM TB_CMM_SITE WHERE SITEID = #{siteid}
    </update>
    
    <!-- 사이트 등록 -->
    <insert id="insertSiteDomain" parameterType="SiteDomainVo" useGeneratedKeys="true">
        /* SiteDao.insertSiteDomain */
        INSERT INTO TB_CMM_SITE_DMN (
            DMN,
            SITEID,
            DMN_DC,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        ) VALUES (
            #{dmn},
            #{siteid},
            #{dmnDc},
            NOW(),
            #{mdfrid},
            NOW(),
            #{rgtrid}
        )
    </insert>
    
    <!-- 사이트 도메인 정보를 수정한다. -->
    <update id="updateSiteDomain" parameterType="SiteDomainVo">
        /* SiteDao.updateSiteDomain */
        UPDATE 
            TB_CMM_SITE_DMN
        SET
            DMN = #{dmn},
            DMN_DC = #{dmnDc},
            MDFCN_DT = NOW(),
            MDFRID = #{mdfrid}
        WHERE
            SITEID = #{siteid}
            AND DMN = #{dmnOrg}
        
    </update>
    
    <!-- 사이트 도메인을 삭제한다. -->
    <update id="deleteSiteDomain" parameterType="SiteDomainVo">
        /* SiteDao.deleteSiteDomain */
        DELETE FROM TB_CMM_SITE_DMN WHERE SITEID = #{siteid} AND DMN = #{dmn}
    </update>
    
    <!-- 사이트에 대한 도메인 목록을 구한다. -->
    <select id="selectSiteDomainList" parameterType="SiteVo" resultType="SiteDomainVo" >
        /* SiteDao.selectSiteDomainList */
        SELECT
            DMN,
            DMN_DC,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        FROM
            TB_CMM_SITE_DMN
        WHERE
            SITEID = #{siteid}
    </select>    
</mapper>