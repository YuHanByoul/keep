<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : SiteDaoImpl.xml
	Description : 사이트 관리
-->
<mapper namespace="com.kbrainc.plum.mng.site.model.SiteDao">

    <!-- 사이트 목록 -->
    <select id="selectSiteList" parameterType="SiteVo" resultType="SiteVo">
        /* SiteDao.selectSiteList */
        <include refid="PaginationMapper.header"/>
        SELECT
            S.SITEID,
            S.SITE_NM,
            S.SYS_SE_CD,
            S.SYS_KND_CD,
            S.USE_YN,
            S.REG_DT,
            S.MDFCN_DT,
            S.INSTID,
            I.INST_NM,
            I.INST_CD,
            (SELECT GROUP_CONCAT(DMN) FROM TB_CMM_SITE_DMN WHERE SITEID = S.SITEID) AS DOMAINS
        FROM 
            TB_CMM_SITE S INNER JOIN TB_CMM_INST I ON S.INSTID = I.INSTID
            <if test='searchType != null and searchType != "" and searchKeyword != null and searchKeyword != ""'>
                <if test='searchType == "instnm"'>
                AND I.INST_NM LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
                <if test='searchType == "instcd"'>
                AND I.INST_CD LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
            </if>
        WHERE 
            1=1
            <if test='useYn != null and useYn != ""'>
            AND S.USE_YN = #{useYn}
            </if>
            <if test='sysSeCd != null and sysSeCd != ""'>
            AND S.SYS_SE_CD = #{sysSeCd}
            </if>
            <if test='sysKndCd != null and sysKndCd != ""'>
            AND S.SYS_KND_CD = #{sysKndCd}
            </if>
            <if test='searchType != null and searchType != "" and searchKeyword != null and searchKeyword != ""'>
                <if test='searchType == "sitenm"'>
                AND S.SITE_NM LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
                <if test='searchType == "dmn"'>
                AND S.SITEID IN(
                    SELECT 
                        SITEID
                    FROM
                        TB_CMM_SITE_DMN
                    WHERE
                        DMN LIKE CONCAT('%', #{searchKeyword}, '%')
                )
                </if>
            </if>

        <include refid="PaginationMapper.footer"/>    
    </select>
    
    <!-- 사이트 등록 -->
    <insert id="insertSite" parameterType="SiteVo" useGeneratedKeys="true" keyProperty="siteid">
        /* SiteDao.insertSite */
        INSERT INTO TB_CMM_SITE (
            SITE_NM,
            SYS_SE_CD,
            SYS_KND_CD,
            INSTID,
            LOGO_FILEID,
            CPYRHT,
            USE_YN,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        ) VALUES (
            #{siteNm},
            #{sysSeCd},
            #{sysKndCd},
            #{instid},
            #{logoFileid},
            #{cpyrht},
            #{useYn},
            NOW(),
            #{mdfrid},
            NOW(),
            #{rgtrid}
        )
    </insert>
    
    <!-- 사이트 정보를 구한다. 도메인 포함. -->
    <select id="selectSiteInfo" parameterType="Integer" resultType="SiteVo">
        /* SiteDao.selectSiteInfo */
        SELECT 
            SITEID,
            SITE_NM,
            SYS_SE_CD,
            SYS_KND_CD,
            INSTID,
            LOGO_FILEID,
            CPYRHT,
            USE_YN,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        FROM TB_CMM_SITE S
        WHERE
            SITEID = #{siteid}
    </select>
    
    <!-- 사이트 정보를 수정한다. -->
    <update id="updateSite" parameterType="SiteVo">
        /* SiteDao.updateSite */
        UPDATE 
            TB_CMM_SITE
        SET
            SITE_NM = #{siteNm},
            SYS_SE_CD = #{sysSeCd},
            SYS_KND_CD = #{sysKndCd},
            LOGO_FILEID = #{logoFileid},
            CPYRHT = #{cpyrht},
            USE_YN = #{useYn},
            MDFCN_DT = NOW(),
            MDFRID = #{mdfrid}
        WHERE
            SITEID = #{siteid}
    </update>

    <!-- 사이트 등록 -->
    <insert id="insertSiteDomains" parameterType="SiteDomainVo">
        /* SiteDao.insertSiteDomain */
        INSERT INTO TB_CMM_SITE_DMN (
            DMN,
            SITEID,            
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        ) VALUES
        <foreach item="item" collection="dmns"  separator=",">
        (
            #{item},
            #{siteid},
            NOW(),
            #{user.userid},
            NOW(),
            #{user.userid}
        )
        </foreach>    
    </insert>
    
    <!-- 사이트 도메인을 삭제한다. -->
    <update id="deleteSiteDomain" parameterType="SiteDomainVo">
        /* SiteDao.deleteSiteDomain */
        DELETE FROM TB_CMM_SITE_DMN WHERE SITEID = #{siteid}
    </update>
    
    <!-- 사이트에 대한 도메인 목록을 구한다. -->
    <select id="selectSiteDomainList" parameterType="SiteVo" resultType="SiteDomainVo" >
        /* SiteDao.selectSiteDomainList */
        SELECT
            DMN,
            DMN_DC,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        FROM
            TB_CMM_SITE_DMN
        WHERE
            SITEID = #{siteid}
    </select>   

    <!-- 저장하려는 도메인과 중복되는 도메인을 조회한다. -->
    <select id="selectSameSiteDomains" parameterType="SiteDomainVo" resultType="SiteDomainVo" >
        /* SiteDao.selectSameSiteDomains */
        SELECT GROUP_CONCAT(DMN) DOMAINS
        FROM TB_CMM_SITE_DMN
        WHERE SITEID != #{siteid}
        AND DMN IN
        <foreach item="item" collection="dmns" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select> 
    
    <!-- 기관회원의 기관관리자 역할 부여 -->
    <insert id="insertInstRoleUser" parameterType="SiteVo">
        /* SiteDao.insertInstRoleUser */
        INSERT INTO TB_CMM_ROLE_USER (ROLEID, USERID, ROLE_STRT_DD, ROLE_END_DD, MDFCN_DT, MDFRID, REG_DT, RGTRID)
        SELECT
            R.ROLEID, U.USERID, DATE_FORMAT(NOW(), '%Y-%m-%d'), '9999-12-31', NOW(), #{mdfrid}, NOW(), #{mdfrid}
        FROM
            TB_CMM_ROLE R CROSS JOIN TB_CMM_USER U ON U.INSTID = #{instid}
            LEFT OUTER JOIN TB_CMM_ROLE_USER T ON R.ROLEID = T.ROLEID AND U.USERID = T.USERID
        WHERE 
            R.KND_CD = 'M'
        AND R.USE_YN = 'Y'
        AND T.ROLEID IS NULL
    </insert>
    
    <!-- 기관회원의 기관관리자 역할 회수 -->
    <delete id="deleteInstRoleUser" parameterType="SiteVo">
        /* SiteDao.deleteInstRoleUser */
        DELETE 
            TB_CMM_ROLE_USER
        FROM 
            TB_CMM_ROLE_USER,
            (
                SELECT 
                    R.ROLEID, U.USERID
                FROM
                    TB_CMM_ROLE R CROSS JOIN TB_CMM_USER U ON U.INSTID = #{instid}
                WHERE
                    R.KND_CD = 'M'
            ) B
        WHERE 
            TB_CMM_ROLE_USER.ROLEID = B.ROLEID
        AND TB_CMM_ROLE_USER.USERID = B.USERID
    </delete>
    
    <!-- 사이트에 메뉴가 존재하는지 확인한다. -->
    <select id="selectSiteMenuYn" parameterType="Integer" resultType="String">
        /* SiteDao.selectSiteMenuYn */
        SELECT 
            CASE WHEN COUNT(1) = 1 THEN 'Y'
                 ELSE 'N'
            END AS MENU_EXISTS_YN
        FROM DUAL
        WHERE
            EXISTS(
                SELECT 
                    MENUID
                FROM
                    TB_CMM_MENU
                WHERE 
                    SITEID = #{siteid}
            )
    </select>
    
    <!-- 분양사이트 메뉴구성을 위한 프로그램 목록을 조회한다. -->
    <select id="selectSiteAplySetupPrgrmList" resultType="SiteMenuSetupVo">
        /* SiteDao.selectSiteAplySetupPrgrmList */
        SELECT 
            C.CD_NM,
            P.DC,
            P.PRGRMID,
            C.OPTN2,
            C.OPTN3,
            C.OPTN4,
            C.OPTN5
        FROM 
            TB_CMM_CD C INNER JOIN TB_CMM_PRGRM P ON C.OPTN1 = P.PRGRMID
        WHERE
            C.CDGRPID = 124
        AND C.USE_YN = 'Y'
        ORDER BY C.ORD
    </select>
    
    <!-- 분양사이트를 구성하는 메뉴의 프로그램 목록을 조회한다. -->
    <select id="selectSiteAplySetupMenuList" parameterType="Integer" resultType="SiteMenuSetupVo">
        /* SiteDao.selectSiteAplySetupMenuList */
        SELECT 
            C.CD_NM,
            P.DC,
            P.PRGRMID,
            C.OPTN3,
            CASE WHEN M.PRGRMID = P.PRGRMID THEN 'Y'
                 ELSE 'N'
            END AS USE_YN
        FROM 
            TB_CMM_CD C INNER JOIN TB_CMM_PRGRM P ON C.OPTN1 = P.PRGRMID
            LEFT OUTER JOIN TB_CMM_MENU M ON M.SITEID = #{siteid} AND M.UPPR_MENUID = 0 AND P.PRGRMID = M.PRGRMID
        WHERE
            C.CDGRPID = 124
        AND C.USE_YN = 'Y'
        ORDER BY C.ORD
    </select>    
    
    <!-- 특정 분양사이트 특정 구성요소의 프로그램 트리. -->
    <select id="selectSiteAplyPrgrmTreeList" parameterType="Integer" resultType="com.kbrainc.plum.rte.lib.tree.TreeItem">
        /* SiteDao.selectSiteAplyPrgrmTreeList */
        WITH RECURSIVE PRGRM_CTE
        AS (
            SELECT 
                IFNULL(UPPR_PRGRMID , '') PKEY,
                PRGRMID `KEY`,
            CONVERT(RIGHT(CONCAT('0000', ORD), 4), VARCHAR(255)) AS TREE_ORD,
            0 AS EXT1
            FROM 
                TB_CMM_PRGRM
            WHERE 
                PRGRMID = #{prgrmid}
            UNION ALL
            SELECT              
            IFNULL(UPPR_PRGRMID , '') PKEY,
            PRGRMID `KEY`,
            CONVERT(CONCAT(C.TREE_ORD, RIGHT(CONCAT('0000', P.ORD), 4)), VARCHAR(255)) AS TREE_ORD,
            P.ORD AS EXT1
            FROM TB_CMM_PRGRM P, PRGRM_CTE C
            WHERE UPPR_PRGRMID = C.KEY
        )
        SELECT 
            PKEY, 
            `KEY`,
            EXT1
        FROM 
            PRGRM_CTE
        ORDER BY TREE_ORD
    </select>
    
    <!-- 일반사용자역할 모든 메뉴 권한 부여. -->
    <insert id="insertSiteAllMenuRoleForGeneralUser" parameterType="SiteMenuSetupVo">
        /* SiteDao.insertSiteAllMenuRoleForGeneralUser */
        INSERT INTO TB_CMM_ROLE_MENU (MENUID, ROLEID, MDFCN_DT, MDFRID, REG_DT, RGTRID)
        SELECT
            M.MENUID, R.ROLEID, NOW(), #{user.userid}, NOW(), #{user.userid}
        FROM
            TB_CMM_ROLE R CROSS JOIN TB_CMM_MENU M ON M.SITEID = #{siteid}
        WHERE 
            R.KND_CD = 'U'
        AND R.USE_YN = 'Y'
    </insert>
    
    <!-- 해당사이트 메뉴 역할 전체 삭제(초기화). -->
    <delete id="deleteRoleMenuForSiteMenuInit" parameterType="Integer">
        /* SiteDao.deleteRoleMenuForSiteMenuInit */
        DELETE 
            TB_CMM_ROLE_MENU
        FROM 
            TB_CMM_ROLE_MENU,
            (
            SELECT 
                MENUID
                FROM
                TB_CMM_MENU
                WHERE
                SITEID = #{siteid}
            ) B
        WHERE 
            TB_CMM_ROLE_MENU.MENUID = B.MENUID
    </delete>
    
    <!-- 해당사이트 메뉴 전체 삭제(초기화). -->
    <delete id="deleteMenuForSiteMenuInit" parameterType="Integer">
        /* SiteDao.deleteMenuForSiteMenuInit */
        DELETE FROM TB_CMM_MENU WHERE SITEID = #{siteid}
    </delete>
</mapper>