<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : RefndMngDaoImpl.xml
	Description : 교육 시설 환불관리 
-->
<mapper namespace="com.kbrainc.plum.mng.refndMng.model.RefndMngDao">

    <!-- 예약내역 목록 조회 -->
    <select id="selectRefndMngList" parameterType="ResveReqstVo" resultType="ResveReqstVo">
        /* RefndMngDao.selectRefndMngList */
        <include refid="PaginationMapper.header"/>
        SELECT
          A.APLYID
          ,A.APLY_DT
          ,A.STLM_STTS_CD
          ,A.APLY_STTS_CD
          ,A.APLCNTID
          ,A.APLCNT_NM
          ,A.AMT
          ,A.DPST_BANK_CD
          ,A.DPST_AMT
          ,A.RFND_DMND_AMT
          ,A.RFND_AMT
          ,A.RFND_REJECT_RSN_CD 
          ,A.MDFCN_DT
          ,A.DPST_IDNTY_DT
          ,A.RFND_DMND_DT
          ,C.INSTID
          ,C.INST_NM
          ,B.BGNG_DT
          ,B.END_DT
          ,B.ALLDAY_YN
          ,E.SPCE_NM
          ,F.FCLT_NM
          ,G.ACNT
          ,G.NM
          ,A.REG_DT
        FROM
          TB_FCL_SPCE_APLY A
          INNER JOIN (
              SELECT 
                  B.APLYID
                  , D.SPCEID
                  , MIN(D.BGNG_DT) AS BGNG_DT
                  , B.ALLDAY_YN
                  , CASE  WHEN B.ALLDAY_YN = 'N' THEN MAX(D.END_DT)
                          ELSE MAX(D.BGNG_DT) 
                    END AS END_DT
                FROM 
                  TB_FCL_APLY_RSVTDE B
                  LEFT JOIN TB_FCL_SPCE_RSVTDE D 
                  ON B.RSVTDEID = D.RSVTDEID
                GROUP BY APLYID
          ) B
          ON A.APLYID = B.APLYID
          INNER JOIN TB_FCL_SPCE E
          ON B.SPCEID = E.SPCEID
          INNER JOIN TB_FCL_FCLT F
          ON E.FCLTID = F.FCLTID
          INNER JOIN TB_CMM_INST C
          ON F.INSTID = C.INSTID
          LEFT OUTER JOIN TB_CMM_USER G ON A.APLCNTID = G.USERID
        WHERE 1=1
        <if test="stlmSttsCd != null and stlmSttsCd != ''">
            AND STLM_STTS_CD IN(#{stlmSttsCd})
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('spceNm')">
            AND E.SPCE_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('fcltNm')">
            AND F.FCLT_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('instNm')">
            AND C.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('acnt')">
            AND G.ACNT LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('aplcntNm')">
            AND A.APLCNT_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <if test="searchAplySttsCd != null and searchAplySttsCd != ''">
            AND A.APLY_STTS_CD = #{searchAplySttsCd}
        </if>
        <if test="searchStlmSttsCd != null and searchStlmSttsCd != ''">
            AND A.STLM_STTS_CD = #{searchStlmSttsCd}
        </if>
        <!-- 신청일 검색시작일  -->
        <if test="searchBgngDt != null and searchBgngDt != ''">
            AND B.BGNG_DT >= date(#{searchBgngDt})
        </if>
        <!-- 신청일 검색종료일  -->
        <if test="searchEndDt  != null and searchEndDt != ''">
            AND B.END_DT <![CDATA[<=]]> date(#{searchEndDt})
        </if>
        <!-- 타메뉴에서 상세 진입시  -->
        <if test="selectedApplyid  != null and selectedApplyid != ''">
            AND A.APLYID = #{selectedApplyid}
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 환불요청 취소 처리 -->
    <update id="updateRefndCancel" parameterType="ResveReqstVo" >
        /* RefndMngDao.updateResveCancel */
        UPDATE TB_FCL_SPCE_APLY A
          SET
            APLY_STTS_CD        = '160102' 
            ,STLM_STTS_CD       = '161102'
            ,DPST_IDNTY_DT      = NOW()
            ,RFND_REJECT_RSN_CD = #{rfndRejectRsnCd} 
            ,RFND_REJECT_RSN    = #{rfndRejectRsn}
            ,CNCL_DT            = NULL 
            ,CNCL_RSN_CD        = NULL 
            ,RFND_DMND_DT       = NULL 
            ,RFND_DE            = NULL
            ,RFND_AMT           = NULL
            ,RFND_DMND_AMT      = NULL 
            ,RFND_CMPTN_DT      = NULL 
            ,MDFRID             = #{user.userid}
            ,MDFCN_DT           = NOW()
        WHERE APLYID IN (
              <foreach item="aplyid" collection="aplyids" separator=",">
                 #{aplyid}
               </foreach>
              ) 
    </update>
    
    <!-- 환불 완료 처리 -->
    <update id="updateRefndComplete" parameterType="ResveReqstVo" >
        /* RefndMngDao.updateRefndComplete */
        UPDATE TB_FCL_SPCE_APLY SET
            RFND_DE            = #{rfndDe}
             ,RFND_AMT         = #{rfndAmt}
             ,APLY_STTS_CD     = '160103'
             ,STLM_STTS_CD     = '161104'
             ,RFND_BANK_CD     = #{rfndBankCd}
             ,RFND_BACNT       = #{rfndBacnt}
             ,RFND_PYR_NM      = #{rfndPyrNm}
             ,MDFCN_DT         = NOW()
             ,MDFRID           = #{user.userid}
        WHERE APLYID = #{aplyid}
    </update>
    
    <!-- 환불완료취소 처리 -->
    <update id="updateRefndRollback" parameterType="ResveReqstVo" >
        /* RefndMngDao.updateRefndRollback */
        UPDATE TB_FCL_SPCE_APLY SET
             STLM_STTS_CD      = '161103'
             ,CNCL_RSN_CD      = null
             ,RSVT_CNCL_RSN    = null
             ,RFND_REJECT_RSN  = null
             ,RFND_BANK_CD     = null
             ,RFND_BACNT       = null
             ,RFND_PYR_NM      = null
             ,MDFRID           = #{user.userid}
             ,MDFCN_DT         = NOW()
        WHERE APLYID IN (
               <foreach item="aplyid" collection="aplyids" separator=",">
                    #{aplyid}
                </foreach>
               ) 
    </update>
    
    <!-- 환불요청취소로 예약 승인 변경건중 예약이 없는 목록 호출 -->
    <select id="selectSuitableAplyids" parameterType="ResveReqstVo" resultType="String">
          /* RefndMngDao.selectSuitableAplyids */    
           SELECT 
               APLYID
               FROM (   
                SELECT
                   B.APLYID 
                   ,COUNT(C.RSVTDEID) AS OTHER_RESVE_CNT
                   ,group_concat(C.APLYID) AP_NM
                 FROM
                   TB_FCL_SPCE_APLY A 
                   LEFT JOIN TB_FCL_APLY_RSVTDE B
                   ON A.APLYID  = B.APLYID  
                   LEFT OUTER JOIN (
                       SELECT
                          A.RSVTDEID
                          ,A.APLYID
                         FROM
                           TB_FCL_APLY_RSVTDE A
                           INNER JOIN TB_FCL_SPCE_APLY B
                           ON A.APLYID  = B.APLYID
                           AND B.APLY_STTS_CD IN ('160101','160102')
                   )C ON B.RSVTDEID = C.RSVTDEID AND A.APLYID  != C.APLYID   
               WHERE 1=1 
                 AND A.APLYID IN (
                     <foreach item="aplyid" collection="aplyids" separator=",">
                        #{aplyid}
                      </foreach>
                     ) 
               GROUP BY A.APLYID
               ) A
             WHERE A.OTHER_RESVE_CNT <![CDATA[<=]]>0
     </select>
    
    
    
</mapper>