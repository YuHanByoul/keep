<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : BizRptDaoImpl.xml
    Description : 사업보고관리
-->
<mapper namespace="com.kbrainc.plum.mng.bizAply.bizRpt.model.BizRptDao">
    <!-- 중간보고관리 목록조회 조건-->
    <sql id="searchCondition1">
        <!-- 사업분야 -->
        <if test="searchFldCd != null and searchFldCd != '' ">
           AND A.FLD_CD = #{searchFldCd}
        </if>
            <!-- 공모명 -->
        <if test="searchPcntstNm != null and searchPcntstNm != '' ">
           AND A.PCNTST_NM LIKE CONCAT('%',#{searchPcntstNm},'%')
        </if>
            <!-- 중간보고 제출기간-시작일 -->
        <if test="searchBgngDt != null and searchBgngDt != ''">
            AND A.MDL_REPORT_BGNG_DT <![CDATA[>=]]> #{searchBgngDt}
        </if>
        <if test="searchEndDt != null and searchEndDt != ''">
            AND A.MDL_REPORT_END_DT <![CDATA[<]]> CAST(CONCAT(#{searchEndDt},' 23:59:59') AS DATETIME)
        </if>
            <!-- 진행상태 -->
        <if test="searchPrgrsSttsCd!= null and searchPrgrsSttsCd != '' ">
           AND #{searchPrgrsSttsCd} = CASE WHEN A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                                     WHEN A.MDL_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                                     THEN CASE WHEN A.MDL_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                                               WHEN A.MDL_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                                               ELSE ''
                                               END
                                     ELSE ''
                                END
        </if>
    </sql>

    <!-- 중간보고제출 목록조회 조건-->
    <sql id="searchCondition2">
            <!-- 제출상태 -->
        <if test="searchReportSttsCd != null and searchReportSttsCd != '' ">
            AND C.REPORT_STTS_CD = #{searchReportSttsCd}
        </if>
            <!-- 키워드.프로그램명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'prgrmNm'">
            AND A.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
            <!-- 키워드.기관명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'instNm'">
            AND A.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
            <!-- 키워드.사용자 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'userNm'">
            AND USR.NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
            <!-- 증빙서류 첨부 -->
        <if test="evdncDcmntYn != null and evdncDcmntYn != '' ">
            AND IF(C.ATCH_FILEGRPID IS NOT NULL, 'Y','N') = #{evdncDcmntYn}
        </if>
            <!-- 중간보고 제출기간-시작일 -->
        <if test="searchBgngDt != null and searchBgngDt != ''">
            AND C.REG_DT <![CDATA[>=]]> #{searchBgngDt}
        </if>
            <!-- 중간보고 제출기간-종료일 -->
        <if test="searchEndDt != null and searchEndDt != ''">
            AND C.REG_DT <![CDATA[<]]> CAST(CONCAT(#{searchEndDt},' 23:59:59') AS DATETIME)
        </if>
    </sql>

        <!-- 결과보고관리 목록조회 조건-->
    <sql id="searchCondition3">
        <!-- 사업분야 -->
        <if test="searchFldCd != null and searchFldCd != '' ">
           AND A.FLD_CD = #{searchFldCd}
        </if>
            <!-- 공모명 -->
        <if test="searchPcntstNm != null and searchPcntstNm != '' ">
           AND A.PCNTST_NM LIKE CONCAT('%',#{searchPcntstNm},'%')
        </if>
            <!-- 중간보고 제출기간-시작일 -->
        <if test="searchBgngDt != null and searchBgngDt != ''">
            AND A.RSLT_REPORT_BGNG_DT <![CDATA[>=]]> #{searchBgngDt}
        </if>
        <if test="searchEndDt != null and searchEndDt != ''">
            AND A.RSLT_REPORT_END_DT <![CDATA[<]]> CAST(CONCAT(#{searchEndDt},' 23:59:59') AS DATETIME)
        </if>
            <!-- 진행상태 -->
        <if test="searchPrgrsSttsCd!= null and searchPrgrsSttsCd != '' ">
           AND #{searchPrgrsSttsCd} = CASE WHEN A.RSLT_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                                     WHEN A.RSLT_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                                     THEN CASE WHEN A.RSLT_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                                               WHEN A.RSLT_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                                               ELSE ''
                                               END
                                     ELSE ''
                                END
        </if>
    </sql>

    <!-- 중간보고관리 목록조회 -->
    <select id="selectMdlRptMngList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectMdlRptMngList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.PCNTSTID
          , A.FLD_CD    /*분야 코드*/
          , A.PCNTST_NM    /*공모 이름*/
          ,''    /*진행 상태*/
          , A.MDL_REPORT_BGNG_DT    /*중간보고 시작일자*/
          , A.MDL_REPORT_END_DT    /*중간보고 종료일자*/
          , CONCAT(A.MDL_REPORT_BGNG_DT, '~', A.MDL_REPORT_END_DT)   AS MDL_REPORT_PRD
          , CASE WHEN A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                 WHEN A.MDL_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                 THEN CASE WHEN A.MDL_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                           WHEN A.MDL_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                           ELSE ''
                      END
                 ELSE ''
           END    AS PRGRS_STTS_CD    /*진행상태 코드*/
          , B.SLCTN_BIZ_CNT    /*선정 사업*/
          , CONCAT(B.REPORT_CNT, "/", B.SLCTN_BIZ_CNT)    AS SBMSN_CNT /*제출 건수*/
          , A.CNSLTNG_USE_CD    /*컨설팅 대상*/
          , A.REG_DT
          , IF(A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW(), '-',B.CNSLTNG_USE_CNT)    AS CNSLTNG_USE_CNT    /*컨설팅 대상 건수*/
        FROM
            TB_SPB_PCNTST A
        LEFT OUTER JOIN
        (
            SELECT
                COUNT(A.APLYID)    AS SLCTN_BIZ_CNT
              , A.PCNTSTID
              /* 보고구분코드 : 중간보고, 보고상태코드 : 제출완료 */
              , COUNT(IF(B.REPORT_SE_CD = #{reportSeCd} AND B.REPORT_STTS_CD <![CDATA[<>]]> '203101' ,1,NULL))    AS REPORT_CNT
              , COUNT(C.APLYID_CNT)    AS CNSLTNG_USE_CNT
            FROM
                TB_SPB_APLY A
            LEFT OUTER JOIN
                TB_SPB_REPORT B ON A.APLYID =B.APLYID
            LEFT OUTER JOIN    /*컨설팅*/
            (
                SELECT
                    COUNT(1) APLYID_CNT
                  , APLYID
                FROM
                    TB_SPB_APLY_CNSLTNG
                GROUP BY
                    APLYID
            ) C ON B.APLYID = C.APLYID
            WHERE
                A.SLCTN_STTS_CD = '193102'    /* 선정 상태 코드 : 선정*/
            GROUP BY
                A.PCNTSTID
        ) B ON A.PCNTSTID = B.PCNTSTID
        WHERE 1=1
        <include refid="searchCondition1"/>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 중간보고관리 목록조회 (엑셀)-->
    <select id="selectMdlRptMngListExcel" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectMdlRptMngListExcel */
        SELECT
            A.PCNTSTID
          , A.FLD_CD    /*분야 코드*/
          , A.PCNTST_NM    /*공모 이름*/
          ,''    /*진행 상태*/
          , A.MDL_REPORT_BGNG_DT    /*중간보고 시작일자*/
          , A.MDL_REPORT_END_DT    /*중간보고 종료일자*/
          , CONCAT(A.MDL_REPORT_BGNG_DT, '~', A.MDL_REPORT_END_DT)   AS MDL_REPORT_PRD
          , CASE WHEN A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                 WHEN A.MDL_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                 THEN CASE WHEN A.MDL_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                           WHEN A.MDL_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                           ELSE ''
                      END
                 ELSE ''
           END    AS PRGRS_STTS_CD    /*진행상태 코드*/
          , B.SLCTN_BIZ_CNT    /*선정 사업*/
          , CONCAT(B.REPORT_CNT, "/", B.SLCTN_BIZ_CNT)    AS SBMSN_CNT /*제출 건수*/
          , A.CNSLTNG_USE_CD    /*컨설팅 대상*/
          , A.REG_DT
          , IF(A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW(), '-',B.CNSLTNG_USE_CNT)    AS CNSLTNG_USE_CNT    /*컨설팅 대상 건수*/
        FROM
            TB_SPB_PCNTST A
        LEFT OUTER JOIN
        (
            SELECT
                COUNT(A.APLYID)    AS SLCTN_BIZ_CNT
              , A.PCNTSTID
              /* 보고구분코드 : 중간보고, 보고상태코드 : 제출완료 */
              , COUNT(IF(B.REPORT_SE_CD = '204101' AND B.REPORT_STTS_CD <![CDATA[<>]]> '203101' ,1,NULL))    AS REPORT_CNT
              , COUNT(C.APLYID_CNT)    AS CNSLTNG_USE_CNT
            FROM
                TB_SPB_APLY A
            LEFT OUTER JOIN
                TB_SPB_REPORT B ON A.APLYID =B.APLYID
            LEFT OUTER JOIN    /*컨설팅*/
            (
                SELECT
                    COUNT(1) APLYID_CNT
                  , APLYID
                FROM
                    TB_SPB_APLY_CNSLTNG
                GROUP BY
                    APLYID
            ) C ON B.APLYID = C.APLYID
            WHERE
                A.SLCTN_STTS_CD = '193102'    /* 선정 상태 코드 : 선정*/
            GROUP BY
                A.PCNTSTID
        ) B ON A.PCNTSTID = B.PCNTSTID
        WHERE 1=1
        <include refid="searchCondition1"/>
    </select>

    <!-- 중간보고관리 상세조회 -->
    <select id="selectMdlRptMng" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectMdlRptMng */
        SELECT
            A.PCNTSTID
          , A.FLD_CD    /*분야 코드*/
          , A.PCNTST_NM    /*공모 이름*/
          ,''    /*진행 상태*/
          , A.MDL_REPORT_BGNG_DT    /*중간보고 시작일자*/
          , A.MDL_REPORT_END_DT    /*중간보고 종료일자*/
          , CONCAT(A.MDL_REPORT_BGNG_DT, '~', A.MDL_REPORT_END_DT)   AS MDL_REPORT_PRD
          , CASE WHEN A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                 WHEN A.MDL_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                 THEN CASE WHEN A.MDL_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                           WHEN A.MDL_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                           ELSE ''
                      END
                 ELSE ''
           END    AS PRGRS_STTS_CD    /*진행상태 코드*/
          , B.SLCTN_BIZ_CNT    /*선정 사업*/
          , CONCAT(B.REPORT_CNT, "/", B.SLCTN_BIZ_CNT)    AS SBMSN_CNT /*제출 건수*/
          , A.CNSLTNG_USE_CD    /*컨설팅 대상*/
          , A.REG_DT
          , IF(A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW(), '-',B.CNSLTNG_USE_CNT)    AS CNSLTNG_USE_CNT    /*컨설팅 대상 건수*/
        FROM
            TB_SPB_PCNTST A
        LEFT OUTER JOIN
        (
            SELECT
                COUNT(A.APLYID)    AS SLCTN_BIZ_CNT
              , A.PCNTSTID
              /* 보고구분코드 : 중간보고, 보고상태코드 : 제출완료 */
              , COUNT(IF(B.REPORT_SE_CD = '204101' AND B.REPORT_STTS_CD <![CDATA[<>]]> '203101' ,1,NULL))    AS REPORT_CNT
              , COUNT(C.APLYID_CNT)    AS CNSLTNG_USE_CNT
            FROM
                TB_SPB_APLY A
            LEFT OUTER JOIN
                TB_SPB_REPORT B ON A.APLYID =B.APLYID
            LEFT OUTER JOIN    /*컨설팅*/
            (
                SELECT
                    COUNT(1) APLYID_CNT
                  , APLYID
                FROM
                    TB_SPB_APLY_CNSLTNG
                GROUP BY
                    APLYID
            ) C ON B.APLYID = C.APLYID
            WHERE
                A.SLCTN_STTS_CD = '193102'    /* 선정 상태 코드 : 선정*/
            GROUP BY
                A.PCNTSTID
        ) B ON A.PCNTSTID = B.PCNTSTID
        WHERE 1=1
        AND
            A.PCNTSTID = #{pcntstid}
    </select>

    <!-- 중간보고제출 목록조회 -->
    <select id="selectRptSbmsnList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectRptSbmsnList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.APLYID
          , A.CNSLTNG_TRGT_CN
<!--           , B.DELVRY_APLYID -->
<!--           , B.DELVRYID -->
          , C.REPORTID
          , A.APLYNO AS RCPTNO            /*접수번호*/
          , C.REPORT_STTS_CD    /*제출(보고)상태*/
          , A.INST_NM           /*기관명*/
          , A.USERID
          , CONCAT(USR.NM,"(",USR.ACNT ,")")    AS USER_NM_ACNT /*신청자 명(ID)*/
          , A.PRGRM_NM
          , IF(C.REG_DT IS NULL,'-',C.REG_DT )    AS SBMSN_DT
          , IF(C.REPORTID IS NULL, '-', IF(C.ATCH_FILEGRPID IS NULL, '미첨부','첨부'))    AS EVDNC_DCMNT_YN
          , ''    AS CNSLTNG_USE    /*컨설팅 여부*/
          , C.REPORT_SE_CD    /*보고서 구분 코드*/
          , C.REG_DT
          , IF(IFNULL(A.CNSLTNG_TRGT_CN,'' ) = '','N','Y')    AS CNSLTNG_TRGT_YN
        FROM
            TB_SPB_APLY A
<!--         LEFT OUTER JOIN TB_SPB_DELVRY_APLY B  ON A.APLYID = B.APLYID -->
        LEFT OUTER JOIN TB_SPB_REPORT C ON A.APLYID = C.APLYID
        LEFT OUTER JOIN TB_CMM_USER USR ON A.USERID = USR.USERID
        WHERE 1=1
        AND A.PCNTSTID = #{pcntstid}
        AND C.REPORT_SE_CD = #{reportSeCd}
        <include refid="searchCondition2"/>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 중간보고제출 목록조회(엑셀) -->
    <select id="selectRptSbmsnListExcel" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectRptSbmsnListExcel */
        SELECT
            A.APLYID
<!--           , B.DELVRY_APLYID -->
<!--           , B.DELVRYID -->
          , C.REPORTID
          , A.APLYNO AS RCPTNO            /*접수번호*/
          , C.REPORT_STTS_CD    /*제출(보고)상태*/
          , A.INST_NM           /*기관명*/
          , A.USERID
          , CONCAT(USR.NM,"(",USR.ACNT ,")")    AS USER_NM_ACNT /*신청자 명(ID)*/
          , A.PRGRM_NM
          , IF(C.REG_DT IS NULL,'-',C.REG_DT )    AS SBMSN_DT
          , IF(C.REPORTID IS NULL, '-', IF(C.ATCH_FILEGRPID IS NULL, '미첨부','첨부'))    AS EVDNC_DCMNT_YN
          , ''    AS CNSLTNG_USE    /*컨설팅 여부*/
          , C.REPORT_SE_CD    /*보고서 구분 코드*/
          , C.REG_DT
          , IF(A.CNSLTNG_TRGT_CN IS NOT NULL,'Y','N')    AS CNSLTNG_TRGT_YN
        FROM
            TB_SPB_APLY A
<!--         LEFT OUTER JOIN TB_SPB_DELVRY_APLY B  ON A.APLYID = B.APLYID -->
        LEFT OUTER JOIN TB_SPB_REPORT C ON A.APLYID = C.APLYID
        LEFT OUTER JOIN TB_CMM_USER USR ON A.USERID = USR.USERID
        WHERE 1=1
        AND A.PCNTSTID = #{pcntstid}
        AND C.REPORT_SE_CD = #{reportSeCd}
        <include refid="searchCondition2"/>
    </select>

    <!-- 보고 제출 처리 상태코드 수정 -->
    <update id="updateRptSttsCd" >
        /* BizRptDao.updateRptSttsCd */
        UPDATE TB_SPB_REPORT SET
            REPORT_STTS_CD = '203106'    /*제출상태코드 : 완료*/
          , MDFCN_DT = NOW()
          , MDFRID   = #{user.userid}
        WHERE REPORTID IN
        <foreach item="item" collection="reportids" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </update>

    <!-- 보고상태코드 수정 -->
    <update id="updateReportSttsCd" >
        /* BizRptDao.updateReportSttsCd*/
        UPDATE TB_SPB_REPORT SET
            REPORT_STTS_CD = #{reportSttsCd}    /*제출상태코드 : 완료*/
          , MDFCN_DT = NOW()
          , MDFRID   = #{user.userid}
        WHERE REPORTID = #{reportid}
    </update>

    <!-- 중간보고제출 상세 조회 -->
    <select id="selectMdlRptSbmsnDetail" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectMdlRptSbmsnDetail */
        SELECT
            B.APLYID
<!--           , C.DELVRY_APLYID -->
<!--           , C.DELVRYID -->
          , A.REPORTID
          , B.APLYNO AS RCPTNO            /*접수번호*/
          , B.INST_NM           /*기관명*/
          , B.PRGRM_NM
          , CONCAT(USR.NM,"(",USR.ACNT ,")")    AS USER_NM_ACNT /*신청자 명(ID)*/
          /* TB_ASS_REPORT 테이블로 변경
          , D.EDU_TRGT
          , D.ESSNTL_SBJCT_NM
          */
          , A.TRGT
          , A.SBJCT
          , A.REG_DT
          , A.REPORT_STTS_CD    /*제출(보고)상태*/
          , A.ETC_CN
          , A.ATCH_FILEGRPID
          , B.CNSLTNG_TRGT_CN   /*컨설팅 대상 내용*/
          , E.CNSLTNGID
          , E.RSLT
        FROM
            TB_SPB_REPORT A
        INNER JOIN TB_SPB_APLY B ON A.APLYID = B.APLYID
        LEFT OUTER JOIN TB_CMM_USER USR ON B.USERID = USR.USERID
<!--         LEFT OUTER JOIN TB_SPB_DELVRY_APLY C ON B.APLYID = C.APLYID -->
        LEFT OUTER JOIN TB_SPB_PRGRM D ON B.APLYID = D.APLYID
        LEFT OUTER JOIN TB_SPB_APLY_CNSLTNG E ON A.APLYID = E.CNSLTNGID
        WHERE 1=1
        AND A.REPORTID = #{reportid}
    </select>

    <!-- 보고운영목록 조회 -->
    <select id="selectReportOperList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectReportOperList*/
        SELECT
            OPERID
          , REPORTID
          , SE_CD
          , BGNG_DE
          , END_DE
          , RND
          , NOPE
          , MNT
          , RMRK
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
          , SUM(RND) OVER (PARTITION BY REPORTID)          AS SUM_RND
          , SUM(NOPE) OVER (PARTITION BY REPORTID)         AS SUM_NOPE
          , SUM(MNT) OVER (PARTITION BY REPORTID)          AS SUM_MNT
          , SUM(IF(SE_CD = '209101',1,0)) OVER (PARTITION BY REPORTID)    AS PLAN_CNT
          , SUM(IF(SE_CD = '209102',1,0)) OVER (PARTITION BY REPORTID)    AS NOW_CNT
        FROM
            TB_SPB_REPORT_OPER
        WHERE REPORTID = #{reportid}
        ORDER BY OPERID
    </select>


    <!-- 심사위원 그룹 조회 -->
    <select id="selectMngGrpList" parameterType="BizRptVo" resultType="BizRptVo">
        /* PublicContestDao.selectMngGrpList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.GRPID
            , A.GRP_NM
            , A.REG_DT
            , COUNT(B.USERID) AS EXPRT_CNT
            , group_concat(C.NM) AS GRP_EXPRT_NM
            , group_concat(C.USERID) AS GRP_EXPRT_IDS
            , group_concat(concat(C.USERID,',',C.NM,'(',C.ACNT,') | ',C.EML,' | ',C.MOBLPHON) SEPARATOR ':' ) AS GRP_EXPRT_STR
        FROM TB_SPB_JDGS_GRP A
        LEFT OUTER JOIN TB_SPB_JDGS_GRP_MAPNG B ON A.GRPID = B.GRPID
        LEFT OUTER JOIN TB_CMM_USER C ON B.USERID = C.USERID
        WHERE 1 = 1
        <if test="searchGrpNm != null and searchGrpNm != '' ">
        AND A.GRP_NM LIKE CONCAT('%',#{searchGrpNm},'%')
        </if>
        GROUP BY A.GRPID
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 보고보완 목록 조회 -->
    <select id="selectSplmntDmndList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectSplmntDmndList*/
        <include refid="PaginationMapper.header"/>
        SELECT
            A.SPLMNTID
          , A.REPORTID
          , A.ANS_STTS_CD  /* 상태     */
          , A.DMND_CN      /* 요청내용 */
          , A.DMND_DT      /* 요청일   */
          , IF(A.ANS_DT IS NULL, '-', A.ANS_DT)    AS ANS_DT /* 완료처리 */
          , A.ANS_CN       /* 완료내용 */
        FROM
            TB_SPB_REPORT_SPLMNT A
        WHERE A.REPORTID = #{reportid}
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 보고보완 조회 -->
    <select id="selectSplmntDmnd" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectSplmntDmndList*/
        SELECT
            A.SPLMNTID
          , A.REPORTID
          , A.ANS_STTS_CD  /* 상태     */
          , A.DMND_CN      /* 요청내용 */
          , A.DMND_DT      /* 요청일   */
          , A.ANS_DT       /* 완료처리 */
          , A.ANS_CN       /* 완료내용 */
        FROM
            TB_SPB_REPORT_SPLMNT A
        WHERE A.SPLMNTID = #{splmntid}
    </select>

    <!-- 보고보완 등록-->
    <insert id="insertRptSplmnt" parameterType="BizRptVo">
        /* BizRptDao.insertRptSplmnt*/
        INSERT INTO TB_SPB_REPORT_SPLMNT (
            REPORTID
          , ANS_STTS_CD  /* 상태     */
          , DMND_CN      /* 요청내용 */
          , RQSTRID
          , DMND_DT      /* 요청일   */
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        )VALUES(
            #{reportid }
          , #{ansSttsCd}   /* 상태     */
          , #{dmndCn   }   /* 요청내용 */
          , #{user.userid}
          , NOW()          /* 요청일   */
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        )

    </insert>

    <!-- 결과보고관리 목록조회 -->
    <select id="selectRsltRptMngList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectRsltRptMngList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.PCNTSTID
          , A.FLD_CD    /*분야 코드*/
          , A.PCNTST_NM    /*공모 이름*/
          ,''    /*진행 상태*/
          , A.RSLT_REPORT_BGNG_DT   /*결과보고 시작일자*/
          , A.RSLT_REPORT_END_DT    /*결과보고 종료일자*/
          , CONCAT(A.RSLT_REPORT_BGNG_DT, '~', A.RSLT_REPORT_END_DT)   AS RSLT_REPORT_PRD
          , CASE WHEN A.RSLT_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                 WHEN A.RSLT_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                 THEN CASE WHEN A.RSLT_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                           WHEN A.RSLT_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                           ELSE ''
                      END
                 ELSE ''
           END    AS PRGRS_STTS_CD    /*진행상태 코드*/
          , B.SLCTN_BIZ_CNT    /*선정 사업*/
          , CONCAT(B.REPORT_CNT, "/", B.SLCTN_BIZ_CNT)    AS SBMSN_CNT /*제출 건수*/
          , A.CNSLTNG_USE_CD    /*컨설팅 대상*/
          , A.REG_DT
          , IF(A.RSLT_REPORT_BGNG_DT <![CDATA[<]]>  NOW(), '-',B.CNSLTNG_USE_CNT)    AS CNSLTNG_USE_CNT    /*컨설팅 대상 건수*/
        FROM
            TB_SPB_PCNTST A
        LEFT OUTER JOIN
        (
            SELECT
                COUNT(A.APLYID)    AS SLCTN_BIZ_CNT
              , A.PCNTSTID
              /* 보고구분코드 : 중간보고, 보고상태코드 : 제출완료 */
              , COUNT(IF(B.REPORT_SE_CD = #{reportSeCd} AND B.REPORT_STTS_CD <![CDATA[<>]]> '203101' ,1,NULL))    AS REPORT_CNT
              , COUNT(C.APLYID_CNT)    AS CNSLTNG_USE_CNT
            FROM
                TB_SPB_APLY A
            LEFT OUTER JOIN
                TB_SPB_REPORT B ON A.APLYID =B.APLYID
            LEFT OUTER JOIN    /*컨설팅*/
            (
                SELECT
                    COUNT(1) APLYID_CNT
                  , APLYID
                FROM
                    TB_SPB_APLY_CNSLTNG
                GROUP BY
                    APLYID
            ) C ON B.APLYID = C.APLYID
            WHERE
                A.SLCTN_STTS_CD = '193102'    /* 선정 상태 코드 : 선정*/
            GROUP BY
                A.PCNTSTID
        ) B ON A.PCNTSTID = B.PCNTSTID
        WHERE 1=1
        <include refid="searchCondition3"/>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 결과보고관리 목록조회 (엑셀)-->
    <select id="selectRsltRptMngListExcel" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectRsltRptMngListExcel*/
        SELECT
            A.PCNTSTID
          , A.FLD_CD    /*분야 코드*/
          , A.PCNTST_NM    /*공모 이름*/
          ,''    /*진행 상태*/
          , A.RSLT_REPORT_BGNG_DT    /*결과보고 시작일자*/
          , A.RSLT_REPORT_END_DT    /*결과보고 종료일자*/
          , CONCAT(A.RSLT_REPORT_BGNG_DT, '~', A.RSLT_REPORT_END_DT)   AS RSLT_REPORT_PRD
          , CASE WHEN A.RSLT_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                 WHEN A.RSLT_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                 THEN CASE WHEN A.RSLT_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                           WHEN A.RSLT_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                           ELSE ''
                      END
                 ELSE ''
           END    AS PRGRS_STTS_CD    /*진행상태 코드*/
          , B.SLCTN_BIZ_CNT    /*선정 사업*/
          , CONCAT(B.REPORT_CNT, "/", B.SLCTN_BIZ_CNT)    AS SBMSN_CNT /*제출 건수*/
          , A.CNSLTNG_USE_CD    /*컨설팅 대상*/
          , A.REG_DT
          , IF(A.RSLT_REPORT_BGNG_DT <![CDATA[<]]>  NOW(), '-',B.CNSLTNG_USE_CNT)    AS CNSLTNG_USE_CNT    /*컨설팅 대상 건수*/
        FROM
            TB_SPB_PCNTST A
        LEFT OUTER JOIN
        (
            SELECT
                COUNT(A.APLYID)    AS SLCTN_BIZ_CNT
              , A.PCNTSTID
              /* 보고구분코드 : 결과보고, 보고상태코드 : 제출완료 */
              , COUNT(IF(B.REPORT_SE_CD = '204102' AND B.REPORT_STTS_CD <![CDATA[<>]]> '203101' ,1,NULL))    AS REPORT_CNT
              , COUNT(C.APLYID_CNT)    AS CNSLTNG_USE_CNT
            FROM
                TB_SPB_APLY A
            LEFT OUTER JOIN
                TB_SPB_REPORT B ON A.APLYID =B.APLYID
            LEFT OUTER JOIN    /*컨설팅*/
            (
                SELECT
                    COUNT(1) APLYID_CNT
                  , APLYID
                FROM
                    TB_SPB_APLY_CNSLTNG
                GROUP BY
                    APLYID
            ) C ON B.APLYID = C.APLYID
            WHERE
                A.SLCTN_STTS_CD = '193102'    /* 선정 상태 코드 : 선정*/
            GROUP BY
                A.PCNTSTID
        ) B ON A.PCNTSTID = B.PCNTSTID
        WHERE 1=1
        <include refid="searchCondition3"/>
    </select>

    <!-- 결과보고 상세조회 -->
    <select id="selectRsltRptMng" resultType="BizRptVo">
        /* BizRptDao.selectRsltRptMng*/
        SELECT
            A.PCNTSTID
          , A.FLD_CD    /*분야 코드*/
          , A.PCNTST_NM    /*공모 이름*/
          ,''    /*진행 상태*/
          , A.RSLT_REPORT_BGNG_DT    /*결과보고 시작일자*/
          , A.RSLT_REPORT_END_DT    /*결과보고 종료일자*/
          , CONCAT(A.RSLT_REPORT_BGNG_DT, '~', A.RSLT_REPORT_END_DT)   AS RSLT_REPORT_PRD
          , CASE WHEN A.RSLT_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                 WHEN A.RSLT_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                 THEN CASE WHEN A.RSLT_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                           WHEN A.RSLT_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                           ELSE ''
                      END
                 ELSE ''
           END    AS PRGRS_STTS_CD    /*진행상태 코드*/
          , B.SLCTN_BIZ_CNT    /*선정 사업*/
          , CONCAT(B.REPORT_CNT, "/", B.SLCTN_BIZ_CNT)    AS SBMSN_CNT /*제출 건수*/
          , A.CNSLTNG_USE_CD    /*컨설팅 대상*/
          , A.REG_DT
          , IF(A.RSLT_REPORT_BGNG_DT <![CDATA[<]]>  NOW(), '-',B.CNSLTNG_USE_CNT)    AS CNSLTNG_USE_CNT    /*컨설팅 대상 건수*/
        FROM
            TB_SPB_PCNTST A
        LEFT OUTER JOIN
        (
            SELECT
                COUNT(A.APLYID)    AS SLCTN_BIZ_CNT
              , A.PCNTSTID
              /* 보고구분코드 : 결과보고, 보고상태코드 : 제출완료 */
              , COUNT(IF(B.REPORT_SE_CD = '204102' AND B.REPORT_STTS_CD <![CDATA[<>]]> '203101' ,1,NULL))    AS REPORT_CNT
              , COUNT(C.APLYID_CNT)    AS CNSLTNG_USE_CNT
            FROM
                TB_SPB_APLY A
            LEFT OUTER JOIN
                TB_SPB_REPORT B ON A.APLYID =B.APLYID
            LEFT OUTER JOIN    /*컨설팅*/
            (
                SELECT
                    COUNT(1) APLYID_CNT
                  , APLYID
                FROM
                    TB_SPB_APLY_CNSLTNG
                GROUP BY
                    APLYID
            ) C ON B.APLYID = C.APLYID
            WHERE
                A.SLCTN_STTS_CD = '193102'    /* 선정 상태 코드 : 선정*/
            GROUP BY
                A.PCNTSTID
        ) B ON A.PCNTSTID = B.PCNTSTID
        WHERE 1=1
        AND A.PCNTSTID = #{pcntstid}

    </select>

    <!-- 중간보고제출 목록조회(엑셀)
    <select id="selectRsltRptSbmsnListExcel" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectRsltRptSbmsnListExcel */
        SELECT
            A.APLYID
          , B.DELVRY_APLYID
          , B.DELVRYID
          , C.REPORTID
          , B.RCPTNO            /*접수번호*/
          , C.REPORT_STTS_CD    /*제출(보고)상태*/
          , A.INST_NM           /*기관명*/
          , A.USERID
          , CONCAT(USR.NM,"(",USR.ACNT ,")")    AS USER_NM_ACNT /*신청자 명(ID)*/
          , A.PRGRM_NM
          , IF(C.REG_DT IS NULL,'-',C.REG_DT )    AS SBMSN_DT
          , IF(C.REPORTID IS NULL, '-', IF(C.ATCH_FILEGRPID IS NULL, '미첨부','첨부'))    AS EVDNC_DCMNT_YN
          , ''    AS CNSLTNG_USE    /*컨설팅 여부*/
          , C.REPORT_SE_CD    /*보고서 구분 코드*/
          , C.REG_DT
          , IF(A.CNSLTNG_TRGT_CN IS NOT NULL,'Y','N')    AS CNSLTNG_TRGT_YN
        FROM
            TB_SPB_APLY A
        LEFT OUTER JOIN TB_SPB_DELVRY_APLY B  ON A.APLYID = B.APLYID
        LEFT OUTER JOIN TB_SPB_REPORT C ON A.APLYID = C.APLYID
        LEFT OUTER JOIN TB_CMM_USER USR ON A.USERID = USR.USERID
        WHERE 1=1
        AND A.PCNTSTID = #{pcntstid}
        AND C.REPORT_SE_CD = #{reportSeCd}
        <include refid="searchCondition2"/>
    </select>
-->


    <!-- 컨설팅 담당자 목록 조회 -->
    <select id="selectCnsltngExprtList" resultType="BizRptVo">
        /* BizAplySrngDaoImpl.selectCnsltngExprtList */
        SELECT
          A.USERID
          , B.NM
        FROM
           TB_ASS_EXPRT A
           INNER JOIN TB_CMM_USER B
           ON A.USERID = B.USERID
           LEFT OUTER JOIN (
               SELECT
                   A.USERID
                   ,GROUP_CONCAT(CRTFCT_NM) AS CRTFCT_NM
                FROM
                   TB_ASS_EXPRT_CRTFCT A
               GROUP BY A.USERID
           ) C
           ON A.USERID = C.USERID
           LEFT OUTER JOIN (
               SELECT
                  A.USERID
                  ,GROUP_CONCAT(B.SIGNGU_NM) AS RGN_NM
                  -- ,GROUP_CONCAT(A.RGN_CD) AS RGN_CD
                  ,GROUP_CONCAT(DISTINCT B.CTPRVN_CD)AS RGN_CD
                 FROM
                  TB_ASS_EXPRT_ACTVT_SCOPE A
                  INNER JOIN TB_CMM_ADDR_SIGNGU B
                  ON A.RGN_CD  = B.SIGNGU_CD
                  GROUP BY A.USERID
           )D ON A.USERID = D.USERID
           LEFT OUTER JOIN (
                SELECT
                   A.USERID
                  ,GROUP_CONCAT(B.CD_NM) AS SBJCT_NM
                  ,GROUP_CONCAT(B.CD) AS SBJCT_CD
                 FROM
                  TB_ASS_EXPRT_SBJCT A
                  INNER JOIN TB_CMM_CD B
                  ON A.SBJCT_CD  =B.CD
                 GROUP BY A.USERID
           )E ON A.USERID = E.USERID
         WHERE 1=1
         ORDER BY B.NM
    </select>

    <sql id="selectCnsltngMngList">
        SELECT
            A.CNSLTNGID
          , A.APLYID
          , A.CNSTNTID
          , USR.NM       /*컨설턴트 이름*/
          , C.FLD_CD     /*사업분야*/
          , C.PCNTST_NM  /*공모명*/
          , B.PRGRM_NM   /*프로그램명*/
          , A.VST_DT     /*방문일시*/
          , CASE WHEN VST_DT > NOW() THEN '컨설팅전'
                  WHEN VST_DT <![CDATA[<]]> NOW() THEN '컨설팅완료'/*상태*/
                  ELSE ''
            END    AS CNSLTNG_STTS_NM
        FROM
            TB_SPB_APLY_CNSLTNG A
        INNER JOIN TB_SPB_APLY B ON A.APLYID = B.APLYID
        INNER JOIN TB_SPB_PCNTST C ON B.PCNTSTID = B.PCNTSTID
        INNER JOIN TB_CMM_USER USR ON A.CNSTNTID = USR.USERID
        WHERE 1=1
        <!-- 컨설턴트 ID -->
        <if test="searchUserid = null and searchUserid != '' ">
            A.CNSTNTID =  #{searchUserid}
        </if>
        <!-- 사업분야 -->
        <if test="searchFldCd != null and searchFldCd != '' ">
           AND C.FLD_CD = #{searchFldCd}
        </if>
        <!-- 키워드.공모명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'pcntstNm'">
            AND C.PCNTST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 키워드.프로그램명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'prgrmNm'">
            AND B.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 상태 -->
        <if test="searchSttsCd != null and searchSttsCd == 'before' ">
            AND A.VST_DT > NOW()
        </if>
        <if test="searchSttsCd != null and searchSttsCd == 'after' ">
            AND A.VST_DT <![CDATA[<]]> NOW()
        </if>
        GROUP BY CNSLTNGID
        ORDER BY A.VST_DT DESC , USR.NM ,A.REG_DT
    </sql>

    <!-- 컨설팅관리 목록조회 -->
    <select id="selectCnsltngMngList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectCnsltngMngList */
        <include refid="PaginationMapper.header"/>
        <include refid="selectCnsltngMngList"/>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 컨설팅관리 목록 엑셀 조회 -->
    <select id="selectCnsltngMngExcelList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectCnsltngMngExcelList */
        <include refid="selectCnsltngMngList"/>
    </select>


    <!-- 컨설팅관리 상세조회 -->
    <select id="selectCnsltngMng" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectCnsltngMng */
        SELECT
            A.CNSLTNGID
          , A.APLYID
          , A.CNSTNTID
          , D.RCPTNO            /*접수번호*/
          , B.INST_NM           /*기관명*/
          , B.PRGRM_NM          /*프로그램명*/
          , B.USERID            /*신청자 ID*/
          , CONCAT(B.APLCNT_NM,'(', USR.ACNT, ')')    AS USER_NM_ACNT
          , B.APLCNT_NM         /*신청자*/
          , B.APLCNT_TELNO      /*신청자 연착처*/
          , B.APLCNT_EML        /*신청자 이메일*/
          , B.INST_SAREA_CD     /*기관권역코드*/
          , B.RGN_CD            /*지역코드*/
          , CTPRVN.CTPRVN_NM    AS RGN_CD_NM    /*지역코명*/
          , E.EDU_TRGT          /*교육대상*/
          , E.ESSNTL_SBJCT_NM   /*교육주제*/
          , B.INST_ZIP          /*주소 ZIP*/
          , B.INST_ADDR         /*주소 */
          , B.INST_ADDR_DTL     /*상세주소*/
          , A.VST_DT            /*방문일시*/
          , A.CN_BFR            /*사전*/
          , A.CN_AFTR           /*사후*/
          , A.RSLT              /*종합의견*/
          , A.ATCH_FILEGRPID
        FROM
            TB_SPB_APLY_CNSLTNG A
        INNER JOIN TB_SPB_APLY B ON A.APLYID = B.APLYID
        LEFT OUTER JOIN TB_SPB_DELVRY_APLY D ON B.APLYID =D.APLYID
        LEFT OUTER JOIN TB_SPB_PRGRM E ON B.APLYID = E.APLYID
        LEFT OUTER JOIN TB_CMM_USER USR ON A.CNSTNTID = USR.USERID
        LEFT OUTER JOIN TB_CMM_ADDR_CTPRVN CTPRVN ON B.RGN_CD = CTPRVN.CTPRVN_CD
        WHERE 1=1
        AND A.CNSLTNGID = #{cnsltngid}
<!--         AND B.APLYID = #{aplyid} -->

    </select>

    <!-- 컨설팅관리 등록-->
    <insert id="insertCnsltngMng" parameterType="BizRptVo">
        /* BizRptDao.insertCnsltngMng*/
        INSERT INTO TB_SPB_APLY_CNSLTNG
        (
            APLYID
          , CNSTNTID
          , VST_DT
          , RSLT
          , CN_BFR
          , CN_AFTR
          , ATCH_FILEGRPID
          , WRT_DT
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES
        (
            #{aplyid       }
          , #{cnstntid     }
          , #{vstDt        }
          , #{rslt         }
          , #{cnBfr        }
          , #{cnAftr       }
          , #{atchFilegrpid}
          , NOW()
          , NOW()
          , #{user.userid  }
          , NOW()
          , #{user.userid  }
        )
    </insert>

    <!-- 컨설팅관리 수정-->
    <update id="updateCnsltngMng" parameterType="BizRptVo">
        /* BizRptDao.updateCnsltngMng*/
        UPDATE
            TB_SPB_APLY_CNSLTNG
        SET
            VST_DT         = #{vstDt        }
          , RSLT           = #{rslt         }
          , CN_BFR         = #{cnBfr        }
          , CN_AFTR        = #{cnAftr       }
          , ATCH_FILEGRPID = #{atchFilegrpid}
          , WRT_DT         = NOW()
          , MDFCN_DT       = NOW()
          , MDFRID         = #{user.userid  }
          , REG_DT         = NOW()
          , RGTRID         = #{user.userid  }
        WHERE
            CNSLTNGID = #{cnsltngid}
    </update>

    <!--# 사업포기관리 #############################-->

    <!-- 사업포기관리 목록 조회-->
        <sql id="selectBizAbndMngListSql">
             SELECT
                A.APLYID
              , B.PCNTSTID  
              , Z.DMNDID
              , Z.RTURN_BGNG_DE
              , Z.RTURN_END_DE
              , Z.INSTID
              , Z.CN
              , Z.DMND_STTS_CD
              , B.FLD_CD          /* 사업분야 */
              , B.PCNTST_NM       /* 공모명 */
              , A.PRGRM_NM        /* 프로그램명/동아리명*/
              , A.BSNS_CNCL_YN    /* 상태 */
              , A.INST_NM         /* 기관명 */
              , CONCAT(A.APLCNT_NM,'(', USR.ACNT, ')')    AS USER_NM_ACNT    /*신청자 명(ID)*/
              , Z.CNCL_DT
              , A.REG_DT
            FROM TB_SPB_BSNS_CNCL_DMND Z
            INNER JOIN
                TB_SPB_APLY A ON Z.APLYID = A.APLYID
            INNER JOIN
                TB_SPB_PCNTST B ON A.PCNTSTID = B.PCNTSTID
            LEFT OUTER JOIN
                TB_CMM_USER USR ON A.USERID = USR.USERID
            WHERE 1=1
                <!-- 사업분야 -->
            <if test="searchFldCd != null and searchFldCd != '' ">
                AND B.FLD_CD = #{searchFldCd}
            </if>
                <!-- 키워드.공모명 -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'pcntstNm'">
                AND B.PCNTST_NM LIKE CONCAT('%',#{searchPcntstNm},'%')
            </if>
                <!-- 키워드.프로그램명 -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'prgrmNm'">
                AND A.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
                <!-- 키워드.기관명 -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'instNm'">
                AND A.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
                <!-- 상태코드 -->
            <if test="searchSttsCd!= null and searchSttsCd != '' ">
                AND Z.DMND_STTS_CD = #{searchSttsCd}
            </if>
        </sql>

    <!-- 사업포기관리 목록 조회-->
    <select id="selectBizAbndMngList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectBizAbndMngList */
        <include refid="PaginationMapper.header"/>
        <include refid="selectBizAbndMngListSql"/>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 사업포기관리 엑셀 목록 조회-->
    <select id="selectBizAbndMngExcelList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectBizAbndMngList */
        <include refid="selectBizAbndMngListSql"/>
    </select>

    <!-- 사업포기관리 상세 조회-->
    <select id="selectBizAbndMng" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectBizAbndMng */
       SELECT DISTINCT 
            A.APLYID
          , Z.DMNDID
          , A.APLYNO AS RCPTNO               /*접수번호*/
          , A.INSTID
          , A.INST_NM              /*기관명*/
          , A.PRGRM_NM             /*프로그램명*/
          , A.USERID               /*신청자 ID*/
          , Z.RTURN_BGNG_DE
          , Z.RTURN_END_DE
          , CONCAT(A.APLCNT_NM,'(', USR.ACNT, ')')    AS USER_NM_ACNT
          , D.BANK_CD
          , D.BACNTNO
          , D.DPSTR_NM
          , Z.DMND_STTS_CD
          , Z.CN    /*기타*/
          , Z.CNCL_DT    /*취소일시(신청일)*/
        FROM
            TB_SPB_BSNS_CNCL_DMND Z
        INNER JOIN
            TB_SPB_APLY A ON Z.APLYID = A.APLYID
        LEFT OUTER JOIN
            TB_SPB_DELVRY_APLY D ON A.APLYID = D.APLYID
        LEFT OUTER JOIN
            TB_CMM_USER USR ON A.USERID = USR.USERID
        WHERE 1=1
        AND A.APLYID = #{aplyid}
        AND Z.DMNDID = #{dmndid}
    </select>

    <!-- 사업포기관리 수정 -->
    <insert id="updateBizAbnd" parameterType="BizRptVo" >
    /* BizRptDao.updateBizAbnd */
    UPDATE
        TB_SPB_BSNS_CNCL_DMND
    SET
        RTURN_BGNG_DE  = #{rturnBgngDe}
      , RTURN_END_DE   = #{rturnEndDe}
      , CN             = #{cn}
      , DMND_STTS_CD   = #{dmndSttsCd}
      , APRV_DT        = NOW()
      , MDFCN_DT       = NOW()
      , MDFRID         = #{user.userid}
    WHERE
        DMNDID = #{dmndid}

    </insert>

    <!-- 사업취소상태 여부 수정-->
    <update id="updateBsnsCnclYn">
        UPDATE
            TB_SPB_APLY
        SET
            BSNS_CNCL_YN = #{bsnsCnclYn}
          , MDFCN_DT = NOW()
          , MDFRID = #{user.userid}
        WHERE
            APLYID = #{aplyid}
    </update>

    <insert id="insertCnsltngTrgt">
        INSERT INTO TB_SPB_APLY_CNSLTNG (
            APLYID
          , CNSTNTID
          , VST_DT
          , RSLT
          , CN_BFR
          , CN_AFTR
          , ATCH_FILEGRPID
          , WRT_DT
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
          ) VALUES (
            #{aplyid        }
            <foreach item="userId" collection="list" separator=",">
                #{cnstntid}
            </foreach>
          , #{vstDt         }
          , #{rslt          }
          , #{cnBfr         }
          , #{cnAftr        }
          , #{atchFilegrpid }
          , #{wrtDt         }
          , #{mdfcnDt       }
          , #{mdfrid        }
          , #{regDt         }
          , #{rgtrid        }
          )
    </insert>

    <delete id="deleteCnsltngMng" parameterType="BizRptVo" >
        DELETE FROM TB_SPB_APLY_CNSLTNG
        WHERE APLYID = #{aplyid}
    </delete>

    <!-- 컨설팅 대상자 내용 수정 -->
    <update id="updateTrgtCn" parameterType="BizRptVo" >
        UPDATE TB_SPB_APLY
        SET    CNSLTNG_TRGT_CN = #{cnsltngTrgtCn}
        WHERE APLYID  = #{aplyid}
    </update>

    <select id="selectCnsltngTrgtCn" parameterType="BizRptVo" resultType="BizRptVo">
        SELECT APLYID , CNSLTNG_TRGT_CN  FROM TB_SPB_APLY
        WHERE 1=1
        AND APLYID = #{aplyid}
    </select>

    <select id="selectCnstntList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectCnstntList */
        SELECT
            A.APLYID
          , A.CNSLTNGID
          , A.CNSTNTID
          , USR.USERID
          , USR.NM
          , USR.ACNT
          , USR.EML
          , USR.MOBLPHON
        FROM TB_SPB_APLY_CNSLTNG A
        LEFT OUTER JOIN TB_CMM_USER USR ON A.CNSTNTID = USR.USERID
        WHERE A.APLYID = #{aplyid}
    </select>

    <!-- 2023.04.25 사업보고 등록 기능 추가 (KCS) -->
    <!-- 사업보고제출 하지 않은 신청자 조회 -->
    <select id="selectAplyList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectAplyList */
        SELECT TSA.APLYNO AS RCPTNO
            , TSA.APLYID 
            , TSA.PRGRM_NM 
            , TSA.INST_NM 
            , TSA.APLCNT_NM AS USER_NM_ACNT
            , CASE WHEN TSR.REPORT_SE_CD = '204101' THEN TSP.MDL_REPORT_BGNG_DT ELSE TSP.RSLT_REPORT_BGNG_DT END AS REPORT_BGNG_DT  
            , CASE WHEN TSR.REPORT_SE_CD = '204101' THEN TSP.MDL_REPORT_END_DT ELSE TSP.RSLT_REPORT_END_DT END AS REPORT_END_DT  
            , TSR.REPORTID 
        FROM TB_SPB_PCNTST TSP 
        INNER JOIN TB_SPB_APLY TSA ON TSP.PCNTSTID = TSA.PCNTSTID
        LEFT OUTER JOIN TB_SPB_REPORT TSR ON TSR.APLYID = TSA.APLYID AND TSR.REPORT_SE_CD = #{reportSeCd} 
        WHERE TSP.PCNTSTID = #{pcntstid}
        AND TSR.REPORTID IS NULL
        AND TSA.APLY_STTS_CD = '192102'
        ORDER BY TSA.APLYNO DESC
    </select>
    
    <!-- 사업보고관리 등록 -->
    <insert id="insertReport" parameterType="BizRptVo" useGeneratedKeys="true" keyProperty="reportid">
        /* BizRptDao.insertReport */
        INSERT INTO TB_SPB_REPORT (
            APLYID
            , REPORT_SE_CD
            , ATCH_FILEGRPID
            , ETC_CN
            , TRGT
            , SBJCT
            , REPORT_BGNG_DT
            , REPORT_END_DT
            , REPORT_STTS_CD
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{aplyid}
            , #{reportSeCd}
            , #{atchFilegrpid}
            , #{etcCn}
            , #{trgt}
            , #{sbjct}
            , STR_TO_DATE(DATE_FORMAT(#{reportBgngDt}, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s')
            , STR_TO_DATE(DATE_FORMAT(#{reportEndDt}, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s')
            , '203102'
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 사업보고관리 교육운영정보 등록 -->
    <insert id="insertReportOper" parameterType="com.kbrainc.plum.front.report.model.ReportOperVo" useGeneratedKeys="true" keyProperty="operid">
        /* BizRptDao.insertReportOper */
        INSERT INTO TB_SPB_REPORT_OPER (
            REPORTID
            , SE_CD
            , BGNG_DE
            , END_DE
            , RND
            , NOPE
            , MNT
            , RMRK
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{reportid}
            , #{seCd}
            , #{bgngDe}
            , #{endDe}
            , #{rnd}
            , #{nope}
            , #{mnt}
            , #{rmrk}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 사업포기관리 등록 접수번호 목록 조회 -->
    <select id="selectAllAplyList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectAllAplyList */
        SELECT TSA.APLYNO AS RCPTNO
            , TSA.APLYID 
            , TSP.FLD_CD 
            , TSA.APLYNO 
            , TSA.PRGRM_NM 
            , TSA.INSTID 
            , TSA.INST_NM 
            , TSA.USERID 
            , TSA.APLCNT_NM AS USER_NM_ACNT
            , TSP.BSNS_BGNG_DE 
            , TSP.BSNS_END_DE
            , BANK_CD
            , BACNTNO
            , DPSTR_NM
        FROM TB_SPB_PCNTST TSP 
        INNER JOIN TB_SPB_APLY TSA ON TSP.PCNTSTID = TSA.PCNTSTID
        LEFT OUTER JOIN (SELECT 
                        APLYID
                        , BANK_CD
                        , BACNTNO
                        , DPSTR_NM 
                    FROM TB_SPB_DELVRY_APLY A
                    INNER JOIN TB_SPB_DELVRY TSD ON A.DELVRYID = TSD.DELVRYID
                    WHERE TSD.CYCL = 1 AND A.DELVRY_STTS_CD = '202102') TSDA ON TSDA.APLYID = TSA.APLYID 
        LEFT OUTER JOIN TB_SPB_BSNS_CNCL_DMND TSBCD ON TSBCD.APLYID = TSA.APLYID AND TSBCD.DMND_STTS_CD NOT IN ('220101','220103') 
        WHERE 1 = 1
        AND TSBCD.DMNDID IS NULL
        AND TSA.SLCTN_STTS_CD = '193102'
        AND TSA.APLY_STTS_CD = '192102'
        ORDER BY TSA.APLYNO DESC
    </select>
    
    <!-- 사업포기신청 등록 -->
    <insert id="insertCancel" parameterType="BizRptVo" useGeneratedKeys="true" keyProperty="dmndid">
        /* BizRptDao.insertCancel */
        INSERT INTO TB_SPB_BSNS_CNCL_DMND (
            APLYID
            , USERID
            , INSTID
            , RTURN_BGNG_DE
            , RTURN_END_DE
            , CN
            , DMND_STTS_CD
            , CNCL_DT
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{aplyid}
            , #{userid}
            , #{instid}
            , #{rturnBgngDe}
            , #{rturnEndDe}
            , #{cn}
            , '220101'
            , NOW()
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 공모신청서 상태 수정 -->
    <update id="updateAplyCancel" parameterType="BizRptVo">
        /* BizRptDao.insertCancel */
        UPDATE TB_SPB_APLY SET
            APLY_STTS_CD = '192103'
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE APLYID = #{aplyid}
    </update>
        
    <!-- 송금은행 정보 수정 -->
    <update id="updateDelvryInfo" parameterType="BizRptVo">
        /* BizRptDao.updateDelvryInfo */
        UPDATE TB_SPB_DELVRY_APLY SET
            BANK_CD = #{bankCd}
            , BACNTNO = #{bacntno}
            , DPSTR_NM = #{dpstrNm}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE APLYID = #{aplyid}
    </update>
    
</mapper>
