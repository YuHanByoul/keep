<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : BizRptDaoImpl.xml
    Description : 사업보고관리
-->
<mapper namespace="com.kbrainc.plum.mng.bizAply.bizRpt.model.BizRptDao">
    <!-- 중간보고관리 목록조회 조건-->
    <sql id="searchCondition1">
        <!-- 사업분야 -->
        <if test="searchFldCd != null and searchFldCd != '' ">
           AND A.FLD_CD = #{searchFldCd}
        </if>
            <!-- 공모명 -->
        <if test="searchPcntstNm != null and searchPcntstNm != '' ">
           AND A.PCNTST_NM LIKE CONCAT('%',#{searchPcntstNm},'%')
        </if>
            <!-- 중간보고 제출기간-시작일 -->
        <if test="searchBgngDt != null and searchBgngDt != ''">
            AND A.MDL_REPORT_BGNG_DT <![CDATA[>=]]> #{searchBgngDt}
        </if>
        <if test="searchEndDt != null and searchEndDt != ''">
            AND A.MDL_REPORT_END_DT <![CDATA[<]]> CAST(CONCAT(#{searchEndDt},' 23:59:59') AS DATETIME)
        </if>
            <!-- 진행상태 -->
        <if test="searchPrgrsSttsCd!= null and searchPrgrsSttsCd != '' ">
           AND #{searchPrgrsSttsCd} = CASE WHEN A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                                     WHEN A.MDL_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                                     THEN CASE WHEN A.MDL_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                                               WHEN A.MDL_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                                               ELSE ''
                                               END
                                     ELSE ''
                                END
        </if>
    </sql>

    <!-- 중간보고제출 목록조회 조건-->
    <sql id="searchCondition2">
            <!-- 제출상태 -->
        <if test="searchReportSttsCd != null and searchReportSttsCd != '' ">
            AND C.REPORT_STTS_CD = #{searchReportSttsCd}
        </if>
            <!-- 키워드.프로그램명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'prgrmNm'">
            AND A.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
            <!-- 키워드.기관명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'instNm'">
            AND A.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
            <!-- 키워드.사용자 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'userNm'">
            AND USR.NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
            <!-- 증빙서류 첨부 -->
        <if test="evdncDcmntYn != null and evdncDcmntYn != '' ">
            AND IF(C.ATCH_FILEGRPID IS NOT NULL, 'Y','N') = #{evdncDcmntYn}
        </if>
            <!-- 중간보고 제출기간-시작일 -->
        <if test="searchBgngDt != null and searchBgngDt != ''">
            AND C.REG_DT <![CDATA[>=]]> #{searchBgngDt}
        </if>
            <!-- 중간보고 제출기간-종료일 -->
        <if test="searchEndDt != null and searchEndDt != ''">
            AND C.REG_DT <![CDATA[<]]> CAST(CONCAT(#{searchEndDt},' 23:59:59') AS DATETIME)
        </if>
    </sql>

        <!-- 결과보고관리 목록조회 조건-->
    <sql id="searchCondition3">
        <!-- 사업분야 -->
        <if test="searchFldCd != null and searchFldCd != '' ">
           AND A.FLD_CD = #{searchFldCd}
        </if>
            <!-- 공모명 -->
        <if test="searchPcntstNm != null and searchPcntstNm != '' ">
           AND A.PCNTST_NM LIKE CONCAT('%',#{searchPcntstNm},'%')
        </if>
            <!-- 중간보고 제출기간-시작일 -->
        <if test="searchBgngDt != null and searchBgngDt != ''">
            AND A.RSLT_REPORT_BGNG_DT <![CDATA[>=]]> #{searchBgngDt}
        </if>
        <if test="searchEndDt != null and searchEndDt != ''">
            AND A.RSLT_REPORT_END_DT <![CDATA[<]]> CAST(CONCAT(#{searchEndDt},' 23:59:59') AS DATETIME)
        </if>
            <!-- 진행상태 -->
        <if test="searchPrgrsSttsCd!= null and searchPrgrsSttsCd != '' ">
           AND #{searchPrgrsSttsCd} = CASE WHEN A.RSLT_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                                     WHEN A.RSLT_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                                     THEN CASE WHEN A.RSLT_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                                               WHEN A.RSLT_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                                               ELSE ''
                                               END
                                     ELSE ''
                                END
        </if>
    </sql>

    <!-- 중간보고관리 목록조회 -->
    <select id="selectMdlRptMngList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectMdlRptMngList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.PCNTSTID
          , A.FLD_CD    /*분야 코드*/
          , A.PCNTST_NM    /*공모 이름*/
          ,''    /*진행 상태*/
          , A.MDL_REPORT_BGNG_DT    /*중간보고 시작일자*/
          , A.MDL_REPORT_END_DT    /*중간보고 종료일자*/
          , CONCAT(A.MDL_REPORT_BGNG_DT, '~', A.MDL_REPORT_END_DT)   AS MDL_REPORT_PRD
          , CASE WHEN A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                 WHEN A.MDL_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                 THEN CASE WHEN A.MDL_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                           WHEN A.MDL_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                           ELSE ''
                      END
                 ELSE ''
           END    AS PRGRS_STTS_CD    /*진행상태 코드*/
          , B.SLCTN_BIZ_CNT    /*선정 사업*/
          , CONCAT(B.REPORT_CNT, "/", B.SLCTN_BIZ_CNT)    AS SBMSN_CNT /*제출 건수*/
          , A.CNSLTNG_USE_CD    /*컨설팅 대상*/
          , A.REG_DT
          , IF(A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW(), '-',B.CNSLTNG_USE_CNT)    AS CNSLTNG_USE_CNT    /*컨설팅 대상 건수*/
        FROM
            TB_SPB_PCNTST A
        LEFT OUTER JOIN
        (
            SELECT
                COUNT(A.APLYID)    AS SLCTN_BIZ_CNT
              , A.PCNTSTID
              /* 보고구분코드 : 중간보고, 보고상태코드 : 제출완료 */
              , COUNT(IF(B.REPORT_SE_CD = #{reportSeCd} AND B.REPORT_STTS_CD <![CDATA[<>]]> '203101' ,1,NULL))    AS REPORT_CNT
              , COUNT(C.APLYID_CNT)    AS CNSLTNG_USE_CNT
            FROM
                TB_SPB_APLY A
            LEFT OUTER JOIN
                TB_SPB_REPORT B ON A.APLYID =B.APLYID
            LEFT OUTER JOIN    /*컨설팅*/
            (
                SELECT
                    COUNT(1) APLYID_CNT
                  , APLYID
                FROM
                    TB_SPB_APLY_CNSLTNG
                GROUP BY
                    APLYID
            ) C ON B.APLYID = C.APLYID
            WHERE
                A.SLCTN_STTS_CD = '193102'    /* 선정 상태 코드 : 선정*/
            GROUP BY
                A.PCNTSTID
        ) B ON A.PCNTSTID = B.PCNTSTID
        WHERE 1=1
        <include refid="searchCondition1"/>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 중간보고관리 목록조회 (엑셀)-->
    <select id="selectMdlRptMngListExcel" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectMdlRptMngListExcel */
        SELECT
            A.PCNTSTID
          , A.FLD_CD    /*분야 코드*/
          , A.PCNTST_NM    /*공모 이름*/
          ,''    /*진행 상태*/
          , A.MDL_REPORT_BGNG_DT    /*중간보고 시작일자*/
          , A.MDL_REPORT_END_DT    /*중간보고 종료일자*/
          , CONCAT(A.MDL_REPORT_BGNG_DT, '~', A.MDL_REPORT_END_DT)   AS MDL_REPORT_PRD
          , CASE WHEN A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                 WHEN A.MDL_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                 THEN CASE WHEN A.MDL_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                           WHEN A.MDL_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                           ELSE ''
                      END
                 ELSE ''
           END    AS PRGRS_STTS_CD    /*진행상태 코드*/
          , B.SLCTN_BIZ_CNT    /*선정 사업*/
          , CONCAT(B.REPORT_CNT, "/", B.SLCTN_BIZ_CNT)    AS SBMSN_CNT /*제출 건수*/
          , A.CNSLTNG_USE_CD    /*컨설팅 대상*/
          , A.REG_DT
          , IF(A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW(), '-',B.CNSLTNG_USE_CNT)    AS CNSLTNG_USE_CNT    /*컨설팅 대상 건수*/
        FROM
            TB_SPB_PCNTST A
        LEFT OUTER JOIN
        (
            SELECT
                COUNT(A.APLYID)    AS SLCTN_BIZ_CNT
              , A.PCNTSTID
              /* 보고구분코드 : 중간보고, 보고상태코드 : 제출완료 */
              , COUNT(IF(B.REPORT_SE_CD = '204101' AND B.REPORT_STTS_CD <![CDATA[<>]]> '203101' ,1,NULL))    AS REPORT_CNT
              , COUNT(C.APLYID_CNT)    AS CNSLTNG_USE_CNT
            FROM
                TB_SPB_APLY A
            LEFT OUTER JOIN
                TB_SPB_REPORT B ON A.APLYID =B.APLYID
            LEFT OUTER JOIN    /*컨설팅*/
            (
                SELECT
                    COUNT(1) APLYID_CNT
                  , APLYID
                FROM
                    TB_SPB_APLY_CNSLTNG
                GROUP BY
                    APLYID
            ) C ON B.APLYID = C.APLYID
            WHERE
                A.SLCTN_STTS_CD = '193102'    /* 선정 상태 코드 : 선정*/
            GROUP BY
                A.PCNTSTID
        ) B ON A.PCNTSTID = B.PCNTSTID
        WHERE 1=1
        <include refid="searchCondition1"/>
    </select>

    <!-- 중간보고관리 상세조회 -->
    <select id="selectMdlRptMng" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectMdlRptMng */
        SELECT
            A.PCNTSTID
          , A.FLD_CD    /*분야 코드*/
          , A.PCNTST_NM    /*공모 이름*/
          ,''    /*진행 상태*/
          , A.MDL_REPORT_BGNG_DT    /*중간보고 시작일자*/
          , A.MDL_REPORT_END_DT    /*중간보고 종료일자*/
          , CONCAT(A.MDL_REPORT_BGNG_DT, '~', A.MDL_REPORT_END_DT)   AS MDL_REPORT_PRD
          , CASE WHEN A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                 WHEN A.MDL_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                 THEN CASE WHEN A.MDL_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                           WHEN A.MDL_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                           ELSE ''
                      END
                 ELSE ''
           END    AS PRGRS_STTS_CD    /*진행상태 코드*/
          , B.SLCTN_BIZ_CNT    /*선정 사업*/
          , CONCAT(B.REPORT_CNT, "/", B.SLCTN_BIZ_CNT)    AS SBMSN_CNT /*제출 건수*/
          , A.CNSLTNG_USE_CD    /*컨설팅 대상*/
          , A.REG_DT
          , IF(A.MDL_REPORT_BGNG_DT <![CDATA[<]]>  NOW(), '-',B.CNSLTNG_USE_CNT)    AS CNSLTNG_USE_CNT    /*컨설팅 대상 건수*/
        FROM
            TB_SPB_PCNTST A
        LEFT OUTER JOIN
        (
            SELECT
                COUNT(A.APLYID)    AS SLCTN_BIZ_CNT
              , A.PCNTSTID
              /* 보고구분코드 : 중간보고, 보고상태코드 : 제출완료 */
              , COUNT(IF(B.REPORT_SE_CD = '204101' AND B.REPORT_STTS_CD <![CDATA[<>]]> '203101' ,1,NULL))    AS REPORT_CNT
              , COUNT(C.APLYID_CNT)    AS CNSLTNG_USE_CNT
            FROM
                TB_SPB_APLY A
            LEFT OUTER JOIN
                TB_SPB_REPORT B ON A.APLYID =B.APLYID
            LEFT OUTER JOIN    /*컨설팅*/
            (
                SELECT
                    COUNT(1) APLYID_CNT
                  , APLYID
                FROM
                    TB_SPB_APLY_CNSLTNG
                GROUP BY
                    APLYID
            ) C ON B.APLYID = C.APLYID
            WHERE
                A.SLCTN_STTS_CD = '193102'    /* 선정 상태 코드 : 선정*/
            GROUP BY
                A.PCNTSTID
        ) B ON A.PCNTSTID = B.PCNTSTID
        WHERE 1=1
        AND
            A.PCNTSTID = #{pcntstid}
    </select>

    <!-- 중간보고제출 목록조회 -->
    <select id="selectMdlRptSbmsnList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectMdlRptSbmsnList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.APLYID
          , B.DELVRY_APLYID
          , B.DELVRYID
          , C.REPORTID
          , B.RCPTNO            /*접수번호*/
          , C.REPORT_STTS_CD    /*제출(보고)상태*/
          , A.INST_NM           /*기관명*/
          , A.USERID
          , CONCAT(USR.NM,"(",USR.ACNT ,")")    AS USER_NM_ACNT /*신청자 명(ID)*/
          , A.PRGRM_NM
          , IF(C.REG_DT IS NULL,'-',C.REG_DT )    AS SBMSN_DT
          , IF(C.REPORTID IS NULL, '-', IF(C.ATCH_FILEGRPID IS NULL, '미첨부','첨부'))    AS EVDNC_DCMNT_YN
          , ''    AS CNSLTNG_USE    /*컨설팅 여부*/
          , C.REPORT_SE_CD    /*보고서 구분 코드*/
          , C.REG_DT
          , IF(A.CNSLTNG_TRGT_CN IS NOT NULL,'Y','N')    AS CNSLTNG_TRGT_YN
        FROM
            TB_SPB_APLY A
        LEFT OUTER JOIN TB_SPB_DELVRY_APLY B  ON A.APLYID = B.APLYID
        LEFT OUTER JOIN TB_SPB_REPORT C ON A.APLYID = C.APLYID
        LEFT OUTER JOIN TB_CMM_USER USR ON A.USERID = USR.USERID
        WHERE 1=1
        AND A.PCNTSTID = #{pcntstid}
        AND C.REPORT_SE_CD = '204101'    /*보고서 구분 중간보고*/
        <include refid="searchCondition2"/>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 중간보고제출 목록조회(엑셀) -->
    <select id="selectMdlRptSbmsnListExcel" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectMdlRptSbmsnListExcel */
        SELECT
            A.APLYID
          , B.DELVRY_APLYID
          , B.DELVRYID
          , C.REPORTID
          , B.RCPTNO            /*접수번호*/
          , C.REPORT_STTS_CD    /*제출(보고)상태*/
          , A.INST_NM           /*기관명*/
          , A.USERID
          , CONCAT(USR.NM,"(",USR.ACNT ,")")    AS USER_NM_ACNT /*신청자 명(ID)*/
          , A.PRGRM_NM
          , IF(C.REG_DT IS NULL,'-',C.REG_DT )    AS SBMSN_DT
          , IF(C.REPORTID IS NULL, '-', IF(C.ATCH_FILEGRPID IS NULL, '미첨부','첨부'))    AS EVDNC_DCMNT_YN
          , ''    AS CNSLTNG_USE    /*컨설팅 여부*/
          , C.REPORT_SE_CD    /*보고서 구분 코드*/
          , C.REG_DT
          , IF(A.CNSLTNG_TRGT_CN IS NOT NULL,'Y','N')    AS CNSLTNG_TRGT_YN
        FROM
            TB_SPB_APLY A
        LEFT OUTER JOIN TB_SPB_DELVRY_APLY B  ON A.APLYID = B.APLYID
        LEFT OUTER JOIN TB_SPB_REPORT C ON A.APLYID = C.APLYID
        LEFT OUTER JOIN TB_CMM_USER USR ON A.USERID = USR.USERID
        WHERE 1=1
        AND A.PCNTSTID = #{pcntstid}
        AND C.REPORT_SE_CD = '204101'    /*보고서 구분 중간보고*/
        <include refid="searchCondition2"/>
    </select>

    <!-- 중간보고상태코드 수정 -->
    <update id="updateRptSttsCd" >
        /* BizRptDao.updateRptSttsCd */
        UPDATE TB_SPB_REPORT SET
            REPORT_STTS_CD = '203106'    /*제출상태코드 : 완료*/
          , MDFCN_DT = NOW()
          , MDFRID   = #{user.userid}
        WHERE REPORTID IN
        <foreach item="item" collection="reportids" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </update>

    <!-- 중간보고제출 상세 조회 -->
    <select id="selectMdlRptSbmsnDetail" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectMdlRptSbmsnDetail */
        SELECT
            B.APLYID
          , C.DELVRY_APLYID
          , C.DELVRYID
          , A.REPORTID
          , C.RCPTNO            /*접수번호*/
          , B.INST_NM           /*기관명*/
          , B.PRGRM_NM
          , CONCAT(USR.NM,"(",USR.ACNT ,")")    AS USER_NM_ACNT /*신청자 명(ID)*/
          , D.EDU_TRGT
          , D.ESSNTL_SBJCT_NM
          , A.REG_DT
          , A.REPORT_STTS_CD    /*제출(보고)상태*/
          , A.ETC_CN
          , A.ATCH_FILEGRPID
        FROM
            TB_SPB_REPORT A
        INNER JOIN TB_SPB_APLY B ON A.APLYID = B.APLYID
        INNER JOIN TB_CMM_USER USR ON B.USERID = USR.USERID
        INNER JOIN TB_SPB_DELVRY_APLY C ON B.APLYID = C.APLYID
        LEFT OUTER JOIN TB_SPB_PRGRM D ON B.APLYID = D.APLYID
        WHERE 1=1
        AND A.REPORTID = #{reportid}
    </select>

    <!-- 보고운영목록 조회 -->
    <select id="selectReportOperList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectReportOperList*/
        SELECT
            OPERID
          , REPORTID
          , SE_CD
          , BGNG_DE
          , END_DE
          , RND
          , NOPE
          , MNT
          , RMRK
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
          , SUM(RND) OVER (PARTITION BY REPORTID)          AS SUM_RND
          , SUM(NOPE) OVER (PARTITION BY REPORTID)         AS SUM_NOPE
          , SUM(MNT) OVER (PARTITION BY REPORTID)          AS SUM_MNT
          , SUM(IF(SE_CD = '209101',1,0)) OVER (PARTITION BY REPORTID)    AS PLAN_CNT
          , SUM(IF(SE_CD = '209102',1,0)) OVER (PARTITION BY REPORTID)    AS NOW_CNT
        FROM
            TB_SPB_REPORT_OPER
        WHERE REPORTID = #{reportid}
        ORDER BY OPERID
    </select>

    <!-- 보고보완 목록 조회 -->
    <select id="selectSplmntDmndList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectSplmntDmndList*/
        <include refid="PaginationMapper.header"/>
        SELECT
            A.SPLMNTID
          , A.REPORTID
          , A.ANS_STTS_CD  /* 상태     */
          , A.DMND_CN      /* 요청내용 */
          , A.DMND_DT      /* 요청일   */
          , IF(A.ANS_DT IS NULL, '-', A.ANS_DT)    AS ANS_DT /* 완료처리 */
          , A.ANS_CN       /* 완료내용 */
        FROM
            TB_SPB_REPORT_SPLMNT A
        WHERE A.REPORTID = #{reportid}
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 보고보완 조회 -->
    <select id="selectSplmntDmnd" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectSplmntDmndList*/
        SELECT
            A.SPLMNTID
          , A.REPORTID
          , A.ANS_STTS_CD  /* 상태     */
          , A.DMND_CN      /* 요청내용 */
          , A.DMND_DT      /* 요청일   */
          , A.ANS_DT       /* 완료처리 */
          , A.ANS_CN       /* 완료내용 */
        FROM
            TB_SPB_REPORT_SPLMNT A
        WHERE A.SPLMNTID = #{splmntid}
    </select>

    <!-- 보고보완 등록-->
    <insert id="insertRptSplmnt" parameterType="BizRptVo">
        /* BizRptDao.insertRptSplmnt*/
        INSERT INTO TB_SPB_REPORT_SPLMNT (
            REPORTID
          , ANS_STTS_CD  /* 상태     */
          , DMND_CN      /* 요청내용 */
          , RQSTRID
          , DMND_DT      /* 요청일   */
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        )VALUES(
            #{reportid }
          , #{ansSttsCd}   /* 상태     */
          , #{dmndCn   }   /* 요청내용 */
          , #{user.userid}
          , NOW()          /* 요청일   */
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        )

    </insert>

    <!-- 결과보고관리 목록조회 -->
    <select id="selectRsltRptMngList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectRsltRptMngList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.PCNTSTID
          , A.FLD_CD    /*분야 코드*/
          , A.PCNTST_NM    /*공모 이름*/
          ,''    /*진행 상태*/
          , A.RSLT_REPORT_BGNG_DT   /*결과보고 시작일자*/
          , A.RSLT_REPORT_END_DT    /*결과보고 종료일자*/
          , CONCAT(A.RSLT_REPORT_BGNG_DT, '~', A.RSLT_REPORT_END_DT)   AS RSLT_REPORT_PRD
          , CASE WHEN A.RSLT_REPORT_BGNG_DT <![CDATA[<]]>  NOW()  THEN '200101'
                 WHEN A.RSLT_REPORT_BGNG_DT <![CDATA[>=]]> NOW()
                 THEN CASE WHEN A.RSLT_REPORT_END_DT <![CDATA[<]]> NOW() THEN '200103'
                           WHEN A.RSLT_REPORT_END_DT <![CDATA[>=]]> NOW() THEN '200102'
                           ELSE ''
                      END
                 ELSE ''
           END    AS PRGRS_STTS_CD    /*진행상태 코드*/
          , B.SLCTN_BIZ_CNT    /*선정 사업*/
          , CONCAT(B.REPORT_CNT, "/", B.SLCTN_BIZ_CNT)    AS SBMSN_CNT /*제출 건수*/
          , A.CNSLTNG_USE_CD    /*컨설팅 대상*/
          , A.REG_DT
          , IF(A.RSLT_REPORT_BGNG_DT <![CDATA[<]]>  NOW(), '-',B.CNSLTNG_USE_CNT)    AS CNSLTNG_USE_CNT    /*컨설팅 대상 건수*/
        FROM
            TB_SPB_PCNTST A
        LEFT OUTER JOIN
        (
            SELECT
                COUNT(A.APLYID)    AS SLCTN_BIZ_CNT
              , A.PCNTSTID
              /* 보고구분코드 : 중간보고, 보고상태코드 : 제출완료 */
              , COUNT(IF(B.REPORT_SE_CD = #{reportSeCd} AND B.REPORT_STTS_CD <![CDATA[<>]]> '203101' ,1,NULL))    AS REPORT_CNT
              , COUNT(C.APLYID_CNT)    AS CNSLTNG_USE_CNT
            FROM
                TB_SPB_APLY A
            LEFT OUTER JOIN
                TB_SPB_REPORT B ON A.APLYID =B.APLYID
            LEFT OUTER JOIN    /*컨설팅*/
            (
                SELECT
                    COUNT(1) APLYID_CNT
                  , APLYID
                FROM
                    TB_SPB_APLY_CNSLTNG
                GROUP BY
                    APLYID
            ) C ON B.APLYID = C.APLYID
            WHERE
                A.SLCTN_STTS_CD = '193102'    /* 선정 상태 코드 : 선정*/
            GROUP BY
                A.PCNTSTID
        ) B ON A.PCNTSTID = B.PCNTSTID
        WHERE 1=1
        <include refid="searchCondition1"/>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 컨설팅관리 목록조회 -->
    <select id="selectCnsltngMngList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectCnsltngMngList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.CNSLTNGID
          , A.APLYID
          , A.CNSTNTID
          , USR.NM       /*컨설턴트 이름*/
          , C.FLD_CD     /*사업분야*/
          , C.PCNTST_NM  /*공모명*/
          , B.PRGRM_NM   /*프로그램명*/
          , A.VST_DT     /*방문일시*/
          , CASE WHEN VST_DT > NOW() THEN '컨설팅전'
                  WHEN VST_DT <![CDATA[<]]> NOW() THEN '컨설팅완료'/*상태*/
                  ELSE ''
            END    AS CNSLTNG_STTS_NM
        FROM
            TB_SPB_APLY_CNSLTNG A
        INNER JOIN TB_SPB_APLY B ON A.APLYID = B.APLYID
        INNER JOIN TB_SPB_PCNTST C ON B.PCNTSTID = B.PCNTSTID
        INNER JOIN TB_CMM_USER USR ON A.CNSTNTID = USR.USERID
        WHERE 1=1
        <!-- 컨설턴트 ID -->
        <if test="searchUserid!= null and searchUserid != '' ">
            A.CNSTNTID =  #{searchUserid}
        </if>
        <!-- 사업분야 -->
        <if test="searchFldCd != null and searchFldCd != '' ">
           AND C.FLD_CD = #{searchFldCd}
        </if>
        <!-- 키워드.공모명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'pcntstNm'">
            AND C.PCNTST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 키워드.프로그램명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'prgrmNm'">
            AND B.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 상태 -->
        <if test="searchSttsCd != null and searchSttsCd == 'before' ">
            AND A.VST_DT > NOW()
        </if>
        <if test="searchSttsCd != null and searchSttsCd == 'after' ">
            AND A.VST_DT <![CDATA[<]]> NOW()
        </if>
        GROUP BY CNSLTNGID
        ORDER BY A.VST_DT DESC , USR.NM ,A.REG_DT
        <include refid="PaginationMapper.footer"/>
    </select>


    <!-- 컨설팅관리 상세조회 -->
    <select id="selectCnsltngMng" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectCnsltngMng */
        SELECT
            A.CNSLTNGID
          , A.APLYID
          , A.CNSTNTID
          , D.RCPTNO            /*접수번호*/
          , B.INST_NM           /*기관명*/
          , B.PRGRM_NM          /*프로그램명*/
          , B.USERID            /*신청자 ID*/
          , CONCAT(B.APLCNT_NM,'(', USR.ACNT, ')')    AS USER_NM_ACNT
          , B.APLCNT_NM         /*신청자*/
          , B.APLCNT_TELNO      /*신청자 연착처*/
          , B.APLCNT_EML        /*신청자 이메일*/
          , B.INST_SAREA_CD     /*기관권역코드*/
          , B.RGN_CD            /*지역코드*/
          , CTPRVN.CTPRVN_NM    /*지역코명*/
          , E.EDU_TRGT          /*교육대상*/
          , E.ESSNTL_SBJCT_NM   /*교육주제*/
          , B.INST_ZIP          /*주소 ZIP*/
          , B.INST_ADDR         /*주소 */
          , B.INST_ADDR_DTL     /*상세주소*/
          , A.VST_DT            /*방문일시*/
          , A.CN_BFR            /*사전*/
          , A.CN_AFTR           /*사후*/
          , A.RSLT              /*종합의견*/
          , A.ATCH_FILEGRPID
        FROM
            TB_SPB_APLY_CNSLTNG A
        INNER JOIN TB_SPB_APLY B ON A.APLYID = B.APLYID
        LEFT OUTER JOIN TB_SPB_DELVRY_APLY D ON B.APLYID =D.APLYID
        LEFT OUTER JOIN TB_SPB_PRGRM E ON B.APLYID = E.APLYID
        LEFT OUTER JOIN TB_CMM_USER USR ON A.CNSTNTID = USR.USERID
        LEFT OUTER JOIN TB_CMM_ADDR_CTPRVN CTPRVN ON B.RGN_CD = CTPRVN.CTPRVN_CD
        WHERE 1=1
        AND B.APLYID = #{aplyid}
    </select>

    <!-- 컨설팅관리 등록-->
    <insert id="insertCnsltngMng" parameterType="BizRptVo">
        /* BizRptDao.insertCnsltngMng*/
        INSERT INTO TB_SPB_APLY_CNSLTNG
        (
            APLYID
          , CNSTNTID
          , VST_DT
          , RSLT
          , CN_BFR
          , CN_AFTR
          , ATCH_FILEGRPID
          , WRT_DT
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES
        (
            #{aplyid       }
          , #{cnstntid     }
          , #{vstDt        }
          , #{rslt         }
          , #{cnBfr        }
          , #{cnAftr       }
          , #{atchFilegrpid}
          , NOW()
          , NOW()
          , #{user.userid  }
          , NOW()
          , #{user.userid  }
        )
    </insert>

    <!-- 컨설팅관리 수정-->
    <update id="updateCnsltngMng" parameterType="BizRptVo">
        /* BizRptDao.updateCnsltngMng*/
        UPDATE
            TB_SPB_APLY_CNSLTNG
        SET
            VST_DT         = #{vstDt        }
          , RSLT           = #{rslt         }
          , CN_BFR         = #{cnBfr        }
          , CN_AFTR        = #{cnAftr       }
          , ATCH_FILEGRPID = #{atchFilegrpid}
          , WRT_DT         = NOW()
          , MDFCN_DT       = NOW()
          , MDFRID         = #{user.userid  }
          , REG_DT         = NOW()
          , RGTRID         = #{user.userid  }
        WHERE
            CNSLTNGID = #{cnsltngid}
    </update>

    <!--# 사업포기관리 #############################-->

    <!-- 사업포기관리 목록 조회-->
        <sql id="selectBizAbndMngListSql">
             SELECT
                A.APLYID
              , Z.DMNDID
              , Z.RTURN_BGNG_DE
              , Z.RTURN_END_DE
              , Z.INSTID
              , Z.CN
              , Z.DMND_STTS_CD
              , B.FLD_CD          /* 사업분야 */
              , B.PCNTST_NM       /* 공모명 */
              , A.PRGRM_NM        /* 프로그램명/동아리명*/
              , A.BSNS_CNCL_YN    /* 상태 */
              , A.INST_NM         /* 기관명 */
              , CONCAT(A.APLCNT_NM,'(', USR.ACNT, ')')    AS USER_NM_ACNT    /*신청자 명(ID)*/
              , Z.CNCL_DT
              , A.REG_DT
            FROM TB_SPB_BSNS_CNCL_DMND Z
            INNER JOIN
                TB_SPB_APLY A ON Z.APLYID = A.APLYID
            INNER JOIN
                TB_SPB_PCNTST B ON A.PCNTSTID = B.PCNTSTID
            LEFT OUTER JOIN
                TB_CMM_USER USR ON A.USERID = USR.USERID
            WHERE 1=1
                <!-- 사업분야 -->
            <if test="searchFldCd != null and searchFldCd != '' ">
                AND B.FLD_CD = #{searchFldCd}
            </if>
                <!-- 키워드.공모명 -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'pcntstNm'">
                AND B.PCNTST_NM LIKE CONCAT('%',#{searchPcntstNm},'%')
            </if>
                <!-- 키워드.프로그램명 -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'prgrmNm'">
                AND A.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
                <!-- 키워드.기관명 -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'instNm'">
                AND A.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
                <!-- 상태코드 -->
            <if test="searchSttsCd!= null and searchSttsCd != '' ">
                AND Z.DMND_STTS_CD = #{searchSttsCd}
            </if>
        </sql>

    <!-- 사업포기관리 목록 조회-->
    <select id="selectBizAbndMngList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectBizAbndMngList */
        <include refid="PaginationMapper.header"/>
        <include refid="selectBizAbndMngListSql"/>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 사업포기관리 엑셀 목록 조회-->
    <select id="selectBizAbndMngExcelList" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectBizAbndMngList */
        <include refid="selectBizAbndMngListSql"/>
    </select>

    <!-- 사업포기관리 상세 조회-->
    <select id="selectBizAbndMng" parameterType="BizRptVo" resultType="BizRptVo">
        /* BizRptDao.selectBizAbndMng */
       SELECT
            A.APLYID
          , Z.DMNDID
          , D.RCPTNO               /*접수번호*/
          , A.INSTID
          , A.INST_NM              /*기관명*/
          , A.PRGRM_NM             /*프로그램명*/
          , A.USERID               /*신청자 ID*/
          , Z.RTURN_BGNG_DE
          , Z.RTURN_END_DE
          , CONCAT(A.APLCNT_NM,'(', USR.ACNT, ')')    AS USER_NM_ACNT
          , D.BANK_CD
          , D.BACNTNO
          , D.DPSTR_NM
          , Z.DMND_STTS_CD
          , Z.CN    /*기타*/
          , Z.CNCL_DT    /*취소일시(신청일)*/
        FROM
            TB_SPB_BSNS_CNCL_DMND Z
        INNER JOIN
            TB_SPB_APLY A ON Z.APLYID = A.APLYID
        LEFT OUTER JOIN
            TB_SPB_DELVRY_APLY D ON A.APLYID = D.APLYID
        LEFT OUTER JOIN
            TB_CMM_USER USR ON A.USERID = USR.USERID
        WHERE 1=1
        AND A.APLYID = #{aplyid}
    </select>

    <!-- 사업포기관리 수정 -->
    <insert id="updateBizAbnd" parameterType="BizRptVo" >
    /* BizRptDao.updateBizAbnd */
    UPDATE
        TB_SPB_BSNS_CNCL_DMND
    SET
        RTURN_BGNG_DE  = #{rturnBgngDe}
      , RTURN_END_DE   = #{rturnEndDe}
      , CN             = #{cn}
      , DMND_STTS_CD   = #{dmndSttsCd}
      , APRV_DT        = NOW()
      , MDFCN_DT       = NOW()
      , MDFRID         = #{user.userid}
    WHERE
        DMNDID = #{dmndid}

    </insert>

    <!-- 사업취소상태 여부 수정-->
    <update id="updateBsnsCnclYn">
        UPDATE
            TB_SPB_APLY
        SET
            BSNS_CNCL_YN = #{bsnsCnclYn}
          , MDFCN_DT = NOW()
          , MDFRID = #{user.userid}
        WHERE
            APLYID = #{aplyid}
    </update>





</mapper>
