<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : DsgnPrgrmDaoImpl.xml
    Description : 지정제심사 관리
-->
<mapper namespace="com.kbrainc.plum.mng.dsgnPrgrm.model.DsgnPrgrmDao">

    <!-- 지정프로그램 목록 조회. -->
    <select id="selectDsgnPrgrmList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        /* DsgnPrgrmDao.selectDsgnPrgrmList */
        <include refid="PaginationMapper.header"/>
        SELECT
            DISTINCT A.PRGRMID
          , Z.HSTRYID
          , A.INSTID
          , A.DSGN_CYCL
          , A.DSGN_NO
          , A.PRGRM_NM
          , A.INST_NM
          , A.STTS_CD
          , B.CHG_APLY_CNT
          , C.OPER_RSLT_CNT
          , D.IMPLMNT_IDNTY_CNT
          , E.OBJC_INFO_CNT
          , A.DSGN_BGNG_DE
          , A.DSGN_END_DE
          , CONCAT(A.DSGN_BGNG_DE, " ~ ", A.DSGN_END_DE )   AS DSGN_PRD
        FROM
            TB_ASS_PRGRM A
        INNER JOIN /*지정 이력*/
        (
            SELECT
                ZZ.PRGRMID
              , MAX(ZZ.HSTRYID) AS HSTRYID
            FROM TB_ASS_DSGN_HSTRY ZZ
            WHERE 1=1
            GROUP BY ZZ.PRGRMID
        ) Z ON A.PRGRMID = Z.PRGRMID
        LEFT OUTER JOIN
            (
                SELECT
                    BB.PRGRMID
                  , BB.APLYID
                  , CONCAT(COUNT(CASE WHEN BB.APLY_STTS_CD = '119104' THEN 1 END), "/", COUNT(BB.APLYID))    AS CHG_APLY_CNT
                FROM
                    TB_ASS_CHG_APLY BB
                GROUP BY
                    BB.PRGRMID
            ) B ON A.PRGRMID = B.PRGRMID
        LEFT OUTER JOIN
            (
                SELECT
                    CC.PRGRMID
                  , CC.STTS_CD
                  , CONCAT(COUNT(CASE WHEN CC.STTS_CD = '126103' THEN 1 END), "/", COUNT(CC.CYCLID ))    AS OPER_RSLT_CNT
                FROM
                    TB_ASS_OPER_RSLT_CYCL CC
                GROUP BY
                    CC.CYCLID
            ) C ON A.PRGRMID =C.PRGRMID
        LEFT OUTER JOIN
            (
                SELECT
                    AA.PRGRMID
                  , AA.CYCLID
                  , CC.SRNGID
                  , CONCAT(COUNT(CASE WHEN CC.FILEGRPID IS NOT NULL THEN 0 END), "/", COUNT(BB.CYCLID))    AS IMPLMNT_IDNTY_CNT
                FROM
                    TB_ASS_OPER_RSLT_CYCL AA
                LEFT OUTER JOIN
                    TB_ASS_OPER_RSLT BB ON AA.CYCLID = BB.CYCLID
                LEFT OUTER JOIN
                    TB_ASS_IMPLMNT_IDNTY_SRNG CC ON AA.CYCLID =CC.CYCLID
            ) D ON A.PRGRMID = D.PRGRMID
        LEFT OUTER JOIN
            (
                SELECT
                    AA.PRGRMID
                  , CONCAT(COUNT(AA.APLYID), "/", COUNT(CASE WHEN AA.APLY_STTS_CD = '129101' THEN 1 END)) AS OBJC_INFO_CNT
                FROM
                    TB_ASS_OBJC_APLY AA
                GROUP BY
                    AA.PRGRMID
            ) E ON A.PRGRMID = E.PRGRMID
        WHERE 1=1
        <!-- 키워드.프로그램명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'prgrmNm'">
            AND A.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 키워드.기관명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'instNm'">
            AND A.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 키워드.지정번호 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'dsgnNo'">
            AND A.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 지정상태  -->
        <if test="searchSttsCd != null and searchSttsCd != ''">
            AND A.STTS_CD = #{searchSttsCd}
        </if>
        <!-- 지정일 검색시작일  -->
        <if test="searchStartDsgnDe != null and searchStartDsgnDe != ''">
            AND A.A.DSGN_BGNG_DE >= #{searchStartDsgnDe}
        </if>
        <!-- 지정일 검색종료일  -->
        <if test="searchEndDsgnDe  != null and searchEndDsgnDe != ''">
            AND A.DSGN_END_DE <![CDATA[<]]> CAST(CONCAT(#{searchEndDsgnDe},' 23:59:59') AS DATETIME)
        </if>
        <!-- 차수 -->
        <if test="searchDsgnCycl != null and searchDsgnCycl != ''">
            AND A.DSGN_CYCL = #{searchDsgnCycl}
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 지정프로그램 상세 조회 -->
    <select id="selectDsgnPrgrm" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            A.INSTID              /* 기관아이디 */
          , A.APLCNTID            /* 신청자아이디 */
          , A.APLCNT_NM           /* 신청자_이름 */
          , A.APLCNT_EML          /* 신청자_이메일 */
          , A.APLCNT_MOBLPHON     /* 신청자_휴대폰 */
          , A.INST_NM             /* 기관_이름 */
          , A.INST_EML            /* 기관_이메일 */
          , A.INST_CNTCT          /* 기관_연락처 */
          , A.INST_HMPG           /* 기관_홈페이지 */
          , A.INST_TYPE_CD        /* 기관_유형_코드 */
          , A.INST_RGN_CD         /* 기관_지역_코드 */
          , A.INST_ZIP            /* 기관_우편번호 */
          , A.INST_ADDR           /* 기관_주소 */
          , A.INST_DTLADDR        /* 기관_상세주소 */
          , A.PRGRM_NM            /* 프로그램_이름 */
          , A.FILEGRPID           /* 파일그룹아이디 */
          , A.DSGN_DE             /* 지정_일자 */
          , B.DSGN_CYCL           /* 지정_차수 */
          , B.DSGN_NO             /* 지정_번호 */
          , B.DSGN_BGNG_DE        /* 지정_시작_일자 */
          , B.DSGN_END_DE         /* 지정_종료_일자 */
          , CONCAT(B.DSGN_CYCL, "/", B.DSGN_NO)    AS CYCL_NO
          , CONCAT(B.DSGN_BGNG_DE, " ~ ", B.DSGN_END_DE )   AS DSGN_PRD
          , B.HSTRYID
          , B.DSGN_OBTAIN_DE      /* 지정획득일자*/
          , B.STTS_CD             /* 지정_상태_코드 */
          , (SELECT BRNO FROM TB_CMM_INST WHERE A.INSTID= INSTID) AS BRNO
        FROM
            TB_ASS_PRGRM A
        INNER JOIN /*지정 이력*/
            TB_ASS_DSGN_HSTRY B ON A.PRGRMID = B.PRGRMID
        WHERE 1=1
        AND A.PRGRMID = #{prgrmid}
        AND B.HSTRYID = #{hstryid}
    </select>


    <!-- 지정내역 목록 조회 -->
    <select id="selectDsgnDsctnList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">

        /* DsgnPrgrmDao.selectDsgnDsctnList*/
        <include refid="PaginationMapper.header"/>
        SELECT
            A.HSTRYID
          , A.PRGRMID
          , A.DSGN_CYCL
          , A.DSGN_NO
          , A.DSGN_OBTAIN_DE
          , A.DSGN_BGNG_DE
          , A.DSGN_END_DE
          , A.DSGN_CNCL_DE
          , CONCAT(A.DSGN_BGNG_DE, " ~ ", A.DSGN_END_DE )   AS DSGN_PRD
          , A.STTS_CD
          , A.MDFCN_DT
          , A.MDFRID
          , A.REG_DT
          , CONCAT( B.NM ,"(",B.ACNT,")" ) AS RGTR_NM
        FROM
            TB_ASS_DSGN_HSTRY A
        LEFT OUTER JOIN
            TB_CMM_USER B ON A.RGTRID = B.USERID
        WHERE 1=1
        AND A.PRGRMID = #{prgrmid}
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 지정 내역 저장 -->
    <insert id="insertDsgnHstry" parameterType="DsgnPrgrmVo" >
        /* AsgsysSrngDao.insertDsgnHstry*/
        INSERT
        INTO TB_ASS_DSGN_HSTRY
        (
            PRGRMID
          , DSGN_CYCL
          , DSGN_NO
          , DSGN_OBTAIN_DE
          , DSGN_BGNG_DE
          , DSGN_END_DE
          , DSGN_CNCL_DE
          , STTS_CD
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES
        (
            #{prgrmid     }
          , #{dsgnCycl    }
          , #{dsgnNo      }
          , #{dsgnObtainDe}
          , #{dsgnBgngDe  }
          , #{dsgnEndDe   }
          , #{dsgnCnclDe  }
          , #{sttsCd      }
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        );
    </insert>

</mapper>