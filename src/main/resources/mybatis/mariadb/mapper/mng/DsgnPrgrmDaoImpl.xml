<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : DsgnPrgrmDaoImpl.xml
    Description : 지정제심사 관리
-->
<mapper namespace="com.kbrainc.plum.mng.dsgnPrgrm.model.DsgnPrgrmDao">


    <!-- 지정번호 조회 -->
    <select id="selectDsgnNoDupChk" parameterType="DsgnPrgrmVo" resultType="int">
        SELECT
            COUNT(1) AS cnt
        FROM
            TB_ASS_PRGRM A
        WHERE 1=1
        AND A.DSGN_NO = #{dsgnNo}
        AND A.PRGRMID <![CDATA[<>]]> #{prgrmid}
    </select>

    <!-- 지정번호 조회 -->
    <select id="selectDsgnNo" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
       SELECT
            CASE WHEN MAX(DSGN_CYCL) IS NULL
                 THEN CONCAT(DATE_FORMAT(NOW(), '%Y'), '-','001')
                 ELSE CONCAT(DATE_FORMAT(NOW(), '%Y'), '-',LPAD(MAX(DSGN_CYCL)+1,3,0))
            END    AS DSGN_NO
          , CASE WHEN MAX(DSGN_CYCL) IS NULL
                 THEN 1
                 ELSE MAX(DSGN_CYCL) + 1
            END    AS DSGN_CYCL
          , #{prgrmid} AS PRGRMID
          , DATE_FORMAT( NOW(), '%Y-%m-%d')    AS DSGN_BGNG_DE
          , DATE_FORMAT( DATE_SUB(DATE_ADD( NOW(),INTERVAL 3 YEAR),INTERVAL 1 DAY), '%Y-%m-%d')    AS DSGN_END_DE
        FROM TB_ASS_DSGN_HSTRY
        WHERE PRGRMID = #{prgrmid}
    </select>

    <!-- 지정내역 조회. -->
    <select id="selectDsgnHstry" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            HSTRYID
          , PRGRMID
          , DSGN_CYCL
          , DSGN_NO
          , DSGN_OBTAIN_DE
          , DSGN_BGNG_DE
          , DSGN_END_DE
          , DSGN_CNCL_DE
          , STTS_CD
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        FROM
            TB_ASS_DSGN_HSTRY
        WHERE
            PRGRMID = #{prgrmid}
    </select>

    <!-- 지정 프로그램 조회-->
    <select id="selectPrgrm" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            PRGRMID              /*프로그램아이디*/
          , INSTID              /*기관아이디*/
          , APLCNTID            /*신청자아이디*/
          , APLCNT_NM           /*신청자_이름*/
          , APLCNT_EML          /*신청자_이메일*/
          , APLCNT_MOBLPHON     /*신청자_휴대폰*/
          , INST_NM             /*기관_이름*/
          , INST_EML            /*기관_이메일*/
          , INST_CNTCT          /*기관_연락처*/
          , INST_HMPG           /*기관_홈페이지*/
          , INST_TYPE_CD        /*기관_유형_코드*/
          , INST_RGN_CD         /*기관_지역_코드*/
          , INST_ZIP            /*기관_우편번호*/
          , INST_ADDR           /*기관_주소*/
          , INST_DTLADDR        /*기관_상세주소*/
          , PRGRM_NM            /*프로그램_이름*/
          , FILEGRPID           /*파일그룹아이디*/
          , STTS_CD             /*상태_코드*/
          , DSGN_CYCL           /*지정_차수*/
          , DSGN_NO             /*지정_번호*/
          , DSGN_DE             /*지정_일자*/
          , DSGN_BGNG_DE        /*지정_시작_일자*/
          , DSGN_END_DE         /*지정_종료_일자*/
          , AUTZRID             /*승인자아이디*/
          , CHKLSTID            /*체크리스트아이디*/
          , CNSLTNG_PRGRS_YN    /*컨설팅__진행_여부*/
          , CNSLTNGID           /*컨설텅아이디*/
          , APLY_DT             /*신청_일시*/
          , MDFCN_DT            /*수정_일시*/
          , MDFRID              /*수정자아이디*/
          , REG_DT              /*등록_일시*/
          , RGTRID              /*등록자아이디*/
        FROM TB_ASS_PRGRM
        WHERE PRGRMID = #{prgrmid}
    </select>

    <!-- 지정프로그램 목록 조회. -->
    <select id="selectDsgnPrgrmList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        /* DsgnPrgrmDao.selectDsgnPrgrmList */
        <include refid="PaginationMapper.header"/>
        SELECT
            DISTINCT A.PRGRMID
          , Z.HSTRYID
          , A.INSTID
          , Z.DSGN_CYCL
          , Z.DSGN_NO
          , A.PRGRM_NM
          , A.INST_NM
          , Z.STTS_CD
          , IFNULL(B.CHG_APLY_CNT      ,'0/0')    AS CHG_APLY_CNT
          , IFNULL(C.OPER_RSLT_CNT     ,'0/0')    AS OPER_RSLT_CNT
          , IFNULL(D.IMPLMNT_IDNTY_CNT ,'0/0')    AS IMPLMNT_IDNTY_CNT
          , IFNULL(E.OBJC_INFO_CNT     ,'0/0')    AS OBJC_INFO_CNT
          , A.DSGN_BGNG_DE
          , A.DSGN_END_DE
          , CONCAT(A.DSGN_BGNG_DE, " ~ ", A.DSGN_END_DE )   AS DSGN_PRD
          , A.REG_DT
        FROM
            TB_ASS_PRGRM A
        INNER JOIN /*지정 이력*/
            TB_ASS_DSGN_HSTRY Z  ON A.PRGRMID = Z.PRGRMID
                                AND Z.HSTRYID =(SELECT MAX(ZZ.HSTRYID) FROM TB_ASS_DSGN_HSTRY ZZ WHERE   Z.PRGRMID = ZZ.PRGRMID )
        LEFT OUTER JOIN
            (
                SELECT
                    BB.PRGRMID
                  , BB.APLYID
                  , CONCAT(COUNT(CASE WHEN BB.APLY_STTS_CD = '119104' THEN 1 END), "/", COUNT(BB.APLYID))    AS CHG_APLY_CNT
                FROM
                    TB_ASS_CHG_APLY BB
                GROUP BY
                    BB.PRGRMID
            ) B ON A.PRGRMID = B.PRGRMID
        LEFT OUTER JOIN
            (
                SELECT
                    CC.PRGRMID
                  , CC.STTS_CD
                  , CONCAT(COUNT(CASE WHEN CC.STTS_CD = '128103' THEN 1 END), "/", COUNT(CC.CYCLID ))    AS OPER_RSLT_CNT
                FROM
                    TB_ASS_OPER_RSLT_CYCL CC
                GROUP BY
                    CC.PRGRMID
            ) C ON A.PRGRMID =C.PRGRMID
        LEFT OUTER JOIN
            (
                SELECT
                    AA.PRGRMID
                  , AA.CYCLID
                  , CC.SRNGID
                  , CONCAT(COUNT(CASE WHEN FILE.FILEID IS NOT NULL THEN 0 END), "/", COUNT(BB.CYCLID))    AS IMPLMNT_IDNTY_CNT
                FROM
                    TB_ASS_OPER_RSLT_CYCL AA
                LEFT OUTER JOIN
                    TB_ASS_OPER_RSLT BB ON AA.CYCLID = BB.CYCLID
                LEFT OUTER JOIN
                    TB_ASS_IMPLMNT_IDNTY_SRNG CC ON AA.CYCLID =CC.CYCLID
                LEFT OUTER JOIN
                (
                    SELECT MAX(FILEID) AS FILEID ,FILEGRPID FROM TB_CMM_FILE GROUP BY FILEGRPID
                ) FILE ON CC.FILEGRPID = FILE.FILEGRPID
                WHERE 1=1
                AND NOW() BETWEEN AA.SBMSN_BGNG_DE AND AA.SBMSN_END_DE
                GROUP BY AA.PRGRMID
            ) D ON A.PRGRMID = D.PRGRMID
        LEFT OUTER JOIN
            (
                SELECT
                    AA.PRGRMID
                  , CONCAT(COUNT(AA.APLYID), "/", COUNT(CASE WHEN AA.APLY_STTS_CD = '129101' THEN 1 END)) AS OBJC_INFO_CNT
                FROM
                    TB_ASS_OBJC_APLY AA
                GROUP BY
                    AA.PRGRMID
            ) E ON A.PRGRMID = E.PRGRMID
        WHERE 1=1
        <!-- 키워드.프로그램명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'prgrmNm'">
            AND A.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 키워드.기관명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'instNm'">
            AND A.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 키워드.지정번호 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'dsgnNo'">
            AND A.DSGN_NO LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 지정상태  -->
        <if test="searchSttsCd != null and searchSttsCd != ''">
            AND Z.STTS_CD = #{searchSttsCd}
        </if>
        <!-- 지정일 검색시작일  -->
        <if test="searchStartDsgnDe != null and searchStartDsgnDe != ''">
            AND A.DSGN_BGNG_DE >= #{searchStartDsgnDe}
        </if>
        <!-- 지정일 검색종료일  -->
        <if test="searchEndDsgnDe  != null and searchEndDsgnDe != ''">
            AND A.DSGN_END_DE <![CDATA[<]]> CAST(CONCAT(#{searchEndDsgnDe},' 23:59:59') AS DATETIME)
        </if>
        <!-- 차수 -->
        <if test="searchDsgnCycl != null and searchDsgnCycl != ''">
            AND Z.DSGN_CYCL = #{searchDsgnCycl}
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 지정프로그램 목록 엑셀 다운. -->
    <select id="selectDsgnPrgrmExcelDownList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        /* DsgnPrgrmDao.selectDsgnPrgrmExcelDownList */
        SELECT
            DISTINCT A.PRGRMID
          , Z.HSTRYID
          , A.INSTID
          , Z.DSGN_CYCL
          , Z.DSGN_NO
          , A.PRGRM_NM
          , A.INST_NM
          , Z.STTS_CD
          , B.CHG_APLY_CNT
          , C.OPER_RSLT_CNT
          , D.IMPLMNT_IDNTY_CNT
          , E.OBJC_INFO_CNT
          , A.DSGN_BGNG_DE
          , A.DSGN_END_DE
          , CONCAT(A.DSGN_BGNG_DE, " ~ ", A.DSGN_END_DE )   AS DSGN_PRD
          , A.REG_DT
        FROM
            TB_ASS_PRGRM A
        INNER JOIN /*지정 이력*/
            TB_ASS_DSGN_HSTRY Z  ON A.PRGRMID = Z.PRGRMID
                                AND Z.HSTRYID =(SELECT MAX(ZZ.HSTRYID) FROM TB_ASS_DSGN_HSTRY ZZ WHERE   Z.PRGRMID = ZZ.PRGRMID )
        LEFT OUTER JOIN
            (
                SELECT
                    BB.PRGRMID
                  , BB.APLYID
                  , CONCAT(COUNT(CASE WHEN BB.APLY_STTS_CD = '119104' THEN 1 END), "/", COUNT(BB.APLYID))    AS CHG_APLY_CNT
                FROM
                    TB_ASS_CHG_APLY BB
                GROUP BY
                    BB.PRGRMID
            ) B ON A.PRGRMID = B.PRGRMID
        LEFT OUTER JOIN
            (
                SELECT
                    CC.PRGRMID
                  , CC.STTS_CD
                  , CONCAT(COUNT(CASE WHEN CC.STTS_CD = '128103' THEN 1 END), "/", COUNT(CC.CYCLID ))    AS OPER_RSLT_CNT
                FROM
                    TB_ASS_OPER_RSLT_CYCL CC
                GROUP BY
                    CC.PRGRMID
            ) C ON A.PRGRMID =C.PRGRMID
        LEFT OUTER JOIN
            (
                SELECT
                    AA.PRGRMID
                  , AA.CYCLID
                  , CC.SRNGID
                  , CONCAT(COUNT(CASE WHEN CC.FILEGRPID IS NOT NULL THEN 0 END), "/", COUNT(BB.CYCLID))    AS IMPLMNT_IDNTY_CNT
                FROM
                    TB_ASS_OPER_RSLT_CYCL AA
                LEFT OUTER JOIN
                    TB_ASS_OPER_RSLT BB ON AA.CYCLID = BB.CYCLID
                LEFT OUTER JOIN
                    TB_ASS_IMPLMNT_IDNTY_SRNG CC ON AA.CYCLID =CC.CYCLID
                WHERE 1=1
                AND NOW() BETWEEN AA.SBMSN_BGNG_DE AND AA.SBMSN_END_DE
                GROUP BY AA.PRGRMID
            ) D ON A.PRGRMID = D.PRGRMID
        LEFT OUTER JOIN
            (
                SELECT
                    AA.PRGRMID
                  , CONCAT(COUNT(AA.APLYID), "/", COUNT(CASE WHEN AA.APLY_STTS_CD = '129101' THEN 1 END)) AS OBJC_INFO_CNT
                FROM
                    TB_ASS_OBJC_APLY AA
                GROUP BY
                    AA.PRGRMID
            ) E ON A.PRGRMID = E.PRGRMID
        WHERE 1=1
        <!-- 키워드.프로그램명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'prgrmNm'">
            AND A.PRGRM_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 키워드.기관명 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'instNm'">
            AND A.INST_NM LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 키워드.지정번호 -->
        <if test="searchKeyword != null and searchKeyword != '' and searchType == 'dsgnNo'">
            AND Z.DSGN_NO LIKE CONCAT('%',#{searchKeyword},'%')
        </if>
        <!-- 지정상태  -->
        <if test="searchSttsCd != null and searchSttsCd != ''">
            AND Z.STTS_CD = #{searchSttsCd}
        </if>
        <!-- 지정일 검색시작일  -->
        <if test="searchStartDsgnDe != null and searchStartDsgnDe != ''">
            AND A.DSGN_BGNG_DE >= #{searchStartDsgnDe}
        </if>
        <!-- 지정일 검색종료일  -->
        <if test="searchEndDsgnDe  != null and searchEndDsgnDe != ''">
            AND A.DSGN_END_DE <![CDATA[<]]> CAST(CONCAT(#{searchEndDsgnDe},' 23:59:59') AS DATETIME)
        </if>
        <!-- 차수 -->
        <if test="searchDsgnCycl != null and searchDsgnCycl != ''">
            AND Z.DSGN_CYCL = #{searchDsgnCycl}
        </if>

    </select>

    <!-- 지정프로그램 상세 조회 -->
    <select id="selectDsgnPrgrm" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            A.PRGRMID             /* 프로그램_아이디 */
          , Z.HSTRYID
          , A.INSTID              /* 기관아이디 */
          , A.APLCNTID            /* 신청자아이디 */
          , A.APLCNT_NM           /* 신청자_이름 */
          , A.APLCNT_EML          /* 신청자_이메일 */
          , A.APLCNT_MOBLPHON     /* 신청자_휴대폰 */
          , A.INST_NM             /* 기관_이름 */
          , A.INST_EML            /* 기관_이메일 */
          , A.INST_CNTCT          /* 기관_연락처 */
          , A.INST_HMPG           /* 기관_홈페이지 */
          , A.INST_TYPE_CD        /* 기관_유형_코드 */
          , A.INST_RGN_CD         /* 기관_지역_코드 */
          , CTPRVN.CTPRVN_NM    AS INST_RGN_CD_NM         /* 기관_지역_코드 */
          , INST.RPRSV_NM
          , A.INST_ZIP            /* 기관_우편번호 */
          , A.INST_ADDR           /* 기관_주소 */
          , A.INST_DTLADDR        /* 기관_상세주소 */
          , A.PRGRM_NM            /* 프로그램_이름 */
          , A.FILEGRPID           /* 파일그룹아이디 */
          , A.DSGN_DE             /* 지정_일자 */
          , Z.DSGN_CYCL           /* 지정_차수 */
          , Z.DSGN_NO             /* 지정_번호 */
          , Z.DSGN_BGNG_DE        /* 지정_시작_일자 */
          , Z.DSGN_END_DE         /* 지정_종료_일자 */
          , Z.DSGN_CNCL_DE        /* 지정_취소_일자 */
          , CONCAT(Z.DSGN_CYCL, "/", Z.DSGN_NO)    AS CYCL_NO
          , CONCAT(Z.DSGN_BGNG_DE, " ~ ", Z.DSGN_END_DE )   AS DSGN_PRD
          , Z.DSGN_OBTAIN_DE      /* 지정획득일자*/
          , Z.STTS_CD             /* 지정_상태_코드 */
          , (SELECT BRNO FROM TB_CMM_INST WHERE A.INSTID= INSTID) AS BRNO
        FROM
            TB_ASS_PRGRM A
        INNER JOIN /*지정 이력*/
            TB_ASS_DSGN_HSTRY Z  ON A.PRGRMID = Z.PRGRMID
                                AND Z.HSTRYID =(SELECT MAX(ZZ.HSTRYID) FROM TB_ASS_DSGN_HSTRY ZZ WHERE   Z.PRGRMID = ZZ.PRGRMID )
        LEFT OUTER JOIN TB_CMM_ADDR_CTPRVN CTPRVN ON SUBSTR(A.INST_RGN_CD,1,2) = CTPRVN.CTPRVN_CD
        LEFT OUTER JOIN TB_CMM_INST INST ON A.INSTID = INST.INSTID
        WHERE 1=1
        AND A.PRGRMID = #{prgrmid}

    </select>

    <!-- 지정내역 목록 조회 -->
    <select id="selectDsgnDsctnList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        /* DsgnPrgrmDao.selectDsgnDsctnList*/
        <include refid="PaginationMapper.header"/>
        SELECT
            A.HSTRYID
          , A.PRGRMID
          , A.DSGN_CYCL
          , A.DSGN_NO
          , A.DSGN_OBTAIN_DE
          , A.DSGN_BGNG_DE
          , A.DSGN_END_DE
          , A.DSGN_CNCL_DE
          , CONCAT(A.DSGN_BGNG_DE, " ~ ", A.DSGN_END_DE )   AS DSGN_PRD
          , A.STTS_CD
          , A.MDFCN_DT
          , A.MDFRID
          , A.REG_DT
          , CONCAT( B.NM ,"(",B.ACNT,")" ) AS RGTR_NM
        FROM
            TB_ASS_DSGN_HSTRY A
        LEFT OUTER JOIN
            TB_CMM_USER B ON A.RGTRID = B.USERID
        WHERE 1=1
        AND A.PRGRMID = #{prgrmid}
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 지정프로그램 개요 조회 -->
    <select id="selectDsgnOutl" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        /* DsgnPrgrmDao.selectDsgnOutl*/
        SELECT
            A.PRGRMID
          , A.PRGRM_NM         /*프로그램명 */
          , (F.SCR +  D.SCR) FINAL_SCR        /*지원단 점수*/
          , (F.SCR +  E.SCR) DCMNT_SRNG_SRC   /*신청자 자가진단 점수(서류심사) */
          , (F.SCR +  D.SCR)-(F.SCR +  E.SCR)   VST_CHK_SRC /*방문점검 점수(현장점검) */
          , B.EDU_NOPE         /*교육인원 */
          , B.EDU_CNT          /*교육시간_회*/
          , B.EDU_HR           /*교육시간_시간 */
          , B.EDU_MNT          /*교육시간_분 */
          , B.STY_YN           /*숙박여부 */
          , CD.CD_NM    AS OPER_FRM_CD_NM /*운영형태 */
          , GROUP_CONCAT(EDUCD.CD_NM separator ', ') AS EDU_SBJCT_NM_LST    /*교육주제 */
                    , CONCAT_WS(', ',
                             CASE WHEN B.INFNT   = 'Y' THEN '유아' END
                           , CASE WHEN B.SCHBOY  = 'Y' THEN '초등학생' END
                           , CASE WHEN B.MSKLSD  = 'Y' THEN '중학생' END
                           , CASE WHEN B.HGSCHST = 'Y' THEN '고등학생' END
                           , CASE WHEN B.ADULT   = 'Y' THEN '성인' END
                           ) AS EDU_TARGET    /*교육대상 */
          , MNG.ETRFEE_INCM                   /*운영예산.참가비 */
          , MNG.SLFPY                         /*운영예산.자부담 */
          , MNG.ETC_INCM                      /*운영예산.후원 */
          , B.EDU_PLC                         /*교육장소 */
          , A.INST_NM                         /*기관명 */
          , INSTCD.CD_NM    AS INST_TYPE_CD_NM     /*기관유형 */
          , C.HSTRY_CNT                       /*보유지정프로그램 */
          , C.GRP_DSGN_NO                     /*지정번호 */
          , B.EDU_PRPS                        /*교육목적 */
          , B.APPRO                           /*적절성 */
          , B.DSTNCTN                         /*우수성 */
          , B.EDU_CN                          /*교육내용 */
          , D.CHKLST_RSLT_CN                  /*현장점검 총평*/
        FROM
            TB_ASS_PRGRM A
            LEFT OUTER JOIN TB_ASS_PRGRM_DSTNCTN B ON A.PRGRMID = B.PRGRMID
            LEFT OUTER JOIN TB_ASS_PRGRM_OPER_MNG MNG ON A.PRGRMID = MNG.PRGRMID
            LEFT OUTER JOIN TB_CMM_CD CD ON B.OPER_FRM_CD = CD.CD
            LEFT OUTER JOIN TB_CMM_CD INSTCD ON A.INST_TYPE_CD = INSTCD.CD
            LEFT OUTER JOIN  TB_ASS_PRGRM_EDU_SBJCT EDU ON A.PRGRMID = EDU.PRGRMID
            LEFT OUTER JOIN TB_CMM_CD EDUCD ON EDU.EDU_SBJCT_CD = EDUCD.CD
            LEFT OUTER JOIN
            (
                SELECT PRGRMID
                      , GROUP_CONCAT(DSGN_NO separator ',')    GRP_DSGN_NO
                      , DSGN_CYCL
                      , COUNT(HSTRYID) HSTRY_CNT
                  FROM TB_ASS_DSGN_HSTRY
                 WHERE 1=1
                   AND STTS_CD = 132101
                   AND PRGRMID = #{prgrmid}
                 ORDER BY DSGN_CYCL DESC
            ) C ON A.PRGRMID = C.PRGRMID
            LEFT OUTER JOIN
            (
                SELECT * FROM TB_ASS_CHKLST_SBMSN
                WHERE PRGRMID = #{prgrmid}
                AND SBMSN_SE_CD = 242102
            ) D ON A.PRGRMID = D.PRGRMID    /*지원단 심사*/
            LEFT OUTER JOIN
            (
                SELECT * FROM TB_ASS_CHKLST_SBMSN
                WHERE PRGRMID = #{prgrmid}
                AND SBMSN_SE_CD = 242101
            ) E ON A.PRGRMID = E.PRGRMID    /*신청자 자가진단*/
            LEFT OUTER JOIN
            (
                SELECT ROUND(SUM(SCR)/COUNT(USERID),2) SCR
                , PRGRMID
                FROM TB_ASS_SRNG_SBMSN
                WHERE PRGRMID = #{prgrmid}
            ) F ON A.PRGRMID = F.PRGRMID    /*심사위원심사*/
        WHERE 1=1
        AND   A.PRGRMID = #{prgrmid}
        GROUP BY A.PRGRMID
    </select>

    <!-- 지정프로그램 개요 체크리스트 목록 조회 -->
    <select id="selectDsgnOutlChkList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
         SELECT
             AA.SE_CD
           , AA.CD_NM
           , AA.ORDR
           , MAX(IF(AA.SBMSN_SE_CD='242101',SCR,NULL))   AS APLCNT_SCR
           , MAX(IF(AA.SBMSN_SE_CD='242102',SCR,NULL))   AS SRNG_SCR
         FROM
         (
         SELECT
             A.PRGRMID
           , B.USERID
           , B.SBMSN_SE_CD
           , C.ORDR
           , C.SE_CD
           , CD.CD_NM
           , SUM(D.SCR)    AS SCR
         FROM TB_ASS_PRGRM A
         LEFT OUTER JOIN TB_ASS_CHKLST_SBMSN B ON A.PRGRMID = B.PRGRMID
         LEFT OUTER JOIN TB_ASS_CHKLST_SE_ORDR_ANS C ON B.SBMSNID =C.SBMSNID
         LEFT OUTER JOIN TB_ASS_CHKLST_ANS D ON B.SBMSNID = D.SBMSNID AND C.SE_CD = D.SE_CD
         LEFT OUTER JOIN TB_CMM_CD CD ON C.SE_CD =CD.CD
         WHERE A.PRGRMID = #{prgrmid}
         GROUP BY B.USERID, C.SE_CD
         ) AA
         GROUP BY AA.ORDR
    </select>

    <!-- 이의신청 목록 조회 -->
    <select id="selectObjcList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmObjcVo">
        <include refid="PaginationMapper.header"/>
        SELECT
        PRGRMID
        , APLYID
        , TTL
        , CN
        , APLY_STTS_CD
        , REG_DT
        , MDFCN_DT
        , ANS_DT
        FROM TB_ASS_OBJC_APLY
        WHERE PRGRMID = #{prgrmid}
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 이의신청 정보 조회 -->
    <select id="selectObjcInfo" resultType="DsgnPrgrmObjcVo">
        SELECT PRGRMID
             , APLYID
             , TTL
             , CN
             , APLY_STTS_CD
             , REG_DT
             , MDFCN_DT
             , ANS_DT
             , ANS
        FROM TB_ASS_OBJC_APLY
        WHERE APLYID = #{aplyid}
    </select>

    <!-- 이의신청 등록-->
    <insert id="insertObjcAns" >
        INSERT INTO TB_ASS_OBJC_APLY
        (
            PRGRMID
          , TTL
          , CN
          , APLCNTID
          , ANS
          , APLY_STTS_CD
          , PICID
          , ANS_DT
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES
        (
            #{prgrmid}       /*프로그램아이디*/
          , #{ttl}           /*제목*/
          , #{cn}            /*내용*/
          , #{aplyid}        /*신청자아이디*/
          , #{ans}           /*답변*/
          , #{aplySttsCd}    /*신청상태코드*/
          , #{user.userid}         /*담당자아이디*/
          , DATE_FORMAT(NOW(),'%Y-%m-%d')
          , NOW()            /*수정일시*/
          , #{user.userid}   /*수정자아이디*/
          , NOW()            /*등록일시*/
          , #{user.userid}   /*등록자아이디*/
        )
    </insert>

    <!-- 이의신청 수정-->
    <update id="updateObjcAns">
        UPDATE TB_ASS_OBJC_APLY
        SET
          ANS = #{ans}
        , APLY_STTS_CD = #{aplySttsCd}
        , CN = #{cn}
        , PICID = #{user.userid}
        , MDFCN_DT = NOW()
        , MDFRID = #{user.userid}
        , ANS_DT = DATE_FORMAT(NOW(),'%Y-%m-%d')
        WHERE APLYID = #{aplyid}
    </update>

    <!-- 지정 내역 저장 -->
    <insert id="insertDsgnHstry" parameterType="DsgnPrgrmVo" >
        /* AsgsysSrngDao.insertDsgnHstry*/
        INSERT
        INTO TB_ASS_DSGN_HSTRY
        (
            PRGRMID
          , DSGN_CYCL
          , DSGN_NO
          , DSGN_OBTAIN_DE
          , DSGN_BGNG_DE
          , DSGN_END_DE
          , DSGN_CNCL_DE
          , STTS_CD
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES
        (
            #{prgrmid     }
          , #{dsgnCycl    }
          , #{dsgnNo      }
          , #{dsgnObtainDe}
          , #{dsgnBgngDe  }
          , #{dsgnEndDe   }
          , #{dsgnCnclDe  }
          , #{sttsCd      }
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        );
    </insert>

    <!-- 지정정보 변경 -->
    <update id="updateDsgnHstry" parameterType="AsgsysSrngVo" >
    /* AsgsysSrngDao.updateDsgnHstry*/
        UPDATE
            TB_ASS_DSGN_HSTRY
        SET
            DSGN_CYCL         = #{dsgnCycl    }
          , DSGN_NO           = #{dsgnNo      }
          , DSGN_OBTAIN_DE    = #{dsgnObtainDe}
          , DSGN_BGNG_DE      = #{dsgnBgngDe  }
          , DSGN_END_DE       = #{dsgnEndDe   }
          , DSGN_CNCL_DE      = #{dsgnCnclDe  }
          , STTS_CD           = #{sttsCd      }
          , MDFCN_DT          = NOW()
          , MDFRID            = #{user.userid}
        WHERE
            PRGRMID = #{prgrmid}
        AND HSTRYID = #{hstryid}
    </update>

    <!-- 변경신청목록 조회-->
    <select id="selectChgAplyList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        <include refid="PaginationMapper.header"/>
        SELECT
            A.PRGRMID
          , A.INSTID
          , A.INST_NM
          , A.DSGN_CYCL
          , A.DSGN_NO
          , CONCAT(DSGN_BGNG_DE, " ~ ", DSGN_END_DE ) AS DSGN_PRD    /* 지정유효기간 */
          , B.APLYID
          , B.SAMENSS_YN
          , B.SAMENSS_CN
          , B.PRGRM_CHG_YN
          , B.PRGRM_CHG_CN
          , B.BGT_CHG_YN
          , B.BGT_CHG_CN
          , B.LDR_CHG_YN
          , B.LDR_CHG_CN
          , B.EDU_ENV_CHG_YN
          , B.EDU_ENV_CHG_CN
          , B.CHG_RSN
          , B.FILEGRPID
          , B.APLCNTID
          , B.APLY_STTS_CD
          , B.SPLMNT_DMND_CN
          , IFNULL(DATE_FORMAT(B.STTS_MDFCN_DT, '%Y-%m-%d'),'-')    AS STTS_MDFCN_DE
          , B.STTS_MDFCN_DT
          , B.MDFCN_DT
          , B.MDFRID
          , B.REG_DT
          , B.RGTRID
        FROM
            TB_ASS_PRGRM A
        INNER JOIN
            TB_ASS_CHG_APLY B ON A.PRGRMID = B.PRGRMID
        WHERE 1=1
        AND A.PRGRMID = #{prgrmid}
        <include refid="PaginationMapper.footer"/>
    </select>

    <select id="selectChgAplyDtl" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            A.APLYID
          , A.PRGRMID
          , A.SAMENSS_YN
          , A.SAMENSS_CN
          , A.PRGRM_CHG_YN
          , A.PRGRM_CHG_CN
          , A.BGT_CHG_YN
          , A.BGT_CHG_CN
          , A.LDR_CHG_YN
          , A.LDR_CHG_CN
          , A.EDU_ENV_CHG_YN
          , A.EDU_ENV_CHG_CN
          , A.CHG_RSN
          , A.FILEGRPID
          , A.APLCNTID
          , A.APLY_STTS_CD
          , A.SPLMNT_DMND_CN
          , A.STTS_MDFCN_DT
          , DATE_FORMAT( A.STTS_MDFCN_DT, '%Y-%m-%d')    AS STTS_MDFCN_DE
          , CONCAT(DATE_FORMAT(A.MDFCN_DT, '%Y-%m-%d'),' (',USR1.ACNT ,')')      AS MDFCN_DE
          , CONCAT(DATE_FORMAT(A.REG_DT  , '%Y-%m-%d'),' (',USR2.ACNT ,')')      AS REG_DE
          , A.MDFCN_DT
          , A.MDFRID
          , A.REG_DT
          , A.RGTRID
        FROM
            TB_ASS_CHG_APLY A
        LEFT OUTER JOIN TB_CMM_USER USR1 ON USR1.USERID = A.MDFRID
        LEFT OUTER JOIN TB_CMM_USER USR2 ON USR2.USERID = A.RGTRID
        WHERE
            A.APLYID = #{aplyid}

    </select>

    <!-- 변경신청 상태 수정 -->
    <update id="updateChgAplyStts" parameterType="DsgnPrgrmVo">
        UPDATE
            TB_ASS_CHG_APLY
        SET
            APLY_STTS_CD   = #{aplySttsCd  }
         ,  SPLMNT_DMND_CN = #{splmntDmndCn}
         <if test="aplySttsCd == '119104' ">
         ,  STTS_MDFCN_DT  = NOW()
         </if>
         ,  MDFCN_DT       = NOW()
         ,  MDFRID         = #{user.userid}
        WHERE
            APLYID         = #{aplyid      }
    </update>

    <!-- 지정프로그램-변경신청 등록-->
    <insert id="insertChgAply" parameterType="DsgnPrgrmVo">
    INSERT INTO
        TB_ASS_CHG_APLY (
            PRGRMID
          , SAMENSS_YN
          , SAMENSS_CN
          , PRGRM_CHG_YN
          , PRGRM_CHG_CN
          , BGT_CHG_YN
          , BGT_CHG_CN
          , LDR_CHG_YN
          , LDR_CHG_CN
          , EDU_ENV_CHG_YN
          , EDU_ENV_CHG_CN
          , CHG_RSN
          , FILEGRPID
          , APLCNTID
          , APLY_STTS_CD
          , SPLMNT_DMND_CN
          , STTS_MDFCN_DT
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
          ) VALUES(
            #{prgrmid     }
          , #{samenssYn   }
          , #{samenssCn   }
          , #{prgrmChgYn  }
          , #{prgrmChgCn  }
          , #{bgtChgYn    }
          , #{bgtChgCn    }
          , #{ldrChgYn    }
          , #{ldrChgCn    }
          , #{eduEnvChgYn }
          , #{eduEnvChgCn }
          , #{chgRsn      }
          , #{filegrpid   }
          , #{aplcntid    }
          , #{aplySttsCd  }
          , #{splmntDmndCn}
          , #{sttsMdfcnDt }
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
          );
    </insert>

    <!-- 변경신청상세 수정 -->
    <update id="updateChgAply" parameterType="DsgnPrgrmVo">
        UPDATE
            TB_ASS_CHG_APLY
        SET
            SAMENSS_YN     = #{samenssYn   }
          , SAMENSS_CN     = #{samenssCn   }
          , PRGRM_CHG_YN   = #{prgrmChgYn  }
          , PRGRM_CHG_CN   = #{prgrmChgCn  }
          , BGT_CHG_YN     = #{bgtChgYn    }
          , BGT_CHG_CN     = #{bgtChgCn    }
          , LDR_CHG_YN     = #{ldrChgYn    }
          , LDR_CHG_CN     = #{ldrChgCn    }
          , EDU_ENV_CHG_YN = #{eduEnvChgYn }
          , EDU_ENV_CHG_CN = #{eduEnvChgCn }
          , CHG_RSN        = #{chgRsn      }
          , FILEGRPID      = #{filegrpid   }
          , APLCNTID       = #{aplcntid    }
          , APLY_STTS_CD   = #{aplySttsCd  }
          , SPLMNT_DMND_CN = #{splmntDmndCn}
          , STTS_MDFCN_DT  = #{sttsMdfcnDt}
          , MDFCN_DT       = NOW()
          , MDFRID         = #{user.userid}
        WHERE
            APLYID         = #{aplyid}
    </update>

    <!-- 운영결과서 목록 조회 -->
    <select id="selectOperRsltList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        <include refid="PaginationMapper.header"/>
            SELECT
                B.CYCLID
              , A.PRGRMID
              , C.CYCLID RPT_CYCLID
              , A.STTS_CD
              , B.CYCL
              , A.DSGN_DE
              , B.SBMSN_BGNG_DE
              , B.SBMSN_END_DE
              , CONCAT(B.SBMSN_BGNG_DE, " ~ ", B.SBMSN_END_DE) AS SBMSN_PRD    /* 제출기간 */
              , CASE WHEN NOW() BETWEEN B.SBMSN_BGNG_DE AND B.SBMSN_END_DE
                      THEN CASE WHEN C.CYCLID IS NOT NULL THEN '제출'
                                 ELSE CASE WHEN DATE_ADD(DATE_FORMAT(A.DSGN_DE  - INTERVAL 1 YEAR, '%Y-12-31'), INTERVAL 6 MONTH) >= NOW() THEN '제외' END
                            END
                      ELSE '-'
                END    AS SBMSN_STTS_CD_NM    /*제출상태코드*/
              , CASE WHEN C.CYCLID IS NULL THEN '대기중'
                     WHEN C.CYCLID IS NOT NULL THEN '내용확인'
                     ELSE CASE WHEN NOW() BETWEEN B.SBMSN_BGNG_DE AND B.SBMSN_END_DE
                                 THEN CASE WHEN DATE_ADD(DATE_FORMAT(A.DSGN_DE  - INTERVAL 1 YEAR, '%Y-12-31'), INTERVAL 6 MONTH) >= NOW() THEN '-' END
                                 ELSE '대기중'
                            END
                END    AS SBMSN_IDNTY    /*제출 확인*/
              , B.MDFCN_DT
              , B.MDFRID
              , B.REG_DT
              , B.RGTRID
              , C.MDFCN_DT AS LAST_SBMSN_DT
            FROM
                TB_ASS_PRGRM A
            LEFT OUTER JOIN
                TB_ASS_OPER_RSLT_CYCL B ON A.PRGRMID = B.PRGRMID
            LEFT OUTER JOIN
                TB_ASS_OPER_RSLT C ON B.CYCLID =C.CYCLID
            WHERE A.STTS_CD = '111111'
            AND A.PRGRMID = #{prgrmid}
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 운영결과차수 조회 -->
    <select id="selectOperRsltCycl" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            CYCLID
          , PRGRMID
          , CYCL
          , SBMSN_BGNG_DE
          , SBMSN_END_DE
          , STTS_CD
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        FROM
            TB_ASS_OPER_RSLT_CYCL
        WHERE 1=1
        AND CYCLID = #{cyclid}
    </select>

    <!-- 운영결과 등록 -->
    <insert id="insertOperRsltCyCl" parameterType="DsgnPrgrmVo">
        /* DsgnPrgrmDao.insertOperRsltCycl*/
        INSERT INTO TB_ASS_OPER_RSLT_CYCL
        (
            PRGRMID
          , CYCL
          , SBMSN_BGNG_DE
          , SBMSN_END_DE
          , STTS_CD
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES
        (
            #{prgrmid    }
          , #{cycl       }
          , #{sbmsnBgngDe}
          , #{sbmsnEndDe }
          , #{sttsCd     }
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        )
    </insert>

    <!-- 운영결과차수목록 조회 -->
    <select id="selectOperRsltCyclList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            CYCLID
          , PRGRMID
          , CYCL
          , SBMSN_BGNG_DE
          , SBMSN_END_DE
          , STTS_CD
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        FROM
            TB_ASS_OPER_RSLT_CYCL
        WHERE 1=1
        AND PRGRMID = #{prgrmid}
    </select>

    <!-- 이행확인심사 조회 -->
    <select id="selectImplmntIdntySrng" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
  SELECT
            A.PRGRMID
          , A.PRGRM_NM            /* 프로그램_이름 */
          , A.INSTID              /* 기관아이디 */
          , A.INST_NM             /* 기관_이름 */
          , A.INST_TYPE_CD        /* 기관_유형_코드 */
          , A.INST_RGN_CD         /* 기관_지역_코드 */
          , CTPRVN.CTPRVN_NM    AS INST_RGN_CD_NM
          , A.STTS_CD             /* 상태_코드 */
          , A.DSGN_CYCL           /* 지정_차수 */
          , A.DSGN_NO             /* 지정_번호 */
          , A.DSGN_DE             /* 지정_일자 */
          , A.DSGN_BGNG_DE        /* 지정_시작_일자 */
          , A.DSGN_END_DE         /* 지정_종료_일자 */
          , CONCAT(A.DSGN_CYCL, "/", A.DSGN_NO)    AS CYCL_NO
          , CONCAT(A.DSGN_BGNG_DE, " ~ ", A.DSGN_END_DE )   AS DSGN_PRD
          , (SELECT ACNT FROM TB_CMM_USER WHERE USERID = A.APLCNTID) AS ACNT
        FROM
            TB_ASS_PRGRM A
        INNER JOIN /*지정 이력*/
            TB_ASS_DSGN_HSTRY Z  ON A.PRGRMID = Z.PRGRMID
                                AND Z.HSTRYID =(SELECT MAX(ZZ.HSTRYID) FROM TB_ASS_DSGN_HSTRY ZZ WHERE   Z.PRGRMID = ZZ.PRGRMID )
        LEFT OUTER JOIN TB_CMM_ADDR_CTPRVN CTPRVN ON SUBSTR(A.INST_RGN_CD,1,2) = CTPRVN.CTPRVN_CD
        WHERE 1=1
        AND   A.PRGRMID = #{prgrmid}
    </select>

    <!-- 이행확인심사 목록 조회 -->
    <select id="selectImplmntIdntySrngList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        <include refid="PaginationMapper.header"/>
         SELECT
            Z.PRGRMID
          , A.SRNGID       /* 심사아이디 */
          , A.CYCLID       /* 차수아이디 */
          , A.PICID        /* 담당자아이디 */
          , (SELECT CONCAT(NM,"(",ACNT,")") FROM TB_CMM_USER WHERE USERID = A.PICID) AS PIC_NM
          , D.CYCL         /* 차수 */
          , A.VST_DE       /* 방문_일자 */
          , A.VST_HR       /* 방문_시간 */
          , A.VST_MNT      /* 방문_분 */
          , IFNULL(DATE_FORMAT(B.REG_DT, '%Y-%m-%d'),'-') AS SPLMNT_IMPRV_DMNDLN
          , B.DMND_CMPTN_DE /*보완요청 완료일 */
          , IFNULL(DATE_FORMAT(C.REG_DT, '%Y-%m-%d'),'-') AS SPLMNT_IMPRV_WRTPLN
          , IFNULL(DATE_FORMAT(D.REG_DT, '%Y-%m-%d'),'-') AS RSLTLN
          , A.REG_DT       /* 등록_일시 */
          , A.RGTRID       /* 등록자아이디 */
          , B.DMNDID
        FROM
            TB_ASS_OPER_RSLT_CYCL Z
        LEFT OUTER JOIN
            TB_ASS_IMPLMNT_IDNTY_SRNG A ON Z.CYCLID = A.CYCLID
        LEFT OUTER JOIN    /* 보완 요청 */
            TB_ASS_SPLMNT_DMND B ON A.SRNGID = B.SRNGID
        LEFT OUTER JOIN
            TB_ASS_SPLMNT_PLAN C ON B.DMNDID = C.DMNDID
        LEFT OUTER JOIN
            TB_ASS_OPER_RSLT_CYCL D ON A.CYCLID = D.CYCLID
        WHERE Z.PRGRMID= #{prgrmid}
        AND NOW() BETWEEN Z.SBMSN_BGNG_DE AND Z.SBMSN_END_DE
        AND B.SRNGID IS NOT NULL
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 이행확인심사 상세 조회 -->
    <select id="selectImplmntIdntySrngDtl" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            A.SRNGID
          , B.DMNDID
          , A.CYCLID
          , A.PICID
          , A.VST_DE
          , A.VST_HR
          , A.VST_MNT
          , A.GNRLZ_OPNN
          , A.GRD_CD
          , A.FILEGRPID
          , A.WRTRID
          , A.MDFCN_DT
          , A.MDFRID
          , A.REG_DT
          , A.RGTRID
          , B.DMND_CN
          , C.CN
        FROM
            TB_ASS_IMPLMNT_IDNTY_SRNG A
        LEFT OUTER JOIN
            TB_ASS_SPLMNT_DMND B ON A.SRNGID = B.SRNGID
        LEFT OUTER JOIN
            TB_ASS_SPLMNT_PLAN C ON B.DMNDID =C.DMNDID
        WHERE 1=1
        AND A.SRNGID = #{srngid}
<!--         AND B.DMNDID = #{dmndid} -->
    </select>

    <!-- 보완 요청 조회 -->
    <select id="selectSplmntDmnd" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            DMNDID
          , SRNGID
          , DMND_CN
          , DMND_DCMNT
          , DMND_CMPTN_DE
          , MDFCN_DT
          , MDFR_ID
          , REG_DT
          , RGTR_ID
        FROM
            TB_ASS_SPLMNT_DMND
        WHERE
            DMNDID = #{dmndid}
    </select>

    <!-- 보완요청 수정-->
    <update id="updateSplmntImprv" parameterType="DsgnPrgrmVo" >
        UPDATE
            TB_ASS_SPLMNT_DMND
        SET
            DMND_CN       = #{dmndCn     }
          , DMND_DCMNT    = #{dmndDcmnt  }
          , DMND_CMPTN_DE = #{dmndCmptnDe}
          , MDFCN_DT      = NOW()
          , MDFR_ID       = #{user.userid}
        WHERE
            DMNDID = #{dmndid}
    </update>

    <!-- 보완 계획 조회 -->
    <select id="selectSplmntPlan" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            A.PLANID
          , B.SRNGID
          , A.DMNDID
          , A.SMRIZE_OPNN
          , A.CN
          , A.FILEGRPID
          , A.MDFCN_DT
          , A.MDFRID
          , A.REG_DT
          , A.RGTRID
          , B.DMND_CN
        FROM
            TB_ASS_SPLMNT_PLAN A
        INNER JOIN
            TB_ASS_SPLMNT_DMND B ON A.DMNDID =B.DMNDID
        WHERE 1=1
        AND A.DMNDID = #{dmndid}
    </select>

    <insert id="insertImplmntIdntySrng" parameterType="DsgnPrgrmVo" >
        INSERT INTO TB_ASS_IMPLMNT_IDNTY_SRNG
        (
            CYCLID
          , PICID
          , VST_DE
          , VST_HR
          , VST_MNT
          , GNRLZ_OPNN
          , GRD_CD
          , FILEGRPID
          , WRTRID
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        )VALUES
        (
            #{cyclid   }
          , #{picid    }
          , #{vstDe    }
          , #{vstHr    }
          , #{vstMnt   }
          , #{gnrlzOpnn}
          , #{grdCd    }
          , #{filegrpid}
          , #{user.userid}
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        )

    </insert>

    <!-- 이행확인심사 수정 -->
    <update id="updateImplmntIdntySrng" parameterType="DsgnPrgrmVo" >
        UPDATE TB_ASS_IMPLMNT_IDNTY_SRNG SET
            PICID        = #{picid     }
          , VST_DE       = #{vstDe     }
          , VST_HR       = #{vstHr     }
          , VST_MNT      = #{vstMnt    }
          , GNRLZ_OPNN   = #{gnrlzOpnn }
          , GRD_CD       = #{grdCd     }
          , FILEGRPID    = #{filegrpid }
          , WRTRID       = #{user.userid}
          , MDFCN_DT     = NOW()
          , MDFRID       = #{user.userid}
        WHERE SRNGID = #{srngid}
    </update>

    <update id="updateCyClSttsCd" parameterType="DsgnPrgrmVo" >
        UPDATE
            TB_ASS_OPER_RSLT_CYCL
        SET
            STTS_CD  = #{sttsCd}
          , MDFRID   = #{user.userid}
          , MDFCN_DT = NOW()
        WHERE CYCLID = #{cyclid}

    </update>

    <!-- 보완계획서 (이행확인심사) 등록 -->
    <insert id="insertSplmntPlan" parameterType="DsgnPrgrmVo" >
        INSERT INTO TB_ASS_SPLMNT_PLAN
        (
            DMNDID
          , SMRIZE_OPNN
          , CN
          , FILEGRPID
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES
        (
            #{dmndid    }
          , #{smrizeOpnn}
          , #{cn        }
          , #{filegrpid }
          , NOW()            /*수정일시*/
          , #{user.userid}   /*수정자아이디*/
          , NOW()            /*등록일시*/
          , #{user.userid}   /*등록자아이디*/
        )
    </insert>

    <!-- 보완계획서 (이행확인심사) 수정 -->
    <update id="updateScrtyImprvPlanln" parameterType="DsgnPrgrmVo" >
        UPDATE
            TB_ASS_SPLMNT_PLAN
        SET
            SMRIZE_OPNN = #{smrizeOpnn}
          , CN          = #{cn}
          , FILEGRPID   = #{filegrpid}
          , MDFRID      = #{user.userid}
          , MDFCN_DT    = NOW()
        WHERE PLANID    = #{planid}
    </update>

    <!-- 결과보고서 조회 -->
    <select id="selectRsltRptlnForm" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            CYCLID
        FROM
            TB_ASS_IMPLMNT_IDNTY_SRNG A
        WHERE
            A.CYCLID = #{cyclid}
    </select>

    <update id="updateSbmsnPrd" parameterType="DsgnPrgrmVo" >
        UPDATE
            TB_ASS_OPER_RSLT_CYCL
        SET
            SBMSN_BGNG_DE = #{sbmsnBgngDe}
          , SBMSN_END_DE  = #{sbmsnEndDe}
          , MDFRID        = #{user.userid}
          , MDFCN_DT      = NOW()
        WHERE CYCLID      = #{cyclid}
    </update>

    <!-- 운영결과상세 조회 -->
    <select id="selectOperRsltDetail" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            A.CYCLID
          , C.INSTID
          , ( SELECT INST_TYPE_CD  FROM TB_CMM_INST WHERE INSTID = C.INSTID ) AS INST_TYPE_CD   /* 기업 유형 코드*/
          , D.SRNGID
          , C.PRGRMID
          , C.INST_NM
          , C.INST_RGN_CD
          , C.PRGRM_NM
          , A.SNRSTFDVLPR_NM
          , A.SNRSTFDVLPR_EML
          , A.SNRSTFDVLPR_TELNO
          , A.SNRSTFDVLPR_MOBLPHON
          , A.PIC_NM
          , A.PIC_EML
          , A.PIC_TELNO
          , A.PIC_MOBLPHON
          , A.PRGRM_TYPE_CD
          , A.STY_YN
          , A.INSRNC_JOIN_YN
          , A.INSRNC_RSN
          , A.CHG_YN
          , A.INFNT
          , A.SCHBOY
          , A.MSKLSD
          , A.HGSCHST
          , A.ADULT
          , A.WHOL_AGE
          , A.EDU_NOPE
          , A.ACTVT_PLC
          , A.ETRFEE
          , A.EDU_CNT
          , A.EDU_HR
          , A.EDU_MNT
          , A.SFTYACDNT_ENNC
          , A.JAN
          , A.FEB
          , A.MAR
          , A.APR
          , A.MAY
          , A.JUNE
          , A.JULY
          , A.AUG
          , A.SEPT
          , A.OCT
          , A.NOV
          , A.DCM
          , A.WHOL_MM
          , A.ISSU_YN
          , A.ISSU_NOCS
          , A.ISSU_SUM
          , A.PRGRM_DSTNCTN
          , A.OPER_MNG
          , A.EVL
          , A.QLFC_POSTNG
          , A.SFTY_MNG
          , A.FILEGRPID
          , A.NEXT_YR_PRGRM
          , A.NEXT_YR_LDR
          , A.NEXT_YR_EDU_ENV
          , A.MDFCN_DT
          , A.MDFRID
          , A.REG_DT
          , A.RGTRID
          , B.STTS_CD
          , D.PICID
          , D.SRNGID
          , USR.NM
          , USR.ACNT
          , USR.MOBLPHON
          , USR.EML
        FROM
            TB_ASS_OPER_RSLT A
        INNER JOIN
            TB_ASS_OPER_RSLT_CYCL B ON A.CYCLID = B.CYCLID
        INNER JOIN
            TB_ASS_PRGRM C ON B.PRGRMID = C.PRGRMID
        LEFT OUTER JOIN TB_ASS_IMPLMNT_IDNTY_SRNG D  ON A.CYCLID = D.CYCLID
        LEFT OUTER JOIN TB_CMM_USER USR ON D.PICID = USR.USERID
        WHERE A.CYCLID = #{cyclid}
    </select>

    <!-- 운영결과 등록 -->
    <insert id="insertOperRslt" parameterType="DsgnPrgrmVo">
        /* DsgnPrgrmDao.insertOperRslt*/
        INSERT INTO TB_ASS_OPER_RSLT
        (
              CYCLID
            , SNRSTFDVLPR_NM
            , SNRSTFDVLPR_EML
            , SNRSTFDVLPR_TELNO
            , SNRSTFDVLPR_MOBLPHON
            , PIC_NM
            , PIC_EML
            , PIC_TELNO
            , PIC_MOBLPHON
            , PRGRM_TYPE_CD
            , STY_YN
            , STY_NIGHT
            , STY_DAYTM
            , INSRNC_JOIN_YN
            , INSRNC_RSN
            , CHG_YN
            , INFNT
            , SCHBOY
            , MSKLSD
            , HGSCHST
            , ADULT
            , WHOL_AGE
            , EDU_NOPE
            , ACTVT_PLC
            , ETRFEE
            , EDU_CNT
            , EDU_HR
            , EDU_MNT
            , SFTYACDNT_ENNC
            , JAN
            , FEB
            , MAR
            , APR
            , MAY
            , JUNE
            , JULY
            , AUG
            , SEPT
            , OCT
            , NOV
            , DCM
            , WHOL_MM
            , ISSU_YN
            , ISSU_NOCS
            , ISSU_SUM
            , PRGRM_DSTNCTN
            , OPER_MNG
            , EVL
            , QLFC_POSTNG
            , SFTY_MNG
            , FILEGRPID
            , NEXT_YR_PRGRM
            , NEXT_YR_LDR
            , NEXT_YR_EDU_ENV
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES
        (
              #{cyclid}                    /*차수아이디*/
            , #{snrstfdvlprNm}             /*책임개발자_이름*/
            , #{snrstfdvlprEml}            /*책임개발자_이메일*/
            , #{snrstfdvlprTelno}          /*책임개발자_전화번호*/
            , #{snrstfdvlprMoblphon}       /*책임개발자_휴대폰번호*/
            , #{picNm}                     /*담당자_이름*/
            , #{picEml}                    /*담당자_이메일*/
            , #{picTelno}                  /*담당자_전화번호*/
            , #{picMoblphon}               /*담당자_휴대폰번호*/
            , #{prgrmTypeCd}               /*프로그램_유형_코드*/
            , #{styYn}                     /*숙박_여부*/
            , #{styNight}
            , #{styDaytm}
            , #{insrncJoinYn}              /*보험_가입_여부*/
            , #{insrncRsn}                 /*보험_사유*/
            , #{chgYn}                     /*변경_여부*/
            , #{infnt}                     /*유아*/
            , #{schboy}                    /*초등학생*/
            , #{msklsd}                    /*중학생*/
            , #{hgschst}                   /*고등학생*/
            , #{adult}                     /*성인*/
            , #{wholAge}                   /*전체_연령*/
            , #{eduNope}                   /*교육_인원수*/
            , #{actvtPlc}                  /*활동_장소*/
            , #{etrfee}                    /*참가비*/
            , #{eduCnt}                    /*교육_횟수*/
            , #{eduHr}                     /*교육_시간*/
            , #{eduMnt}                    /*교육_분*/
            , #{sftyacdntEnnc}             /*안전사고_유무*/
            , #{jan}                       /*1월*/
            , #{feb}                       /*2월*/
            , #{mar}                       /*3월*/
            , #{apr}                       /*4월*/
            , #{may}                       /*5월*/
            , #{june}                      /*6월*/
            , #{july}                      /*7월*/
            , #{aug}                       /*8월*/
            , #{sept}                      /*9월*/
            , #{oct}                       /*10월*/
            , #{nov}                       /*11월*/
            , #{dcm}                       /*12월*/
            , #{wholMm}                    /*전체_월*/
            , #{issuYn}                    /*발급_여부*/
            , #{issuNocs}                  /*발급_건수*/
            , #{issuSum}                   /*발급_합계*/
            , #{prgrmDstnctn}              /*프로그램_우수성*/
            , #{operMng}                   /*운영_관리*/
            , #{evl}                       /*평가*/
            , #{qlfcPostng}                /*자격_배치*/
            , #{sftyMng}                   /*안전_관리*/
            , #{filegrpid}                 /*파일그룹아이디*/
            , #{nextYrPrgrm}               /*다음_연도_프로그램*/
            , #{nextYrLdr}                 /*다음_연도_지도자*/
            , #{nextYrEduEnv}              /*다음_연도_교육_환경*/
            , NOW()                        /*수정_일시*/
            , #{user.userid}               /*수정자아이디*/
            , NOW()                        /*등록_일시*/
            , #{user.userid}              /*등록자아이디*/
        )
    </insert>

    <!-- 운영결과 수정-->
    <update id="updateOperRslt" parameterType="DsgnPrgrmVo" >
    /* DsgnPrgrmDao.updateOperRslt*/
        UPDATE
            TB_ASS_OPER_RSLT
        SET
            CYCLID                   = #{cyclid}
          , SNRSTFDVLPR_NM           = #{snrstfdvlprNm}
          , SNRSTFDVLPR_EML          = #{snrstfdvlprEml}
          , SNRSTFDVLPR_TELNO        = #{snrstfdvlprTelno}
          , SNRSTFDVLPR_MOBLPHON     = #{snrstfdvlprMoblphon}
          , STY_NIGHT                = #{styNight}
          , STY_DAYTM                = #{styDaytm}
          , PIC_NM                   = #{picNm}
          , PIC_EML                  = #{picEml}
          , PIC_TELNO                = #{picTelno}
          , PIC_MOBLPHON             = #{picMoblphon}
          , PRGRM_TYPE_CD            = #{prgrmTypeCd}
          , STY_YN                   = #{styYn}
          , INSRNC_JOIN_YN           = #{insrncJoinYn}
          , INSRNC_RSN               = #{insrncRsn}
          , CHG_YN                   = #{chgYn}
          , INFNT                    = #{infnt}
          , SCHBOY                   = #{schboy}
          , MSKLSD                   = #{msklsd}
          , HGSCHST                  = #{hgschst}
          , ADULT                    = #{adult}
          , WHOL_AGE                 = #{wholAge}
          , EDU_NOPE                 = #{eduNope}
          , ACTVT_PLC                = #{actvtPlc}
          , ETRFEE                   = #{etrfee}
          , EDU_CNT                  = #{eduCnt}
          , EDU_HR                   = #{eduHr}
          , EDU_MNT                  = #{eduMnt}
          , SFTYACDNT_ENNC           = #{sftyacdntEnnc}
          , JAN                      = #{jan}
          , FEB                      = #{feb}
          , MAR                      = #{mar}
          , APR                      = #{apr}
          , MAY                      = #{may}
          , JUNE                     = #{june}
          , JULY                     = #{july}
          , AUG                      = #{aug}
          , SEPT                     = #{sept}
          , OCT                      = #{oct}
          , NOV                      = #{nov}
          , DCM                      = #{dcm}
          , WHOL_MM                  = #{wholMm}
          , ISSU_YN                  = #{issuYn}
          , ISSU_NOCS                = #{issuNocs}
          , ISSU_SUM                 = #{issuSum}
          , PRGRM_DSTNCTN            = #{prgrmDstnctn}
          , OPER_MNG                 = #{operMng}
          , EVL                      = #{evl}
          , QLFC_POSTNG              = #{qlfcPostng}
          , SFTY_MNG                 = #{sftyMng}
          , FILEGRPID                = #{filegrpid}
          , NEXT_YR_PRGRM            = #{nextYrPrgrm}
          , NEXT_YR_LDR              = #{nextYrLdr}
          , NEXT_YR_EDU_ENV          = #{nextYrEduEnv}
          , MDFCN_DT                 = NOW()
          , MDFRID                   = #{user.userid}
        WHERE
            CYCLID = #{cyclid}
    </update>

    <!-- 운영결과 삭제 -->

    <delete id="deleteOperRslt" parameterType="DsgnPrgrmVo">
        /* DsgnPrgrmDao.deleteOperRslt */

        DELETE FROM TB_ASS_OPER_RSLT
        WHERE CYCLID = #{cyclid}
    </delete>

    <!-- 운영결과 운영실적 목록조회 -->
    <select id="selectOperRsltPrfmncList" parameterType="DsgnPrgrmVo" resultType="OperPrfmncVo">
        SELECT
            B.PRFMNCID
          , A.CYCLID
          , B.OPRTN_DE
          , B.TRGT
          , B.HR
          , B.NOPE
          , B.CNT
          , B.WHOL_HR
          , B.WHOL_NOPE
          , B.LDR_POSTNG_RT
          , B.MDFCN_DT
          , B.MDFRID
          , B.REG_DT
          , B.RGTRID
        FROM
            TB_ASS_OPER_RSLT A
        LEFT OUTER JOIN
            TB_ASS_OPER_RSLT_PRFMNC B ON A.CYCLID = B.CYCLID
        WHERE A.CYCLID = #{cyclid}
        ORDER BY B.PRFMNCID
    </select>
    <!-- 운영결과 운영성과 조회 -->

    <!-- 운영실적 등록-->
    <insert id="insertOperPrfmnc" parameterType="OperPrfmncVo" >
        /* DsgnPrgrmDao.insertOperPrfmnc*/
        INSERT INTO TB_ASS_OPER_RSLT_PRFMNC
        (
              CYCLID
            , OPRTN_DE
            , TRGT
            , HR
            , NOPE
            , CNT
            , WHOL_HR
            , WHOL_NOPE
            , LDR_POSTNG_RT
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
            ) VALUES (
              #{cyclid     }
            , #{oprtnDe    }
            , #{trgt       }
            , #{hr         }
            , #{nope       }
            , #{cnt        }
            , #{wholHr     }
            , #{wholNope   }
            , #{ldrPostngRt}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>

    <delete id="deleteOperPrfmnc" parameterType="DsgnPrgrmVo" >
        /* DsgnPrgrmDao.insertOperPrfmnc*/
        DELETE FROM TB_ASS_OPER_RSLT_PRFMNC
        WHERE CYCLID = #{cyclid}
    </delete>

    <!-- 지원단 캘린더 목록 조회 -->
    <select id="selectSprtgrpClndrList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        SELECT
            A.PRGRMID
          , A.PRGRM_NM
          , A.INST_NM
          , B.VST_DE
          , B.VST_HR
          , B.VST_MNT
          , B.SPRTGRPID
          , CONCAT(C.NM, '(', C.ACNT, ')')    AS SPRTGRP_NM_ACNT
          , C.NM
          , CONCAT(B.VST_DE , ' ', B.VST_HR  ,' : ',  B.VST_MNT)    AS VST_DE
        FROM
            TB_ASS_PRGRM A
        LEFT OUTER JOIN
            TB_ASS_SPRTGRP_SRNG B ON A.PRGRMID = B.PRGRMID
        LEFT OUTER JOIN
            TB_CMM_USER C ON B.SPRTGRPID = C.USERID
        WHERE 1=1
        <if test="searchAplyStartDt != null and searchAplyStartDt != '' ">
            AND B.VST_DE <![CDATA[>=]]> #{searchAplyStartDt}
        </if>
        <if test="searchAplyEndDt != null and searchAplyEndDt != '' ">
            AND   B.VST_DE <![CDATA[<=]]> #{searchAplyEndDt}
        </if>
        ORDER BY VST_DE, VST_HR, VST_MNT
    </select>


    <!-- 담당자(지원단)배정 목록 조회-->
    <select id="selectPicList" parameterType="DsgnPrgrmVo" resultType="DsgnPrgrmVo">
        <include refid="PaginationMapper.header"/>
                SELECT
                    A.USERID
                  , B.ACNT
                  , B.NM
                  , B.EML
                  , B.MOBLPHON
                  , C.CRTFCT_NM
                  , D.RGN_CD
                  , D.RGN_NM
                  , E.SBJCT_CD
                  , E.SBJCT_NM
                FROM
                   TB_ASS_EXPRT A
                   INNER JOIN TB_CMM_USER B
                   ON A.USERID = B.USERID
                   LEFT OUTER JOIN (
                       SELECT
                           A.USERID
                           ,GROUP_CONCAT(CRTFCT_NM) AS CRTFCT_NM
                        FROM
                           TB_ASS_EXPRT_CRTFCT A
                       GROUP BY A.USERID
                   ) C
                   ON A.USERID = C.USERID
                   LEFT OUTER JOIN (
                       SELECT
                          A.USERID
                          ,GROUP_CONCAT(B.SIGNGU_NM) AS RGN_NM
                          ,GROUP_CONCAT(DISTINCT B.CTPRVN_CD)AS RGN_CD
                         FROM
                          TB_ASS_EXPRT_ACTVT_SCOPE A
                          INNER JOIN TB_CMM_ADDR_SIGNGU B
                          ON A.RGN_CD  = B.SIGNGU_CD
                          GROUP BY A.USERID
                   )D ON A.USERID = D.USERID
                   LEFT OUTER JOIN (
                        SELECT
                           A.USERID
                          ,GROUP_CONCAT(B.CD_NM) AS SBJCT_NM
                          ,GROUP_CONCAT(B.CD) AS SBJCT_CD
                         FROM
                          TB_ASS_EXPRT_SBJCT A
                          INNER JOIN TB_CMM_CD B
                          ON A.SBJCT_CD  =B.CD
                         GROUP BY A.USERID
                   )E ON A.USERID = E.USERID
                 WHERE 1=1
                <if test="searchNm != null and searchNm != '' ">
                   AND (ACNT LIKE CONCAT('%',#{searchNm},'%') OR NM LIKE CONCAT('%',#{searchNm},'%'))
                </if>
                <if test="searchCrtfctNm != null and searchCrtfctNm != '' ">
                   AND CRTFCT_NM LIKE CONCAT('%',#{searchCrtfctNm},'%')
                </if>
                <if test="searchSbjctCd != null and searchSbjctCd != '' ">
                   AND SBJCT_CD LIKE CONCAT('%',#{searchSbjctCd},'%')
                </if>
                <if test="searchRgnCd != null and searchRgnCd != '' ">
                   AND RGN_CD LIKE CONCAT('%',#{searchRgnCd},'%')
                </if>
        <include refid="PaginationMapper.footer"/>
    </select>

    <update id="updatePrgrm" parameterType="DsgnPrgrmVo">
        UPDATE
            TB_ASS_PRGRM
        SET
            INSTID            = #{instid        }
          , APLCNTID          = #{aplcntid      }
          , APLCNT_NM         = #{aplcntNm      }
          , APLCNT_EML        = #{aplcntEml     }
          , APLCNT_MOBLPHON   = #{aplcntMoblphon}
          , INST_NM           = #{instNm        }
          , INST_EML          = #{instEml       }
          , INST_CNTCT        = #{instCntct     }
          , INST_HMPG         = #{instHmpg      }
          , INST_TYPE_CD      = #{instTypeCd    }
          , INST_RGN_CD       = #{instRgnCd     }
          , INST_ZIP          = #{instZip       }
          , INST_ADDR         = #{instAddr      }
          , INST_DTLADDR      = #{instDtladdr   }
          , PRGRM_NM          = #{prgrmNm       }
          , FILEGRPID         = #{filegrpid     }
          , STTS_CD           = #{sttsCd        }
          , DSGN_CYCL         = #{dsgnCycl      }
          , DSGN_NO           = #{dsgnNo        }
          , DSGN_DE           = #{dsgnDe        }
          , DSGN_BGNG_DE      = #{dsgnBgngDe    }
          , DSGN_END_DE       = #{dsgnEndDe     }
          , AUTZRID           = #{autzrid       }
          , CHKLSTID          = #{chklstid      }
          , CNSLTNG_PRGRS_YN  = #{cnsltngPrgrsYn}
          , CNSLTNGID         = #{cnsltngid     }
          , APLY_DT           = #{aplyDt        }
          , MDFCN_DT          = NOW()
          , MDFRID            = #{user.userid}
        WHERE
            PRGRMID = #{prgrmid}
    </update>

</mapper>