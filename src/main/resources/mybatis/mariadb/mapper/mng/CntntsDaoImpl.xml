<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : CntntsDaoImpl.xml
	Description : 콘텐츠 관리
-->
<mapper namespace="com.kbrainc.plum.mng.cntnts.model.CntntsDao">
    
    <!-- 컨텐츠 관리 게시글 목록 조회 -->
    <select id="selectCntntsList" parameterType="CntntsVo" resultType="CntntsVo">
        /* CntntsDao.selectCntntsList */
        <include refid="PaginationMapper.header"/>
            SELECT
                A.CNTNTSID
              , A.TTL
              , TB1.EDU_SBJCT AS EDUSBJCT
              , TB2.EDU_TRGT EDUTRGT
              , CONCAT(D2.CD_NM, ' > ', D1.CD_NM) AS TYPECD
              , NVL(A.HITS, 0) AS HITS
              , A.DEL_YN AS DELYN
              , A.RPRS_IMG_FILEID
              , E.FILEGRPID
              , A.REG_DT AS REGDT
            FROM
                TB_CMM_CNTNTS A
            
                    LEFT OUTER JOIN (
                                    SELECT
                                        GROUP_CONCAT(ESUPPRCD.CD_NM, ' > ', ESCD.CD_NM) EDU_SBJCT
                                      , ES.CNTNTSID
                                      , ES.EDU_SBJCT_CD
                                    FROM
                                        TB_CMM_CNTNTS_EDU_SBJCT ES
                                            LEFT OUTER JOIN TB_CMM_CD ESCD ON ES.EDU_SBJCT_CD = ESCD.CD
                                            LEFT OUTER JOIN TB_CMM_CD ESUPPRCD ON ESCD.UPPR_CD = ESUPPRCD.CD
                                    GROUP BY CNTNTSID
                                    ) TB1 ON A.CNTNTSID = TB1.CNTNTSID
            
                    LEFT OUTER JOIN (
                                    SELECT
                                        GROUP_CONCAT(ETCD.CD_NM) EDU_TRGT
                                      , CNTNTSID
                                      , ET.EDU_TRGT_CD
                                    FROM
                                        TB_CMM_CNTNTS_EDU_TRGT ET
                                            LEFT OUTER JOIN TB_CMM_CD ETCD ON ET.EDU_TRGT_CD = ETCD.CD
                                    GROUP BY CNTNTSID                                            
                                    ) TB2 ON A.CNTNTSID = TB2.CNTNTSID
            
            
                    LEFT OUTER JOIN TB_CMM_CD D1 ON A.TYPE_CD = D1.CD
                    LEFT OUTER JOIN TB_CMM_CD D2 ON D1.UPPR_CD = D2.CD
            
                    LEFT OUTER JOIN TB_CMM_FILE E ON A.RPRS_IMG_FILEID = E.FILEID
            WHERE
                1 = 1
            <!-- 키워드 -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchTtl'">
            AND A.TTL LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchCn'">
            AND A.CN LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchTtlCn'">
            AND A.TTL LIKE CONCAT('%',#{searchKeyword},'%')
            AND A.CN LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            
            <!-- 교육주제 -->
            <if test="searchEduSbjctCd != null and searchEduSbjctCd != ''">
            AND TB1.EDU_SBJCT_CD = #{searchEduSbjctCd}
            </if>
            
            <!-- 교육대상 -->
            <if test="searchEduTrgtCd != null and searchEduTrgtCd != ''">
            AND TB2.EDU_TRGT_CD = #{searchEduTrgtCd}
            </if>
            
            <!-- 콘텐츠 유형 -->
            <if test="searchMainTypeCd != null and searchMainTypeCd != ''">
            AND D2.CD = #{searchMainTypeCd}
            </if>
            <if test="searchMdleTypeCd != null and searchMdleTypeCd != ''">
            AND D1.CD = #{searchMdleTypeCd}
            </if>
            
            <!-- 등록일(시작일, 종료일) -->
            <if test="searchBgngDt != null and searchBgngDt != ''">
            <![CDATA[
                AND DATE(A.REG_DT) >= #{searchBgngDt}
            ]]>
            </if>
            <if test="searchEndDt != null and searchEndDt != ''">
            <![CDATA[
                AND DATE(A.REG_DT) <= #{searchEndDt}
            ]]>
            </if>            
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 컨텐츠 관리 게시글 상세조회 -->
    <select id="selectCntntsInfo" parameterType="CntntsVo" resultType="CntntsVo"> 
        /* CntntsDao.selectCntntsInfo */
        SELECT
              A.CNTNTSID
            , A.TTL
            , A.TYPE_CD
            , D2.CD AS MAIN_TYPE_CD
            , A.ORIGIN
            , A.MNFCT_YY
            , A.PLY_SECND
            , A.TTL
            , A.CN
            , A.CPYRHT_CD
            , DATE(A.REG_DT) AS REG_DT
            , A.RGTRID
            , CONCAT(F.ACNT,'(',F.NM,')') AS rgtridNm
            , A.RPRS_IMG_FILEID
            , E.FILEGRPID
            , E.FILE_IDNTFC_KEY      
            , E.ORGINL_FILE_NM
            , A.ATCH_FILEGRPID
            , A.MDFCN_DT
            , A.DEL_YN
            , A.MVP_ID
        FROM
            TB_CMM_CNTNTS A
            LEFT OUTER JOIN TB_CMM_CD D1 ON A.TYPE_CD = D1.CD
            LEFT OUTER JOIN TB_CMM_CD D2 ON D1.UPPR_CD = D2.CD
            
            LEFT OUTER JOIN TB_CMM_FILE E ON A.RPRS_IMG_FILEID = E.FILEID
            
            LEFT OUTER JOIN TB_CMM_USER F ON A.RGTRID = F.USERID
        WHERE CNTNTSID = #{cntntsid}
    </select>
    
    <!-- 컨텐츠 관리 게시글 등록 --> 
    <insert id="insertCntnts" useGeneratedKeys="true">
        /* CntntsDao.insertCntnts */
        <selectKey resultType="int" keyProperty="cntntsid" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>        
        INSERT INTO TB_CMM_CNTNTS (
            TYPE_CD
            , ORIGIN
            , MNFCT_YY
            , PLY_SECND
            , TTL
            , CN
            , RPRS_IMG_FILEID
            , ATCH_FILEGRPID
            , CPYRHT_CD
            , DEL_YN
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        )VALUES(
            #{typeCd}
            ,#{origin}
            ,#{mnfctYy}
            ,#{plySecnd}
            ,#{ttl}
            ,#{cn}
            ,#{rprsImgFileid}
            ,#{atchFilegrpid}
            ,#{cpyrhtCd}
            ,'N'
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
        )
    </insert>

    <!-- 컨텐츠 관리 게시글 수정 --> 
    <update id="updateCntnts" parameterType="CntntsVo" >
         /* CntntsDao.updateCntnts */
          UPDATE TB_CMM_CNTNTS SET
              TYPE_CD          = #{typeCd}
              ,ORIGIN           = #{origin}
              ,MNFCT_YY         = #{mnfctYy}
              ,PLY_SECND        = #{plySecnd}
              ,TTL              = #{ttl}
              ,CN               = #{cn}
              ,RPRS_IMG_FILEID  = #{rprsImgFileid}
              ,ATCH_FILEGRPID   = #{atchFilegrpid}
              , CPYRHT_CD       = #{cpyrhtCd}
              ,MDFCN_DT         = NOW()
              ,MDFRID           = #{user.userid}
           WHERE CNTNTSID = #{cntntsid}
    </update>
    
    <!-- 컨텐츠 관리 게시글 삭제 -->
    <update id="deleteCntnts">
        /* CntntsDao.deleteCntnts */
        UPDATE TB_CMM_CNTNTS
        SET
            DEL_YN   = 'Y'
          , MDFCN_DT = NOW()
          , MDFRID   = #{user.userid}
        WHERE CNTNTSID IN 
        <foreach item="item" collection="cntntsids" open="(" close=")" separator=",">
        #{item}
        </foreach>
    </update>
    
    
    <!-- 교육주제 코드 리스트 조회 --> 
    <select id="selectCntntsCdList" parameterType="map" resultType="map">
          /* CntntsDao.selectCntntsCdList */
           SELECT 
               A.CD 
               ,CONCAT(B.CD_NM,'>',A.CD_NM ) CD_NM 
             FROM 
               TB_CMM_CD A
               INNER JOIN TB_CMM_CD B
               ON A.UPPR_CD = B.CD 
            WHERE 1=1
              AND A.USE_YN = 'Y'
              AND A.CDGRPID = #{cdgrpid}
    </select>
    
    <!-- 공모전 분야 매핑 등록 -->
    <insert id="insertEduSbjct">
        INSERT INTO TB_CMM_CNTNTS_EDU_SBJCT (CNTNTSID, EDU_SBJCT_CD, REG_DT, RGTRID) VALUES
        <foreach item="item" collection="eduSbjctCds"  separator=",">
            (
            #{cntntsid}
            , #{item}
            , NOW()
            , #{user.userid}
            )
        </foreach>
    </insert>
    
    <!-- 공모전 분야 매핑 등록 -->
    <insert id="insertEduTrgt">
        INSERT INTO TB_CMM_CNTNTS_EDU_TRGT (CNTNTSID, EDU_TRGT_CD, REG_DT, RGTRID) VALUES
        <foreach item="item" collection="eduTrgt"  separator=",">
            (
            #{cntntsid}
            , #{item}
            , NOW()
            , #{user.userid}
            )
        </foreach>
    </insert>
    
    <!-- 콘텐츠 교육 주제 코드 맵핑 리스트 호출 --> 
    <select id="selectCntntsEduSbjctList" parameterType="CntntsEduSbjctVo" resultType="CntntsEduSbjctVo">
          /* CntntsDao.selectCntntsEduSbjctList */
           SELECT
               CNTNTSID 
               ,EDU_SBJCT_CD
               ,REG_DT
               ,RGTRID
             FROM 
               TB_CMM_CNTNTS_EDU_SBJCT
            WHERE 1=1
              AND CNTNTSID = #{cntntsid}
    </select>
    
    <!-- 콘텐츠 교육 대상 코드 리스트 호출 --> 
    <select id="selectCntntsEduTrgtList" parameterType="CntntsEduTrgtVo" resultType="CntntsEduTrgtVo">
          /* CntntsDao.selectCntntsEduTrgtList */
           SELECT
               CNTNTSID
               ,EDU_TRGT_CD
               ,REG_DT
               ,RGTRID
             FROM 
               TB_CMM_CNTNTS_EDU_TRGT
            WHERE 1=1
              AND CNTNTSID = #{cntntsid}
    </select>
    
    <!-- 콘텐츠 교육 주제 코드 삭제 -->
    <delete id="deleteEduSbjct" parameterType="CntntsVo">
        /* CntntsDao.deleteEduSbjct */
        DELETE FROM TB_CMM_CNTNTS_EDU_SBJCT
        WHERE CNTNTSID = #{cntntsid}
    </delete>
    
    <!-- 콘텐츠 교육 대상 코드 삭제 -->
    <delete id="deleteEduTrgt" parameterType="CntntsVo">
        /* CntntsDao.deleteEduTrgt */
        DELETE FROM TB_CMM_CNTNTS_EDU_TRGT
        WHERE CNTNTSID = #{cntntsid}
    </delete>
</mapper>