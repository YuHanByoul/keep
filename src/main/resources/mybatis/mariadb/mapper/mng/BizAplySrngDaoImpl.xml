<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : ScoreCardDaoImpl.xml
    Description : 심사표관리
-->
<mapper namespace="com.kbrainc.plum.mng.bizAply.srng.model.BizAplySrngDao">
    
    <!-- 컨설팅 담당자 목록 조회 -->
    <select id="selectCnsltngExprtList" resultType="BizAplySrngVo">
        /* BizAplySrngDaoImpl.selectCnsltngExprtList */
        SELECT 
          A.USERID
          , B.NM 
        FROM 
           TB_ASS_EXPRT A 
           INNER JOIN TB_CMM_USER B
           ON A.USERID = B.USERID 
           LEFT OUTER JOIN (
               SELECT 
                   A.USERID
                   ,GROUP_CONCAT(CRTFCT_NM) AS CRTFCT_NM 
                FROM 
                   TB_ASS_EXPRT_CRTFCT A
               GROUP BY A.USERID
           ) C
           ON A.USERID = C.USERID
           LEFT OUTER JOIN (
               SELECT 
                  A.USERID
                  ,GROUP_CONCAT(B.SIGNGU_NM) AS RGN_NM
                  -- ,GROUP_CONCAT(A.RGN_CD) AS RGN_CD
                  ,GROUP_CONCAT(DISTINCT B.CTPRVN_CD)AS RGN_CD
                 FROM 
                  TB_ASS_EXPRT_ACTVT_SCOPE A
                  INNER JOIN TB_CMM_ADDR_SIGNGU B
                  ON A.RGN_CD  = B.SIGNGU_CD
                  GROUP BY A.USERID
           )D ON A.USERID = D.USERID 
           LEFT OUTER JOIN (
                SELECT
                   A.USERID
                  ,GROUP_CONCAT(B.CD_NM) AS SBJCT_NM
                  ,GROUP_CONCAT(B.CD) AS SBJCT_CD 
                 FROM 
                  TB_ASS_EXPRT_SBJCT A
                  INNER JOIN TB_CMM_CD B
                  ON A.SBJCT_CD  =B.CD 
                 GROUP BY A.USERID
           )E ON A.USERID = E.USERID 
         WHERE 1=1
         ORDER BY B.NM
    </select>
    
    <!-- 심사결과 조회 -->
    <select id="detailBizAplySrng" parameterType="BizAplySrngVo" resultType="BizAplySrngVo">
        /** BizAplySrngDaoImpl.detailBizAplySrng **/
        SELECT
            SBMSNID
            , APLYID
            , FORMID
            , USERID
            , VST_DT
            , SRNG_OPNN
            , OPNN1
            , OPNN2
            , OPNN3
            , OPNN4
            , TOT_SCR
            , SCR
            , SBMSN_DT
            , SBMSN_STTS_CD
            , B.CD_NM AS SBMSN_STTS_NM
            , USER_IP
            , A.MDFCN_DT
            , A.MDFRID
            , A.REG_DT
            , A.RGTRID
        FROM
            TB_SPB_SRNG_SBMSN A
            LEFT OUTER JOIN TB_CMM_CD B ON A.SBMSN_STTS_CD = B.CD
        WHERE APLYID = #{aplyid}
        AND FORMID = #{formid}
        AND USERID = #{user.userid}
    </select>
    
    <!-- 심사결과 등록 -->
    <insert id="insertBizAplySrng" parameterType="BizAplySrngVo" useGeneratedKeys="true" keyProperty="sbmsnid">
        /** BizAplySrngDaoImpl.insertBizAplySrng **/
        INSERT INTO TB_SPB_SRNG_SBMSN (
            SBMSNID
            , APLYID
            , FORMID
            , USERID
            , VST_DT
            , SRNG_OPNN
            , OPNN1
            , OPNN2
            , OPNN3
            , OPNN4
            , TOT_SCR
            , SCR
            , SBMSN_DT
            , SBMSN_STTS_CD
            , USER_IP
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{sbmsnid}
            , #{aplyid}
            , #{formid}
            , #{user.userid}
            , #{vstDt}
            , #{srngOpnn}
            , #{opnn1}
            , #{opnn2}
            , #{opnn3}
            , #{opnn4}
            , #{totScr}
            , #{totalSum}
            , NOW()
            , #{sbmsnSttsCd}
            , #{userIp}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 심사결과 수정 -->
    <update id="updateBizAplySrng" parameterType="BizAplySrngVo">
        /** BizAplySrngDaoImpl.updateBizAplySrng **/
        UPDATE
            TB_SPB_SRNG_SBMSN
        SET
            APLYID = #{aplyid}
            , FORMID = #{formid}
            , USERID = #{user.userid}
            , VST_DT = #{vstDt}
            , SRNG_OPNN = #{srngOpnn}
            , OPNN1 = #{opnn1}
            , OPNN2 = #{opnn2}
            , OPNN3 = #{opnn3}
            , OPNN4 = #{opnn4}
            , TOT_SCR = #{totScr}
            , SCR = #{totalSum}
            , SBMSN_DT = NOW()
            , SBMSN_STTS_CD = #{sbmsnSttsCd}
            , USER_IP = NULL
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE
            SBMSNID = #{sbmsnid}
    </update>
    
    <!-- 문항별 심사 결과 등록 -->
    <insert id="insertItem" parameterType="com.kbrainc.plum.mng.score.model.QuestionVo">
        /** BizAplySrngDaoImpl.insertItem **/
        INSERT INTO TB_SPB_SRNG_SBMSN_QITEM (
            SBMSNID
            , QITEMID
            , QITEM_SE_CD
            , QITEM
            , ORDR
            , ALTM
            , SCR
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{sbmsnid}
            , #{qitemid}
            , (SELECT QITEM_SE_CD FROM TB_SPB_SRNG_FORM_QITEM WHERE QITEMID = #{qitemid})
            , (SELECT QITEM FROM TB_SPB_SRNG_FORM_QITEM WHERE QITEMID = #{qitemid})
            , (SELECT ORDR FROM TB_SPB_SRNG_FORM_QITEM WHERE QITEMID = #{qitemid})
            , (SELECT ALTM FROM TB_SPB_SRNG_FORM_QITEM WHERE QITEMID = #{qitemid})
            , #{scr}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 문항별 심사 결과 수정 -->
    <update id="updateItem" parameterType="com.kbrainc.plum.mng.score.model.QuestionVo">
        /** BizAplySrngDaoImpl.updateItem **/
        UPDATE
            KEEP_DEV01.TB_SPB_SRNG_SBMSN_QITEM
        SET
            SCR = #{scr}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE
            SBMSNID = #{sbmsnid}
            AND QITEMID = #{qitemid}
    </update>
    
</mapper>