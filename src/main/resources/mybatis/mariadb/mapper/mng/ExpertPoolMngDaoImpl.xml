<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : ExpertPoolMngDaoImpl.xml
	Description : 전문가 풀 관리
-->
<mapper namespace="com.kbrainc.plum.mng.expertPoolMng.model.ExpertPoolMngDao">
      <!--전문가 목록 조회-->
    <select id="selectExpertList" resultType="ExpertVo">
        <include refid="PaginationMapper.header"/>
        SELECT
            A.USERID
            , A.EXPRT_TYPE_CD
            , A.FLD_LCTR_YN
            , A.FLD_PLANNG_YN
            , A.FLD_CNSLTNG_YN
            , A.FLD_ETC_YN
            , A.FLD_ETC_CN
            , A.MOBLPHON_RLS_YN
            , A.EML_RLS_YN
            , A.QLFC_RLS_YN
            , A.HDOF_RLS_YN
            , A.CAREER_RLS_YN
            , A.ENT_LCTR_DMND_RCPTN_YN
            , A.LCTR_GDNC_RCPTN_YN
            , A.ENV_EDU_CAREER_YY
            , A.ENV_EDU_CAREER_MM
            , A.STTS_CD
            , A.APLY_DT
            , A.MDFCN_DT
            , A.MDFRID
            , A.REG_DT
            , A.RGTRID
            , A.APRV_DT
            , A.RJCT_DT
            , A.CNCL_DT
            , B.STTS_CD AS USER_STTS_CD
            , B.ACNT
            , B.NM
            , GROUP_CONCAT(D.CD_NM) AS EXPRT_SBJCT
            , GROUP_CONCAT(C.CD_NM) AS EXPRT_ACTVT_SCOPE
            , GROUP_CONCAT(E.CD_NM) AS EXPRT_TRGT
        FROM TB_ASS_EXPRT A
        INNER JOIN TB_CMM_USER B
        ON A.USERID = B.USERID

        LEFT OUTER JOIN (
            SELECT A.USERID, B.CD_NM, B.CD
            FROM TB_ASS_EXPRT_ACTVT_SCOPE A
            INNER JOIN TB_CMM_CD B ON A.RGN_CD = B.CD
        ) C
        ON A.USERID = C.USERID

        LEFT OUTER JOIN (
            SELECT A.USERID, B.CD_NM, B.CD
            FROM TB_ASS_EXPRT_SBJCT A
            INNER JOIN TB_CMM_CD B ON A.SBJCT_CD = B.CD
        ) D
        ON A.USERID= D.USERID

        LEFT OUTER JOIN (
            SELECT A.USERID, B.CD_NM, B.CD
            FROM TB_ASS_EXPRT_TRGT A
            INNER JOIN TB_CMM_CD B ON A.TRGT_CD = B.CD
        ) E
        ON A.USERID= E.USERID

        WHERE 1=1
        GROUP BY A.USERID
        <include refid="PaginationMapper.footer"/>
    </select>
    <select id="selectExpertInfo" resultType="ExpertVo">
        SELECT
            A.USERID
            , A.ACNT
            , A.NM
            , A.GNDR
            , A.BRDT
            , A.MOBLPHON
            , A.TELNO
            , A.EML
            , A.STTS_CD
        FROM TB_CMM_USER A
        WHERE
            A.USERID = #{userid}
    </select>

    <resultMap id="expertApplyInfo" type="ExpertVo">
        <id property="userid" column="userid"/>
        <result property="sttsCd" column="stts_cd"/>
        <result property="aplyDt" column="aply_dt"/>
        <result property="aprvDt" column="aprv_dt"/>
        <result property="rjctDt" column="rjct_dt"/>
        <result property="cnclDt" column="cncl_dt"/>
        <result property="envEduCareerMm" column="ENV_EDU_CAREER_MM"/>
        <result property="envEduCareerYy" column="ENV_EDU_CAREER_YY"/>
        <result property="exprtTypeCd" column="EXPRT_TYPE_CD"/>
        <result property="fldLctrYn" column="FLD_LCTR_YN"/>
        <result property="fldPlanngYn" column="FLD_PLANNG_YN"/>
        <result property="fldCnsltngYn" column="FLD_CNSLTNG_YN"/>
        <result property="fldEtcYn" column="FLD_ETC_YN"/>
        <result property="emlRlsYn" column="EML_RLS_YN"/>
        <result property="moblphonRlsYn" column="MOBLPHON_RLS_YN"/>
        <result property="qlfcRlsYn" column="QLFC_RLS_YN"/>
        <result property="hdofRlsYn" column="HDOF_RLS_YN"/>
        <result property="careerRlsYn" column="CAREER_RLS_YN"/>
        <result property="entLctrDmndRcptnYn" column="ENT_LCTR_DMND_RCPTN_YN"/>
        <result property="lctrGdncRcptnYn" column="LCTR_GDNC_RCPTN_YN"/>
        <result property="exprtTrgt" column="EXPRT_TRGT"/>
        <result property="exprtTypeCd" column="EXPRT_TYPE_CD"/>
        <result property="exprtSbjct" column="EXPRT_SBJCT"/>
        <result property="exprtActvtRgn" column="EXPRT_ACTVT_RGN"/>
        <result property="exprtActvtScope" column="EXPRT_ACTVT_SCOPE"/>

        <collection property="expertCareerList" resultMap="expertCareerResultMap"/>
        <collection property="expertCrtfctList" resultMap="expertCrtfctResultMap"/>
        <collection property="expertHdofList" resultMap="expertHdofResultMap"/>
    </resultMap>

    <resultMap id="expertCrtfctResultMap" type="ExpertCrtfctVo">
        <result property="crtfctNm" column="crtfct_nm"/>
        <result property="acqsInst" column="acqs_inst"/>
        <result property="acqsNo" column="acqs_no"/>
        <result property="acqsGrd" column="acqs_grd"/>
        <result property="acqsDe" column="acqs_de"/>
    </resultMap>

    <resultMap id="expertHdofResultMap" type="ExpertHdofVo">
        <result property="hdofSeCd" column="hdof_se_cd"/>
        <result property="instNm" column="inst_nm"/>
        <result property="deptNm" column="dept_nm"/>
        <result property="jbgdNm" column="jbgd_nm"/>
        <result property="hdofBgngDe" column="hdof_bgng_de"/>
        <result property="hdofEndDe" column="hdof_end_de"/>
        <result property="hdofYn" column="hdof_yn"/>
    </resultMap>

    <resultMap id="expertCareerResultMap" type="ExpertCareerVo">
        <result property="fldNm" column="fld_nm"/>
        <result property="actvtBgngDe" column="actvt_bgng_de"/>
        <result property="actvtEndDe" column="actvt_end_de"/>
        <result property="actvtYn" column="actvt_yn"/>
        <result property="actvtHr" column="actvt_hr"/>
        <result property="idntyInstNm" column="idnty_inst_nm"/>
        <result property="actvtCn" column="actvt_cn"/>
        <result property="idntyDe" column="idnty_de"/>
    </resultMap>

    <select id="selectExpertApplyInfo" resultMap="expertApplyInfo">
        SELECT
            A.USERID
            , A.STTS_CD
            , A.APLY_DT
            , A.APRV_DT
            , A.RJCT_DT
            , A.CNCL_DT
            , A.ENV_EDU_CAREER_MM
            , A.ENV_EDU_CAREER_YY
            , A.EXPRT_TYPE_CD
            , A.FLD_LCTR_YN
            , A.FLD_PLANNG_YN
            , A.FLD_CNSLTNG_YN
            , A.FLD_ETC_YN
            , A.MOBLPHON_RLS_YN
            , A.EML_RLS_YN
            , A.QLFC_RLS_YN
            , A.HDOF_RLS_YN
            , A.CAREER_RLS_YN
            , A.ENT_LCTR_DMND_RCPTN_YN
            , A.LCTR_GDNC_RCPTN_YN
            , B.FLD_NM
            , B.ACTVT_BGNG_DE
            , B.ACTVT_END_DE
            , B.ACTVT_YN
            , B.ACTVT_HR
            , B.IDNTY_INST_NM
            , B.ACTVT_CN
            , B.IDNTY_DE
            , C.CRTFCT_NM
            , C.ACQS_INST
            , C.ACQS_NO
            , C.ACQS_GRD
            , C.ACQS_DE
            , D.HDOF_SE_CD
            , D.INST_NM
            , D.DEPT_NM
            , D.JBGD_NM
            , D.HDOF_BGNG_DE
            , D.HDOF_END_DE
            , D.HDOF_YN
            , (SELECT GROUP_CONCAT(TRGT_CD SEPARATOR', ') FROM TB_ASS_EXPRT_TRGT  WHERE USERID = #{userid} ) AS EXPRT_TRGT /* 전문분야 대상 */
            , (SELECT GROUP_CONCAT(SBJCT_CD SEPARATOR', ') FROM TB_ASS_EXPRT_SBJCT  WHERE USERID = #{userid} ) AS EXPRT_SBJCT /* 전문분야 주제 */
            , (SELECT GROUP_CONCAT(RGN_CD SEPARATOR', ') FROM TB_ASS_EXPRT_ACTVT_RGN  WHERE USERID = #{userid} ) AS EXPRT_ACTVT_RGN /* 주요활동지역 */
            , (SELECT GROUP_CONCAT(RGN_CD SEPARATOR', ') FROM TB_ASS_EXPRT_ACTVT_SCOPE  WHERE USERID = #{userid} ) AS EXPRT_ACTVT_SCOPE /* 가능 활동범위 */
        FROM TB_ASS_EXPRT A
        LEFT OUTER JOIN TB_ASS_EXPRT_CAREER B ON A.USERID = B.USERID
        LEFT OUTER JOIN TB_ASS_EXPRT_CRTFCT C ON A.USERID = C.USERID
        LEFT OUTER JOIN TB_ASS_EXPRT_HDOF D ON A.USERID = D.USERID
        WHERE A.USERID = #{userid}
    </select>

    <!-- 전문가 상태 변경 -->
    <update id="updateExpertStatus" parameterType="ExpertVo">
        UPDATE TB_ASS_EXPRT
        SET
            STTS_CD = #{sttsCd}
        WHERE
            USERID = #{userid}
    </update>

    <!-- 전문가 로그 생성 -->
    <insert id="insertExpertLog" parameterType="ExpertLogVo">
        INSERT INTO TB_ASS_EXPRT_LOG (
             USERID
             , PRCS_SE_CD
             , RSN_CN
             , REG_DT
             , RGTRID
             ) VALUES (
             #{userid}
             , #{prcsSeCd}
             , #{rsnCn}
             , NOW()
             , #{user.userid}
             )
    </insert>

    <!-- 전문가 로그 조회-->
    <select id="selectExpertLogList" resultType="ExpertLogVo">
        <include refid="PaginationMapper.header"/>
        SELECT
            LOGID
            , USERID
            , PRCS_SE_CD
            , RSN_CN
            , REG_DT
            , RGTRID
        FROM TB_ASS_EXPRT_LOG
        WHERE
            USERID= #{userid}
        <include refid="PaginationMapper.footer"/>
    </select>





</mapper>