<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : BbsDaoImpl.xml
    Description : 게시판 관리
-->
<mapper namespace="com.kbrainc.plum.mng.bbs.model.BbsDao">

    <!-- 게시판을 추가한다. -->
    <insert id="insertBbs"  parameterType="BbsVo">
        /* BbsDao.insertBbs */
        INSERT INTO tb_cmm_bbs (
            NM,
            DC,
            CL_CD,
            FXD_NTC_USE_YN,
            FXD_NTC_CNT,
            ATCHFILE_USE_YN,
            ATCHFILE_CNT,
            ATCHFILE_SIZE,
            RPLY_USE_YN,
            CMNT_USE_YN,
            NEW_USE_YN,
            NEW_INDICT_DAYCNT,
            HOT_USE_YN,
            HOT_USE_STDR_HITS,
            CL_USE_YN,
            PAGE_PST_CNT,
            NLOGIN_DWNLD_PERM_YN,
            USE_YN,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID 
        ) VALUES (
            #{nm               },
            #{dc               },
            #{clCd            },
            #{fxdNtcUseYn   },
            #{fxdNtcCnt      },
            #{atchfileUseYn  },
            #{atchfileCnt     },
            #{atchfileSize    },
            #{rplyUseYn      },
            #{cmntUseYn      },
            #{newUseYn       },
            #{newIndictDaycnt},
            #{hotUseYn       },
            #{hotUseStdrHits},
            #{clUseYn        },
            #{pagePstCnt     },
            #{nloginDwnldPermYn   },
            #{useYn           },
            NOW(),
            #{user.userid      },
            NOW(),
            #{user.userid      }
        )
    </insert>
    
    <!-- 게시판 분류를 추가한다. -->
    <insert id="insertBbsCl"  parameterType="BbsClVo">
        /* BbsDao.insertBbsCl */
        <selectKey keyProperty="ord" resultType="Int" order="BEFORE"> 
        SELECT 
            IFNULL (Max(ORD),0) +1
        FROM 
            TB_CMM_BBS_CL
        WHERE 
            1=1
            AND bbsid=#{bbsid}
        </selectKey>
        INSERT INTO TB_CMM_BBS_CL (
            CL_NM,
            BBSID,
            ORD,
            USE_YN,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        )VALUES(
            #{clNm    },
            #{bbsid    },
            #{ord      },
            #{useYn   },
            NOW(),
            #{user.userid},
            NOW(),
            #{user.userid}
        )
    </insert>
    
    <!-- 게시판 목록을 가져온다. -->
    <select id="getBbsList" parameterType="BbsVo" resultType="BbsVo">
        /* BbsDao.getBbsList */
        <include refid="PaginationMapper.header"/>
        SELECT 
            A.BBSID,
            A.CL_CD,
            A.NM,
            IFNULL(PST_CNT,0) PST_CNT,
            A.USE_YN,
            A.CL_USE_YN,
            A.MDFCN_DT
        FROM 
            TB_CMM_BBS A
            LEFT OUTER JOIN (SELECT BBSID, COUNT(PSTID) PST_CNT FROM TB_CMM_PST GROUP BY BBSID) B ON A.BBSID = B.BBSID
            WHERE 
                1=1
                <if test="searchCl != null and searchCl != '' ">
                AND CL_CD = #{searchCl}
                </if>
                <if test="searchType != null and searchType != '' and searchKeyword.trim()!= ''">
                AND NM LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
        <include refid="PaginationMapper.footer"/>
    </select> 

    <!-- 게시판 정보를 가져온다. -->
    <select id="selectOneBbs" parameterType="BbsVo" resultType="BbsVo">
        /* BbsDao.selectOneBbs */
        SELECT
            BBSID,
            NM,
            DC,
            CL_CD,
            FXD_NTC_USE_YN,
            FXD_NTC_CNT,
            ATCHFILE_USE_YN,
            ATCHFILE_CNT,
            ATCHFILE_SIZE,
            RPLY_USE_YN,
            CMNT_USE_YN,
            NEW_USE_YN,
            NEW_INDICT_DAYCNT,
            HOT_USE_YN,
            HOT_USE_STDR_HITS,
            CL_USE_YN,
            PAGE_PST_CNT,
            NLOGIN_DWNLD_PERM_YN,
            USE_YN,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID,
            (SELECT  SUM( CASE WHEN fxd_ntc_yn = 'Y' THEN 1 ELSE 0 END ) FROM TB_CMM_PST  WHERE BBSID = #{bbsid}) cur_fxd_ntc_cnt
        FROM
            TB_CMM_BBS
        WHERE 
            1=1
            AND BBSID = #{bbsid}  
    </select>
 
    <!-- 게시판을 수정한다. -->
    <update id="updateBbs"  parameterType="BbsVo">
        /* BbsDao.updateBbs */
        UPDATE tb_cmm_bbs SET 
            NM                    =  #{nm               },
            DC                    =  #{dc               },
            CL_CD                 =  #{clCd            },
            FXD_NTC_USE_YN        =  #{fxdNtcUseYn   },
            FXD_NTC_CNT           =  #{fxdNtcCnt      },
            ATCHFILE_USE_YN       =  #{atchfileUseYn  },
            ATCHFILE_CNT          =  #{atchfileCnt     },
            ATCHFILE_SIZE         =  #{atchfileSize    },
            RPLY_USE_YN           =  #{rplyUseYn      },
            CMNT_USE_YN           =  #{cmntUseYn      },
            NEW_USE_YN            =  #{newUseYn       },
            NEW_INDICT_DAYCNT     =  #{newIndictDaycnt},
            HOT_USE_YN            =  #{hotUseYn       },
            HOT_USE_STDR_HITS     =  #{hotUseStdrHits},
            CL_USE_YN             =  #{clUseYn        },
            PAGE_PST_CNT          =  #{pagePstCnt     },
            NLOGIN_DWNLD_PERM_YN  =  #{nloginDwnldPermYn   },
            USE_YN                =  #{useYn           },
            MDFCN_DT               =  NOW(),
            MDFRID            =  #{user.userid      }
        WHERE 
            BBSID=#{bbsid}    
    </update>
  
    <!-- 게시판 분류를 수정한다. -->
    <update id="updateBbsCl"  parameterType="BbsClVo">
        /* BbsDao.updateBbsCl */
        UPDATE TB_CMM_BBS_CL SET
            CL_NM       = #{clNm    }, 
            BBSID       = #{bbsid    },
            ORD         = #{ord      },
            USE_YN      = #{useYn   },
            MDFCN_DT     = NOW(),
            MDFRID  = #{user.userid  }
        WHERE 
            BBS_CLID     = #{bbsClid}   
    </update>
    <!-- 게시판 분류를 정보를 가져온다. -->
    <select id="selectBbsCl"  parameterType="BbsClVo" resultType="BbsClVo">
        /* BbsDao.selectBbsCl */
        <include refid="PaginationMapper.header"/>
        SELECT 
            CL_NM,
            bbs_clid,
            BBSID,
            USE_YN,
            ORD,
            MDFCN_DT mdfcn_dt
          FROM 
            TB_CMM_BBS_CL  
         WHERE 1=1 
           AND BBSID = #{bbsid}
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 게시판 분류 목록을 가져온다. -->
    <select id="selectBbsClList"  parameterType="BbsClVo" resultType="BbsClVo">
        /* BbsDao.selectBbsClList */
        SELECT 
            CL_NM,
            bbs_clid,
            BBSID,
            USE_YN,
            ORD,
            MDFCN_DT mdfcn_dt
        FROM 
            TB_CMM_BBS_CL  
        WHERE 
            1=1 
            AND BBSID = #{bbsid}
            <if test="useYn != null and useYn != '' ">
            AND USE_YN = #{useYn}
            </if>
    </select>
    
    <!-- 사용중인 게시판 분류 목록을 가져온다. -->
    <select id="selectBbsbyClUseYn" parameterType="BbsVo" resultType ="BbsVo" >
        /* BbsDao.selectBbsbyClUseYn */
        SELECT 
            A.BBSID,
            cl_cd,
            NM,
            USE_YN,
            CL_USE_YN,
            PAGE_PST_CNT,
            MDFCN_DT
        FROM 
            TB_CMM_BBS A
        WHERE 
            1=1
            <if test= "searchKeyword != 'All' ">
            AND  A.CL_USE_YN ='Y'
            </if>
    </select>
    <!-- 게시판 순서를 바꾼다.(UP) -->
    <update id="modifybbsClOrdUp" parameterType="BbsClVo" >
        /* BbsDao.modifybbsClOrdUp */
        UPDATE TB_CMM_BBS_CL SET 
            ORD = ORD - 1
        WHERE 
            BBSID = #{bbsid} 
            AND ORD = #{ord}
    </update>
    
    <!-- 게시판 순서를 바꾼다. -->
    <update id="modifybbsClOrdByClid" parameterType="BbsClVo" >
        /* BbsDao.modifybbsClOrdByClid */
        UPDATE TB_CMM_BBS_CL SET 
            ORD =  #{ord}
        WHERE 
            BBSID = #{bbsid}
            AND BBS_CLID = #{bbsClid}
    </update>
    
    <!-- 게시판 순서를 바꾼다.(DOWN) -->
    <update id="modifybbsClOrdDown" parameterType="BbsClVo" >
        /* BbsDao.modifybbsClOrdDown */
         UPDATE TB_CMM_BBS_CL SET 
            ORD = ORD + 1
        WHERE 
            BBSID = #{bbsid} 
            AND ORD   = #{ord}
    </update>
    
    <!--*************** 게시물 관리***************-->
    <!-- 게시물을 추가한다. -->
    <insert id="insertPst" parameterType="PstVo">
        /* BbsDao.insertPst */
        INSERT INTO TB_CMM_PST (
            BBSID,
            SITEID,
            TITLE,
            CNTNTS,
            PRNTS_PSTID,
            GRP,
            DPTH,
            ORD,
            HITS,
            BBS_CLID,
            FXD_NTC_YN,
            FXD_NTC_STRT_DT,
            FXD_NTC_END_DT,
            LOGIN_YN,
            DEL_YN,
            FILEGRPID,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        )VALUES(
            #{bbsid         },
            #{siteid         },
            #{title         },
            #{cntnts        },
            #{prntsPstid   },
            IFNULL(#{grp }, (SELECT  IFNULL(MAX(A.GRP),0) +1 FROM TB_CMM_PST A)),
            IFNULL(#{dpth}, 0),
            IFNULL(#{ord  }, 1),
            #{hits          },
            #{bbsClid      },
            <choose>
                <when test='fxdNtcYn == "Y" '>
                #{fxdNtcYn    },
                #{fxdNtcStrtDt},
                #{fxdNtcEndDt },
                </when>
                <otherwise>
                null,
                null,
                null,
                </otherwise>
            </choose>
            #{loginYn      },
            'N',
            #{filegrpid     },
            NOW(),
            #{user.userid },
            NOW(),
            #{user.userid }
        )
    </insert>
    
    <!-- 게시물 목록을 가져온다. -->
    <select id="selectPstList"  parameterType="PstVo" resultType ="PstVo" >
        /* BbsDao.selectPstList */
        <include refid="PaginationMapper.header"/>
            SELECT 
                A.PSTID,
                A.SITEID,
                A.TITLE,
                A.DEL_YN,
                A.GRP,
                A.ORD,
                A.DPTH,
                A.FXD_NTC_YN,
                IFNULL(A.HITS,0) AS HITS,
                B.FXD_NTC_USE_YN, 
                IFNULL(C.cmntcnt,0) cmnt_cnt,
                A.REG_DT, 
                <choose>
                    <when test='hotUseYn == "Y"'>
                     CASE WHEN (FXD_NTC_YN = 'N' OR FXD_NTC_YN IS NULL) AND HITS <![CDATA[>=]]> #{hotUseStdrHits} THEN HITS
                          ELSE 0
                     END hot_order_num,
                     CASE WHEN (FXD_NTC_YN = 'N' OR FXD_NTC_YN IS NULL) AND HITS <![CDATA[>=]]> #{hotUseStdrHits} THEN 'Y'
                          ELSE 'N'
                     END hot_yn,
                    </when>
                    <otherwise>
                      0 hot_order_num,
                     'N' hot_yn,
                    </otherwise>
                </choose>
                <choose>
                    <when test='hotUseYn == "Y" and newUseYn == "Y"'>
                     CASE WHEN (FXD_NTC_YN = 'N' OR FXD_NTC_YN IS NULL) AND IFNULL(HITS,0) <![CDATA[<]]> #{hotUseStdrHits}
                               AND NOW() <![CDATA[<=]]> DATE_ADD(A.REG_DT, INTERVAL  #{newIndictDaycnt}  DAY)
                          THEN 'Y'
                          ELSE 'N'
                     END new_yn,
                    </when>
                    <when test='hotUseYn != "Y" and newUseYn == "Y"'>
                     CASE WHEN  NOW() <![CDATA[<=]]> DATE_ADD(A.REG_DT, INTERVAL  #{newIndictDaycnt}  DAY) THEN 'Y'
                          ELSE 'N'
                     END new_yn,
                    </when>
                    <otherwise>
                      'N' new_yn,
                    </otherwise>
                </choose>
                 CASE WHEN FXD_NTC_YN = 'Y' THEN 1
                      ELSE 2
                  END AS FIXORDER ,
                A.MDFCN_DT,
                D.NM
            FROM 
                TB_CMM_PST A
                INNER JOIN 
                TB_CMM_BBS B 
                ON A.BBSID = B.BBSID
                LEFT OUTER JOIN (
                    SELECT 
                         PSTID
                         ,COUNT(Cmntid) cmntCnt 
                      FROM 
                         TB_CMM_CMNT 
                     GROUP BY PSTID
                ) C ON  A.PSTID =C.PSTID
                INNER JOIN
                    TB_CMM_USER D
                ON A.RGTRID = D.USERID
                INNER JOIN
                TB_CMM_SITE E
                ON A.SITEID = E.SITEID
            WHERE 1=1
           -- AND A.DEL_YN = 'N'
            <bind name="searchSiteValue" value="searchSite"/>
            <bind name="searchSiteSysSeCd" value="'U'"/>
            <include refid="SearchMapper.siteLmtCondition">
                <property name="tableAlias" value="E"/>
            </include>
            <if test="bbsid != null and bbsid != 0">
            AND A.BBSID= #{bbsid}
            </if>
            <if test="searchType != null and searchType == 'nm' ">
            AND A.TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>         
            <if test="searchType != null and searchType == 'cntnts' ">
            AND A.CNTNTS LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>
            <if test="@com.kbrainc.plum.rte.util.CommonUtil@isEmpty(searchType) and @com.kbrainc.plum.rte.util.CommonUtil@isNotEmpty(searchKeyword)">
            AND (A.TITLE LIKE CONCAT('%', #{searchKeyword}, '%') OR A.CNTNTS LIKE CONCAT('%', #{searchKeyword}, '%'))
            </if>
            <if test='user.roleInfo.trgtInstCd == "S"'>
            AND A.SITEID IN ( SELECT A.SITEID FROM TB_CMM_SITE A WHERE INSTID =  #{user.instid} )
            </if>
            <!--관리자에서는 고정공지 기간이 지나도 보이도록-->            
            <!-- <if test='fxdNtcUseYn == "Y"'>
                 AND PRNTS_PSTID IS NULL
                 AND (CASE WHEN FXD_NTC_YN ='Y' AND   FXD_NTC_STRT_DT <![CDATA[<=]]> NOW() AND DATE_ADD(FXD_NTC_END_DT, INTERVAL 1 DAY)  <![CDATA[>=]]> NOW() THEN 'Y'
                       WHEN FXD_NTC_YN ='Y' AND FXD_NTC_STRT_DT IS NULL AND FXD_NTC_END_DT IS NULL THEN 'Y'
                       WHEN FXD_NTC_YN ='N' or FXD_NTC_YN IS NULL THEN 'Y'
                       ELSE 'N' 
                 END )= 'Y'
             </if> -->
             
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 게시물을 수정한다. -->
    <update id="updatePst" parameterType="PstVo">
        /* BbsDao.updatePst */
        UPDATE TB_CMM_PST SET     
            TITLE          = #{title         },
            CNTNTS         = #{cntnts        },
            <if test="siteid != null and siteid != 0">
            SITEID         = #{siteid        },
            </if>
            BBS_CLID       = #{bbsClid      },
            FILEGRPID      = #{filegrpid     },
            MDFCN_DT        = NOW(),
            MDFRID     = #{user.userid   },
            <choose>
                <when test='fxdNtcYn == "Y" '>
                FXD_NTC_YN     = #{fxdNtcYn    },
                FXD_NTC_STRT_DT= #{fxdNtcStrtDt},
                FXD_NTC_END_DT = #{fxdNtcEndDt },
                </when>
                <otherwise>
                FXD_NTC_YN     = null,
                FXD_NTC_STRT_DT= null,
                FXD_NTC_END_DT = null,
                </otherwise>
            </choose>
            LOGIN_YN       = #{loginYn      }
        WHERE 
            PSTID = #{pstid}     
    </update>
    
    <!-- 게시물 답글 일괄 수정 -->
    <update id="updatePstReply" parameterType="PstVo">
        /* BbsDao.updatePstReply */
        UPDATE TB_CMM_PST SET     
            <if test="siteid != null and siteid != 0">
            SITEID        = #{siteid        },
            </if>
            TITLE         =  (CASE WHEN LOCATE('RE:RE:',TITLE) > 0 THEN concat('RE:RE:', #{title})
                                   WHEN LOCATE('RE:',TITLE) > 0 THEN concat('RE:', #{title})
                                   ELSE #{title}
                               END 
                              ),
            BBS_CLID      = #{bbsClid      },
            MDFCN_DT      = NOW(),
            MDFRID        = #{user.userid   },
            FXD_NTC_YN    = #{fxdNtcYn    },
            LOGIN_YN      = #{loginYn      }
        WHERE PSTID IN(
            WITH RECURSIVE CTE AS (
                 SELECT 
                    #{pstid} AS PSTID
                 UNION ALL
                 SELECT
                    A.PSTID AS PSTID
                   FROM TB_CMM_PST A
                   INNER JOIN  CTE B
                   ON (A.PRNTS_PSTID  = B.PSTID) 
            )
            SELECT PSTID FROM CTE WHERE PSTID != #{pstid}
        )     
    </update>
    
    <!-- 게시물 정보를 가져온다. -->
    <select id="selectPst"  parameterType="PstVo" resultType ="PstVo" >
        /* BbsDao.selectPst */
        SELECT 
            A.PSTID             
           ,A.SITEID            
           ,B.BBSID             
           ,B.NM                
           ,A.rgtrid            
           ,C.NM                
           ,A.REG_DT            
           ,IFNULL(A.HITS,0) AS HITS   
           ,A.TITLE             
           ,A.CNTNTS            
           ,A.MDFCN_DT          
           ,A.fxd_ntc_yn
           ,A.fxd_ntc_strt_dt
           ,A.fxd_ntc_end_dt 
           ,A.login_yn
           ,A.del_yn
           ,A.BBS_CLID            
           ,A.ORD                 
           ,A.GRP                 
           ,A.DPTH                
           ,IFNULL(a.FILEGRPID,0) AS FILEGRPID 
           ,B.hot_use_yn
           ,b.atchfile_use_yn     
           ,b.atchfile_cnt        
           ,b.atchfile_size       
           ,B.cmnt_use_yn         
           ,B.rply_use_yn         
           ,B.cl_use_yn           
           ,B.fxd_ntc_use_yn      
           ,B.FXD_NTC_CNT         
           ,D.CL_NM               
          --  (SELECT  SUM( CASE WHEN fxd_ntc_yn = 'Y' THEN 1 ELSE 0 END ) FROM TB_CMM_PST E WHERE A.BBSID = E.BBSID ) as cur_fxd_ntc_cnt
        FROM
            TB_CMM_PST A
            LEFT OUTER JOIN TB_CMM_BBS_CL D ON (A.BBS_CLID = D.BBS_CLID),
            TB_CMM_BBS B,
            TB_CMM_USER C
        WHERE 
            1=1
            AND A.BBSID = B.BBSID
            AND A.RGTRID = C.USERID
            AND A.PSTID = #{pstid}
    </select>
    
    <!-- 게시물을 삭제한다. -->
    <delete id="deletePst" parameterType="PstVo" >
        /* BbsDao.deletePst */
        <!-- DELETE FROM TB_CMM_PST --> 
        UPDATE TB_CMM_PST 
           SET DEL_YN    = #{delYn}
               ,MDFCN_DT = NOW()
               ,MDFRID   = #{user.userid }
        WHERE 1=1
        <choose>
           <when test="delPstids != null and delPstids != '' ">
              AND PSTID IN
               (
                 <foreach item="item" collection="delPstids"  separator=",">
                    #{item}
                 </foreach>
               )  
           </when>
           <otherwise>
              AND PSTID =#{pstid}
           </otherwise>
        </choose>
    </delete>
    
    <!-- 게시물 댓글 순서를 수정한다. -->
    <update  id="updatePstOrd" parameterType="CmntVo" >
        /* BbsDao.updatePstOrd */
        UPDATE TB_CMM_PST SET
            ORD           = #{ord}, 
            MDFCN_DT       = NOW(),
            MDFRID    = #{user.userid}
        WHERE 
           pstid = #{pstid} 
    </update>
  
    <!-- 게시물 댓글 순서를 수정한다. -->
    <update  id="updatePstOrdElse" parameterType="CmntVo" >
        /* BbsDao.updatePstOrdElse */
        <selectKey keyProperty="ord" resultType="Int" order="BEFORE"> 
<!--         SELECT 
            CASE 
                WHEN
                    (SELECT  IFNULL(MAX(ORD),0)  FROM  TB_CMM_PST  WHERE GRP= #{grp} AND DPTH = #{dpth}+1 ) = 0
                    THEN 
                        #{ord}+1
                ELSE
                    (SELECT  IFNULL(MAX(ORD),0)  FROM  TB_CMM_PST  WHERE GRP= #{grp}  AND DPTH = #{dpth}+1 )+1
            END -->
           WITH RECURSIVE CTE AS (
                   SELECT 
                      #{prntsPstid} AS PSTID
                   UNION ALL
                   SELECT
                      A.PSTID AS PSTID
                     FROM TB_CMM_PST A
                     INNER JOIN  CTE B
                     ON (A.PRNTS_PSTID  = B.PSTID) 
             )
                SELECT 
                   IFNULL(MAX(A.ORD),0) + 1 AS ord
                  FROM 
                   TB_CMM_PST A
                 WHERE 1=1 
                   AND PSTID IN (
                       SELECT PSTID FROM CTE   
                   )
        </selectKey>
        UPDATE TB_CMM_PST SET
            ORD      = ORD +1
            ,MDFCN_DT = NOW()
            ,MDFRID   = #{user.userid}
        WHERE 1=1
          AND GRP = #{grp}
          AND ORD >= #{ord} 
    </update>
    
    <!-- 게시물  조회수 증가  -->
    <update id="updatePstHitsCount" parameterType="front.PstVo" >
        /* BbsDao.updatePstHitsCount */
        UPDATE TB_CMM_PST SET
             HITS        = IFNULL(HITS,0)+1 
            ,MDFCN_DT     = NOW()
            <if test="user != null and user.userid != null ">
            ,MDFRID  = #{user.userid }
            </if>
        WHERE 
            pstid = #{pstid}  
    </update>
    
    
    <!--******************* 댓글 SQL START ***************************  -->
    <!-- 댓글을 삭제한다. -->
    <delete id="deleteCmnt" parameterType="PstVo" >
        /* BbsDao.deleteCmnt */
<!--         DELETE FROM TB_CMM_CMNT -->
            UPDATE TB_CMM_CMNT 
               SET DEL_YN    = #{delYn}
                   ,MDFCN_DT = NOW()
                   ,MDFRID   = #{user.userid }
            WHERE 1=1
              AND PSTID =#{pstid}
    </delete>
  
  <!-- 댓글 목록을 가져온다. -->
  <select id="selectCmntList" parameterType="CmntVo"  resultType ="CmntVo">
        /* BbsDao.selectCmntList */
        <include refid="PaginationMapper.header"/>
        SELECT 
            a.PSTID,
            a.CMNTID,
            a.CNTNTS,
            a.PRNTS_CMNTID,
            a.CMNT_GRP,
            a.DPTH,
            a.ORD,
            a.OPN_YN,
            a.MDFCN_DT,
            a.MDFRID,
            a.REG_DT,
            a.RGTRID,
            a.del_yn,
            b.NM,
            b.ACNT
        FROM
            TB_CMM_CMNT a,
            TB_CMM_USER b 
        WHERE 
            1=1
            AND a.RGTRID = b.USERID
            AND PSTID = #{pstid}
            <if test="prntsCmntid != null and prntsCmntid != 0 ">
            AND PRNTS_CMNTID = #{prntsCmntid}
            </if>         
        <include refid="PaginationMapper.footer"/>
    </select>
  
    <!-- 게시물 댓글 삭제 유무를 수정한다. -->
    <update id="updateCmntReplyDelYn" parameterType="CmntVo" >
        /* BbsDao.updateCmntReplyDelYn */
        UPDATE TB_CMM_CMNT SET
            DEL_YN      = #{delYn},
            MDFCN_DT     = NOW(),
            MDFRID  = #{user.userid }
        WHERE 
            cmntid = #{cmntid}  
    </update>
    
    <!-- 게시물 댓글을 수정한다. -->
    <update  id="updateCmnt" parameterType="CmntVo" >
        /* BbsDao.updateCmnt */
        UPDATE TB_CMM_CMNT SET
            CNTNTS        =#{cntnts}, 
            MDFCN_DT       = NOW(),
            MDFRID    =#{user.userid}
        WHERE 
            cmntid = #{cmntid} 
    </update>
  
    <!-- 댓글 순서를 수정한다. -->
    <update  id="updateCmntOrd" parameterType="CmntVo" >
        /* BbsDao.updateCmntOrd */
        UPDATE TB_CMM_CMNT SET
            ORD           = #{ord}, 
            MDFCN_DT       = NOW(),
            MDFRID    = #{user.userid}
        WHERE 
           cmntid = #{cmntid} 
    </update>
    
    <!-- 댓글 순서를 수정한다. -->
    <update  id="updateCmntOrdElse" parameterType="CmntVo" >
        /* BbsDao.updateCmntOrdElse */
        <selectKey keyProperty="ord" resultType="Int" order="BEFORE"> 
     <!-- SELECT 
            CASE 
                WHEN
                    (SELECT  IFNULL(MAX(ORD),0)  FROM  TB_CMM_CMNT  WHERE CMNT_GRP= #{cmntGrp} AND DPTH = #{dpth}+1 ) = 0
                    THEN 
                        #{ord}+1
                ELSE
                    (SELECT  IFNULL(MAX(ORD),0)  FROM  TB_CMM_CMNT  WHERE CMNT_GRP= #{cmntGrp}  AND DPTH = #{dpth}+1 )+1
            END -->
             WITH RECURSIVE CTE AS (
                   SELECT 
                      #{prntsCmntid} AS CMNTID
                   UNION ALL
                   SELECT
                      A.CMNTID AS CMNTID
                     FROM TB_CMM_CMNT A
                     INNER JOIN  CTE B
                     ON (A.PRNTS_CMNTID  = B.CMNTID) 
             )
            SELECT 
               IFNULL(MAX(A.ORD),0) + 1 AS ord
              FROM 
               TB_CMM_CMNT A
             WHERE 1=1 
               AND CMNTID IN (
                   SELECT CMNTID FROM CTE   
               )
        </selectKey>
        update tb_cmm_cmnt set
            ord = ord +1
        where  
            CMNT_GRP = #{cmntGrp}
            and ord >= #{ord} 
    </update>

    <!-- 게시물 댓글를 추가한다. -->
    <insert  id="insertCmnt" useGeneratedKeys="true" keyProperty="cmntid" parameterType="CmntVo">
        /* BbsDao.insertCmnt */
        INSERT INTO TB_CMM_CMNT (
            PSTID,
            CNTNTS,
            PRNTS_CMNTID,
            CMNT_GRP,
            DPTH,
            ORD,
            DEL_YN,
            MDFCN_DT,
            MDFRID,
            REG_DT,
            RGTRID
        )VALUES(
            #{pstid       },
            #{cntnts      },
            #{prntsCmntid},
            IFNULL(#{cmntGrp }, (SELECT  IFNULL(MAX(CMNT_GRP),0) +1 FROM TB_CMM_CMNT CMNT)),
            IFNULL(#{dpth}, 0),
            IFNULL(#{ord  }, 1),
            'N',
            NOW(),
            #{user.userid },
            NOW(),
            #{user.userid }
        );
    </insert>
    
    <!-- 게시물 답글 정보를 가져온다 -->
    <select id="selectReplyPstList"  parameterType="PstVo" resultType ="PstVo" >
        /* BbsDao.selectReplyPstList */
        SELECT 
            A.PSTID      as pstid,
            B.BBSID      as bbsid,
            B.NM         as nm,
            A.rgtrid  as userid,
            C.NM    as user_nm,
            C.ACNT  as acnt,
            A.REG_DT     as reg_dt,
            IFNULL(A.HITS,0)   as hits,
            A.TITLE               as title,
            A.CNTNTS              as cntnts,
            A.MDFCN_DT             as mdfcn_dt,
            A.fxd_ntc_yn,
            A.BBS_CLID            as bbs_clid,
            IFNULL(a.FILEGRPID,0) as filegrpid,
            B.hot_use_yn,
            b.atchfile_use_yn     as atchfile_use_yn,
            b.atchfile_cnt        as atchfile_cnt,
            b.atchfile_size       as atchfile_size,
            B.cmnt_use_yn         as cmnt_use_yn,
            B.rply_use_yn         as rply_use_yn,
            B.cl_use_yn           as cl_use_yn,
            B.fxd_ntc_use_yn      as fxd_ntc_use_yn,
            B.FXD_NTC_CNT         as fxd_ntc_cnt,
            D.CL_NM               as cl_nm,
            D.BBS_CLID               as bbs_clid,
            (SELECT  SUM( CASE WHEN fxd_ntc_yn = 'Y' THEN 1 ELSE 0 END ) FROM TB_CMM_PST E WHERE A.BBSID = E.BBSID ) cur_fxd_ntc_cnt
        FROM
            TB_CMM_PST A
            LEFT OUTER JOIN TB_CMM_BBS_CL D ON (A.BBS_CLID = D.BBS_CLID),
            TB_CMM_BBS B,
            TB_CMM_USER C
        WHERE 
            1=1
            AND A.BBSID = B.BBSID
            AND A.RGTRID = C.USERID
            AND A.PRNTS_PSTID = #{prntsPstid}
            ORDER BY A.MDFCN_DT DESC 
    </select>
    
    <!-- 게시물 답글 정보를 가져온다 -->
    <select id="selectNtcPstCnt"  parameterType="PstVo" resultType ="PstVo" >
      /* BbsDao.selectReplyPstList */
      SELECT 
        COUNT(pstid) AS fxdNtcCnt
       FROM
         TB_CMM_PST
       WHERE 1=1
        AND SITEID = #{siteid}
        AND BBSID  = #{bbsid}
        AND FXD_NTC_YN = 'Y'
    </select>
    
</mapper>