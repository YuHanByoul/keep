<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : EnvReqstDaoImpl.xml
    Description : 환경교육시설 예약
-->
<mapper namespace="com.kbrainc.plum.front.mypage.mypageEnvReqst.model.MypageEnvReqstDao">

    <select id="selectMypageEnvReqstList" resultType="front.EnvReqstVo">
        <include refid="PaginationMapper.header"/>
        SELECT 
          A.*
         FROM (
         
            SELECT 
                A.APLYID
                , A.STLM_STTS_CD
                , A.APLY_STTS_CD
                , A.APLCNTID
                , A.APLCNT_NM
                , A.AMT
                , A.DPST_AMT
                , A.RFND_DMND_AMT
                , A.RFND_AMT
                , A.MDFCN_DT
                , A.RVW_CN
                , A.RVW_SCR
                , A.RVW_DT
                , CASE WHEN A.STLM_STTS_CD = '161104' THEN '161104' /* 환불완료*/
                       WHEN A.STLM_STTS_CD = '161103' THEN '161103' /* 환불요청*/
                       WHEN A.APLY_STTS_CD = '160103' THEN '160103' /* 예약취소 */
                       WHEN A.STLM_STTS_CD = '161102' THEN '161102' /* 입금완료 */
                       ELSE '161101' /* 입금대기 */
                    END AS TOTAL_STTS
                , A.RSVT_CNCL_RSN    
                , A.RFND_REJECT_RSN    
                , C.INSTID
                , C.INST_NM
                , B.ALLDAY_YN
                , B.BGNG_DT
                , B.END_DT
                , E.SPCE_NM
                , E.SIZE
                , E.MAX_NOPE
                , F.ADDR
                , F.ADDR_DTL
                , F.FCLT_NM
                , F.RGN_CD
                , G.ACNT
                , G.NM
                , F.RPRS_IMG_FILEID
                , D.FILE_IDNTFC_KEY AS RPRS_IMG_FILE_KEY
                FROM TB_FCL_SPCE_APLY A
                INNER JOIN (
                 SELECT 
                      B.APLYID,
                      D.SPCEID,
                      MIN(D.BGNG_DT) AS BGNG_DT,
                      B.ALLDAY_YN,
                      CASE WHEN B.ALLDAY_YN = 'N' THEN MAX(D.END_DT)
                           ELSE MAX(D.BGNG_DT) 
                      END AS END_DT
                   FROM 
                      TB_FCL_APLY_RSVTDE B
                      LEFT JOIN TB_FCL_SPCE_RSVTDE D 
                      ON B.RSVTDEID = D.RSVTDEID
                  GROUP BY APLYID
                ) B
                ON A.APLYID = B.APLYID
                INNER JOIN TB_FCL_SPCE E
                ON B.SPCEID = E.SPCEID
                INNER JOIN TB_FCL_FCLT F
                ON E.FCLTID = F.FCLTID
                INNER JOIN TB_CMM_INST C
                ON F.INSTID = C.INSTID
                LEFT OUTER JOIN TB_CMM_USER G 
                ON A.APLCNTID = G.USERID
                LEFT OUTER JOIN TB_CMM_FILE D 
                ON F.RPRS_IMG_FILEID = D.FILEID
            WHERE 1=1
               AND A.APLCNTID = #{user.userid}
            <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('spceNm')">
                AND E.SPCE_NM LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchKeyword != null and searchKeyword != '' and searchType.equals('fcltNm')">
                AND F.FCLT_NM LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <!-- 신청일 검색시작일  -->
            <if test="searchBgngDt != null and searchBgngDt != ''">
                AND B.BGNG_DT >= date(#{searchBgngDt})
            </if>
            <!-- 신청일 검색종료일  -->
            <if test="searchEndDt  != null and searchEndDt != ''">
                AND B.END_DT <![CDATA[<=]]> date(#{searchEndDt})
            </if>
         ) A
         WHERE 1=1 
           <if test="searchAplySttsCd != null and searchAplySttsCd != ''">
            AND A.TOTAL_STTS = #{searchAplySttsCd}
           </if>
        <include refid="PaginationMapper.footer"/>
        
    </select>

    <!-- 환경교육시설 예약 상세조회 -->
    <select id="selectResveEnvInfo" resultType="front.EnvReqstVo">
        /* EnvReqstDao.selectResveEnvInfo */
        SELECT
            A.APLYID
             ,A.STLM_STTS_CD
             ,A.APLY_STTS_CD
             ,A.APLCNTID
             ,A.APLCNT_NM
             ,A.APLCNT_MOBLPHON
             ,A.APLCNT_EML
             ,A.CNCL_DT
             ,A.RFND_DMND_DT
             ,A.RFND_DMND_AMT
             ,A.PYR_NM
             ,A.DPST_AMT
             ,A.DPST_DE
             ,A.DPST_BACNT
             ,A.DPST_BANK_CD
             ,A.RFND_BANK_CD
             ,A.RFND_BACNT
             ,A.RFND_PYR_NM
             ,A.RFND_AMT
             ,A.RFND_DE
             ,A.NOPE_ADULT
             ,A.NOPE_CHIL
             ,A.NOPE_INFNT
             ,A.UTZTN_PRPS
             ,A.AMT
             ,A.REG_DT
             ,A.RSVT_REJECT_RSN
             ,A.RSVT_CNCL_RSN
             ,A.RFND_REJECT_RSN_CD
             ,A.RFND_REJECT_RSN
             ,A.CNCL_RSN_CD
             ,A.RVW_CN
             ,A.RVW_SCR
             ,A.RVW_DT
             ,SUBSTRING_INDEX(SUBSTRING_INDEX(A.APLCNT_EML, '@', 1), '@', -1) AS APLCNT_EML_ID
             ,SUBSTRING_INDEX(SUBSTRING_INDEX(A.APLCNT_EML, '@', 2), '@', -1) AS APLCNT_EML_DOMAIN
             , A.RSVT_CNCL_RSN    
             , A.RFND_REJECT_RSN
             ,C.INSTID
             ,C.INST_NM
             ,B.ALLDAY_YN
             ,B.BGNG_DT
             ,B.END_DT
             ,B.UTZTN_SE_CD
             ,E.SPCE_NM
             ,E.CHKIN_HR
             ,E.CHCKT_HR
             ,E.MAX_NOPE
             ,E.SIZE
             ,F.EXTNL_URL
             ,F.FCLT_NM
             ,F.BACNT_NO
             ,F.DPSTR_NM
             ,F.ADDR
             ,F.ADDR_DTL
             ,CASE WHEN IFNULL(I.ROLECD,'U') = 'U' AND H.INSTID IS NOT NULL THEN '기업회원'
                   WHEN IFNULL(I.ROLECD,'U') = 'U' AND H.INSTID IS NULL THEN '개인회원'
                   ELSE '관리자'
            END AS ROLECDNM
             ,H.NM
             ,H.MOBLPHON
             ,H.EML
             ,H.ACNT
             ,D.RESVE_DT
             ,IFNULL(C.INST_NM, '-') AS USER_INST_NM
        FROM
            TB_FCL_SPCE_APLY A
            INNER JOIN (
                  SELECT 
                     B.UTZTN_SE_CD
                     , B.APLYID
                     , D.SPCEID
                     , MIN(D.BGNG_DT) AS BGNG_DT
                     , B.ALLDAY_YN
                     ,CASE WHEN B.ALLDAY_YN = 'N' THEN MAX(D.END_DT)
                           ELSE MAX(D.BGNG_DT) 
                       END AS END_DT
                    FROM 
                      TB_FCL_APLY_RSVTDE B
                      LEFT JOIN TB_FCL_SPCE_RSVTDE D 
                      ON B.RSVTDEID = D.RSVTDEID
                   GROUP BY APLYID
                   ) B
            ON A.APLYID = B.APLYID
            INNER JOIN (
                   SELECT 
                       A.APLYID
                       ,B.SPCEID
                       ,GROUP_CONCAT(
                          CONCAT(B.DE
                                 ,' '
                                ,(CASE WHEN B.ALLDAY_YN ='N' THEN CONCAT (DATE_FORMAT(B.BGNG_DT,'%H시%i분'),' ~ ',DATE_FORMAT(B.END_DT,'%H시%i분')) ELSE '숙박'END)
                                ,' ('
                                , CASE WHEN B.AMT = 0 THEN '무료)'ELSE CONCAT(FORMAT(B.AMT,0),'원)') END 
                          )
                       SEPARATOR  '/' 
                       ) AS RESVE_DT  
                     FROM 
                       TB_FCL_APLY_RSVTDE A
                       LEFT JOIN TB_FCL_SPCE_RSVTDE B 
                       ON A.RSVTDEID = B.RSVTDEID
                    WHERE A.APLYID = #{aplyid}
                    GROUP BY APLYID
            ) D ON A.APLYID = D.APLYID
            INNER JOIN TB_FCL_SPCE E
            ON B.SPCEID = E.SPCEID
            INNER JOIN TB_FCL_FCLT F
            ON E.FCLTID = F.FCLTID
            INNER JOIN TB_CMM_INST C
             ON F.INSTID = C.INSTID
            LEFT OUTER JOIN TB_CMM_USER H 
            ON A.APLCNTID = H.USERID
            LEFT OUTER JOIN (
            SELECT
                A.USERID
                 ,CASE WHEN INSTR(GROUP_CONCAT(A.ROLEID),'1') > 0 OR INSTR(GROUP_CONCAT(A.ROLEID),'5') > 0 THEN 'A'
                       ELSE 'U'
                END AS ROLECD
            FROM
                TB_CMM_ROLE_USER A
               ,TB_CMM_ROLE B
            WHERE 1=1
              AND A.ROLEID = B.ROLEID
            GROUP BY USERID
            ) I
            ON(H.USERID = I.USERID)
        WHERE 1=1
          AND A.APLYID = #{aplyid}
    </select>

    <select id="selectSpceInfo" resultType="front.EnvReqstVo">
        SELECT
            A.SPCEID
             , A.FCLTID
             , A.SPCE_NM
             , A.SPCE_NO
             , A.MAX_NOPE
             , A.SIZE
             , A.CHKIN_HR
             , A.CHCKT_HR
             , A.NXTY_CHCKT_YN
             , A.RSVT_PSBLTY_DAYCNT
             , A.TODAY_RSVT_PSBLTY_YN
             , A.USE_YN
             , A.MDFCN_DT
             , A.MDFRID
             , A.REG_DT
             , A.RGTRID
             , B.BANK_CD
             , B.BACNT_NO
             , B.DPSTR_NM
             , B.FCLTID
             , B.FCLT_NM
             , B.FCLT_NO
             , B.ADDR
             , B.ADDR_DTL
             , B.APLY_MTHD_CD
             , B1.CD_NM AS BANK_CD_NM
             , C.INST_NM
             , C.INSTID
        FROM
            TB_FCL_SPCE A
                INNER JOIN TB_FCL_FCLT B
                           ON A.FCLTID = B.FCLTID
                INNER JOIN TB_CMM_INST C
                           ON B.INSTID = C.INSTID
                INNER JOIN (
                    SELECT
                        CD
                         , CD_NM
                    FROM
                        TB_CMM_CD
                    WHERE
                        CDGRPID = 154
                ) B1 ON (B.BANK_CD = B1.CD)
        WHERE 1=1
          AND A.SPCEID = #{spceid}
    </select>

    <!-- 공간 예약 여부 확인 목록 -->
    <select id="selectFclRsvtdeList" resultType="map">
        /* SpceDao.selectFclRsvtdeList */
        SELECT RSVTDEID,
        SPCEID,
        DE,
        AMT,
        RSVT_PSBLTY_YN
        FROM TB_FCL_SPCE_RSVTDE A
        WHERE 1 = 1
        AND A.RSVTDEID IN (
        <foreach item="item" collection="rsvtdeid"  separator=",">
            #{item.rsvtdeid}
        </foreach>
        )
    </select>

    <!-- 사유 확인 팝업 -->
    <select id="selectRsnInfo" resultType="front.EnvReqstVo">
        /* MypageEnvReqstDao.selectRsnInfo */
        SELECT
            RFND_REJECT_RSN
        FROM TB_FCL_SPCE_APLY A
        WHERE 1 = 1
        AND A.APLYID = #{aplyid}
    </select>

    <!-- 입금정보 팝업 -->
    <select id="selectDpstInfo" resultType="front.EnvReqstVo">
        /* MypageEnvReqstDao.selectDpstInfo */
        SELECT
             A.AMT
             ,F1.CD_NM AS BANK_CD_NM
             ,F.BACNT_NO
             ,F.DPSTR_NM
        FROM
            TB_FCL_SPCE_APLY A
                INNER JOIN (SELECT B.APLYID, D.SPCEID FROM TB_FCL_APLY_RSVTDE B
                                     LEFT JOIN TB_FCL_SPCE_RSVTDE D ON B.RSVTDEID = D.RSVTDEID
                            GROUP BY APLYID) B
                           ON A.APLYID = B.APLYID
                INNER JOIN TB_FCL_SPCE E
                           ON B.SPCEID = E.SPCEID
                INNER JOIN TB_FCL_FCLT F
                           ON E.FCLTID = F.FCLTID
                INNER JOIN (
                SELECT
                    CD
                     , CD_NM
                FROM
                    TB_CMM_CD
                WHERE
                    CDGRPID = 154
            ) F1 ON (F.BANK_CD = F1.CD)
        WHERE
            1=1
          AND A.APLYID = #{aplyid}
    </select>

    <!-- 후기확인 기능 -->
    <select id="selectRwvInfo" resultType="front.EnvReqstVo">
        /* MypageEnvReqstDao.selectRwvInfo */
        SELECT
            RVW_CN,
            RVW_SCR,
            RVW_DT
        FROM TB_FCL_SPCE_APLY A
        WHERE
            1=1
          AND A.APLYID = #{aplyid}
    </select>

    <!-- 예약 취소 업데이트  -->
    <update id="insertRsn" parameterType="front.EnvReqstVo" >
        /* MypageEnvReqstDao.insertRsn */
        UPDATE TB_FCL_SPCE_APLY SET
          CNCL_RSN_CD       = '215104'
          ,APLY_STTS_CD     = '160103'
          ,RSVT_CNCL_RSN    = #{rsvtCnclRsn}
          ,CNCL_DT          = NOW()
          ,MDFRID           = #{user.userid}
          ,MDFCN_DT         = NOW()
        WHERE APLYID = #{aplyid}
    </update>

    <!-- 후기 작성 기능 -->
    <update id="insertRvw" parameterType="front.EnvReqstVo" >
        /* MypageEnvReqstDao.insertRvw */
        UPDATE TB_FCL_SPCE_APLY SET
            RVW_CN     = #{rvwCn}
            ,RVW_SCR   = #{rvwScr}
            ,RVW_DT    = NOW()
            ,MDFRID    = #{user.userid}
            ,MDFCN_DT  = NOW()
        WHERE APLYID = #{aplyid}
    </update>

    <!-- 후기 삭제 기능 -->
    <update id="deleteRvw" parameterType="front.EnvReqstVo" >
        /* MypageEnvReqstDao.deleteRvw */
        UPDATE TB_FCL_SPCE_APLY SET
            RVW_CN    = null
            ,RVW_SCR  = 0
            ,RVW_DT   = null
            ,MDFRID   = #{user.userid}
            ,MDFCN_DT = NOW()
        WHERE APLYID = #{aplyid}
    </update>
</mapper>