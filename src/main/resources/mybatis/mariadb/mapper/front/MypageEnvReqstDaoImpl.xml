<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : EnvReqstDaoImpl.xml
    Description : 환경교육시설 예약
-->
<mapper namespace="com.kbrainc.plum.front.mypage.mypageEnvReqst.model.MypageEnvReqstDao">

    <select id="selectMypageEnvReqstList" resultType="com.kbrainc.plum.front.mypage.mypageEnvReqst.model.MypageEnvReqstVo">
        <include refid="PaginationMapper.header"/>
        SELECT A.APLYID
        , A.RSVTDEID
        , A.UTZTN_SE_CD
        , A.DE
        , A.BGNG_DT
        , A.END_DT
        , A.AMT
        , CASE
        WHEN B.STLM_STTS_CD = 161101 AND B.APLY_STTS_CD = 160101 THEN '' /* 입금대기 - 예약신청 */
        WHEN B.STLM_STTS_CD = 161101 AND B.APLY_STTS_CD = 160103 THEN B.RSVT_CNCL_RSN /* 입금대기 - 예약취소 - 예약취소사유 */
        WHEN B.STLM_STTS_CD = 161102 AND B.APLY_STTS_CD = 160102 THEN '' /* 입금완료 - 예약승인 */
        WHEN B.STLM_STTS_CD = 161103 AND B.APLY_STTS_CD = 160103 THEN '' /* 환불요청 - 예약취소 */
        WHEN B.STLM_STTS_CD = 161104 AND B.APLY_STTS_CD = 160103 THEN '' /* 환불완료 - 예약취소 */
        WHEN B.STLM_STTS_CD = 161102 AND B.APLY_STTS_CD = 160102
        THEN B.RFND_REJECT_RSN /* 환불완료 - 예약취소 - 환불완료취소 - 환불완료취소사유 and 환불완료취소사유코드 */
        ELSE ''
        END AS CHG_RSN
        , D.SPCE_NM
        , D.SIZE
        , D.MAX_NOPE
        , E.FCLT_NM
        , E.ADDR
        , E.ADDR_DTL
        , E.RGN_CD
        FROM TB_FCL_APLY_RSVTDE A
        INNER JOIN TB_FCL_SPCE_APLY B ON A.APLYID = B.APLYID
        INNER JOIN TB_FCL_SPCE_RSVTDE C ON A.RSVTDEID = C.RSVTDEID
        INNER JOIN TB_FCL_SPCE D ON C.SPCEID = D.SPCEID
        INNER JOIN TB_FCL_FCLT E ON D.FCLTID = E.FCLTID
        WHERE A.RGTRID = #{user.userid}
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 환경교육시설 예약 상세조회 -->
    <select id="selectResveEnvInfo" resultType="com.kbrainc.plum.front.mypage.mypageEnvReqst.model.MypageEnvReqstVo">
        /* EnvReqstDao.selectResveEnvInfo */
        SELECT A.APLYID
             , A.RGTRID
             , A.RSVTDEID
             , A.UTZTN_SE_CD
             , A.DE
             , A.BGNG_DT
             , A.END_DT
             , A.REG_DT
             , B.APLCNT_NM
             , B.APLCNT_MOBLPHON
             , SUBSTRING_INDEX(SUBSTRING_INDEX(B.APLCNT_EML, '@', 1), '@', -1) AS APLCNT_EML_ID
             , SUBSTRING_INDEX(SUBSTRING_INDEX(B.APLCNT_EML, '@', 2), '@', -1) AS APLCNT_EML_DOMAIN
             , B.NOPE_ADULT
             , B.NOPE_CHIL
             , B.NOPE_INFNT
             , B.UTZTN_PRPS
             , B.AMT
             , B.DPST_AMT
             , B.RFND_DMND_AMT
             , B.RFND_AMT
             , B.STLM_MTHD_CD
             , B.DPST_BACNT
             , B.PYR_NM
             , B.APLY_DT
             , B.DPST_DE
             , B.DPST_IDNTY_DT
             , B.CNCL_DT
             , B.RFND_DMND_DT
             , B.RFND_DE
             , B.RFND_CMPTN_DT
             , B.RFND_BANK_CD
             , B.RFND_BACNT
             , B.RFND_PYR_NM
             , B.APLY_STTS_CD
             , B.STLM_STTS_CD
             , B.CNCL_RSN_CD
             , B1.CD_NM AS CNCL_RSN_CD_NM
             , B.RSVT_REJECT_RSN
             , B.RSVT_CNCL_RSN
             , B.RFND_REJECT_RSN
             , CASE
                   WHEN B.STLM_STTS_CD = 161101 AND B.APLY_STTS_CD = 160101 THEN '' /* 입금대기 - 예약신청 */
                   WHEN B.STLM_STTS_CD = 161101 AND B.APLY_STTS_CD = 160103 THEN B.RSVT_CNCL_RSN /* 입금대기 - 예약취소 - 예약취소사유 */
                   WHEN B.STLM_STTS_CD = 161102 AND B.APLY_STTS_CD = 160102 THEN '' /* 입금완료 - 예약승인 */
                   WHEN B.STLM_STTS_CD = 161103 AND B.APLY_STTS_CD = 160103 THEN '' /* 환불요청 - 예약취소 */
                   WHEN B.STLM_STTS_CD = 161104 AND B.APLY_STTS_CD = 160103 THEN '' /* 환불완료 - 예약취소 */
                   WHEN B.STLM_STTS_CD = 161102 AND B.APLY_STTS_CD = 160102
                       THEN B.RFND_REJECT_RSN /* 환불완료 - 예약취소 - 환불완료취소 - 환불완료취소사유 and 환불완료취소사유코드 */
                   ELSE ''
            END AS CHG_RSN
             , D.SPCE_NM
             , D.SIZE
             , D.MAX_NOPE
             , D.CHKIN_HR
             , D.CHCKT_HR
             , E.FCLT_NM
             , E.RGN_CD
             , E.BANK_CD
             , E.BACNT_NO
             , E.DPSTR_NM
             , E.FCLTID
             , E.FCLT_NM
             , E.FCLT_NO
             , E.ADDR
             , E.ADDR_DTL
             , E.APLY_MTHD_CD
             , E1.CD_NM AS BANK_CD_NM
             , F.INST_NM
        FROM TB_FCL_APLY_RSVTDE A
                 INNER JOIN TB_FCL_SPCE_APLY B ON A.APLYID = B.APLYID
                 LEFT OUTER JOIN (
                        SELECT
                            CD
                             , CD_NM
                        FROM
                            TB_CMM_CD
                        WHERE
                            CDGRPID = 215
                    ) B1 ON (B.CNCL_RSN_CD = B1.CD)
                 INNER JOIN TB_FCL_SPCE_RSVTDE C ON A.RSVTDEID = C.RSVTDEID
                 INNER JOIN TB_FCL_SPCE D ON C.SPCEID = D.SPCEID
                 INNER JOIN TB_FCL_FCLT E ON D.FCLTID = E.FCLTID
                 INNER JOIN (
                        SELECT
                            CD
                             , CD_NM
                        FROM
                            TB_CMM_CD
                        WHERE
                            CDGRPID = 154
                    ) E1 ON (E.BANK_CD = E1.CD)
                 INNER JOIN TB_CMM_INST F ON E.INSTID = F.INSTID
        WHERE A.APLYID = #{aplyid} AND A.RSVTDEID = #{rsvtdeid}
    </select>

    <select id="selectSpceInfo" resultType="com.kbrainc.plum.front.mypage.mypageEnvReqst.model.MypageEnvReqstVo">
        SELECT
            A.SPCEID
             , A.FCLTID
             , A.SPCE_NM
             , A.SPCE_NO
             , A.MAX_NOPE
             , A.SIZE
             , A.CHKIN_HR
             , A.CHCKT_HR
             , A.NXTY_CHCKT_YN
             , A.RSVT_PSBLTY_DAYCNT
             , A.TODAY_RSVT_PSBLTY_YN
             , A.USE_YN
             , A.MDFCN_DT
             , A.MDFRID
             , A.REG_DT
             , A.RGTRID
             , B.BANK_CD
             , B.BACNT_NO
             , B.DPSTR_NM
             , B.FCLTID
             , B.FCLT_NM
             , B.FCLT_NO
             , B.ADDR
             , B.ADDR_DTL
             , B.APLY_MTHD_CD
             , B1.CD_NM AS BANK_CD_NM
             , C.INST_NM
             , C.INSTID
        FROM
            TB_FCL_SPCE A
                INNER JOIN TB_FCL_FCLT B
                           ON A.FCLTID = B.FCLTID
                INNER JOIN TB_CMM_INST C
                           ON B.INSTID = C.INSTID
                INNER JOIN (
                    SELECT
                        CD
                         , CD_NM
                    FROM
                        TB_CMM_CD
                    WHERE
                        CDGRPID = 154
                ) B1 ON (B.BANK_CD = B1.CD)
        WHERE 1=1
          AND A.SPCEID = #{spceid}
    </select>

    <!-- 예약 등록(시설 예약) -->
    <insert id="insertResveEnvFclSpceAply" useGeneratedKeys="true" keyProperty="aplyid">
        /* EnvReqstDao.insertResveEnvFclAply */
        INSERT INTO TB_FCL_SPCE_APLY (
            APLCNTID
            ,APLCNT_NM
            ,APLCNT_MOBLPHON
            ,APLCNT_EML
            ,NOPE_ADULT
            ,NOPE_CHIL
            ,NOPE_INFNT
            ,UTZTN_PRPS
            ,AMT
            ,STLM_MTHD_CD
            ,DPST_BACNT
            ,PYR_NM
            ,APLY_DT
            ,MDFCN_DT
            ,MDFRID
            ,REG_DT
            ,RGTRID
        )VALUES
        (
            #{user.userid}
            ,#{aplcntNm}
            ,#{aplcntMoblphon}
            ,#{aplcntEml}
            ,#{nopeAdult}
            ,#{nopeChil}
            ,#{nopeInfnt}
            ,#{utztnPrps}
            ,#{amt}
            ,'190101'
            ,#{bacntNo}
            ,#{pyrNm}
            ,NOW()
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
        )
    </insert>

    <!-- 예약 등록(시설 예약) -->
    <insert id="insertResveEnvFclAply" keyProperty="userid">
        /* EnvReqstDao.insertResveEnvFclAply */
        INSERT INTO TB_FCL_APLY_RSVTDE (
                APLYID,
                RSVTDEID,
                UTZTN_SE_CD,
                DE,
                BGNG_DT,
                END_DT,
                AMT,
                MDFCN_DT,
                MDFRID,
                REG_DT,
                RGTRID
        )VALUES
        <foreach item="item" collection="rsvtdeids"  separator=",">
             (
            #{aplyid}
            ,#{item}
            ,#{utztnSeCd}
            ,#{de}
            ,#{bgngDt}
            ,#{endDt}
            ,#{amt}
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
            )
        </foreach>
    </insert>

    <!-- 예약 등록(시설 예약-히스토리) -->
    <insert id="insertResveEnvFclAplyHstry" useGeneratedKeys="true" keyProperty="aplyid">
        /* EnvReqstDao.insertResveEnvFclAply */
        INSERT INTO TB_FCL_SPCE_APLY_HSTRY (
                                      APLYID
                                     ,APLCNTID
                                     ,APLCNT_NM
                                     ,APLCNT_MOBLPHON
                                     ,APLCNT_EML
                                     ,NOPE_ADULT
                                     ,NOPE_CHIL
                                     ,NOPE_INFNT
                                     ,UTZTN_PRPS
                                     ,AMT
                                     ,STLM_MTHD_CD
                                     ,DPST_BACNT
                                     ,PYR_NM
                                     ,APLY_DT
                                     ,MDFCN_DT
                                     ,MDFRID
                                     ,REG_DT
                                     ,RGTRID
        )VALUES
            (
             #{aplyid}
            ,#{user.userid}
            ,#{aplcntNm}
            ,#{aplcntMoblphon}
            ,#{aplcntEml}
            ,#{nopeAdult}
            ,#{nopeChil}
            ,#{nopeInfnt}
            ,#{utztnPrps}
            ,#{amt}
            ,'190101'
            ,#{bacntNo}
            ,#{pyrNm}
            ,NOW()
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
            )
    </insert>

    <!-- 예약 등록(공간 예약) -->
    <!--<insert id="insertResveEnvSpceAply" keyProperty="userid">
        /* EnvReqstDao.insertResveEnvSpceAply */
        INSERT INTO TB_FCL_SPCE_APLY (
                APLCNTID,
                INSTID,
                APLCNT_NM,
                APLCNT_MOBLPHON,
                APLCNT_EML,
                NOPE_ADULT,
                NOPE_CHIL,
                NOPE_INFNT,
                UTZTN_PRPS,
                AMT,
                DPST_BACNT,
                PYR_NM,
                APLY_DT,
                APLY_STTS_CD,
                STLM_STTS_CD,
                MDFCN_DT,
                MDFRID,
                REG_DT,
                RGTRID
        )VALUES(
               #{aplcntid},
               #{instid},
               #{aplcntNm},
               #{aplcntMoblphon},
               #{aplcntEml},
               #{nopeAdult},
               #{nopeChil},
               #{nopeInfnt},
               #{utztnPrps},
               #{amt},
               #{dpstBacnt},
               #{pyrNm},
               #{aplyDt},
               '160101',
               '161101',
               ,NOW()
               ,#{user.userid}
               ,NOW()
               ,#{user.userid}
               )
    </insert>-->

    <!-- 공간 예약 여부 확인 목록 -->
    <select id="selectFclRsvtdeList" resultType="map">
        /* SpceDao.selectFclRsvtdeList */
        SELECT RSVTDEID,
        SPCEID,
        DE,
        AMT,
        RSVT_PSBLTY_YN
        FROM TB_FCL_SPCE_RSVTDE A
        WHERE 1 = 1
        AND A.RSVTDEID IN (
        <foreach item="item" collection="rsvtdeid"  separator=",">
            #{item.rsvtdeid}
        </foreach>
        )
    </select>
</mapper>