<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : DelvryDaoImpl.xml
	Description : 마이페이지 > 체험환경 > 교부신청
-->
<mapper namespace="com.kbrainc.plum.front.delvry.model.DelvryDao">
    
    <!-- 교부신청 목록 조회 -->
    <select id="selectDelvryAplyList" parameterType="front.DelvryAplyVo" resultType="front.DelvryAplyVo">
        /* DelvryDao.selectDelvryAplyList */
        <include refid="PaginationMapper.header"/>
        SELECT 
            TSA.PCNTSTID 
            , TSP.FLD_CD
            , TCC.CD_NM AS FLD_NM
            , APLYNO
            , PRGRM_NM
            , IF(TSDA.DELVRY_APLYID IS NULL, '202100', TSDA.DELVRY_STTS_CD) AS DELVRY_STTS_CD 
            , IF(TSDA.DELVRY_APLYID IS NULL, '신청전', TCC2.CD_NM) AS DELVRY_STTS_NM
            , TSD.CYCL 
            , CONCAT(DATE_FORMAT(TSD.DELVRY_APLY_BGNG_DT, '%Y-%m-%d %H:%i'), '<![CDATA[<br class="pc-only"> ]]>~ ', DATE_FORMAT(TSD.DELVRY_APLY_END_DT, '%Y-%m-%d %H:%i')) AS DELVRY_APLY_DT   
            , CONCAT(DATE_FORMAT(TSD.DELVRY_CFMTN_PRSNTN_BGNG_DT, '%Y-%m-%d %H:%i'), '<![CDATA[<br class="pc-only"> ]]>~ ', DATE_FORMAT(TSD.DELVRY_CFMTN_PRSNTN_END_DT, '%Y-%m-%d %H:%i')) AS DELVRY_CFMTN_PRSNTN_DT
            , CONCAT(TSP.BSNS_BGNG_DE, ' ~ ', TSP.BSNS_END_DE) AS BSNS_DE
            , TSDA.DELVRY_APLYID 
            , CASE WHEN TSDA.DELVRY_APLYID IS NULL AND NOW() <![CDATA[>]]> TSD.DELVRY_APLY_BGNG_DT AND NOW() <![CDATA[<]]> TSD.DELVRY_APLY_END_DT THEN 'C'  -- 신청버튼
                WHEN TSDA.DELVRY_STTS_CD IN ('202101','202103','202104') AND TSDA.DELVRY_APLYID IS NOT NULL AND NOW() <![CDATA[>]]> TSD.DELVRY_APLY_BGNG_DT AND NOW() <![CDATA[<]]> TSD.DELVRY_APLY_END_DT THEN 'U'
                WHEN TSDA.DELVRY_APLYID IS NOT NULL THEN 'R'
                ELSE '-' END AS CRUD_BTN
            , (SELECT MAX(SPLMNTID) FROM TB_SPB_DELVRY_APLY_SPLMNT TSDAS WHERE TSDAS.DELVRY_APLYID = TSDA.DELVRY_APLYID) AS SPLMNTID
            , TSA.USERID
            , TSA.APLCNT_NM
            , IF(TSA.INST_NM IS NULL, NULL, TSA.INSTID) AS INSTID
            , TSA.INST_NM 
            , TSA.APLYID
            , TSD.DELVRYID
            , TSDA.TOT_AMT
            , BANK_CD
            , BACNTNO
            , DPSTR_NM
            , TSDA.ATCH_FILEGRPID
            , TSA.REG_DT 
            , TSA.MDFCN_DT 
        FROM 
            TB_SPB_PCNTST TSP 
            INNER JOIN TB_SPB_APLY TSA ON TSP.PCNTSTID = TSA.PCNTSTID
            INNER JOIN TB_SPB_DELVRY TSD ON TSA.PCNTSTID = TSD.PCNTSTID  
            LEFT OUTER JOIN TB_SPB_DELVRY_APLY TSDA ON TSD.DELVRYID = TSDA.DELVRYID AND TSDA.APLYID = TSA.APLYID
            LEFT OUTER JOIN TB_CMM_CD TCC ON TSP.FLD_CD = TCC.CD
            LEFT OUTER JOIN TB_CMM_CD TCC2 ON TSDA.DELVRY_STTS_CD = TCC2.CD
        WHERE TSA.USERID = #{user.userid}
        <if test="user.loginUserType == 'P'.toString()">
        AND TSP.FLD_CD IN ('173105','173106')
        </if>
        <if test="user.loginUserType == 'I'.toString()">
        AND TSP.FLD_CD NOT IN ('173105','173106')
        </if>
        <if test="delvryid != null and delvryid != ''">
            AND TSD.DELVRYID = #{delvryid}
        </if>
        <if test="searchFldCd != null and searchFldCd != ''">
            AND TSP.FLD_CD = #{searchFldCd}
        </if>
        <if test="searchPcntstNm != null and searchPcntstNm != ''">
            AND TSP.PCNTST_NM LIKE CONCAT('%',#{searchPcntstNm},'%')
        </if>
        <if test="searchPrgrmNm != null and searchPrgrmNm != ''">
            AND PRGRM_NM LIKE CONCAT('%',#{searchPrgrmNm},'%')
        </if>
        <if test="searchDelvrySttsCd != null and searchDelvrySttsCd != ''">
            AND IF(TSDA.DELVRY_APLYID IS NULL, '202100', TSDA.DELVRY_STTS_CD) = #{searchDelvrySttsCd}
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 교부신청 -->
    <insert id="insertDelvryAply" parameterType="front.DelvryAplyVo" useGeneratedKeys="true" keyProperty="delvryAplyid">
        /* DelvryDao.insertDelvryAply */
        INSERT INTO TB_SPB_DELVRY_APLY (
            APLYID
            , DELVRYID
            , RCPTNO
            , INSTID
            , USERID
            , APLCNT_NM
            , TOT_AMT
            , BANK_CD
            , BACNTNO
            , DPSTR_NM
            , ATCH_FILEGRPID
            , DELVRY_STTS_CD
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{aplyid}
            , #{delvryid}
            , #{rcptno}
            , #{instid}
            , #{userid}
            , #{aplcntNm}
            , #{totAmt}
            , #{bankCd}
            , #{bacntno}
            , #{dpstrNm}
            , #{atchFilegrpid}
            , '202101'
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 교부신청정보 수정 -->
    <update id="updateDelvryAply" parameterType="front.DelvryAplyVo" >
        /* DelvryDao.updateDelvryAply */
        UPDATE TB_SPB_DELVRY_APLY SET
            TOT_AMT = #{totAmt}
            , BANK_CD = #{bankCd}
            , BACNTNO = #{bacntno}
            , DPSTR_NM = #{dpstrNm}
            , ATCH_FILEGRPID = #{atchFilegrpid}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE 
            DELVRY_APLYID = #{delvryAplyid}
    </update>
    
    <!-- 산출내역 목록 조회 -->
    <select id="selectDelvryAplyComputList" parameterType="front.DelvryAplyVo" resultType="front.DelvryAplyComputVo">
        /* DelvryDao.selectDelvryAplyComputList */
        WITH T AS (
            SELECT
                COMPUTID
                , EXPITM_CD
                , AMT
                , CN
                , ORDR
                , MDFCN_DT
                , MDFRID
                , REG_DT
                , RGTRID
                , DELVRY_APLYID
            FROM
                TB_SPB_DELVRY_APLY_COMPUT
            WHERE DELVRY_APLYID = #{delvryAplyid}
        )
        SELECT 
            T.*
            , ROW_NUMBER() OVER (PARTITION BY TCC.CD_NM ORDER BY TCC.ORD, B.CD) AS GROUP_NUM
            , COUNT(B.CD) OVER (PARTITION BY TCC.CD_NM)*2 AS ROWSPAN
            , B.CD AS CODE
            , TCC.CD_NM AS EXPITM_UPPR_NM
            , B.CD_NM  AS EXPITM_NM
        FROM TB_CMM_CD B
            LEFT OUTER JOIN T ON T.EXPITM_CD = B.CD 
            INNER JOIN TB_CMM_CD TCC ON TCC.CD = B.UPPR_CD 
        WHERE 1 = 1 
        AND B.CDGRPID = '218'
        <choose>
            <when test="fldCd == '173106'"><!-- 그린캠퍼스 -->
        AND B.UPPR_CD = '218301'
            </when>
            <when test="fldCd == '173105'"><!-- 교사학습공동체 -->
        AND B.UPPR_CD = '218401'
            </when>
            <when test="fldCd == '173104'"><!-- 환경동아리 -->
        AND B.UPPR_CD = '218201'
            </when>
            <when test="fldCd == '173107'"><!-- 환경교육 우수학교 -->
        AND B.UPPR_CD = '218501'
            </when>
            <otherwise><!-- 생애주기, 종교인, 학습공동체 -->
        AND B.UPPR_CD IN ('218101','218121','218141')
            </otherwise>
        </choose>
        ORDER BY 
            TCC.ORD
            , B.CD
    </select>
    
    <!-- 산출내역 등록 -->
    <insert id="insertDelvryAplyComput" parameterType="front.DelvryAplyComputVo" useGeneratedKeys="true" keyProperty="computid">
        /* DelvryDao.insertDelvryAplyComput */
        INSERT INTO TB_SPB_DELVRY_APLY_COMPUT (
            EXPITM_CD
            , AMT
            , CN
            , ORDR
            , DELVRY_APLYID
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{expitmCd}
            , #{amt}
            , #{cn}
            , #{ordr}
            , #{delvryAplyid}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 산출내역 업데이트 -->
    <update id="updateDelvryAplyComput" parameterType="front.DelvryAplyComputVo">
        /* DelvryDao.updateDelvryAplyComput */
        UPDATE TB_SPB_DELVRY_APLY_COMPUT SET
            AMT = #{amt}
            , CN = #{cn}
            , ORDR = #{ordr}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE 
            COMPUTID = #{computid}
    </update>
    
    <!--  보완요청 상세 조회-->
    <select id="selectDelvryAplySplmntInfo" parameterType="front.SupplementVo" resultType="front.SupplementVo">
        /* DelvryDao.selectDelvryAplySplmntInfo */
        SELECT
            SPLMNTID
            , DELVRY_APLYID AS APLYID 
            , DMND_CN
            , ANS_STTS_CD
            , ANS_CN
        FROM
            TB_SPB_DELVRY_APLY_SPLMNT
        WHERE
            SPLMNTID = #{splmntid}
    </select>
    
    <!-- 보완요청 업데이트 -->
    <update id="updateDelvryAplySplmnt" parameterType="front.SupplementVo">
        /* DelvryDao.updateDelvryAplySplmnt */
        UPDATE TB_SPB_DELVRY_APLY_SPLMNT SET
            ANS_CN = #{ansCn}
            , ANS_STTS_CD = '201102'
            , ANSWRRID = #{user.userid}
            , ANS_DT = NOW()
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE 
            SPLMNTID = #{splmntid}
    </update>
    
    <!-- 교부신청정보 보완완료 상태 업데이트 -->
    <update id="updateDelvryAplyStts" parameterType="front.DelvryAplyVo">
        /* DelvryDao.updateDelvryAply */
        UPDATE TB_SPB_DELVRY_APLY SET
            DELVRY_STTS_CD = '202104'
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE 
            DELVRY_APLYID = #{aplyid}
    </update>
    
</mapper>