<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : SrvyDaoImpl.xml
	Description : 설문조사
-->
<mapper namespace="com.kbrainc.plum.front.srvy.model.SrvyDao">
    
    <!-- 설문 목록 조회 -->
    <select id="selectSrvyList" parameterType="front.SrvyVo" resultType="front.SrvyVo">
        /* SrvyDao.selectSrvyList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.SRVYID
            , A.QESTNRID
            , A.SRVY_NM
            , A.BGNG_DE
            , A.END_DE
            , CASE WHEN F.SBMSNID IS NOT NULL THEN '설문확인' WHEN NOW() > A.END_DE THEN '기간종료' ELSE '설문참여' END AS STTS_NM
            , C.USERID
            , A.REG_DT
            , F.SBMSN_DT
        FROM
            TB_CMM_SRVY A
        LEFT OUTER JOIN
            TB_CMM_QESTNR B ON (B.QESTNRID = A.QESTNRID)
        LEFT OUTER JOIN
            TB_CMM_SRVY_USER C ON (C.SRVYID = A.SRVYID)
        LEFT OUTER JOIN
            TB_CMM_SRVY_INST D ON (D.SRVYID = A.SRVYID)
        LEFT OUTER JOIN
            TB_CMM_SRVY_SITE E ON (E.SRVYID = A.SRVYID)
        LEFT OUTER JOIN
            TB_CMM_SRVY_SBMSN F ON (F.SRVYID = A.SRVYID AND F.USERID = #{user.userid})
        WHERE 
            B.QESTNR_KND_CD IN ('110100', '110101', '110107')
            AND A.USE_YN = 'Y'
            AND NOW() >= A.BGNG_DE
            AND (C.USERID = #{user.userid} OR D.INSTID = #{user.instid} OR E.SITEID = #{siteid})
        GROUP BY
            A.SRVYID
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 설문 참여이력 목록 조회 -->
    <select id="selectSrvyHstryList" parameterType="front.SrvyVo" resultType="front.SrvyVo">
        /* SrvyDao.selectSrvyHstryList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.SRVYID
            , A.QESTNRID
            , A.SRVY_NM
            , A.BGNG_DE
            , A.END_DE
            , CASE WHEN F.SBMSNID IS NOT NULL THEN '설문확인' WHEN NOW() > A.END_DE THEN '기간종료' ELSE '설문참여' END AS STTS_NM
            , '일반' AS SRVY_CTGRY
            , A.REG_DT
            , F.SBMSN_DT
            , F.SBMSNID
        FROM
            TB_CMM_SRVY A
        LEFT OUTER JOIN
            TB_CMM_QESTNR B ON (B.QESTNRID = A.QESTNRID)
        LEFT OUTER JOIN
            TB_CMM_SRVY_USER C ON (C.SRVYID = A.SRVYID)
        LEFT OUTER JOIN
            TB_CMM_SRVY_INST D ON (D.SRVYID = A.SRVYID)
        LEFT OUTER JOIN
            TB_CMM_SRVY_SITE E ON (E.SRVYID = A.SRVYID)
        LEFT OUTER JOIN
            TB_CMM_SRVY_SBMSN F ON (F.SRVYID = A.SRVYID AND F.USERID = #{user.userid})
        WHERE
            B.QESTNR_KND_CD IN ('110100', '110101', '110107')
            AND A.USE_YN = 'Y'
            AND NOW() >= A.BGNG_DE
            AND (C.USERID = #{user.userid} OR D.INSTID = #{user.instid} OR E.SITEID = #{siteid})
        GROUP BY
            A.SRVYID
        UNION ALL
        SELECT
            E.SRVYID
            , F.QESTNRID
            , E.SRVY_NM
            , E.BGNG_DE
            , E.END_DE
            , CASE WHEN G.SBMSNID IS NOT NULL THEN '설문확인' WHEN NOW() > E.END_DE THEN '기간종료' ELSE '설문참여' END AS STTS_NM
            , '유아' AS SRVY_CTGRY
            , E.REG_DT
            , G.SBMSN_DT
            , G.SBMSNID
        FROM
            TB_EDU_INFNT_PRGRM_APLY A
        LEFT OUTER JOIN
            TB_EDU_INFNT_PRGRM_TME_SCHDL B ON (B.TME_SCHDLID = A.TME_SCHDLID)
        LEFT OUTER JOIN
            TB_EDU_INFNT_PRGRM_TME C ON (C.TMEID = B.TMEID)
        LEFT OUTER JOIN
            TB_EDU_INFNT_PRGRM D ON (D.PRGRMID = C.PRGRMID)
        LEFT OUTER JOIN
            TB_CMM_SRVY E ON (E.SRVYID = D.APLCNT_DGSTFN_SRVYID)
        LEFT OUTER JOIN
            TB_CMM_QESTNR F ON (F.QESTNRID = E.QESTNRID)
        LEFT OUTER JOIN
            TB_CMM_SRVY_SBMSN G ON (G.SRVYID = E.SRVYID AND G.USERID = #{user.userid})
        WHERE
            A.USERID = #{user.userid}
            AND G.SBMSNID IS NOT NULL
        GROUP BY
            E.SRVYID
        UNION ALL
        SELECT
            F.SRVYID
            , G.QESTNRID
            , F.SRVY_NM
            , F.BGNG_DE
            , F.END_DE
            , CASE WHEN H.SBMSNID IS NOT NULL THEN '설문확인' WHEN NOW() > F.END_DE THEN '기간종료' ELSE '설문참여' END AS STTS_NM
            , '푸름이' AS SRVY_CTGRY
            , E.REG_DT
            , H.SBMSN_DT
            , H.SBMSNID
        FROM
            TB_EDU_MVMN_PRGRM_APLY A
        LEFT OUTER JOIN
            TB_EDU_MVMN_PRGRM_APLY_SCHDL B ON (B.APLYID = A.APLYID)
        LEFT OUTER JOIN
            TB_EDU_MVMN_PRGRM_TME_SCHDL C ON (C.TME_SCHDLID = B.TME_SCHDLID)
        LEFT OUTER JOIN
            TB_EDU_MVMN_PRGRM_TME D ON (D.TMEID = C.TMEID)
        LEFT OUTER JOIN
            TB_EDU_MVMN_PRGRM E ON (E.PRGRMID = D.PRGRMID)
        LEFT OUTER JOIN
            TB_CMM_SRVY F ON (F.SRVYID = E.APLCNT_DGSTFN_SRVYID)
        LEFT OUTER JOIN
            TB_CMM_QESTNR G ON (G.QESTNRID = F.QESTNRID)
        LEFT OUTER JOIN
            TB_CMM_SRVY_SBMSN H ON (H.SRVYID = F.SRVYID AND H.USERID = #{user.userid})
        WHERE
            A.USERID = #{user.userid}
            AND H.SBMSNID IS NOT NULL
        GROUP BY
            F.SRVYID
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 설문 정보 조회 -->
    <select id="selectSrvyInfo" parameterType="front.SrvyVo" resultType="front.SrvyVo">
        /* SrvyDao.selectSrvyInfo */
        SELECT
            A.SRVYID
            , A.SRVY_NM
            , A.EXPLN
            <if test="user != null">
            , B.SBMSN_DT
            </if>
            <if test="sbmsnid != 0 and ((infntPrgrmAplyid != null and infntPrgrmAplyid != 0) or (mvmnPrgrmAplyid != null or mvmnPrgrmAplyid != 0))">
            , DATE_FORMAT(MAX(D.SBMSN_DT), '%Y-%m-%d') AS APLY_SBMSN_DT
            , D.PRTPNT_NM
            , C.QESTNR_KND_CD
            </if>
        FROM
            TB_CMM_SRVY A
        <if test="user != null">  
        LEFT OUTER JOIN TB_CMM_QESTNR C ON A.QESTNRID = C.QESTNRID
        LEFT OUTER JOIN
            TB_CMM_SRVY_SBMSN B ON (B.SRVYID = A.SRVYID AND B.USERID = #{user.userid})
        </if>
        <if test="sbmsnid != 0 and ((infntPrgrmAplyid != null and infntPrgrmAplyid != 0) or (mvmnPrgrmAplyid != null or mvmnPrgrmAplyid != 0))">
        LEFT OUTER JOIN TB_CMM_SRVY_SBMSN D ON D.SRVYID = A.SRVYID AND D.SBMSNID = #{sbmsnid} 
        </if>        
        WHERE 
            A.SRVYID = #{srvyid}
        GROUP BY 
            A.SRVYID 
    </select>
    
    <!-- 설문 문항 목록 조회 -->
    <select id="selectQitemList" parameterType="front.SrvyVo" resultType="QitemVo">
        /* SrvyDao.selectQitemList */
        SELECT
            A.QITEMID
            , A.QESTNRID
            , A.QITEM_TYPE_CD
            , A.CN
            , A.EX_CNT
        FROM
            TB_CMM_QESTNR_QITEM A
        WHERE
            A.USE_YN = 'Y'
            AND A.QESTNRID = #{qestnrid}
        ORDER BY
            A.ORDR
    </select>
    
    <!-- 설문 답변 목록 조회 -->
    <select id="selectAnsList" parameterType="front.SrvyVo" resultType="QitemVo">
        /* SrvyDao.selectAnsList */
        SELECT
            A.QITEMID
            , A.QESTNRID
            , A.QITEM_TYPE_CD
            , A.CN
            , A.EX_CNT
            , C.ANS
            , C.ANS_DSCRP
            , C.SCALE
            , C.SCR
        FROM
            TB_CMM_QESTNR_QITEM A
        LEFT OUTER JOIN
            TB_CMM_SRVY_SBMSN B ON (B.SRVYID = #{srvyid})
        LEFT OUTER JOIN
            TB_CMM_SRVY_SBMSN_ANS C ON (C.SBMSNID = B.SBMSNID AND C.QITEMID = A.QITEMID)
        WHERE
            A.USE_YN = 'Y'
            AND A.QESTNRID = #{qestnrid}
            <if test="(infntPrgrmAplyid == null or infntPrgrmAplyid == 0) and (mvmnPrgrmAplyid == null or mvmnPrgrmAplyid == 0)">
            AND B.USERID = #{user.userid}
            </if>
            AND B.SBMSNID = #{sbmsnid}
        ORDER BY
            A.ORDR
    </select>
    
    <!-- 설문 문항 보기 목록 조회 -->
    <select id="selectExList" parameterType="QitemVo" resultType="QitemExVo">
        /* SrvyDao.selectExList */
        SELECT
            A.EXID
            , A.QITEMID
            , A.EX_NO
            , A.CN
            , A.SCR
            , A.ETC_YN
        FROM
            TB_CMM_QESTNR_QITEM_EX A
        WHERE
            A.QITEMID = #{qitemid}
        ORDER BY
            A.EX_NO
    </select>
    
    <!-- 설문 제출 정보 등록 -->
    <insert id="insertSrvySbmsn" parameterType="front.SrvySbmsnVo" useGeneratedKeys="true" keyProperty="sbmsnid">
        /* SrvyDao.insertSrvySbmsn */
        INSERT INTO TB_CMM_SRVY_SBMSN (
            SRVYID
            , USERID
            , INSTID
            , APFEX_DT
            , SBMSN_DT
            , USER_IP
            , BRWSR_NM
            , DEVICE_KND_CD
            , INFNT_PRGRM_APLYID
            , MVMN_PRGRM_APLYID
            , PRTPNT_NM
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{srvyid}
            , #{user.userid}
            , #{user.instid}
            , NOW()
            , NOW()
            , #{userIp}
            , #{brwsrNm}
            , #{deviceKndCd}
            , #{infntPrgrmAplyid}
            , #{mvmnPrgrmAplyid}
            , #{prtpntNm}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 설문 답변 정보 등록 -->
    <insert id="insertSrvySbmsnAns" parameterType="front.SrvySbmsnAnsVo">
        /* SrvyDao.insertSrvySbmsnAns */
        INSERT INTO TB_CMM_SRVY_SBMSN_ANS (
            SBMSNID
            , QITEMID
            , ANS
            , ANS_DSCRP
            <if test="scale != null and scale != 0">
            , SCALE
            </if>
            <if test="scr != null and scr != 0">
            , SCR
            </if>
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{sbmsnid}
            , #{qitemid}
            , #{ans}
            , #{ansDscrp}
            <if test="scale != null and scale != 0">
            , #{scale}
            </if>
            <if test="scr != null and scr != 0">
            , #{scr}
            </if>
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
</mapper>