<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : InqryDaoImpl.xml
    Description : 1:1문의 관리
-->
<mapper namespace="com.kbrainc.plum.front.inqry.model.InqryDao">
    <!-- 1:1문의 생성 -->
    <insert id="insertInqry">
        INSERT INTO TB_CMM_INQRY(
            SITEID
            , TITLE
            , CNTNTS
            , FILEGRPID
            , INQRY_CL_CD
            , STTS_CD
            , USERID
            , INSTID
            , RLS_YN
            , DEL_YN
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
             ) VALUES (
            #{site.siteid}
            , #{title}
            , #{cntnts}
            , #{filegrpid}
            , #{inqryClCd}
            , '103101'
            , #{user.userid}
            , #{user.instid}
            , #{rlsYn}
            , 'N'
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
             )
    </insert>

    <!-- 1:1문의 수정 -->
    <update id="updateInqry">
        UPDATE TB_CMM_INQRY SET
            TITLE = #{title}
            , CNTNTS = #{cntnts}
            , FILEGRPID = #{filegrpid}
            , INQRY_CL_CD = #{inqryClCd}
            , RLS_YN = #{rlsYn}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE INQRYID = #{inqryid}
    </update>

    <!-- 1:1문의 삭제 -->
    <update id="deleteInqry">
        UPDATE TB_CMM_INQRY SET
            DEL_YN = 'Y'
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE INQRYID = #{inqryid}
    </update>

    <!-- 1:1문의 취소 -->
    <update id="cancelInqry">
        UPDATE TB_CMM_INQRY SET
            STTS_CD = '103102'
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE INQRYID = #{inqryid}
    </update>

    <!-- 1:1문의 목록 조회 -->
    <select id="selectInqryList" resultType="front.InqryVo">
        <include refid="PaginationMapper.header"/>
        SELECT
            A.INQRYID
            , A.SITEID
            , A.USERID
            , A.TITLE
            , A.CNTNTS
            , B.NM
            , A.FILEGRPID
            , A.INQRY_CL_CD
            , A.STTS_CD
            , A.RLS_YN
            , A.REG_DT
        FROM TB_CMM_INQRY A
        INNER JOIN TB_CMM_USER B
            ON A.USERID = B.USERID
        WHERE
            A.DEL_YN = 'N' AND A.STTS_CD != '103102'
            <if test="searchKeyword != null and searchKeyword!= ''">
                AND A.TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>
            <if test="inqryClCd != null and inqryClCd != ''">
                AND A.INQRY_CL_CD = #{inqryClCd}
            </if>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 1:1문의 상세 조회 -->
    <select id="selectInqry" resultType="front.InqryVo">
        SELECT
            A.INQRYID
             , A.SITEID
             , A.USERID
             , A.TITLE
             , A.CNTNTS
             , B.NM
             , A.FILEGRPID
             , A.INQRY_CL_CD
             , A.STTS_CD
             , A.RLS_YN
             , A.REG_DT
        FROM TB_CMM_INQRY A
        INNER JOIN TB_CMM_USER B
            ON A.USERID = B.USERID
        WHERE INQRYID = #{inqryid}
    </select>

    <!-- 1:1문의 답변 조회 -->
    <select id="selectInqryAns" resultType="com.kbrainc.plum.front.inqry.model.InqryAnsVo">
        SELECT
            A.ANSWRID
            , A.INQRYID
            , A.TITLE
            , A.CNTNTS
            , A.OPETRID
            , A.FILEGRPID
            , A.ANS_DE
            , C.NM
            FROM TB_CMM_INQRY_ANSWR A
            INNER JOIN TB_CMM_INQRY B
                ON A.INQRYID = B.INQRYID
            INNER JOIN TB_CMM_USER C
                ON A.OPETRID = C.USERID
            WHERE A.INQRYID = #{inqryid}
    </select>

    <!-- 마이페이지 > 1:1문의 목록 조회 -->
    <select id="selectMypageInqryList" resultType="front.InqryVo">
        <include refid="PaginationMapper.header"/>
        SELECT
            A.INQRYID
            , A.SITEID
            , A.USERID
            , A.TITLE
            , A.CNTNTS
            , B.NM
            , A.FILEGRPID
            , A.INQRY_CL_CD
            , A.STTS_CD
            , A.RLS_YN
            , A.REG_DT
        FROM TB_CMM_INQRY A
        INNER JOIN TB_CMM_USER B
            ON A.USERID = B.USERID
        WHERE
            A.DEL_YN = 'N'
            AND A.USERID = #{user.userid}
        <if test="searchKeyword != null and searchKeyword!= ''">
            AND A.TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>
</mapper>