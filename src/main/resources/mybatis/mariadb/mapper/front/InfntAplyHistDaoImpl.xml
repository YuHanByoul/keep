<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : InfntAplyHistDaoImpl.xml
    Description : 유아환경교육관 교육신청
-->
<mapper namespace="com.kbrainc.plum.front.mypage.infntAplyHist.model.InfntAplyHistDao">
    <!-- 유아환경교육관 신청이력 조회 -->
    <select id="selectInfntAplyHistList" parameterType="front.InfntAplyHistVo" resultType="front.InfntAplyHistVo">
        /* InfntAplyHistDao.selectInfntAplyHistList */
        <include refid="PaginationMapper.header"/>
            SELECT
                  A.APLYID 
                , A.TME_SCHDLID  
                , D.PRGRMID
                , E.CLSSRMID
                , E.CLSSRM_NM
                , D.PRGRM_NM
                , D.EDU_NOPE
                , D.EDU_HR_MNT
                , (SELECT GROUP_CONCAT(TB.CD_NM SEPARATOR',') FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG TA, TB_CMM_CD TB WHERE TA.PRGRMID = D.PRGRMID and TA.TRGT_CD = TB.CD) AS TRGT_NM
                , F.CD_NM CTPRVN_NM
                , REPLACE(B.DE, '.', '-') DE
                , C.TMEID
                , C.TME_NM
                , A.STTS_CD
                , G.CD_NM STTS_NM
                , D.APLCNT_DGSTFN_SRVYID
                , D.STDNT_DGSTFN_SRVYID
                , H.QESTNRID APLCNT_DGSTFN_QESTNRID
                , I.QESTNRID STDNT_DGSTFN_QESTNRID
                , J.SBMSNID
                , CASE WHEN J.SBMSN_DT IS NULL THEN 'N' ELSE 'Y' END SBMSN_YN 
                , DATE_FORMAT(A.REG_DT, '%Y-%m-%d') REG_DT
                , A.RGTRID
            FROM TB_EDU_INFNT_PRGRM_APLY A
            LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TME_SCHDL B ON B.TME_SCHDLID = A.TME_SCHDLID
            LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TME C ON C.TMEID = B.TMEID
            LEFT OUTER JOIN TB_EDU_INFNT_PRGRM D ON D.PRGRMID = C.PRGRMID
            LEFT OUTER JOIN TB_EDU_CLSSRM E ON E.CLSSRMID = D.CLSSRMID
            LEFT OUTER JOIN TB_CMM_CD F ON F.CD = E.CTPRVN_CD
            LEFT OUTER JOIN TB_CMM_CD G ON G.CD = A.STTS_CD
            LEFT OUTER JOIN TB_CMM_SRVY H ON H.SRVYID = D.APLCNT_DGSTFN_SRVYID
            LEFT OUTER JOIN TB_CMM_SRVY I ON I.SRVYID = D.STDNT_DGSTFN_SRVYID
            LEFT OUTER JOIN (SELECT SRVYID, SBMSNID, INFNT_PRGRM_APLYID, MAX(SBMSN_DT) SBMSN_DT FROM TB_CMM_SRVY_SBMSN GROUP BY SRVYID, INFNT_PRGRM_APLYID) J ON J.SRVYID = D.APLCNT_DGSTFN_SRVYID AND J.INFNT_PRGRM_APLYID = A.APLYID
            WHERE 1=1
            AND A.USERID = #{user.userid}
            <!-- 유아환경교육관 교육신청 프로그램명 -->
            <if test="searchType != null and searchType == 'searchPrgrmNm' ">
            AND D.PRGRM_NM LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>         
            <!-- 유아환경교육관 교육신청 프로그램명 -->
            <if test="searchType != null and searchType == 'searchEduClssRmNm' ">
            AND E.CLSSRM_NM LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>         
        <include refid="PaginationMapper.footer"/>
    </select>    

    <!-- 유아환경교육관 신청이력 정보 조회 -->
    <select id="selectInfntAplyHistInfo" parameterType="front.InfntAplyHistVo" resultType="front.InfntAplyHistVo">
        /* InfntAplyHistDao.selectInfntAplyHistInfo */
            SELECT
                  A.APLYID 
                , D.PRGRMID
                , E.CLSSRMID
                , E.CLSSRM_NM
                , D.PRGRM_NM
                , D.EDU_NOPE
                , D.EDU_HR_MNT
                , (SELECT GROUP_CONCAT(TC.TRGT_CD SEPARATOR',') FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG TC WHERE TC.PRGRMID = D.PRGRMID) AS TRGT_CD
                , (SELECT GROUP_CONCAT(TB.CD_NM SEPARATOR',') FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG TA, TB_CMM_CD TB WHERE TA.PRGRMID = D.PRGRMID and TA.TRGT_CD = TB.CD) AS TRGT_NM
                , F.CD_NM CTPRVN_NM
                , REPLACE(B.DE, '.', '-') DE
                , C.TMEID
                , C.TME_NM
                , A.STTS_CD
                , G.CD_NM STTS_NM
                , D.APLCNT_DGSTFN_SRVYID
                , D.STDNT_DGSTFN_SRVYID
                , H.QESTNRID APLCNT_DGSTFN_QESTNRID
                , I.QESTNRID STDNT_DGSTFN_QESTNRID
                , J.SBMSNID
                , CASE WHEN J.SBMSN_DT IS NULL THEN 'N' ELSE 'Y' END SBMSN_YN
                , DATE_FORMAT(A.REG_DT, '%Y-%m-%d') REG_DT
                , A.RGTRID
            FROM TB_EDU_INFNT_PRGRM_APLY A
            LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TME_SCHDL B ON B.TME_SCHDLID = A.TME_SCHDLID
            LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TME C ON C.TMEID = B.TMEID
            LEFT OUTER JOIN TB_EDU_INFNT_PRGRM D ON D.PRGRMID = C.PRGRMID
            LEFT OUTER JOIN TB_EDU_CLSSRM E ON E.CLSSRMID = D.CLSSRMID
            LEFT OUTER JOIN TB_CMM_CD F ON F.CD = E.CTPRVN_CD
            LEFT OUTER JOIN TB_CMM_CD G ON G.CD = A.STTS_CD
            LEFT OUTER JOIN TB_CMM_SRVY H ON H.SRVYID = D.APLCNT_DGSTFN_SRVYID
            LEFT OUTER JOIN TB_CMM_SRVY I ON I.SRVYID = D.STDNT_DGSTFN_SRVYID
            LEFT OUTER JOIN (SELECT SRVYID, SBMSNID, INFNT_PRGRM_APLYID, MAX(SBMSN_DT) SBMSN_DT FROM TB_CMM_SRVY_SBMSN GROUP BY SRVYID, INFNT_PRGRM_APLYID) J ON J.SRVYID = D.APLCNT_DGSTFN_SRVYID AND J.INFNT_PRGRM_APLYID = A.APLYID            
            WHERE 1=1
            AND A.APLYID = #{aplyid}   
            AND A.TME_SCHDLID = #{tmeSchdlid}     
    </select>    

    <!-- 유아환경교육관 신청이력 상세 조회 -->
    <select id="selectInfntAplyHistDetail" parameterType="front.InfntAplyHistVo" resultType="front.InfntAplyHistVo">
        /* InfntAplyHistDao.selectInfntAplyHistDetail */
        SELECT
            A.APLYID
          , A.TME_SCHDLID
          , B.DE
          , C.TMEID
          , C.TME_NM
          , A.REG_DT AS APLY_DT
          , A.INSTID
          , NULLIF(E.INST_NM, '') INST_NM
          , NULLIF(A.USERID, '') APLY_USERID
          , NULLIF(F.NM, '') APLY_USER_NM
          , NULLIF(A.ADDR, '') ADDR
          , NULLIF(A.ADDR_DTL, '') ADDR_DTL
          , NULLIF(A.CTPRVN_CD, '') CTPRVN_CD
          , NULLIF(A.TELNO, '') TELNO
          , NULLIF(A.MOBLPHON, '') MOBLPHON
          , NULLIF(A.EML, '') EML
          , A.EDU_NOPE
          , A.TCHER_NOPE
          , NULLIF(A.ETC, '') ETC
          , A.TOWWAY_ONLN_EDU_AGRE_YN
          , A.STTS_CD
          , D.CD_NM AS STTS_NM
          , (
            SELECT GROUP_CONCAT(CD SEPARATOR ',')
            FROM tb_cmm_cd
            WHERE CDGRPID = 162
            ) AS CD
          , (
            SELECT GROUP_CONCAT(CD_NM SEPARATOR ',')
            FROM tb_cmm_cd
            WHERE CDGRPID = 162
            ) AS CD_NM
            SELECT
                GROUP_CONCAT(TB.CD_NM SEPARATOR ', ')
            FROM
                TB_EDU_INFNT_PRGRM_APLY_EDU_TRGT TA
              , TB_CMM_CD TB
            WHERE
                  TA.APLYID = 47
              and TA.EDU_TRGT_CD = TB.CD
            ) AS TRGT_NM
          , A.MDFCN_DT
          , A.MDFRID
          , A.REG_DT
          , A.RGTRID
        FROM
            TB_EDU_INFNT_PRGRM_APLY A
                LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TME_SCHDL B ON B.TME_SCHDLID = A.TME_SCHDLID
                LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TME C ON C.TMEID = B.TMEID
                LEFT OUTER JOIN TB_CMM_CD D ON D.CD = A.STTS_CD
                LEFT OUTER JOIN TB_CMM_INST E ON E.INSTID = A.INSTID
                LEFT OUTER JOIN TB_CMM_USER F ON F.USERID = A.USERID
        WHERE   
            A.APLYID = #{aplyid}
        AND A.TME_SCHDLID = #{tmeSchdlid}
    </select>
        
    <!-- 유아환경교육관 신청취소 -->
    <update id="updateSttsInfntAply" parameterType="front.InfntAplyHistVo">
        /* InfntAplyHistDao.updateCancelInfntAply */
        UPDATE TB_EDU_INFNT_PRGRM_APLY SET
            STTS_CD = #{updCd}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE APLYID = #{aplyid}
    </update>    
    
    <!-- 유아환경교육관 설문 정보 조회 -->
    <select id="selectInfntSrvyInfo" parameterType="front.SrvyVo" resultType="front.SrvyVo">
        /* InfntAplyHistDao.selectInfntSrvyInfo */
        SELECT
            A.SRVYID
            , A.QESTNRID
            , A.SRVY_NM
            , A.SRVY_PRD_CD
            , A.BGNG_DE
            , A.END_DE
            , A.USE_YN
        FROM
            TB_CMM_SRVY A
        WHERE 
            SRVYID = #{srvyid}
    </select>

    <!-- 유아환경교육관 설문 정보 조회 -->
    <select id="selectInfntSrvySendList" parameterType="front.SrvyVo" resultType="front.SrvyVo">
        /* InfntAplyHistDao.selectInfntSrvySendList */
        SELECT
            A.SBMSNID
            , A.SITEID
            , A.SRVYID
            , B.QESTNRID
            , A.INFNT_PRGRM_APLYID
            , A.USERID
            , A.PRTPNT_NM
            , DATE_FORMAT(A.SBMSN_DT, '%Y-%m-%d') AS SBMSN_DT_STR
            , A.MDFCN_DT
            , A.MDFRID
            , A.REG_DT
            , A.RGTRID
        FROM
            TB_CMM_SRVY_SBMSN A
        LEFT OUTER JOIN TB_CMM_SRVY B ON A.SRVYID = B.SRVYID
        WHERE 
            A.SRVYID = #{srvyid}
        <if test="infntPrgrmAplyid != null and infntPrgrmAplyid != 0">
            AND A.INFNT_PRGRM_APLYID = #{infntPrgrmAplyid} 
        </if>            
    </select>
    
    <!-- 유아환경교육관 참여이력 수정 -->
    <update id="updateInfntAply" parameterType="front.InfntAplyHistVo" keyProperty="front.InfntAplyHistVo">
        /* InfntAplyHistDao.updateInfntAply */
        UPDATE TB_EDU_INFNT_PRGRM_APLY SET
                CTPRVN_CD                 = #{ctprvnCd}
                , MOBLPHON                  = #{moblphon}
                , EDU_NOPE                  = #{eduNope}
                , TCHER_NOPE                = #{tcherNope}
                , ETC                       = #{etc}
                , TOWWAY_ONLN_EDU_AGRE_YN   = #{towwayOnlnEduAgreYn}
                , MDFCN_DT                  = NOW()
                , MDFRID                    = #{user.userid}
         WHERE APLYID                      = #{aplyid}
    </update>      
    
    <!-- 교육대상 저장 -->
    <insert id="insertTrgtCd" parameterType="front.InfntAplyHistVo" >
         /* InfntAplyHistDao.insertTrgtCd */
         INSERT INTO TB_EDU_INFNT_PRGRM_APLY_EDU_TRGT(
              APLYID
              ,EDU_TRGT_CD
              ,MDFCN_DT
              ,MDFRID
              ,REG_DT
              ,RGTRID
         )VALUES
          <foreach item="item" collection="trgtCds"  separator=",">
           (
             #{aplyid}
             ,#{item}
             ,NOW()
             ,#{user.userid}
             ,NOW()
             ,#{user.userid}             
            )
          </foreach>
    </insert>

    <!-- 교육대상 삭제 -->
    <insert id="deleteTrgtCd" parameterType="front.InfntAplyHistVo" >
         /* InfntAplyHistDao.deleteTrgtCd */
         DELETE FROM TB_EDU_INFNT_PRGRM_APLY_EDU_TRGT
         WHERE 1=1
           AND APLYID = #{aplyid}
    </insert>
    
    <select id="selectEduTrgtCd" parameterType="front.InfntAplyHistVo" resultType="front.InfntAplyHistVo">
        /* InfntAplyHistDao.selectEduTrgtCd */
        SELECT
            EDU_TRGT_CD AS TRGT_CD
        FROM
            TB_EDU_INFNT_PRGRM_APLY_EDU_TRGT
        WHERE
            APLYID = #{aplyid}
    </select>       
</mapper>