<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : HelpdeskDaoImpl.xml
    Description : 탄소중립 헬프데스크
-->
<mapper namespace="com.kbrainc.plum.front.helpdesk.model.HelpdeskDao">

    <!--  헬프데스크 등록  -->
    <insert id="insertHelpdesk">
        INSERT INTO TB_CMM_HELPDESK(
            TTL
            , CN
            , FILEGRPID
            , CLSF_CD
            , STTS_CD
            , USERID
            , INSTID
            , RLS_YN
            , DEL_YN
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
             #{ttl}
             , #{cn}
             , #{filegrpid}
             , #{clsfCd}
             , '113101'
             , #{user.userid}
             , #{user.instid}
             , #{rlsYn}
             , 'N'
             , NOW()
             , #{user.userid}
             , NOW()
             , #{user.userid}
             )
    </insert>

    <!-- 헬프데스크 수정   -->
    <update id="updateHelpdesk">
        UPDATE TB_CMM_HELPDESK SET
            TTL = #{ttl}
            , CN = #{cn}
            , FILEGRPID = #{filegrpid}
            , CLSF_CD = #{clsfCd}
            , RLS_YN = #{rlsYn}
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE INQRYID = #{inqryid}
    </update>

    <!-- 헬프데스크 삭제  -->
    <update id="deleteHelpdesk">
        UPDATE TB_CMM_HELPDESK SET
            DEL_YN = 'Y'
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE INQRYID = #{inqryid}
    </update>

    <!--  헬프데스크 취소  -->
    <update id="cancelHelpdesk">
        UPDATE TB_CMM_HELPDESK SET
           STTS_CD = '113102'
           , MDFCN_DT = NOW()
           , MDFRID = #{user.userid}
        WHERE INQRYID = #{inqryid}
    </update>

    <!--  헬프데스크 신청 목록 조회  -->
    <select id="selectHelpdeskList" resultType="com.kbrainc.plum.front.helpdesk.model.HelpdeskVo">
        <include refid="PaginationMapper.header"/>
        SELECT
            A.INQRYID
            , A.TTL
            , A.CLSF_CD
            , A.CN
            , A.FILEGRPID
            , A.STTS_CD
            , A.RLS_YN
            , A.REG_DT
            , A.USERID
            , B.NM
        FROM TB_CMM_HELPDESK A
        INNER JOIN TB_CMM_USER B
            ON A.USERID = B.USERID
        WHERE 1 = 1
            AND A.DEL_YN = 'N' AND A.STTS_CD != '113102'
        <if test="searchKeyword != null and searchKeyword !=''">
            <choose>
                <when test="searchType == 'ttl' ">
                    AND A.TTL LIKE CONCAT('%', #{searchKeyword}, '%')
                </when>
                <when test="searchType =='cn' ">
                    AND A.CN LIKE CONCAT('%', #{searchKeyword}, '%')
                </when>
                <otherwise>
                    AND ( A.TTL LIKE CONCAT('%', #{searchKeyword}, '%') OR A.CN LIKE CONCAT('%', #{searchKeyword}, '%'))
                </otherwise>
            </choose>
        </if>
        <if test="clsfCd != null and clsfCd != ''">
            AND A.CLSF_CD = #{clsfCd}
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>

    <!--  헬프데스크 상세 조회  -->
    <select id="selectHelpdesk" resultType="com.kbrainc.plum.front.helpdesk.model.HelpdeskVo">
        SELECT
            A.INQRYID
             , A.TTL
             , A.CLSF_CD
             , A.CN
             , A.FILEGRPID
             , A.STTS_CD
             , A.RLS_YN
             , A.REG_DT
             , A.USERID
             , B.NM
        FROM TB_CMM_HELPDESK A
        INNER JOIN TB_CMM_USER B
            ON A.USERID = B.USERID
        WHERE A.INQRYID = #{inqryid}
    </select>

    <!--  헬프데스크 답변 조회  -->
    <select id="selectHelpdeskAns" resultType="com.kbrainc.plum.front.helpdesk.model.HelpdeskAnsVo">
        SELECT
            A.ANSID
            , A.ANS_DE
            , A.RLS_YN
            , A.TTL
            , A.CN
            , A.FILEGRPID
            , B.NM
        FROM TB_CMM_HELPDESK_ANS A
        INNER JOIN TB_CMM_USER B
            ON A.PRCRID = B.USERID
        WHERE A.INQRYID = #{inqryid}
    </select>

    <!--  마이페이지 > 헬프데스크 신청 목록 조회  -->
    <select id="selectMyHelpdeskList" resultType="com.kbrainc.plum.front.helpdesk.model.HelpdeskVo">
        <include refid="PaginationMapper.header"/>
        SELECT
            A.INQRYID
            , A.TTL
            , A.CLSF_CD
            , A.CN
            , A.FILEGRPID
            , A.STTS_CD
            , A.RLS_YN
            , A.REG_DT
            , A.USERID
            , B.NM
        FROM TB_CMM_HELPDESK A
        INNER JOIN TB_CMM_USER B
            ON A.USERID = B.USERID
        WHERE 1 = 1
            AND A.DEL_YN = 'N'
            AND A.USERID = #{user.userid}
        <if test="searchKeyword != null and searchKeyword!= ''">
            AND A.TTL LIKE CONCAT('%', #{searchKeyword}, '%')
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>

</mapper>