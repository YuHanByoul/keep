<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<!--
	SQL File Name : MyExprtDaoImpl.xml
	Description : 마이페이지 > 환경교육 전문가 풀
-->
<mapper namespace="com.kbrainc.plum.front.mypage.exprtPool.model.MyExprtDao">
    <insert id="insertHdof">
        INSERT INTO TB_ASS_EXPRT_MDFCN_HDOF(
            MDFCN_DMND_ID
            , HDOF_SE_CD
            , INST_NM
            , DEPT_NM
            , JBGD_NM
            , HDOF_BGNG_DE
            , HDOF_END_DE
            , HDOF_YN
            , HDOFCRTF_FILEGRPID
            , ORDR
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES
        <foreach collection="hdofs" item="item" separator="," index="index">
            (
            #{mdfcnDmndId}
            , #{item.hdofSeCd}
            , #{item.instNm}
            , #{item.deptNm}
            , #{item.jbgdNm}
            , #{item.hdofBgngDe}
            , #{item.hdofEndDe}
            , #{item.hdofYn}
            , #{item.hdofcrtfFileid}
            , #{index}
            , NOW()
            , #{user.userid}
            ,  NOW()
            , #{user.userid}
            )
        </foreach>
    </insert>

    <!-- -->
    <insert id="insertCareer">
        INSERT INTO TB_ASS_EXPRT_MDFCN_CAREER(
            MDFCN_DMND_ID
            , FLD_NM
            , ACTVT_BGNG_DE
            , ACTVT_END_DE
            , ACTVT_YN
            , ACTVT_HR
            , IDNTY_INST_NM
            , ACTVT_CN
            , IDNTY_DE
            , CRTF_FILEGRPID
            , ARTCLASS_FILEGRPID
            , ORDR
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES
        <foreach collection="careers" item="item" separator="," index="index">
            (
            #{mdfcnDmndId}
            , #{item.fldNm}
            , #{item.actvtBgngDe}
            , #{item.actvtEndDe}
            , #{item.actvtYn}
            , #{item.actvtHr}
            , #{item.idntyInstNm}
            , #{item.actvtCn}
            , #{item.idntyDe}
            , #{item.crtfFileid}
            , #{item.artclassFileid}
            , #{index}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
            )
        </foreach>
    </insert>

    <insert id="insertCrtfct">
        INSERT INTO TB_ASS_EXPRT_MDFCN_CRTFCT(
            MDFCN_DMND_ID
            , CRTFCT_NM
            , ACQS_INST
            , ACQS_NO
            , ACQS_GRD
            , ACQS_DE
            , CRTFCT_FILEGRPID
            , ORDR
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES
        <foreach collection="crtfcts" item="item" separator="," index="index">
            (
            #{mdfcnDmndId}
            , #{item.crtfctNm}
            , #{item.acqsInst}
            , #{item.acqsNo}
            , #{item.acqsGrd}
            , #{item.acqsDe}
            , #{item.crtfctFileid}
            , #{index}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
            )
        </foreach>
    </insert>

    <insert id="insertTrgtCds">
        INSERT INTO TB_ASS_EXPRT_MDFCN_TRGT(
            MDFCN_DMND_ID
            , TRGT_CD
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES
        <foreach collection="trgtCds" item="trgtCd" separator=",">
            (
            #{mdfcnDmndId}
            , #{trgtCd}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
            )
        </foreach>
    </insert>

    <insert id="insertSbjctCds">
        INSERT INTO TB_ASS_EXPRT_MDFCN_SBJCT (
            MDFCN_DMND_ID
            , SBJCT_CD
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES
        <foreach collection="sbjctCds" item="sbjctCd" separator=",">
            (
            #{mdfcnDmndId}
            , #{sbjctCd}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
            )
        </foreach>
    </insert>

    <insert id="insertActvtRgnCds">
        INSERT INTO TB_ASS_EXPRT_MDFCN_ACTVT_RGN(
            MDFCN_DMND_ID
            , RGN_CD
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES
        <foreach collection="actvtRgnCds" item="actvtRgnCd" separator=",">
            (
            #{mdfcnDmndId}
            , #{actvtRgnCd}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
            )
        </foreach>
    </insert>

    <insert id="insertActvtScopeCds">
        INSERT INTO TB_ASS_EXPRT_MDFCN_ACTVT_SCOPE
        (
            MDFCN_DMND_ID
            , RGN_CD
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES
        <foreach collection="actvtScopeCds" item="actvtScopeCd" separator=",">
            (
            #{mdfcnDmndId}
            , #{actvtScopeCd}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
            )
        </foreach>
    </insert>

    <insert id="insertMdfcnDmnd" useGeneratedKeys="true" keyProperty="mdfcnDmndId">
        INSERT TB_ASS_EXPRT_MDFCN_DMND(
            USERID
           , EXPRT_TYPE_CD
           , FLD_LCTR_YN
           , FLD_PLANNG_YN
           , FLD_CNSLTNG_YN
           , FLD_ETC_YN
           , FLD_ETC_CN
           , ENV_EDU_CAREER_YY
           , ENV_EDU_CAREER_MM
           , INFO_MDFCN_RSN
           , STTS_CD
           , MDFCN_DT
           , MDFRID
           , REG_DT
           , RGTRID)
        VALUES (
            #{user.userid}
            , #{exprtTypeCd}
            , #{fldLctrYn}
            , #{fldPlanngYn}
            , #{fldCnsltngYn}
            , #{fldEtcYn}
            , #{fldEtcCn}
            , #{envEduCareerYy}
            , #{envEduCareerMm}
            , #{infoMdfcnRsn}
            , '152101'
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
       )
    </insert>

    <update id="updateRlsAndRcptn">
        UPDATE TB_ASS_EXPRT
        SET
            MOBLPHON_RLS_YN = #{moblphonRlsYn}
            , TELNO_RLS_YN = #{telnoRlsYn}
            , EML_RLS_YN = #{emlRlsYn}
            , QLFC_RLS_YN = #{qlfcRlsYn}
            , HDOF_RLS_YN = #{hdofRlsYn}
            , CAREER_RLS_YN = #{careerRlsYn}
            , ENT_LCTR_DMND_RCPTN_YN = #{entLctrDmndRcptnYn}
            , LCTR_GDNC_RCPTN_YN = #{lctrGdncRcptnYn}
        WHERE USERID = #{user.userid}
    </update>

    <select id="selectMyExprt" resultType="com.kbrainc.plum.front.mypage.exprtPool.model.MyExprtVo">
        SELECT
            EXPRT_TYPE_CD
             , (SELECT CONCAT_WS(',',
                                 CASE WHEN FLD_LCTR_YN = 'Y' THEN '강의' END
                           , CASE WHEN FLD_PLANNG_YN = 'Y' THEN '기획' END
                           , CASE WHEN FLD_CNSLTNG_YN = 'Y' THEN '사업자문 및 컨설팅' END
                           , CASE WHEN FLD_ETC_YN = 'Y' THEN CONCAT('기타(', FLD_ETC_CN,')') END
                           )) AS FLDS
            , MOBLPHON_RLS_YN
            , TELNO_RLS_YN
            , EML_RLS_YN
            , QLFC_RLS_YN
            , HDOF_RLS_YN
            , CAREER_RLS_YN
            , ENT_LCTR_DMND_RCPTN_YN
            , LCTR_GDNC_RCPTN_YN
            , ENV_EDU_CAREER_YY
            , ENV_EDU_CAREER_MM
            , STTS_CD
            , APLY_DT
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
            , TOS_AGRE_YN
            , PRVC_CLCT_AGRE_YN
            , PRVC_THPTY_PVSN_AGRE_YN
            , (SELECT GROUP_CONCAT(TCC.CD_NM) FROM TB_ASS_EXPRT_SBJCT TAES INNER JOIN TB_CMM_CD TCC ON TAES.SBJCT_CD = TCC.CD WHERE TAES.USERID = #{user.userid}) AS SBJCT_CD_NM
            , (SELECT GROUP_CONCAT(TCC.CD_NM) FROM TB_ASS_EXPRT_TRGT TAET INNER JOIN TB_CMM_CD TCC ON TAET.TRGT_CD = TCC.CD WHERE TAET.USERID = #{user.userid}) AS TRGT_CD_NM
            , (SELECT GROUP_CONCAT(TCAC.CTPRVN_NM) FROM TB_CMM_ADDR_CTPRVN TCAC INNER JOIN TB_ASS_EXPRT_ACTVT_SCOPE TAEAS ON TCAC.CTPRVN_CD = TAEAS.RGN_CD WHERE TAEAS.USERID = #{user.userid}) AS ACTVT_SCOPE_CD_NM
            , (SELECT GROUP_CONCAT(TCAC.CTPRVN_NM) FROM TB_CMM_ADDR_CTPRVN TCAC INNER JOIN TB_ASS_EXPRT_ACTVT_RGN TAEAR ON TCAC.CTPRVN_CD = TAEAR.RGN_CD WHERE TAEAR.USERID = #{user.userid}) AS ACTVT_RGN_CD_NM
        FROM TB_ASS_EXPRT A
        WHERE A.USERID = #{user.userid}
            AND STTS_CD = '134103'
    </select>


    <select id="selectExpertCareerList" resultType="com.kbrainc.plum.front.mypage.exprtPool.model.MyCareerVo">
        SELECT
            EXPRT_CAREER_ID
             , FLD_NM
             , ACTVT_BGNG_DE
             , ACTVT_END_DE
             , ACTVT_YN
             , ACTVT_HR
             , IDNTY_INST_NM
             , ACTVT_CN
             , IDNTY_DE
             , CRTF_FILEID
             , ARTCLASS_FILEID
             , ORDR
        FROM TB_ASS_EXPRT_CAREER
        WHERE USERID= #{user.userid}
        ORDER BY ORDR
    </select>

    <select id="selectExpertCrtfctList" resultType="com.kbrainc.plum.front.mypage.exprtPool.model.MyCrtfctVo">
        SELECT
            EXPRT_CRTFCT_ID
             , CRTFCT_NM
             , ACQS_INST
             , ACQS_NO
             , ACQS_GRD
             , ACQS_DE
             , CRTFCT_FILEID
             , ORDR
        FROM TB_ASS_EXPRT_CRTFCT
        WHERE USERID= #{user.userid}
        ORDER BY ORDR
    </select>

    <select id="selectExpertHdofList" resultType="com.kbrainc.plum.front.mypage.exprtPool.model.MyHdofVo">
        SELECT
            EXPRT_HDOF_ID
             , HDOF_SE_CD
             , INST_NM
             , DEPT_NM
             , JBGD_NM
             , HDOF_BGNG_DE
             , HDOF_END_DE
             , HDOF_YN
             , HDOFCRTF_FILEID
             , ORDR
        FROM TB_ASS_EXPRT_HDOF
        WHERE USERID= #{user.userid}
        ORDER BY ORDR
    </select>

    <select id="selectMyExprtMdfcn" resultType="com.kbrainc.plum.front.mypage.exprtPool.model.MyExprtMdfcnVo">
        SELECT
            EXPRT_TYPE_CD
             , USERID
             , FLD_LCTR_YN
             , FLD_PLANNG_YN
             , FLD_CNSLTNG_YN
             , FLD_ETC_YN
             , FLD_ETC_CN
             , ENV_EDU_CAREER_YY
             , ENV_EDU_CAREER_MM
             , STTS_CD
             , (SELECT GROUP_CONCAT(TRGT_CD) FROM TB_ASS_EXPRT_TRGT  WHERE USERID = #{user.userid} ) AS TRGT_CDS/* 전문분야 대상 */
             , (SELECT GROUP_CONCAT(SBJCT_CD) FROM TB_ASS_EXPRT_SBJCT  WHERE USERID = #{user.userid} ) AS SBJCT_CDS /* 전문분야 주제 */
             , (SELECT GROUP_CONCAT(RGN_CD) FROM TB_ASS_EXPRT_ACTVT_RGN  WHERE USERID = #{user.userid} ) AS ACTVT_RGN_CDS /* 주요활동지역 */
             , (SELECT GROUP_CONCAT(RGN_CD) FROM TB_ASS_EXPRT_ACTVT_SCOPE  WHERE USERID = #{user.userid} ) AS ACTVT_SCOPE_CDS /* 가능 활동범위 */
        FROM TB_ASS_EXPRT
        WHERE USERID= #{user.userid}
    </select>
</mapper>