<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.kbrainc.plum.front.intro.envEduPlcyDta.model.EnvEduPlcyDtaDao">
    <update id="updateBsnsOperDtaHits">
        UPDATE TB_CMM_BSNS_OPER_DTA
        SET HITS = IFNULL(HITS,0) + 1
        WHERE DTAID = #{dtaid}
    </update>

    <update id="updateSpcltyDtaHits">
        UPDATE TB_CMM_SPCLTY_DTA
        SET HITS = IFNULL(HITS,0) + 1
        WHERE DTAID = #{dtaid}
    </update>

    <select id="selectBsnsOperDtaList" resultType="front.BsnsOperDtaVo">
        <include refid="PaginationMapper.header"/>
            SELECT
                A.DTAID
                , A.YY
                , IFNULL(B.INST_NM, '') AS INST_NM
                , A.TTL
                , A.CN
                , A.PDF_FILEID
                , A.ATCH_FILEGRPID
                , A.REG_DT
                , IFNULL(A.HITS,0) AS HITS
                , C.CLSF_CD_NM
            FROM TB_CMM_BSNS_OPER_DTA A
            LEFT OUTER JOIN TB_CMM_INST B
                ON A.INSTID = B.INSTID
            INNER JOIN (
                SELECT
                    TCBODCM.DTAID
                     , GROUP_CONCAT(TCC.CD_NM SEPARATOR ', ') CLSF_CD_NM
                FROM TB_CMM_BSNS_OPER_DTA_CLSF_MAPNG TCBODCM
                INNER JOIN TB_CMM_CD TCC
                    ON TCBODCM.CLSF_CD = TCC.CD
                GROUP BY TCBODCM.DTAID
            ) C
                ON A.DTAID = C.DTAID
            WHERE A.DEL_YN = 'N'
            <if test="searchKeyword != null and searchKeyword != ''">
                <choose>
                    <when test="searchType == 'ttl'">
                        AND A.TTL LIKE CONCAT ('%', #{searchKeyword}, '%')
                    </when>
                    <when test="searchType == 'cn'">
                        AND A.CN LIKE CONCAT ('%', #{searchKeyword}, '%')
                    </when>
                    <otherwise>
                        AND (A.TTL LIKE CONCAT('%', #{searchKeyword}, '%') OR A.CN LIKE CONCAT('%', #{searchKeyword}, '%'))
                    </otherwise>
                </choose>
            </if>

            <if test="instNm != null and instNm != ''">
                AND B.INST_NM LIKE CONCAT('%', #{instNm}, '%')
            </if>

            <if test="searchFromRegDt != null and searchFromRegDt != ''">
                AND DATE(A.REG_DT) <![CDATA[>=]]> #{searchFromRegDt}
            </if>

            <if test="searchToRegDt != null and searchToRegDt != ''">
                AND DATE(A.REG_DT) <![CDATA[<=]]> #{searchToRegDt}
            </if>

            <if test="searchClsfCdNm != null and searchClsfCdNm != ''">
                AND C.CLSF_CD_NM LIKE CONCAT('%', #{searchClsfCdNm}, '%')
            </if>
        <include refid="PaginationMapper.footer"/>
    </select>

    <select id="selectBsnsOperDta" resultType="front.BsnsOperDtaVo">
        WITH SPCLTY_DTA_LIST AS(
            SELECT
                A.DTAID
                , ROW_NUMBER() OVER(ORDER BY A.REG_DT DESC) AS ROW_NUM
                , A.YY
                , A.TYPE_CD
                , IFNULL(C.INST_NM, '')
                , D.CLSF_CD_NM
                , A.CPYRHT_CD
                , A.TTL
                , A.CN
                , A.PDF_FILEID
                , A.ATCH_FILEGRPID
                , A.REG_DT
            FROM TB_CMM_BSNS_OPER_DTA A
            LEFT OUTER JOIN TB_CMM_INST C
                ON A.INSTID = C.INSTID
            INNER JOIN (
                SELECT
                    TCBODCM.DTAID
                     , GROUP_CONCAT(TCC.CD_NM SEPARATOR ', ') CLSF_CD_NM
                FROM TB_CMM_BSNS_OPER_DTA_CLSF_MAPNG TCBODCM
                INNER JOIN TB_CMM_CD TCC
                    ON TCBODCM.CLSF_CD = TCC.CD
                GROUP BY TCBODCM.DTAID
            ) D
            ON A.DTAID = D.DTAID
        )
        SELECT *
        , (SELECT DTAID FROM SPCLTY_DTA_LIST  WHERE ROW_NUM <![CDATA[<]]> A.ROW_NUM ORDER BY REG_DT DESC LIMIT 1) AS NEXT_DTAID
        , (SELECT TTL FROM SPCLTY_DTA_LIST  WHERE ROW_NUM <![CDATA[<]]> A.ROW_NUM ORDER BY REG_DT DESC LIMIT 1) AS NEXT_DTA_TTL
        , (SELECT DTAID FROM SPCLTY_DTA_LIST  WHERE ROW_NUM <![CDATA[>]]> A.ROW_NUM ORDER BY REG_DT DESC LIMIT 1) AS PREV_DTAID
        , (SELECT TTL FROM SPCLTY_DTA_LIST  WHERE ROW_NUM <![CDATA[>]]> A.ROW_NUM ORDER BY REG_DT DESC LIMIT 1) AS PREV_DTA_TTL
        FROM SPCLTY_DTA_LIST A
        WHERE A.DTAID = #{dtaid}
    </select>

    <select id="selectSpcltyDta" resultType="front.SpcltyDtaVo">
    WITH SPCLTY_DTA_LIST AS (
        SELECT A.DTAID
             , ROW_NUMBER() OVER(ORDER BY REG_DT DESC) AS ROW_NUM
             , A.YY
             , A.WRITR
             , A.TTL
             , A.CN
             , A.PDF_FILEID
             , A.ATCH_FILEGRPID
             , A.REG_DT
             , A.CPYRHT_CD
             , B.CLSF_CD_NM
        FROM TB_CMM_SPCLTY_DTA A
        INNER JOIN (
            SELECT
                TCSDC.DTAID
                , GROUP_CONCAT(TCC.CD_NM SEPARATOR ', ') CLSF_CD_NM
            FROM TB_CMM_SPCLTY_DTA_CLSF TCSDC
            INNER JOIN TB_CMM_CD TCC
                ON TCSDC.CLSF_CD = TCC.CD
            GROUP BY TCSDC.DTAID
        ) B
        ON A.DTAID = B.DTAID
    )
    SELECT *
    , (SELECT DTAID FROM SPCLTY_DTA_LIST  WHERE ROW_NUM <![CDATA[<]]> A.ROW_NUM ORDER BY REG_DT DESC LIMIT 1) AS NEXT_DTAID
    , (SELECT TTL FROM SPCLTY_DTA_LIST  WHERE ROW_NUM <![CDATA[<]]> A.ROW_NUM ORDER BY REG_DT DESC LIMIT 1) AS NEXT_DTA_TTL
    , (SELECT DTAID FROM SPCLTY_DTA_LIST  WHERE ROW_NUM <![CDATA[>]]> A.ROW_NUM ORDER BY REG_DT DESC LIMIT 1) AS PREV_DTAID
    , (SELECT TTL FROM SPCLTY_DTA_LIST  WHERE ROW_NUM <![CDATA[>]]> A.ROW_NUM ORDER BY REG_DT DESC LIMIT 1) AS PREV_DTA_TTL
    FROM SPCLTY_DTA_LIST A
    WHERE A.DTAID = #{dtaid}
    </select>

    <select id="selectSpcltyDtaList" resultType="front.SpcltyDtaVo">
        <include refid="PaginationMapper.header"/>
            SELECT
                A.DTAID
                , A.YY
                , A.WRITR
                , A.TTL
                , A.CN
                , A.PDF_FILEID
                , A.ATCH_FILEGRPID
                , A.REG_DT
                , IFNULL(A.HITS,0) AS HITS
                , B.CLSF_CD_NM
        FROM TB_CMM_SPCLTY_DTA A
        INNER JOIN (
            SELECT
                TCSDC.DTAID
                , GROUP_CONCAT(TCC.CD_NM SEPARATOR ', ') CLSF_CD_NM
                FROM TB_CMM_SPCLTY_DTA_CLSF TCSDC
                INNER JOIN TB_CMM_CD TCC
                    ON TCSDC.CLSF_CD = TCC.CD
                GROUP BY TCSDC.DTAID
            ) B
            ON A.DTAID = B.DTAID
        WHERE A.DEL_YN = 'N'
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test="searchType == 'ttl'">
                    AND A.TTL LIKE CONCAT ('%', #{searchKeyword}, '%')
                </when>
                <when test="searchType == 'cn'">
                    AND A.CN LIKE CONCAT ('%', #{searchKeyword}, '%')
                </when>
                <otherwise>
                    AND (A.TTL LIKE CONCAT('%', #{searchKeyword}, '%') OR A.CN LIKE CONCAT('%', #{searchKeyword}, '%'))
                </otherwise>
            </choose>
        </if>
        <if test="writr != null and writr !=''">
            AND A.WRITR LIKE CONCAT('%', #{writr}, '%')
        </if>
        <if test="searchFromRegDt != null and searchFromRegDt != ''">
            AND DATE(A.REG_DT) <![CDATA[>=]]> #{searchFromRegDt}
        </if>

        <if test="searchToRegDt != null and searchToRegDt != ''">
            AND DATE(A.REG_DT) <![CDATA[<=]]> #{searchToRegDt}
        </if>

        <if test="searchClsfCdNm != null and searchClsfCdNm != ''">
            AND B.CLSF_CD_NM LIKE CONCAT('%', #{searchClsfCdNm}, '%')
        </if>
        <include refid="PaginationMapper.footer"/>
    </select>
</mapper>