<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : CarbonEnveduDaoImpl.xml
	Description : 탄소중립 환경교육
-->
<mapper namespace="com.kbrainc.plum.front.wbzn.carbon.model.CarbonEnveduDao">
    <!-- 배너 목록 조회 -->
    <select id="selectBannerList" parameterType="front.CarbonBannerVo" resultType="front.CarbonBannerVo">
        /* CarbonEnveduDao.selectBannerList */
        SELECT
              A.BANNERID
            , A.BANNER_TTL
            , A.URL
            , A.BANNER_FILEID
            , B.FILE_IDNTFC_KEY
            , A.EXPSR_YN
            , A.REG_DT
        FROM 
            TB_CMM_WBZN_BANNER A
        LEFT OUTER JOIN TB_CMM_FILE B ON A.BANNER_FILEID = B.FILEID
        WHERE 
            1=1
            AND A.EXPSR_YN = 'Y'
            AND A.CLSF_CD = '232102'
            AND (A.DEL_YN = 'N' OR A.DEL_YN IS NULL)
        ORDER BY ORDR ASC               
    </select>
    
    <!-- 환경교육 필터 년도 조회 -->
    <select id="selectEnveduYrList" parameterType="front.CarbonEnveduVo" resultType="front.CarbonEnveduVo">
        /* CarbonEnveduDao.selectEnveduYrList */
            SELECT
            	YR
            FROM
            	TB_CMM_WBZN_ENVEDU
            WHERE
                CLSF_CD = '232102'
                AND (DEL_YN = 'N' OR DEL_YN IS NULL)                
            GROUP BY
            	YR
            ORDER BY
            	YR ASC
    </select>
    
    <!-- 환경교육 필터 월 조회 -->
    <select id="selectEnveduMmList" parameterType="front.CarbonEnveduVo" resultType="front.CarbonEnveduVo">
        /* CarbonEnveduDao.selectEnveduMmList */
            SELECT
                QU
            FROM
                TB_CMM_WBZN_ENVEDU
            WHERE
                CLSF_CD = '232102'
                AND YR = #{yr}
                AND (DEL_YN = 'N' OR DEL_YN IS NULL)
            GROUP BY
                QU
            ORDER BY
                QU ASC
    </select>
    
    <!-- 프로그램 필터 년도 조회 -->
    <select id="selectPrgrmgdYrList" parameterType="front.CarbonPrgrmgdVo" resultType="front.CarbonPrgrmgdVo">
        /* CarbonEnveduDao.selectPrgrmgdYrList */
            SELECT
                YR
            FROM
                TB_CMM_WBZN_PRGRM
            WHERE
                CLSF_CD = '232102'
                AND (DEL_YN = 'N' OR DEL_YN IS NULL)
            GROUP BY
                YR
            ORDER BY
                YR ASC
    </select>
    
    <!-- 프로그램 필터 월 조회 -->
    <select id="selectPrgrmgdMmList" parameterType="front.CarbonPrgrmgdVo" resultType="front.CarbonPrgrmgdVo">
        /* CarbonEnveduDao.selectPrgrmgdMmList */
            SELECT
                QU
            FROM
                TB_CMM_WBZN_PRGRM
            WHERE
                CLSF_CD = '232102'
                AND YR = #{yr}
                AND (DEL_YN = 'N' OR DEL_YN IS NULL)
            GROUP BY
                QU
            ORDER BY
                QU ASC
    </select>
    
    <select id="selectEnveduNextCount" parameterType="front.CarbonEnveduVo" resultType="int">
        SELECT
            COUNT(*) AS nextCnt
        FROM
            TB_CMM_WBZN_ENVEDU A
        WHERE
              1 = 1
            AND A.CLSF_CD = '232102'
            AND (A.DEL_YN = 'N' OR A.DEL_YN IS NULL)
            AND A.QU = #{compareQuarter}
            AND A.YR = #{compareYear}
    </select>
    
    <select id="selectEnveduPrevCount" parameterType="front.CarbonEnveduVo" resultType="int">
        SELECT
            COUNT(*) AS prevCnt
        FROM
            TB_CMM_WBZN_ENVEDU A
        WHERE
              1 = 1
            AND A.CLSF_CD = '232102'
            AND (A.DEL_YN = 'N' OR A.DEL_YN IS NULL)
            AND A.QU = #{compareQuarter}
            AND A.YR = #{compareYear}
    </select>
    
    <select id="selectPrgrmgdNextCount" parameterType="front.CarbonPrgrmgdVo" resultType="int">
        SELECT
            COUNT(*) AS nextCnt
        FROM
            TB_CMM_WBZN_PRGRM A
        WHERE
              1 = 1
            AND A.CLSF_CD = '232102'
            AND (A.DEL_YN = 'N' OR A.DEL_YN IS NULL)
            AND A.QU = #{compareQuarter}
            AND A.YR = #{compareYear}
    </select>
    
    <select id="selectPrgrmgdPrevCount" parameterType="front.CarbonPrgrmgdVo" resultType="int">
        SELECT
            COUNT(*) AS prevCnt
        FROM
            TB_CMM_WBZN_PRGRM A
        WHERE
              1 = 1
            AND A.CLSF_CD = '232102'
            AND (A.DEL_YN = 'N' OR A.DEL_YN IS NULL)
            AND A.QU = #{compareQuarter}
            AND A.YR = #{compareYear}
    </select>    

    <!-- 환경교육 목록 조회 -->
    <select id="selectEnveduList" parameterType="front.CarbonEnveduVo" resultType="front.CarbonEnveduVo">
        /* CarbonEnveduDao.selectEnveduList */
        <include refid="PaginationMapper.header"/>
            SELECT
                A.ENVEDUID
              , A.CLSF_CD
              , A.ENVEDU_SE_CD
              , D.CD_NM AS ENVEDUSECDNM
              , CONCAT(A.YR, '-', A.MM) AS YRMM
              , A.YR
              , A.MM
              , A.QU
              , A.TTL
              , A.TYPE_CD
              , A.URL
              , A.THMBN_FILEID
              , C.FILEGRPID
              , C.FILE_IDNTFC_KEY
              , A.CN_STYLE
              , A.CN
              , A.MDFCN_DT
              , A.MDFRID
              , A.REG_DT AS REGDT
              , A.RGTRID
              , B.NM
            FROM
                TB_CMM_WBZN_ENVEDU A
                    LEFT OUTER JOIN TB_CMM_USER B ON A.RGTRID = B.USERID
                    LEFT OUTER JOIN TB_CMM_FILE C ON A.THMBN_FILEID = C.FILEID
                    LEFT OUTER JOIN TB_CMM_CD D ON A.ENVEDU_SE_CD = D.CD
            WHERE
                  1 = 1
              AND A.CLSF_CD = '232102'
              AND (A.DEL_YN = 'N' OR A.DEL_YN IS NULL)
            <choose>
                <when test="beforeQuarter != null and beforeQuarter != ''">
                    AND A.QU = #{compareQuarter}
                    AND A.YR = #{compareYear}
                </when>
                <when test="nextQuarter != null and nextQuarter != ''">
                    AND A.QU = #{compareQuarter}
                    AND A.YR = #{compareYear}
                </when>
                <when test="enveduSearchYr != null and enveduSearchYr != '' and enveduSearchMm != null and enveduSearchMm!= ''">
                    AND A.YR = #{enveduSearchYr}
                    AND A.QU = #{enveduSearchMm}
                </when>                
                <otherwise>
                <![CDATA[ 
                    AND
                        CASE
                              WHEN DATE_FORMAT(NOW(), '%m') >= '01' AND DATE_FORMAT(NOW(), '%m') <= '03'
                                  THEN A.QU = 1
                              WHEN DATE_FORMAT(NOW(), '%m') >= '04' AND DATE_FORMAT(NOW(), '%m') <= '06'
                                  THEN A.QU = 2
                              WHEN DATE_FORMAT(NOW(), '%m') >= '07' AND DATE_FORMAT(NOW(), '%m') <= '09'
                                  THEN A.QU = 3
                              WHEN DATE_FORMAT(NOW(), '%m') >= '10' AND DATE_FORMAT(NOW(), '%m') <= '12'
                                  THEN A.QU = 4
                        END
                    AND A.YR = DATE_FORMAT(NOW(), '%Y')
                ]]>
                </otherwise>                
            </choose>               
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 환경교육 상세조회 -->
    <select id="selectEnveduInfo" parameterType="front.CarbonEnveduVo" resultType="front.CarbonEnveduVo"> 
        /* CarbonEnveduDao.selectEnveduInfo */
        SELECT 
        	  A.ENVEDUID
        	, A.CLSF_CD
        	, A.ENVEDU_SE_CD
            , C.CD_NM AS ENVEDUSECDNM
            , A.YR
        	, A.MM
            , A.QU
        	, A.TTL
            , A.TYPE_CD
        	, A.URL
        	, A.THMBN_FILEID
            , B.FILEGRPID
            , B.FILE_IDNTFC_KEY
            , B.ORGINL_FILE_NM
        	, A.CN_STYLE
        	, A.CN
            , DATE(A.REG_DT) REGDT
        FROM TB_CMM_WBZN_ENVEDU A
        LEFT OUTER JOIN TB_CMM_FILE B ON A.THMBN_FILEID = B.FILEID
        LEFT OUTER JOIN TB_CMM_CD C ON A.ENVEDU_SE_CD = C.CD
       WHERE ENVEDUID = #{enveduid}
    </select>
    
    <!-- 프로그램 게시글 목록 조회 -->
    <select id="selectPrgrmgdList" parameterType="front.CarbonPrgrmgdVo" resultType="front.CarbonPrgrmgdVo">
        /* PrgrmgdDao.selectPrgrmgdList */
        <include refid="PaginationMapper.header"/>
        SELECT
              A.PRGRMID
            , A.CLSF_CD
            , A.RGN_CD
            , D.CD_NM AS RGNCDNM
            , CONCAT(A.YR, '-' ,A.MM) AS YRMM
            , A.YR
            , A.MM
            , A.TTL
            , A.SCHDL
            , A.URL
            , A.THMBN_FILEID
            , C.FILEGRPID
            , C.FILE_IDNTFC_KEY
            , A.CN_STYLE
            , A.CN
            , A.CN_SUMRY
            , A.MDFCN_DT
            , A.MDFRID
            , A.REG_DT AS REGDT
            , A.RGTRID
            , B.NM
        FROM 
            TB_CMM_WBZN_PRGRM A
            LEFT OUTER JOIN TB_CMM_USER B ON A.RGTRID = B.USERID
            LEFT OUTER JOIN TB_CMM_FILE C ON A.THMBN_FILEID = C.FILEID
            LEFT OUTER JOIN TB_CMM_CD D ON A.RGN_CD = D.CD
        WHERE 
            1=1
            AND A.CLSF_CD = '232102'
            AND (A.DEL_YN = 'N' OR A.DEL_YN IS NULL)
            <choose>
                <when test="beforeQuarter != null and beforeQuarter != ''">
                    AND A.QU = #{compareQuarter}
                    AND A.YR = #{compareYear}
                </when>
                <when test="nextQuarter != null and nextQuarter != ''">
                    AND A.QU = #{compareQuarter}
                    AND A.YR = #{compareYear}
                </when>
                <when test="prgrmgdSearchYr != null and prgrmgdSearchYr != '' and prgrmgdSearchMm != null and prgrmgdSearchMm != ''">
                    AND A.YR = #{prgrmgdSearchYr}
                    AND A.QU = #{prgrmgdSearchMm}
                </when>
                <otherwise>
                <![CDATA[ 
                    AND
                        CASE
                              WHEN DATE_FORMAT(NOW(), '%m') >= '01' AND DATE_FORMAT(NOW(), '%m') <= '03'
                                  THEN A.QU = 1
                              WHEN DATE_FORMAT(NOW(), '%m') >= '04' AND DATE_FORMAT(NOW(), '%m') <= '06'
                                  THEN A.QU = 2
                              WHEN DATE_FORMAT(NOW(), '%m') >= '07' AND DATE_FORMAT(NOW(), '%m') <= '09'
                                  THEN A.QU = 3
                              WHEN DATE_FORMAT(NOW(), '%m') >= '10' AND DATE_FORMAT(NOW(), '%m') <= '12'
                                  THEN A.QU = 4
                        END
                    AND A.YR = DATE_FORMAT(NOW(), '%Y')
                ]]>
                </otherwise>
            </choose>                     
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 프로그램 상세조회 -->
    <select id="selectPrgrmgdInfo" parameterType="front.CarbonPrgrmgdVo" resultType="front.CarbonPrgrmgdVo"> 
        /* CarbonEnveduDao.selectPrgrmgdInfo */
        SELECT 
              A.PRGRMID
            , A.CLSF_CD
            , A.RGN_CD
            , C.CD_NM AS RGNCDNM
            , A.YR
            , A.MM
            , A.TTL
            , A.SCHDL
            , A.URL
            , A.THMBN_FILEID
            , B.FILEGRPID
            , B.FILE_IDNTFC_KEY
            , B.ORGINL_FILE_NM
            , A.TYPE_CD
            , A.CN_STYLE
            , A.CN
            , A.CN_SUMRY
            , DATE(A.REG_DT) REGDT
        FROM TB_CMM_WBZN_PRGRM A
        LEFT OUTER JOIN TB_CMM_FILE B ON A.THMBN_FILEID = B.FILEID
        LEFT OUTER JOIN TB_CMM_CD C ON A.RGN_CD = C.CD
       WHERE PRGRMID = #{prgrmid}
    </select>    
</mapper>