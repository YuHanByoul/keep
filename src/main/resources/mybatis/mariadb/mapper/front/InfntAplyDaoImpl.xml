<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : InfntAplyDaoImpl.xml
	Description : 유아환경교육관 교육신청
-->
<mapper namespace="com.kbrainc.plum.front.infntAply.model.InfntAplyDao">
    
    <!-- 유아환경교육관 교육신청 목록 조회 -->
    <select id="selectInfntAplyList" parameterType="front.InfntAplyVo" resultType="front.InfntAplyVo">
        /* InfntAplyDao.selectInfntAplyList */
        <include refid="PaginationMapper.header"/>
            SELECT 
                A.PRGRMID
                , A.CLSSRMID
                , B.CLSSRM_NM
                , A.PRGRM_NM
                , F.CD_NM AS CLSF_NM
                , A.EDU_HR_MNT
                , G.FILEID
                , G.FILE_IDNTFC_KEY
                , E.CD_NM CTPRVN_NM
                ,(SELECT GROUP_CONCAT(TB.CD_NM SEPARATOR', ') FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG TA, TB_CMM_CD TB WHERE TA.PRGRMID = A.PRGRMID and TA.TRGT_CD = TB.CD) AS TRGT_NM
                , CASE WHEN B.RCPT_BGNG_DT <![CDATA[>]]> NOW() THEN '모집전' 
                       WHEN NOW() BETWEEN B.RCPT_BGNG_DT AND B.RCPT_END_DT THEN '모집중'
                       WHEN B.RCPT_END_DT <![CDATA[<]]> NOW() THEN '마감'
                       ELSE '' END AS RCPT_DESC  
                , A.MDFCN_DT
                , A.MDFRID
                , A.REG_DT
                , A.RGTRID
                FROM TB_EDU_INFNT_PRGRM A
                LEFT OUTER JOIN TB_EDU_CLSSRM B ON A.CLSSRMID = B.CLSSRMID 
                LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_CLSF_MAPNG C ON A.PRGRMID = C.PRGRMID
                LEFT OUTER JOIN TB_CMM_CD E ON E.CD = B.CTPRVN_CD
                LEFT OUTER JOIN TB_CMM_CD F ON F.CD = C.CLSF_CD
                LEFT OUTER JOIN TB_CMM_FILE G ON A.EDU_PHOTO_FILEID = G.FILEID
                WHERE
                A.USE_YN = 'Y'
                <!-- 유아환경교육관 교육신청 프로그램명 -->
                <if test="searchPrgrmNm != null and searchPrgrmNm != ''">
                AND A.PRGRM_NM LIKE CONCAT('%',#{searchPrgrmNm},'%')
                </if>
                <!-- 유아환경교육관 교육신청 기관명 -->
                <if test="searchEduClssRmNm != null and searchEduClssRmNm != ''">
                AND B.CLSSRM_NM LIKE CONCAT('%',#{searchEduClssRmNm},'%')
                </if>
                <!-- 유아환경교육관 교육신청 교육대상 -->
                <if test="searchTrgtCd != null and searchTrgtCd != '' and searchTrgtCd != '전체'">
                AND D.TRGT_CD = #{searchTrgtCd}
                </if>
                <!-- 유아환경교육관 교육신청 교육지역 -->
                <if test="searchCtprvnCd != null and searchCtprvnCd != '' and searchCtprvnCd != '전체'">
                AND B.CTPRVN_CD = #{searchCtprvnCd}
                </if>
                <!-- 유아환경교육관 교육신청 교육주제 -->
                <if test="searchClsfCd_1 != null and searchClsfCd_1 != '' and searchClsfCd_1 != '전체'">
                AND F.UPPR_CD = #{searchClsfCd_1}
                </if>            
                <if test="searchClsfCd_2 != null and searchClsfCd_2 != '' and searchClsfCd_2 != '전체'">
                AND C.CLSF_CD = #{searchClsfCd_2}
                </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 유아환경교육관 교육신청 게시글 상세조회 -->
    <select id="selectInfntAplyInfo" parameterType="front.InfntAplyVo" resultType="front.InfntAplyVo"> 
        /* InfntAplyDao.selectInfntAplyInfo */
            SELECT
                A.PRGRMID
                , A.CLSSRMID
                , B.CLSSRM_NM
                , A.PRGRM_NM
                , F.CD_NM AS CLSF_NM
                , A.EDU_HR_MNT
                , A.EDU_NOPE
                , A.EDU_INTRCN_FILEID
                , H.FILEGRPID EDU_INTRCN_FILEGRPID
                , H.FILE_IDNTFC_KEY EDU_INTRCN_FILE_IDNTFC_KEY
                , H.ORGINL_FILE_NM EDU_INTRCN_ORGINL_FILE_NM
                , G.FILEID
                , G.FILE_IDNTFC_KEY
                , I.CD_NM AS RCPT_MTHD_NM
                , A.RCPT_MTHD_CD
                , A.EDU_EXPLN
                , A.MTTRAT              
                , E.CD_NM CTPRVN_NM
                ,(SELECT GROUP_CONCAT(TB.CD_NM SEPARATOR', ') FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG TA, TB_CMM_CD TB WHERE TA.PRGRMID = A.PRGRMID and TA.TRGT_CD = TB.CD) AS TRGT_NM
                , CASE WHEN B.RCPT_BGNG_DT <![CDATA[>]]> NOW() THEN '모집전' 
                       WHEN NOW() BETWEEN B.RCPT_BGNG_DT AND B.RCPT_END_DT THEN '모집중'
                       WHEN B.RCPT_END_DT <![CDATA[<]]> NOW() THEN '마감'
                       ELSE '' END AS RCPT_DESC  
                , A.MDFCN_DT
                , A.MDFRID
                , A.REG_DT
                , A.RGTRID
            FROM TB_EDU_INFNT_PRGRM A
                LEFT OUTER JOIN TB_EDU_CLSSRM B ON A.CLSSRMID = B.CLSSRMID 
                LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_CLSF_MAPNG C ON A.PRGRMID = C.PRGRMID
                LEFT OUTER JOIN TB_CMM_CD E ON E.CD = B.CTPRVN_CD
                LEFT OUTER JOIN TB_CMM_CD F ON F.CD = C.CLSF_CD
                LEFT OUTER JOIN TB_CMM_FILE G ON A.EDU_PHOTO_FILEID = G.FILEID
                LEFT OUTER JOIN TB_CMM_FILE H ON A.EDU_INTRCN_FILEID = H.FILEID
                LEFT OUTER JOIN TB_CMM_CD I ON I.CD = A.RCPT_MTHD_CD
            WHERE A.USE_YN = 'Y'
              AND A.PRGRMID = #{prgrmid}
            GROUP BY A.PRGRMID;
    </select>
    
    <!-- 유아환경교육관 교육신청 교육사진 파일 목록 조회 -->
    <select id="selectEduPhotoFileList" parameterType="front.InfntAplyVo" resultType="front.InfntAplyVo">
        /* InfntAplyDao.selectInstInfntAplyList */
            SELECT
                COALESCE(B.FILEID, 0) FILEID
              , B.FILE_IDNTFC_KEY
            FROM
            	TB_EDU_INFNT_PRGRM A
            	LEFT OUTER JOIN tb_cmm_file B ON A.EDU_PHOTO_FILEID = B.FILEID                
            WHERE
                1=1
                AND A.PRGRMID = #{prgrmid}
    </select>
    
    <!-- 유아환경교육관 교육신청 회차 목록 조회 -->
    <select id="selectInfntAplyTmeList" parameterType="front.InfntAplyVo" resultType="front.InfntAplyVo">
        /* InfntAplyDao.selectInfntAplyTmeList */
        SELECT  X.PRGRMID
              , X.TMEID
              , X.TME_NM
              , (CASE WHEN X.EDU_NOPE > X.APLY_CNT THEN 
                    CASE WHEN X.TMEID IN (
                        SELECT TMEID FROM TB_EDU_INFNT_PRGRM_TME_SCHDL 
                         WHERE DE <![CDATA[>=]]>  DATE_FORMAT(NOW(), '%Y.%m.%d')) THEN '신청가능' 
                    ELSE '마감' END 
                 ELSE '마감' END) AS STTS_DESC
              , X.WAIT_CNT
              , X.REG_DT
          FROM (
                SELECT  A.PRGRMID
                      , A.TMEID
                      , A.TME_NM
                      , B.EDU_NOPE
                      , A.REG_DT
                      , (SELECT COUNT(TA.APLYID) 
                           FROM TB_EDU_INFNT_PRGRM_APLY TA
                              , TB_EDU_INFNT_PRGRM_TME_SCHDL TB 
                          WHERE TA.TME_SCHDLID = TB.TME_SCHDLID 
                            AND TB.TMEID = A.TMEID) APLY_CNT
                     ,(SELECT COUNT(TA.APLYID) 
                         FROM TB_EDU_INFNT_PRGRM_APLY TA, TB_EDU_INFNT_PRGRM_TME_SCHDL TB 
                        WHERE TA.TME_SCHDLID = TB.TME_SCHDLID 
                          AND TA.STTS_CD = '180101'
                          AND TB.TMEID = A.TMEID) WAIT_CNT    
                  FROM TB_EDU_INFNT_PRGRM_TME A    
                  LEFT OUTER JOIN TB_EDU_INFNT_PRGRM B ON B.PRGRMID = A.PRGRMID
                  
           ) X
         WHERE 1=1
           AND X.PRGRMID = #{prgrmid}    
         ORDER BY X.REG_DT ASC             
    </select>    

    <!-- 유아환경교육관 동일 교육관 교육 프로그램 목록 조회 -->
    <select id="selectInfntAplyEduClssRmList" parameterType="front.InfntAplyVo" resultType="front.InfntAplyVo">
        /* InfntAplyDao.selectInfntAplyEduClssRmList */
            SELECT 
                A.PRGRMID
                , A.CLSSRMID
                , B.CLSSRM_NM
                , A.PRGRM_NM
                , F.CD_NM AS CLSF_NM
                , A.EDU_HR_MNT
                , E.CD_NM CTPRVN_NM
                ,(SELECT GROUP_CONCAT(TB.CD_NM SEPARATOR', ') FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG TA, TB_CMM_CD TB WHERE TA.PRGRMID = A.PRGRMID and TA.TRGT_CD = TB.CD) AS TRGT_NM
                , A.MDFCN_DT
                , A.MDFRID
                , A.REG_DT
                , A.RGTRID
                FROM TB_EDU_INFNT_PRGRM A
                LEFT OUTER JOIN TB_EDU_CLSSRM B ON A.CLSSRMID = B.CLSSRMID 
                LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_CLSF_MAPNG C ON A.PRGRMID = C.PRGRMID
                LEFT OUTER JOIN TB_CMM_CD E ON E.CD = B.CTPRVN_CD
                LEFT OUTER JOIN TB_CMM_CD F ON F.CD = C.CLSF_CD
            WHERE A.USE_YN = 'Y'
            AND A.CLSSRMID = #{clssrmid}   
            AND A.PRGRMID <![CDATA[<>]]> #{prgrmid}             
    </select>  
    
    <!-- 유아환경교육관 교육신청 목록 조회 -->
    <select id="selectInfntAplyDeList" parameterType="front.InfntAplyVo" resultType="front.InfntAplyVo">
        /* InfntAplyDao.selectInfntAplyList */
        SELECT  X.PRGRMID
              , X.TMEID
              , X.TME_NM
              , (CASE WHEN X.EDU_NOPE > X.APLY_CNT THEN '신청가능' ELSE '마감' END) AS STTS_DESC
              , REPLACE(X.DE,'.','-') DE
              , X.TME_SCHDLID
          FROM (
                SELECT  A.PRGRMID
                      , A.TMEID
                      , A.TME_NM
                      , B.EDU_NOPE
                      , C.DE
                      , C.TME_SCHDLID
                      , (SELECT COUNT(TA.APLYID)
                           FROM TB_EDU_INFNT_PRGRM_APLY TA
                              , TB_EDU_INFNT_PRGRM_TME_SCHDL TB 
                          WHERE TA.TME_SCHDLID = TB.TME_SCHDLID 
                            AND TB.TMEID = A.TMEID) APLY_CNT
                  FROM TB_EDU_INFNT_PRGRM_TME A    
                  LEFT OUTER JOIN TB_EDU_INFNT_PRGRM B ON B.PRGRMID = A.PRGRMID 
                  LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TME_SCHDL C ON C.TMEID = A.TMEID
                  WHERE C.DE IS NOT NULL
           ) X
         WHERE 1=1
           AND X.PRGRMID = #{prgrmid}        
    </select>
    
    <!-- 유아환경교육관 교육신청 등록정보 상세조회 -->
    <select id="selectInfntAplyRegInfo" parameterType="front.InfntAplyVo" resultType="front.InfntAplyVo"> 
        /* InfntAplyDao.selectInfntAplyInfo */
            SELECT
                A.PRGRMID
                , A.CLSSRMID
                , B.CLSSRM_NM
                , A.PRGRM_NM
                , A.EDU_HR_MNT
                , A.EDU_NOPE
                , E.CD_NM CTPRVN_NM
                , C.TME_NM
                , REPLACE(D.DE, '.', '-') DE
                ,(SELECT GROUP_CONCAT(TB.CD_NM SEPARATOR', ') FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG TA, TB_CMM_CD TB WHERE TA.PRGRMID = A.PRGRMID and TA.TRGT_CD = TB.CD) AS TRGT_NM
                ,(SELECT GROUP_CONCAT(TC.TRGT_CD SEPARATOR', ') FROM TB_EDU_INFNT_PRGRM_TRGT_MAPNG TC WHERE TC.PRGRMID = A.PRGRMID ) AS TRGT_CD
                , F.INSTID
                , H.INST_NM
                , H.TELNO
                , F.USERID APLY_USERID                
                , F.NM APLY_USER_NM
                , F.EML
                , H.ADDR
                , H.ADDR_DTL
                , A.MDFCN_DT
                , A.MDFRID
                , A.REG_DT
                , A.RGTRID
            FROM TB_EDU_INFNT_PRGRM A
                LEFT OUTER JOIN TB_EDU_CLSSRM B ON A.CLSSRMID = B.CLSSRMID
                LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TME C ON C.PRGRMID = A.PRGRMID
                LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TME_SCHDL D ON D.TMEID = C.TMEID 
                LEFT OUTER JOIN TB_CMM_CD E ON E.CD = B.CTPRVN_CD
                LEFT OUTER JOIN TB_CMM_USER F ON F.USERID = #{user.userid}
                LEFT OUTER JOIN TB_CMM_INST H ON H.INSTID = F.INSTID                                
            WHERE A.USE_YN = 'Y'
              AND A.PRGRMID = #{prgrmid}
              AND D.TME_SCHDLID = #{tmeSchdlid}
            GROUP BY A.PRGRMID;
    </select>    
    <!-- 유아환경교육관 교육신청 등록 --> 
    <insert id="insertInfntAply" parameterType="front.InfntAplyVo" useGeneratedKeys="true" keyProperty="aplyid">
        /* InfntAplyDao.insertInfntAply */
        INSERT INTO TB_EDU_INFNT_PRGRM_APLY (
            INSTID
            , USERID
            , TME_SCHDLID
            , ADDR
            , ADDR_DTL
            , CTPRVN_CD
            , TELNO
            , MOBLPHON
            , EML
            , EDU_NOPE
            , TCHER_NOPE
            , ETC
            , TOWWAY_ONLN_EDU_AGRE_YN
            , STTS_CD
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        )
        SELECT 
             NULLIF(#{instid},'')
            ,#{aplyUserid}
            ,#{tmeSchdlid}
            ,#{addr}
            ,#{addrDtl}
            ,#{ctprvnCd}
            ,#{telno}
            ,#{moblphon}
            ,#{eml}
            ,#{eduNope}
            ,#{tcherNope}
            ,#{etc}
            ,#{towwayOnlnEduAgreYn}
            ,CASE WHEN C.RCPT_MTHD_CD = '156101' THEN '180102' ELSE CASE WHEN COUNT(D.STTS_CD) <![CDATA[<=]]> C.EDU_NOPE THEN '180102' ELSE '180101' END END    
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
          FROM TB_EDU_INFNT_PRGRM_TME_SCHDL A
          LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_TME B ON B.TMEID = A.TMEID
          LEFT OUTER JOIN TB_EDU_INFNT_PRGRM C ON C.PRGRMID = B.PRGRMID                
          LEFT OUTER JOIN TB_EDU_INFNT_PRGRM_APLY D ON D.TME_SCHDLID = #{tmeSchdlid}                 
         WHERE A.TME_SCHDLID = #{tmeSchdlid}    
    </insert>    
    <!-- 유아환경교육관 교육신청 대상등록 -->
    <insert id="insertTrgtCd" parameterType="front.InfntAplyVo" >
         /* InfntAplyDao.insertTrgtCd */
         INSERT INTO TB_EDU_INFNT_PRGRM_APLY_EDU_TRGT(
              APLYID
              ,EDU_TRGT_CD
              ,MDFCN_DT
              ,MDFRID
              ,REG_DT
              ,RGTRID
         )VALUES
          <foreach item="item" collection="trgtCds"  separator=",">
           (
             #{aplyid}
             ,#{item}
             ,NOW()
             ,#{user.userid}
             ,NOW()
             ,#{user.userid}             
            )
          </foreach>
    </insert>    
</mapper>