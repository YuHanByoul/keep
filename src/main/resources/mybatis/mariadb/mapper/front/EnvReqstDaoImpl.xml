<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : EnvReqstDaoImpl.xml
    Description : 환경교육시설 예약
-->
<mapper namespace="com.kbrainc.plum.front.envReqst.model.EnvReqstDao">

    <select id="selectEnvReqstList" resultType="front.EnvReqstVo">
        /* EnvReqstDao.selectEnvReqstList*/
        <include refid="PaginationMapper.header"/>
        SELECT 
           A.SPCEID
           , B.FCLTID
           , B.FCLT_NM
           , B.ADDR
           , B.ADDR_DTL
           , B.RPRS_IMG_FILEID
           , B.APLY_MTHD_CD
           , C.INSTID
           , C.INST_NM
           , D.FILE_IDNTFC_KEY AS RPRS_IMG_FILE_KEY
        FROM 
           TB_FCL_SPCE A
           INNER JOIN TB_FCL_FCLT B 
           ON A.FCLTID = B.FCLTID
           LEFT OUTER JOIN TB_CMM_INST C 
           ON B.INSTID = C.INSTID
           LEFT OUTER JOIN TB_CMM_FILE D 
           ON B.RPRS_IMG_FILEID = D.FILEID
        WHERE 1 = 1
          AND A.USE_YN = 'Y'
          AND B.USE_YN = 'Y'
        <if test="instNm != null and instNm != ''">
            AND C.INST_NM LIKE CONCAT('%',#{instNm},'%')
        </if>
        <if test="fcltNm != null and fcltNm != ''">
            AND B.FCLT_NM LIKE CONCAT('%',#{fcltNm},'%')
        </if>
        <if test="maxNope != null and maxNope != ''">
            AND A.MAX_NOPE >= #{maxNope}
        </if>
        <if test="searchSiGunGuCd != null and searchSiGunGuCd != '' ">
            AND SUBSTRING( B.RGN_CD,1,2)  =  #{searchSiGunGuCd}
        </if>
        <if test="searchAplyMthdCd != null and searchAplyMthdCd != '' ">
            AND B.APLY_MTHD_CD = #{searchAplyMthdCd}
        </if>
        <!-- 신청일 검색시작일  -->
        <if test="searchBgngDt != null and searchBgngDt != ''">
           AND EXISTS (
               SELECT 
                   DE 
                 FROM TB_FCL_SPCE_RSVTDE G 
                WHERE 1=1
                  AND A.SPCEID = G.SPCEID
                  AND G.RSVT_PSBLTY_YN = 'Y'
                  AND DE >= #{searchBgngDt}
                )
        </if>
        <!-- 신청일 검색종료일  -->
        <if test="searchEndDt  != null and searchEndDt != ''">
            AND EXISTS (
               SELECT 
                   DE 
                 FROM TB_FCL_SPCE_RSVTDE G 
                WHERE 1=1
                  AND A.SPCEID = G.SPCEID
                  AND G.RSVT_PSBLTY_YN = 'Y'
                  AND DE <![CDATA[<=]]> #{searchEndDt}
                )
        </if>
          GROUP BY B.FCLTID
        <include refid="PaginationMapper.footer"/>
    </select>

    <select id="selectResveEnvRvwList" resultType="front.EnvReqstVo">
        /* EnvReqstDao.selectResveEnvRvwList*/
        <include refid="PaginationMapper.header"/>
             SELECT 
               A.APLYID 
               ,A.APLCNTID 
               ,A.APLCNT_NM 
               ,A.RVW_CN 
               ,A.RVW_SCR  
               ,A.RVW_DT
               ,D.FCLTID
               ,D.SPCE_NM 
               ,E.ACNT 
              FROM 
               TB_FCL_SPCE_APLY A
               INNER JOIN TB_FCL_APLY_RSVTDE B
               ON A.APLYID = B.APLYID
               INNER JOIN TB_FCL_SPCE_RSVTDE C
               ON B.RSVTDEID = C.RSVTDEID 
               INNER JOIN TB_FCL_SPCE D
               ON C.SPCEID = D.SPCEID
               INNER JOIN TB_CMM_USER E
               ON A.APLCNTID = E.USERID 
             WHERE 1=1 
               AND A.RVW_SCR IS NOT NULL
               AND A.RVW_DT IS NOT NULL
               AND D.FCLTID = #{fcltid} 
             GROUP BY A.APLYID 
        <include refid="PaginationMapper.footer"/>
    </select>

    <!-- 환경교육시설 예약 상세조회 -->
    <select id="selectResveEnvInfo" resultType="front.EnvReqstVo">
        /* EnvReqstDao.selectResveEnvInfo */
        SELECT
            A.FCLTID
             , A.FCLT_NM
             , A.FCLT_NO
             , A.INSTID
             , A.ZIP
             , A.ADDR
             , A.ADDR_DTL
             , A.RGN_CD
             , A.APLY_MTHD_CD
             , A.EXTNL_URL
             , A.BANK_CD
             , A.BACNT_NO
             , A.DPSTR_NM
             , A.RPRS_IMG_FILEID
             , A.DTL_IMG_FILEGRPID
             , A.GDNC_FILEID
             , A.DTL_CN
             , A.USE_YN
             , A.MDFCN_DT
             , A.MDFRID
             , A.REG_DT
             , A.RGTRID
             , B.INST_NM
             , C.SIGNGU_NM AS RGN_NM
             , E.NM
        FROM
            TB_FCL_FCLT A
            LEFT OUTER JOIN TB_CMM_INST B 
            ON A.INSTID = B.INSTID
            LEFT OUTER JOIN TB_CMM_USER E 
            ON A.RGTRID = E.USERID
            INNER JOIN (
                   SELECT
                       A.SIGNGU_CD AS RGN_CD
                       ,B.CTPRVN_NM
                       ,A.SIGNGU_NM
                       ,A.CTPRVN_CD 
                     FROM
                       TB_CMM_ADDR_SIGNGU A 
                       INNER JOIN TB_CMM_ADDR_CTPRVN B 
                       ON A.CTPRVN_CD = B.CTPRVN_CD
            ) C ON C.RGN_CD = A.RGN_CD
        WHERE 1=1
          AND A.INSTID = B.INSTID
          AND FCLTID = #{fcltid}
    </select>

    <select id="selectSpceInfo" resultType="front.EnvReqstVo">
        /* EnvReqstDao.selectSpceInfo */
        SELECT
            A.SPCEID
             , A.FCLTID
             , A.SPCE_NM
             , A.SPCE_NO
             , A.MAX_NOPE
             , A.SIZE
             , A.CHKIN_HR
             , A.CHCKT_HR
             , A.NXTY_CHCKT_YN
             , A.RSVT_PSBLTY_DAYCNT
             , A.TODAY_RSVT_PSBLTY_YN
             , A.USE_YN
             , A.MDFCN_DT
             , A.MDFRID
             , A.REG_DT
             , A.RGTRID
             , B.BANK_CD
             , B.BACNT_NO
             , B.DPSTR_NM
             , B.FCLTID
             , B.FCLT_NM
             , B.FCLT_NO
             , B.ADDR
             , B.ADDR_DTL
             , B.APLY_MTHD_CD
             , C.INST_NM
             , C.INSTID
             , F.BGNG_DT
             , F.END_DT
         FROM
            TB_FCL_SPCE A
            INNER JOIN TB_FCL_FCLT B
            ON A.FCLTID = B.FCLTID
            INNER JOIN TB_CMM_INST C
            ON B.INSTID = C.INSTID
            INNER JOIN (SELECT SPCEID, MIN(BGNG_DT) BGNG_DT, MAX(END_DT) END_DT FROM TB_FCL_SPCE_RSVTDE F
            WHERE RSVTDEID IN(
                <foreach item="item" collection="rsvtdeids"  separator=",">
                    #{item}
                </foreach>
                )
        GROUP BY SPCEID) F ON A.SPCEID = F.SPCEID
        WHERE 1=1
          AND A.SPCEID = #{spceid}
    </select>

    <!-- 예약 등록(시설 예약) -->
    <insert id="insertResveEnvFclSpceAply" useGeneratedKeys="true" keyProperty="aplyid">
        /* EnvReqstDao.insertResveEnvFclAply */
        INSERT INTO TB_FCL_SPCE_APLY (
            APLCNTID
            ,INSTID
            ,APLCNT_NM
            ,APLCNT_MOBLPHON
            ,APLCNT_EML
            ,NOPE_ADULT
            ,NOPE_CHIL
            ,NOPE_INFNT
            ,UTZTN_PRPS
            ,AMT
            ,STLM_MTHD_CD
            ,DPST_BANK_CD
            ,DPST_BACNT
            ,PYR_NM
            ,APLY_DT
            ,APLY_STTS_CD
            ,STLM_STTS_CD
            ,MDFCN_DT
            ,MDFRID
            ,REG_DT
            ,RGTRID
        )VALUES
        (
             #{user.userid}
            ,#{aplcntNm}
            ,(SELECT INSTID FROM TB_CMM_USER WHERE USERID = #{user.userid} )
            ,#{aplcntMoblphon}
            ,#{aplcntEml}
            ,#{nopeAdult}
            ,#{nopeChil}
            ,#{nopeInfnt}
            ,#{utztnPrps}
            ,(SELECT IFNULL (SUM(AMT),0) FROM tb_fcl_spce_rsvtde WHERE RSVTDEID IN (
              <foreach item="item" collection="rsvtdeids"  separator=",">
                #{item}
              </foreach>
            ))
            ,'190101'
            ,(SELECT A.BANK_CD  FROM  TB_FCL_FCLT A INNER JOIN TB_FCL_SPCE B ON A.FCLTID = B. FCLTID WHERE B.SPCEID  = #{spceid} )
            ,(SELECT A.BACNT_NO FROM  TB_FCL_FCLT A INNER JOIN TB_FCL_SPCE B ON A.FCLTID = B. FCLTID WHERE B.SPCEID  = #{spceid} )
            ,#{pyrNm}
            ,NOW()
            ,'160101'
            ,'161101'
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
        )
    </insert>

    <!-- 예약 등록(시설 예약) -->
    <insert id="insertResveEnvFclAply" >
        /* EnvReqstDao.insertResveEnvFclAply */
        INSERT INTO TB_FCL_APLY_RSVTDE (
             APLYID,
             RSVTDEID,
             UTZTN_SE_CD,
             ALLDAY_YN,
             DE,
             BGNG_DT,
             END_DT,
             AMT,
             MDFCN_DT,
             MDFRID,
             REG_DT,
             RGTRID
        )
          SELECT
            #{aplyid}
            ,RSVTDEID
            ,UTZTN_SE_CD
            ,ALLDAY_YN
            ,DE
            ,BGNG_DT
            ,END_DT
            ,AMT
            ,NOW()
            ,#{user.userid}
            ,NOW()
            ,#{user.userid}
          FROM 
            TB_FCL_SPCE_RSVTDE 
         WHERE RSVTDEID IN (
                <foreach item="item" collection="rsvtdeids"  separator=",">
                #{item}
                </foreach>
            )  
    </insert>

    <!-- 예약 등록(시설 예약-히스토리) -->
    <insert id="insertResveEnvFclAplyHstry" useGeneratedKeys="true" keyProperty="aplyid">
        /* EnvReqstDao.insertResveEnvFclAply */
        INSERT INTO TB_FCL_SPCE_APLY_HSTRY (
            APLCNTID
            ,INSTID
            ,APLCNT_NM
            ,APLCNT_MOBLPHON
            ,APLCNT_EML
            ,NOPE_ADULT
            ,NOPE_CHIL
            ,NOPE_INFNT
            ,UTZTN_PRPS
            ,AMT
            ,STLM_MTHD_CD
            ,DPST_BANK_CD
            ,DPST_BACNT
            ,PYR_NM
            ,APLY_DT
            ,APLY_STTS_CD
            ,STLM_STTS_CD
            ,MDFCN_DT
            ,MDFRID
            ,REG_DT
            ,RGTRID
        )
          SELECT 
            APLCNTID
            ,INSTID
            ,APLCNT_NM
            ,APLCNT_MOBLPHON
            ,APLCNT_EML
            ,NOPE_ADULT
            ,NOPE_CHIL
            ,NOPE_INFNT
            ,UTZTN_PRPS
            ,AMT
            ,STLM_MTHD_CD
            ,DPST_BANK_CD
            ,DPST_BACNT
            ,PYR_NM
            ,APLY_DT
            ,APLY_STTS_CD
            ,STLM_STTS_CD
            ,MDFCN_DT
            ,MDFRID
            ,REG_DT
            ,RGTRID
           FROM 
             TB_FCL_SPCE_APLY   
        WHERE APLYID = #{aplyid}
    </insert>
    
    <!-- 공간 예약 일정 목록 -->
    <select id="selectFclRsvtdeList" resultType="map">
        /* SpceDao.selectFclRsvtdeList */
        SELECT 
           RSVTDEID
           ,SPCEID
           ,DE
           ,AMT
           ,ALLDAY_YN
           ,RSVT_PSBLTY_YN
         FROM 
           TB_FCL_SPCE_RSVTDE A
        WHERE 1=1
          AND A.RSVTDEID IN (
        <foreach item="item" collection="rsvtdeids"  separator=",">
            #{item}
        </foreach>
        )
    </select>

    <!--************* 공간 예약 일자 *************** -->
    <!-- 공간 예약 일자 목록 -->
    <select id="selectSpceRsvtdeList" parameterType="front.EnvReqstVo" resultType="front.EnvReqstVo">
       /* EnvReqstDao.selectSpceRsvtdeList */
       SELECT
           A.RSVTDEID
           ,DE
           ,date_format(A.BGNG_DT, '%H:%i' )   AS STRT_TM
           ,date_format(A.END_DT, '%H:%i' )    AS END_TM
           ,A.UTZTN_SE_CD
           ,A.ALLDAY_YN
           ,A.AMT
           ,A.RSVT_PSBLTY_YN
           ,A.BGNG_DT
           ,A.END_DT
           ,IFNULL(B.RSVTDEID, '0')         AS FULL_YN
           ,C.TODAY_RSVT_PSBLTY_YN
        FROM
           TB_FCL_SPCE_RSVTDE A
           LEFT OUTER JOIN (
               SELECT 
                    B.RSVTDEID
                 FROM 
                    TB_FCL_APLY_RSVTDE B
                    INNER JOIN TB_FCL_SPCE_APLY C 
                    ON B.APLYID = C.APLYID
                 WHERE 1=1
                    AND C.APLY_STTS_CD IN ('160101','160102')
                  GROUP BY B.RSVTDEID
           ) B ON A.RSVTDEID = B.RSVTDEID
           INNER JOIN TB_FCL_SPCE C ON A.SPCEID = C.SPCEID
        WHERE 1=1
          AND A.RSVT_PSBLTY_YN = 'Y'
          AND A.SPCEID = #{spceid}
<!--           AND  A.DE  >= date_format(NOW(),'%Y-%m-%d')
          AND  A.DE <![CDATA[<=]]> date_format(DATE_ADD(NOW(),INTERVAL C.RSVT_PSBLTY_DAYCNT DAY)  ,'%Y-%m-%d') -->
        <if test="utztnSe.equals('single')">
            AND A.UTZTN_SE_CD = '169102'
        </if>
        <if test="utztnSe.equals('range')">
            AND A.UTZTN_SE_CD = '169101'
        </if>
        <if test='de != null and de !=""'>
            AND A.DE = #{de}
        </if>
        <if test="startDt != null and startDt != '' ">
            AND A.DE <![CDATA[>=]]> #{startDt}
        </if>
        <if test="enddDt != null and enddDt != '' ">
            AND A.DE <![CDATA[<=]]> #{enddDt}
        </if>
        <!-- <if test="rsvtdeList != null and rsvtdeList.size!=0 ">
            AND A.DE IN
            (
            <foreach item="item" collection="rsvtdeList"  separator=",">
                #{item.de}
            </foreach>
            )
        </if> -->
    </select>
    
    <!-- 신청 예약중 실시간 예약 및 운영중지 상태 유무 확인 목록    -->
    <select id="selectReservedRsvtdeList"  parameterType="front.EnvReqstVo" resultType="front.AplyRsvtdeVo" >
             /* EnvReqstDao.selectSpceRsvtdeList */
             SELECT
               C.APLY_STTS_CD
               ,A.DE
               ,A.RSVT_PSBLTY_YN 
             FROM 
               TB_FCL_SPCE_RSVTDE A
               LEFT OUTER JOIN TB_FCL_APLY_RSVTDE B
               ON A.RSVTDEID  = B.RSVTDEID
               LEFT OUTER JOIN TB_FCL_SPCE_APLY C
               ON B.APLYID = C.APLYID 
            WHERE 1=1
              AND (C.APLY_STTS_CD IN ('160101','160102') OR A.RSVT_PSBLTY_YN ='N')
              AND A.RSVTDEID IN (
                <foreach item="item" collection="rsvtdeids"  separator=",">
                    #{item}
                </foreach>
                )
    </select>
    
    
    
</mapper>