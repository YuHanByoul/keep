<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : MemberDaoImpl.xml
	Description : 회원정보
-->
<mapper namespace="com.kbrainc.plum.front.member.model.MemberDao">
    
    <!-- 회원 탈퇴 -->
    <update id="updateMemberDel" parameterType="UserVo">
        /* front.MemberDao.updateMemberDel */
        UPDATE TB_CMM_USER 
        SET
            NM = NULL,
            MOBLPHON = NULL,
            TELNO = NULL,
            BRDT = NULL,
            GNDR = NULL,
            ZIP = NULL,
            ADDR = NULL,
            ADDR_DTL = NULL,
            SIGNGU_CD = NULL,
            DEL_YN = 'Y',
            ACNT_LOCK_YN = 'Y',
            ACNT_LOCK_CD = '101106',
            <if test="secsnRsn != null and secsnRsn != ''">
            SECSN_RSN = #{secsnRsn},
            </if>
            STTS_CD = '9',
            MDFCN_DT = NOW(),
            MDFRID = #{userid}
        WHERE
            USERID = #{userid}
    </update>
    
    <!-- 특정 userid의 간편로그인 정보 전체 삭제 -->
    <delete id="deleteEsylgnByUserid" parameterType="UserVo">
        /* front.MemberDao.deleteEsylgnByUserid */
        DELETE FROM TB_CMM_USER_ESYLGN WHERE USERID = #{userid}
    </delete>
    
    <!-- acnt에 해당하는 사용자 카운트 조회  -->
    <select id="checkDuplicationUser" parameterType="front.MemberVo" resultType="int">
        /* front.MemberDao.checkDuplicationUser */
        SELECT 
            COUNT(1)
	    FROM 
            TB_CMM_USER
	    WHERE
	        ACNT = #{acnt}
        LIMIT 1
    </select>
    
    <!-- ci에 해당하는 userid 조회  -->
    <select id="selectUseridByCI" parameterType="front.MemberVo" resultType="String">
        /* front.MemberDao.selectUseridByCI */
        SELECT 
            USERID
        FROM
            TB_CMM_USER
        WHERE
            CI = #{ci}
        AND DEL_YN = 'N' 
        LIMIT 1
    </select>
    
    <!-- ci에 해당하는 userid 조회  -->
    <select id="selectUserInfoByCI" parameterType="front.MemberVo" resultType="front.MemberVo">
        /* front.MemberDao.selectUseridByCI */
        SELECT 
            USERID,
            ACNT,
            NM,
            MOBLPHON,
            EML,
            ZIP,
            ADDR,
            ADDR_DTL,
            SIGNGU_CD,
            INSTID
        FROM
            TB_CMM_USER
        WHERE
            CI = #{ci}
        AND DEL_YN = 'N' 
        LIMIT 1
    </select>
    
    <!-- 부모ci와 이름에 해당하는 userid 조회  -->
    <select id="selectUseridByParntsCIandName" parameterType="front.MemberVo" resultType="String">
        /* front.MemberDao.selectUseridByParntsCIandName */
        SELECT 
            USERID
        FROM
            TB_CMM_USER
        WHERE
            CI_PARNTS = #{ciParnts}
        AND NM = #{nm}
        AND DEL_YN = 'N' 
        LIMIT 1
    </select>
    
    <!-- 사용자정보 저장 -->
    <insert id="insertMember" parameterType="front.MemberVo" useGeneratedKeys="true" keyProperty="userid">
        /* front.MemberDao.insertMember */
        INSERT INTO TB_CMM_USER
            (
                ACNT,
                PSWD,
                NM,
                MOBLPHON,
                EML,
                BRDT,
                GNDR,
                ZIP,
                ADDR,
                ADDR_DTL,
                SIGNGU_CD,
                TOS_AGRE_YN,
                PRIVCY_AGRE_YN,
                PRVC_THPTY_PVSN_AGRE_YN,
                CHILD_JOIN_AGRE_YN,
                WBZN_APLY_AGRE_YN,
                PRVC_VLDTY,
                ACNT_LOCK_YN,
                TMPR_PSWD_YN,
                PSWD_MDFCN_DT,
                STTS_CD,
                DEL_YN,
                BLCKLST_YN,
                CI,
                CI_PARNTS,
                MDFCN_DT,
                REG_DT
            )
            VALUES
            (
                #{acnt},
                #{pswd},
                #{nm},
                #{moblphon},
                #{eml},
                #{brdt},
                #{gndr},
                #{zip},
                #{addr},
                #{addrDtl},
                #{signguCd},
                #{tosAgreYn},
                #{privcyAgreYn},
                #{prvcThptyPvsnAgreYn},
                #{childJoinAgreYn},
                #{wbznAplyAgreYn},
                #{prvcVldty},
                'N',
                'N',
                NOW(),
                1,
                'N',
                'N',
                #{ci},
                #{ciParnts},
                NOW(),
                NOW()
            )
    </insert>
    
    <!-- 회원정보 수정(동의여부, 개인정보 유효기간만 update) -->
    <update id="updateMemberAgreYnAndPrvcVldty" parameterType="MemberVo">
        /* front.MemberDao.updateMemberAgreYnAndPrvcVldty */
        UPDATE 
            TB_CMM_USER 
        SET
            TOS_AGRE_YN = #{tosAgreYn},
            PRIVCY_AGRE_YN = #{privcyAgreYn},
            PRVC_THPTY_PVSN_AGRE_YN = #{prvcThptyPvsnAgreYn},
            CHILD_JOIN_AGRE_YN = #{childJoinAgreYn},
            WBZN_APLY_AGRE_YN = #{wbznAplyAgreYn},
            PRVC_VLDTY = NVL(#{prvcVldty}, 1),
            MDFCN_DT = NOW(),
            MDFRID = #{userid}
        WHERE USERID = #{userid}
    </update>
    
    <!-- 사용자 관심분야 저장 -->
    <insert id="insertItrstfld" parameterType="front.MemberVo" >
        /* front.MemberDao.insertItrstfld */
        INSERT INTO TB_CMM_USER_ITRSTFLD
            (
                USERID,
                ITRSTFLD_CD,
                MDFCN_DT,
                MDFRID,
                REG_DT,
                RGTRID
            )
            VALUES
            <foreach item="item" collection="itrstfldCds"  separator=",">
            (
                #{userid},
                #{item},
                NOW(),
                #{userid},
                NOW(),
                #{userid}
            )
            </foreach>
    </insert>

    <!-- 사용자 환경분야 저장 -->
    <insert id="insertEnvfld" parameterType="front.MemberVo" >
        /* front.MemberDao.insertItrstyfld */
        INSERT INTO TB_CMM_USER_ENVFLD
            (
                USERID,
                ENVFLD_CD,
                MDFCN_DT,
                MDFRID,
                REG_DT,
                RGTRID
            )
            VALUES
            <foreach item="item" collection="envfldCds"  separator=",">
            (
                #{userid},
                #{item},
                NOW(),
                #{userid},
                NOW(),
                #{userid}
            )
            </foreach>
    </insert>

    <!-- 기관풀 검색 리스트 조회  -->
    <select id="selectInstSearchList" parameterType="MemberInstSearchVo" resultType="MemberInstSearchVo">
        /* front.MemberDao.selectInstSearchList */
        <include refid="PaginationMapper.header"/>
            SELECT 
                ARTCLID,
                INST_NM, 
                INST_TYPE_CD, 
                BRNO
            FROM 
                TB_CMM_INST_POOL
            WHERE
                1 = 1
            <if test="instNm != null and instNm != ''">
            AND INST_NM LIKE CONCAT('%',#{instNm},'%')
            </if>
            <if test="brno != null and brno != ''">
            AND BRNO LIKE CONCAT('%',#{brno},'%')
            </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 기관 정보 조회(기관풀)  -->
    <select id="selectInstPoolInfo" parameterType="MemberInstSearchVo" resultType="MemberInstSearchVo">
        /* front.MemberDao.selectInstPoolInfo */
        SELECT 
            ARTCLID,
            INST_NM, 
            INST_TYPE_CD, 
            BRNO,
            RPRSV_NM,
            TELNO,
            ZIP,
            ADDR,
            ADDR_DTL
        FROM 
            TB_CMM_INST_POOL
        WHERE
            ARTCLID = #{artclid}
    </select>
    
    <!-- 사업자등록번호에 해당하는 기관POOL 정보 조회 -->
    <select id="selectInstPoolInfoByBrno" parameterType="MemberInstVo" resultType="MemberInstVo">
        /* front.MemberDao.selectInstPoolInfoByBrno */
        SELECT 
            INST_NM, 
            INST_TYPE_CD, 
            BRNO,
            RPRSV_NM,
            TELNO,
            ZIP,
            ADDR,
            ADDR_DTL
        FROM 
            TB_CMM_INST_POOL
        WHERE 
            BRNO = #{brno}
    </select>
    
    <!-- 기관 테이블 존재여부와 상태값, 기관담당자 존재여부 조회 -->
    <select id="selectInstInfoByBrno" parameterType="MemberInstVo" resultType="MemberInstVo">
        /* front.MemberDao.selectInstInfoByBrno */
        SELECT 
            I.INSTID,
            I.APRV_STTS_CD,
            (SELECT USERID FROM TB_CMM_USER WHERE INSTID = I.INSTID LIMIT 1) AS INST_USERID
        FROM 
            TB_CMM_INST I
        WHERE 
            I.BRNO = #{brno}
    </select>
    
    <!-- 기관정보 저장 -->
    <insert id="insertInst" parameterType="MemberInstVo" useGeneratedKeys="true" keyProperty="instid">
        /* front.MemberDao.insertInst */
        INSERT INTO TB_CMM_INST
            (
                INST_NM,
                INST_TYPE_CD,
                BRNO,
                RPRSV_NM,
                TELNO,
                FXNO,
                ZIP,
                ADDR,
                ADDR_DTL,
                RGN_CD,
                HMPG,
                LOGO_FILEID,
                FILEGRPID,
                APRV_STTS_CD,
                USE_YN,
                MDFCN_DT,
                MDFRID,
                REG_DT,
                RGTRID
            )
            VALUES
            (
                #{instNm},
                #{instTypeCd},
                #{brno},
                #{rprsvNm},
                #{telno},
                #{fxno},
                #{instZip},
                #{instAddr},
                #{instAddrDtl},
                #{instSignguCd},
                #{hmpg},
                #{bizlogoFileid},
                #{bizfileFilegrpid},
                '1',
                'Y',
                NOW(),
                #{userid},
                NOW(),
                #{userid}
            )
    </insert>
    
    <!-- 기관정보 수정 -->
    <update id="updateInst" parameterType="MemberInstVo">
        /* front.MemberDao.updateInst */
        UPDATE 
            TB_CMM_INST 
        SET
            INST_NM = #{instNm},
            INST_TYPE_CD = #{instTypeCd},
            BRNO = #{brno},
            RPRSV_NM = #{rprsvNm},
            TELNO = #{telno},
            FXNO = #{fxno},
            ZIP = #{instZip},
            ADDR = #{instAddr},
            ADDR_DTL = #{instAddrDtl},
            RGN_CD = #{instSignguCd},
            HMPG = #{hmpg},
            LOGO_FILEID = #{bizlogoFileid},
            FILEGRPID = #{bizfileFilegrpid},
            APRV_STTS_CD = '1',
            USE_YN = 'Y',
            MDFCN_DT = NOW(),
            MDFRID = #{userid}
        WHERE INSTID = #{instid}
    </update>
    
    <!-- 회원을 기관회원 마스터로 update -->
    <update id="updateUserInstMaster" parameterType="MemberInstVo">
        /* front.MemberDao.updateUserInstMaster */
        UPDATE 
            TB_CMM_USER 
        SET
            INSTID = #{instid},
            INSTPIC_ROLE_CD = '109101',
            MDFCN_DT = NOW(),
            MDFRID = #{userid}
        WHERE USERID = #{userid}
    </update>
    
    <!-- 기관 유형 코드 리스트 호출 --> 
    <select id="selectInstTypeCdList" parameterType="map" resultType="map">
        /* front.MemberDao.selectInstTypeCdList */
        SELECT 
            A.CD,
            concat(B.CD_NM,' > ',A.CD_NM ) CD_NM 
        FROM 
            TB_CMM_CD A INNER JOIN TB_CMM_CD B ON A.UPPR_CD = B.CD 
        WHERE
            A.USE_YN = 'Y'
        AND A.CDGRPID = '108'
    </select>
   
    <!-- 기관코드 수정 -->
    <update id="updateInstCd" parameterType="Integer">
        /* front.MemberDao.updateInstCd */
        UPDATE 
            TB_CMM_INST I
        SET
            INST_CD = CONCAT((SELECT OPTN1 FROM TB_CMM_CD WHERE CD = I.INST_TYPE_CD), INSTID + 100000)
        WHERE I.INSTID = #{instid}
    </update>
   
    <!-- ci 또는 휴대폰번호에 해당하는 회원과 어린이회원의 계정정보를 조회한다. -->
    <select id="selectAcntFromCiAndMoblphonList" parameterType="MemberAcntPswdFindVo" resultType="MemberAcntPswdFindVo">
        /* front.MemberDao.selectAcntFromCiAndMoblphonList */
        SELECT 
            ACNT,
            REG_DT
        FROM 
            TB_CMM_USER 
        WHERE
            CI = #{ci}
        AND DEL_YN = 'N'
        UNION
        SELECT 
            ACNT,
            REG_DT
        FROM 
            TB_CMM_USER 
        WHERE
            CI_PARNTS = #{ci}
        AND DEL_YN = 'N'
        UNION
        SELECT 
            ACNT,
            REG_DT
        FROM 
            TB_CMM_USER 
        WHERE
            MOBLPHON = #{moblphon}
        AND DEL_YN = 'N'
    </select>
   
    <!-- ci 또는 휴대폰번호가 일치하는 acnt에 해당하는 회원 정보를 조회한다. -->
    <select id="selectAcntFromCiAndMoblphon" parameterType="MemberAcntPswdFindVo" resultType="MemberAcntPswdFindVo">
        /* front.MemberDao.selectAcntFromCiAndMoblphon */
        SELECT 
            USERID,
            ACNT,
            PSWD
        FROM 
            TB_CMM_USER 
        WHERE
            (CI = #{ci} OR CI_PARNTS = #{ci} OR MOBLPHON = #{moblphon})
        AND ACNT = #{acnt}
        AND DEL_YN = 'N'
    </select>
    
    <!-- 비밀번호 수정(비밀번호 찾기). -->
    <update id="updatePassword" parameterType="MemberAcntPswdFindVo">
        /* front.MemberDao.updatePassword */
        UPDATE 
            TB_CMM_USER 
        SET
            PSWD = #{pswd},
            PSWD_MDFCN_DT = NOW(),
            MDFCN_DT = NOW(),
            MDFRID = #{userid}
        WHERE USERID = #{userid}
    </update>
    
    <!-- 사용자정보 조회 -->
    <select id="selectMemberInfo" parameterType="front.MemberVo" resultType="front.MemberVo">
        /* front.MemberDao.selectMemberInfo */
             SELECT
                A.USERID
               ,A.ACNT
               ,A.PSWD
               ,A.NM
               ,A.NCNM
               ,A.MOBLPHON
               ,A.TELNO
               ,A.EML
               ,A.BRDT
               ,A.GNDR
               ,A.ZIP
               ,A.ADDR
               ,A.ADDR_DTL
               ,A.INSTID
               ,A.INSTPIC_ROLE_CD
               ,A.TOS_AGRE_YN
               ,A.PRIVCY_AGRE_YN
               ,A.MARKT_EML_AGRE_YN
               ,A.MARKT_SMS_AGRE_YN
               ,A.PRVC_VLDTY
               ,A.ACNT_LOCK_YN
               ,A.ACNT_LOCK_CD
               ,A.TMPR_PSWD_YN
               ,A.PSWD_MDFCN_DT
               ,A.STTS_CD
               ,A.DEL_YN
               ,A.BLCKLST_YN
               ,A.LGN_DT
               ,A.LGN_FAIL_CNT
               ,A.MDFCN_DT
               ,A.MDFRID
               ,A.REG_DT
               ,A.RGTRID
               ,(SELECT GROUP_CONCAT(ITRSTFLD_CD SEPARATOR',') FROM TB_CMM_USER_ITRSTFLD  WHERE USERID = #{user.userid} ) AS ITRSTFLD_CD
               ,(SELECT GROUP_CONCAT(ENVFLD_CD SEPARATOR',') FROM TB_CMM_USER_ENVFLD  WHERE USERID = #{user.userid} ) AS ENVFLD_CD
               <!-- ,(SELECT GROUP_CONCAT(ESYLGN_CD SEPARATOR',') FROM TB_CMM_USER_ESYLGN  WHERE USERID = #{userid} ) AS ESYLGN_CD -->
               ,IFNULL(B.ROLECD ,'' ) AS ROLEIDS
               ,CASE WHEN INSTR(B.ROLECD,'1') > 0 OR INSTR(B.ROLECD,'5') > 0 THEN 'A'
                     WHEN A.INSTID IS NOT NULL THEN 'C'
                     ELSE 'U'
               END AS ROLECD
             FROM
               TB_CMM_USER A
               LEFT OUTER JOIN (
                 SELECT USERID , GROUP_CONCAT(ROLEID SEPARATOR  ',') AS ROLECD FROM TB_CMM_ROLE_USER  WHERE USERID = #{user.userid}
               )B
               ON(A.USERID =B.USERID)
           WHERE A.USERID = #{user.userid}
    </select>
</mapper>