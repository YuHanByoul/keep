<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : DsgnPrgrmDaoImpl.xml
    Description : 지정제심사 관리
-->
<mapper namespace="com.kbrainc.plum.front.dsgnPrgrm.model.DsgnPrgrmDao">

    <!-- selectDsgnSttusList -->
    <select id="selectDsgnSttusList" parameterType="front.DsgnPrgrmVo" resultType="front.DsgnPrgrmVo">
        <include refid="PaginationMapper.header"/>
        SELECT
            A.PRGRMID
          , A.INST_NM
          , A.PRGRM_NM
          , ADDR.CTPRVN_NM
          , A.INST_RGN_CD
          , CONCAT_WS(',',
             CASE WHEN B.INFNT = 'Y' THEN '유아' END
           , CASE WHEN B.SCHBOY = 'Y' THEN '초등' END
           , CASE WHEN B.MSKLSD = 'Y' THEN '중등' END
           , CASE WHEN B.HGSCHST = 'Y' THEN '고등' END
           , CASE WHEN B.ADULT = 'Y' THEN '성인' END
           ) AS EDU_TARGET
          , B.WHOL_AGE
          , CASE WHEN IFNULL(B.ETRFEE,0) > 0 THEN FORMAT(B.ETRFEE, '0') ELSE '무료' END ETRFEE
          , GROUP_CONCAT(CD1.CD_NM) AS EDU_SBJCT_NM_LST    /*교육 주제*/
          , NVL(OPERFRMCD.CD_NM, '') AS CD_NM
          , A.MDFCN_DT
          , A.REG_DT
          , D.FILEID
          , D.FILE_IDNTFC_KEY
        FROM
            TB_ASS_PRGRM A
        LEFT OUTER JOIN
            TB_ASS_PRGRM_DSTNCTN B ON A.PRGRMID =B.PRGRMID
        LEFT OUTER JOIN (SELECT PRGRMID, EDU_SBJCT_CD FROM TB_ASS_PRGRM_EDU_SBJCT) C ON A.PRGRMID = C.PRGRMID
        LEFT OUTER JOIN TB_CMM_CD CD1 ON C.EDU_SBJCT_CD = CD1.CD
        LEFT OUTER JOIN TB_CMM_CD CD2 ON CD1.UPPR_CD = CD2.CD
        LEFT OUTER JOIN (
            SELECT
                FILEID
              , FILEGRPID
              , FILE_IDNTFC_KEY
            FROM
                TB_CMM_FILE
            GROUP BY
                FILEGRPID
        ) D ON B.EDU_PHOTO_FILEGRPID = D.FILEGRPID
        LEFT OUTER JOIN
            TB_CMM_ADDR_CTPRVN ADDR ON A.INST_RGN_CD = ADDR.CTPRVN_CD
        LEFT OUTER JOIN TB_CMM_CD OPERFRMCD ON B.OPER_FRM_CD = OPERFRMCD.CD

        WHERE A.STTS_CD = 111111    <!-- 지정승인 -->
            <!-- 프로그램 명 -->
        <if test="searchPrgrmNm!= null and searchPrgrmNm != '' ">
            AND A.PRGRM_NM LIKE CONCAT('%',#{searchPrgrmNm},'%')
        </if>
            <!-- 운영기관 명 -->
        <if test="searchInstNm!= null and searchInstNm != '' ">
            AND A.INST_NM LIKE CONCAT('%',#{searchInstNm},'%')
        </if>
            <!-- 지역 코드-->
        <if test="searchRgnCd!= null and searchRgnCd != '' ">
            AND A.INST_RGN_CD = #{searchRgnCd}
        </if>

        <!-- 교육주제 -->
        <if test="searchManinEduSbjctCd != null and searchManinEduSbjctCd != ''">
        AND CD2.CD = #{searchManinEduSbjctCd}
        </if>
        <if test="searchMdleEduSbjctCd != null and searchMdleEduSbjctCd != ''">
        AND CD1.CD = #{searchMdleEduSbjctCd}
        </if>
            <!-- 교육대상 코드-->
        <if test="searchEduTarget!= null and searchEduTarget != '' ">
            AND CASE WHEN 'WHOL_AGE' = #{searchEduTarget} THEN 1=1
                     WHEN 'INFNT'    = #{searchEduTarget} THEN B.INFNT    = 'Y'
                     WHEN 'SCHBOY'   = #{searchEduTarget} THEN B.SCHBOY   = 'Y'
                     WHEN 'MSKLSD'   = #{searchEduTarget} THEN B.MSKLSD   = 'Y'
                     WHEN 'HGSCHST'  = #{searchEduTarget} THEN B.HGSCHST  = 'Y'
                     WHEN 'ADULT'    = #{searchEduTarget} THEN B.ADULT    = 'Y'
                END
        </if>
            <!-- 참가비.유료-->
        <if test="searchEtrfee != null and searchEtrfee == 'pchrg' "  >
            AND IFNULL(B.ETRFEE,0) > 0
        </if>
            <!-- 참가비.무료-->
        <if test="searchEtrfee != null and searchEtrfee == 'free' "  >
            AND B.ETRFEE <![CDATA[<]]> 1
        </if>
        GROUP BY A.PRGRMID
        ORDER BY A.REG_DT, A.PRGRMID
        <include refid="PaginationMapper.footer"/>
    </select>

    <select id="selectDsgnSttus" parameterType="front.DsgnPrgrmVo" resultType="front.DsgnPrgrmVo">
        /* front.DsgnPrgrmDao.selectDsgnSttus*/
        SELECT
            A.PRGRMID
          , A.PRGRM_NM
          , C.DSGN_NO
          , A.INSTID
          , A.INST_NM
          , A.INST_RGN_CD
          , D.RPRSV_NM
          , A.INST_ADDR
          , A.INST_DTLADDR
          , A.DSGN_DE
          , A.INST_HMPG
          , ADDR.CTPRVN_NM
          , B.STY_NIGHT
          , B.STY_DAYTM
          , B.STY_YN
          , CD.CD_NM
          , CONCAT_WS(', ',
                   CASE WHEN B.JAN  = 'Y' THEN '1월'  END
                 , CASE WHEN B.FEB  = 'Y' THEN '2월'  END
                 , CASE WHEN B.MAR  = 'Y' THEN '3월'  END
                 , CASE WHEN B.APR  = 'Y' THEN '4월'  END
                 , CASE WHEN B.MAY  = 'Y' THEN '5월'  END
                 , CASE WHEN B.JUNE = 'Y' THEN '6월'  END
                 , CASE WHEN B.JULY = 'Y' THEN '7월'  END
                 , CASE WHEN B.AUG  = 'Y' THEN '8월'  END
                 , CASE WHEN B.SEPT = 'Y' THEN '9월'  END
                 , CASE WHEN B.OCT  = 'Y' THEN '10월' END
                 , CASE WHEN B.NOV  = 'Y' THEN '11월' END
                 , CASE WHEN B.DCM  = 'Y' THEN '12월' END
                 ) AS TARGETMM
          , EDU.EDU_SBJCT_CD
          , GROUP_CONCAT(EDUCD.CD_NM separator ', ') AS EDU_SBJCT_CD_NM
          , CONCAT_WS(', ',
                   CASE WHEN B.INFNT   = 'Y' THEN '유아' END
                 , CASE WHEN B.SCHBOY  = 'Y' THEN '초등학생' END
                 , CASE WHEN B.MSKLSD  = 'Y' THEN '중학생' END
                 , CASE WHEN B.HGSCHST = 'Y' THEN '고등학생' END
                 , CASE WHEN B.ADULT   = 'Y' THEN '성인' END
                 ) AS EDU_TARGET
          , B.EDU_PLC
          , B.EDU_NOPE
          , CONCAT(B.EDU_HR, EDU_MNT) AS EDU_TIME
          , B.PCHRG_YN
          , CASE WHEN B.ETRFEE > 0 THEN CONCAT(FORMAT(B.ETRFEE, '0'), '원') ELSE '무료' END ETRFEE_STR
          , A.APLCNT_NM
          , A.APLCNT_MOBLPHON
          , B.EDU_PRPS
          , B.APPRO
          , B.DSTNCTN
          , B.EDU_CN
        FROM
            TB_ASS_PRGRM A
            LEFT OUTER JOIN TB_ASS_PRGRM_DSTNCTN B ON A.PRGRMID = B.PRGRMID
            LEFT OUTER JOIN (SELECT PRGRMID, DSGN_NO, DSGN_CYCL FROM TB_ASS_DSGN_HSTRY ORDER BY DSGN_CYCL DESC LIMIT 1) C ON A.PRGRMID = C.PRGRMID
            LEFT OUTER JOIN TB_CMM_INST D ON A.INSTID = D.INSTID
            LEFT OUTER JOIN TB_CMM_CD CD ON B.OPER_FRM_CD = CD.CD
            LEFT OUTER JOIN TB_CMM_ADDR_CTPRVN ADDR ON A.INST_RGN_CD = ADDR.CTPRVN_CD
            LEFT OUTER JOIN  TB_ASS_PRGRM_EDU_SBJCT EDU ON A.PRGRMID = EDU.PRGRMID
            LEFT OUTER JOIN TB_CMM_CD EDUCD ON EDU.EDU_SBJCT_CD = EDUCD.CD
        WHERE
            A.STTS_CD = 111111
        AND A.PRGRMID = #{prgrmid}
        GROUP BY A.PRGRMID
    </select>

    <!-- 교육주제 목록 조회 -->
    <select id="selectEduSbjctList" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        SELECT
            A.PRGRMID       /*프로그램아이디*/
          , B.EDU_SBJCT_CD  /*교육_주제_코드*/
          , B.MDFCN_DT      /*수정_일시*/
          , B.MDFRID        /*수정자아이디*/
          , B.REG_DT        /*등록_일시*/
          , B.RGTRID        /*등록자아이디*/
        FROM
            TB_ASS_PRGRM A
        LEFT OUTER JOIN
            TB_ASS_PRGRM_EDU_SBJCT B ON A.PRGRMID = B.PRGRMID
        WHERE 1=1
        AND A.PRGRMID = ${prgrmid}
    </select>

    <!-- 프로그램 교육사진 파일 목록 조회 -->
    <select id="selectEduPhotoFileList" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        /* front.DsgnPrgrmDao.selectEduPhotoFileList */
        SELECT
            C.FILEID
          , C.FILE_IDNTFC_KEY
        FROM
            TB_ASS_PRGRM A
            LEFT OUTER JOIN TB_ASS_PRGRM_DSTNCTN B ON A.PRGRMID = B.PRGRMID
            LEFT OUTER JOIN tb_cmm_file C ON B.EDU_PHOTO_FILEGRPID = C.FILEGRPID
        WHERE
            A.STTS_CD = 111111
            AND A.PRGRMID = #{prgrmid}
    </select>

    <!-- 프로그램 해당기업 프로그램 목록 조회 -->
    <select id="selectInstPrgrmList" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        /* front.DsgnPrgrmDao.selectInstPrgrmList */
            SELECT
                A.PRGRMID
              , A.PRGRM_NM
              , ADDR.CTPRVN_NM
              , A.INST_NM
              , CONCAT(CASE WHEN B.INFNT = 'Y' THEN '유아, 'ELSE '' END
                     , CASE WHEN B.SCHBOY = 'Y' THEN '초등학생, 'ELSE '' END
                     , CASE WHEN B.MSKLSD = 'Y' THEN '중학생, 'ELSE '' END
                     , CASE WHEN B.HGSCHST = 'Y' THEN '고등학생, 'ELSE '' END
                     , CASE WHEN B.ADULT = 'Y' THEN '성인'ELSE '' END
                     ) AS EDU_TARGET
              , B.WHOL_AGE
              , GROUP_CONCAT(EDUCD.CD_NM separator ', ') AS EDU_SBJCT_CD_NM
              , CASE WHEN B.ETRFEE > 0 THEN CONCAT(FORMAT(B.ETRFEE, '0'), '원') ELSE '무료' END ETRFEE_STR
              , C.DSGN_NO
              , A.DSGN_DE
              , A.REG_DT
            FROM
                TB_ASS_PRGRM A
                LEFT OUTER JOIN TB_ASS_PRGRM_DSTNCTN B ON A.PRGRMID = B.PRGRMID
                LEFT OUTER JOIN (SELECT PRGRMID, DSGN_NO, DSGN_CYCL FROM TB_ASS_DSGN_HSTRY ORDER BY DSGN_CYCL DESC LIMIT 1) C ON A.PRGRMID = C.PRGRMID
                LEFT OUTER JOIN TB_CMM_ADDR_CTPRVN ADDR ON A.INST_RGN_CD = ADDR.CTPRVN_CD
                LEFT OUTER JOIN  TB_ASS_PRGRM_EDU_SBJCT EDU ON A.PRGRMID = EDU.PRGRMID
                LEFT OUTER JOIN TB_CMM_CD EDUCD ON EDU.EDU_SBJCT_CD = EDUCD.CD
            WHERE
                A.STTS_CD = 111111
                AND A.INSTID = #{instid}
                AND A.PRGRMID NOT IN (#{prgrmid})
    </select>

    <!-- 프로그램 운영일정 목록 조회 -->
    <select id="selectPrgrmSchdlList" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        /* front.DsgnPrgrmDao.selectPrgrmSchdlList*/
        SELECT
            PRGRMID
          , SCHDLID
          , RND
          , BGNG_HR
          , BGNG_MNT
          , END_HR
          , END_MNT
          , CONCAT(BGNG_HR, "시 ",  BGNG_MNT,"분 ~ ", END_HR, "시 ",  END_MNT, "분") AS SCHDL
          , PRGRM_NM
          , CRS
          , REG_DT
          , RGTRID
          , MDFRID
        FROM
            TB_ASS_PRGRM_SCHDL    /*ASS_프로그램_일정*/
        WHERE PRGRMID = #{prgrmid}
    </select>

    <!-- 프로그램 운영일정 등록 -->
    <insert id="insertPrgrmSchdl" parameterType="front.dsgnPrgrmVo" >
        INSERT INTO
            TB_ASS_PRGRM_SCHDL (
                PRGRMID
              , RND
              , BGNG_HR
              , BGNG_MNT
              , END_HR
              , END_MNT
              , PRGRM_NM
              , CRS
              , MDFCN_DT
              , MDFRID
              , REG_DT
              , RGTRID
        ) VALUES(
                #{schdlArr.prgrmid }
              , #{schdlArr.rnd     }
              , #{schdlArr.bgngHr  }
              , #{schdlArr.bgngMnt }
              , #{schdlArr.endHr   }
              , #{schdlArr.endMnt  }
              , #{schdlArr.prgrmNm }
              , #{schdlArr.crs     }
              , NOW()
              , #{user.userid}
              , NOW()
              , #{user.userid}
        )
    </insert>

    <!-- 프로그램 운영일정 삭제 -->
    <delete id="deletePrgrmSchdl" parameterType="front.dsgnPrgrmVo" >
        DELETE FROM
            TB_ASS_PRGRM_SCHDL
        WHERE PRGRMID = #{prgrmid}
    </delete>

    <!-- 프로그램 대처계획 목록 조회 -->
    <select id="selectPlanList" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        /* front.DsgnPrgrmDao.selectPlanList */
        SELECT
            PLANID
          , PRGRMID
          , PRGRM_NM
          , SBSTN_PRGRM_NM
        FROM
            TB_ASS_EMRGCY_ACTN_PLAN
        WHERE 1=1
        AND PRGRMID = #{prgrmid}
    </select>

    <!-- 기관정보 조회 -->
    <select id="selectInstInfo" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        /* front.DsgnPrgrmDao.selectInstInfo*/
        SELECT
            A.INSTID
          , A.USERID    AS APLCNTID
          , A.NM        AS APLCNT_NM
          , A.ACNT
          , CONCAT(A.NM, '(',A.ACNT,')')    AS APLCNT_NM_ACNT
          , A.MOBLPHON       AS APLCNT_MOBLPHON
          , A.EML            AS APLCNT_EML
          , CD.CD_NM         AS INST_CD_NM
          , TYPE_CD.CD_NM    AS INST_TYPE_CD_NM
          , A.USERID    AS INST_PIC_NM
          , A.EML       AS INST_PIC_EML
          , B.INST_TYPE_CD
          , B.INST_NM
          , B.INST_CD
          , B.RGN_CD  AS INST_RGN_CD
          , SIGNGU.SIGNGU_CD
          , SIGNGU.SIGNGU_NM
          , B.BRNO
          , B.RPRSV_NM
          , B.TELNO
          , B.FXNO
          , B.ZIP
          , B.ZIP      AS INST_ZIP
          , B.ADDR     AS INST_ADDR
          , B.ADDR_DTL AS INST_DTLADDR
          , B.HMPG     AS INST_HMPG
          , B.LOGO_FILEID
          , B.APRV_STTS_CD
          , B.USE_YN
          , B.MDFCN_DT
          , B.MDFRID
          , B.REG_DT
          , B.RGTRID
        FROM
            TB_CMM_USER A
        INNER JOIN
            TB_CMM_INST B ON A.INSTID = B.INSTID
        LEFT OUTER JOIN
            TB_CMM_CD TYPE_CD ON B.INST_TYPE_CD = TYPE_CD.CD
        LEFT OUTER JOIN
            TB_CMM_CD CD ON B.INST_TYPE_CD = CD.CD
        LEFT OUTER JOIN TB_CMM_ADDR_SIGNGU SIGNGU ON B.RGN_CD = SIGNGU.SIGNGU_CD
        WHERE 1=1
            AND A.USERID = #{aplcntid}
    </select>

    <!-- 신청정보 조회 -->
    <select id="selectAplyInfo" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        /* front.DsgnPrgrmDao.selectAplyInfo*/
        SELECT
            A.PRGRMID
          , A.INSTID
          , A.APLCNTID
          , A.APLCNT_NM
          , A.APLCNT_EML
          , A.APLCNT_MOBLPHON
          , A.INST_NM
          , A.INST_EML
          , A.INST_CNTCT
          , A.INST_HMPG
          , A.INST_TYPE_CD
          , A.INST_RGN_CD
          , A.INST_ZIP
          , A.INST_ADDR
          , A.INST_DTLADDR
          , A.PRGRM_NM
          , A.FILEGRPID
          , A.STTS_CD
          , A.DSGN_CYCL
          , A.DSGN_NO
          , A.DSGN_DE
          , A.DSGN_BGNG_DE
          , A.DSGN_END_DE
          , A.AUTZRID
          , A.CHKLSTID
          , A.CNSLTNG_PRGRS_YN
          , A.CNSLTNGID
          , A.APLY_DT
          , B.PRGRMID    AS DSTNCTNID
          , B.AUG
          , B.STY_NIGHT
          , B.EDU_CN
          , B.HGSCHST
          , B.SCHBOY
          , B.OPER_FRM_CD
          , B.SEPT
          , B.JULY
          , B.EDU_PLC
          , B.JAN
          , B.STY_YN
          , B.EDU_PRPS
          , B.DSTNCTN
          , B.OCT
          , B.ACTN_MTHD
          , B.FEB
          , B.NOV
          , B.WHOL_AGE
          , B.STY_DAYTM
          , B.MAR
          , B.INFNT
          , B.MAY
          , B.EDU_MNT
          , B.EDU_CNT
          , B.EDU_HR
          , B.MSKLSD
          , B.PCHRG_YN
          , B.ADULT
          , B.APPRO
          , B.APR
          , B.WETHER_STTN
          , B.EDU_NOPE
          , B.ETRFEE
          , B.WHOL_MM
          , B.DCM
          , B.JUNE
          , B.EDU_PHOTO_FILEGRPID
        FROM
            TB_ASS_PRGRM A
        LEFT OUTER JOIN
            TB_ASS_PRGRM_DSTNCTN B ON A.PRGRMID = B.PRGRMID
        WHERE 1=1
        AND A.PRGRMID = #{prgrmid}
        <if test="sttsCd != null and sttsCd != ''">
            AND A.STTS_CD = #{sttsCd}
        </if>
        <if test="sttsCd == null or sttsCd == ''">
            AND A.STTS_CD = '111101'    /* 작성중 */
        </if>
    </select>

    <select id="getPrgrmid" parameterType="dsgnPrgrmVo" resultType="Integer">
        SELECT
            MAX(C.PRGRMID)    PRGRMID
        FROM
            TB_CMM_USER A
        INNER JOIN
            TB_CMM_INST B ON A.INSTID = B.INSTID
        LEFT OUTER JOIN
            TB_ASS_PRGRM C ON A.USERID = C.APLCNTID
        WHERE 1=1
            AND A.USERID = #{user.userid}
            AND C.STTS_CD = '111101'    /* 작성중 */
    </select>

    <!-- ASS 프로그램 등록 -->
    <insert id="insertPrgrmAssPrgrm" parameterType="front.dsgnPrgrmVo" >
        /* front.DsgnPrgrmDao.insertPrgrmAssPrgrm*/
        INSERT INTO TB_ASS_PRGRM
        (
            INSTID
          , APLCNTID
          , APLCNT_NM
          , APLCNT_EML
          , APLCNT_MOBLPHON
          , INST_NM
          , INST_EML
          , INST_CNTCT
          , INST_HMPG
          , INST_TYPE_CD
          , INST_RGN_CD
          , INST_ZIP
          , INST_ADDR
          , INST_DTLADDR
          , PRGRM_NM
          , FILEGRPID
          , STTS_CD
          , DSGN_CYCL
          , DSGN_NO
          , DSGN_DE
          , DSGN_BGNG_DE
          , DSGN_END_DE
          , AUTZRID
          , CHKLSTID
          , CNSLTNG_PRGRS_YN
          , CNSLTNGID
          , APLY_DT
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES
        (
            #{instid}
          , #{aplcntid}
          , #{aplcntNm}
          , #{aplcntEml}
          , #{aplcntMoblphon}
          , #{instNm}
          , #{instEml}
          , #{instCntct}
          , #{instHmpg}
          , #{instTypeCd}
          , #{instRgnCd}
          , #{instZip}
          , #{instAddr}
          , #{instDtladdr}
          , #{prgrmNm}
          , #{filegrpid}
          , #{sttsCd}
          , #{dsgnCycl}
          , #{dsgnNo}
          , #{dsgnDe}
          , #{dsgnBgngDe}
          , #{dsgnEndDe}
          , #{autzrid}
          , #{chklstid}
          , #{cnsltngPrgrsYn}
          , #{cnsltngid}
          , NOW()
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        )
    </insert>

    <!-- ASS 프로그램 수정 -->
    <update id="updateAssPrgrm" parameterType="front.dsgnPrgrmVo" >
        /* front.DsgnPrgrmDao.updatePrgrmAssPrgrm*/
        UPDATE TB_ASS_PRGRM SET
            MDFCN_DT          = NOW()
          , MDFRID            = #{user.userid}
<if test="aplcntEml      != null and aplcntEml      != ''">   APLCNT_EML        = #{aplcntEml        } </if>
<if test="aplcntMoblphon != null and aplcntMoblphon != ''"> , APLCNT_MOBLPHON   = #{aplcntMoblphon   } </if>
<if test="instNm         != null and instNm         != ''"> , INST_NM           = #{instNm           } </if>
<if test="instEml        != null and instEml        != ''"> , INST_EML          = #{instEml          } </if>
<if test="instCntct      != null and instCntct      != ''"> , INST_CNTCT        = #{instCntct        } </if>
<if test="instHmpg       != null and instHmpg       != ''"> , INST_HMPG         = #{instHmpg         } </if>
<if test="instTypeCd     != null and instTypeCd     != ''"> , INST_TYPE_CD      = #{instTypeCd       } </if>
<if test="instRgnCd      != null and instRgnCd      != ''"> , INST_RGN_CD       = #{instRgnCd        } </if>
<if test="instZip        != null and instZip        != ''"> , INST_ZIP          = #{instZip          } </if>
<if test="instAddr       != null and instAddr       != ''"> , INST_ADDR         = #{instAddr         } </if>
<if test="instDtladdr    != null and instDtladdr    != ''"> , INST_DTLADDR      = #{instDtladdr      } </if>
<if test="prgrmNm        != null and prgrmNm        != ''"> , PRGRM_NM          = #{prgrmNm          } </if>
<if test="filegrpid      != null and filegrpid      != ''"> , FILEGRPID         = #{filegrpid        } </if>
<if test="sttsCd         != null and sttsCd         != ''"> , STTS_CD           = #{sttsCd           } </if>
<if test="dsgnCycl       != null and dsgnCycl       != ''"> , DSGN_CYCL         = #{dsgnCycl         } </if>
<if test="dsgnNo         != null and dsgnNo         != ''"> , DSGN_NO           = #{dsgnNo           } </if>
<if test="dsgnDe         != null and dsgnDe         != ''"> , DSGN_DE           = #{dsgnDe           } </if>
<if test="dsgnBgngDe     != null and dsgnBgngDe     != ''"> , DSGN_BGNG_DE      = #{dsgnBgngDe       } </if>
<if test="dsgnEndDe      != null and dsgnEndDe      != ''"> , DSGN_END_DE       = #{dsgnEndDe        } </if>
<if test="autzrid        != null and autzrid        != ''"> , AUTZRID           = #{autzrid          } </if>
<if test="chklstid       != null and chklstid       != ''"> , CHKLSTID          = #{chklstid         } </if>
<if test="cnsltngPrgrsYn != null and cnsltngPrgrsYn != ''"> , CNSLTNG_PRGRS_YN  = #{cnsltngPrgrsYn   } </if>
<if test="cnsltngid      != null and cnsltngid      != ''"> , CNSLTNGID         = #{cnsltngid        } </if>
<if test="aplyDt         != null and aplyDt         != ''"> , APLY_DT           = #{aplyDt           } </if>
        WHERE PRGRMID = #{prgrmid}
    </update>

    <!-- 프로그램 우수성 등록 -->
    <insert id="insertPrgrmDstnctnForm" parameterType="front.dsgnPrgrmVo" >
    /* front.DsgnPrgrmDao.insertPrgrmDstnctn */
    INSERT
        INTO TB_ASS_PRGRM_DSTNCTN (
            PRGRMID
          , STY_YN
          , STY_NIGHT
          , STY_DAYTM
          , OPER_FRM_CD
          , JAN
          , FEB
          , MAR
          , APR
          , MAY
          , JUNE
          , JULY
          , AUG
          , SEPT
          , OCT
          , NOV
          , DCM
          , WHOL_MM
          , INFNT
          , SCHBOY
          , MSKLSD
          , HGSCHST
          , ADULT
          , WHOL_AGE
          , EDU_PLC
          , EDU_NOPE
          , EDU_CNT
          , EDU_HR
          , EDU_MNT
          , PCHRG_YN
          , ETRFEE
          , EDU_PRPS
          , APPRO
          , DSTNCTN
          , EDU_CN
          , WETHER_STTN
          , ACTN_MTHD
          , EDU_PHOTO_FILEGRPID
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
          ) VALUES (
            #{prgrmid          }
          , #{styYn            }
          , #{styNight         }
          , #{styDaytm         }
          , #{operFrmCd        }
          , #{jan              }
          , #{feb              }
          , #{mar              }
          , #{apr              }
          , #{may              }
          , #{june             }
          , #{july             }
          , #{aug              }
          , #{sept             }
          , #{oct              }
          , #{nov              }
          , #{dcm              }
          , #{wholMm           }
          , #{infnt            }
          , #{schboy           }
          , #{msklsd           }
          , #{hgschst          }
          , #{adult            }
          , #{wholAge          }
          , #{eduPlc           }
          , #{eduNope          }
          , #{eduCnt           }
          , #{eduHr            }
          , #{eduMnt           }
          , #{pchrgYn          }
          , #{etrfee           }
          , #{eduPrps          }
          , #{appro            }
          , #{dstnctn          }
          , #{eduCn            }
          , #{wetherSttn       }
          , #{actnMthd         }
          , #{eduPhotoFilegrpid}
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
          )
    </insert>

    <!-- 프로그램 우수성 수정 -->
    <update id="updatePrgrmDstnctnForm" parameterType="front.dsgnPrgrmVo" >
    /* front.DsgnPrgrmDao.updatePrgrmDstnctn */
        UPDATE
            TB_ASS_PRGRM_DSTNCTN
        SET
            STY_YN                  = #{styYn            }
          , STY_NIGHT               = #{styNight         }
          , STY_DAYTM               = #{styDaytm         }
          , OPER_FRM_CD             = #{operFrmCd        }
          , JAN                     = #{jan              }
          , FEB                     = #{feb              }
          , MAR                     = #{mar              }
          , APR                     = #{apr              }
          , MAY                     = #{may              }
          , JUNE                    = #{june             }
          , JULY                    = #{july             }
          , AUG                     = #{aug              }
          , SEPT                    = #{sept             }
          , OCT                     = #{oct              }
          , NOV                     = #{nov              }
          , DCM                     = #{dcm              }
          , WHOL_MM                 = #{wholMm           }
          , INFNT                   = #{infnt            }
          , SCHBOY                  = #{schboy           }
          , MSKLSD                  = #{msklsd           }
          , HGSCHST                 = #{hgschst          }
          , ADULT                   = #{adult            }
          , WHOL_AGE                = #{wholAge          }
          , EDU_PLC                 = #{eduPlc           }
          , EDU_NOPE                = #{eduNope          }
          , EDU_CNT                 = #{eduCnt           }
          , EDU_HR                  = #{eduHr            }
          , EDU_MNT                 = #{eduMnt           }
          , PCHRG_YN                = #{pchrgYn          }
          , ETRFEE                  = #{etrfee           }
          , EDU_PRPS                = #{eduPrps          }
          , APPRO                   = #{appro            }
          , DSTNCTN                 = #{dstnctn          }
          , EDU_CN                  = #{eduCn            }
          , WETHER_STTN             = #{wetherSttn       }
          , ACTN_MTHD               = #{actnMthd         }
          , EDU_PHOTO_FILEGRPID     = #{eduPhotoFilegrpid}
          , MDFCN_DT                = NOW()
          , MDFRID                  = #{user.userid      }
        WHERE
            PRGRMID = #{prgrmid}
    </update>

    <!-- 체크리스트 정보 조회 -->
    <select id="selectChkListInfo" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        /* front.DsgnPrgrmDao.selectChkListInfo*/
        SELECT
            A.PRGRMID
          , A.APLCNTID
          , A.STTS_CD
          , IFNULL(A.CHKLSTID ,C.CHKLSTID)    AS CHKLSTID
          , B.OPER_FRM_CD
          , CD.CD_NM
          , D.SBMSNID
        FROM TB_ASS_PRGRM A
        LEFT OUTER JOIN
            TB_ASS_PRGRM_DSTNCTN B ON A.PRGRMID = B.PRGRMID
        LEFT OUTER JOIN TB_CMM_CD CD ON B.OPER_FRM_CD = CD.CD
        LEFT OUTER JOIN TB_ASS_CHKLST C ON B.OPER_FRM_CD = C.OPER_FRM_CD AND C.USE_YN ='Y'
        LEFT OUTER JOIN TB_ASS_CHKLST_SBMSN D ON A.PRGRMID = D.PRGRMID
                                             AND A.CHKLSTID = D.CHKLSTID
                                             AND D.SBMSN_SE_CD =#{sbmsnSeCd}   /*신청자 자가진단*/
        WHERE A.PRGRMID = #{prgrmid}
    </select>

    <!-- 프로그램 평가 체계 조회 -->
    <select id="selectPrgrmEvlForm" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        /* front.DsgnPrgrmDao.selectPrgrmEvlForm*/
        SELECT
            A.PRGRMID                /* 프로그램아이디 */
          , B.PRGRMID    AS EVLID
          , B.EVL_PRPS               /* 평가_목적 */
          , B.BFR_LDR_EVL_ARTCL      /* 사전_지도자_평가_항목 */
          , B.BFR_LDR_EVL_TL         /* 사전_지도자_평가_도구 */
          , B.AFTR_LDR_EVL_ARTCL     /* 사후_지도자_평가_항목 */
          , B.AFTR_LDR_EVL_TL        /* 사후_지도자_평가_도구 */
          , B.BFR_PRTPNT_EVL_ARTCL   /* 사전_참여자_평가_항목 */
          , B.BFR_PRTPNT_EVL_TL      /* 사전_참여자_평가_도구 */
          , B.AFTR_PRTPNT_EVL_ARTCL  /* 사후_참여자_평가_항목 */
          , B.AFTR_PRTPNT_EVL_TL     /* 사후_참여자_평가_도구 */
          , B.BFR_GDR_EVL_ARTCL      /* 사전_인솔자_평가_항목 */
          , B.BFR_GDR_EVL_TL         /* 사전_인솔자_평가_도구 */
          , B.AFTR_GDR_EVL_ARTCL     /* 사후_인솔자_평가_항목 */
          , B.AFTR_GDR_EVL_TL        /* 사후_인솔자_평가_도구 */
          , B.DATABASE_WRT_YN        /* 데이터베이스_작성_여부 */
          , B.CLSJRNL_WRT_YN         /* 수업일지_작성_여부 */
          , B.ETC_YN                 /* 기타_여부 */
          , B.ETC_CN                 /* 기타_내용 */
          , B.MDFCN_DT               /* 수정_일시 */
          , B.MDFRID                 /* 수정자아이디 */
          , B.REG_DT                 /* 등록_일시 */
          , B.RGTRID                 /* 등록자아이디 */
        FROM TB_ASS_PRGRM A
        LEFT OUTER JOIN TB_ASS_PRGRM_EVL B    /* ASS_프로그램_평가 */
            ON A.PRGRMID= B.PRGRMID
        WHERE 1=1
        AND A.PRGRMID = #{prgrmid}
    </select>

    <!-- 컨설팅 등록 -->
    <insert id="insertCsltng" parameterType="front.dsgnPrgrmVo" >
        /* front.DsgnPrgrmDao.insertCsltng*/
        INSERT INTO TB_ASS_CNSLTNG
        (
            INSTID
          , USERID
          , USER_NM
          , PIC_TELNO
          , INST_TELNO
          , PIC_EML
          , ADDR
          , ADDR_DTL
          , PRGRM_NM
          , CNSLTNG_KND_CD
          , HOPE_DE1
          , HOPE_DE2
          , PRGRM
          , LDR
          , ETC
          , FILEGRPID
          , STTS_CD
          , MDFCN_DT
          , MDFRID
          , REG_DT
          , RGTRID
        ) VALUES
        (
            #{instid       }
          , #{user.userid       }
          , #{userNm       }
          , #{picTelno     }
          , #{instTelno    }
          , #{picEml       }
          , #{addr         }
          , #{addrDtl      }
          , #{prgrmNm      }
          , #{cnsltngKndCd }
          , #{hopeDe1      }
          , #{hopeDe2      }
          , #{prgrm        }
          , #{ldr          }
          , #{etc          }
          , #{filegrpid    }
          , #{sttsCd       }
          , NOW()
          , #{user.userid}
          , NOW()
          , #{user.userid}
        )
    </insert>

    <select id="selectCsltngList" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        SELECT
            A.CNSLTNGID            /*컨설팅아이디*/
          , A.INSTID               /*기관아이디*/
          , A.USERID               /*사용자아이디*/
          , A.USER_NM              /*사용자_이름*/
          , A.PIC_TELNO            /*담당자_전화번호*/
          , A.INST_TELNO           /*기관_전화번호*/
          , A.PIC_EML              /*담당자_이메일*/
          , A.ZIP                  /*우편번호*/
          , A.ADDR                 /*주소*/
          , A.ADDR_DTL             /*주소_상세*/
          , A.PRGRM_NM             /*프로그램_이름*/
          , A.CNSLTNG_KND_CD       /*컨설팅_종류_코드*/
          , A.HOPE_DE1             /*희망_일자1*/
          , A.HOPE_DE1_AM_PM_CD    /*희망_일자1_오전_오후_코드*/
          , A.HOPE_DE2             /*희망_일자2*/
          , A.HOPE_DE2_AM_PM_CD    /*희망_일자2_오전_오후_코드*/
          , A.PRGRM                /*프로그램*/
          , A.LDR                  /*지도자*/
          , A.SFTYMNG              /*안전관리*/
          , A.ETC                  /*기타*/
          , A.FILEGRPID            /*파일그룹아이디*/
          , A.STTS_CD              /*상태_코드*/
          , A.SRVYID               /*설문아이디*/
          , A.MDFCN_DT             /*수정_일시*/
          , A.MDFRID               /*수정자아이디*/
          , A.REG_DT               /*등록_일시*/
          , A.RGTRID               /*등록자아이디*/
        FROM TB_ASS_CNSLTNG A
        WHERE A.USERID = #{user.userid}
    </select>

    <!-- 컨설팅 수정 -->
    <update id="updateCsltng" parameterType="front.dsgnPrgrmVo" >
        /* front.DsgnPrgrmDao.updateCsltng*/
        UPDATE TB_ASS_CNSLTNG SET
            INSTID            = #{instid}           /*기관아이디*/
          , USERID            = #{user.userid}      /*사용자아이디*/
          , USER_NM           = #{userNm}           /*사용자_이름*/
          , PIC_TELNO         = #{picTelno}         /*담당자_전화번호*/
          , INST_TELNO        = #{instTelno}        /*기관_전화번호*/
          , PIC_EML           = #{picEml}           /*담당자_이메일*/
          , ADDR              = #{addr}             /*주소*/
          , ADDR_DTL          = #{addrDtl}          /*주소_상세*/
          , PRGRM_NM          = #{prgrmNm}          /*프로그램_이름*/
          , CNSLTNG_KND_CD    = #{cnsltngKndCd}     /*컨설팅_종류_코드*/
          , HOPE_DE1          = #{hopeDe1}          /*희망_일자1*/
          , HOPE_DE2          = #{hopeDe2}          /*희망_일자2*/
          , PRGRM             = #{prgrm}            /*프로그램*/
          , LDR               = #{ldr}              /*지도자*/
          , ETC               = #{etc}              /*기타*/
          , FILEGRPID         = #{filegrpid}        /*파일그룹아이디*/
          , STTS_CD           = #{sttsCd}           /*상태_코드*/
          , MDFCN_DT          = NOW()               /*수정_일시*/
          , MDFRID            = #{user.userid}      /*수정자아이디*/
        WHERE
            CNSLTNGID         = #{cnsltngid}        /*컨설팅아이디*/
    </update>

    <!-- 지정제 프로그램 컨설팅id 수정 -->
    <update id="updateCnsltngid" parameterType="front.dsgnPrgrmVo" >
        /* front.DsgnPrgrmDao.updatePrgrm */
        UPDATE TB_ASS_PRGRM SET
            CNSLTNGID           = #{cnsltngid}    /* 컨설텅아이디 */
          , MDFCN_DT            = NOW()                /* 수정_일시 */
          , MDFRID              = #{user.userid}    /* 수정자아이디 */
        WHERE PRGRMID = #{prgrmid}
    </update>

    <!-- 컨설팅아이디 조회 -->
    <select id="selectCnsltngid" parameterType="front.dsgnPrgrmVo" resultType="int">
        SELECT
            max(CNSLTNGID) CNSLTNGID
        FROM TB_ASS_CNSLTNG
        WHERE INSTID = #{instid}
        AND   USERID = #{user.userid}
    </select>

    <!-- 신청내역목록 조회 -->
    <select id="selectAplyDsctnList" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        /* front.DsgnPrgrmDao.selectAplyDsctnList*/
        <if test="opner!='aply'">
            <include refid="PaginationMapper.header"/>
        </if>
        SELECT
           A.PRGRMID  /*프로그램아이디*/
         , A.INSTID    /*기관아이디*/
         , A.APLCNTID   /*신청자아이디*/
         , A.PRGRM_NM  /*프로그램_이름*/
         , A.STTS_CD   /*상태_코드*/
         , A.APLY_DT   /*신청_일시*/
         , CONCAT(B.VST_DE , " " , B.VST_HR , ":" , B.VST_MNT) AS VST_DT
        FROM
            TB_ASS_PRGRM A
        LEFT OUTER JOIN
            TB_ASS_SPRTGRP_SRNG B ON A.PRGRMID  = B.PRGRMID
        WHERE 1=1
        AND APLCNTID = #{aplcntid}
        AND A.STTS_CD IN (111101,111102)
            <!-- 프로그램 명 -->
        <if test="searchPrgrmNm!= null and searchPrgrmNm != '' ">
            AND A.PRGRM_NM LIKE CONCAT('%',#{searchPrgrmNm},'%')
        </if>
            <!-- 상태 코드-->
        <if test="searchSttsCd!= null and searchSttsCd != '' ">
            AND A.STTS_CD = #{searchSttsCd}
        </if>
        <if test="opner!='aply'">
            <include refid="PaginationMapper.footer"/>
        </if>
    </select>

    <!-- 체크리스트 문항 목록 조회 -->
    <select id="selectQitemList" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        WITH CHK_LST AS (
                SELECT
                   A.CHKLSTID
                 , B.ORDR   DP2ORDR
                 , D.ORDR   DP1ORDR
                 , CD1D.CD  DP1
                 , CD2D.CD  DP2
                 , ROW_NUMBER() OVER(PARTITION BY C.SE_CD ORDER BY B.ORDR ASC) AS QROW
                 , C.SE_CD
                 , CD1D.CD_NM DB1CN
                 , CD2D.CD_NM DP2CN
                 , B.QITEMID
                 , C.CN
                 , C.ALTM
               FROM TB_ASS_CHKLST A
               LEFT OUTER JOIN TB_ASS_CHKLST_QITEM_MAPNG B ON A.CHKLSTID = B.CHKLSTID
               LEFT OUTER JOIN TB_ASS_CHKLST_QITEM C ON B.QITEMID = C.QITEMID
               LEFT OUTER JOIN TB_ASS_CHKLST_SE_ORDR D ON A.CHKLSTID = D.CHKLSTID AND C.SE_CD = D.SE_CD
               LEFT OUTER JOIN TB_CMM_CD CD2D ON C.SE_CD = CD2D.CD
               LEFT OUTER JOIN TB_CMM_CD CD1D ON CD2D.UPPR_CD = CD1D.CD
               WHERE A.CHKLSTID = #{chklstid}
               ORDER BY D.ORDR ,B.ORDR
        )
        SELECT  DP1 , DP2 , CN , LV , ORDR , QITEMID , ALTM, QROW FROM
        (
            SELECT
                DP1
              , DP2
              , DB1CN     AS CN
              , '1'       AS LV
              , DENSE_RANK() OVER(PARTITION BY QROW ORDER BY DP1ORDR) ORDR
              , 0         AS QITEMID
              , 0         AS ALTM
              , 0         AS QROW
            FROM CHK_LST A
            GROUP BY DP1
            UNION ALL
            SELECT
                DP1
              , DP2
              , DP2CN    AS CN
              , '2'      AS LV
              , DENSE_RANK() OVER(PARTITION BY QROW ORDER BY DP1ORDR) ORDR
              , 0        AS QITEMID
              , 0        AS ALTM
              , 0        AS QROW
            FROM CHK_LST A
            GROUP BY DP2
            UNION ALL
            SELECT
                DP1
              , DP2
              , CN       AS  CN
              , '3'      AS  LV
              , DENSE_RANK() OVER(PARTITION BY QROW ORDER BY DP1ORDR) ORDR
              , QITEMID
              , ALTM
              , QROW
            FROM CHK_LST A
            GROUP BY A.QITEMID
            ORDER BY ORDR
        ) AA
        ORDER BY AA.DP1, AA.DP2,AA.LV, AA.ORDR, QROW


    </select>

    <select id="selectChkAnsList" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        SELECT
            SBMSNID       /*제출아이디*/
          , QITEMID       /*문항아이디*/
          , SE_CD         /*구분_코드*/
          , CN            /*내용*/
          , IDNTY_MTTR    /*확인_사항*/
          , SCR           /*점수*/
          , ORDR          /*순서*/
          , MDFCN_DT      /*수정_일시*/
          , MDFRID        /*수정자아이디*/
          , REG_DT        /*등록_일시*/
          , RGTRID        /*등록자아이디*/
        FROM TB_ASS_CHKLST_ANS
        WHERE SBMSNID = #{sbmsnid}
    </select>

    <select id="selectSplmntDmnd" parameterType="front.dsgnPrgrmVo" resultType="front.dsgnPrgrmVo">
        /* front.DsgnPrgrmDao.selectSplmntDmnd*/
            SELECT
            SPLMNT_DMNDID    /* 보완_요청아이디 */
          , PRGRMID          /* 프로그램아이디 */
          , STTS_CD          /* 상태_코드 */
          , OPNN_CN          /* 의견_내용 */
          , CMPTN_PRCS_DE    /* 완료_처리_일자 */
          , MDFCN_DT         /* 수정_일시 */
          , MDFRID           /* 수정자아이디 */
          , REG_DT           /* 등록_일시 */
          , RGTRID           /* 등록자아이디 */
        FROM
            TB_ASS_PRGRM_SPLMNT_DMND
        WHERE 1=1
        AND SPLMNT_DMNDID = #{splmntDmndid}
    </select>



</mapper>