<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : MyInfoDaoImpl.xml
	Description : 내 정보 수정
-->
<mapper namespace="com.kbrainc.plum.front.myInfo.model.MyInfoDao">

    <!-- 사용자정보 조회 -->
    <select id="selectMemberInfo" parameterType="front.MemberVo" resultType="front.MemberVo">
             SELECT
                 A.USERID
               , A.ACNT
               , A.NM
               , A.PSWD
               , A.MOBLPHON
               , A.TELNO
               , A.EML
               , A.BRDT
               , A.GNDR
               , A.SIGNGU_CD
               , A.ZIP
               , A.ADDR
               , A.ADDR_DTL
               ,(SELECT GROUP_CONCAT(ITRSTFLD_CD SEPARATOR',') FROM TB_CMM_USER_ITRSTFLD  WHERE USERID = #{user.userid} ) AS ITRSTFLD_CD
               ,(SELECT GROUP_CONCAT(ENVFLD_CD SEPARATOR',') FROM TB_CMM_USER_ENVFLD  WHERE USERID = #{user.userid} ) AS ENVFLD_CD
               , A.PRVC_VLDTY
             FROM
               TB_CMM_USER A
               LEFT OUTER JOIN (
                 SELECT USERID , GROUP_CONCAT(ROLEID SEPARATOR  ',') AS ROLECD FROM TB_CMM_ROLE_USER  WHERE USERID = #{user.userid}
               )B
               ON(A.USERID =B.USERID)
           WHERE A.USERID = #{user.userid}
    </select>
    
    <!-- 내 정보 수정 -->
    <update id="updateMyInfo" parameterType="front.MemberVo">
        UPDATE TB_CMM_USER SET
        	MOBLPHON  = #{moblphon}
          , EML       = #{eml}
          , SIGNGU_CD = #{signguCd}
          , ZIP       = #{zip}
          , ADDR      = #{addr}
          , ADDR_DTL  = #{addrDtl}
          , PRVC_VLDTY = #{prvcVldty}
          , MDFCN_DT  = NOW()
          , MDFRID    = #{user.userid}
        WHERE
        	USERID = #{userid}
    </update>
    
    <!-- 관심분야 삭제 -->
    <delete id="deleteItrstfld" parameterType="front.MemberVo">
        DELETE FROM TB_CMM_USER_ITRSTFLD
        WHERE
            USERID = #{userid}
    </delete>
    
    <!-- 사용자 관심분야 저장 -->
    <insert id="insertItrstfld" parameterType="front.MemberVo" >
        /* front.MemberDao.insertItrstfld */
        INSERT INTO TB_CMM_USER_ITRSTFLD
            (
                USERID,
                ITRSTFLD_CD,
                MDFCN_DT,
                MDFRID,
                REG_DT,
                RGTRID
            )
            VALUES
            <foreach item="item" collection="itrstfldCds"  separator=",">
            (
                #{userid},
                #{item},
                NOW(),
                #{userid},
                NOW(),
                #{userid}
            )
            </foreach>
    </insert>
    
    <!-- 사용자 환경분야 삭제 -->
    <delete id="deleteEnvfld" parameterType="front.MemberVo">
        DELETE FROM TB_CMM_USER_ENVFLD
        WHERE
            USERID = #{userid}        
    </delete>

    <!-- 사용자 환경분야 저장 -->
    <insert id="insertEnvfld" parameterType="front.MemberVo" >
        INSERT INTO TB_CMM_USER_ENVFLD
            (
                USERID,
                ENVFLD_CD,
                MDFCN_DT,
                MDFRID,
                REG_DT,
                RGTRID
            )
            VALUES
            <foreach item="item" collection="envfldCds"  separator=",">
            (
                #{userid},
                #{item},
                NOW(),
                #{userid},
                NOW(),
                #{userid}
            )
            </foreach>
    </insert>
    
    <!-- 비밀전호 변경 -->
    <update id="updatePswd" parameterType="front.MemberVo">
        UPDATE TB_CMM_USER SET
            PSWD      = #{pswd}
          , MDFCN_DT  = NOW()
          , MDFRID    = #{user.userid}
        WHERE
            USERID = #{user.userid}
    </update>    
    
</mapper>
