<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
	SQL File Name : BookDaoImpl.xml
	Description : 우수환경도서 
-->
<mapper namespace="com.kbrainc.plum.front.book.model.BookDao">
    
    <!-- 우수환경도서 게시글 목록 조회 -->
    <select id="selectBookList" parameterType="front.BookVo" resultType="front.BookVo">
        /* BookDao.selectBookList */
        <include refid="PaginationMapper.header"/>
        SELECT 
           A.*
          FROM 
          (
           SELECT
                A.BOOKID
                , A.TTL
                , A.EDU_TRGT_CD
                , A.WRITR
                , A.WRITR_PICTR                
                , A.PLSCMPN 
                , A.RPRS_IMG_FILEID
                , A.CPYRHT_CD
                , E.FILE_IDNTFC_KEY
                , NVL(A.HITS,0) AS HITS
                , DATE(A.REG_DT) AS REG_DT
                ,GROUP_CONCAT(B.EDU_SBJCT_CD) AS EDUSBJCTCD 
                ,GROUP_CONCAT(DISTINCT  LEFT(B.EDU_SBJCT_CD,6)) AS UPPR_EDUSBJCTCD 
            FROM
                TB_CMM_BOOK A
                LEFT OUTER JOIN TB_CMM_BOOK_SBJCT B ON A.BOOKID = B.BOOKID 
                LEFT OUTER JOIN TB_CMM_FILE E ON A.RPRS_IMG_FILEID = E.FILEID
               GROUP BY A.BOOKID
               ) A
            WHERE 1=1
            <!-- 키워드 -->
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchTtl'">
            AND A.TTL LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchCn'">
            AND A.CN LIKE CONCAT('%',#{searchKeyword},'%')
            </if>
            <if test="searchKeyword != null and searchKeyword != '' and searchType == 'searchTtlCn'">
            AND (A.TTL LIKE CONCAT('%',#{searchKeyword},'%') OR A.CN LIKE CONCAT('%',#{searchKeyword},'%'))
            </if>
            
            <!-- 작가/출판사 -->
            <if test="searchKeyword2 != null and searchKeyword2 != '' and searchType2 == 'searchWritr'">
            AND A.WRITR LIKE CONCAT('%',#{searchKeyword2},'%')
            </if>
            <if test="searchKeyword2 != null and searchKeyword2 != '' and searchType2 == 'searchWritrPictr'">
            AND A.WRITR_PICTR LIKE CONCAT('%',#{searchKeyword2},'%')
            </if>
            <if test="searchKeyword2 != null and searchKeyword2 != '' and searchType2 == 'searchPlscmpn'">
            AND A.PLSCMPN LIKE CONCAT('%',#{searchKeyword2},'%')
            </if>            
            
            <!-- 교육대상 -->
            <if test="searchEduTrgtCd != null and searchEduTrgtCd != ''">
            AND EDUTRGTCD = #{searchEduTrgtCd}
            </if>
            
            <!-- 교육주제 -->
            <if test="searchManinEduSbjctCd != null and searchManinEduSbjctCd != ''">
            AND UPPR_EDUSBJCTCD LIKE CONCAT('%',#{searchManinEduSbjctCd},'%')
            </if>
            <if test="searchMdleEduSbjctCd != null and searchMdleEduSbjctCd != ''">
            AND EDUSBJCTCD  LIKE CONCAT('%',#{searchMdleEduSbjctCd},'%')
            </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 우수환경도서 게시글 상세조회 -->
    <select id="selectBookInfo" parameterType="front.BookVo" resultType="front.BookVo"> 
        /* BookDao.selectBookInfo */
        SELECT
              A.BOOKID
            , GROUP_CONCAT(EDU_SBJCT_CD ) AS EDU_SBJCT_CD
            , A.EDU_TRGT_CD
            , A.WRITR
            , A.WRITR_PICTR
            , A.PLSCMPN
            , A.CPYRHT_CD
            , FORMAT(A.AMT, 0) AS AMT
            , NVL(A.HITS,0) AS HITS
            , A.TTL
            , A.RPRS_IMG_FILEID
            , E.FILE_IDNTFC_KEY
            , A.CN
            , DATE(A.REG_DT) AS REG_DT
            <![CDATA[
            , (SELECT BOOKID FROM tb_cmm_book WHERE BOOKID > #{bookid} LIMIT 1) AS NEXT_BOOKID
            , (SELECT TTL FROM tb_cmm_book WHERE BOOKID > #{bookid} LIMIT 1) AS NEXT_BOOK_TTL
            , (SELECT BOOKID FROM tb_cmm_book WHERE BOOKID < #{bookid} ORDER BY BOOKID DESC LIMIT 1) AS BEFORE_BOOKID
            , (SELECT TTL FROM tb_cmm_book WHERE BOOKID < #{bookid} ORDER BY BOOKID DESC LIMIT 1) AS BEFORE_BOOK_TTL
            ]]>
        FROM
            TB_CMM_BOOK A
            LEFT OUTER JOIN TB_CMM_BOOK_SBJCT B ON A.BOOKID  = B.BOOKID
            LEFT OUTER JOIN TB_CMM_FILE E ON A.RPRS_IMG_FILEID = E.FILEID
            LEFT OUTER JOIN TB_CMM_USER F ON A.RGTRID = F.USERID
        WHERE A.BOOKID = #{bookid}
    </select>
    
    <!-- 우수환경도서 게시글 상세조회 -->
    <select id="selectBookFileList" parameterType="front.BookVo" resultType="front.BookVo"> 
        /* BookDao.selectBookFileList */
        SELECT
            A.ATCH_FILEGRPID
            , B.FILEID
            , B.FILE_IDNTFC_KEY
            , B.ORGINL_FILE_NM
            , TRIM(LEADING '.' FROM B.FILE_EXTSN) AS EXT
        FROM
            TB_CMM_BOOK A
            LEFT OUTER JOIN TB_CMM_FILE B ON A.ATCH_FILEGRPID = B.FILEGRPID
        WHERE BOOKID = #{bookid}
    </select>
    
    <!-- 조회수 증가 -->
    <update id="updateBookHits" parameterType="front.BookVo">
        UPDATE TB_CMM_BOOK SET HITS = IFNULL(HITS,0) + 1 
        WHERE BOOKID = #{bookid}
    </update>
</mapper>