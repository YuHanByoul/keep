<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : BbsDaoImpl.xml
    Description : 게시판 관리
-->
<mapper namespace="com.kbrainc.plum.front.bbs.model.BbsDao">
    
    <!-- 게시물 목록을 가져온다. -->
    <select id="selectPstList"  parameterType="front.PstVo" resultType ="front.PstVo" >
        /* BbsDao.selectPstList */
        <include refid="PaginationMapper.header"/>
        SELECT 
         A.*
         FROM
         (
            SELECT 
                A.PSTID,
                A.TITLE,
                A.HITS,
                CASE WHEN FXD_NTC_YN = 'Y' THEN 1
                     WHEN FXD_NTC_YN = 'N' THEN 2
                     ELSE 3
                END AS FXD_NTC_YN_ORD,
                FXD_NTC_YN,
                FXD_NTC_STRT_DT,
                FXD_NTC_END_DT,
                IFNULL(B.FILECNT,0) file_cnt,
                B.NM ,
                CONVERT(A.REG_DT, CHAR(10)) REG_DT,
                CONVERT(A.UPDT_DT, CHAR(10)) UPDT_DT,
                A.UPDT_DT ord_DT,
                A.LOGIN_YN 
            FROM 
                TB_PST A 
                LEFT OUTER JOIN (SELECT FILEGRPID, COUNT(FILEID) FILECNT FROM TB_FILE GROUP BY FILEGRPID) B ON  A.FILEGRPID =B.FILEGRPID
                INNER JOIN TB_USER B ON(A.REGUSERID = B.USERID)
            WHERE 1=1
                 AND (CASE WHEN FXD_NTC_YN ='Y' AND   FXD_NTC_STRT_DT <![CDATA[<=]]> NOW() AND DATE_ADD(FXD_NTC_END_DT, INTERVAL 1 DAY)  <![CDATA[>=]]> NOW() THEN 'Y'
                       WHEN FXD_NTC_YN ='Y' AND   FXD_NTC_STRT_DT = null AND FXD_NTC_END_DT = null THEN 'Y'
                       WHEN FXD_NTC_YN ='N' THEN 'Y'
                       ELSE 'N' 
                 END )= 'Y'
                <if test="bbsid != null and bbsid!= 0">
                AND BBSID= #{bbsid}
                </if>
                <if test="searchType != null and searchType == 'TITLE' ">
                AND A.TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>         
                <if test="searchType != null and searchType == 'CNTNTS' ">
                AND A.CNTNTS LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
             )  A
            WHERE 1=1 
                <if test="searchType != null and searchType == 'WRITER' ">
                AND A.NM LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
                <if test="user == null or user.userid ==null ">
                AND A.LOGIN_YN = 'N'
                </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 게시물 정보를 가져온다. -->
    <select id="selectPst"  parameterType="front.PstVo" resultType ="front.PstVo" >
        /* BbsDao.selectPst */
        SELECT 
            A.PSTID      as pstid,
            B.BBSID      as bbsid,
            B.NM         as nm,
            A.reguserid  as userid,
            C.NM    as user_nm,
            C.ACNT  as acnt,
            A.REG_DT     as reg_dt,
            IFNULL(A.HITS,0)   as hits,
            A.TITLE               as title,
            A.CNTNTS              as cntnts,
            A.UPDT_DT             as updt_dt,
            A.fxd_ntc_yn,
            A.BBS_CLID            as bbs_clid,
            IFNULL(a.FILEGRPID,0) as filegrpid,
            B.hot_use_yn,
            b.atchfile_use_yn     as atchfile_use_yn,
            b.atchfile_cnt        as atchfile_cnt,
            b.atchfile_size       as atchfile_size,
            B.cmnt_use_yn         as cmnt_use_yn,
            B.rply_use_yn         as rply_use_yn,
            B.cl_use_yn           as cl_use_yn,
            B.fxd_ntc_use_yn      as fxd_ntc_use_yn,
            B.FXD_NTC_CNT         as fxd_ntc_cnt,
            D.CL_NM               as cl_nm,
            D.BBS_CLID               as bbs_clid,
            (SELECT  SUM( CASE WHEN fxd_ntc_yn = 'Y' THEN 1 ELSE 0 END ) FROM TB_PST E WHERE A.BBSID = E.BBSID ) cur_fxd_ntc_cnt
        FROM
            TB_PST A
            LEFT OUTER JOIN TB_BBS_CL D ON (A.BBS_CLID = D.BBS_CLID),
            TB_BBS B,
            TB_USER C
        WHERE 
            1=1
            AND A.BBSID = B.BBSID
            AND A.REGUSERID = C.USERID
            AND A.PSTID = #{pstid}
    </select>
    
    
        <!-- 게시물을 정보를 가져온다. -->
    <select id="selectOneBbs" parameterType="front.BbsVo" resultType="front.BbsVo">
        /* BbsDao.selectOneBbs */
        SELECT
            BBSID,
            NM,
            DC,
            CL_CD,
            FXD_NTC_USE_YN,
            FXD_NTC_CNT,
            ATCHFILE_USE_YN,
            ATCHFILE_CNT,
            ATCHFILE_SIZE,
            RPLY_USE_YN,
            CMNT_USE_YN,
            NEW_USE_YN,
            NEW_INDICT_DAYCNT,
            HOT_USE_YN,
            HOT_USE_STDR_HITS,
            CL_USE_YN,
            PAGE_PST_CNT,
            NLOGIN_PERM_YN,
            USE_YN,
            UPDT_DT,
            UPDTUSERID,
            REG_DT,
            REGUSERID,
            (SELECT  SUM( CASE WHEN fxd_ntc_yn = 'Y' THEN 1 ELSE 0 END ) FROM TB_PST  WHERE BBSID = #{bbsid}) cur_fxd_ntc_cnt
        FROM
            TB_BBS
        WHERE 
            1=1
            AND BBSID = #{bbsid}  
    </select>
    
    
    <!-- 게시물 목록을 가져온다. -->
    <select id="selectTotalPstList"  parameterType="front.BbsVo" resultType ="front.PstVo" >
        /* BbsDao.selectTotalPstList */
        <include refid="PaginationMapper.header"/>
        SELECT 
         A.*
         FROM
         (
            SELECT 
                A.PSTID,
                A.TITLE,
                IFNULL(A.HITS,0) HITS,
                CASE WHEN FXD_NTC_YN = 'Y' THEN 1
                     <if test ='hot_use_yn == "Y"' >
                     WHEN HITS <![CDATA[>=]]> #{hot_use_stdr_hits}  THEN 2
                     </if>
                     ELSE 3
                END AS order_num,
                <choose>
                    <when test='hot_use_yn == "Y"'>
       	             CASE WHEN FXD_NTC_YN = 'N' AND HITS <![CDATA[>=]]> #{hot_use_stdr_hits} THEN HITS
	                      ELSE 0
	                 END hot_order_num,
       	             CASE WHEN FXD_NTC_YN = 'N' AND HITS <![CDATA[>=]]> #{hot_use_stdr_hits} THEN 'Y'
	                      ELSE 'N'
	                 END hot_yn,
                    </when>
                    <otherwise>
                      0 hot_order_num,
                     'N' hot_yn,
                    </otherwise>
                </choose>
                <choose>
                    <when test='new_use_yn == "Y"'>
       	             CASE WHEN FXD_NTC_YN = 'N' AND IFNULL(HITS,0) <![CDATA[<]]> #{hot_use_stdr_hits}
       	                       AND NOW() <![CDATA[<=]]> DATE_ADD(A.REG_DT, INTERVAL  #{new_indict_daycnt}  DAY)
       	                  THEN 'Y'
	                      ELSE 'N'
	                 END new_yn,
                    </when>
                    <otherwise>
                      'N' new_yn,
                    </otherwise>
                </choose>
                FXD_NTC_YN,
                FXD_NTC_STRT_DT,
                FXD_NTC_END_DT,
                IFNULL(B.FILECNT,0) file_cnt,
                C.BBS_CLID,
                C.CL_NM,
                D.NM ,
                CONVERT(A.REG_DT, CHAR(10)) REG_DT,
                CONVERT(A.UPDT_DT, CHAR(10)) UPDT_DT,
                A.UPDT_DT ord_updt_dt,
                A.REG_DT ord_reg_dt,
                A.LOGIN_YN 
            FROM 
                TB_PST A 
                LEFT OUTER JOIN (SELECT FILEGRPID, COUNT(FILEID) FILECNT FROM TB_FILE GROUP BY FILEGRPID) B ON  A.FILEGRPID =B.FILEGRPID
                LEFT OUTER JOIN TB_BBS_CL C ON  A.BBS_CLID = C.BBS_CLID
                INNER JOIN TB_USER D ON(A.REGUSERID = D.USERID)
            WHERE 1=1
                 AND (CASE WHEN FXD_NTC_YN ='Y' AND   FXD_NTC_STRT_DT <![CDATA[<=]]> NOW() AND DATE_ADD(FXD_NTC_END_DT, INTERVAL 1 DAY)  <![CDATA[>=]]> NOW() THEN 'Y'
                       WHEN FXD_NTC_YN ='Y' AND   FXD_NTC_STRT_DT = null AND FXD_NTC_END_DT = null THEN 'Y'
                       WHEN FXD_NTC_YN ='N' THEN 'Y'
                       ELSE 'N' 
                 END )= 'Y'
                <if test="bbsid != null and bbsid!= 0">
                AND A.BBSID= #{bbsid}
                </if>
                <if test="searchType != null and searchType == 'TITLE' ">
                AND A.TITLE LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>         
                <if test="searchType != null and searchType == 'CNTNTS' ">
                AND A.CNTNTS LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
                <if test="bbs_clid != null and bbs_clid !='' ">
                AND A.BBS_CLID = #{bbs_clid}
                </if>
             )  A
            WHERE 1=1 
                <if test="searchType != null and searchType == 'WRITER' ">
                AND A.NM LIKE CONCAT('%', #{searchKeyword}, '%')
                </if>
                <if test="user == null or user.userid ==null ">
                AND A.LOGIN_YN = 'N'
                </if>
        <include refid="PaginationMapper.footer"/>
    </select>
    
      <!-- 게시물 댓글 목록을 가져온다. -->
  <select id="selectCmntList" parameterType="front.CmntVo"  resultType ="front.CmntVo">
        /* BbsDao.selectCmntList */
        <include refid="PaginationMapper.header"/>
        SELECT 
            a.PSTID,
            a.CMNTID,
            a.CNTNTS,
            a.PRNTS_CMNTID,
            a.CMNT_GRP,
            a.DPTH,
            a.ORD,
            a.OPN_YN,
            a.UPDT_DT,
            a.UPDTUSERID,
            a.REG_DT,
            a.REGUSERID,
            a.del_yn,
            b.NM,
            b.ACNT
        FROM
            TB_CMNT a,
            TB_USER b 
        WHERE 
            1=1
            AND a.REGUSERID = b.USERID
            -- AND a.del_yn = 'N'
            AND PSTID = #{pstid}
            <if test="prnts_cmntid != null and prnts_cmntid != 0 ">
            AND PRNTS_CMNTID = #{prnts_cmntid}
            </if>         
            -- ORDER BY CMNT_GRP, PRNTS_CMNTID,DPTH,ORD
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 게시판 분류 목록을 가져온다. -->
    <select id="selectBbsClList"  parameterType="front.BbsClVo" resultType="front.BbsClVo">
        /* BbsDao.selectBbsClList */
        SELECT 
           CL_NM,
           bbs_clid,
           BBSID,
           USE_YN,
           ORD,
           UPDT_DT updt_dt
        FROM 
           TB_BBS_CL  
        WHERE 1=1 
          AND BBSID = #{bbsid}
    </select>
    
    <!-- 게시물  조회수 증가  -->
    <update id="updatePstHitsCount" parameterType="front.PstVo" >
        /* BbsDao.updatePstHitsCount */
        UPDATE TB_PST SET
             HITS        = IFNULL(HITS,0)+1 
            ,UPDT_DT     = NOW()
            <if test="user != null and user.userid != null ">
            ,UPDTUSERID  = #{user.userid }
            </if>
        WHERE 
            pstid = #{pstid}  
    </update>
</mapper>