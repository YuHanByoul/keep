<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : JntpurchsDaoImpl.xml
    Description : 환경교육 교구 공동구매
-->
<mapper namespace="com.kbrainc.plum.front.jntpurchs.model.JntpurchsDao">
    
    <!-- 공동구매 목록 조회 -->
    <select id="selectJntpurchsList" parameterType="front.JntpurchsVo" resultType="front.JntpurchsVo">
        /* JntpurchsDao.selectJntpurchsList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.JNTPURCHSID
            , CASE WHEN NOW() <![CDATA[>]]> A.END_DT THEN '모집종료' WHEN A.STTS_CD <![CDATA[=]]> '172104' THEN '일시중지'
              WHEN NOW() <![CDATA[<]]> A.BGNG_DT THEN '모집대기' 
              WHEN A.QNTY_WHOL_LMT_YN <![CDATA[=]]> 'Y' AND D.ORDER_QNTY <![CDATA[>=]]> A.QNTY_WHOL THEN '재고소진'
              ELSE '모집중' END AS STTS_CD_NM
            , A.JNTPURCHS_NM
            , A.BGNG_DT
            , A.END_DT
            , A.REG_DT
            , GROUP_CONCAT(C.TCHAID_NM SEPARATOR ', ') AS TCHAID_NM
            , A.QNTY_WHOL
            , A.QNTY_WHOL_LMT_YN
            , A.RPRS_IMG_FILEID
            , G.FILE_IDNTFC_KEY AS RPRS_IMG_FILEKEY
            , IFNULL(D.ORDER_QNTY, 0) AS ORDER_QNTY
    , G.FILE_IDNTFC_KEY
        FROM
            TB_THA_TCHAID_JNTPURCHS A
        LEFT OUTER JOIN
            TB_THA_TCHAID_JNTPURCHS_GOODS B ON (B.JNTPURCHSID = A.JNTPURCHSID)
        LEFT OUTER JOIN
            TB_THA_TCHAID C ON (C.TCHAIDID = B.TCHAIDID)
        LEFT OUTER JOIN (
            SELECT
                JNTPURCHSID
                , SUM(QNTY) AS ORDER_QNTY
                FROM (
                    SELECT
                        B.JNTPURCHSID
                        , B.QNTY
                    FROM
                        TB_THA_TCHAID_JNTPURCHS_ORDER A
                    LEFT OUTER JOIN
                        TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS B ON (B.ORDERID = A.ORDERID)
                    WHERE
                        A.STTS_CD = '181100'
                    GROUP BY
                        A.ORDERID
                        , B.JNTPURCHSID
            ) ORDR
            GROUP BY
                JNTPURCHSID
        ) D ON (D.JNTPURCHSID = A.JNTPURCHSID)
        INNER JOIN (
            SELECT
                USERID
                , INSTID
                , ACNT
            FROM
                TB_CMM_USER
        ) E ON (E.USERID = A.RGTRID)
        LEFT OUTER JOIN
            TB_CMM_INST F ON (F.INSTID = E.INSTID)
        LEFT OUTER JOIN
            TB_CMM_FILE G ON (G.FILEID = A.RPRS_IMG_FILEID)
        WHERE 1 = 1
        <if test="searchJntpurchsNm != null and searchJntpurchsNm != ''">
            AND A.JNTPURCHS_NM LIKE CONCAT('%',#{searchJntpurchsNm},'%')
        </if>
        <if test="searchSttsCd != null and searchSttsCd != '' and searchSttsCd == '172100'">
            AND NOW() <![CDATA[<]]> A.BGNG_DT
        </if>
        <if test="searchSttsCd != null and searchSttsCd != '' and searchSttsCd == '172101'">
            AND (NOW() <![CDATA[>=]]> A.BGNG_DT AND NOW() <![CDATA[<=]]> A.END_DT) 
        </if>
        <if test="searchSttsCd != null and searchSttsCd != '' and searchSttsCd == '172102'">
            AND NOW() <![CDATA[>]]> A.END_DT
        </if>
        <if test="searchSttsCd != null and searchSttsCd != '' and searchSttsCd == '172103'">
            AND (A.QNTY_WHOL_LMT_YN <![CDATA[=]]> 'Y' AND D.ORDER_QNTY <![CDATA[>=]]> A.QNTY_WHOL)
        </if>
        <if test="searchSttsCd != null and searchSttsCd != '' and searchSttsCd == '172104'">
            AND (NOW() <![CDATA[>=]]> A.BGNG_DT AND NOW() <![CDATA[<=]]> A.END_DT AND A.STTS_CD = '172104')
        </if>
        GROUP BY
            B.JNTPURCHSID
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 공동구매 상세 정보 조회 -->
    <select id="selectJntpurchsInfo" parameterType="front.JntpurchsVo" resultType="front.JntpurchsVo">
        /* JntpurchsDao.selectJntpurchsInfo */
        SELECT
            A.JNTPURCHSID
            , A.JNTPURCHSNO
            , CASE WHEN NOW() <![CDATA[>]]> A.END_DT THEN '모집종료' WHEN A.STTS_CD <![CDATA[=]]> '172104' THEN '일시중지'
              WHEN NOW() <![CDATA[<]]> A.BGNG_DT THEN '모집대기' 
              WHEN A.QNTY_WHOL_LMT_YN <![CDATA[=]]> 'Y' AND B.ORDER_QNTY <![CDATA[>=]]> A.QNTY_WHOL THEN '재고소진'
              ELSE '모집중' END AS STTS_CD_NM
            , A.JNTPURCHS_NM
            , GROUP_CONCAT(D.TCHAID_NM SEPARATOR ', ') AS TCHAID_NM
            , A.BGNG_DT
            , A.END_DT
            , A.QNTY_WHOL
            , A.QNTY_WHOL_LMT_YN
            , A.QNTY_LMT
            , A.QNTY_LMT_YN
            , IFNULL(B.ORDER_QNTY, 0) AS ORDER_QNTY
            , A.DTL_CN
            , A.MVP_URL
            , A.MVP_PSTN_CD
            , A.RPRS_IMG_FILEID
            , A.DTL_IMG_FILEGRPID
            , A.MAP_FILEGRPID
            , A.EDU_PHOTO_FILEGRPID
            , A.ATENT_MTTR
        FROM
            TB_THA_TCHAID_JNTPURCHS A
        LEFT OUTER JOIN (
            SELECT
                SUM(QNTY) AS ORDER_QNTY
            FROM (
                SELECT
                    B.JNTPURCHSID
                    , B.QNTY
                FROM
                    TB_THA_TCHAID_JNTPURCHS_ORDER A
                LEFT OUTER JOIN
                    TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS B ON (B.ORDERID = A.ORDERID)
                WHERE
                    A.STTS_CD = '181100'
                    AND B.JNTPURCHSID = #{jntpurchsid}
                GROUP BY
                    A.ORDERID
                    , B.JNTPURCHSID
            ) ORDR
            GROUP BY
                JNTPURCHSID
        ) B ON 1 = 1
        LEFT OUTER JOIN
            TB_THA_TCHAID_JNTPURCHS_GOODS C ON (C.JNTPURCHSID = A.JNTPURCHSID)
        LEFT OUTER JOIN
            TB_THA_TCHAID D ON (D.TCHAIDID = C.TCHAIDID)
        WHERE
            A.JNTPURCHSID = #{jntpurchsid}
    </select>
    
    <!-- 공동구매 수량별 가격 정보 조회 -->
    <select id="selectAmtList" parameterType="JntpurchsAmtVo" resultType="JntpurchsAmtVo">
        /* JntpurchsDao.selectAmtList */
        SELECT
            AMTID
            , QNTY_BGNG
            , QNTY_END
            , AMT
        FROM
            TB_THA_TCHAID_JNTPURCHS_AMT
        WHERE
            JNTPURCHSID = #{jntpurchsid}
        ORDER BY
            AMT
    </select>
    
    <!-- 공동구매 상품 조회 -->
    <select id="selectGoodsList" parameterType="JntpurchsTchaidVo" resultType="JntpurchsTchaidVo">
        /* JntpurchsDao.selectGoodsList */
        SELECT
            B.TCHAIDID
            , B.TCHAID_NM
            , C.CD_NM AS TCHAID_TYPE_CD_NM
            , GROUP_CONCAT(E.CD_NM SEPARATOR ', ') AS EDU_SBJCT_CD_NM
            , GROUP_CONCAT(G.CD_NM SEPARATOR ', ') AS EDU_TRGT_CD_NM
            , H.CD_NM AS TEAM_CMPSTN_CD_NM
            , I.CD_NM AS EDU_TYPE_CD_NM
        FROM
            TB_THA_TCHAID_JNTPURCHS_GOODS A
        LEFT OUTER JOIN
            TB_THA_TCHAID B ON (B.TCHAIDID = A.TCHAIDID)
        INNER JOIN (
            SELECT
                CD
                , CD_NM
            FROM
                TB_CMM_CD
            WHERE
                CDGRPID = '184'
        ) C ON (C.CD = B.TCHAID_TYPE_CD)
        LEFT OUTER JOIN
            TB_THA_TCHAID_EDU_SBJCT_MAPNG D ON (D.TCHAIDID = A.TCHAIDID)
        INNER JOIN (
            SELECT
                CD
                , CD_NM
            FROM
            TB_CMM_CD
            WHERE
            CDGRPID = '155'
        ) E ON (E.CD = D.EDU_SBJCT_CD)
        LEFT OUTER JOIN
            TB_THA_TCHAID_EDU_TRGT_MAPNG F ON (F.TCHAIDID = A.TCHAIDID)
        INNER JOIN (
            SELECT
                CD
                , CD_NM
            FROM
            TB_CMM_CD
            WHERE
            CDGRPID = '185'
        ) G ON (G.CD = F.EDU_TRGT_CD)
        INNER JOIN (
            SELECT
                CD
                , CD_NM
            FROM
                TB_CMM_CD
            WHERE
                CDGRPID = '186'
        ) H ON (H.CD = B.TEAM_CMPSTN_CD)
        INNER JOIN (
            SELECT
                CD
                , CD_NM
            FROM
                TB_CMM_CD
            WHERE
                CDGRPID = '187'
        ) I ON (I.CD = B.EDU_TYPE_CD)
        WHERE
            A.JNTPURCHSID = #{jntpurchsid}
        GROUP BY
            A.TCHAIDID
        ORDER BY
            A.TCHAIDID
    </select>
    
    <!-- 공동구매 후기 목록 조회 -->
    <select id="selectRvwList" parameterType="front.JntpurchsRvwVo" resultType="front.JntpurchsRvwVo">
        /* JntpurchsDao.selectRvwList */
        SELECT
            C.ACNT
            , A.RVW_CN
            , A.RVW_SCR
            , A.RVW_REG_DT
        FROM
            TB_THA_TCHAID_JNTPURCHS_ORDER A
        LEFT OUTER JOIN
            TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS B ON (B.ORDERID = A.ORDERID)
        INNER JOIN
            TB_CMM_USER C ON (C.USERID = A.RGTRID)
        WHERE
            A.RVW_CN IS NOT NULL
            AND B.JNTPURCHSID = #{jntpurchsid}
        GROUP BY
            A.ORDERID
        ORDER BY
            A.RVW_REG_DT DESC
    </select>
    
    <!-- 공동구매 신청 회원 정보 조회 -->
    <select id="selectUserInfo" parameterType="front.MemberVo" resultType="front.MemberVo">
        SELECT
            NM
            , MOBLPHON
            , EML
            , ZIP
            , ADDR
            , ADDR_DTL
        FROM
            TB_CMM_USER
        WHERE
            USERID = #{user.userid}
    </select>
    
    <!-- 공동구매 수량 정보 조회(전체/제한/주문 수량 정보) -->
    <select id="selectQntyInfo" parameterType="JntpurchsOrderVo" resultType="front.JntpurchsVo">
        SELECT
            A.QNTY_WHOL_LMT_YN
            , A.QNTY_WHOL
            , A.QNTY_LMT_YN
            , A.QNTY_LMT
            , IFNULL(B.ORDER_QNTY, 0) AS ORDER_QNTY
        FROM
            TB_THA_TCHAID_JNTPURCHS A
        LEFT OUTER JOIN (
            SELECT
                SUM(QNTY) AS ORDER_QNTY
            FROM (
                SELECT
                    B.JNTPURCHSID
                    , B.QNTY
                FROM
                    TB_THA_TCHAID_JNTPURCHS_ORDER A
                LEFT OUTER JOIN
                    TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS B ON (B.ORDERID = A.ORDERID)
                WHERE
                    A.STTS_CD = '181100'
                    AND B.JNTPURCHSID = #{jntpurchsid}
                GROUP BY
                    A.ORDERID
                    , B.JNTPURCHSID
            ) ORDR
            GROUP BY
                JNTPURCHSID
        ) B ON 1 = 1
        WHERE
            A.JNTPURCHSID = #{jntpurchsid}
    </select>
    
    <!-- 공동구매 신청 등록 -->
    <insert id="insertJntpurchsOrder" parameterType="JntpurchsOrderVo"  useGeneratedKeys="true" keyProperty="orderid">
        /* JntpurchsDao.insertJntpurchsOrder */
        INSERT INTO TB_THA_TCHAID_JNTPURCHS_ORDER (
            ORDERNO
            , USERID
            , INSTID
            , USER_NM
            , INST_NM
            , STTS_CD
            , TELNO
            , EML
            , RECPTR
            , RECPTR_TELNO
            , RECPTR_EML
            , DLVY_ZIP
            , DLVY_ADDR
            , DLVY_ADDR_DTL
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            (SELECT CONCAT(#{jntpurchsno}, '-', IFNULL(MAX(LPAD(ORDERID + 1, 4, '0')), LPAD('1', 4, '0'))) FROM TB_THA_TCHAID_JNTPURCHS_ORDER AS A WHERE SUBSTR(ORDERNO, 1, 6) = #{jntpurchsno})
            , #{user.userid}
            , #{user.instid}
            , #{user.name}
            , (SELECT INST_NM FROM TB_CMM_INST AS A WHERE INSTID = #{user.instid})
            , '181100'
            , #{telno}
            , #{eml}
            , #{recptr}
            , #{recptrTelno}
            , #{recptrEml}
            , #{dlvyZip}
            , #{dlvyAddr}
            , #{dlvyAddrDtl}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 공동구매 상품 신청 등록 -->
    <insert id="insertJntpurchsOrderGoods" parameterType="JntpurchsTchaidVo">
        INSERT TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS (
            ORDERID
            , JNTPURCHSID
            , TCHAIDID
            , QNTY
            , AMT
            , MDFCN_DT
            , MDFRID
            , REG_DT
            , RGTRID
        ) VALUES (
            #{orderid}
            , #{jntpurchsid}
            , #{tchaidid}
            , #{qnty}
            , #{amt}
            , NOW()
            , #{user.userid}
            , NOW()
            , #{user.userid}
        )
    </insert>
    
    <!-- 공동구매 신청 이력 조회 -->
    <select id="selectjntpurchsOrderHstryList" parameterType="JntpurchsOrderVo" resultType="JntpurchsOrderVo">
        /* JntpurchsDao.selectJntpurchsList */
        <include refid="PaginationMapper.header"/>
        SELECT
            A.ORDERID
            , C.JNTPURCHS_NM
            , C.BGNG_DT
            , C.END_DT
            , B.QNTY
            , A.STTS_CD
            , D.CD_NM AS STTS_CD_NM
            , A.RVW_REG_DT
            , A.REG_DT
        FROM
            TB_THA_TCHAID_JNTPURCHS_ORDER A
        LEFT OUTER JOIN
            TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS B ON (B.ORDERID = A.ORDERID)
        LEFT OUTER JOIN
            TB_THA_TCHAID_JNTPURCHS C ON (C.JNTPURCHSID = B.JNTPURCHSID)
        INNER JOIN (
            SELECT
                CD
                , CD_NM
            FROM
                TB_CMM_CD
            WHERE
                CDGRPID = '181'
        ) D ON (D.CD = A.STTS_CD)
        WHERE 
            A.USERID = #{user.userid}
        <if test="searchJntpurchsNm != null and searchJntpurchsNm != ''">
            AND C.JNTPURCHS_NM LIKE CONCAT('%',#{searchJntpurchsNm},'%')
        </if>
        GROUP BY
            A.ORDERID
        <include refid="PaginationMapper.footer"/>
    </select>
    
    <!-- 공동구매 신청 정보 조회 -->
    <select id="selectJntpurchsOrderInfo" parameterType="JntpurchsOrderVo" resultType="JntpurchsOrderVo">
        /* JntpurchsDao.selectJntpurchsOrderInfo */
        SELECT
            A.ORDERID
            , C.JNTPURCHSID
            , C.JNTPURCHS_NM
            , C.BGNG_DT
            , C.END_DT
            , B.QNTY
            , B.AMT
            , A.REG_DT
            , A.STTS_CD
            , D.CD_NM AS STTS_CD_NM
            , A.RECPTR
            , A.RECPTR_TELNO
            , A.RECPTR_EML
            , A.DLVY_ZIP
            , A.DLVY_ADDR
            , A.DLVY_ADDR_DTL
            , CASE WHEN NOW() <![CDATA[>]]> C.END_DT OR A.STTS_CD = '181101' THEN 'N' ELSE 'Y' END AS CANCEL_YN
        FROM
            TB_THA_TCHAID_JNTPURCHS_ORDER A
        LEFT OUTER JOIN
            TB_THA_TCHAID_JNTPURCHS_ORDER_GOODS B ON (B.ORDERID = A.ORDERID)
        LEFT OUTER JOIN
            TB_THA_TCHAID_JNTPURCHS C ON(C.JNTPURCHSID = B.JNTPURCHSID)
        INNER JOIN (
            SELECT
                CD
                , CD_NM
            FROM
                TB_CMM_CD
            WHERE
                CDGRPID = '181'
        ) D ON (D.CD = A.STTS_CD)
        WHERE
            A.ORDERID = #{orderid}
        GROUP BY
            A.ORDERID
    </select>
    
    <!-- 공동구매 신청 취소 -->
    <update id="deleteJntpurchsOrder" parameterType="JntpurchsOrderVo">
        /* JntpurchsDao.deleteJntpurchsOrder */
        UPDATE TB_THA_TCHAID_JNTPURCHS_ORDER SET
            STTS_CD = '181101'
            , RVW_SCR = NULL
            , RVW_CN = NULL
            , RVW_FILEGRPID = NULL
            , RVW_REG_DT = NULL
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE
            ORDERID = #{orderid}
    </update>
    
    <!-- 공동구매 후기 등록 -->
    <update id="insertJntpurchsOrderRvw" parameterType="JntpurchsOrderVo">
        /* JntpurchsDao.insertJntpurchsOrderRvw */
        UPDATE TB_THA_TCHAID_JNTPURCHS_ORDER SET
            RVW_SCR = #{rvwScr}
            , RVW_CN = #{rvwCn}
            , RVW_FILEGRPID = #{rvwFilegrpid}
            , RVW_REG_DT = NOW()
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE
            ORDERID = #{orderid}
    </update>
    
    <!-- 공동구매 후기 정보 조회 -->
    <select id="selectJntpurchsOrderRvwInfo" parameterType="JntpurchsOrderVo" resultType="JntpurchsOrderVo">
        /* JntpurchsDao.selectJntpurchsOrderRvwInfo */
        SELECT
            RVW_SCR
            , RVW_CN
            , RVW_FILEGRPID
        FROM
            TB_THA_TCHAID_JNTPURCHS_ORDER
        WHERE
            ORDERID = #{orderid}
    </select>
    
    <!-- 공동구매 후기 삭제 -->
    <update id="deleteJntpurchsOrderRvw" parameterType="JntpurchsOrderVo">
        /* JntpurchsDao.deleteJntpurchsOrderRvw */
        UPDATE TB_THA_TCHAID_JNTPURCHS_ORDER SET
            RVW_SCR = NULL
            , RVW_CN = NULL
            , RVW_FILEGRPID = NULL
            , RVW_REG_DT = NULL
            , MDFCN_DT = NOW()
            , MDFRID = #{user.userid}
        WHERE
            ORDERID = #{orderid}
    </update>
    
</mapper>