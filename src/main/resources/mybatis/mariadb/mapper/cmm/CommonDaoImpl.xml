<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : CommonDaoImpl.xml
    Description : 공통쿼리
-->
<mapper namespace="com.kbrainc.plum.cmm.model.CommonDao">
    
    <!-- 사이트 리스트를 반환한다. -->
    <select id="selectSiteList" parameterType="SiteVo" resultType="SiteVo">
	    /* CommonDao.selectSiteList */
        SELECT 
	        SITEID,   
		    SITE_NM,
            SYS_SE_CD
        FROM TB_CMM_SITE		
		WHERE 
		    USE_YN = 'Y'
	    <if test="siteid != null and siteid != ''">
		    AND SITEID = #{siteid}			
	    </if>
	</select>
    
    <!-- 현재 사용자의 접근가능한 기관목록을 반환한다. -->
    <select id="selectAlowedInstList" parameterType="UserVo" resultType="java.util.Map">
        /* CommonDao.selectAlowedInstList */
        SELECT 
            INSTID,
            INST_NM,
            INST_CD
        FROM 
            TB_CMM_INST
        WHERE 
            USE_YN = 'Y'
        AND APRV_STTS_CD = '2'
        <choose>
            <when test='roleInfo.trgtInstCd == "A"'>
            </when>
            <when test='roleInfo.trgtInstCd == "S"'>
                AND INSTID = #{instid}          
            </when>
            <when test='roleInfo.trgtInstCd == "C"'>
                AND INSTID IN(SELECT INSTID FROM TB_CMM_ROLE_INST WHERE ROLEID = #{roleInfo.roleid})          
            </when>
            <otherwise>
                AND 1 != 1
            </otherwise>
        </choose>
        <if test='roleInfo.trgtRgnCd == "S"'>
            AND INSTID IN(SELECT INSTID FROM TB_CMM_INST WHERE RGN_CD IN(SELECT RGN_CD FROM TB_CMM_ROLE_RGN WHERE ROLEID = #{roleInfo.roleid}))          
        </if>
        ORDER BY INST_NM ASC
    </select>
    
    <!-- 현재 사용자의 접근가능한 사이트목록을 반환한다. -->
    <select id="selectAlowedSiteList" parameterType="java.util.Map" resultType="java.util.Map">
        /* CommonDao.selectAlowedSiteList */
        SELECT 
            S.SITEID,
            S.SITE_NM,
            I.INST_NM
        FROM
            TB_CMM_SITE S LEFT OUTER JOIN TB_CMM_INST I ON S.INSTID = I.INSTID
        WHERE 
            S.USE_YN = 'Y'
        <if test="sysSeCd != null and sysSeCd != ''">
            AND S.SYS_SE_CD = #{sysSeCd}
        </if>
        <choose>
            <when test='user.roleInfo.trgtInstCd == "A"'>
            </when>
            <when test='user.roleInfo.trgtInstCd == "S"'>
                AND S.INSTID = #{user.instid}          
            </when>
            <when test='user.roleInfo.trgtInstCd == "C"'>
                AND S.INSTID IN(SELECT INSTID FROM TB_CMM_ROLE_INST WHERE ROLEID = #{user.roleInfo.roleid})          
            </when>
            <otherwise>
                AND 1 != 1
            </otherwise>
        </choose>
        <if test='user.roleInfo.trgtRgnCd == "S"'>
            AND S.INSTID IN(SELECT INSTID FROM TB_CMM_INST WHERE RGN_CD IN(SELECT RGN_CD FROM TB_CMM_ROLE_RGN WHERE ROLEID = #{user.roleInfo.roleid}))         
        </if>
        ORDER BY S.SITE_NM ASC
    </select>
    
    <!-- 로그인 성공 이력을 저장한다. -->
    <insert id="insertLoginDescription" parameterType="java.util.Map">
        /* CommonDao.insertLoginDescription */    
        INSERT INTO TB_CMM_LGN_DSCTN 
            (USERID, 
             DEVICE_CD, 
             IP, 
             LGN_DT
            )
            VALUES
            (#{userid}, 
             #{deviceCd}, 
             #{ipAddr}, 
             NOW()
            )
    </insert>
    
    <!-- 로그인 실패 횟수를 0으로 수정하고 로그인일시를 수정한다. -->
    <update id="updateUserLgnInfo" parameterType="java.util.Map">
        /* CommonDao.updateUserLgnInfo */
        UPDATE 
            TB_CMM_USER 
        SET 
            LGN_DT = NOW(),
            LGN_FAIL_CNT = 0 
        WHERE USERID = #{userid}
    </update>
    
    <!-- 로그인 실패 이력을 저장한다. -->
    <insert id="insertLoginFailDescription" parameterType="java.util.Map">
        /* CommonDao.insertLoginFailDescription */    
        INSERT INTO TB_CMM_LGN_FAIL_DSCTN 
            (USERID, 
             DEVICE_CD, 
             IP, 
             LGN_DT
            )
            VALUES
            (#{userid}, 
             #{deviceCd}, 
             #{ipAddr}, 
             NOW()
            )
    </insert>
    
    <!-- 로그인 실패 횟수를 1회 증가시킨다. -->
    <update id="updateLgnFailCntPlusOne" parameterType="java.util.Map">
        /* CommonDao.updateLgnFailCntPlusOne */
        UPDATE 
            TB_CMM_USER 
        SET 
            LGN_FAIL_CNT = NVL(LGN_FAIL_CNT,0) + 1 
        WHERE 
            USERID = #{userid}
    </update>
    
    <!-- 계정을 잠근다(비밀번호 5회 초과 사유) -->
    <update id="updateAccountLock" parameterType="java.util.Map">
        /* CommonDao.updateAccountLock */
        UPDATE 
            TB_CMM_USER 
        SET 
            ACNT_LOCK_YN = 'Y', 
            ACNT_LOCK_CD = '101103' 
        WHERE 
            USERID = #{userid} 
        AND LGN_FAIL_CNT >= 5
    </update>
    
    <!-- 전체 지역 목록 조회 -->
    <select id="selectAllRgnList" resultType="java.util.Map">
        <![CDATA[ /* CommonDao.selectAllRgnList */
            SELECT
                A.SIGNGU_CD AS RGN_CD, 
                B.CTPRVN_NM,
                A.SIGNGU_NM,
                A.CTPRVN_CD
            FROM 
                TB_CMM_ADDR_SIGNGU A INNER JOIN TB_CMM_ADDR_CTPRVN B ON A.CTPRVN_CD = B.CTPRVN_CD
            ORDER BY B.ORDR ASC, A.ORDR ASC
        ]]>
    </select>
    
    <!-- 시도 지역 리스트 호출 -->
    <select id="selectCtprvnList"  resultType="map">
        /* CommonDao.selectCtprvnList */
        SELECT 
           CTPRVN_CD 
           ,CTPRVN_NM  
          FROM 
            TB_CMM_ADDR_CTPRVN
         ORDER BY ORDR ASC
    </select>
    
    <!-- 사용자 휴면 데이터로 부터 사용자 정보를 수정 -->
    <update id="updateUserFromDrmncy" parameterType="DrmncyInfoVo">
        /* CommonDao.updateUserFromDrmncy */
        UPDATE 
            TB_CMM_USER U JOIN TB_CMM_USER_DRMNCY D ON U.USERID = D.USERID 
        SET 
            U.NM = D.NM,
            U.MOBLPHON = D.MOBLPHON,
            U.TELNO = D.TELNO,
            U.BRDT = D.BRDT,
            U.GNDR = D.GNDR,
            U.ZIP = D.ZIP,
            U.ADDR = D.ADDR,
            U.ADDR_DTL = D.ADDR_DTL,
            U.SIGNGU_CD = D.SIGNGU_CD,
            U.PRVC_VLDTY = #{prvcVldty},
            U.ACNT_LOCK_YN = 'N',
            U.ACNT_LOCK_CD = NULL,
            U.LGN_DT = NOW(),
            U.LGN_FAIL_CNT = 0,
            U.MDFCN_DT = NOW(),
            U.MDFRID = #{mdfrid}
        WHERE U.USERID = #{userid}
    </update>
    
    <!-- 사용자 휴면 데이터 삭제 -->
    <delete id="deleteUserDrmncy" parameterType="String">
        /* CommonDao.deleteUserDrmncy */
        DELETE FROM TB_CMM_USER_DRMNCY WHERE USERID = #{userid}
    </delete>
    
    <!-- 사용자에게 부여된 역할 삭제 -->
    <delete id="deleteRoleUser" parameterType="String">
        /* CommonDao.deleteRoleUser */
        DELETE FROM TB_CMM_ROLE_USER WHERE USERID = #{userid}
    </delete>
</mapper>
