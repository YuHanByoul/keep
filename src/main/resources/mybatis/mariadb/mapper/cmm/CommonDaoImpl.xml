<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : CommonDaoImpl.xml
    Description : 공통쿼리
-->
<mapper namespace="com.kbrainc.plum.cmm.model.CommonDao">
    
    <!-- 사이트 리스트를 반환한다. -->
    <select id="selectSiteList" parameterType="SiteVo" resultType="SiteVo">
	    /* CommonDao.selectSiteList */
        SELECT 
	        SITEID,   
		    SITE_NM
        FROM TB_CMM_SITE		
		WHERE 
		    USE_YN = 'Y'
	    <if test="siteid != null and siteid != ''">
		    AND SITEID = #{siteid}			
	    </if>
	</select>
    
    <!-- 현재 사용자의 접근가능한 기관목록을 반환한다. -->
    <select id="selectAlowedInstList" parameterType="UserVo" resultType="java.util.Map">
        /* CommonDao.selectAlowedInstList */
        SELECT 
            INSTID,
            INST_NM,
            INST_CD
        FROM 
            TB_CMM_INST
        WHERE 
            USE_YN = 'Y'
        AND APRV_STTS_CD = '2'
        <choose>
            <when test='roleInfo.trgtInsttCd == "A"'>
            </when>
            <when test='roleInfo.trgtInsttCd == "S"'>
                AND INSTID = #{instid}          
            </when>
            <when test='roleInfo.trgtInsttCd == "C"'>
                AND INSTID IN(SELECT INSTID FROM TB_CMM_ROLE_INST WHERE ROLEID = #{roleInfo.roleid})          
            </when>
            <otherwise>
                AND 1 != 1
            </otherwise>
        </choose>
        ORDER BY INST_NM ASC
    </select>
    
    <!-- 현재 사용자의 접근가능한 사이트목록을 반환한다. -->
    <select id="selectAlowedSiteList" parameterType="java.util.Map" resultType="java.util.Map">
        /* CommonDao.selectAlowedSiteList */
        SELECT 
            S.SITEID,
            S.SITE_NM,
            I.INST_NM
        FROM
            TB_CMM_SITE S LEFT OUTER JOIN TB_CMM_INST I ON S.INSTID = I.INSTID
        WHERE 
            S.USE_YN = 'Y'
        <if test="sysSeCd != null and sysSeCd != ''">
            AND S.SYS_SE_CD = #{sysSeCd}
        </if>
        <choose>
            <when test='user.roleInfo.trgtInsttCd == "A"'>
            </when>
            <when test='user.roleInfo.trgtInsttCd == "S"'>
                AND S.INSTID = #{user.instid}          
            </when>
            <when test='user.roleInfo.trgtInsttCd == "C"'>
                AND S.INSTID IN(SELECT INSTID FROM TB_CMM_ROLE_INST WHERE ROLEID = #{user.roleInfo.roleid})          
            </when>
            <otherwise>
                AND 1 != 1
            </otherwise>
        </choose>
        ORDER BY S.SITE_NM ASC
    </select>
    
</mapper>
