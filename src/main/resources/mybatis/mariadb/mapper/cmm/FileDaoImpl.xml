<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : FileDaoImpl.xml
    Description : 파일 관련
-->
<mapper namespace="com.kbrainc.plum.cmm.file.model.FileDao">
	
	<!-- 파일리스트 가져옴 -->
	<select id="getFileList" parameterType="FileVo" resultType="FileVo">
	    /* FileDao.getFileList */
		SELECT 
			FILEID,
			FILEGRPID,
			FILE_IDNTFC_KEY,
			FILE_PATH,
			SAVE_FILE_NM,
			ORGINL_FILE_NM,
			FILE_EXTSN,
			FILE_SIZE,
			ORD,
			REG_DT,
			RGTRID
		FROM TB_CMM_FILE
		WHERE 1=1
		<if test="@com.kbrainc.plum.rte.util.CommonUtil@isNotEmpty(filegrpid)">
			AND FILEGRPID = #{filegrpid}
		</if>
		 ORDER BY ORD
	</select>

	<!-- 파일 등록 -->
	<insert id="addFile" useGeneratedKeys="true" keyProperty="fileid" parameterType="FileVo">
		/* FileDao.addFile */
		INSERT INTO TB_CMM_FILE
		(
			FILEGRPID,
			FILE_IDNTFC_KEY,
			FILE_PATH,
			SAVE_FILE_NM,
			ORGINL_FILE_NM,
			FILE_EXTSN,
			FILE_SIZE,
			ORD,
			MDFCN_DT,
			MDFRID,
			REG_DT,
			RGTRID
		)
		VALUES (
			#{filegrpid},
			#{fileIdntfcKey},
			#{filePath},
			#{saveFileNm},
			#{orginlFileNm},
			#{fileExtsn},
			#{fileSize},
			(SELECT IFNULL(MAX(ORD),0) +1 FROM  TB_CMM_FILE AS F WHERE 1=1  AND filegrpid = #{filegrpid} ),
			NOW(),
			#{rgtrid},
			NOW(),
			#{rgtrid}
		)
	</insert>
	
	<!-- 파일 삭제 -->
	<delete id="deleteFile" parameterType="FileVo">
		/* FileDao.deleteFile */
		DELETE
		FROM TB_CMM_FILE
		WHERE FILEID = #{fileid}
		  AND FILE_IDNTFC_KEY = #{fileIdntfcKey}
	</delete>
	
	<!-- 파일 데이터를 가져옴 -->
	<select id="selectFile" parameterType="FileVo" resultType="FileVo">
		/* FileDao.selectFile */
		SELECT 
			A.FILEID,
			A.FILEGRPID,
			A.FILE_IDNTFC_KEY,
			B.FILEGRP_NM,
            B.BBSID,
            C.NLOGIN_DWNLD_PERM_YN,
			A.FILE_PATH,
			A.SAVE_FILE_NM,
			A.ORGINL_FILE_NM,
			A.FILE_EXTSN,
			A.FILE_SIZE,
			A.ORD,
			A.REG_DT,
			A.RGTRID
		FROM TB_CMM_FILE A
		    ,TB_CMM_FILEGRP B
            LEFT OUTER JOIN TB_CMM_BBS C ON B.BBSID = C.BBSID
		WHERE 1=1
			AND A.FILEGRPID = B.FILEGRPID
			AND A.FILEID = #{fileid}
            AND A.FILE_IDNTFC_KEY = #{fileIdntfcKey}
	</select>
	
	<!-- 파일 정보를 가져옴 -->
	<select id="selectFileInfo" parameterType="FileGrpVo" resultType="FileVo">
		/* FileDao.selectFileInfo */
		SELECT TOP 1
			A.FILEID,
			A.FILEGRPID,
			A.FILE_IDNTFC_KEY,
			B.FILEGRP_NM,
			A.FILE_PATH,
			A.SAVE_FILE_NM,
			A.ORGINL_FILE_NM,
			A.FILE_EXTSN,
			A.FILE_SIZE,
			A.ORD,
			A.REG_DT,
			A.RGTRID
		FROM TB_CMM_FILE A
		    ,TB_CMM_FILEGRP B
		WHERE 1=1
			AND A.FILEGRPID = B.FILEGRPID
			AND A.FILEGRPID = #{filegrpid}
	</select>
    
	<!-- 파일 정보를 가져옴 -->
	<select id="getFileInfo" parameterType="FileGrpVo" resultType="FileVo">
		/* FileDao.getFileInfo */
        SELECT 
            A.FILEID,
            A.FILEGRPID,
            A.FILE_IDNTFC_KEY,
            B.FILEGRP_NM,
            B.BBSID,
            C.NLOGIN_DWNLD_PERM_YN,
            A.FILE_PATH,
            A.SAVE_FILE_NM,
            A.ORGINL_FILE_NM,
            A.FILE_EXTSN,
            A.FILE_SIZE,
            A.ORD,
            A.REG_DT,
            A.RGTRID
        FROM TB_CMM_FILE A
            ,TB_CMM_FILEGRP B
            LEFT OUTER JOIN TB_CMM_BBS C ON B.BBSID = C.BBSID
        WHERE 1=1
            AND A.FILEGRPID = B.FILEGRPID
            AND A.FILEID = #{fileid}
	</select>
	
	<!-- 이전 파일 목록을 가져옴 -->
	<select id="selectOldFileList" parameterType="Integer" resultType="FileVo">
		/* FileDao.selectOldFileList */
		SELECT 
			A.FILEID,
			A.FILEGRPID,
			A.FILE_IDNTFC_KEY,
			B.FILEGRP_NM,
			A.FILE_PATH,
			A.SAVE_FILE_NM,
			A.ORGINL_FILE_NM,
			A.FILE_EXTSN,
			A.FILE_SIZE,
			A.ORD,
			A.REG_DT,
			A.RGTRID
		FROM TB_CMM_FILE A
		    ,TB_CMM_FILEGRP B
		WHERE 1=1
			AND A.FILEGRPID = B.FILEGRPID
			AND A.FILEGRPID = (SELECT FILEGRPID FROM TB_CMM_FILE WHERE FILEID = #{fileid})
			AND A.FILEID != #{fileid}
	</select>
    
    <!-- 파일다운로드 횟수를 증가시킨다. -->
    <update id="updateFileDwnldCntPlusOne" parameterType="FileVo">
        /* FileDao.updateFileDwnldCntPlusOne */
        UPDATE TB_CMM_FILE SET
            DWNLD_CNT = NVL(DWNLD_CNT, 0) + 1
        WHERE
            FILEID = #{fileid}
    </update>
</mapper>