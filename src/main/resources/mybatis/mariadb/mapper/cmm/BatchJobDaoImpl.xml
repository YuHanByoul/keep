<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : BatchJobDaoImpl.xml
    Description : 배치잡 실행시 수행하는 SQL관리
-->
<mapper namespace="com.kbrainc.plum.cmm.scheduling.model.BatchJobDao">    

    <!-- 휴면계정처리를 위해 sp_userDrmncy프로시져를 호출한다. -->
    <update id="callSpUserDrmncy" statementType="CALLABLE">
	    {
	    	/* BatchJobDao.callSpUserDrmncy */
	        call sp_userDrmncy()
	    }
	</update>
    
    <!-- 유아환경교육 안내 알림톡 발송 대상자 리스트를 반환한다 -->
    <select id="selectInfntEnveduSmsSendList" resultType="java.util.Map">
        /* BatchJobDao.selectInfntEnveduSmsSendList */
        SELECT 
            A.* 
            <if test="type == 1">
            , DATE_FORMAT(DATE_ADD(STR_TO_DATE(A.START_TIME, '%Y.%m.%d %H:%i:%S'), INTERVAL -30 MINUTE), '%Y-%m-%d %H:%i') AS SENDRSVTIME
            </if>
            <if test="type == 2">
            , DATE_FORMAT(DATE_ADD(STR_TO_DATE(A.END_TIME, '%Y.%m.%d %H:%i:%S'), INTERVAL -30 MINUTE), '%Y-%m-%d %H:%i') AS SENDRSVTIME
            </if>
        FROM (
            SELECT 
                IPA.APLYID
                , IP.PRGRM_NM 
                , IPA.INSTID 
                , IPA.USERID 
                , CU.NM AS USER_NM
                , IPA.MOBLPHON 
                , IPA.EDU_NOPE
                , IPA.TCHER_NOPE 
                , CONCAT(IPTS.DE, ' ', IPT.BGNG_TM) AS START_TIME
                , CONCAT(IPTS.DE, ' ', IPT.END_TM) AS END_TIME
            FROM TB_EDU_INFNT_PRGRM_APLY IPA
                LEFT JOIN TB_CMM_USER CU ON IPA.USERID = CU.USERID 
                LEFT JOIN TB_EDU_INFNT_PRGRM_TME_SCHDL IPTS ON IPA.TME_SCHDLID = IPTS.TME_SCHDLID 
                LEFT JOIN TB_EDU_INFNT_PRGRM_TME IPT ON IPTS.TMEID = IPT.TMEID 
                LEFT JOIN TB_EDU_INFNT_PRGRM IP ON IPT.PRGRMID = IP.PRGRMID
        WHERE 1=1
                <!-- AND IPA.STTS_CD = '180103'
                AND CU.MARKT_SMS_AGRE_YN = 'Y' -->
                AND IPA.MOBLPHON IS NOT NULL
                AND LENGTH(IPA.MOBLPHON) > 9
        ) A
        <!-- WHERE 1=1
            <if test="type == 1">
            AND STR_TO_DATE(A.START_TIME, '%Y.%m.%d %H:%i:%S') 
                BETWEEN DATE_ADD(NOW(), INTERVAL 1 HOUR) 
                AND DATE_ADD(NOW(), INTERVAL 2 HOUR)
            </if>
            <if test="type == 2">
            AND STR_TO_DATE(A.END_TIME, '%Y.%m.%d %H:%i:%S') 
                BETWEEN DATE_ADD(NOW(), INTERVAL 1 HOUR) 
                AND DATE_ADD(NOW(), INTERVAL 2 HOUR)
            </if> -->
    </select>
    
    <!-- 푸름이 이동 환경교육 안내 알림톡 발송 대상자 리스트를 반환한다 -->
    <select id="selectMvnEnveduSmsSendList" resultType="java.util.Map">
        /* BatchJobDao.selectMvnEnveduSmsSendList */
        SELECT 
            A.* 
            <if test="type == 1">
            , DATE_FORMAT(DATE_ADD(STR_TO_DATE(A.START_TIME, '%Y.%m.%d %H:%i:%S'), INTERVAL -30 MINUTE), '%Y-%m-%d %H:%i') AS SENDRSVTIME
            </if>
            <if test="type == 2">
            , DATE_FORMAT(DATE_ADD(STR_TO_DATE(A.END_TIME, '%Y.%m.%d %H:%i:%S'), INTERVAL -30 MINUTE), '%Y-%m-%d %H:%i') AS SENDRSVTIME
            </if>
        FROM (
            SELECT 
                MPA.APLYID
                , MP.PRGRM_NM 
                , MPA.INSTID 
                , MPA.USERID 
                , CU.NM AS USER_NM
                , CU.MOBLPHON 
                , MPA.EDU_NOPE 
                , CONCAT(MPTS.DE, ' ', MPT.BGNG_TM) AS START_TIME
                , CONCAT(MPTS.DE, ' ', MPT.END_TM) AS END_TIME
            FROM TB_EDU_MVMN_PRGRM_APLY MPA
                LEFT JOIN TB_CMM_USER CU ON MPA.USERID = CU.USERID 
                LEFT JOIN TB_EDU_MVMN_PRGRM_TME_SCHDL MPTS ON MPA.TME_SCHDLID = MPTS.TME_SCHDLID 
                LEFT JOIN TB_EDU_MVMN_PRGRM_TME MPT ON MPTS.TMEID = MPT.TMEID 
                LEFT JOIN TB_EDU_MVMN_PRGRM MP ON MPT.PRGRMID = MP.PRGRMID
            WHERE 1=1 
                AND MPA.STTS_CD = '180103'
                AND CU.MARKT_SMS_AGRE_YN = 'Y'
                AND CU.MOBLPHON IS NOT NULL
                AND LENGTH(CU.MOBLPHON) > 9
        ) A
        WHERE 1=1 
            <if test="type == 1">
            AND STR_TO_DATE(A.START_TIME, '%Y.%m.%d %H:%i:%S') 
                BETWEEN DATE_ADD(NOW(), INTERVAL 1 HOUR) 
                AND DATE_ADD(NOW(), INTERVAL 2 HOUR)
            </if>
            <if test="type == 2">
            AND STR_TO_DATE(A.END_TIME, '%Y.%m.%d %H:%i:%S') 
                BETWEEN DATE_ADD(NOW(), INTERVAL 1 HOUR) 
                AND DATE_ADD(NOW(), INTERVAL 2 HOUR)
            </if>
    </select>
    
    <!-- 휴면계정 전환 안내 메일 발송 대상자 리스트를 반환한다 -->
    <select id="selectDrmncyNtcMailSendUserList" resultType="java.util.Map">
        /* BatchJobDao.selectDrmncyNtcMailSendUserList */
        SELECT 
            USERID 
            , ACNT 
            , NM 
            , EML 
            , NVL(PRVC_VLDTY, 0) AS PRVC_VLDTY
            , ACNT_LOCK_CD 
            , LGN_DT 
            , REG_DT 
            , DEL_YN 
        FROM TB_CMM_USER
        WHERE DEL_YN = 'N'
            AND STTS_CD != '9'
            AND (ACNT_LOCK_CD NOT IN (101105, 101106) OR ACNT_LOCK_CD IS NULL)
            AND NVL(PRVC_VLDTY, 0) > 0
            AND REG_DT <![CDATA[<]]> DATE_ADD(NOW(), INTERVAL -(PRVC_VLDTY * 12 - 1) MONTH)
            AND LGN_DT <![CDATA[<]]> DATE_ADD(NOW(), INTERVAL -(PRVC_VLDTY * 12 - 1) MONTH)
    </select>
    
    <!-- 휴면계정 전환 대상자 리스트를 반환한다 -->
    <select id="selectDrmncyUserList" resultType="java.util.Map">
        /* BatchJobDao.selectDrmncyMailSendUserList */
        SELECT 
            USERID 
            , ACNT 
            , NM 
            , EML 
            , NVL(PRVC_VLDTY, 0) AS PRVC_VLDTY
            , ACNT_LOCK_CD 
            , LGN_DT 
            , REG_DT 
            , DEL_YN 
        FROM TB_CMM_USER
        WHERE DEL_YN = 'N'
            AND STTS_CD != '9'
            AND (ACNT_LOCK_CD NOT IN (101105, 101106) OR ACNT_LOCK_CD IS NULL)
            AND NVL(PRVC_VLDTY, 0) > 0
            AND REG_DT <![CDATA[<]]> DATE_ADD(NOW(), INTERVAL -(PRVC_VLDTY * 12) MONTH)
            AND LGN_DT <![CDATA[<]]> DATE_ADD(NOW(), INTERVAL -(PRVC_VLDTY * 12) MONTH)
    </select>
    
    <!-- 휴면계정 테이블로 이관 -->
    <insert id="insertUserdrmncyInfo">
        /* BatchJobDao.insertUserdrmncyInfo */
        INSERT INTO TB_CMM_USER_DRMNCY(
            USERID, ACNT, PSWD, NM, NCNM, MOBLPHON, TELNO, EML, BRDT, GNDR, ZIP, ADDR, ADDR_DTL
            , SIGNGU_CD, INSTID, INSTPIC_ROLE_CD, TOS_AGRE_YN, PRIVCY_AGRE_YN, PRVC_THPTY_PVSN_AGRE_YN
            , CHILD_JOIN_AGRE_YN, MARKT_EML_AGRE_YN, MARKT_SMS_AGRE_YN, WBZN_APLY_AGRE_YN, PRVC_VLDTY
            , ACNT_LOCK_YN, ACNT_LOCK_CD, SECSN_RSN, TMPR_PSWD_YN, PSWD_MDFCN_DT, STTS_CD, DEL_YN
            , BLCKLST_YN, LGN_DT, LGN_FAIL_CNT, CI, CI_PARNTS, MDFCN_DT, MDFRID, REG_DT, RGTRID
        )
        SELECT 
            USERID, ACNT, PSWD, NM, NCNM, MOBLPHON, TELNO, EML, BRDT, GNDR, ZIP, ADDR, ADDR_DTL
            , SIGNGU_CD, INSTID, INSTPIC_ROLE_CD, TOS_AGRE_YN, PRIVCY_AGRE_YN, PRVC_THPTY_PVSN_AGRE_YN
            , CHILD_JOIN_AGRE_YN, MARKT_EML_AGRE_YN, MARKT_SMS_AGRE_YN, WBZN_APLY_AGRE_YN
            , NVL(PRVC_VLDTY, 0) AS PRVC_VLDTY, ACNT_LOCK_YN, ACNT_LOCK_CD, SECSN_RSN, TMPR_PSWD_YN
            , PSWD_MDFCN_DT, STTS_CD, DEL_YN, BLCKLST_YN, LGN_DT, LGN_FAIL_CNT, CI, CI_PARNTS
            , MDFCN_DT, MDFRID, REG_DT, RGTRID
        FROM TB_CMM_USER
        WHERE USERID = #{userid}
    </insert>
    
    <!-- 사용자 테이블 휴면회원 개인정보 삭제 -->
    <update id="updateUserInfo">
        /* BatchJobDao.updateUserInfo */
        UPDATE TB_CMM_USER
        SET
            NM = '휴면회원'
            , MOBLPHON = NULL
            , TELNO = NULL
            , BRDT = NULL
            , GNDR = NULL
            , ZIP = NULL
            , ADDR = NULL
            , ADDR_DTL = NULL
            , SIGNGU_CD = NULL
            , ACNT_LOCK_YN = 'Y'
            , ACNT_LOCK_CD = '101105'
        WHERE USERID = #{userid}
    </update>
    
    <!-- 3개월 이상 지난 알림메세지 삭제 -->
    <delete id="deleteOldNtcMsg">
        /* BatchJobDao.deleteOldNtcMsg */
        DELETE FROM TB_CMM_NTCN
        WHERE REG_DT <![CDATA[<]]> DATE_ADD(NOW(), INTERVAL -3 MONTH)
    </delete>
    
    <!-- 전문가 섭외자와 대상 전문가 대상 알림 메시지 발송 대상자 리스트를 반환한다 -->
    <select id="selectExprtEduMsgSendUser" parameterType="int" resultType="java.util.Map">
        /* BatchJobDao.selectExprtEduMsgSendUser */
        SELECT 
            ALD.DMNDID 
            , ALD.EXPRTID
            , ECU.NM AS ASS_NM
            , ECU.MOBLPHON AS ASS_MOBLPHON
            , ECU.EML AS ASS_EML
            , ALD.USERID 
            , CU.NM 
            , ALD.MOBLPHON 
            , ALD.EML 
            , ALD.DMND_STTS_CD 
            , ALD.EDU_NOPE 
            , DATE_FORMAT(ALD.LCTR_BGNG_DT, '%Y.%m.%d %H:%i:%S') AS LCTR_BGNG_DT
            , DATE_FORMAT(DATE_ADD(ALD.LCTR_BGNG_DT, INTERVAL -30 MINUTE), '%Y-%m-%d %H:%i') AS BFR_SEND_DT
            , DATE_FORMAT(ALD.LCTR_END_DT, '%Y.%m.%d %H:%i:%S') AS LCTR_END_DT
            , DATE_FORMAT(ALD.LCTR_END_DT, '%Y-%m-%d %H:%i') AS AFTR_SEND_DT
            , AE.EXPRT_TYPE_CD 
            , AE.LCTR_GDNC_RCPTN_YN 
            , AE.STTS_CD 
        FROM TB_ASS_LCTR_DMND ALD
            LEFT JOIN TB_CMM_USER ECU ON ALD.EXPRTID = ECU.USERID 
            LEFT JOIN TB_CMM_USER CU ON ALD.USERID = CU.USERID 
            LEFT JOIN TB_ASS_EXPRT AE ON ALD.EXPRTID = AE.USERID 
        WHERE 
            ALD.DMND_STTS_CD = '139104'
            AND AE.STTS_CD = '134103'
            <if test="type == 1">
                AND ALD.LCTR_BGNG_DT BETWEEN DATE_ADD(NOW(), INTERVAL 1 HOUR) AND DATE_ADD(NOW(), INTERVAL 2 HOUR)
            </if>
            <if test="type == 2">
                AND ALD.LCTR_END_DT BETWEEN DATE_ADD(NOW(), INTERVAL 1 HOUR) AND DATE_ADD(NOW(), INTERVAL 2 HOUR)
            </if>
    </select>
    
    <!-- 미입금 시설예약 취소처리 메일 발송 대상자 리스트를 반환한다 -->
    <select id="selectFlctRsvCancleUserList" resultType="java.util.Map">
        /* BatchJobDao.selectFlctRsvCancleUserList */
        SELECT A.*
            , DATE_FORMAT(A.DPST_LMT_DT, '%Y.%m.%d') AS DPST_LMT_DT_STR
        FROM (
            SELECT 
                FSA.APLYID 
                , FAR.RSVTDEID 
                , FSA.APLCNT_NM 
                , FSA.APLCNT_EML 
                , FF.FCLT_NM 
                , FS.SPCE_NM 
                , FSA.APLY_DT 
                , DATE_FORMAT(FSA.APLY_DT, '%Y.%m.%d %H:%i') AS APLY_DT_STR
                , FSR.BGNG_DT 
                , DATE_FORMAT(FSR.BGNG_DT, '%Y.%m.%d %H:%i') AS BGNG_DT_STR
                , CASE
                    WHEN DATE_ADD(FSA.APLY_DT, INTERVAL 7 DAY) > FSR.BGNG_DT
                        THEN DATE_ADD(FSR.BGNG_DT, INTERVAL 1 DAY)
                    ELSE DATE_ADD(FSA.APLY_DT, INTERVAL 7 DAY)
                END AS DPST_LMT_DT
                , FSA.APLY_STTS_CD 
                , FSA.STLM_STTS_CD 
                , FSA.NOPE_ADULT 
                , FSA.NOPE_CHIL 
                , FSA.NOPE_INFNT 
            FROM TB_FCL_SPCE_APLY FSA
                LEFT JOIN TB_FCL_APLY_RSVTDE FAR ON FSA.APLYID = FAR.APLYID 
                LEFT JOIN TB_FCL_SPCE_RSVTDE FSR ON FAR.RSVTDEID = FSR.RSVTDEID 
                LEFT JOIN TB_FCL_SPCE FS ON FSR.SPCEID = FS.SPCEID 
                LEFT JOIN TB_FCL_FCLT FF ON FS.FCLTID = FF.FCLTID 
            WHERE FSA.APLY_STTS_CD = '160101'
                AND FSA.STLM_STTS_CD = '161101'
        ) A
        WHERE A.DPST_LMT_DT <![CDATA[<]]> NOW()
    </select>
    <!-- 미입금 시설예약 취소처리 -->
    <update id="updateFlctRsvCancle" parameterType="int">
        /* BatchJobDao.updateFlctRsvCancle */
        UPDATE
            TB_FCL_SPCE_APLY
        SET
            APLY_STTS_CD = '160103'
            , CNCL_RSN_CD = '215103'
            , MDFCN_DT = SYSDATE()
            , MDFRID = 10000001
        WHERE 
            APLYID = #{aplyId}
    </update>
    
    <!-- 시설 이용자 대상 만족도 평가 안내 메시지 발송 대상자 리스트를 반환한다 -->
    <select id="selectFlctRsvDgstfnNtcMsgSend" resultType="java.util.Map">
        /* BatchJobDao.selectFlctRsvDgstfnNtcMsgSend */
        SELECT 
            FSA.APLYID 
            , FAR.RSVTDEID 
            , FSA.APLCNT_NM AS NM
            , FSA.APLCNT_MOBLPHON AS MOBLPHON 
            , FF.FCLT_NM 
            , FS.SPCE_NM 
            , FSR.END_DT 
            , DATE_FORMAT(FSR.END_DT, '%Y-%m-%d %H:%i') AS END_DT_STR
            , FSA.APLY_STTS_CD 
            , FSA.STLM_STTS_CD 
            , FSA.NOPE_ADULT 
            , FSA.NOPE_CHIL 
            , FSA.NOPE_INFNT 
        FROM TB_FCL_SPCE_APLY FSA
            LEFT JOIN TB_FCL_APLY_RSVTDE FAR ON FSA.APLYID = FAR.APLYID 
            LEFT JOIN TB_FCL_SPCE_RSVTDE FSR ON FAR.RSVTDEID = FSR.RSVTDEID 
            LEFT JOIN TB_FCL_SPCE FS ON FSR.SPCEID = FS.SPCEID 
            LEFT JOIN TB_FCL_FCLT FF ON FS.FCLTID = FF.FCLTID 
        WHERE FSA.APLY_STTS_CD = '160101'
            AND FSA.STLM_STTS_CD = '161101'
            AND FSR.END_DT BETWEEN DATE_ADD(NOW(), INTERVAL 1 HOUR) AND DATE_ADD(NOW(), INTERVAL 2 HOUR)
    </select>
	
</mapper>