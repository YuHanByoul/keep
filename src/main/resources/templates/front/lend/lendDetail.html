<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" 
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout" 
    layout:decorator="layout/front/subLayout" >
<body>
<script type="text/javascript" src="../files/assets/pages/accordion/accordion.js"></script>
<div layout:fragment="content">
    <div class="product-wrap sub-banner-swiper">
        <div class="thumb-swiper">
        
            <div class="swiper gallery-thumb">
            
                <div class="swiper-wrapper">
                    <div class="swiper-slide" th:if="${rprsImgFileInfo}!=null">
                        <div class="thumb">
                            <img th:src="@{/downloadFileByFileid.do?fileid=}+${rprsImgFileInfo.fileid}+@{&file_idntfc_key=}+${rprsImgFileInfo.fileIdntfcKey}" alt="" 
                                 onerror="this.src='/images/front/bg/bg-noimage.png'; this.style.objectFit='none';"/>
                        </div>
                    </div>
                    <th:block th:each="item : ${dtlImgFileList}">
                    <div class="swiper-slide">
                        <div class="thumb">
                            <img th:src="@{/downloadFileByFileid.do?fileid=}+${item.fileid}+@{&file_idntfc_key=}+${item.fileIdntfcKey}" alt="" 
                             onerror="this.src='/images/front/bg/bg-noimage.png'; this.style.objectFit='none';" />
                        </div>
                    </div>
                    </th:block>
                </div>
                <button type="button" class="swiper-button-next"></button>
                <button type="button" class="swiper-button-prev"></button>
            </div>
            
            <div thumbsSlider="" class="swiper gallery-list">
                <div class="swiper-wrapper">
                    <div class="swiper-slide" th:if="${rprsImgFileInfo}!=null">
                        <div class="thumb">
                            <img th:src="@{/downloadFileByFileid.do?fileid=}+${rprsImgFileInfo.fileid}+@{&file_idntfc_key=}+${rprsImgFileInfo.fileIdntfcKey}" alt=""
                                 onerror="this.src='/images/front/bg/bg-noimage.png'; this.style.objectFit='scale-down'; this.style.padding='5px';"/>
                        </div>
                    </div>
                    <th:block th:each="item : ${dtlImgFileList}">
                    <div class="swiper-slide">
                        <div class="thumb">
                            <img th:src="@{/downloadFileByFileid.do?fileid=}+${item.fileid}+@{&file_idntfc_key=}+${item.fileIdntfcKey}" alt="" 
                                 onerror="this.src='/images/front/bg/bg-noimage.png'; this.style.objectFit='scale-down'; this.style.padding='5px';"/>
                        </div>
                    </div>
                    </th:block>
                </div>
            </div>
        </div>
        <div class="product-section">
            <div class="title">
            
                <div class="tag tag-green" th:if ="${lendInfo.periodStts == 'W'}">모집대기</div>
                <div class="tag tag-gray" th:if ="${lendInfo.periodStts == 'E'}">모집종료</div>
                <div class="tag tag-blue" th:if ="${lendInfo.periodStts == 'C'}">모집중</div>
                
                <h3><th:block th:text="${lendInfo.rcritNm}"/></h3>
                <dl>
                    <div class="list">
                        <dt>꾸러미명  :</dt>
                        <dd><th:block th:text="${lendInfo.packageNm}"/></dd>
                    </div>
                    <div class="list">
                        <dt>교육주제  :</dt>
                        <dd><th:block th:text="${lendInfo.eduSbjctCdNm}"/></dd>
                    </div>
                    <div class="list">
                        <dt>교육대상  :</dt>
                        <dd><th:block th:text="${lendInfo.eduTrgtCdNm}"/></dd>
                    </div>
                    <div class="list">
                        <dt>모둠구성  :</dt>
                        <dd><th:block th:text="${lendInfo.teamCmpstnCdNm}"/></dd>
                    </div>
                    <div class="list">
                        <dt>교육유형  :</dt>
                        <dd><th:block th:text="${lendInfo.eduTypeCdNm}"/></dd>
                    </div>
                    <div class="list">
                        <dt>모집 기간 :</dt>
                        <dd><th:block th:text="${#dates.format(lendInfo.bgngDt, 'yyyy-MM-dd HH:mm')+' ~ '+#dates.format(lendInfo.endDt, 'yyyy-MM-dd HH:mm')}"/></dd>
                    </div>
                </dl>
            </div>
            <div class="btn-wrap">
                <div class="left">
                   <th:block th:if="${mapFileInfo != null and #lists.size(mapFileInfo) > 0}">
                   <a href="javascript:viewPdf()" class="btn-medium btn-outline-blue btn-before-blank" >지도안 보기</a>
                   <a href="javascript:onDownloadMapFiles()" class="btn-medium btn-outline-black btn-before-download">지도안 다운로드</a>
                   </th:block>
                   <th:block th:if="${eduPhotoFileList != null}">
                   <a href="javascript:onDownloadEduPhoto();" class="btn-medium btn-outline-black btn-before-download" >교육사진 다운로드</a>
                   </th:block>
                </div>
            </div>
        </div>
    </div>
  
    <div class="box-form-list">
     <ul>
         <li th:each ="item:${rndList}"  th:id="'rnd'+${item.rndid}"  class="chasi-frm"  th:data-totalCnt="${item.totalCnt}" >
             <div class="left">
                 <div class="num">
                     <strong>[[${item.ordr}]]차</strong>
                     <th:block  th:if ="${lendInfo.periodStts eq 'E'}" >
                         <div class="tag tag-disabled" >모집 기간 종료</div>
                     </th:block>  
                     <th:block  th:unless ="${lendInfo.periodStts eq 'E'}" >
                         <div class="tag tag-green tag-disabled" th:if ="${item.sttsCd eq 'L'}" >대여기간종료</div>  
                         <div class="tag tag-red"    th:if ="${item.sttsCd eq 'S'}" >재고 소진</div>
                         <div class="tag tag-green"    th:if ="${item.sttsCd eq 'O'}" >신청 가능</div>
                     </th:block>
                 </div>
                 <div class="detail">
                     <span class="fc-black6">대여기간</span>
                     <span class="fc-black3"><th:block th:text="${item.bgngDe +' ~ '+item.endDe}"/></span>
                     <span class="fc-black6">(재고 <i class="fc-blue"> <th:block th:text="${item.totalCnt}"/> </i>개)</span>
                 </div>
             </div>
             <div class="right">
                 <select title="수량선택" style="width:120px;" th:disabled="${lendInfo.periodStts eq 'E' or item.sttsCd ne'O'}"  th:id="requestQnty"
                         th:rndid ="${item.rndid}" th:onchange="onchangeEventCheck(this.getAttribute('rndid'))" >
                     <option value="0">수량선택</option>
                     <th:block th:if="${ lendInfo.lmtCd =='225101' or lendInfo.lmtCd =='225103'}">
                     <option value="1">1</option>
                     </th:block>
                     <th:block th:unless="${ lendInfo.lmtCd =='225101' or lendInfo.lmtCd =='225103'}">
                     <option value="1">1</option>
                     <option value="2">2</option>
                     </th:block> 
                 </select>
                 <button type="button" class="btn-medium btn-green" th:rndid ="${item.rndid}" onclick="requestAply(this.getAttribute('rndid'))" disabled>신청</button>
             </div>
         </li>
       </ul>
    </div>
    
    <div class="tab-content tab-sub dropDown">
        <button type="button" class="tab-mobile-trigger trigger" aria-expanded="true">상세정보</button>
        <ul class="tab-list target" >
            <li class="tab active" ><button data-controls="tab-subpanel01" id="tab-sub01"  >상세정보</button></li>
            <li class="tab"        ><button data-controls="tab-subpanel02" id="tab-sub02"  >유의사항</button></li>
            <li class="tab"        ><button data-controls="tab-subpanel03" id="tab-sub03"  >후기</button></li>
        </ul>
        <div id="tab-subpanel01" class="tabpanel active" >
            <h3 class="blind">상세정보</h3>
            <div class="youtube-frame" th:if ="${lendInfo.mvpUrl != null and lendInfo.mvpUrl != '' and lendInfo.mvpPstnCd =='226101' }" >
                <iframe  th:src="'https://www.youtube.com/embed/'+${lendInfo.mvpUrl}" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
            </div>
            <div class="table-col table-layout-auto">
               <th:block th:if ="${lendInfo.dtlCn != null and lendInfo.dtlCn != ''}" th:utext="${lendInfo.dtlCn}" />
               <th:block th:unless ="${lendInfo.dtlCn != null and lendInfo.dtlCn != ''}" >등록된 상세정보가 없습니다.</th:block>
            </div>
            <div class="youtube-frame" th:if ="${lendInfo.mvpUrl != null and lendInfo.mvpUrl != '' and lendInfo.mvpPstnCd =='226102' }" >
                <iframe  th:src="'https://www.youtube.com/embed/'+${lendInfo.mvpUrl}" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
            </div>
        </div>
        
        <div id="tab-subpanel02" class="tabpanel" >
           <h3 class="blind">유의사항</h3>
           <div class="box-desc-list bg7" > 
                <th:block th:if ="${lendInfo.atentMttr != null and lendInfo.atentMttr != ''}"  th:utext="${lendInfo.atentMttr}"/>
                <th:block th:unless ="${lendInfo.atentMttr != null and lendInfo.atentMttr != ''}">등록된 유의사항이 없습니다.</th:block>
            </div>
        </div>
        
        <div id="tab-subpanel03" class="tabpanel" >
           <h3 class="blind">후기</h3>
            <div class="accordion-content acc-list" id="replyListArea"></div>
            <div id="reply_pagination"></div>
        </div>
    </div>
    <div class="btn-wrap">
        <div class="center">
            <button type="button" class="btn-medium btn-gray" onclick="returnToList()">목록</button>
        </div>
    </div>
    
    <form id="replyFrom">
	    <input type="hidden" id="pageNumber" name="pageNumber" value="1">
	    <input type="hidden" id="rowPerPage" name="rowPerPage" value="10">
	    <input type="hidden" id="orderDirection" name="orderDirection" value="desc">
	    <input type="hidden" id="orderField" name="orderField" value="REG_DT">
	    <input type="hidden" id="rcritid" name="rcritid" th:value="${lendInfo.rcritid}">
    </form>
    
    <form id="aplyForm">
	    <input type="hidden" id="rcritid" name="rcritid" th:value="${lendInfo.rcritid}">
	    <input type="hidden" id="rndid"   name="rndid" value="">
	    <input type="hidden" id="qnty"    name="qnty"  value="">
    </form>
    
    <form id="backToListForm" >
        <input type="hidden" id="pageNumber" name="pageNumber" th:value="${(params != null and params.pageNumber > 0 )? params.pageNumber:1}"    >
        <input type="hidden" id="eduTypeCd"  name="eduTypeCd"  th:value="${params.eduTypeCd}"  >
        <input type="hidden" id="eduTrgtCd"  name="eduTrgtCd"  th:value="${params.eduTrgtCd}" >
        <input type="hidden" id="rcritNm"    name="rcritNm"    th:value="${params.rcritNm}"   >
        <input type="hidden" id="typeCd"     name="typeCd"     th:value="${params.typeCd}"    >
        <input type="hidden" id="eduSbjctCd" name="eduSbjctCd"     th:value="${params.eduSbjctCd}"    >
        <input type="hidden" id="pageNumber" name="pageNumber" th:value="${params.pageNumber}"    >
    </form>
    
    <script src="/js/common/handlebars/handlebars-v4.7.7.js"></script>   
    <script src="/js/common/handlebars/handlebars.helper.js"></script>
    
    <!--  masking 처리 계정으로 할 경우 {{rgtrNm}}  ==> {{rgtrAcnt}} 으로 변경 -->
    <script id="replyListTemplate" type="text/x-handlebars-template">
       {{#each replyList}}
          <h3 class="acc-title active">
              <span  class="acc-trigger mo-flex-wrap"  title="후기" >
                  <span class="name"> {{rgtrNm}} </span>
                  <span class="rate" title="별점">
                    {{#each rvwScrArr}}
                      <span class="icon icon-star" title="별점"></span>
                    {{/each}}
                  </span>
              </span>
          </h3>
          <div id="accordion-panel0" role="region"  class="acc-panel active">
              <div class="acc-content bg-white p0 fc-black6 fw-300">
                  {{{rvwCn}}}
              </div>
          </div>
      {{/each}}
    </script>
    <script id="noReplyTemplate" type="text/x-handlebars-template">
       <div class="nodata" style="border:none;" >
         <p><span class="icon icon-notice bg-black9"></span> 등록된 후기가 없습니다.</p>
       </div>
    </script>
    <script th:inline="javascript">
        /*<![CDATA[*/ 
        var currentUser = /*[[${session.user}]]*/ null;
        var lendInfo = /*[[${lendInfo}]]*/null; 
        var rndList = /*[[${rndList}]]*/null; 
        var eduPhotoFileList = /*[[${eduPhotoFileList}]]*/null; 
        var mapFileInfo = /*[[${mapFileInfo}]]*/null; 
        /*]]>*/
        var portalUrl = /*[[${T(com.kbrainc.plum.rte.util.CommonUtil).portalUrl}]]*/ "";
        var noDataMeg = '<li class="block"><div class="nodata"><p><span class="icon icon-notice bg-black9"></span>등록된 후기가 없습니다.</p></div></li>';
        var replyListTemplet = Handlebars.compile($("#replyListTemplate").html());
        var noReplyTemplate = Handlebars.compile($("#noReplyTemplate").html());
        
        $(function(){
            selectReplyList();
        })
        function onDownloadEduPhoto() {
            for(var i = 0, len = eduPhotoFileList.length; i < len; i++) {
                var data = eduPhotoFileList[i];
                downloadFileByFileid(data.fileid, data.fileIdntfcKey);
                onDelay(1000);
            }
        }
        function onDownloadMapFiles() {
            for(var i = 0, len = mapFileInfo.length; i < len; i++) {
                var data = mapFileInfo[i];
                downloadFileByFileid(data.fileid, data.fileIdntfcKey);
                onDelay(1000);
            }
        }
        function onDelay(time) {
            var start = new Date().getTime();
            while(start + time > new Date().getTime());
        }

        function viewPdf(){
        	for(var i = 0, len = mapFileInfo.length; i < len; i++) {
                var data = mapFileInfo[i];
                var pdfUrl ='/js/pdfjs/web/viewer.html?file=/' + data.filegrpNm + '/' + data.saveFileNm;
                window.open(pdfUrl,"","");
            }
       }
       function returnToList(){
           var f = document.forms.backToListForm ;
           f.action = "/front/lend/LendList.html?";
           f.submit();
       }
       function selectReplyList() {
           if (displayWorkProgress(true)){
               $.ajax({
                   url : "/front/lend/selectLendReplyList.do",
                   cache : false,
                   dataType : 'json',
                   data : $("#replyFrom").serialize(),
                   type : 'POST',
                   success : function(data) {
                       renderingReplyData(data.list);
                       if(data.totalCount == 0) {
                           $("#replyListArea").html(noReplyTemplate());
                           $("#reply_pagination").html('');
                       }else{
                           $("#reply_pagination").html(data.pagination);
                       }
                       closeWorkProgress();
                   }
               });
           }
       }
       function renderingReplyData(list){
           list.forEach(function(item){
               var arr= [] 
               for(var i= 0 ; i < item.rvwScr;i++){
            	   arr.push('1');
               }
	           item.rvwScrArr = arr;
           })
           $("#replyListArea").html(replyListTemplet({replyList:list}));
       }
       function goPage(page) {
           $("#replyFrom #pageNumber").val(page);
           selectReplyList();
       }
       function onchangeEventCheck(rndid){
           let plusedQnty = Number($("#rnd"+rndid+" #requestQnty").val()); 
    	   let limitCnt  = (lendInfo.lmtCd =='225101' || lendInfo.lmtCd =='225103')? 1:2;
    	   var totalCnt = $("#rnd"+rndid).attr("data-totalCnt");
    	   if(limitCnt < plusedQnty){alert("한 개차시에 "+limitCnt+"개 까지 신청 할 수 있습니다."); $("#rnd"+rndid+" #requestQnty").val(0); return;}
           if(totalCnt < plusedQnty){alert("재고 이상으로 입력 할수 없습니다."); $("#rnd"+rndid+" #requestQnty").val(0); return;}
           $("#rnd"+rndid+" .btn-green").attr("disabled",(plusedQnty>0)? false:true);
       }
       function requestAply(rndid){
    	   if(currentUser ==null){
        	   alert("로그인 후 이용 가능합니다.");
        	   return;
           }
    	   if(currentUser.roleInfo.roleid !='3'){
        	   alert("기관 회원만 신청 가능합니다.");
        	   return;
           }
           var qnty  = Number($("#rnd"+rndid+" #requestQnty").val());
           if(qnty ==null || qnty =="" ||qnty <=0){
               alert("수량을 입력해주십시오");
               showErrorMark("#rnd"+rndid+" #requestQnty");
               return;
           }

           $("#rndid").val(rndid);
           $("#qnty").val(qnty);
           
           if (displayWorkProgress(true)){
               $.ajax({
                   url : "/front/lend/checkLendAply.do",
                   cache : false,
                   dataType : 'json',
                   data : $("#aplyForm").serialize(),
                   type : 'POST',
                   success : function(data) {
                       if(data.result =="fail"){
                           alert(data.msg);
                       }else{
				           let f = document.forms.aplyForm;
				           f.action = "/front/lend/lendAply.html";
				           f.submit();
                       }
                       closeWorkProgress();
                   }
               });
           }
       }
       
       var swiper = new Swiper(".gallery-list", {
           loop: false,
           spaceBetween: 0,
           slidesPerView: 5,
           freeMode: true,
           watchSlidesProgress: true,
       });
       var swiper2 = new Swiper(".gallery-thumb", {
           loop: false,
           spaceBetween: 10,
           thumbs: {
               swiper: swiper,
           },
           navigation: {
               nextEl: ".swiper-button-next",
               prevEl: ".swiper-button-prev",
           },
           a11y: {
               prevSlideMessage: '이전 슬라이드',
               nextSlideMessage: '다음 슬라이드',
           },
       });
       
       
    </script>
   </div>
</body>
</html>