<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" 
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout" 
    layout:decorator="layout/front/subLayout" >
<body>
    <div layout:fragment="content">
        <!-- content -->
        <form class="search-filter" id="searchForm" name="searchForm" onsubmit="return false;" >
        
            <div class="form-input-wrap">
                    <div class="form-row">
                        <div class="form-header"><strong class="label">교구명</strong></div>
                        <div class="form-body">
                            <input type="search" title="교구명"  placeholder="교구명을 입력해 주세요." id="rcritNm" name="rcritNm" th:value="${params.rcritNm}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-header"><strong class="label">교육유형</strong></div>
                        <div class="form-body">
                            <span kattr:select_code="eduTypeCd" grpCd="187" title="교육유형" firstOptTxt="- 전체 -"  th:attr ="selectedCd=${params.eduTypeCd}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-header"><strong class="label">교육대상</strong></div>
                        <div class="form-body">
                           <span kattr:select_code="eduTrgtCd" grpCd="185" title="교육유형" firstOptTxt="- 전체 -" th:attr ="selectedCd=${params.eduTrgtCd}">  
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-header"><strong class="label">교구유형</strong></div>
                        <div class="form-body">
                           <span kattr:select_code="typeCd" grpCd="184" title="교육유형" firstOptTxt="- 전체 -" th:attr ="selectedCd=${params.typeCd}">
                                                   
                        </div>
                    </div>
                    <div class="form-row">
	                    <div class="form-header"><strong class="label">교육주제</strong></div>
	                    <div class="form-body">
	                        <div class="form-input">
	                            <select name="searchManinEduSbjctCd" id="searchEduSbjctCd_1" title="주제" onchange="setSearchSelectBox.setNextDepth(155,this.value,'eduSbjctCd')">
	                                <option value="" selected>- 전체 -</option>
	                            </select>
	                            <select name="eduSbjctCd" id="eduSbjctCd"  title="주제 상세" style="flex:auto">
	                                <option value="" selected>- 전체 -</option>
	                            </select>                           
	                        </div>
	                    </div>
	                </div>
                </div>
            
            <div class="search-filter-submit">
                <button type="button" class="btn-medium btn-gray btn-before-refresh" onclick="initSearch();">초기화</button>
                <button type="submit" class="btn-medium btn-green btn-before-search" onclick="onSearch();">검색</button>
            </div>
            <input type="hidden" id="pageNumber"     name="pageNumber"     th:value="${(params != null and params.pageNumber > 0 )? params.pageNumber:1}"    >
            <input type="hidden" id="rowPerPage"     name="rowPerPage"     value="12" >
            <input type="hidden" id="orderDirection" name="orderDirection" value="desc">
            <input type="hidden" id="orderField"     name="orderField"     value="REG_DT">
            <input type="hidden" id="rcritid"        name="rcritid"        value="0">
        </form>
        <div class="rank-list" th:if="${#lists.size(rankList)}  > 0 ">
             <ul>
                 <li th:each="item:${rankList}"><th:block th:text="${item.NM}"></li>
             </ul>
        </div>
        <div class="table-caption flex-nowrap">
            <div class="left">
                <p>총 <b id="totalCount">0</b> 건</p>
            </div>
        </div>
        <div class="card-section" id="lendList">
        </div>
        <div id="pagination">
        </div>

    <!-- //content -->
    <script src="/js/common/handlebars/handlebars-v4.7.7.js"></script>   
    <script src="/js/common/handlebars/handlebars.helper.js"></script>
    <script id="lendListTemplate" type="text/x-handlebars-template">
       <ul class="n3">
       {{#each lendList}}
       <li   {{#if isEnd }} class="disabled" {{/if}} >
              <div class="flag {{tagStr}}">{{sttsStr}}</div>

              <ul class="type">
                  <li><button type="button" title="툴팁"><span class="icon {{typeIcon}} "></span></button><div>{{typeCdNm}}</div></li>
                  <li><button type="button" title="툴팁"><span class="icon {{eduTypeIcon}}"></span></button><div>{{eduTypeCdNm}}</div></li>
              </ul>

              <div class="thumb">
                  <img src="/downloadFileByFileid.do?fileid={{rprsImgFileid}}&file_idntfc_key={{rprsImgFileKey}}" alt="" onerror="this.src='/images/front/bg/bg-noimage.png'; this.style.objectFit='none';">
                  <dl class="target">
                      <dt class="blind">대상</dt>
                      <dd>
                          {{#if eduTrgtCd1 }}<div>유아</div>{{/if}}
                          {{#if eduTrgtCd2 }}<div>아동</div>{{/if}}
                          {{#if eduTrgtCd3 }}<div>청소년</div>{{/if}}
                          {{#if eduTrgtCd4 }}<div>성인</div>{{/if}}
                      </dd>
                  </dl>
              </div>
              <div class="cont">
                  <a href="javascript:goDetail('{{rcritid}}')" class="title ellipsis" data-ellipsis="2">{{{rcritNm}}}</a>
                  <div class="fs-14 fc-black6">모집기간 : {{{bgngDt}}} ~  {{endDt}}</div>
                  <ul class="hash">
                      {{#if eduSbjctCd1 }}<li><button type="button" title="툴팁">#생활환경</button><div>소음, 폐기물 및 자원순환, 환경보건</div></li>{{/if}}
                      {{#if eduSbjctCd2 }}<li><button type="button" title="툴팁">#자연환경</button><div>물, 토양, 생태계</div></li>{{/if}}
                      {{#if eduSbjctCd3 }}<li><button type="button" title="툴팁">#지구환경</button><div>기후변화 및 탄소중립, 대기, 에너지</div></li>{{/if}}
                      {{#if eduSbjctCd4 }}<li><button type="button" title="툴팁">#환경문화</button><div>지속가능발전, 생명윤리</div></li>{{/if}}
                      {{#if eduSbjctCd5 }}<li><button type="button" title="툴팁">#기타</button><div>기타</div></li>{{/if}}
                  </ul>
              </div>
       </li>
      {{/each}}
       </ul>
    </script>
    
    <script th:inline="javascript">
    
	    /*<![CDATA[*/ 
	    var rankList = /*[[${rankList}]]*/null; 
	    var params = /*[[${params}]]*/null; 
	    /*]]>*/
	    var noDataMsg = '<div class="nodata" style="border:none;" ><p><span class="icon icon-notice bg-black9"></span>등록된 대여모집이 없습니다.</p></div>';
	    
	    $(function(){
		    
	    	var returnEduSbjctCd = "";
	    	if(params.eduSbjctCd !=null && params.eduSbjctCd != "" && params.eduSbjctCd.length > 0){
	    		returnEduSbjctCd = params.eduSbjctCd.substring(0,6)
		    }
            setSearchSelectBox.fn_getNextDepthList(155 , 0, 'searchEduSbjctCd_1',returnEduSbjctCd);
            setSearchSelectBox.setNextDepth(155,returnEduSbjctCd,'eduSbjctCd',params.eduSbjctCd)
		    selectLendList();
		})
		
		var listTemplet = Handlebars.compile($("#lendListTemplate").html());
		
		function initSearch(){
			$("#rcritNm").val("");
			$("#eduTrgtCd").val("");
			$("#typeCd").val("");
			$("#searchEduSbjctCd_1").val("").trigger("change");
			$("#eduTypeCd").val("");
		}
		function onSearch(){
			$("#pageNumber").val('1');
			selectLendList();
		}
		function selectLendList() {
		    if (displayWorkProgress(true)){
		        $.ajax({
		            url   : "/front/lend/selectLendList.do",
		            cache : false,
                    async : false,
		            dataType : 'json',
		            data : $("#searchForm").serialize(),
		            type : 'POST',
		            success : function(data) {
		            	renderingListData(data.list);
		            	$("#totalCount").text(data.totalCount);
		                if(data.totalCount == 0) {
		                	$("#lendList").html(noDataMsg);
		                    $("#pagination").html('');
		                }else{
		                    $("#pagination").html(data.pagination);
		                }
		                closeWorkProgress();
		            }
		        });
		    }
		}
		function renderingListData(list){
			
			list.forEach(function(item){
				if(item.periodStts == 'W'){
                    item.tagStr = ' bg-green';
                    item.sttsStr = '모집대기';
					item.isEnd = false;
				}else if(item.periodStts == 'E'){
                    item.tagStr = ' bg-black6';
                    item.sttsStr = '모집종료';
					item.isEnd = true;
				}else{
					item.tagStr = ' bg-blue ';
					item.sttsStr = '모집중';
					item.isEnd = false;
				}
				item.eduTrgtCdNm = item.eduTrgtCdNm.replaceAll(",","</br>") ;
				item.eduSbjctCdNm = item.eduSbjctCdNm.replaceAll("/,","</br>").replaceAll("/","");

				item.eduTypeIcon = (item.eduTypeCd == "187101")?' icon-card-tooltip04 ':" icon icon-card-tooltip02 ";
				item.typeIcon = (item.typeCd == "184101")?' icon-card-tooltip03 ':(item.typeCd == "184101")? ' icon-card-tooltip01 ':' icon-card-tooltip05';
				
				var eduTrgtCdArr = item.eduTrgtCd.split(",");
				var eduSbjctCdArr = item.eduSbjctCd.split(",");
				
				eduSbjctCdArr.forEach(function(cd){
					if( cd.substring(0,6) == "155101" ){item.eduSbjctCd1 = true };
					if( cd.substring(0,6) == "155102" ){item.eduSbjctCd2 = true };
					if( cd.substring(0,6) == "155103" ){item.eduSbjctCd3 = true };
					if( cd.substring(0,6) == "155104" ){item.eduSbjctCd4 = true };
					if( cd.substring(0,6) == "155105" ){item.eduSbjctCd5 = true };
				})
				eduTrgtCdArr.forEach(function(cd){
					if( cd == "185101" ){item.eduTrgtCd1 = true };
					if( cd == "185102" ){item.eduTrgtCd2 = true };
					if( cd == "185103" ){item.eduTrgtCd3 = true };
					if( cd == "185104" ){item.eduTrgtCd4 = true };
				})
				
				item.bgngDt = (item.bgngDt).substring(0,10); 
				item.endDt  = (item.endDt).substring(0,10); 
			})
			
		    $("#lendList").html(listTemplet({lendList:list}));
		}
		function goPage(page) {
		    $("#pageNumber").val(page);
		    selectLendList();
		}
		function enterkey() {
		    if (window.event.keyCode == 13) {
		    	selectLendList();
		    }
		}
		function goDetail(rcritid){
            var f = document.forms.searchForm ;
            f.action = "/front/lend/lendDetail.html";
            f.rcritid.value=rcritid;
            f.submit();
		}
		
        var getCodeListUrl = "/mng/customAttr/grpCodeList.do"
            
            var setSearchSelectBox = {
                fn_getNextDepthList : function(grpcd , upprcd, targetId,selected){
                    $.ajax({
                        url : getCodeListUrl,
                        type: 'GET',
                        cache : false,
                        async:false,
                        dataType: 'json',
                        data: {
                              grpcd  : grpcd
                            , upprcd : upprcd
                        }, 
                        success : function (data){
                            setSearchSelectBox.writeHtml(grpcd,targetId,data,selected);
                        },
                        error : function (error){
                        } 
                        
                    });
                },
                
                writeHtml : function(grpcd,targetId,list,selected){
                    var cntArr = targetId.split("_");
                    var nextCnt = Number(cntArr[1])+1;
                    var nextTarget = cntArr[0]+"_"+nextCnt;
                       
                    var html ="<select id='"+targetId+"' onchange=setSearchSelectBox.setNextDepth('"+grpcd+"',this.value,'"+nextTarget+"')>";
                        html +="    <option value='' selected>- 전체 -</option>";
                        
                      for(var i=0 ; i < list.length;i++){
                        if(list[i].cd==selected ){
                        html +="    <option value="+list[i].cd+" selected>"+ list[i].cdNm+ "</option>";
                        }else{
                        html +="    <option value="+list[i].cd+">"+ list[i].cdNm+ "</option>";
                        }
                      }
                      if(list.length == 0 && jQuery("#"+nextTarget)[0] != undefined){
                        setSearchSelectBox.writeHtml(grpcd,nextTarget,list,"");
                      }
                      html +="    </select>";
                      $("#"+targetId).html(html);
                },
                
                setNextDepth : function(grpcd , upprcd , targetId,selected){
                    setSearchSelectBox.fn_getNextDepthList(grpcd , upprcd , targetId,selected);
                }
            }
        
        </script>
    </div>
</body>
</html>