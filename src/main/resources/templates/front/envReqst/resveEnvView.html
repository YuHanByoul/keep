<html xmlns:th="http://wwwymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="layout/front/subLayout">
<div layout:fragment="content">
    <link rel="stylesheet" href="/css/front/flatpickr.min.css">
    <script type="text/javascript" src="/files/bower_components/moment/moment.js" charset="utf-8"></script>
    <script src="/js/front/flatpickr.js"></script>
    <script src="/js/front/flatpickr-locale-ko.js"></script>
    <script src="/js/front/flatpickr-locale-ko.js"></script>

    <div class="product-wrap sub-banner-swiper">
        <div class="thumb-swiper">
            <div class="swiper gallery-thumb">
                <div class="swiper-wrapper">
                    <th:block th:if="${rprsImgFileMap}">
                        <div class="swiper-slide" th:each="item : ${rprsImgFileMap}" th:id="${item.fileid}">
                            <div class="thumb">
                                <img th:src="@{'/downloadFileByFileid.do?fileid='+${item.fileid}+'&file_idntfc_key='+${item.fileIdntfcKey}}" alt="" 
                                   onerror="this.src='/images/front/bg/bg-noimage.png'; this.style.objectFit='none';" />
                            </div>
                        </div>
                    </th:block>
                    <th:block th:if="${dtlImgFileMap}">
                        <div class="swiper-slide" th:each="item : ${dtlImgFileMap}" th:id="${item.fileid}">
                            <div class="thumb">
                                <img th:src="@{'/downloadFileByFileid.do?fileid='+${item.fileid}+'&file_idntfc_key='+${item.fileIdntfcKey}}" alt="" 
                                    onerror="this.src='/images/front/bg/bg-noimage.png'; this.style.objectFit='none'; " />
                            </div>
                        </div>
                    </th:block>
                </div>
                <button type="button" class="swiper-button-next"></button>
                <button type="button" class="swiper-button-prev"></button>
            </div>
            <div thumbsSlider="" class="swiper gallery-list">
                <div class="swiper-wrapper">
                    <th:block th:if="${rprsImgFileMap}">
                        <div class="swiper-slide" th:each="item : ${rprsImgFileMap}" th:id="${item.fileid}">
                            <div class="thumb">
                                <img th:src="@{'/downloadFileByFileid.do?fileid='+${item.fileid}+'&file_idntfc_key='+${item.fileIdntfcKey}}" alt=""
                                onerror="this.src='/images/front/bg/bg-noimage.png'; this.style.objectFit='scale-down'; this.style.padding='5px';"/>
                            </div>
                        </div>
                    </th:block>
                    <th:block th:if="${dtlImgFileMap}">
                        <div class="swiper-slide" th:each="item : ${dtlImgFileMap}" th:id="${item.fileid}">
                            <div class="thumb">
                                <img th:src="@{'/downloadFileByFileid.do?fileid='+${item.fileid}+'&file_idntfc_key='+${item.fileIdntfcKey}}" alt=""
                                onerror="this.src='/images/front/bg/bg-noimage.png'; this.style.objectFit='scale-down'; this.style.padding='5px';"/>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
        </div>
        <div class="product-section">
            <div class="title">
                <h3 th:text ="'['+${envReqst.instNm}+']'+${envReqst.fcltNm}"></h3>
                <p th:text ="${envReqst.addr}+' '+${envReqst.addrDtl}"></p>
            </div>
            <div class="btn-wrap">
                <div class="left">
                    <th:block th:if = "${gdncFileMap} != null ">
                        <a th:each="item:${gdncFileMap}" th:href="@{'/downloadFileByFileid.do?fileid='+${item.fileid}+'&file_idntfc_key='+${item.fileIdntfcKey}}" class="btn-medium btn-outline-black btn-before-download">안내자료 다운로드</a>
                    </th:block>
                </div>
            </div>
            
            <th:block th:if="${envReqst.aplyMthdCd} == '153102'">
                <div class="detail">
                    <div class="desc">
                        <p>해당 시설은 별도 홈페이지를 통해 예약을 신청할 수 있으며, 아래 예약신청 바로가기 버튼을 눌러 예약 페이지로 이동하실 수 있습니다.</p>
                        <p class="desc-info fc-blue mt10">외부 사이트에서 신청한 예약은 통합환경플랫폼 마이페이지에서 확인하실 수 없습니다.</p>
                    </div>
                    <dl>
                        <div class="list">
                            <dt></dt>
                            <dd>
                                <a th:href="'http://'+${envReqst.extnlUrl}" target="_blank" class="btn-medium btn-green" title="예약신청 새창열림">예약신청 바로가기</a>
                            </dd>
                        </div>
                    </dl>
                </div>
            </th:block>
            
        </div>
    </div>
    <th:block th:if="${envReqst.aplyMthdCd} == '153101'">
        <div class="reservation-wrap">

            <div class="search-filter mb20">
                <div class="form-input mo-flex-wrap">
                    <strong class="label">공간 선택</strong>
                    <div class="form-input">
                        <select title="공간 선택" style="width:auto;" name="spceList" onchange="selectSpce(this);">
                            <option value="">선택</option>
                            <option th:each="item : ${spceList}" th:value="${item.spceid}" th:text="${item.spceNm}+', 최대'+${item.maxNope}+'명, '+${item.size}+'평형'"
                            ></option>
                        </select>
                    </div>
                    <strong class="label">이용 형태</strong>
                    <div class="form-check-list">
                        <label class="inp"><input type="radio" name="utztnSe" value="169101"><b>숙박</b></label>
                        <label class="inp"><input type="radio" name="utztnSe" value="169102"><b>대여</b></label>
                    </div>
                </div>
            </div>

            <div class="reservation-inner">
                <div class="left">
                    <input type="date" id="flatpickr" name="flatpickr" datepicker="true" class="blind">
                </div>
                <div class="right">
                        <!--대여 선택시 표출 테이블 -->
                        <div class="table-col table-layout-auto table-col-sm" id="timeTable" style="display:none;">
                            <table>
                                <caption>환경교육시설 예약 - 선택, 시간, 가격</caption>
                                <colgroup>
                                    <col style="width:65px;">
                                </colgroup>
                                <thead>
                                <tr>
                                    <th scope="col"><span class="">선택</span></th>
                                    <th scope="col">시간</th>
                                    <th scope="col">가격</th>
                                </tr>
                                </thead>
                                <tbody id="timeList">
                                </tbody>
                            </table>
                        </div>
                    
                    <div class="detail">
                        <dl>
                            <div class="list">
                                <dt><span>이용인원 <i class="ast" title="필수 입력"> * </i></span><p class="fs-14 fc-black6">최대 <span id="maxNope">0</span>인</p></dt>
                                <dd>
                                    <div class="form-input d-flex mo-flex-wrap al a-center j-between pt0 pb0">
                                        <div class="form-input" style="flex:1;max-width:calc(100% / 3 - 10px)">
                                            <div class="bul fs-14">성인</div>
                                            <div class="form-input form-input-number">
                                                <input type="number" id="nopeAdult" name="nopeAdult" min="0" title="성인" class="ac pl0 pr0" value="0">
                                                <div class="btn-number">
                                                      <button type="button" class="num-up"   title="숫자 증가" ></button>
                                                      <button type="button" class="num-down" title="숫자 감소" ></button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-input" style="flex:1;max-width:calc(100% / 3 - 10px)">
                                            <div class="bul fs-14">아동</div>
                                            <div class="form-input form-input-number">
                                                <input type="number" id="nopeChil"  name="nopeChil" min="0"  title="아동" class="ac pl0 pr0" value="0">
                                                <div class="btn-number"><button type="button" class="num-up" title="숫자 증가"></button><button type="button" class="num-down" title="숫자 감소"></button></div>
                                            </div>
                                        </div>
                                        <div class="form-input" style="flex:1;max-width:calc(100% / 3 - 10px)">
                                            <div class="bul fs-14">유아</div>
                                            <div class="form-input form-input-number">
                                                <input type="number" id="nopeInfnt" name="nopeInfnt" min="0" title="유아" class="ac pl0 pr0" value="0">
                                                <div class="btn-number"><button type="button" class="num-up" title="숫자 증가"></button><button type="button" class="num-down" title="숫자 감소"></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </dd>
                            </div>
                        </dl>
                        <dl>
                            <div class="list">
                                <dt><span>이용목적 <i class="ast" title="필수 입력"> *</i></dt>
                                <dd>
                                    <div class="form-input">
                                        <textarea title="이용목적" id="utztnPrps"></textarea>
                                    </div>
                                </dd>
                            </div>
                        </dl>
                        <dl class="last">
                            <div class="list">
                                <dt>이용일시</dt>
                                <dd><span id="useDate"></span> <span id="useTime"></span></dd>
                            </div>
                            <div class="list">
                                <dt>금액</dt>
                                <dd><span class="fc-blue fw-700 fs-18" id="useAmt">0원</span></dd>
                            </div>
                        </dl>
                    </div>
                    <div class="btn-wrap">
                        <div class="right">
                            <a href="javascript:aplyResve()" class="btn-medium btn-green" id="submitData">예약신청</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-content tab-sub dropDown">
            <button type="button" class="tab-mobile-trigger trigger"  aria-expanded="true">상세정보</button>
            <ul class="tab-list target" >
                <li class="tab active"><button data-controls="tab-subpanel01" id="tab-sub01" >상세정보</button></li>
                <li class="tab"><button data-controls="tab-subpanel02" id="tab-sub02" >후기(<span class="total-count"></span>)</button></li>
            </ul>
            <div id="tab-subpanel01" class="tabpanel active" >
                <h3 class="blind">상세정보</h3>
                <th:block th:text="${envReqst.dtlCn}"/>
            </div>
            
            <div id="tab-subpanel02" class="tabpanel"  >
                <h3 class="blind">후기</h3>
                <form id="searchForm" name="searchForm" onsubmit="return false;">
                    <input type="hidden" id="pageNumber" name="pageNumber" value="1">
                    <input type="hidden" id="rowPerPage" name="rowPerPage" value="10"/>
                    <input type="hidden" id="orderField" name="orderField" value="RVW_DT">
                    <input type="hidden" id="ORDER_DIRECTION" name="orderDirection" value="desc">
                </form>
                
                <div class="accordion-content acc-list" id="list-area"></div>
                <div class="pagination" id="pagination" aria-label="pagination"></div>
            </div>
        </div>
    </th:block>

    <th:block th:if="${envReqst.aplyMthdCd} == '153102'">
        <div class="table-caption">
            <div class="left">
                <h3 class="sub-title">시설소개</h3>
            </div>
        </div>
        <p th:utext="${envReqst.dtlCn}"></p>
    </th:block>
    <div class="btn-wrap">
        <div class="center">
            <button type="button" class="btn-medium btn-gray" onclick="javascript:returnToList()">목록</button>
        </div>
    </div>

    <form id="viewForm" method="get" onsubmit="return false;">
        <input type="hidden" id="fcltid" name="fcltid" th:value="${envReqst.fcltid}">
        <input type="hidden" id="spceid" name="spceid">
        <input type="hidden" name="nopeAdult" value="0">
        <input type="hidden" name="nopeChil" value="0">
        <input type="hidden" name="nopeInfnt" value="0">
        <input type="hidden" id="utztnSeCd" name="utztnSeCd">
        <input type="hidden" id="rsvtdeids" name="rsvtdeids">
        <input type="hidden" name="utztnPrps">
    </form>
    
    <form id="backToListForm" >
        <input type="hidden" id="pageNumber"       name="pageNumber"        th:value="${(params != null and params.pageNumber > 0 )? params.pageNumber:1}"    >
        <input type="hidden" id="instNm"           name="instNm"            th:value="${params.instNm}"  >
        <input type="hidden" id="fcltNm"           name="fcltNm"            th:value="${params.fcltNm}" >
        <input type="hidden" id="searchRgnCd"      name="searchRgnCd"       th:value="${params.searchRgnCd}"   >
        <input type="hidden" id="searchAplyMthdCd" name="searchAplyMthdCd"  th:value="${params.searchAplyMthdCd}"    >
        <input type="hidden" id="maxNope"          name="maxNope"           th:value="${params.maxNope}"    >
        <input type="hidden" id="searchBgngDt"     name="searchBgngDt"      th:value="${params.searchBgngDt}"    >
        <input type="hidden" id="searchEndDt"      name="searchEndDt"       th:value="${params.searchEndDt}"    >
    </form>

    <script th:inline="javascript">

	    /*<![CDATA[*/ 
	    var currentUser = /*[[${session.user}]]*/ null;
        var aplyMthdCd = /*[[${envReqst.aplyMthdCd}]]*/null;
	    /*]]>*/
        var mode = "range"
        var isInitCal = false;
        const skip = `<button type="button" class="skipCal">달력 넘기기</button>`;
        
        /* 이용 형태 변경 event(숙박 or 대여) */
        $(document).on('change', 'input[name="utztnSe"]' , function () {
            var selectedVal = $('select[name="spceList"]').val()
            if(selectedVal ==null || selectedVal ==''){
                alert("공간을 선택해주십시오.");
                $('input[name="utztnSe"]').prop("checked",false);
                return;
            }
            resetData();
            if( $(this).val() == '169101' ){// 숙박
                mode = 'range';
                $('.dot-blue').show();
                $('.dot-red').hide();
            }else{// 대여
                mode = 'single';
                $('.dot-blue').hide();
                $('.dot-red').show();
            }
            $('#spceid').val(selectedVal);
            isInitCal = false;
            makeCalendarEvent(moment().format("YYYY-MM-DD"),selectedVal, mode);
            
            for( var i=0; i<spceList.length; i++ ){
                if( spceList[i].spceid == selectedVal ){
                    // 선택한 이용공간의 정보
                    maxNope = spceList[i].maxNope;
                    aplyLimitDays = spceList[i].rsvtPsbltyDaycnt;
                    $('#maxNope').text(maxNope);
                }
            }
            utztnSeCd = $(this).val();
        });

        // 공간리스트
        var spceList = /*[[${spceList}]]*/null;
        // 선택한 날짜 seq 리스트
        var selectedRsvtdeidList = [];
        var selectedRsvtdeids = [];
        // 최대정원
        var maxNope;
        // 선택한 인원 수
        var userCnt;
        // 이용금액
        var selectedAmt;
        // 예약 가능 일수 (금일부터)
        var aplyLimitDays = 0;
        // 대여인지, 숙박인지 구분값(대여 : 169102, 숙박 : 169101)
        var utztnSeCd = '169101';
        var selectedTimeList = [];
        var datepicker = null;
        var today = moment().format('YYYY-MM-DD') //date2str(parseDate(new Date()), 'yyyy-mm-dd');
        var newToday = new Date(today);
        
        let list01 = '<ul><li class="dot-white">예약불가</li><li class="dot-blue">숙박</li><li class="dot-red">대여</li><ul>';

        // 초기화용 picker
        var initFlatpickr = function(){
            datepicker = flatpickr("#flatpickr",{
                mode: "single",
                minDate: "today",
                dateFormat: "Y-m-d",
                locale: "ko",
                inline: true,
                position: "bottom center",
                onDayCreate: function(dObj, dStr, fp, dayElem) {
                },
                onChange: function(dObj, dStr, fp, dayElem) {
                    if($('select[name="spceList"]').val() == "" || $('input[name="utztnSe"]:checked').val()==null  ){
                        alert("먼저 공간 및 숙박/대여 여부를 선택 하세요");
                        $(".flatpickr-day").removeClass(" selected startRange endRange"); 
                        return false;
                    }
                }
            });
        }
        
        $(function(){
            
        	initFlatpickr();
        	
            $(document).off('keyup', '.form-input-number input[type="number"]');
            $(document).off('click', '.form-input-number button');
            
            //인원수 버튼 컨트롤
            $(document).on('keyup', '.form-input-number input[type="number"]' , function () {

                const numInput = $(this);
                const valueMin = parseInt(numInput[0].min);
                const valueMax = parseInt(numInput[0].max);
                let inputId = $(this).attr('id');
                
                if (numInput.val() > valueMax) {
                    numInput.val(valueMax)
                }
                if (numInput.val() < valueMin) {
                    numInput.val(valueMin)
                }
                
                let tempCnt = 0;
                $('.form-input-number input[type="number"]').each(function(){
                    tempCnt += parseInt(this.value);
                })
                
                if( tempCnt > maxNope ){
                    alert('최대 '+maxNope+'명 까지만 신청 가능합니다.');
                    $('input[name='+inputId+']').val(0);
                    numInput.val(0);
                }else{
                    userCnt = tempCnt;
                    $('input[name='+inputId+']').val(this.value);
                }
            });

            $(document).on('click', '.form-input-number button' , function () {
                const par = $(this).closest('.form-input-number');
                const numInput = par.find('input[type="number"]');
                const valueMin = parseInt(numInput[0].min);
                const valueMax = parseInt(numInput[0].max);
                //value up
                if ($(this).hasClass('num-up')) {
                    userCnt++;
                    if (numInput.val() === '') {
                        numInput.val(0)
                    }
                    if (valueMax > numInput.val() || numInput[0].max === '') {
                        if( userCnt > maxNope ){
                            userCnt--;
                            if( userCnt == maxNope ){
                                alert('최대 '+maxNope+'명 까지만 신청 가능합니다.');
                                numInput.val(parseInt(numInput.val()));
                            }
                        }else{
                            numInput[0].value++;
                        }
                    }
                }
                //value down
                if ($(this).hasClass('num-down')) {
                    if (numInput.val() === '') {
                        numInput.val(0)
                    }
                    if (numInput.val() > valueMin || numInput[0].min === '') {
                        numInput[0].value--;
                        userCnt--;
                    }
                }
                let inputId = $(numInput).attr('id');
                $('input[name='+inputId+']').val(numInput.val());
            });
            //후기 목록 호출 
            if(aplyMthdCd != "153102"){
	            selectResveEnvRvwList();
            }
        })
        
        
        function date2str(x, y) {
            var z = {
                m: x.getMonth() + 1,
                d: x.getDate(),
                H: x.getHours(),
                M: x.getMinutes(),
                S: x.getSeconds()
            };

            y = y.replace(/(m+|d+|H+|M+|S+)/g, function(v) {
                return ((v.length > 1 ? "0" : "") + z[v.slice(-1)]).slice(-2)
            });

            return y.replace(/(y+)/g, function(v) {
                return x.getFullYear().toString().slice(-v.length)
            });
        }

        function parseDate(strDate) {
            var _strDate = strDate;
            var _dateObj = new Date(_strDate);
            if(_dateObj.toString() == 'Invalid Date') {
                _strDate = _strDate.split('.').join('-');
                _dateObj = new Date(_strDate);
            }
            if(_dateObj.toString() == 'Invalid Date') {
                var _parts = _strDate.split(' ');

                var _dateParts = _parts[0];
                _dateObj = new Date(_dateParts);

                if (_parts.length > 1) {
                    var _timeParts = _parts[1].split(':');
                    _dateObj.setHours(_timeParts[0]);
                    _dateObj.setMinutes(_timeParts[1]);
                    if (_timeParts.length > 2) {
                        _dateObj.setSeconds(_timeParts[2]);
                    }
                }
            }
            return _dateObj;
        }
        
        var envReqstView = {
            fcltid: /*[[${envReqst.fcltid}]]*/null,
            updateUrl: '/front/envReqst/updateEnvReqst.html',
            listUrl: '/front/envReqst/envReqstList.html',
            moveToUpdateForm() {
                this.submit(this.updateFormUrl);
            },
            moveToUpdate() {
                this.submit(this.updateUrl);
            },
            submit(url) {
                let f = document.forms.viewForm;
                f.action = url;
                f.submit();
            }
        };
        
        let list02 = '<ul><li class="dot-white">예약불가</li><li class="dot-blue">숙박</li><li class="dot-red">대여</li><ul>';

        // Better always use a two digit format in your dates obj
        function get2DigitFmt(val) {
            return ('0' + val).slice(-2);
        }

        function selectSpce(el){
            // 숙박,대여 라디오 버튼 초기화 
            $('input[name="utztnSe"]').prop('checked', false);
            //데이터 초기화
            resetData();
            //flatpicker 초기화 
            initFlatpickr();
        }

        //데이터 초기화 
        function resetData(){
            userCnt = 0;
            selectedAmt = 0;
            $('.form-input-number input[type="number"]').val(0);
            $('#timeTable').hide();
            $('#utztnPrps').val('');
            $('#useTime').empty();
            $('#useDate').empty();
            $('#useAmt').text(0);
            $('#rsvtdeids').val("");
            selectedStrtTmTimeList = [];
            selectedEndTmTimeList = [];
            selectedRsvtdeids = [];
        }

        function checkData(){
            
            let startDate = $('#startDate').val();
            let endDate   = $('#endDate').val();
            let time      = null;
            let nopeCnt   = userCnt;
            let utztnPrps = $('#utztnPrps').val();
            let utztnSeCd = $('#utztnSeCd').val();
            let rsvtdeid  = $('#rsvtdeid').val();
            let rsvtdeids  = $('#rsvtdeids').val();
            let utztnSe   = $('[name=utztnSe]:checked').val()

            var selectedVal = $('select[name="spceList"]').val()
            if(selectedVal ==null || selectedVal ==''){
                alert("공간을 선택해주십시오.");
                $('input[name="utztnSe"]').prop("checked",false);
                return;
            }
            if( utztnSe == '' || utztnSe == 'undefined' ||utztnSe==null ){
                alert('숙박/대여 여부를 선택해 주세요.');
                return false;
            }
            if( startDate == '' || endDate == '' ){
                alert('이용날짜를 선택해 주세요.');
                return false;
            }
            if(rsvtdeids == null || rsvtdeids == ""){
                alert(  (utztnSeCd == '169102')?"이용시간":"이용일" + '을 체크해 주세요.');
                return false;
            }
            if( nopeCnt == 0 ){
                alert('이용인원수를 입력해 주세요.');
                return false;
            }
            if( utztnPrps == '' || utztnPrps.trim()==''){
                alert('이용목적을 입력해 주세요.');
                showErrorMark("#utztnPrps");
                return false;
            }
            if( utztnPrps.length >= 200  ){
                alert('이용목적은 200자 이하여야 합니다.');
                showErrorMark("#utztnPrps");
                return false;
            }
            return true;
        }

        function makeCalendarEvent(yearDayStr, spceid, mode ){

        	let yyyymm = "";
            yyyymm =(yearDayStr==null || yearDayStr=='undefined')?moment().format("YYYY-MM-DD"):yearDayStr;
            
            var params = {
                 spceid   : spceid
                ,utztnSe  : mode
                ,startDt  : moment(yyyymm).format("YYYY-MM-DD")
                ,enddDt   : moment(yyyymm).format("YYYY-MM-")+moment(yyyymm).daysInMonth()
            }
            
            if( mode == 'single' ){
                list02 = '<ul><li class="dot-white">예약불가</li><li class="dot-red">대여</li><ul>';
            }else{
                list02 = '<ul><li class="dot-white">예약불가</li><li class="dot-blue">숙박</li><ul>';  
            }
            
            if(displayWorkProgress(true)){
                $.ajax({
                    url : "/front/envReqst/selectSpceRsvtdeList.do",
                    type: 'POST',
                    cache : false,
                    dataType: 'json',
                    data : params,
                    success : function (data){
                        let list = data.rsvtdelist;
                        let enableDates = [];
                        let disableDates = [];
                        let datesKind = {};
                        
                        if(list.length > 0){
                            
                            list.forEach(function(item){
                                let de = item.de;
                                // let amt = (item.amt=='0')? "무료":addComma3(item.amt)+'원';
                                              
                                if( item.fullYn == 0 ){ // 이미 신청 되어 있거나 승인된 이벤트가 없는
                                    if(item.utztnSeCd == '169102'){//대여
                                        if( item.todayRsvtPsbltyYn == 'Y' ){
                                            datesKind[de] = '1';
                                            enableDates.push(de);
                                        }else{
                                            if(moment(newToday).format("YYYY-MM-DD") != moment(new Date(de)).format("YYYY-MM-DD") ){
                                                datesKind[de] = '1';
                                                enableDates.push(de);
                                            }
                                        }
                                    }else{//숙박
                                        if( item.todayRsvtPsbltyYn == 'Y' ){
                                            datesKind[de] = '0';
                                            enableDates.push(de);
                                        }else{
                                        	if( moment(newToday).format("YYYY-MM-DD") != moment(new Date(de)).format("YYYY-MM-DD") ){
                                                datesKind[de] = '0';
                                                enableDates.push(de);
                                            }
                                        }
                                    }
                                }
                            })
                        }
                            
                            
                        let classDict = {                                  
                                '0' : ['dot-blue','숙박'],                   
                                '1' : ['dot-red','대여'],                    
                        };               
                        
                        if(!isInitCal){
                            datepicker.clear();
	                        resetFlatpicker(mode,spceid);
	                        isInitCal = true;
                        }
                        datepicker.set({enable:[]});
                        datepicker.config.selectedDates= null;
                        datepicker.set({
                            defaultDate :moment(yyyymm).format("YYYY-MM-DD"),
                            enable:enableDates
                            });
                        datepicker.config.onDayCreate.push(
                            function(dObj, dStr, fp, dayElem) {
                                var date = dayElem.dateObj;                        
                                var calDate = moment(date).format("YYYY-MM-DD");   
                                var value = classDict[datesKind[calDate]];         
                                if (value) {                                       
                                    dayElem.className +=' ' + value[0];            
                                    dayElem.title = value[1]                       
                                }                                                  
                            }                                
                        );
                        datepicker.config.onChange.push(
                                function(selectedDates, dateStr, instance) {
                                	   calendarOnchangeEvent(data,mode,selectedDates,dateStr,datesKind) 
	                            } 
                        );
                        datepicker.redraw();
                        $('#timeTable').hide();
                   
                        closeWorkProgress();
                    }
                });
            }
        }
        
        function resetFlatpicker(mode,spceid){
        	datepicker.clear();
            datepicker = flatpickr("#flatpickr",{
                mode: mode,
                dateFormat: "Y-m-d",
                maxDate : moment().add(aplyLimitDays+1,'day').format("YYYY-MM-DD"), 
                minDate: "today",
                locale: "ko",
                inline: true,
                position: "bottom center",
                onReady : function () {
                    const datepickerWrap = this.calendarContainer;
                    const datepickerList = document.createElement('div')
                    datepickerList.classList.add('datepicker-list')
                    datepickerWrap.appendChild(datepickerList)
                    datepickerList.insertAdjacentHTML('beforeend', list02);

                    const reservWrap = document.querySelector('.reservation-inner .left');
                    const datepickerSkip = document.createElement('div');
                    datepickerSkip.classList.add('blind');
                    datepickerSkip.insertAdjacentHTML('beforeend', skip);
                    this.input.after(datepickerSkip);
                }
                , onMonthChange :function(selectedDates, dateStr, instance){
                	instance.selectedDates=[];
                    let currentMonth = (instance.currentMonth=="0")?"12":instance.currentMonth;
                    moment(instance.currentYear+"-"+currentMonth).add(1,"month").format("YYYY-MM")
                    makeCalendarEvent(moment(instance.currentYear+"-"+currentMonth).add(1,"month").format("YYYY-MM"), spceid, mode );
                    resetData();
                  }
            });
        }

        $(document).on('click', '.skipCal', function () {
            
            $(this).closest('.left').next().attr('tabindex','0').focus();
            console.log(1)
        })
        
        function  calendarOnchangeEvent(data,mode,selectedDates,dateStr,datesKind){

            selectedRsvtdeidList = [];
            selectedRsvtdeids = [];
            resetData();
            if( mode == 'single' ){
                // 대여
                var str = '';
                $('#timeList').empty();
                $('#timeTable').hide();
                for( var t=0;  t< data.rsvtdelist.length; t++ ){
                    
                    let innerData = data.rsvtdelist[t];
                    let target1 = new Date(innerData.de);
                    //체킹 한 날자
                    let target2 = new Date(dateStr);
                    let disabledStr = 'disabled';
                    if( innerData.fullYn == '0' ){ disabledStr = ''; }
                    
                    if( moment(target1).isSame(target2)){
                        
                        let amt = (innerData.amt=='0')? "무료":addComma3(innerData.amt)+'원';
                        
                        str = '<tr class="tr-check">' +
                              '<td><label class="inp vm">'+
                              '<input type="checkbox" data-strtTm="'+innerData.strtTm
                                +'" data-endTm="'+innerData.endTm
                                +'" id="rsvtdeTime'+innerData.rsvtdeid
                                +'" name="rsvtdeTime" data-amt="'
                                +innerData.amt+'" value="'+innerData.rsvtdeid+'" '+disabledStr+'>'
                              +'</label></td>' +
                              '<td class="timeStr">'+innerData.strtTm +' ~ '+ innerData.endTm+'</td>' +
                              '<td>'+amt+'</td>' +
                              '</tr>';
                        $('#timeList').append(str);
                    }
                }
                
                $('#timeTable').show();
                $('#startDate').val(dateStr);
                $('#endDate').val(dateStr);
                //$('#useAmt').text((selectedAmt==0)?"무료":addComma3(selectedAmt)+'원');
                $('#useAmt').text(addComma3(selectedAmt)+'원');
                $('#useDate').text( moment(new Date(dateStr)).format('YYYY년 MM월 DD일'));
                
            }else{
                // 숙박
                $('#timeList').empty();
                $('#timeTable').hide();
                if( selectedDates.length > 1 ) {
                    let selectedDatesList = [];
                    let target1 = new Date(selectedDates[0]);
                    let target2 = new Date(selectedDates[1]);
                    
                    $('#startDate').val(date2str(parseDate(selectedDates[0]), 'yyyy-mm-dd'));
                    $('#endDate').val(date2str(parseDate(selectedDates[1]), 'yyyy-mm-dd'));
                    
                    if( !moment(target1).isSame(target2)){
                        // 2일 이상
                        let dateList = getDatesStartToLast(date2str(parseDate(selectedDates[0]), 'yyyy-mm-dd'), date2str(parseDate(selectedDates[1]), 'yyyy-mm-dd'));
                        for( var s=0; s<selectedDates.length; s++ ){
                            selectedDatesList.push(date2str(parseDate(selectedDates[s]), 'yyyy년 mm월 dd일'));
                        }
                        
                        for( var da=0; da<dateList.length; da++ ){
                            for( var da2=0; da2<data.rsvtdelist.length; da2++ ){
                                let innerData = data.rsvtdelist[da2];
                                let daTarget1 = new Date(dateList[da]);
                                let daTarget2 = new Date(innerData.de);
                                
                                if( moment(daTarget1).isSame(daTarget2)){
                                    selectedRsvtdeidList.push({rsvtdeid : innerData.rsvtdeid});
                                    selectedRsvtdeids.push(innerData.rsvtdeid);
                                    selectedAmt += innerData.amt;
                                }
                            }
                        }
                        $('#useDate').text(selectedDatesList.join(' ~ ') + " ("+dateList.length+"박)");
                        //$('#useDate').text(selectedDatesList.join(' ~ ') + " (익일 체크아웃)");
                        $('#useAmt').text(addComma3(selectedAmt)+'원');
                        //$('#useAmt').text((selectedAmt==0)?"무료":addComma3(selectedAmt)+'원');
                        $('#amt').val(selectedAmt);
                        $('#rsvtdeid').val(JSON.stringify(selectedRsvtdeidList));
                        $('#rsvtdeids').val(selectedRsvtdeids.join(","));
                    }else{
                        if( datesKind[dateStr] != 1 ){
                            // 당일 숙박
                            let dateList = getDatesStartToLast(date2str(parseDate(selectedDates[0]), 'yyyy-mm-dd'), date2str(parseDate(selectedDates[1]), 'yyyy-mm-dd'));
                            selectedDatesList.push(date2str(parseDate(selectedDates[0]), 'yyyy년 mm월 dd일'));
                            for( var da2=0; da2<data.rsvtdelist.length; da2++ ){
                                let innerData = data.rsvtdelist[da2];
                                let daTarget1 = new Date(dateList[0]);
                                let daTarget2 = new Date(innerData.de);
                                if( moment(daTarget1).isSame(daTarget2) ){
                                    selectedRsvtdeidList.push({rsvtdeid : innerData.rsvtdeid});
                                    selectedRsvtdeids.push(innerData.rsvtdeid);
                                    selectedAmt += innerData.amt;
                                }
                            }
                            
                            $('#useDate').text(selectedDatesList + " ("+dateList.length+"박)" ); 
                            //$('#useDate').text(selectedDatesList + " ("+selectedDatesList.length+"박"+(selectedDatesList.length+1)+"일)" );
                            //$('#useDate').text(selectedDatesList + " (익일 체크아웃)" );
                            $('#useAmt').text((selectedAmt==0)?"무료":addComma3(selectedAmt)+'원');
                            $('#amt').val(selectedAmt);
                            $('#rsvtdeid').val(JSON.stringify(selectedRsvtdeidList));
                            $('#rsvtdeids').val(selectedRsvtdeids.join(","));
                        }
                    };
                }
            }
        }

        $(document).on('change', 'input[name="rsvtdeTime"]' , function () {
        	selectedRsvtdeids=[];
        	$('input[name="rsvtdeTime"]').each(function(){
            	if($(this).prop('checked')){
            		selectedRsvtdeids.push($(this).val());	
                }
            })
            
            var strtTm = $(this).attr('data-strtTm');
            var endTm = $(this).attr('data-endTm');
            
            if( $(this).prop('checked') ){
                // 이용시간 선택 시
                selectedAmt += parseInt($(this).attr('data-amt'));
                selectedStrtTmTimeList.push(strtTm);
                selectedEndTmTimeList.push($(this).attr('data-endTm'));
            }else{
                selectedAmt -= parseInt($(this).attr('data-amt'));
                for( var i=0; i<selectedStrtTmTimeList.length; i++){
                    if( selectedStrtTmTimeList[i] === strtTm ){
                        selectedStrtTmTimeList.splice(i, 1);
                    }
                }
                for( var i=0; i<selectedEndTmTimeList.length; i++){
                    if( selectedEndTmTimeList[i] === endTm ){
                        selectedEndTmTimeList.splice(i, 1);
                    }
                }
            }
            
            if( selectedStrtTmTimeList.length > 0 && selectedEndTmTimeList.length > 0 ){
                var min = selectedStrtTmTimeList.reduce((prev,curr) => {
                    // 이전것과 비교해 더 작은 것 리턴
                    return prev <= curr ? prev : curr;
                });

                var max = selectedEndTmTimeList.reduce((prev,curr) => {
                    // 이전것과 비교해 더 큰 것을 리턴
                    return prev <= curr ? curr : prev;
                });

                $('#useTime').text(min+' ~ '+max);
            }else{
                $('#useTime').text('');
            }
            let selectedAmtStr = (selectedAmt==0)?"무료":addComma3(selectedAmt)+'원';
            $('#rsvtdeids').val(selectedRsvtdeids.join(","));
            $('#useAmt').text(selectedAmtStr);
            $('#amt').val(selectedAmt);
        });

        function aplyResve(){
            
            if(currentUser ==null){
                alert("로그인 후 이용 가능합니다.");
                return;
            }
            if( checkData() ){
                $('input[name="utztnPrps"]').val($('#utztnPrps').val());
                envReqstView.moveToUpdate();
            }
        }
        
        /**************************************************/
        //후기 리스트 호출
        function selectResveEnvRvwList() {
            
            $('#list-area').empty();
            var formData = $('#searchForm').serializeArray()
            let param = [];
            param.push({name: 'fcltid', value: envReqstView.fcltid});
            formData = formData.concat(param);
            if (displayWorkProgress(true)) {
                $.ajax({
                    url: '/front/envReqst/selectResveEnvRvwList.do',
                    cache: false,
                    dataType: 'json',
                    data: formData,
                    type: 'POST',
                    success: function (data) {
                        $("#list-area").html(makeListHtml(data.list));
                        if( data.list == null || data.list.length <= 0 ){
                            $("#pagination").html('');
                        }else{
                            $("#pagination").html(data.pagination);
                        }
                        $(".total-count").html(data.totalCount);
                        closeWorkProgress();
                    }
                });
            }
        }

        function makeListHtml(list) {
            var html = "";
            if (list == null || list.length <= 0) {
                html += `<div class="nodata" style="border:none"><p><span class="icon icon-notice bg-black9"></span>등록된 후기가 없습니다.</p></div>`;
            } else {
                list.forEach(function (item) {
                    html += '<h3 class="acc-title active">' +
                             '<span class="acc-trigger mo-flex-wrap">' +
                             '<span class="name">'+item.maskAcnt+'</span>' +
                             '<span class="rate" title="별점4">';
                    for( var i=0; i<item.rvwScr; i++ ){
                        html += '<span class="icon icon-star" title=""></span>';
                    }
                    html += '</span>' +
                            '</span>' +
                            '</h3>' +
                            '<div class="acc-panel active">' +
                              '<span class="blind">후기</span>' +
                               '<div class="acc-content bg-white p0 fc-black6 fw-300">이용공간 : '+item.spceNm+'</div>'+
                               '<div class="acc-content bg-white p0 fc-black6 fw-300">'+item.rvwCn+'</div>'+
                            '</div>';
                })
            }
            return html;
        }

        function returnToList(){
            var f = document.forms.backToListForm ;
            f.action = "/front/envReqst/envReqstList.html";
            f.submit();
        }
        
        var swiper = new Swiper(".gallery-list", {
            loop: false,
            spaceBetween: 0,
            slidesPerView: 5,
            freeMode: true,
            watchSlidesProgress: true,
        });
        var swiper2 = new Swiper(".gallery-thumb", {
            loop: false,
            spaceBetween: 10,
            thumbs: {
                swiper: swiper,
            },
            navigation: {
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
            },
            a11y: {
                prevSlideMessage: '이전 슬라이드',
                nextSlideMessage: '다음 슬라이드',
            },
        });

        function getDatesStartToLast(startDate, lastDate) {
            var regex = RegExp(/^\d{4}-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])$/);
            if(!(regex.test(startDate) && regex.test(lastDate))) return "Not Date Format";
            var result = [];
            var curDate = new Date(startDate);
            while(curDate <= new Date(lastDate)) {
                result.push(curDate.toISOString().split("T")[0]);
                curDate.setDate(curDate.getDate() + 1);
            }
            return result;
        }
    </script>
    
</div>