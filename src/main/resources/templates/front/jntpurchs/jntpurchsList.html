<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" 
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout" 
    layout:decorator="layout/front/subLayout" >
<body>
    <div layout:fragment="content">
        <!-- content -->
        <form class="search-filter" id="searchForm" name="searchForm" onsubmit="return false;">
            <div class="form-input-wrap">
                <div class="form-row">
                    <div class="form-header"><strong class="label">공동구매명</strong></div>
                    <div class="form-body">
                        <input type="search" id="searchJntpurchsNm" name="searchJntpurchsNm" title="공동구매명" placeholder="공동구매명을 입력해 주세요.">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-header"><strong class="label">모집상태</strong></div>
                    <div class="form-body">
                        <span kattr:select_code="searchSttsCd" grpcd="172" title="모집상태" firstOptTxt="전체">
                    </div>
                </div>
            </div>
            <div class="search-filter-submit">
                <button type="button" class="btn-medium btn-gray btn-before-refresh" onclick="jntpurchs.initSearch();">초기화</button>
                <button type="submit" class="btn-medium btn-green btn-before-search" onclick="jntpurchs.onSearch();">검색</button>
            </div>
            <input type="hidden" id="pageNumber" name="pageNumber" value="1">
            <input type="hidden" id="rowPerPage" name="rowPerPage" value="12">
            <input type="hidden" id="orderDirection" name="orderDirection" value="desc">
            <input type="hidden" id="orderField" name="orderField" value="REG_DT">
            <input type="hidden" id="jntpurchsid" name="jntpurchsid" value="0">
        </form>

        <div class="table-caption flex-nowrap">
            <div class="left">
                <p>총 <b id="totalCount">0</b> 건</p>
            </div>
        </div>
        <div class="nodata d-none">
            <p><span class="icon icon-notice bg-black9"></span>등록된 공동구매가 없습니다.</p>
        </div>
        <div class="card-section">
            <ul class="n3" id="jntpurchsList">
            </ul>
        </div>
        <div id="pagination">
        </div>

        <!-- //content -->
        <script th:inline="javascript">
            var jntpurchs = {
                listUrl: "/front/jntpurchs/selectJntpurchsList.do"
                , detailUrl: "/front/jntpurchs/jntpurchsDetailForm.html"
                
                , init: function() {
                    this.onLoadData();
                    this.registEvent();                
                }
                
                , registEvent: function() {
                    // TODO
                }
                
                , onLoadData: function() {
                    if(displayWorkProgress(true)) {
                        if(document.URL.indexOf('#') > -1) { // 검색유지
                            var historyData = document.URL.substring(document.URL.indexOf("#") + 1).split("&");
                            $("#pageNumber").val(historyData[0].split("=")[1]);
                            $("#searchJntpurchsNm").val(decodeURI(historyData[1].split("=")[1]));
                            $("#searchSttsCd").val(historyData[2].split("=")[1]);
                        }
                        var param = $('#searchForm').serializeArray();
                        $.ajax({
                            url: jntpurchs.listUrl
                            , cache: false
                            , dataType: "json"
                            , data: param
                            , type: "GET"
                            , success: function(response) {
                                jntpurchs.setList(response);
                                closeWorkProgress();
                            }
                        });
                    }
                }
                
                , setList: function(data) {
                    $("#jntpurchsList, #pagination").empty();
                    $("#totalCount").text(data.totalCount);
                    if(data.totalCount == 0) {
                        $(".nodata").removeClass("d-none");
                        $(".card-list").addClass("d-none");
                    } else {
                        $(".nodata").addClass("d-none");
                        $(".card-list").removeClass("d-none");
                        $(data.list).each(function(index, data) {
                            $("#jntpurchsList").append(jntpurchs.getListItem(data));
                        });                        
                    }
                    $("#pagination").html(data.pagination);
                }
                
                , getListItem: function(data) {
                    console.log(data)
                    var stts = data.sttsCdNm;
                    var qnty = '';
                    var remainQnty = parseInt(data.qntyWhol, 10) - parseInt(data.orderQnty, 10);
                    var tagClass = stts == "모집중" ? "bg-blue" : stts == "모집대기" ? "bg-green" : "bg-black6";
                    if(stts == "재고소진") {
                        qnty = "재고소진";
                    } else if(stts == "모집종료") {
                        qnty = "모집마감";
                    } else if(data.qntyWholLmtYn == "Y") {
                        qnty = "제한없음";
                    }else {
                        qnty = remainQnty + "개 남음";
                    }
                    var item = '<li>';
                    if((stts != "모집중" && stts != "모집대기") || remainQnty <= 0) item = '<li class="disabled">';
                    item += '<div class="flag ' + tagClass + '">' + stts + '</div>';
                    item += '<div class="thumb">';
                    item += '<img src="/downloadFileByFileid.do?fileid=' + data.rprsImgFileid + '&file_idntfc_key=' + data.rprsImgFilekey + '" alt="' + '">';
                    item += '</div>';
                    item += '<div class="cont mt0">';
                    item += '<a href="javascript:jntpurchs.onDetail(' + data.jntpurchsid + ');" class="title ellipsis" data-ellipsis="2">' + data.jntpurchsNm + '</a>';
                    item += '<div class="fs-14 fc-black6">모집기간 : ' + data.bgngDt.split(" ")[0] + ' ~ ' + data.endDt.split(" ")[0] + '</div>';
                    item += '<div class="fs-16 fc-black3 ar">' + qnty + '</div>';
                    item += '</div>';
                    item += '</li>';
                    
                    return item;
                }
                
                , initSearch: function() {
                     $("#searchJntpurchsNm, #searchSttsCd").val("");
                     //this.onSearch();
                }
                
                , onSearch: function() {
                    $("#pageNumber").val("1");
                    this.setPage();
                    this.onLoadData();
                }
                
                , onDetail: function(jntpurchsid) {
                    if($("#pageNumber").val() != 1 || $("#searchJntpurchsNm").val() || $("#searchSttsCd").val()) {
                        this.setPage();                        
                    }
                    location.href = this.detailUrl + "?jntpurchsid=" + jntpurchsid;
                }
                
                , setPage: function() {
                    var hashUrl = "";
                    if(document.URL.indexOf("#") > -1) {
                        var url = document.URL.substring(0, document.URL.indexOf("#"));
                        hashUrl = url + "#pageNumber=" + $("#pageNumber").val();
                        hashUrl += "&searchJntpurchsNm=" + encodeURI($("#searchJntpurchsNm").val());
                        hashUrl += "&searchSttsCd=" + $("#searchSttsCd").val();
                    } else {
                        hashUrl = document.URL + "#pageNumber=" + $("#pageNumber").val();
                        hashUrl += "&searchJntpurchsNm=" + encodeURI($("#searchJntpurchsNm").val());
                        hashUrl += "&searchSttsCd=" + $("#searchSttsCd").val();
                    }
                    
                    location.replace(hashUrl);
                }
            };
            
            function goPage(pageNumber) {
                $("#pageNumber").val(pageNumber);
                jntpurchs.setPage();
                jntpurchs.onLoadData();
            }
            
            $(function() {
                jntpurchs.init();
            });
        </script>
    </div>
</body>
</html>