<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
    layout:decorator="layout/front/nolnbSubLayout">
<body>
<div layout:fragment="content">
    <div class="steps">
        <ol>
            <li>
                <div class="steps-inner">
                    <span>01</span>
                    <strong>약관동의</strong>
                </div>
            </li>
            <li class="active" title="현재 단계" aria-current="step">
                <div class="steps-inner">
                    <span>02</span>
                    <strong>신청정보 작성</strong>
                </div>
            </li>
            <li>
                <div class="steps-inner">
                    <span>03</span>
                    <strong>신청완료</strong>
                </div>
            </li>
        </ol>
    </div>

    <div class="row row-section">
        <div class="col col-small">
            <div class="sticky-navigation">
                <strong class="tit">신청정보 항목</strong>
                <div class="sticky-steps">
                    <ul>
                        <li><a href="#">신청정보</a></li>
                        <li class="active"><a href="#" title="현재 단계" aria-current="step">운영계획 개요</a></li>
                        <li><a href="#">추진일정</a></li>
                        <li><a href="#">교육전문인력 현황</a></li>
                        <li><a href="#">교육프로그램 보유현황</a></li>
                        <li><a href="#">교육시설 및 설비 현황</a></li>
                    </ul>
                    <div class="btn-wrap">
                        <div class="center">
                            <button type="button" class="btn-large btn-gray"  onclick="doSave()">중간저장</button>
                            <button type="button" class="btn-large btn-green" onclick="doSave('next')">다음</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <form id="operPlanForm" name="operPlanForm" class="col col-wide">
            <input type="hidden"  id="aplyid" name="aplyid" th:value="${planOutlInfo.aplyid}" />
            <input type="hidden"  id="planKey" name="planKey" th:value="${planOutlInfo.planKey}" />

            <div class="table-caption mt0">
                <div class="left">
                    <h3 class="sub-title">기관·단체의 설립목적 및 주요사업</h3>
                </div>
                <div class="right">
                    <p class="desc"><span class="ast">*</span>표시는 필수 입력 정보입니다.</p>
                </div>
            </div>

            <div class="table-row table-row-mo">
                <table>
                    <caption>기관·단체의 설립목적 및 주요사업 - 기관·단체의 설립목적 및 주요사업, 증빙서류</caption>
                    <colgroup>
                        <col style="width:140px;">
                        <col>
                    </colgroup>
                    <tbody>
                        <tr>
                            <th scope="row">기관·단체의 설립목적 및 주요사업<i class="ast" title="필수입력">*</i></th>
                            <td>
                                <textarea title="기관·단체의 설립목적 및 주요사업" placeholder="500자 이하의 기관·단체의 설립목적 및 주요사업을 입력해 주세요." id="mainBsns" name="mainBsns" >[[${planOutlInfo.mainBsns}]]</textarea>
                                <div class="desc ar size"><span>0</span> / 500자</div>
                                <p class="feedback"></p>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">증빙서류<i class="ast" title="필수입력">*</i></th>
                            <td id="fileTd" >
                                <div class="form-input-file">
                                    <label class="form-input">
                                        <input type="file" id="multiFileInput" name="files" class="blind" multiple="multiple" accept=".jpeg,.jpg,.png,.gif,.tif,.tiff,.hwp,.hwpx,.pdf,.ppt,.pptx,.doc,.docx,.xls,.xlsx,.zip" title="파일첨부" maxcount="10">
                                        <span class="btn-medium btn-gray">파일선택</span>
                                    </label>
                                    <ul id="multipleFileUploadSuccess">
                                        <th:block th:if="${fileList ne null}" th:each="file : ${fileList}">
                                            <li class="file-block" th:data_ext="${#strings.substring(file.fileExtsn,1)}" th:id="${file.fileid}">
                                            <span class="name">
                                                <a href="javascript:void(0)" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                                                   th:onclick="|javascript:downloadFileByFileid(this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'))|">
                                                    [[${file.orginlFileNm}]]
                                                </a>
                                            </span>
                                                <button type="button" class="file-delete" title="삭제" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                                                        th:onclick="|javascript:fn_deleteFileList(this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'))|">
                                                    <span class="icon icon-circle-close"></span>
                                                </button>
                                            </li>
                                        </th:block>
                                    </ul>
                                    <input type="hidden" id="atchFilegrpid" name="atchFilegrpid" th:value="${(planOutlInfo.atchFilegrpid == '' or planOutlInfo.atchFilegrpid == null) ? 0 : planOutlInfo.atchFilegrpid}"/>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="table-caption">
                <div class="left">
                    <h3 class="sub-title">운영계획</h3>
                </div>
            </div>

            <div class="table-row table-row-mo">
                <table>
                    <caption>운영계획 - 교육 운영방안, 세부 운영계획, 참가자 모집 및 홍보&관리계획</caption>
                    <colgroup>
                        <col style="width:140px;">
                        <col>
                    </colgroup>
                    <tbody>
                        <tr>
                            <th scope="row">교육 운영방안<i class="ast" title="필수입력">*</i></th>
                            <td>
                                <textarea title="교육 운영방안" placeholder="500자 이하의 교육 운영방안을 입력해 주세요." id="operMthd" name="operMthd" >[[${planOutlInfo.operMthd}]]</textarea>
                                <div class="desc ar size"><span>0</span> / 500자</div>
                                <p class="feedback"></p>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">세부 운영계획</th>
                            <td>
                                <textarea title="세부 운영계획" placeholder="500자 이하의 세부 운영계획을 입력해 주세요." id="operPlan" name="operPlan" >[[${planOutlInfo.operPlan}]]</textarea>
                                <div class="desc ar size"><span>0</span> / 500자</div>
                                <p class="feedback"></p>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">참가자 모집 및 홍보, 관리계획</th>
                            <td>
                                <textarea title="참가자 모집 및 홍보&관리계획" placeholder="500자 이하의 참가자 모집 및 홍보,관리계획을 입력해 주세요." id="mngPlan" name="mngPlan" >[[${planOutlInfo.mngPlan}]]</textarea>
                                <div class="desc ar size"><span>0</span> / 500자</div>
                                <p class="feedback"></p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="table-caption">
                <div class="left">
                    <h3 class="sub-title">소요예산 확보 방안 및 집행계획</h3>
                </div>
            </div>


            <div class="table-row table-row-mo">
                <table>
                    <caption>소요예산 확보 방안 및 집행계획 - 소요예산 확보 방안 및 집행계획</caption>
                    <colgroup>
                        <col style="width:140px;">
                        <col>
                    </colgroup>
                    <tbody>
                        <tr>
                            <th scope="row">소요예산 확보 방안 및 집행계획<i class="ast" title="필수입력">*</i></th>
                            <td>
                                <textarea title="소요예산 확보 방안 및 집행계획" placeholder="500자 이하의 소요예산 확보 방안 및 집행계획을 입력해 주세요." id="bgtPlan" name="bgtPlan" >[[${planOutlInfo.bgtPlan}]]</textarea>
                                <div class="desc ar size"><span>0</span> / 500자</div>
                                <p class="feedback"></p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>


            <div class="table-caption">
                <div class="left">
                    <h3 class="sub-title">기대효과</h3>
                </div>
            </div>


            <div class="table-row table-row-mo">
                <table>
                    <caption>기대효과 - 기대효과</caption>
                    <colgroup>
                        <col style="width:140px;">
                        <col>
                    </colgroup>
                    <tbody>
                        <tr>
                            <th scope="row">기대효과<i class="ast" title="필수입력">*</i></th>
                            <td>
                                <textarea title="기대효과" placeholder="500자 이하의 기대효과를 입력해 주세요." id="expcEffect" name="expcEffect" >[[${planOutlInfo.expcEffect}]]</textarea>
                                <div class="desc ar size"><span>0</span> / 500자</div>
                                <p class="feedback"></p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="table-caption">
                <div class="left">
                    <h3 class="sub-title">기타자료</h3>
                </div>
            </div>


            <div class="table-row table-row-mo">
                <table>
                    <caption>기타자료 - 기타자료</caption>
                    <colgroup>
                        <col style="width:140px;">
                        <col>
                    </colgroup>
                    <tbody>
                        <tr>
                            <th scope="row">기타자료</th>
                            <td>
                                <textarea title="기타자료" placeholder="500자 이하의 기타자료를 입력해 주세요." id="etcDta" name="etcDta" >[[${planOutlInfo.etcDta}]]</textarea>
                                <div class="desc ar size"><span>0</span> / 500자</div>
                                <p class="feedback"></p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mo-only">
                <div class="btn-wrap">
                    <div class="center">
                        <button type="button" class="btn-medium btn-gray" onclick="doSave()">중간저장</button>
                    </div>
                </div>
                <div class="btn-wrap">
                    <div class="center">
                        <button type="button" class="btn-medium btn-gray"  onclick="doPrev()">이전</button>
                        <button type="button" class="btn-medium btn-green" onclick="doSave('next')">다음</button>
                    </div>
                </div>
            </div>

        </form>
    </div>

    <script th:inline="javascript">

        var reUrl="/front/eduInst/operPlanOutlForm.html";
        var nextUrl="/front/eduInst/propSchdlForm.html";
        var insertUrl="/front/eduInst/insertOperPlan.do";
        var updateUrl="/front/eduInst/updateOperPlan.do";
        var uploadFileCnt=0;

        function goNext(){
            location.href = nextUrl;
        }

        function doSave(call){
        	debugger;
        	var bChk = true;
            var param = {};
            var key = $("#planKey").val();
            var url ="";

            if(key == null || key == 0 || key == ''){
                url = insertUrl;
                $("#sttsCd").val("248101");    //작성중
            }else{
                url = updateUrl
            }

            if("next"==call){

            	bChk = $("#operPlanForm").valid() ? bChk : false;


                //첨부파일
                var fileCnt = $("[fileid],[id^=fileid]").length;
                if(fileCnt==0){
                    var msg="첨부파일을 입력해 주십시오";
                    if (!$("#fileTd").find(".feedback.invalid").length) {
                        $("#fileTd").append(`<p class="feedback invalid">${msg}</p>`);
                    }
                    var offset = $("#fileTd").offset();
                    $('html, body').animate({scrollTop : offset.top - 300}, 300);
                    $("#fileTd").focus();
                    bChk = false;
                } else {
                    $("#fileTd").find(".feedback.invalid").remove();
                }

                //
                if(!bChk) return;
            }

            if(call!="next")if(!confirm("저장하시겠습니까?")) return;

            param = $("#operPlanForm").serializeArray();

            $.ajax({
                url : url,
                type: 'POST',
                cache : false,
                dataType: 'json',
                data: param,
                success : function (data){
                    let saveData = escapeData(data);

                    if(saveData.result=="success"){
                        alert(saveData.msg);

                        if(call == "next") {
                            var id = saveData?.aplyid?? $("#aplyid").val();
                            location.href = nextUrl+"?aplyid=" + id;
                        }else{
                            var id = saveData?.aplyid?? $("#aplyid").val();
                            debugger;
                            location.href = reUrl+"?aplyid=" + id;
                        }
                    }else{
                        alert(data.msg);
                    }
                },
                error : function (error){
                }
            });
        }

        $(function(){
        	//
        	var validator= $("#operPlanForm").validate({
                rules: {
                     mainBsns       : { required: true , isBlank:true , maxlength: 500}
                    ,operMthd       : { required: true , isBlank:true , maxlength: 500}
                    ,operPlan       : { maxlength: 500}
                    ,mngPlan        : { maxlength: 500}
                    ,bgtPlan        : { required: true , isBlank:true , maxlength: 500}
                    ,expcEffect     : { required: true , isBlank:true , maxlength: 500}
                    ,etcDta         : { maxlength: 500}
                },
                messages: {
                     mainBsns       : { required : "기관·단체의 설립목적 및 주요사업을 입력해 주십시오."  ,isBlank : "입력값에 공백이 있습니다." ,maxlength: "기관·단체의 설립목적 및 주요사업은 500자 이하여야 합니다."}
                    ,operMthd       : { required : "교육 운영방안을 입력해 주십시오."                     ,isBlank : "입력값에 공백이 있습니다." ,maxlength: "교육 운영방안은 500자 이하여야 합니다."}
                    ,operPlan       : { maxlength: "세부 운영계획은 500자 이하여야 합니다."}
                    ,mngPlan        : { maxlength: "참가자 모집 및 홍보, 관리계획은 500자 이하여야 합니다."}
                    ,bgtPlan        : { required : "소요예산 확보 방안 및 집행계획을 입력해 주십시오."    ,isBlank : "입력값에 공백이 있습니다." ,maxlength: "소요예산 확보 방안 및 집행계획은 500자 이하여야 합니다."}
                    ,expcEffect     : { required : "기대효과를입력해 주십시오."                           ,isBlank : "입력값에 공백이 있습니다." ,maxlength: "기대효과는 500자 이하여야 합니다."}
                    ,etcDta         : { maxlength: "기타자료는 500자 이하여야 합니다."}
                }
            })

            //
            $("textArea").keyup(function (e) {
                var inTxt = $(this).val();
                if($("#"+this.id).next().prop("class")=="desc ar size"){
                    $("#"+this.id).next().children().prop("innerHTML",inTxt.length);
                }
            });
            $("textArea").trigger("keyup");

            //
          //첨부파일
            $('#multiFileInput').on("change", function(event) {
                var objFile = document.querySelector('#multiFileInput');
                var formData = new FormData();
                var content = "";

                for( i = 0 ; i < objFile.files.length ; i++) {
                    formData.append("files", objFile.files[i]);
                    uploadFileCnt++;
                }

                formData.append("filegrpid", $("#atchFilegrpid").val());
                formData.append("filegrpNm", "eduInst_file");

                if(uploadFileCnt >0 ){
                    $.ajax({
                        url : '/uploadMultipleFiles.do',
                        processData : false,
                        contentType : false,
                        data : formData,
                        type : 'POST',
                        success : function(response) {

                            if(response.result == 'fail'){
                                alert(response.msg);
                            }else{
                                if($("#atchFilegrpid").val()=='0' || $("#atchFilegrpid").val()==''  || $("#atchFilegrpid").val()==null){
                                    $("#atchFilegrpid").val(response[0].filegrpid);
                                }

                                for(i = 0 ;i < response.length; i++ ){
                                    content = '<li class="file-block" data_ext="' + response[i].fileExtsn.replace(".", '') + '" id="fileid' + response[i].fileid + '">'
                                    content += '<span class="name">'
                                    content += ' <a href="javascript:void(0)" fileid="' + response[i].fileid + '" fileIdntfcKey="' + response[i].fileIdntfcKey + '" onclick="downloadFileByFileid(this.getAttribute(\'' + response[i].fileid + '\'), this.getAttribute(\'' + response[i].fileIdntfcKey + '\'))">' + response[i].orginlFileNm + '</a>'
                                    content += '</span>'
                                    content += ' <button type="button" class="file-delete" title="삭제" fileid="' + response[i].fileid + '" fileIdntfcKey="' + response[i].fileIdntfcKey + '" onclick="fn_deleteFileList(\'' + response[i].fileid + '\',\'' + response[i].fileIdntfcKey + '\')">'
                                    content += ' <span class="icon icon-circle-close"></span>'
                                    content += ' </button>'
                                    content += '</li>'
                                    $('#multipleFileUploadSuccess').append(content);
                                }
                            }
                        }
                    });
                   if (detectBrowser() == "other") {
                       $("#multiFileInput").val("");
                   } else {
                      $("#multiFileInput").replaceWith( $("#multiFileInput").clone(true))
                   }
                }
            });

        });

        function fn_deleteFileList(fileid, fileIdntfcKey){

            if(!confirm("파일을 삭제하시겠습니까?")){return;}
            fn_deleteFile(fileid, fileIdntfcKey);
            $("#fileid"+fileid).remove();
        }

        function fn_deleteFile(fileid, fileIdntfcKey){

            var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;

            $.ajax({
               url : deleteFileUrl,
               type: 'GET',
               cache : false,
               dataType: 'json',
               success : function (data){
                   if(data.result=="success"){
                       $("#"+fileid).remove();
                       if(uploadFileCnt > 0){
                           uploadFileCnt = uploadFileCnt-1;
                       }
                       alert("파일삭제가 완료 되었습니다.");
                   }else{
                       alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                   }
               },
               error : function (error){
               }
            })
        };

    </script>

</div>
</body>
</html>