<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
    layout:decorator="layout/front/nolnbSubLayout">
<body>
<div layout:fragment="content">
    <div class="steps">
        <ol>
            <li>
                <div class="steps-inner">
                    <span>01</span> <strong>약관동의</strong>
                </div>
            </li>
            <li class="active" title="현재 단계" aria-current="step">
                <div class="steps-inner">
                    <span>02</span> <strong>신청정보 작성</strong>
                </div>
            </li>
            <li>
                <div class="steps-inner">
                    <span>03</span> <strong>신청완료</strong>
                </div>
            </li>
        </ol>
    </div>


    <div class="row row-section">
        <div class="col col-small">
            <div class="sticky-navigation">
                <strong class="tit">신청정보 항목</strong>
                <div class="sticky-steps">
                    <ul>
                        <li><a href="#">신청정보</a></li>
                        <li><a href="#">운영계획 개요</a></li>
                        <li><a href="#">추진일정</a></li>
                        <li class="active"><a href="#" title="현재 단계" aria-current="step">교육전문인력 현황</a></li>
                        <li><a href="#">교육프로그램 보유현황</a></li>
                        <li><a href="#">교육시설 및 설비 현황</a></li>
                    </ul>
                    <div class="btn-wrap">
                        <div class="center">
                            <button type="button" class="btn-large btn-gray"  onclick="doSave()">중간저장</button>
                            <button type="button" class="btn-large btn-green" onclick="doSave('next')">다음</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <form id="eduExPrtForm" name="eduExPrtForm" class="col col-wide">
            <input type="hidden" id="aplyid" name="aplyid" th:value="${eduInstVo.aplyid}" />

            <div class="table-caption mt0">
                <div class="left">
                    <h3 class="sub-title">교육전문인력 현황</h3>
                </div>
            </div>

            <div class="table-add-group" id="exprtListDiv">
                <div class="table-row table-row-mo" th:id="'exprtDiv'+${i.count}" th:if="${#lists.size(eduExprtList) > 0}" th:each="exprt, i: ${eduExprtList}">
                    <table>
                        <caption>교육전문인력 현황 - 구분, 성명, 생년월일, 담당업무, 소지자격증, 재직기간, 주요경력, 증빙서류</caption>
                        <colgroup>
                            <col style="width: 140px;">
                            <col>
                            <col style="width: 140px;">
                            <col>
                        </colgroup>
                        <tbody>
                            <tr>
                                <th scope="row">구분</th>
                                <td><span kattr:select_code="seCd" th:attr='grpcd=249,selectedCd=${exprt.seCd}' firstOptTxt="- 선택 -"  title="구분" ></span></td>
                                <th scope="row">성명</th>
                                <td><input type="text" title="성명" placeholder="성명을 입력해 주세요." maxlength="60" id="nm" name="nm" th:value="${exprt.nm}"></td>
                            </tr>
                            <tr>
                                <th scope="row">생년월일</th>
                                <td><input type="date" title="생년월일" placeholder="생년월일을 입력해 주세요." maxlength="10" id="brdt" name="brdt" th:value="${exprt.brdt}"></td>
                                <th scope="row">담당업무</th>
                                <td><input type="text" title="담당업무" placeholder="담당업무을 입력해 주세요." maxlength="100" id="chrgtask" name="chrgtask" th:value="${exprt.chrgtask}"></td>
                            </tr>
                            <tr>
                                <th scope="row">소지자격증</th>
                                <td colspan="3"><input type="text" title="소지자격증" placeholder="소지자격증을 입력해 주세요." maxlength="100" id="crtfct" name="crtfct" th:value="${exprt.crtfct}"></td>
                            </tr>
                            <tr>
                                <th scope="row">재직기간</th>
                                <td colspan="3">
                                    <div class="form-input">
                                        <input type="date" title="재직기간(시작일)" placeholder="재직기간(시작일)을 입력해 주세요." maxlength="10" id="hdofBgngDe" name="hdofBgngDe" th:value="${exprt.hdofBgngDe}" style="width:130px;">
                                        <div class="bul">~</div>
                                        <input type="date" title="재직기간(종료일)" placeholder="재직기간(종료일)을 입력해 주세요." maxlength="10" id="hdofEndDe" name="hdofEndDe" th:value="${exprt.hdofEndDe}" style="width:130px">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">주요경력</th>
                                <td colspan="3"><input type="text" title="주요경력" placeholder="주요경력을 입력해 주세요." maxlength="200" id="career" name="career" th:value="${exprt.career}"></td>
                            </tr>
                            <tr>
                                <th scope="row">증빙서류</th>
                                <td colspan="3" id="fileTd" >
                                    <div class="form-input-file">
                                        <label class="form-input">
                                            <input type="file" th:id="'multiFileInput'+${i.count}" th:name="'files'+${i.count}" class="blind" multiple="multiple" accept=".jpeg,.jpg,.png,.gif,.tif,.tiff,.hwp,.hwpx,.pdf,.ppt,.pptx,.doc,.docx,.xls,.xlsx,.zip" title="파일첨부" maxcount="10">
                                            <span class="btn-medium btn-gray">파일선택</span>
                                        </label>
                                        <ul th:id="'multipleFileUploadSuccess'+${i.count}">
                                            <th:block th:if="${exprt.fileList ne null}" th:each="file : ${exprt.fileList}">
                                                <li class="file-block" th:data_ext="${#strings.substring(file.fileExtsn,1)}" th:id="${file.fileid}">
                                                <span class="name">
                                                    <a href="javascript:void(0)" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                                                       th:onclick="|javascript:downloadFileByFileid(this.getAttribute(fileid), this.getAttribute('fileIdntfcKey'))|">
                                                        [[${file.orginlFileNm}]]
                                                    </a>
                                                </span>
                                                    <button type="button" class="file-delete" title="삭제" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                                                            th:onclick="|javascript:deleteFile(this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'))|">
                                                        <span class="icon icon-circle-close"></span>
                                                    </button>
                                                </li>
                                            </th:block>
                                        </ul>
                                        <input type="hidden" th:id="'atchFilegrpid'+${i.count}" th:name="'atchFilegrpid'+${i.count}" th:value="${(exprt.atchFilegrpid == '' or exprt.atchFilegrpid == null) ? 0 : exprt.atchFilegrpid}"/>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="table-add-button" th:if="${i.count > 1}" >
                        <button type="button" class="btn-remove-table mb0" title="테이블 삭제" onclick="delRow()">
                            <span class="icon icon-remove"></span>
                        </button>
                    </div>
                </div>


                <button type="button" class="btn-row-add" title="테이블 추가" onclick="addRow()">
                    <span class="icon icon-row-add"></span>
                </button>

            </div>

            <div class="mo-only">
                <div class="btn-wrap">
                    <div class="center">
                        <button type="button" class="btn-medium btn-gray" onclick="doSave()">중간저장</button>
                    </div>
                </div>
                <div class="btn-wrap">
                    <div class="center">
                        <button type="button" class="btn-medium btn-gray"  onclick="doPrev()">이전</button>
                        <button type="button" class="btn-medium btn-green" onclick="goSave('next')">다음</button>
                    </div>
                </div>
            </div>

        </form>
    </div>
    <script th:inline="javascript">
        var nextUrl="/front/eduInst/hldngSttsForm.html";
        var reUrl="/front/eduInst/mnPwrSttusForm.html";
        var insertUrl="/front/eduInst/insertEduExprt.do";

        var uploadFileCnt = 0;

        function addRow() {
        	var lastRow = $('#exprtListDiv div[id^="exprtDiv"]:last');
        	var idx = lastRow.index() + 2;

            if ($('#exprtListDiv div[id^="exprtDiv"]').length >= 10) {
                alert("최대 10행까지만 추가 가능합니다.");
                return;
            }

            var newRow = lastRow.clone().attr('id', 'exprtDiv' + idx);

            newRow.find('input').val('');
            newRow.find('select').val('');
            newRow.find('ul li').each(function() {
                $(this).remove();
            });

            newRow.find('ul').attr('id','multipleFileUploadSuccess' + idx);
            newRow.find('[id^=atchFilegrpid]').attr('id','atchFilegrpid' + idx);

            lastRow.after(newRow);

            if ($('#exprtListDiv div[id^="exprtDiv"]').length == 2) {
                $('#exprtListDiv div[id^="exprtDiv"] table:last').after(`<div class="table-add-button" >
                                                          <button type="button" class="btn-remove-table mb0" title="테이블 삭제" onclick="delRow()">
                                                              <span class="icon icon-remove"></span>
                                                          </button>
                                                      </div>`);
            }
        }

        function delRow(){
            var lastRow = $('#exprtListDiv div[id^="exprtDiv"]:last');

            if(lastRow.index() > 0) lastRow.remove();

        }

        function validateTable() {
            var valid = true;

            $('div[id^="exprtDiv"] input[type="text"]').each(function(index,item) {
              var inputVal = $(this).val().trim();

              var trgtid= $(this).attr('id');
              if (!inputVal && $(this).val()!='') {
                  valid = false;

                  if($("#"+trgtid).next().attr('class') != "feedback invalid"){
                      $("#"+trgtid).after("<p class='feedback invalid'>공백은 입력할 수 없습니다.</p>");
                  }
              } else {
            	  $("#"+trgtid).next().remove();
              }
            });
            return valid;
          }

        function doSave(call){

            var param = {};
            var key = $("#planKey").val();

            if(key == null || key == 0 || key == ''){
                url = insertUrl;
            }else{
                url = updateUrl
            }


            //테이블
            if(!validateTable()) return;



            if(call!="next")if(!confirm("저장하시겠습니까?")) return;

            var exprtList = [];
            $('#exprtListDiv div[id^="exprtDiv"]').each(function(index, value){

                var nm         = $(this).find('input[name="nm"]').val();
                var seCd       = $(this).find('select[name=seCd]').val();
                var brdt       = $(this).find('input[name="brdt"]').val();
                var chrgtask   = $(this).find('input[name="chrgtask"]').val();
                var crtfct     = $(this).find('input[name="crtfct"]').val();
                var hdofBgngDe = $(this).find('input[name="hdofBgngDe"]').val();
                var hdofEndDe  = $(this).find('input[name="hdofEndDe"]').val();
                var career     = $(this).find('input[name="career"]').val();
                var atchFilegrpid = $(this).find('[id^="atchFilegrpid"]').val();
                exprtList.push({nm:nm, seCd:seCd, brdt:brdt, chrgtask:chrgtask, crtfct:crtfct, hdofBgngDe:hdofBgngDe, hdofEndDe:hdofEndDe, career:career,atchFilegrpid:atchFilegrpid});
            });

            param = {
              aplyid: $("#aplyid").val(),
              eduExprtList: exprtList
            };

            $.ajax({
                url : insertUrl,
                type: 'POST',
                cache : false,
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(param),
                success : function (data){

                    if(data.result=="success"){
                        alert(data.msg);
                        var id = $("#aplyid").val();
                        if(call == "next") {
                            location.href = nextUrl+"?aplyid=" + id;
                        }else{
                            location.href = reUrl+"?aplyid=" + id;
                        }
                    }else{
                        alert(data.msg);
                    }
                },
                error : function (error){
                }
            });
        }

        $(function(){

        	//첨부파일
            $('[id^=multiFileInput]').on("change", function(event) {
                var objFile = document.querySelector('#'+this.id);
                var no = this.id.replace('multiFileInput','');

                var formData = new FormData();
                var content = "";
                uploadFileCnt = 0;

                for( i = 0 ; i < objFile.files.length ; i++) {

                    formData.append("files", objFile.files[i]);

                    uploadFileCnt++;
                }

                formData.append("filegrpid", $("#atchFilegrpid"+no).val());
                formData.append("filegrpNm", "eduInst_file");

                if(uploadFileCnt >0 ){
                    $.ajax({
                        url : '/uploadMultipleFiles.do',
                        processData : false,
                        contentType : false,
                        data : formData,
                        type : 'POST',
                        success : function(response) {

                            if(response.result == 'fail'){
                                alert(response.msg);
                            }else{
                                if($("#atchFilegrpid"+no).val()=='0' || $("#atchFilegrpid"+no).val()==''  || $("#atchFilegrpid"+no).val()==null){
                                    $("#atchFilegrpid"+no).val( response[0].filegrpid );
                                }

                                for(i = 0 ;i < response.length; i++ ){
                                    content = '<li class="file-block" data_ext="' + response[i].fileExtsn.replace(".", '') + '" id="fileid' + response[i].fileid + '">'
                                    content += '<span class="name">'
                                    content += ' <a href="javascript:void(0)" fileid="' + response[i].fileid + '" fileIdntfcKey="' + response[i].fileIdntfcKey + '" onclick="downloadFileByFileid(this.getAttribute(\'' + response[i].fileid + '\'), this.getAttribute(\'' + response[i].fileIdntfcKey + '\'))">' + response[i].orginlFileNm + '</a>'
                                    content += '</span>'
                                    content += ' <button type="button" class="file-delete" title="삭제" fileid="' + response[i].fileid + '" fileIdntfcKey="' + response[i].fileIdntfcKey + '" onclick="fn_deleteFileList(\'' + response[i].fileid + '\',\'' + response[i].fileIdntfcKey + '\')">'
                                    content += ' <span class="icon icon-circle-close"></span>'
                                    content += ' </button>'
                                    content += '</li>'
                                    $('#multipleFileUploadSuccess'+no).append(content);
                                }
                            }
                        }
                    });

                   if (detectBrowser() == "other") {
                       $("#multiFileInput"+no).val("");
                   } else {
                      $("#multiFileInput"+no).replaceWith( $("#multiFileInput"+no).clone(true))
                   }
                }
            });

        });

        function fn_deleteFileList(fileid, fileIdntfcKey){

            if(!confirm("파일을 삭제하시겠습니까?")){return;}
            fn_deleteFile(fileid, fileIdntfcKey);
            $("#fileid"+fileid).remove();
        }

        function fn_deleteFile(fileid, fileIdntfcKey){

            var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;

            $.ajax({
               url : deleteFileUrl,
               type: 'GET',
               cache : false,
               dataType: 'json',
               success : function (data){
                   if(data.result=="success"){
                       $("#"+fileid).remove();
                       if(uploadFileCnt > 0){
                           uploadFileCnt = uploadFileCnt-1;
                       }
                       alert("파일삭제가 완료 되었습니다.");
                   }else{
                       alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                   }
               },
               error : function (error){
               }
            })
        };
    </script>
</div>
</body>
</html>