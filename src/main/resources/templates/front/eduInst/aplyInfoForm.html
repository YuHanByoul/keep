<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
    layout:decorator="layout/front/nolnbSubLayout">
<body>
<div layout:fragment="content">

    <div class="steps">
        <ol>
            <li>
                <div class="steps-inner">
                    <span>01</span>
                    <strong>약관동의</strong>
                </div>
            </li>
            <li class="active" title="현재 단계" aria-current="step">
                <div class="steps-inner">
                    <span>02</span>
                    <strong>신청정보 작성</strong>
                </div>
            </li>
            <li>
                <div class="steps-inner">
                    <span>03</span>
                    <strong>신청완료</strong>
                </div>
            </li>
        </ol>
    </div>


    <div class="row row-section">
        <div class="col col-small">
            <div class="sticky-navigation">
                <strong class="tit">신청정보 항목</strong>
                <div class="sticky-steps">
                    <ul>
                        <li class="active"><a href="#" title="현재 단계" aria-current="step">신청정보</a></li>
                        <li><a href="#">운영계획 개요</a></li>
                        <li><a href="#">추진일정</a></li>
                        <li><a href="#">교육전문인력 현황</a></li>
                        <li><a href="#">교육프로그램 보유현황</a></li>
                        <li><a href="#">교육시설 및 설비 현황</a></li>
                    </ul>
                    <div class="btn-wrap">
                        <div class="center">
                            <button type="button" class="btn-large btn-gray" onclick="doSave()">중간저장</button>
                            <button type="button" class="btn-large btn-green" onclick="doSave('next')">다음</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col col-wide">

            <div class="table-caption mt0">
                <div class="left">
                    <h3 class="sub-title">유의사항</h3>
                </div>
            </div>

            <div class="box-desc-list bg7">
                <p>
                    동사업은 국가 예산으로 지원하는 사업으로 기재하신 사항은 공공의 목적으로 공개될 수 있음을 양지하시기 바랍니다.<br>
                    신청하는 내용이 허위로 밝혀질 경우 심사에서 제외될 수 있으며, 선정이 확정된 사업이라도 취소될 수 있습니다.<br>
                    신청서를 제출하신 후에는 수정을 할 수 없으니, 제출하시기 전에 기재한 사항이 틀린 내용이 없는지 확인하여 주시기 바랍니다.<br>
                    선정이 확정된 사업이라도 일부 내용이 적절하지 않다고 판단되는 경우에는 수정을 요구할 수 있으며, 이를 불리행시 선정 결정이 취소될 수 있습니다.
                </p>
            </div>


            <div class="table-caption">
                <div class="left">
                    <h3 class="sub-title">신청정보</h3>
                </div>
                <div class="right">
                    <p class="desc"><span class="ast">*</span>표시는 필수 입력 정보입니다.</p>
                </div>
            </div>

            <form name="aplyForm" id="aplyForm" class="table-row table-row-mo">
                <input type="hidden"  id="aplyid" name="aplyid" th:value="${aplyInfo.aplyid}" />
                <input type="hidden"  id="instid" name="instid" th:value="${aplyInfo.instid}" />
                <input type="hidden"  id="aplcntid" name="aplcntid" th:value="${aplyInfo.aplcntid}" />
                <input type="hidden"  id="rcptno" name="rcptno" th:value="${aplyInfo.rcptno}" />
                <input type="hidden"  id="instNm" name="instNm" th:value="${aplyInfo.instNm}" />
                <input type="hidden"  id="instCntct" name="instCntct" th:value="${aplyInfo.instCntct}" />
                <input type="hidden"  id="dsgnno" name="dsgnno" th:value="${aplyInfo.dsgnno}" />
                <input type="hidden"  id="dsgnDe" name="dsgnDe" th:value="${aplyInfo.dsgnDe}" />
                <input type="hidden"  id="autzrid" name="autzrid" th:value="${aplyInfo.autzrid}" />
                <input type="hidden"  id="issuDe" name="issuDe" th:value="${aplyInfo.issuDe}" />
                <input type="hidden"  id="isgnDe" name="isgnDe" th:value="${aplyInfo.isgnDe}" />
                <input type="hidden"  id="sttsCd" name="sttsCd" th:value="${aplyInfo.sttsCd}" />

                <table>
                    <caption>신청정보 - 시도, 접수번호, 기관명, 기관유형, 대표자명, 대표자 생년월일, 기관 연락처, 기관 이메일, 사업자등록번호, 신청자명, 신청자 연락처, 신청자 이메일, 기관주소, 상세주소, 증빙서류</caption>
                    <colgroup>
                        <col style="width:140px;">
                        <col>
                        <col style="width:140px;">
                        <col>
                    </colgroup>
                    <tbody>
                        <tr>
                            <th scope="row">시도<i class="ast" title="필수입력">*</i></th>
                            <td>
                                <select id="ctprvnCd" name="ctprvnCd" title="지역">
                                    <option value="">- 전체 -</option>
                                    <th:block th:each="code : ${sidoList}">
                                    <option th:value="${code.CTPRVN_CD}" th:selected="${code.CTPRVN_CD==aplyInfo.ctprvnCd ? 'selected':''}">[[${code.CTPRVN_NM}]]</option>
                                    </th:block>
                                </select>
                                <p class="feedback"></p>
                            </td>
                            <th scope="row">접수번호</th>
                            <td>[[${aplyInfo.rcptno==null || aplyInfo.rcptno=='' ? '자동생성':aplyInfo.rcptno}]]</td>
                        </tr>
                        <tr>
                            <th scope="row">기관명</th>
                            <td>[[${aplyInfo.instNm}]]</td>
                            <th scope="row">기관유형</th>
                            <td>[[${aplyInfo.cdNm}]]</td>
                        </tr>
                        <tr>
                            <th scope="row">대표자명</th>
                            <td>[[${aplyInfo.cdNm}]]</td>
                            <th scope="row">대표자 생년월일</th>
                            <td><input type="date" title="대표자 생년월일" id="rprsvBrdt" name="rprsvBrdt" th:value="${aplyInfo.rprsvBrdt}"></td>
                        </tr>

                        <tr>
                            <th scope="row">기관 연락처</th>
                            <td>[[${aplyInfo.instCntct}]]</td>
                            <th scope="row">기관 이메일</th>
                            <td><input type="email" placeholder="기관 이메일을 입력해 주세요." id="instEml" name="instEml" th:value="${aplyInfo.instEml}">
                                <p class="feedback"></p>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">사업자등록번호</th>
                            <td>[[${aplyInfo.brno}]]</td>
                            <th scope="row">신청자명</th>
                            <td><input type="text" title="신청자명" id="aplcntNm" name="aplcntNm" th:value="${aplyInfo.aplcntNm}">
                                <p class="feedback"></p>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">신청자 연락처</th>
                            <td><input type="text" title="신청자 연락처" id="aplcntMoblphon" name="aplcntMoblphon" th:value="${aplyInfo.aplcntMoblphon}" maxlength="40">
                                <p class="feedback"></p>
                            </td>
                            <th scope="row">신청자 이메일</th>
                            <td><input type="email" id="aplcntEml" name="aplcntEml" th:value="${aplyInfo.aplcntEml}">
                                <p class="feedback"></p>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">기관주소</th>
                            <td>[[${aplyInfo.addr}]]</td>
                            <th scope="row">상세주소</th>
                            <td>[[${aplyInfo.addrDtl}]]</td>
                        </tr>

                        <tr>
                            <th scope="row">증빙서류<i class="ast" title="필수입력">*</i></th>
                            <td id="fileTd" >
                                <div class="form-input-file">
                                    <label class="form-input">
                                        <input type="file" id="multiFileInput" name="files" class="blind" multiple="multiple" accept=".jpeg,.jpg,.png,.gif,.tif,.tiff,.hwp,.hwpx,.pdf,.ppt,.pptx,.doc,.docx,.xls,.xlsx,.zip" title="파일첨부" maxcount="10">
                                        <span class="btn-medium btn-gray">파일선택</span>
                                    </label>
                                    <ul id="multipleFileUploadSuccess">
                                        <th:block th:if="${fileList ne null}" th:each="file : ${fileList}">
                                            <li class="file-block" th:data_ext="${#strings.substring(file.fileExtsn,1)}" th:id="${file.fileid}">
                                            <span class="name">
                                                <a href="javascript:void(0)" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                                                   th:onclick="|javascript:downloadFileByFileid(this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'))|">
                                                    [[${file.orginlFileNm}]]
                                                </a>
                                            </span>
                                                <button type="button" class="file-delete" title="삭제" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                                                        th:onclick="|javascript:deleteFile(this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'))|">
                                                    <span class="icon icon-circle-close"></span>
                                                </button>
                                            </li>
                                        </th:block>
                                    </ul>
                                    <input type="hidden" id="atchFilegrpid" name="atchFilegrpid" th:value="${(aplyInfo.atchFilegrpid == '' or aplyInfo.atchFilegrpid == null) ? 0 : aplyInfo.atchFilegrpid}"/>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </form>

            <div class="mo-only">
                <div class="btn-wrap">
                    <div class="center">
                        <button type="button" class="btn-medium btn-gray" onclick="doSave()">중간저장</button>
                    </div>
                </div>
                <div class="btn-wrap">
                    <div class="center">
                        <button type="button" class="btn-medium btn-gray"  onclick="goPrev()">이전</button>
                        <button type="button" class="btn-medium btn-green" onclick="doSave('next')">다음</button>
                    </div>
                </div>
            </div>

        </div>
    </div>



    <script th:inline="javascript">
        var reUrl="/front/eduInst/aplyInfoForm.html";
        var nextUrl="/front/eduInst/operPlanOutlForm.html";
        var insertUrl="/front/eduInst/insertAplyInfo.do";
        var updateUrl="/front/eduInst/updateAplyInfo.do";
        var uploadFileCnt=0;


        function doSave(call){

        	/*
SELECT LPAD( SUBSTR(A.RCPTNO,9,4)+1,4,0)
        , CONCAT(SUBSTR(A.RCPTNO,1,8 ),LPAD( SUBSTR(A.RCPTNO,9,4)+1,4,0))
        ,LPAD( SUBSTR(A.RCPTNO,9,4)+1,0,4)
        FROM TB_SEE_ENV_EDU_INST A
        WHERE A.RCPTNO IS NOT NULL
        AND   A.RCPTNO LIKE '2023-48%'
        	*/
            var param = {};
        	var aplyid = $("#aplyid").val();
        	var url ="";

        	if(aplyid == null || aplyid == 0 || aplyid == ''){
        		url = insertUrl;
        		$("#sttsCd").val("248101");    //작성중
        	}else{
        		url = updateUrl
        	}

        	if("next"==call){
            	if(!$("#aplyForm").valid()) return;

            	//첨부파일
                var fileCnt = $("[fileid],[id^=fileid]").length;
                if(fileCnt==0){
                    //$("[fileid]").length
                    var msg="첨부파일을 입력해 주십시오";
                    if (!$("#fileTd").find(".feedback.invalid").length) {
                        $("#fileTd").append(`<p class="feedback invalid">${msg}</p>`);
                    }
                    var offset = $("#fileTd").offset();
                    $('html, body').animate({scrollTop : offset.top - 300}, 300);
                    $("#fileTd").focus();
                    return false;
                } else {
                    $("#fileTd").find(".feedback.invalid").remove();
                }
        	}

        	if(call!="next")if(!confirm("저장하시겠습니까?")) return;

        	var now = new Date(); // 현재 날짜 및 시간
            var year = now.getFullYear()
            var ctprvnCd  = $("#ctprvnCd").val();
            var rcptnoStr = year+"-"+ctprvnCd+"-"+"0001";
            $("#rcptno").val(rcptnoStr);

            param = $("#aplyForm").serializeArray();

            $.ajax({
                url : url,
                type: 'POST',
                cache : false,
                dataType: 'json',
                data: param,
                success : function (data){
                	let saveData = escapeData(data);

                    if(saveData.result=="success"){
                    	alert(saveData.msg);

                        if(call == "next") {
                        	var id = saveData?.aplyid?? $("#aplyid").val();
                            location.href = nextUrl+"?aplyid=" + id;
                        }else{
                        	var id = saveData?.aplyid?? $("#aplyid").val();
                        	debugger;
                            location.href = reUrl+"?aplyid=" + id;
                        }
                    }else{
                        alert(data.msg);
                    }
                },
                error : function (error){
                }
            });

        }

        $(function(){
            var validator= $("#aplyForm").validate({
                rules: {
                	 ctprvnCd       : { required: true }
                    ,instEml        : { isBlank : true, maxlength: 50 }
                    ,aplcntNm       : { isBlank : true ,maxlength: 50 }
                    ,aplcntMoblphon : { isBlank : true}
                    ,aplcntEml      : { isBlank : true, maxlength: 50 }
                },
                messages: {
                	ctprvnCd        : { required: "시도를 선택해 주십시오."}
                    ,instEml        : { isBlank : "입력값에 공백이 있습니다.", maxlength: "이메일은 50자 이하여야 합니다." }
                    ,aplcntNm       : { isBlank : "입력값에 공백이 있습니다.", maxlength: "신청자명은 20자 이하여야 합니다." }
                    ,aplcntMoblphon : { isBlank : "입력값에 공백이 있습니다." }
                    ,aplcntEml      : { isBlank : "입력값에 공백이 있습니다.", maxlength: "이메일은 50자 이하여야 합니다." }
                }
            })

            //첨부파일
            $('#multiFileInput').on("change", function(event) {
                var objFile = document.querySelector('#multiFileInput');
                var formData = new FormData();
                var content = "";

                for( i = 0 ; i < objFile.files.length ; i++) {
                    formData.append("files", objFile.files[i]);
                    uploadFileCnt++;
                }

                formData.append("filegrpid", $("#atchFilegrpid").val());
                formData.append("filegrpNm", "eduInst_file");

                if(uploadFileCnt >0 ){
                    $.ajax({
                        url : '/uploadMultipleFiles.do',
                        processData : false,
                        contentType : false,
                        data : formData,
                        type : 'POST',
                        success : function(response) {

                            if(response.result == 'fail'){
                                alert(response.msg);
                            }else{
                                if($("#atchFilegrpid").val()=='0' || $("#atchFilegrpid").val()==''  || $("#atchFilegrpid").val()==null){
                                    $("#atchFilegrpid").val( response[0].filegrpid );
                                }

                                for(i = 0 ;i < response.length; i++ ){
                                	content = '<li class="file-block" data_ext="' + response[i].fileExtsn.replace(".", '') + '" id="fileid' + response[i].fileid + '">'
                                    content += '<span class="name">'
                                    content += ' <a href="javascript:void(0)" fileid="' + response[i].fileid + '" fileIdntfcKey="' + response[i].fileIdntfcKey + '" onclick="downloadFileByFileid(this.getAttribute(\'' + response[i].fileid + '\'), this.getAttribute(\'' + response[i].fileIdntfcKey + '\'))">' + response[i].orginlFileNm + '</a>'
                                    content += '</span>'
                                    content += ' <button type="button" class="file-delete" title="삭제" fileid="' + response[i].fileid + '" fileIdntfcKey="' + response[i].fileIdntfcKey + '" onclick="fn_deleteFileList(\'' + response[i].fileid + '\',\'' + response[i].fileIdntfcKey + '\')">'
                                    content += ' <span class="icon icon-circle-close"></span>'
                                    content += ' </button>'
                                    content += '</li>'
                                    $('#multipleFileUploadSuccess').append(content);
                                }
                            }
                        }
                    });
                   if (detectBrowser() == "other") {
                       $("#multiFileInput").val("");
                   } else {
                      $("#multiFileInput").replaceWith( $("#multiFileInput").clone(true))
                   }
                }
            });

        });

        function fn_deleteFileList(fileid, fileIdntfcKey){

            if(!confirm("파일을 삭제하시겠습니까?")){return;}
            fn_deleteFile(fileid, fileIdntfcKey);
            $("#fileid"+fileid).remove();
        }

        function fn_deleteFile(fileid, fileIdntfcKey){

            var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;

            $.ajax({
               url : deleteFileUrl,
               type: 'GET',
               cache : false,
               dataType: 'json',
               success : function (data){
                   if(data.result=="success"){
                       $("#"+fileid).remove();
                       if(uploadFileCnt > 0){
                           uploadFileCnt = uploadFileCnt-1;
                       }
                       alert("파일삭제가 완료 되었습니다.");
                   }else{
                       alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                   }
               },
               error : function (error){
               }
            })
        };

    </script>
</div>
</body>
</html>