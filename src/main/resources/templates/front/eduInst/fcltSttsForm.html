<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
    layout:decorator="layout/front/nolnbSubLayout">
<body>
<div layout:fragment="content">
    <div class="steps">
        <ol>
            <li>
                <div class="steps-inner">
                    <span>01</span>
                    <strong>약관동의</strong>
                </div>
            </li>
            <li class="active" title="현재 단계" aria-current="step">
                <div class="steps-inner">
                    <span>02</span>
                    <strong>신청정보 작성</strong>
                </div>
            </li>
            <li>
                <div class="steps-inner">
                    <span>03</span>
                    <strong>신청완료</strong>
                </div>
            </li>
        </ol>
    </div>

    <div class="row row-section">
        <div class="col col-small">
            <div class="sticky-navigation">
                <strong class="tit">신청정보 항목</strong>
                <div class="sticky-steps">
                    <ul>
                        <li><a href='javascript:navclick()'>신청정보</a></li>
                        <li><a href='javascript:navclick()'>운영계획 개요</a></li>
                        <li><a href='javascript:navclick()'>추진일정</a></li>
                        <li><a href='javascript:navclick()'>교육전문인력 현황</a></li>
                        <li><a href='javascript:navclick()'>교육프로그램 보유현황</a></li>
                        <li class="active"><a href='javascript:navclick()' title="현재 단계" aria-current="step">교육시설 및 설비 현황</a></li>
                    </ul>
                    <div class="btn-wrap">
                        <div class="center">
                            <button type="button" class="btn-large btn-gray" onclick="doSave()">중간저장</button>
                            <button type="button" class="btn-large btn-green"onclick="doSave('next')">신청완료</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <form id='fclstForm' class="col col-wide">
            <input type="hidden" id="aplyid" name="aplyid" th:value="${eduInstVo.aplyid}" />
            <input type="hidden" id="fcltKey" name="fcltKey" th:value="${eduInstVo.fcltKey}" />
            <input type="hidden" id="sttsCd" name="sttsCd" th:value="${eduInstVo.sttsCd}" />

            <div class="table-caption mt0">
                <div class="left">
                    <h3 class="sub-title">시설개요</h3>
                </div>
            </div>

            <div class="table-row table-row-mo">
                <table>
                    <caption>시설개요 - 임대여부, 임대기간, 연건평(제곱미터), 숙박시설보유여부, 면적(제곱미터), 수용인원 </caption>
                    <colgroup>
                        <col style="width:140px;">
                        <col>
                        <col style="width:140px;">
                        <col>
                    </colgroup>
                    <tbody>
                        <tr>
                            <th scope="row">임대여부</th>
                            <td colspan="3">
                                <div class="form-check-list no-flex-wrap">
                                    <label class="inp"><input type="radio" id="rentYn1" name="rentYn1" value="Y" th:checked="${eduInstVo.rentYn eq 'Y'}"><b>임대</b></label>
                                    <label class="inp"><input type="radio" id="rentYn2" name="rentYn2" value="N" th:checked="${eduInstVo.rentYn eq 'N' or eduInstVo.rentYn eq null}"><b>소유</b></label>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">임대기간</th>
                            <td><input type="text" title="임대기간" placeholder="임대기간를 입력해 주세요" maxlength="100" id="rentPrd" name="rentPrd" th:value="${eduInstVo.rentPrd}" /></td>
                            <th scope="row">연건평(m<sup>2</sup>)</th>
                            <td>
                                <input type="text" title="연건평(m2)" placeholder="연건평을 입력해 주세요" maxlength="10" id="totar" name="totar" th:value="${eduInstVo.totar}" />
                                <p class="feedback"></p>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">숙박시설 보유여부</th>
                            <td colspan="3">
                                <div class="form-check-list no-flex-wrap">
                                    <label class="inp"><input type="radio" id="styFcltHoldYn1" name="styFcltHoldYn" value="Y" th:checked="${eduInstVo.styFcltHoldYn eq 'Y'}"><b>보유</b></label>
                                    <label class="inp"><input type="radio" id="styFcltHoldYn2" name="styFcltHoldYn" value="N" th:checked="${eduInstVo.styFcltHoldYn eq 'N' or eduInstVo.styFcltHoldYn eq null}"><b>미보유</b></label>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">면적(m<sup>2</sup>)</th>
                            <td>
                                <input type="text" title="면적(m2)" placeholder="면적을 입력해 주세요" maxlength="10" id="styFcltAr" name="styFcltAr" th:value="${eduInstVo.styFcltAr}" />
                                <p class="feedback"></p>
                            </td>

                            <th scope="row">수용인원</th>
                            <td>
                                <input type="text" title="수용인원" placeholder="수용인원을 입력해 주세요" maxlength="10" id="styFcltNope" name="styFcltNope" th:value="${eduInstVo.styFcltNope}" />
                                <p class="feedback"></p>
                            </td>

                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="table-caption">
                <div class="left">
                    <h3 class="sub-title">강의실</h3>
                </div>
            </div>

            <div class="table-col table-layout-auto table-col-scroll">
                <table>
                    <caption>강의실 - 강의실명, 면적(제곱미터), 수용인원, 행 삭제</caption>
                    <colgruop>
                        <col>
                        <col>
                        <col>
                        <col style="width:55px;">
                    </colgruop>
                    <thead>
                        <tr>
                            <th scope="col">강의실명</th>
                            <th scope="col">면적(m<sup>2</sup>)</th>
                            <th scope="col">수용인원</th>
                            <th scope="col"><span class="blind">행 삭제</span></th>
                        </tr>
                    </thead>
                    <tbody id="lctrum1Tbody">
                        <tr th:id=' lctrum1Tr + ${j.count} ' th:if='${lctrum1}' th:each='lctrum1, j: ${lctrumList1}'>
                            <td><input type="text" maxlength="100" title="강의실명" id="nm" name="nm" th:value="${lctrum1.nm}"></td>
                            <td><input type="text" maxlength="10" title="면적(m2)" id="ar" name="ar" th:value="${lctrum1.ar}"></td>
                            <td><input type="text" maxlength="10" title="수용인원" id="nope" name="nope" th:value="${lctrum1.nope}"></td>
                            <input type="hidden" title="구분코드" id="seCd" name="seCd" value='251101'>
                            <td class="ac">
                                <button th:if='${j.count > 1}' type="button" class="btn-remove-table" title="행 삭제" onclick="lctrum1DelRow()"><span class="icon icon-remove"></span></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <button type="button" class="btn-row-add" title="행 추가" id="addBtn1" onclick="lctrum1AddRow()">
                <span class="icon icon-row-add"></span>
            </button>

            <div class="table-caption">
                <div class="left">
                    <h3 class="sub-title">실습실</h3>
                </div>
            </div>

            <div class="table-col table-layout-auto table-col-scroll">
                <table>
                    <caption>실습실 - 실습실명, 면적(제곱미터), 수용인원, 행 삭제</caption>
                    <colgruop>
                        <col>
                        <col>
                        <col>
                        <col style="width:55px;">
                    </colgruop>
                    <thead>
                        <tr>
                            <th scope="col">실습실명</th>
                            <th scope="col">면적(m<sup>2</sup>)</th>
                            <th scope="col">수용인원</th>
                            <th scope="col"><span class="blind">행 삭제</span></th>
                        </tr>
                    </thead>
                    <tbody id="lctrum2Tbody">
                    <th:block th:if='${lctrumList2!=null}'>
                        <tr th:id=' lctrum2Tr + ${k.count} 'th:if='${lctrum2}' th:each='lctrum2, k: ${lctrumList2}'>
                            <td><input type="text" maxlength="100" title="강의실명" id="nm" name="nm" th:value="${lctrum2.nm}"></td>
                            <td><input type="text" maxlength="12" title="면적(m2)" id="ar" name="ar" th:value="${lctrum2.ar}"></td>
                            <td><input type="text" maxlength="10" title="수용인원" id="nope" name="nope" th:value="${lctrum2.nope}"></td>
                            <input type="hidden" title="구분코드" id="seCd" name="seCd" value='251102'>
                            <td class="ac">
                                <button th:if='${k.count > 1}' type="button" class="btn-remove-table" title="행 삭제" onclick="lctrum2DelRow()"><span class="icon icon-remove"></span></button>
                            </td>
                        </tr>
                    </th:block>
                    </tbody>
                </table>
            </div>

            <button type="button" class="btn-row-add" title="행 추가" id="addBtn2" onclick="lctrum2AddRow()">
                <span class="icon icon-row-add"></span>
            </button>

            <div class="table-caption">
                <div class="left">
                    <h3 class="sub-title">교육설비 등</h3>
                </div>
            </div>

            <div class="table-col table-layout-auto table-col-scroll">
                <table>
                    <caption>교육설비 등 - 설비명, 수량, 활용방안 ,비고, 행 삭제</caption>
                    <colgruop>
                        <col>
                        <col style="width:180px;">
                        <col>
                        <col>
                        <col style="width:55px;">
                    </colgruop>
                    <thead>
                        <tr>
                            <th scope="col">설비명</th>
                            <th scope="col">수량</th>
                            <th scope="col">활용방안</th>
                            <th scope="col">비고</th>
                            <th scope="col"><span class="blind">행 삭제</span></th>
                        </tr>
                    </thead>
                    <tbody id="eqp1Tbody">
                        <tr th:id=' eqp1Tr + ${n.count} ' th:if='${eqpList != null}' th:each='eqp, n: ${eqpList}'>
                            <td><input type="text" maxlength="100" title="설비명" id="nm" name="nm" th:value="${eqp.nm}"></td>
                            <td>
                                <input type="text" maxlength="10" title="수량" id="qnty" name="qnty" th:value="${eqp.qnty}">
                                <p class="feedback"></p>
                            </td>
                            <td><input type="text" maxlength="100" title="활용방안" id="prcuseMthd" name="prcuseMthd" th:value="${eqp.prcuseMthd}"></td>
                            <td><input type="text" maxlength="100" title="비고" id="rmrk" name="rmrk" th:value="${eqp.rmrk}"></td>
                            <td class="ac"><button th:if='${n.count > 1}' type="button" class="btn-remove-table" title="행 삭제" onclick="eqp1DelRow()"><span class="icon icon-remove"></span></button>
                        </tr>
                    </tbody>
                </table>
            </div>

            <button type="button" class="btn-row-add" title="행 추가" id="addBtn3" onclick="eqp1AddRow()">
                <span class="icon icon-row-add"></span>
            </button>

            <div class="mo-only">
                <div class="btn-wrap">
                    <div class="center">
                        <button type="button" class="btn-medium btn-gray" onclick="doSave()">중간저장</button>
                    </div>
                </div>
                <div class="btn-wrap">
                    <div class="center">
                        <button type="button" class="btn-medium btn-gray">이전</button>
                        <button type="button" class="btn-medium btn-green" onclick="goNext()">다음</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        var nextUrl="/front/eduInst/aplyCmptnForm.html";
        var reUrl="/front/eduInst/fcltSttsForm.html";
        var insertUrl="/front/eduInst/insertFcltStts.do";
        var updateUrl="/front/eduInst/updateFcltStts.do";

        function navClick(){

        }

        function goNext(){
            location.href = nextUrl;
        }

        function lctrum1AddRow() {

        	var lastRow = $('[id^="lctrum1Tr"]:last');
            var idx = lastRow.index() + 2;

            if ($('[id^="lctrum1Tr"]').length >= 20) {
                alert("최대 20행까지만 추가 가능합니다.");
                return;
            }

            var newRow = lastRow.clone().attr('id', 'lctrum1Tr' + idx);
            newRow.find('input:not([id="seCd"]').val('');
            newRow.find('select').val('');

            lastRow.after(newRow);

            if ($('[id^="lctrum1Tr"]').length == 2) {
                $('[id^="lctrum1Tr"] td:last')
                    .append(`<button type="button" class="btn-remove-table" title="행 삭제" onclick="lctrum1DelRow()"><span class="icon icon-remove"></span></button>`);
            }
        }

        function lctrum1DelRow(){
        	var lastRow = $('[id^="lctrum1Tr"]:last');
            if(lastRow.index() > 0) lastRow.remove();
        }

        function lctrum2AddRow() {
        	var lastRow = $('[id^="lctrum2Tr"]:last');
            var idx = lastRow.index() + 2;

            if ($('[id^="lctrum2Tr"]').length >= 20) {
                alert("최대 20행까지만 추가 가능합니다.");
                return;
            }

            var newRow = lastRow.clone().attr('id', 'lctrum2Tr' + idx);
            newRow.find('input:not([id="seCd"]').val('');
            newRow.find('select').val('');

            lastRow.after(newRow);

            if ($('[id^="lctrum2Tr"]').length == 2) {
                $('[id^="lctrum2Tr"] td:last')
                    .append(`<button type="button" class="btn-remove-table" title="행 삭제" onclick="lctrum2DelRow()"><span class="icon icon-remove"></span></button>`);
            }
        }

        function lctrum2DelRow(){
        	var lastRow = $('[id^="lctrum2Tr"]:last');
            if(lastRow.index() > 0) lastRow.remove();
        }

        function eqp1AddRow() {
        	var lastRow = $('[id^="eqp1Tr"]:last');
            var idx = lastRow.index() + 2;

            if ($('[id^="eqp1Tr"]').length >= 20) {
                alert("최대 20행까지만 추가 가능합니다.");
                return;
            }

            var newRow = lastRow.clone().attr('id', 'eqp1Tr' + idx);
            newRow.find('input:not([id="seCd"]').val('');
            newRow.find('select').val('');

            lastRow.after(newRow);

            if ($('[id^="eqp1Tr"]').length == 2) {
                $('[id^="eqp1Tr"] td:last')
                    .append(`<button type="button" class="btn-remove-table" title="행 삭제" onclick="eqp1DelRow()"><span class="icon icon-remove"></span></button>`);
            }
        }

        function eqp1DelRow(){
        	var lastRow = $('[id^="eqp1Tr"]:last');
            if(lastRow.index() > 0) lastRow.remove();
        }

        function chkList(){
        	var flag = true;

        	var num_check='';

        	$('[name=ar],[name=nope]').each(function(idx,data){
        		var chkVal= $(this).val();
        		var nm = $(this).attr('name');
        		if(nm=='ar'){
        			num_check=/^[0-9.]*$/;
        		}else if(nm='nope'){
        			num_check=/^[0-9]*$/;
        		}
        		var msg ="숫자만 입력 가능합니다.";

        		//숫자 체크
        		if($(this).next().length==1) $(this).next().remove();
                if(!num_check.test(chkVal)){
                	if($(this).next().length==0) $(this).after(`<p class="feedback invalid" style='text-align:left;'>${msg}</p>`);
                	flag =false;
                }
        	});

        	return flag;

        }

        function doSave(call){

        	var url;
            var param = {};

            var lctrumList = [];
            var eqpList = [];


            $('tr[id^="lctrum"]').each(function(index, value){
            	var nm   = $(this).find('input[name="nm"]').val();
            	var ar   = $(this).find('input[name="ar"]').val();
            	var nope = $(this).find('input[name="nope"]').val();
            	var seCd = $(this).find('input[name="seCd"]').val();

            	lctrumList.push({
                    nm   :nm
                  , ar   :ar==''?0:ar
                  , nope :nope==''?0:nope
                  , seCd :seCd
                });
            });

            $('tr[id^="eqp"]').each(function(index, value){
            	var nm         = $(this).find('input[name="nm"]').val();
            	var qnty       = $(this).find('input[name="qnty"]').val();
            	var prcuseMthd = $(this).find('input[name="prcuseMthd"]').val();
            	var rmrk       = $(this).find('input[name="rmrk"]').val();

            	eqpList.push({
                    nm         :nm
                  , qnty       :qnty
                  , prcuseMthd :prcuseMthd
                  , rmrk       :rmrk
                });
            });

            var flag = true;

            if(!$('#fclstForm').valid())return;
            if(!chkList()) return

            if(call!="next")if(!confirm("저장하시겠습니까?")) return;

            param = {
                aplyid        : $("#aplyid").val()
              , rentYn        : $("#rentYn1").attr("checked") ? 'Y':'N'  /** 임대 여부 */
              , rentPrd       : $("#rentPrd").val()          /** 임대 기간 */
              , totar         : $("#totar").val()            /** 총면적 */
              , styFcltHoldYn : $("#styFcltHoldYn1").attr("checked") ? 'Y':'N'    /** 숙박 시설 보유 여부 */
              , styFcltAr     : $("#styFcltAr").val()        /** 숙박 시설 면적 */
              , styFcltNope   : $("#styFcltNope").val()      /** 숙박 시설 인원수 */
              , sttsCd        : $("#sttsCd").val() =='248101' ? '248102' : $("#sttsCd").val()
              , lctrumList: lctrumList
              , eqpList   : eqpList
            };
            var key = $("#fcltKey").val()
            if(key!=null && key!= ''&& key!=0){
            	url=updateUrl;
            }else{
            	url=insertUrl;
            }

            $.ajax({
                url : url,
                type: 'POST',
                cache : false,
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(param),
                success : function (data){
                    if(data.result=="success"){

                        var id = $("#aplyid").val();
                        if(call == "next") {
                            location.href = nextUrl+"?aplyid=" + id;
                        }else{
                        	alert(data.msg);
                            location.href = reUrl+"?aplyid=" + id;
                        }
                    }else{
                        alert(data.msg);
                    }
                },
                error : function (error){
                }
            });
        };

        $(function(){

        	var validator= $("#fclstForm").validate({
                rules: {
                	 totar      : { number:true }
                    ,styFcltAr  : { number:true }
                    ,styFcltNope: { number:true }
                    ,qnty       : { number:true }
                },
                messages: {
                	totar      : { number:"숫자만 입력가능합니다."}
                   ,styFcltAr  : { number:"숫자만 입력가능합니다."}
                   ,styFcltNope: { number:"숫자만 입력가능합니다."}
                   ,qnty       : { number:"숫자만 입력가능합니다."}
                }
            })

        });
    </script>
</div>
</body>
</html>