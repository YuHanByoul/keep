<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" 
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout" 
    layout:decorator="layout/front/subLayout" 
>

<body>
<div layout:fragment="content">
    <section>
	    <div class="table-caption">
	        <div class="left">
	            <h3 class="sub-title">기본정보</h3>
	        </div>
	    </div>
	    <form id="saveForm">
	        <input type="hidden" name="ansSttsCd" id="ansSttsCd" th:value="${detail.excclcSttsCd}"/>
	        <input type="hidden" name="aplyid" id="aplyid" th:value="${detail.aplyid}"/>
		    <div class="table-row table-row-mo">
		        <table>
		            <caption>기본정보 - </caption>
		            <colgroup>
		                <col style="width:140px;">
		                <col>
		                <col style="width:140px;">
		                <col>
		            </colgroup>
		            <tbody>
		                <tr>
		                    <th scope="row">공모명</th>
		                    <td><th:block th:text="${detail.pcntstNm}" /></td>
		                    <th scope="row">프로그램명</th>
		                    <td><th:block th:text="${detail.prgrmNm}" /></td>
		                </tr>
		                <tr>
		                    <th scope="row">신청기관 / 신청자</th>
		                    <td><th:block th:text="${detail.instNm == null ? '-' : detail.instNm}" /> / <th:block th:text="${detail.aplcntNm}" /> </td>
		                    <th scope="row">사업기간</th>
		                    <td><th:block th:text="${detail.bsnsDe}" /></td>
		                </tr>
		                <tr>
		                    <th scope="row">예산액</th>
		                    <td class="ar"><th:block th:text="${#numbers.formatInteger(detail.totAmt, 0, 'COMMA')}" /></td>
		                    <th scope="row">지출액</th>
		                    <td class="ar"><th:block th:text="${#numbers.formatInteger(detail.minusAmt, 0, 'COMMA')}" /></td>
		                </tr>
		                <tr>
		                    <th scope="row">집행잔액</th>
		                    <td class="ar"><th:block th:text="${#numbers.formatInteger(detail.nowAmt, 0, 'COMMA')}" /></td>
		                    <th scope="row">이자+캐쉬백</th>
		                    <td class="ar"><th:block th:text="${#numbers.formatInteger(detail.plusAmt, 0, 'COMMA')}" /></td>
		                </tr>
		                <tr>
		                    <th scope="row">잔액(집행잔액+이자발생분)</th>
		                    <td colspan="3" class="ar"><th:block th:text="${#numbers.formatInteger(detail.amt, 0, 'COMMA')}" /></td>
		                </tr>
		                <tr>
		                    <th scope="row">통장사본</th>
		                    <td colspan="3">
		                        <div class="form-input-file">
		                            <span class="form-input" th:if="${detail.crudBtn != 'R'}">
		                                <input type="file" id="multiFileInput1" name="files" class="blind" accept=".jpeg,.jpg,.png,.gif,.tif,.tiff,.hwp,.hwpx,.pdf,.ppt,.pptx,.doc,.docx,.xls,.xlsx,.zip" title="파일첨부">
		                            </span>
	                                <label for="multiFileInput1"  class="btn-medium btn-gray" th:if="${detail.crudBtn != 'R'}">파일선택</label>
		                            <div class="upload-response">
		                                <div id="multipleFileUploadError1"></div>
		                                <div id="multipleFileUploadSuccess1">
		                                <th:block th:if="${bankFile != null}">
		                                    <div th:each="item : ${bankFile}" th:id="${item.fileid}" class="col-auto">
		                                        <ul th:if="${item.orginlFileNm != null}">
		                                            <li th:fileid='${item.fileid}'
		                                                th:fileIdntfcKey="${item.fileIdntfcKey}"
		                                                th:onclick="downloadFileByFileid(this.getAttribute('fileid'),this.getAttribute('fileIdntfcKey'))"
		                                                class='label label-inverse'
		                                                th:data_ext="${#strings.replace(item.fileExtsn, '.', '')}">
		                                                <th:block th:text="${item.orginlFileNm}" />&nbsp;&nbsp; 
		                                                <a th:if="${detail.crudBtn != 'R'}" th:name="${item.fileid}" th:attr="data-idntfc-key=${item.fileIdntfcKey}" th:onclick="fn_deleteFileList(this.name, this.dataset.idntfcKey)" class='text-white'> 
		                                                <th:block th:text="X"></th:block></a>
		                                            </li>
		                                        </ul>
		                                    </div>
		                                </th:block>
		                                </div>
		                            </div>
		                            <input type="hidden" id="bnkbFileid" name="bnkbFileid" th:value="${(detail.bnkbFileid == '' or detail.bnkbFileid == null) ? 0 : detail.bnkbFileid}"/>
		                        </div>
		                    </td>
		                </tr>
		                <tr>
		                    <th scope="row">첨부파일</th>
		                    <td colspan="3">
		                        <div class="form-input-file">
		                            <span class="form-input" th:if="${detail.crudBtn != 'R'}">
		                                <input type="file" id="multiFileInput2" name="files" class="blind" multiple="multiple" accept=".jpeg,.jpg,.png,.gif,.tif,.tiff,.hwp,.hwpx,.pdf,.ppt,.pptx,.doc,.docx,.xls,.xlsx,.zip" title="파일첨부" maxcount="10">
		                            </span>
	                                <label for="multiFileInput2" class="btn-medium btn-gray" th:if="${detail.crudBtn != 'R'}">파일선택</label>
		                            <div class="upload-response">
		                                <div id="multipleFileUploadError2"></div>
		                                <div id="multipleFileUploadSuccess2">
		                                <th:block th:if="${fileList != null}">
		                                    <div th:each="item : ${fileList}" th:id="${item.fileid}" class="col-auto">
		                                        <ul th:if="${item.orginlFileNm != null}">
		                                            <li th:fileid='${item.fileid}'
		                                                th:fileIdntfcKey="${item.fileIdntfcKey}"
		                                                th:onclick="downloadFileByFileid(this.getAttribute('fileid'),this.getAttribute('fileIdntfcKey'))"
		                                                class='label label-inverse'
		                                                th:data_ext="${#strings.replace(item.fileExtsn, '.', '')}">
		                                                <th:block th:text="${item.orginlFileNm}" />&nbsp;&nbsp; 
		                                                <a th:if="${detail.crudBtn != 'R'}" th:name="${item.fileid}" th:attr="data-idntfc-key=${item.fileIdntfcKey}" th:onclick="fn_deleteFileList(this.name, this.dataset.idntfcKey)" class='text-white'> 
		                                                <th:block th:text="X"></th:block></a>
		                                            </li>
		                                        </ul>
		                                    </div>
		                                </th:block>
		                                </div>
		                            </div>
		                            <input type="hidden" id=excclcAtchFilegrpid name="excclcAtchFilegrpid" th:value="${(detail.excclcAtchFilegrpid == '' or detail.excclcAtchFilegrpid == null) ? 0 : detail.excclcAtchFilegrpid}"/>
		                        </div>
		                    </td>
		                </tr>
		            </tbody>
		        </table>
		    </div>
	    </form>
	    
	    <div class="table-caption flex-nowrap">
	        <div class="left">
	            <h3 class="sub-title">집행내역 개요서</h3>
	            <p class="fc-red">* 이자/캐시백 미포함</p>
	        </div>
	    </div>
	    
	    <div class="table-col table-layout-auto table-col-scroll">
	        <table>
	            <caption>집행내역 개요서 - 비목(항목, 세목), 예산액, 지출금액, 집행건수, 집행잔액, 집행비율</caption>
	            <thead>
	                <tr>
	                    <th scope="colgroup" colspan="2">비목</th>
	                    <th scope="col" rowspan="2">예산액</th>
	                    <th scope="col" rowspan="2">지출금액</th>
	                    <th scope="col" rowspan="2">집행건수</th>
	                    <th scope="col" rowspan="2">집행잔액</th>
	                    <th scope="col" rowspan="2">집행비율</th>
	                </tr>
	                <tr>
	                    <th scope="col">항목</th>
	                    <th scope="col">세목</th>
	                </tr>
	            </thead>
	            <tbody id="outlList-area"> 
	            </tbody>
	        </table>
	    </div>
	
	
	    <div class="table-caption flex-nowrap">
	        <div class="left">
	            <h3 class="sub-title">세부 집행내역서</h3>
	            <p class="fc-red">* 이자/캐시백 미포함</p>
	            <p class="fc-red">* 입금액 / 출금액</p>
	        </div>
	    </div>
	
	
	    <div class="table-col table-layout-auto table-col-scroll">
	        <table>
	            <caption>세부 집행내역서 - 번호, 비목(항목, 세목),일자, 입출금, 내역, 사용목적, 금액, 증빙자료</caption>
	            <thead>
	                <tr>
	                    <th scope="col" rowspan="2">번호</th>
	                    <th scope="colgroup" colspan="2">비목</th>
	                    <th scope="col" rowspan="2">일자</th>
	                    <th scope="col" rowspan="2">입출금</th>
	                    <th scope="col" rowspan="2">내역</th>
	                    <th scope="col" rowspan="2">사용목적</th>
	                    <th scope="col" rowspan="2">금액</th>
	                    <th scope="col" rowspan="2">증빙자료</th>
	                </tr>
	                <tr>
	                    <th scope="col">항목</th>
	                    <th scope="col">세목</th>
	                </tr>
	            </thead>
	            <tbody>
	                <th:block th:if="${#lists.size(list) > 0}">
		            <tr th:each="list, i: ${list}">
	                    <td>11</td>
	                    <td><th:block th:text="${list.artclUpperNm}" /></td>
	                    <td><th:block th:text="${list.artclNm}" /></td>
	                    <td><th:block th:text="${list.de}" /></td>
	                    <td><th:block th:text="${list.seNm}" /></td>
	                    <td class="al"><th:block th:text="${list.dsctn}" /></td>
	                    <td class="al"><th:block th:text="${list.usePrps}" /></td>
	                    <td class="ar"><span th:class="${list.color}+' nowrap'"><th:block th:text="${list.amt}" /></span></td>
	                    <td class="al"><a href="javascript:;" th:onclick="downloadFileByFileid([[${list.fileid}]], [[${list.fileIdntfcKey}]])" class="link"><th:block th:text="${list.orginlFileNm}"/></a></td>
	                </tr>
	                </th:block>
	                <th:block th:unless="${#lists.size(list) > 0}">
		                <tr>
		                    <td class="nodata" colspan="9">
		                        <p><span class="icon icon-notice bg-black9"></span>집행내역이 없습니다.</p>
		                    </td>
		                </tr>
		            </th:block>
	            </tbody>
	            <tfoot>
	                <tr>
	                    <th scope="row" colspan="7">합계(집행합계)</td>
	                    <td class="bg5 ar pl20"><span class="nowrap" id="minusSum"><th:block th:text="${#numbers.formatInteger(detail.minusAmt, 0, 'COMMA')}" /></span></td>
	                    <td class="bg5"></td>
	                </tr>
	            </tfoot>
	        </table>
	    </div>
	
	    <div class="btn-wrap">
	        <div class="center">
	            <button type="button" class="btn-medium btn-gray" onclick="listPage.goListPage()">목록</button>
	            <button th:if="${detail.crudBtn != 'R'}" type="button" class="btn-medium btn-green" onclick="listPage.updateClclnReport()">제출</button>
	        </div>
	    </div>
	</section>

<!-- layerpopup -->
<div class="layer-popup layer-large" data-layer-id="clclnDsctnModalPopup">
    <div class="layer-dimmed" title="레이어팝업 닫기"></div>
    <div class="layer-wrap" id="clclnDsctnModalPopup">
    </div>
</div>

<!-- layerpopup -->
<div class="layer-popup layer-large" data-layer-id="bankModalPopup">
    <div class="layer-dimmed" title="레이어팝업 닫기"></div>
    <div class="layer-wrap" id="bankModalPopup">
    </div>
</div>

<script th:inline="javascript">
	/*<![CDATA[*/
	var fldCd = /*[[${detail.fldCd}]]*/null;
	var aplyid = /*[[${detail.aplyid}]]*/null;
	var excclcSttsCd = /*[[${detail.excclcSttsCd}]]*/null;
	/*]]>*/
    var atchfileCnt = 6;
    var uploadFileCnt = 0;
	var listPage = {
        outlListUrl: '/front/clclnMng/selectClclnDsctnOutlList.do',
        updateUrl : '/front/clclnReport/updateClclnReport.do',

        init() {
            this.outlSelectList();
        },
        addComma(value) {
        	if (value == "" || value == null) {
                return 0;               
            }
        	return value.replace(/(\d)(?=(?:\d{3})+(?!\d))/g, '$1,');
        },
        removeComma(value){
            if (value == "" || value == null) {
                return 0;               
            }
            value = value.replace(/[^\d]+/g, "");
            return value; 
        },
        goListPage() {
        	location.href = "/front/clclnReport/clclnReportListForm.html";
        },
        updateClclnReport() {
            if (displayWorkProgress(true)) {
            	if(!confirm("제출 하시겠습니까?")){return;}
            	$("#ansSttsCd").val("203102");
            	var data =  $("#saveForm").serialize();
                $.ajax({
                    url: listPage.updateUrl,
                    cache: false,
                    dataType: 'json',
                    data: data,
                    type: 'POST',
                    success: function (data) {
                    	if(data.result=="success"){
                            alert(data.msg);
                            listPage.goListPage();
                        }else{
                            alert(data.msg);
                        }
                    }
                });
            }
        },
        outlSelectList() {
            if (displayWorkProgress(true)) {
                $.ajax({
                    url: listPage.outlListUrl,
                    cache: false,
                    dataType: 'json',
                    data: {
                    	fldCd: fldCd
                    	, aplyid: aplyid
                    },
                    type: 'GET',
                    success: function (data) {
                        listPage.makeOutlListHtml(data);
                        closeWorkProgress();
                    }
                });
            }
        },
        makeOutlListHtml(data) {
        	var listHtml = "";
        	var footHtml = "";
            if (data.list == null || data.list.length <= 0) {
                listHtml += `
                <tr>
                    <td class="nodata" colspan="9">
                        <p><span class="icon icon-notice bg-black9"></span>집행내역이 없습니다.</p>
                    </td>
                </tr>
                `;
            } else {
                data.list.forEach(function(item) {
                    listHtml += `<tr>`;
                    if (item.groupNum == "1" && item.artclUpperNm != null) {
                        listHtml += `<td rowspan="${item.rowspan}">${item.artclUpperNm}</td>`;                    	
                    }
                    if (item.artclUpperNm == null) {
                    	listHtml += `
                    	    <th scope="row" colspan="2" class="bg7">합계</th>
                    	    <td class="bg7 ar">${item.amt}</td>
                            <td class="bg7 ar">${item.minusSum}</td>
                            <td class="bg7 ar">${item.cnt}</td>
                            <td class="bg7 ar">${item.nowAmt}</td>
                            <td class="bg7 ar">${item.clclnRate}%</td>
                    	`;
                    } else if (item.artclNm == null) {
                        listHtml += `
                            <th scope="row" colspan="2">소계</th>
                            <td class="bg5 ar">${item.amt}</td>
                            <td class="bg5 ar">${item.minusSum}</td>
                            <td class="bg5 ar">${item.cnt}</td>
                            <td class="bg5 ar">${item.nowAmt}</td>
                            <td class="bg5 ar">${item.clclnRate}%</td>
                        `;
                    } else {
                        listHtml += `
                            <td>${item.artclNm}</td>
	                        <td class="ar">${item.amt}</td>
	                        <td class="ar">${item.minusSum}</td>
	                        <td class="ar">${item.cnt}</td>
	                        <td class="ar">${item.nowAmt}</td>
	                        <td class="ar">${item.clclnRate}%</td>
                        `;
                    }
	                listHtml += `</tr>`;
                });
            }
            $('#outlList-area').html(listHtml);
        },
    };

    $(function () {
        listPage.init();
    });
    
    // 파일업로드
    $('#multiFileInput1, #multiFileInput2').on("change", function(event) {
        var fileOjbId = $(this).prop("id");
        var objFile = document.querySelector('#'+fileOjbId);
        var formData = new FormData();
        var content = "";
        var regex = /[^0-9]/g;
        var fileNum = fileOjbId.replace(regex, "");
        var fileLength = $("#multipleFileUploadSuccess" + fileNum).find("ul > li").length;

        for( i = 0 ; i < objFile.files.length ; i++) {
            if (fileNum == "1") {
                if (fileLength+objFile.files.length > 1) {
                    alert("통장사본의 첨부파일은 1개만 등록가능합니다.");
                    break;
                }
            } else {
                if (fileLength+objFile.files.length > 5) {
                    alert("첨부파일은 최대 5개까지 등록가능합니다.");
                    break;
                }
            }
            
            formData.append("files", objFile.files[i]);
            uploadFileCnt++;
        }
        
        formData.append("filegrpid", fileNum == "1" ? $("#bnkbFileid").val() : $("#excclcAtchFilegrpid").val());
        formData.append("filegrpNm", "clclnDsctn_file");

        if(uploadFileCnt > 0){
            $.ajax({
                url : '/uploadMultipleFiles.do',
                processData : false,
                contentType : false,
                data : formData,
                type : 'POST',
                success : function(response) {
                    if(response.result == 'fail'){
                        alert(response.msg);
                    }else{
                    	if (fileNum == "1") {
	                        if($("#bnkbFileid").val()=='0' || $("#bnkbFileid").val()==''  || $("#bnkbFileid").val()==null){
	                            $("#bnkbFileid").val( response[0].filegrpid );
	                        }
                    	} else {
                    		if($("#excclcAtchFilegrpid").val()=='0' || $("#excclcAtchFilegrpid").val()==''  || $("#excclcAtchFilegrpid").val()==null){
                                $("#excclcAtchFilegrpid").val( response[0].filegrpid );
                            }
                    	}

                        for(i = 0 ;i < response.length; i++ ){
                            content = '<ul>';
                            content +=  '<li class="file-block" data_ext="'+response[i].fileExtsn.replace(".", '')+'" id="'+response[i].fileid+'"><span class="name">'+response[i].orginlFileNm
                            content += '&nbsp;&nbsp;<a href="javascript:uploadFileCnt--;fn_deleteFileList("'+response[i].fileid+'","'+response[i].fileIdntfcKey+'")>X</a></span></li>'
                            content += '</ul>';
                            $('#multipleFileUploadSuccess'+fileNum).append(content);
                        }
                    }
                }
            });
        } 
    });

    // 파일삭제
    function fn_deleteFileList(fileid, fileIdntfcKey){
        if(!confirm("파일을 삭제하시겠습니까?")){return;}
        fn_deleteFile(fileid, fileIdntfcKey);
        $("#"+fileid).remove();
    }

    // 파일삭제
    function fn_deleteFile(fileid, fileIdntfcKey){
        var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;
          $.ajax({
            url : deleteFileUrl,
            type: 'GET',
            cache : false,
            dataType: 'json',
            success : function (data){
                if(data.result=="success"){
                    $("#"+fileid).remove();
                    alert("파일삭제가 완료 되었습니다.");
                }else{
                    alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                }
            },
            error : function (error){
            }
         })
    }
</script>
</div>
</body>
</html>