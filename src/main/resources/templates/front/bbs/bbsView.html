<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="layout/front/subLayout">
<body>

<div layout:fragment="content">
        <div class="table-view">
        <div class="table-view-header">
            <h3><span>[[${pstInfo.title}]]</span></h3>
            <dl>
                <div class="list">
                    <dt>등록기관</dt>
                    <dd>[[${pstInfo.userNm}]]</dd>
                </div>
                <div class="list">
                    <dt>등록일</dt>
                    <dd>[[${#dates.format(pstInfo.regDt, 'yyyy-MM-dd')}]]</dd>
                </div>
                <div class="list">
                    <dt>조회수</dt>
                    <dd>[[${pstInfo.hits}]]</dd>
                </div>
            </dl>
            <dl>
                <div class="list">
                    <dt>첨부파일</dt>
                    <dd>
                        <div class="form-input-file">
                            <ul th:each="file : ${fileMap}">
                                <li class="file-block" th:data_ext="${#strings.substring(file.fileExtsn,1)}">
                                    <span class="name">
                                        <!-- <a href="javascript:void(0)" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                                           th:onclick="|javascript:downloadFileByFileid(this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'))|"> -->
                                        <a th:href="|javascript:downloadFileByFileid('${file.fileid}','${file.fileIdntfcKey}')|">   
                                           
                                                        [[${file.orginlFileNm}]]
                                        </a>
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </dd>
                </div>
            </dl>
        </div>
        <div class="table-view-body">
            <div class="table-view-content">
				<th:block th:utext="${pstInfo.cntnts}"></th:block>
            </div>
        </div>

        <div class="btn-wrap">
            <div class="center">
                <button type="button" class="btn-medium btn-gray" onclick="goListPage()">목록</button>
            </div>
        </div>

        <div class="page-navigation">
            <a th:href="|javascript:goToOtherPst('${pstInfo.prevPstid}')|">
                <dl>
                    <dt>이전글</dt>
                    <dd><span class="ellipsis">[[${pstInfo.prevTitle}]]</span></dd>
                </dl>
            </a>

            <a th:href="|javascript:goToOtherPst('${pstInfo.nextPstid}')|">
                <dl>
                    <dt>다음글</dt>
                    <dd><span class="ellipsis">[[${pstInfo.nextTitle}]]</span>
                    </dd>
                </dl>
            </a>
        </div>
    </div>

    <form name="listForm" id="listForm" method="GET">
        <input type="hidden" id="pageNumber" name="pageNumber" th:value="${PstVo.pageNumber}">
        <input type="hidden" id="rowPerPage" name="rowPerPage" th:value="${PstVo.rowPerPage}">
        <input type="hidden" id="searchType" name="searchType" th:value="${PstVo.searchType}">
        <input type="hidden" id="orderField" name="orderField" th:value="${PstVo.orderField }">
        <input type="hidden" id="searchKeyword" name="searchKeyword" th:value="${PstVo.searchKeyword}">
        <input type="hidden" id="tabType" name="tabType" th:value="${PstVo.tabType}">
        <input type="hidden" id="pstid" name="pstid">
    </form>

    <script th:inline="javascript">
        var PstVo = /*[[${PstVo}]]*/null;
        var bbsInfo = /*[[${bbsInfo}]]*/null;
        var goReadUrl = "/front/bbs/" + bbsInfo.bbsid + "/view.html"
        var goListFormUrl = "/front/bbs/" + bbsInfo.bbsid + "/main.html";
        var selectCmntListUrl = "/front/bbs/" + bbsInfo.bbsid + "/selectCmntList.do";
        var insertCmnturl = "/front/bbs/" + bbsInfo.bbsid + "/insertCmnt.do";
        var modifyCmntUrl = "/front/bbs/" + bbsInfo.bbsid + "/updateCmnt.do";
        var delelteCmntUrl = "/front/bbs/" + bbsInfo.bbsid + "/updateCmntReplyDelYn.do";
        var insertReplyUrl = "/front/bbs/" + bbsInfo.bbsid + "/insertCmntReply.do";
        var goModifyFormUrl = "/front/bbs/" + bbsInfo.bbsid + "/modify.html";

        $(document).ready(function () {

            if (bbsInfo.cmntUseYn == 'Y') {
                fn_selectCmntList();
            }
        })

        function goToOtherPst(pstid) {
            if(pstid == null) return;

            let f = document.forms.listForm;
            f.action = goReadUrl;
            f.pstid.value = pstid;
            f.submit();
        }

        function goModifyPage() {
            var f = document.forms.modifyForm;
            f.action = goModifyFormUrl;
            f.submit();
        }

        function goListPage() {
            var f = document.forms.listForm;
            f.action = goListFormUrl;
            f.submit();
        }

        function fn_disableTrue(id) {
            $("#" + id).attr("disabled", "true");
        }

        function fn_disableFalse(id) {
            $("#" + id).removeAttr("disabled");
        }

        function fn_selectCmntList() {

            $.ajax({
                url: selectCmntListUrl,
                type: 'POST',
                cache: false,
                dataType: 'json',
                data: {
                    "pstid": PstVo.pstid
                    , "pageNumber": $("#pageNumber").val()
                },
                success: function (data) {
                    $("#reply_area").html(makeCmntHtml(data.list))
                    $(".paging").html(data.pagination)
                    closeWorkProgress();
                },
                error: function (error) {
                }
            })
        }

        function makeCmntHtml(list) {

            if (list == null || list.length <= 0) return;

            var html = "";

            list.forEach(function (item) {

                if (item.paddingStr == null || item.paddingStr == "") {
                    item.paddingStr = "";
                }

                html += '<div style="padding:5px;margin-bottom:10px;border:1px solid lightgray;padding:10px;border-radius:5px;">'
                html += ' <form id="replyForm' + item.cmntid + '" >';

                html += '<input type="hidden" id="pstid"    name="pstid"    value="' + item.pstid + '">'
                html += '<input type="hidden" id="cmntid"   name="cmntid"   value="' + item.cmntid + '">'
                html += '<input type="hidden" id="dpth"     name="dpth"     value="' + item.dpth + '">'
                html += '<input type="hidden" id="ord"      name="ord"      value="' + item.ord + '">'
                html += '<input type="hidden" id="cmntGrp" name="cmntGrp" value="' + item.cmntGrp + '">'
                html += '<input type="hidden" id="curText" value="' + item.cntnts + '">'

                if (item.delYn == 'Y') {

                    html += '<div class="" style="height:30px;">'
                    html += '<label>' + item.dpthStr + item.nm + '(' + item.acnt + ')</label>'
                    html += '<h6><label style="height:40px;font-size:20px;">' + item.paddingStr + '삭제된 게시물입니다.</label></h6>'
                    html += '</div>'

                } else {

                    html += '<div id="normalForm' + item.cmntid + '">'
                    html += '<div class="" style="padding-left:' + item.dpth * 10 + 'px;">'

                    html += '<div class="" style="height:30px;">'
                    html += '<label>' + item.dpthStr + item.nm + '(' + item.acnt + ')</label>'

                    if (PstVo.user != null && PstVo.user.userid == item.rgtrid) {

                        html += '	<input type="button" class="btn-small btn-color2" id="' + item.cmntid + '" onclick="fn_openModifytReplyForm(this.id)" value="수정 " />'
                        html += '	<input type="button" class="btn-small btn-color2" id="' + item.cmntid + '" onclick="fn_deleteCmntReply(this.id)" value="삭제" />'
                    }

                    html += '</div>'
                    html += '</div>'

                    html += '<div style="margin:10px;">'
                    html += '<h6><label style="height:30px;font-size:20px;">' + item.paddingStr + item.cntnts + '</label></h6>'
                    html += '</div>'

                    if (bbsInfo.rplyUseYn == "Y" && item.dpth < 2) {
                        html += item.paddingStr
                        html += '<input type="button" class="btn-small btn-color1" id=' + item.cmntid + '  onclick="fn_openReplyForm(this.id)" value="답글" />'
                    }
                    html += '</div>'

                    html += '<div id="modifyForm' + item.cmntid + '" style="margin-top:5px;display:none;">'
                    html += '    <span>' + item.paddingStr + '</span>'
                    html += ' 	 <label>' + item.dpthStr + item.nm + '(' + item.acnt + ')</label>'
                    html += '    <span>' + item.paddingStr + '</span>'
                    html += '    <br/>'
                    html += '    <br/>'
                    html += ' 	 <textarea class="textarea" name="modifyReplyCntnts" title="내용 입력"	id="modifyReplyCntnts" style="height: 6.25em;">' + item.cntnts + '</textarea>'
                    html += ' 	 <input type="button" class="btn-small btn-color1"	id="' + item.cmntid + '" onclick="fn_modifyCmntReply(this.id)"value="수정등록" />'
                    html += ' 	 <input type="button" class="btn-small btn-color1" id="' + item.cmntid + '" onclick="fn_closeModifyReplyForm(this.id)" value="취소" />'
                    html += ' </div>'

                    html += ' <div id="replyCntntsForm' + item.cmntid + '" style="padding-left: 0px; display: none">'
                    html += ' 	<textarea id="cntnts" name="cntnts" class="textarea" style="height: 6.25em;" title="내용 입력" ></textarea>'
                    html += ' 	<input type="button" class="btn-small btn-color1"	id="' + item.cmntid + '" onclick="fn_insertReply(this.id)" value="답글등록" />'
                    html += ' 	<input type="button" class="btn-small btn-color1" id="' + item.cmntid + '" onclick="fn_cnacelInsertReply(this.id)" value="취소 " />'
                    html += '</div>'
                }
                html += ' </form>'
                html += '</div>'
            })
            return html;
        }

        function fn_cnacelInsertReply(cmntid) {
            $("#replyForm" + cmntid + "  #cntnts").val("");
            $("#replyCntntsForm" + cmntid).css("display", "none");
            $("#normalForm" + cmntid).css("display", "block");
            $("#modifyForm" + cmntid).css("display", "none");
        }

        function fn_closeModifyReplyForm(cmntid) {
            $("#replyCntntsForm" + cmntid).css("display", "none");
            $("#normalForm" + cmntid).css("display", "block");
            $("#modifyForm" + cmntid).css("display", "none");
        }

        function fn_openModifytReplyForm(cmntid) {
            var text = $("#replyForm" + cmntid + " #curText ").val();
            $("#modifyForm" + cmntid + "  #modifyReplyCntnts").val(text);
            $("#replyCntntsForm" + cmntid).css("display", "none");
            $("#normalForm" + cmntid).css("display", "none");
            $("#modifyForm" + cmntid).css("display", "block");
        }

        function fn_openReplyForm(cmntid) {
            $("#replyCntntsForm" + cmntid).css("display", "block");
        }

        function goPage(pageNumber) {
            $("#pageNumber").val(pageNumber);
            fn_selectCmntList();
        }

        //댓글 입력
        function fn_insertCmnt() {

            var cmntValidator = $("#cmntForm").validate({
                rules: {cmntCntnts: {required: true}},
                messages: {cmntCntnts: {required: "댓글 내용을 입력해 주십시오."}}
            })

            if ($("#cmntForm").valid() == false) return;

            var cmntCntnts = $("#cmntCntnts").val();

            if (!confirm("저장하시겠습니까?")) return;
            var data = {
                pstid: PstVo.pstid,
                cntnts: $("#cmntCntnts").val()
            }

            if (displayWorkProgress()) {
                $.ajax({
                    url: insertCmnturl,
                    type: 'POST',
                    cache: false,
                    dataType: 'json',
                    data: data,
                    success: function (data) {
                        if (data.result == "success") {
                            alert("등록이 완료 되었습니다.");
                            $("#cmntCntnts").val("");
                            $("#pageNumber").val(1);
                            fn_selectCmntList();
                        } else {
                            alert("등록중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                        }
                        closeWorkProgress();
                    },
                    error: function (error) {
                    }
                })
            }

        }

        //댓글 수정
        function fn_modifyCmntReply(cmntid) {

            $("#replyForm" + cmntid).validate({
                rules: {
                    modifyReplyCntnts: {required: true}
                },
                messages: {
                    modifyReplyCntnts: {required: "답글 내용을 입력해 주십시오."}
                }
            })

            var data = {
                cntnts: $("#replyForm" + cmntid + " #modifyReplyCntnts").val(),
                cmntid: $("#replyForm" + cmntid + " #cmntid").val(),
            }

            if (!confirm("답글을 수정 하시겠습니까?")) {
                return;
            }

            if (displayWorkProgress()) {
                $.ajax({
                    url: modifyCmntUrl,
                    type: 'POST',
                    cache: false,
                    dataType: 'json',
                    data: data,
                    success: function (data) {
                        if (data.result == "success") {
                            alert("수정이 완료 되었습니다.");
                            $("#cmntCntnts").val("");
                            fn_selectCmntList();
                        } else {
                            alert("수정중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                        }
                        closeWorkProgress();
                    },
                    error: function (error) {
                    }
                })
            }
        }

        /*댓글 삭제  */
        function fn_deleteCmntReply(cmntid) {
            var data = {
                cmntid: $("#replyForm" + cmntid + " #cmntid").val(),
                delYn: 'Y'
            }
            if (!confirm("답글을 삭제 하시겠습니까?")) {
                return;
            }

            if (displayWorkProgress()) {
                $.ajax({
                    url: delelteCmntUrl,
                    type: 'POST',
                    cache: false,
                    dataType: 'json',
                    data: data,
                    success: function (data) {
                        if (data.result == "success") {
                            alert("삭제가 완료 되었습니다.");
                            fn_selectCmntList();
                        } else {
                            alert("삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                        }
                        closeWorkProgress();
                    },
                    error: function (error) {
                    }
                })
            }
        }

        /* 댓글 등록 */
        function fn_insertReply(cmntid) {

            var cmntValidator = $("#replyForm" + cmntid).validate({
                rules: {
                    cntnts: {required: true}
                },
                messages: {
                    cntnts: {required: "답글 내용을 입력해 주십시오."}
                }
            })

            if ($("#replyForm" + cmntid).valid() == false) {
                return;
            }

            if (!confirm("답글을 저장하시겠습니까?")) {
                return;
            }

            var dpth = $("#replyForm" + cmntid + "  #dpth").val();

            var data = {
                pstid: $("#replyForm" + cmntid + "  #pstid").val(),
                cntnts: $("#replyForm" + cmntid + "  #cntnts").val(),
                dpth: (dpth == null || dpth == '0' || dpth == '') ? 0 : Number(dpth),
                prntsCmntid: $("#replyForm" + cmntid + "  #cmntid").val(),
                cmntGrp: $("#replyForm" + cmntid + "  #cmntGrp").val(),
                ord: $("#replyForm" + cmntid + "  #ord").val()
            }

            if (displayWorkProgress()) {
                $.ajax({
                    url: insertReplyUrl,
                    type: 'POST',
                    cache: false,
                    dataType: 'json',
                    data: data,
                    success: function (data) {
                        if (data.result == "success") {
                            alert("등록이 완료 되었습니다.");
                            fn_selectCmntList();
                        } else {
                            alert("등록중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                        }
                        closeWorkProgress();
                    },
                    error: function (error) {
                    }
                })
            }
        }

    </script>

</div>
</body>
</html>