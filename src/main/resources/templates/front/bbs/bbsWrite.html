<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" 
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout" 
    layout:decorator="layout/front/intro/detailLayout" 
>
    <body>
        <div layout:fragment="content">
            <article class="qna-wrap">
                <form id="pstInsertForm" submit="return:false;">
                    <fieldset>
                        <legend><span>글쓰기</span></legend>
                        <h3 class="title"><th:block th:text="${bbsInfo.nm}"></th:block> 글쓰기 </h3>

                        <div class="board-wrap">
                            <table class="board-input">
                                <caption><span>문의하기 작성</span></caption>
                                <colgroup>
                                    <col style="width: 179px;">
                                    <col>
                                </colgroup>
                                <tr>
                                    <th scope="row"><label for="title">제목</label></th>
                                    <td>
                                        <input type="text" id="title" name="title" class="input-text" style="width: 100%;">
                                        <span class="form-msg"></span>
                                    </td>
                                </tr>
                                
                			    <th:block  th:if ="${bbsInfo.clUseYn == 'Y'}">
                                    <tr>
                                    <th scope="row"><label for="title">분류</label></th>
	                                    <td>
										<fieldset>
										    <legend>
										    	<span>검색</span>
										    </legend>
										    
										    <div class="search-board-in">
										    	<select title="구분" class="form-select" id="bbsClid" name="bbsClid">
										    		<option value="">분류선택</option>
										    		<th:block th:each="item : ${clList}">
										    		    <option th:value="${item.bbsClid}"><th:block th:text="${item.clNm}"/></option>
										    		</th:block>
										    	</select>
										    	<span class="form-msg"></span> 
										    </div>
										</fieldset>
										
	                                    </td>
                                    </tr>
						       </th:block>
						       
                               <tr>
                                    <td colspan="4" class="">
                                        <textarea cols="40" id="cntnts" name="cntnts" rows="5" placeholder="내용을 입력하세요." title="내용입력" class="textarea"></textarea>
                                        <span class="form-msg"></span>
                                    </td>
                                    
                              </tr>
                                
                              <th:block th:if="${bbsInfo.atchfileUseYn=='Y'}">
                                <tr>
                                  <th scope="row"><label for="title">파일첨부</label></th>
                                  <td colspan="4" class="">
								    <div  style="text-align:left;">
							                       <div class="multiple-upload" >
													<label class="btn-medium btn-color1"> 
														파일 업로드 <input id="multiFileInput" type="file" name="files" multiple accept="image/jpeg,image/gif,image/png,application/pdf" style="display: none;">
													</label>
													<br/>
													<br/>
													<div class="upload-response">
														<div id="multipleFileUploadError"></div>
														<div id="multipleFileUploadSuccess"></div>
													</div>
													<input type="hidden"  id = "filegrpid" name = "filegrpid" value='0'/>
												</div>
								    </div>                
                                  </td>
                                </tr>
						      </th:block>
                            </table>
                        </div>

                        <div class="qna-button">
                            <button type="button" onclick="fn_insertPst()" class="btn-large btn-color1"> 등록하기 </button>
                        </div>
                        
                    </fieldset>
                    
                </form>
            </article>
            
      <script src="/js/ckeditor/ckeditor.js"></script>
      <script th:inline="javascript">
      
	  var bbsInfo = /*[[${bbsInfo}]]*/null;
	  var insertPstUrl = "/front/bbs/"+bbsInfo.bbsid+"/insert.do"
	  var goBbsMainUrl = "/front/bbs/"+bbsInfo.bbsid+"/main.html"
	  
	  var atchfileCnt = bbsInfo.atchfileCnt ;
	  var atchfileSize = bbsInfo.atchfileSize;
      var editor ;
	  var uploadFileCnt = 0 ;
	    
      $(function(){
    	  
      	if($("#atchfileCnt").val()!= null && $("#atchfileCnt").val() != 0 ){atchfileCnt = $("#atchfileCnt").val() }
		    if($("#atchfileSize").val()!= null && $("#atchfileSize").val() != 0 ){atchfileSize = $("#atchfileSize").val() }
      	
  		//editor = CKEDITOR.replace('cntnts');
  		//에디터 엔터키 두줄 바꿈 제거 (shift + enter 처럼 바로 한줄 밑으로 떨어지게 함 ) 
		    editor = CKEDITOR.replace('cntnts', {enterMode: CKEDITOR.ENTER_BR});
	        validate();
	        
	    	$('#multiFileInput').on("change", function(event) {
	    		
		        var objFile = document.querySelector('#multiFileInput');
		        var formData = new FormData();
		        var content = "";
		        
			    for( i = 0 ; i < objFile.files.length ; i++) {
	    		
			    	   if(objFile.files[i].size > (atchfileSize*1024*1024)){
			    		   alert( atchfileSize + "MG 초과하는 파일은 업로드 하실수 없습니다.  : "+objFile.files[i].name ); 
			    	   }else if(uploadFileCnt +objFile.files.length > atchfileCnt){
			    		   alert("첨부파일은  "+atchfileCnt+ " 개 까지 가능합니다." ); break;
			    	   }else{
			    		   formData.append("files", objFile.files[i]);
			    		   uploadFileCnt++;
			    	   }
			    }
			    
		        formData.append("filegrpid", $("#filegrpid").val());
		        formData.append("filegrpNm", "bbs");
                formData.append("bbsid", bbsInfo.bbsid);
		        
		        if(uploadFileCnt >0 ){
		 		    $.ajax({
						url : '/uploadMultipleFiles.do',
						processData : false,
						contentType : false,
						data : formData,
						type : 'POST',
						success : function(response) {
							if($("#filegrpid").val()=='0' || $("#filegrpid").val()==''  || $("#filegrpid").val()==null){
								$("#filegrpid").val( response[0].filegrpid );
							}
							
							for(i = 0 ;i < response.length; i++ ){
								content = "<div class ='' id='inputFiles"+response[i].fileid+"'>"+response[i].orginlFileNm ;
						        content +="&nbsp;&nbsp;<input type='button'  class = 'btn btn-xs btn-danger' onclick = fn_deleteFileList('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"') value='X'/></div>";
						        $('#multipleFileUploadSuccess').append(content);
							}
						}
					})
		           if (detectBrowser() == "other") { 
					   $("#multiFileInput").val("");
				   } else {   
					  $("#multiFileInput").replaceWith( $("#multiFileInput").clone(true)) 
				   }
		        }
		});

     })
     
     
   function fn_deleteFileList(fileid, fileIdntfcKey){
    	  
       if(!confirm("파일을 삭제하시겠습니까?")){return;}
	   fn_deleteFile(fileid, fileIdntfcKey);
       $("#inputFiles"+fileid).remove();
       
   }   
     
   function fn_deleteFile(fileid, fileIdntfcKey){
	 	   
	 var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey; 
	 
		 $.ajax({
			url : deleteFileUrl,
			type: 'GET',
			cache : false,
			dataType: 'json',
			success : function (data){
				if(data.result=="success"){
					$("#"+fileid).remove();
					console.log("uploadFileCnt--->"+uploadFileCnt);
					if(uploadFileCnt > 0){
						uploadFileCnt = uploadFileCnt-1;	
					}
					alert("파일삭제가 완료 되었습니다.");
				}else{
					alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
				}
			},
		 	error : function (error){
			} 
	      })
   };
     
     
    function validate(){
    	
       $("#pstInsertForm").validate({
     	    ignore: [],
		    rules: {  
		    	  title       : { required: true , maxlength:200  }
   	              ,cntnts      : { required: true , maxlength:4000}
   	              ,bbs_clid    : { required: true }
		    },
		    messages: {  
		    	  title       : { required: "게시판명을 입력해 주십시오."  , maxlength : "게시판 제목은 200자를 넘을 수 없습니다."  }
		         ,cntnts      : { required: "게시글 내용을 입력해 주십시오." , maxlength: "게시판 내용은 4000자를 넘을 수 없습니다." }
		         ,bbs_clid    : { required:"게시글 분류를 선택해주십시오 "}
		    }
		 });
       
     }

	 function fn_insertPst(){
		 
	 	    var editorData = editor.getData();
	 	    
	 	    $("#cntnts").val(editorData);
	 	    
	 	    if($("#pstInsertForm").valid() == false) return;
	 	    
	 	    if(!confirm("저장하시겠습니까?")) return;
	 	    
	        var data =  $("#pstInsertForm").serialize() ;
	        
			$.ajax({
				url : insertPstUrl,
				type: 'POST',
				cache : false,
				dataType: 'json',
				data : data,
				success : function (data){
					if(data.result=="success"){
						alert("등록이 완료 되었습니다.");
						goBbsMain();			
					}else{
						alert("등록중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
					}
				},
			 	error : function (error){
				} 
			});
		}
	 
	function goBbsMain(){
		var f = document.forms.pstInsertForm ;
		f.action = goBbsMainUrl;
		f.submit();
	} 
	 

 </script>
 
 </div>

</body>
</html>