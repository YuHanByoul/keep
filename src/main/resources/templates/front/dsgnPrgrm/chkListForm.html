<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
    layout:decorator="layout/front/nolnbSubLayout" >
<body>
    <div layout:fragment="content">
    <form id="chkListForm" name="chkListForm" th:action="@{/front/dsgnPrgrm/aplyCmptnForm.html}" method="post">
        <input type="hidden"  id="prgrmid" name="prgrmid" th:value="${chkListInfo.prgrmid}" />
        <input type="hidden"  id="sbmsnid" name="sbmsnid" th:value="${chkListInfo.sbmsnid}" />
        <input type="hidden"  id="chklstid" name="chklstid" th:value="${chkListInfo.chklstid}" />
        <input type="hidden"  id="operFrmCd" name="operFrmCd" th:value="${chkListInfo.operFrmCd}" />
        <input type="hidden"  id="opner" name="opner" th:value="${opner==null ?'':opner}" />

        <!-- content -->
        <div class="steps" id="steps" th:if="${opner!='myPage'}">
            <ol>
                <li>
                    <div class="steps-inner">
                        <span>01</span>
                        <strong>약관동의</strong>
                    </div>
                </li>
                <li>
                    <div class="steps-inner">
                        <span>02</span>
                        <strong>신청정보 확인 및 <br class="pc-only"> 증빙자료 등록</strong>
                    </div>
                </li>
                <li class="active" title="현재 단계" aria-current="step">
                    <div class="steps-inner">
                        <span>03</span>
                        <strong>프로그램 정보 작성</strong>
                    </div>
                </li>
                <li>
                    <div class="steps-inner">
                        <span>04</span>
                        <strong>신청완료</strong>
                    </div>
                </li>
            </ol>
        </div>


        <div class="row row-section">
            <div class="col col-small">
                <div class="sticky-navigation">
                    <strong class="tit">프로그램 정보 항목</strong>
                    <div class="sticky-steps">
                        <ul>
<!--                             <li><a th:href="@{/front/dsgnPrgrm/prgrmDstnctnForm.html?prgrmid=}+${chkListInfo.prgrmid}" >프로그램 우수성</a></li> -->
<!--                             <li><a th:href="@{/front/dsgnPrgrm/prgrmOperMngForm.html?prgrmid=}+${chkListInfo.prgrmid}" >프로그램 운영관리</a></li> -->
<!--                             <li><a th:href="@{/front/dsgnPrgrm/prgrmEvlForm.html?prgrmid=}+${chkListInfo.prgrmid}" >프로그램 평가</a></li> -->
<!--                             <li><a th:href="@{/front/dsgnPrgrm/ldrQlfcForm.html?prgrmid=}+${chkListInfo.prgrmid}" >지도자의 자격 및 배치</a></li> -->
<!--                             <li><a th:href="@{/front/dsgnPrgrm/sftyMngForm.html?prgrmid=}+${chkListInfo.prgrmid}" >안전관리</a></li> -->
<!--                             <li class="active"><a th:href="@{/front/dsgnPrgrm/chkListForm.html?prgrmid=}+${chkListInfo.prgrmid}" >체크리스트</a></li> -->
                                <li >              <a>프로그램 우수성</a></li>
                                <li>               <a>프로그램 운영관리</a></li>
                                <li>               <a>프로그램 평가</a></li>
                                <li>               <a>지도자의 자격 및 배치</a></li>
                                <li>               <a>안전관리</a></li>
                                <li class="active"><a>체크리스트</a></li>
                        </ul>
                        <div class="btn-wrap">
                            <div class="center">
                                <button type="button" class="btn-large btn-gray"  onclick="doSave()">중간저장</button>
                                <button type="button" class="btn-large btn-green" onclick="goNext()">다음</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="checkList" class="col col-wide">

                <div class="mo-only">
                    <div class="btn-wrap">
                        <div class="center">
                            <button type="button" class="btn-medium btn-gray">중간저장</button>
                        </div>
                    </div>
                    <div class="btn-wrap">
                        <div class="center">
                            <button type="button" class="btn-medium btn-gray">이전</button>
                            <button type="button" class="btn-medium btn-green">다음</button>
                        </div>
                    </div>
                </div>


            </div>
        </div>
        </form>
        <!-- //content -->
        <script th:inline="javascript">
        var insertUrl = "/front/dsgnPrgrm/insertChkListForm.do";
        var updateUrl = "/front/dsgnPrgrm/updateChkListForm.do";

        var qitemList = /*[[${qitemList}]]*/null;
        var ansList = /*[[${ansList}]]*/null;

        function setChkList(){
            var list = qitemList;
            var html = "";
            var idx  = 1;
            var ordr = 1;

            for(var row of list){

                if(row.lv=="1"){

                	html += `
                        <div class="table-caption mt0">
                            <div class="left">
                                <h3 class="sub-title">${row.cn}</h3>
                            </div>
                            <div class="right">
                                <p id="sum${row.dp1}">총점 <b class="fc-blue" >17</b> 건/ 17점</p>
                            </div>
                         </div>
                    `
                }
        	    if(row.lv=="2"){
        	    	if(idx!=1){
            	    	html += `
                	    	</tbody>
                            </table>
                        </div>
                        `
        	    	}

        	    	html += `
                        <div class="table-caption">
                            <div class="left">
                                <h4 class="dot-title">${row.cn}</h4>
                            </div>
                        </div>

                        <div class="table-col table-layout-auto  table-col-scroll">
                            <table>
                                <caption>${row.cn} - 번호, 내용, 배점, 예, 아니오</caption>
                                <colgroup>
                                    <col style="width:6%;">
                                    <col>
                                    <col style="width:85px;">
                                    <col style="width:75px;">
                                    <col style="width:75px;">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th scope="col">번호</th>
                                        <th scope="col">내용</th>
                                        <th scope="col">배점</th>
                                        <th scope="col">예</th>
                                        <th scope="col">아니오</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `
                    idx=1;
        	    }

        	    if(row.lv=="3"){
                    html += `
                    	<tr class="tr-survey" id="qiteRow">
        	                <td>${row.qrow}</td>
        	                <td class="al">${row.cn}</td>
        	                <td>${row.altm}</td>
        	                <td><label class="inp"><input type="radio" title="예"     id="chkRdo${row.qitemid}" lv1="${row.dp1}" altm="${row.altm}" name="chkRdo${row.qitemid}" value="Y" qitemid="${row.qitemid}" ordr="${ordr}"></label></td>
        	                <td><label class="inp"><input type="radio" title="아니오" id="chkRdo${row.qitemid}" lv1="${row.dp1}" altm="${row.altm}" name="chkRdo${row.qitemid}" ></label></td>
        	            </tr>
                    `
                    idx++;
                    ordr++;
                }
            }

            $("#checkList").append(html);
        }

        function setAnsList(){

        	var list = ansList;
        	if(list != null){
        		for(var row of list){
        			var scr = row?.scr?? 0
        			if(scr > 0 ){
        				$("input[qitemid="+row.qitemid+"]").prop("checked",true);
        			}
        		}
        	}
        }

        function validate(){

            $("#chkListForm").validate({
                ignore: [],
                rules: {
                    title       : { required: true , maxlength:200  }
                    ,cntnts      : { required: true , maxlength:4000}
                    ,bbs_clid    : { required: true }
                 },
                 messages: {
                    title       : { required: "게시판명을 입력해 주십시오."  , maxlength : "게시판 제목은 200자를 넘을 수 없습니다."  }
                    ,cntnts      : { required: "게시글 내용을 입력해 주십시오." , maxlength: "게시판 내용은 4000자를 넘을 수 없습니다." }
                    ,bbs_clid    : { required:"게시글 분류를 선택해주십시오 "}
                 }
            });

        }

        function goPrev(){
            document.dstnctnForm.action = "/front/dsgnPrgrm/evlForm.html";    //평가
            $("#chkListForm").submit();
        }

        function goNext(){
            if($("#chkListForm").valid() == false) return;
            doSave();

        }

        function doSave(){

        	var param = {};
        	var list = qitemList;
        	var index = 0;

        	for(var row of list){
        		if(row.lv=="3"){
            		param["ansLst[" + index + "].seCd"] = row.dp2;
            		param["ansLst[" + index + "].qitemid"] = row.qitemid;
            		param["ansLst[" + index + "].cn"] = row.cn;
            		param["ansLst[" + index + "].scr"] = $("input[qitemid="+row.qitemid+"]:checked").val() =="Y" ? row.altm : 0;
            		param["ansLst[" + index + "].ordr"] = $("input[qitemid="+row.qitemid+"]").attr("ordr");
            		index++;
        		}
        	}

        	param["prgrmid"] = $("#prgrmid").val();;
            param["sbmsnid"] = $("#sbmsnid").val();
            param["chklstid"] = $("#chklstid").val();
            param["sbmsnSeCd"] = "N";    /*신청자 자가진단*/

            if(!confirm("저장하시겠습니까?")) return;

            $.ajax({
                url : "/front/dsgnPrgrm/insertChkList.do",
                type: 'POST',
                cache : false,
                dataType: 'json',
                data : param,
                success : function (data){
                    if(data.result=="success"){
                        alert("등록이 완료 되었습니다.");
                        document.chkListForm.action = "/front/dsgnPrgrm/aplyCmptnForm.html";    //신청완료
                        $("#chkListForm").submit();
                    }else{
                        alert("등록중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                    }
                },
                error : function (error){
                }
            });


        }

        function validate(){

            $("#ldrQlfcForm").validate({
                ignore: [],
                rules: {
                    bgngDe    : { maxlength:10  } /** 시작 일자 */
                  , endDe     : { maxlength:00  }/** 종료 일자 */
                  , schlNm    : { maxlength:30  } /** 학교 이름 */
                  , mjr       : { maxlength:30  }/** 전공 */
                  , dgr       : { maxlength:30  }/** 학위 */
                  , nm        : { maxlength:30  }
                  , brdt      : { maxlength:10  }
                  , qlfcNm    : { maxlength:50  } /** 자격 명*/
                  , grd       : { maxlength:30  } /** 급수 */
                  , acqsDe    : { maxlength:10  } /** 취득일자 */
                  , wrkplc    : { maxlength:30  } /** 발령청*/
                  , actvtNm   : { maxlength:30  } /** 활동명 */
                  , actvtType : { maxlength:30  } /** 활동 유형 */
                 },
                 messages: {
                    bgngDe    : { maxlength : "시작 일자는 10자를 넘을 수 없습니다." }/** 시작 일자 */
                  , endDe     : { maxlength : "종료 일자는 10자를 넘을 수 없습니다." }/** 종료 일자 */
                  , schlNm    : { maxlength : "학교 이름은 30자를 넘을 수 없습니다." }/** 학교 이름 */
                  , mjr       : { maxlength : "전공운 30자를 넘을 수 없습니다." }/** 전공 */
                  , dgr       : { maxlength : "학위는 30자를 넘을 수 없습니다." }/** 학위 */
                  , nm        : { maxlength : "성명은 30자를 넘을 수 없습니다." }
                  , brdt      : { maxlength : "생년월일은 10자를 넘을 수 없습니다." }
                  , qlfcNm    : { maxlength : "자격 명 은 50자를 넘을 수 없습니다." }/** 자격 명*/
                  , grd       : { maxlength : "급수는 30자를 넘을 수 없습니다." }/** 급수 */
                  , acqsDe    : { maxlength : "취득일자 는 10자를 넘을 수 없습니다." }/** 취득일자 */
                  , wrkplc    : { maxlength : "발령처는 30자를 넘을 수 없습니다." }/** 발령청*/
                  , actvtNm   : { maxlength : "활동명은 30자를 넘을 수 없습니다." }/** 활동명 */
                  , actvtType : { maxlength : "활동 유형은 30자를 넘을 수 없습니다." }/** 활동 유형 */
                 }
            });

        }

        $(function() {

            setChkList();
            setAnsList();
            validate();

            $("#chkListForm [name^=chkRdo]").on("change",function(e){

            	var id = $("#"+this.id).attr("qitemid");
            	var lv1 = $("#"+this.id).attr("lv1");
            	var sumScr = 0 ;
            	var cnt = $("#chkListForm [lv1^="+lv1+"]").length;

            	$("#chkListForm [lv1^="+lv1+"]:checked").each(function(index,item){
            		sumScr += item.value =='Y' ? Number(item.attributes.altm.value) : 0
            	});

            	$('#sum'+lv1).get(0).innerHTML = `총점 <b class="fc-blue" >${cnt}</b> 건/ ${sumScr}점</p>`;

            });

            $("#chkListForm [name^=chkRdo]").trigger('change');


        });

        </script>
    </div>

</body>
</html>
