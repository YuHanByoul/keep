<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
    layout:decorator="layout/front/nolnbSubLayout" >
<body>
    <div layout:fragment="content">
    <form id="chkListForm" name="chkListForm" th:action="@{/front/dsgnPrgrm/aplyCmptnForm.html}" method="post">
        <input type="hidden"  id="loginUserid" name="loginUserid" th:value="${loginUserid}" />
        <input type="hidden"  id="prgrmid" name="prgrmid" th:value="${chkListInfo.prgrmid}" />
        <input type="hidden"  id="sbmsnid" name="sbmsnid" th:value="${chkListInfo.sbmsnid}" />
        <input type="hidden"  id="sttsCd" name="sttsCd" th:value="${chkListInfo.sttsCd}" />
        <input type="hidden"  id="chklstid" name="chklstid" th:value="${chkListInfo.chklstid}" />
        <input type="hidden"  id="operFrmCd" name="operFrmCd" th:value="${chkListInfo.operFrmCd}" />
        <input type="hidden"  id="opner" name="opner" th:value="${opner==null ?'':opner}" />
        <input type="hidden"  id="allSum" name="allSum" value="0" /><!-- 총점 -->

        <!-- content -->
        <div class="steps" id="steps" th:if="${opner!='myPage'}">
            <ol>
                <li>
                    <div class="steps-inner">
                        <span>01</span>
                        <strong>약관동의</strong>
                    </div>
                </li>
                <li>
                    <div class="steps-inner">
                        <span>02</span>
                        <strong>신청정보 확인 및 <br class="pc-only"> 증빙자료 등록</strong>
                    </div>
                </li>
                <li class="active" title="현재 단계" aria-current="step">
                    <div class="steps-inner">
                        <span>03</span>
                        <strong>프로그램 정보 작성</strong>
                    </div>
                </li>
                <li>
                    <div class="steps-inner">
                        <span>04</span>
                        <strong>신청완료</strong>
                    </div>
                </li>
            </ol>
        </div>


        <div class="row row-section">
            <div class="col col-small">
                <div class="sticky-navigation">
                    <strong class="tit">프로그램 정보 항목</strong>
                    <div class="sticky-steps">
                        <ul>
<!--                             <li><a th:href="@{/front/dsgnPrgrm/prgrmDstnctnForm.html?prgrmid=}+${chkListInfo.prgrmid}" >프로그램 우수성</a></li> -->
<!--                             <li><a th:href="@{/front/dsgnPrgrm/prgrmOperMngForm.html?prgrmid=}+${chkListInfo.prgrmid}" >프로그램 운영관리</a></li> -->
<!--                             <li><a th:href="@{/front/dsgnPrgrm/prgrmEvlForm.html?prgrmid=}+${chkListInfo.prgrmid}" >프로그램 평가</a></li> -->
<!--                             <li><a th:href="@{/front/dsgnPrgrm/ldrQlfcForm.html?prgrmid=}+${chkListInfo.prgrmid}" >지도자의 자격 및 배치</a></li> -->
<!--                             <li><a th:href="@{/front/dsgnPrgrm/sftyMngForm.html?prgrmid=}+${chkListInfo.prgrmid}" >안전관리</a></li> -->
<!--                             <li class="active"><a th:href="@{/front/dsgnPrgrm/chkListForm.html?prgrmid=}+${chkListInfo.prgrmid}" >체크리스트</a></li> -->
                                <li >              <a>프로그램 우수성</a></li>
                                <li>               <a>프로그램 운영관리</a></li>
                                <li>               <a>프로그램 평가</a></li>
                                <li>               <a>지도자의 자격 및 배치</a></li>
                                <li>               <a>안전관리</a></li>
                                <li class="active"><a>체크리스트</a></li>
                        </ul>
                        <div class="btn-wrap">
                            <div class="center">
                                <button type="button" class="btn-large btn-gray"  onclick="doSave()">중간저장</button>
                                <button type="button" class="btn-large btn-green" onclick="goNext()">다음</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="checkList" class="col col-wide">

                <div class="mo-only">
                    <div class="btn-wrap">
                        <div class="center">
                            <button type="button" class="btn-medium btn-gray">중간저장</button>
                        </div>
                    </div>
                    <div class="btn-wrap">
                        <div class="center">
                            <button type="button" class="btn-medium btn-gray">이전</button>
                            <button type="button" class="btn-medium btn-green">다음</button>
                        </div>
                    </div>
                </div>


            </div>
        </div>
        </form>
        <!-- //content -->
        <script th:inline="javascript">
        var insertUrl = "/front/dsgnPrgrm/insertChkListForm.do";
        var updateUrl = "/front/dsgnPrgrm/updateChkListForm.do";
        var nextUrl = "/front/dsgnPrgrm/aplyCmptnForm.html";
        var prevUrl = "/front/dsgnPrgrm/sftyMngForm.html";      //안전관리
        var reUrl = "/front/dsgnPrgrm/chkListForm.html";
        /*<![CDATA[*/
        var qitemList = /*[[${qitemList}]]*/null;
        /*]]>*/

        var ansList = /*[[${ansList}]]*/null;

        function setChkList(){
            var list = qitemList;
            var html = "";
            var idx  = 1;
            var ordr = 1;
//             if(list !=null){

//                 list.sort((a, b) => {
//                     return a["rnum"] - b["rnum"] || Object.keys(a).filter(key => key !== field)
//                       .find(key => a[key] !== b[key]) && (a[key] < b[key] ? -1 : 1) || 0;
//                 });
//             }

            for(var row of list){

                if(row.lv=="1"){
                	html += `
                        <div class="table-caption mt0">
                            <div class="left">
                                <h3 class="sub-title">${row.cn}</h3>
                            </div>
                            <div class="right">
                                <p id="sum${row.dp1}">총점 <b class="fc-blue" >0</b> / 0점</p>
                            </div>
                         </div>
                    `
                }
        	    if(row.lv=="2"){
        	    	if(idx!=1){
            	    	html += `
                	    	</tbody>
                            </table>
                        </div>
                        `
        	    	}

        	    	html += `
                        <div class="table-caption">
                            <div class="left">
                                <h4 class="dot-title">${row.cn}</h4>
                            </div>
                        </div>

                        <div class="table-col table-layout-auto  table-col-scroll">
                            <table>
                                <caption>${row.cn} - 번호, 내용, 배점, 예, 아니오</caption>
                                <colgroup>
                                    <col style="width:6%;">
                                    <col>
                                    <col style="width:85px;">
                                    <col style="width:75px;">
                                    <col style="width:75px;">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th scope="col">번호</th>
                                        <th scope="col">내용</th>
                                        <th scope="col">배점</th>
                                        <th scope="col">예</th>
                                        <th scope="col">아니오</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `
                    idx=1;
        	    }

        	    if(row.lv=="3"){
                    html += `
                    	<tr class="tr-survey" id="qiteRow">
        	                <td>${row.qrow}</td>
        	                <td class="al">${row.cn}</td>
        	                <td>${row.altm}</td>
        	                <td><label class="inp"><input type="radio" title="예"     id="chkRdo${row.qitemid}" lv1="${row.dp1}" altm="${row.altm}" name="chkRdo${row.qitemid}" value="Y" qitemidY="${row.qitemid}" ordr="${ordr}"></label></td>
        	                <td><label class="inp"><input type="radio" title="아니오" id="chkRdo${row.qitemid}" lv1="${row.dp1}" altm="${row.altm}" name="chkRdo${row.qitemid}" qitemidN="${row.qitemid}"></label></td>
        	            </tr>
                    `
                    idx++;
                    ordr++;
                }
            }

            $("#checkList").append(html);
        }

        function setAnsList(){

        	var list = ansList;
        	if(list != null){
        		for(var row of list){
        			var scr = row?.scr?? 0
        			if(scr > 0 ){
        				$("input[qitemidY="+row.qitemid+"]").prop("checked",true);
        			}else{
        				$("input[qitemidN="+row.qitemid+"]").prop("checked",true);
        			}
        		}
        	}
        }

        function goPrev(){
            document.dstnctnForm.action = "/front/dsgnPrgrm/evlForm.html";    //평가
            $("#chkListForm").submit();
        }

        function goNext(){
            if($("#chkListForm").valid() == false) return;
            doSave("next");
        }

        function doSave(call){

        	var param = {};
        	var list = qitemList;
        	var index = 0;

        	for(var row of list){
        		if(row.lv=="3"){
            		param["ansLst[" + index + "].seCd"] = row.dp2;
            		param["ansLst[" + index + "].qitemid"] = row.qitemid;
            		param["ansLst[" + index + "].cn"] = row.cn;
            		param["ansLst[" + index + "].scr"] = $("input[qitemidY="+row.qitemid+"]:checked").val() =="Y" ? row.altm : 0;
            		param["ansLst[" + index + "].ordr"] = $("input[qitemidY="+row.qitemid+"]").attr("ordr");
            		index++;
        		}
        	}

        	param["prgrmid"] = $("#prgrmid").val();;
            param["sbmsnid"] = $("#sbmsnid").val();
            param["chklstid"] = $("#chklstid").val();
            param["sbmsnSeCd"] = "242101";    /*신청자 자가진단*/
            param["sprtgrpid"] = $("#loginUserid").val();     /*심사자id :신청자 자가진단*/
            param["sttsCd"] = "111102";    /*상태코드 신청완료*/

            if(!confirm("저장하시겠습니까?")) return;

            $.ajax({
                url : "/front/dsgnPrgrm/insertChkList.do",
                type: 'POST',
                cache : false,
                dataType: 'json',
                data : param,
                success : function (data){
                    if(data.result=="success"){
                        alert("등록이 완료 되었습니다.");
                        if(call=="next"){
                            location.href = nextUrl+"?prgrmid=" + $("#prgrmid").val()+"&opner="+$("#opner").val();
                    	}else{
                    		location.href = reUrl+"?prgrmid=" + $("#prgrmid").val()+"&opner="+$("#opner").val();
                    	}
                    }else{
                        alert("등록중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                    }
                },
                error : function (error){
                }
            });
        }

        $(function() {

            setChkList();
            setAnsList();

            $("#chkListForm [name^=chkRdo]").on("change",function(e){

            	var id = $("#"+this.id).attr("qitemidY");
            	var lv1 = $("#"+this.id).attr("lv1");
            	var sumScr = 0 ;
            	var sumAltm = 0 ;
            	var allSum=0;
            	var cnt = $("#chkListForm [lv1^="+lv1+"]").length;

            	$("#chkListForm [lv1^="+lv1+"]").each(function(index,item){
            		sumAltm += item.value =='Y' ? Number(item.attributes.altm.value) : 0
            	});
            	$("#chkListForm [lv1^="+lv1+"]:checked").each(function(index,item){
            		sumScr += item.value =='Y' ? Number(item.attributes.altm.value) : 0
            		allSum +=sumScr;
            	});

            	$('#sum'+lv1).get(0).innerHTML = `총점 <b class="fc-blue" >${sumScr}</b> / ${sumAltm}점</p>`;

            	//$("#allSum").val()

            });

            $("#chkListForm [name^=chkRdo]").trigger('change');


        });

        </script>
    </div>

</body>
</html>
