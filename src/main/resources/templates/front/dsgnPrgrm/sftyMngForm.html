<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
    layout:decorator="layout/front/nolnbSubLayout" >
<body>
    <div layout:fragment="content">
    <form id="sftyMngForm" name="sftyMngForm" th:action="@{/front/dsgnPrgrm/chkListForm.html}" method="post">
        <input type="hidden" id="prgrmid" name="prgrmid" th:value="${aplyInfo.prgrmid}">
        <input type="hidden" id="sbmsnid" name="sbmsnid" th:value="${aplyInfo.sbmsnid}">
        <input type="hidden" id="sbmsnSeCd" name="sbmsnSeCd" th:value="242101">    <!-- 제출 구분 코드 : 신청자자가진단 -->
        <input type="hidden" id="sprtgrpid" name="sprtgrpid" th:value="${loginUserid}"><!-- 심사자 : loginUser-->
        <input type="hidden" id="sftyMngId" name="sftyMngId" th:value="${aplyInfo.sftyMngId}">
        <input type="hidden" id="opner" name="opner" th:value="${opner==null ?'':opner}" />

        <!-- content -->
        <div class="steps" id="steps" th:if="${opner!='myPage'}">
            <ol>
                <li>
                    <div class="steps-inner">
                        <span>01</span>
                        <strong>약관동의</strong>
                    </div>
                </li>
                <li>
                    <div class="steps-inner">
                        <span>02</span>
                        <strong>신청정보 확인 및 <br class="pc-only"> 증빙자료 등록</strong>
                    </div>
                </li>
                <li class="active" title="현재 단계" aria-current="step">
                    <div class="steps-inner">
                        <span>03</span>
                        <strong>프로그램 정보 작성</strong>
                    </div>
                </li>
                <li>
                    <div class="steps-inner">
                        <span>04</span>
                        <strong>신청완료</strong>
                    </div>
                </li>
            </ol>
        </div>


        <div class="row row-section">
            <div class="col col-small">
                <div class="sticky-navigation">
                    <strong class="tit">프로그램 정보 항목</strong>
                    <div class="sticky-steps">
                        <ul>
<!--                             <li><a th:href="@{/front/dsgnPrgrm/prgrmDstnctnForm.html?prgrmid=}+${aplyInfo.prgrmid}" >프로그램 우수성</a></li> -->
<!--                             <li><a th:href="@{/front/dsgnPrgrm/prgrmOperMngForm.html?prgrmid=}+${aplyInfo.prgrmid}" >프로그램 운영관리</a></li> -->
<!--                             <li><a th:href="@{/front/dsgnPrgrm/prgrmEvlForm.html?prgrmid=}+${aplyInfo.prgrmid}" >프로그램 평가</a></li> -->
<!--                             <li><a th:href="@{/front/dsgnPrgrm/ldrQlfcForm.html?prgrmid=}+${aplyInfo.prgrmid}" >지도자의 자격 및 배치</a></li> -->
<!--                             <li class="active"><a th:href="@{/front/dsgnPrgrm/sftyMngForm.html?prgrmid=}+${aplyInfo.prgrmid}" >안전관리</a></li> -->
<!--                             <li><a th:href="@{/front/dsgnPrgrm/chkListForm.html?prgrmid=}+${aplyInfo.prgrmid}" >체크리스트</a></li> -->
                                <li >              <a>프로그램 우수성</a></li>
                                <li>               <a>프로그램 운영관리</a></li>
                                <li>               <a>프로그램 평가</a></li>
                                <li>               <a>지도자의 자격 및 배치</a></li>
                                <li class="active"><a>안전관리</a></li>
                                <li>               <a>체크리스트</a></li>
                            </ul>
                        <div class="btn-wrap">
                            <div class="center">
                                <button type="button" class="btn-large btn-gray" onclick="doSave()">중간저장</button>
                                <button type="button" class="btn-medium btn-green" onclick="goNext()">다음</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col col-wide">

                <div class="table-caption mt0">
                    <div class="left">
                        <h3 class="sub-title">안전관리 메뉴얼</h3>
                    </div>
                </div>

                <div class="table-row table-row-mo">
                    <table>
                        <caption>안전관리 메뉴얼 - 첨부파일</caption>
                        <colgroup>
                            <col style="width:140px">
                            <col>
                        </colgroup>
                        <tbody>
                            <tr>
                                <th scope="col">첨부파일<span class="ast">*</span></th>
                                <td id="fileTr">
                                    <div class="form-input-file">

                                        <label class="form-input">
                                            <input id="multiFileInput1" name="files" type="file" multiple class="blind" title="파일첨부" maxcount="5" style="display: none;" th:attr="accept=${acceptUploadFileExt}">
                                            <span class="btn-medium btn-gray">파일선택</span>
                                        </label>
                                        <ul id="multipleFileUploadSuccess1">
                                            <th:block th:if="${fileList ne null}" th:each="file : ${fileList}">
                                                <li class="file-block" th:data_ext="${#strings.substring(file.fileExtsn,1)}" th:id="${file.fileid}">
                                                <span class="name">
                                                    <a href="javascript:void(0)" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                                                       th:onclick="|javascript:downloadFileByFileid(this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'))|">
                                                        [[${file.orginlFileNm}]]
                                                    </a>
                                                </span>
                                                    <button type="button" class="file-delete" title="삭제" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                                                            th:onclick="|javascript:fn_deleteFileList(this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'))|">
                                                        <span class="icon icon-circle-close"></span>
                                                    </button>
                                                </li>
                                            </th:block>
                                        </ul>
                                        <input type="hidden" id="filegrpid" name="filegrpid" th:value="${(aplyInfo.filegrpid == '' or aplyInfo.filegrpid == null) ? 0 : aplyInfo.filegrpid}"/>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="table-caption">
                    <div class="left">
                        <h3 class="sub-title">안전교육</h3>
                        <h4 class="dot-title">프로그램 지도자 대상 교육</h4>
                    </div>
                </div>

                <div class="table-row table-row-mo">
                    <table>
                        <caption>안전교육(프로그램 지도자 대상 교육) - 교육시기, 담당자, 교육내용 개요</caption>
                        <colgroup>
                            <col style="width:140px">
                            <col>
                        </colgroup>
                        <tbody>
                            <tr>
                                <th scope="col">교육시기</th>
                                <td>
                                    <input type="text" title="교육시기" id="ldrEduSess" name="ldrEduSess" th:value="${aplyInfo.ldrEduSess}" emode="mod" />
                                </td>
                            </tr>
                            <tr>
                                <th scope="col">담당자</th>
                                <td>
                                    <input type="text" title="담당자" name="ldrEduPic" id="ldrEduPic" th:value="${aplyInfo.ldrEduPic}" emode="mod" />
                                </td>
                            </tr>
                            <tr>
                                <th scope="col">교육내용 개요</th>
                                <td>
                                    <textarea maxlength="200" title="교육내용 개요" id="prtcpntEduCn" name="prtcpntEduCn" emode="mod" ><th:block th:text="${aplyInfo.prtcpntEduCn}"></th:block></textarea>
                                    <div class="desc ar size"><span>0</span> / 200자</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="table-caption">
                    <div class="left">
                        <h4 class="dot-title">프로그램 참가자 대상 교육</h4>
                    </div>
                </div>

                <div class="table-row table-row-mo">
                    <table>
                        <caption>프로그램 참가자 대상 교육 - 교육시기, 담당자, 교육내용 개요</caption>
                        <colgroup>
                            <col style="width:140px">
                            <col>
                        </colgroup>
                        <tbody>
                            <tr>
                                <th scope="col">교육시기</th>
                                <td>
                                    <input type="text" title="구분" id="prtcpntEduSess" name="prtcpntEduSess" th:value="${aplyInfo.prtcpntEduSess}" emode="mod" />
                                </td>
                            </tr>
                            <tr>
                                <th scope="col">담당자</th>
                                <td>
                                    <input type="text" title="담당자" name="prtcpntEduPic" id="prtcpntEduPic" th:value="${aplyInfo.prtcpntEduPic}" emode="mod" />
                                </td>
                            </tr>
                            <tr>
                                <th scope="col">교육내용 개요</th>
                                <td>
                                    <textarea maxlength="200" title="교육내용 개요" id="ldrEduCn" name="ldrEduCn" emode="mod" ><th:block th:text="${aplyInfo.ldrEduCn}"></th:block></textarea>
                                    <div class="desc ar size"><span>0</span> / 200자</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>


                <div class="table-caption">
                    <div class="left">
                        <h4 class="dot-title">안전관리 사전인증</h4>
                    </div>
                </div>

                <div class="table-row table-row-mo">
                    <table>
                        <caption>안전관리 사전인증 - 인증여부, 첨부파일</caption>
                        <colgroup>
                            <col style="width:140px;">
                            <col>
                        </colgroup>
                        <tbody>
                            <tr>
                                <th scope="col">인증여부</th>
                                <td>
                                    <span kattr:radio_yn="bfrCertYn" label1="예" label2="아니오" th:attr="defaultVal=${aplyInfo.bfrCertYn == null ? 'N':aplyInfo.bfrCertYn}" addStyle="margin-top:4px" addClass="col-sm-3" />
                                    <p class="desc">‘예’ 선택  :  체크리스트 자동 만점 처리  /  ‘아니오’ 선택 :  체크리스트를 직접 체크</p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="col">첨부파일</th>
                                <td>
                                    <div class="form-input-file" >
                                        <label class="form-input" readonly="readonly" >
                                            <input id="multiFileInput2" name="files" type="file" multiple class="blind" title="파일첨부" maxcount="10" style="display: none;" th:attr="accept=${acceptUploadFileExt}" >
                                            <span class="btn-medium btn-gray" id="bfrCertYnSpan">파일선택</span>
                                        </label>
                                        <ul id="multipleFileUploadSuccess2">
                                        <th:block th:if="${bfrCertFileList != null}">
                                            <th:block th:each="file : ${bfrCertFileList}">
                                                <li class="file-block" th:data_ext="${#strings.substring(file.fileExtsn,1)}" th:id="${file.fileid}">
                                                    <span class="name">
                                                        <a href="javascript:void(0)" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                                                           th:onclick="|javascript:downloadFileByFileid(this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'))|">
                                                            [[${file.orginlFileNm}]]
                                                        </a>
                                                    </span>
                                                    <button type="button" class="file-delete" title="삭제" th:name="${file.fileid}"
                                                            th:attr="data-file-idntfc-key=${file.fileIdntfcKey}, data-id=${file.fileid}"
                                                            th:onclick="deleteFile(this.name, this.dataset.fileIdntfcKey)">
                                                        <span class="icon icon-circle-close"></span>
                                                    </button>
                                                </li>
                                            </th:block>
                                        </th:block>
                                    </ul>
                                    <input type="hidden" id="bfrCertFilegrpid" name="bfrCertFilegrpid" th:value="${aplyInfo.bfrCertFilegrpid == null or aplyInfo.bfrCertFilegrpid == ''}? 0: ${aplyInfo.bfrCertFilegrpid}"/>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mo-only">
                    <div class="btn-wrap">
                        <div class="center">
                            <button type="button" class="btn-medium btn-gray" onclick="doSave()">중간저장</button>
                        </div>
                    </div>
                    <div class="btn-wrap">
                        <div class="center">
                            <button type="button" class="btn-medium btn-gray">이전</button>
                            <button type="button" class="btn-medium btn-green" onclick="goNext()">다음</button>>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!-- //content -->

        <script th:inline="javascript">
        var insertUrl = "/front/dsgnPrgrm/insertPrgrmSftyMngForm.do";
        var updateUrl = "/front/dsgnPrgrm/updatePrgrmSftyMngForm.do";
        var nextUrl = "/front/dsgnPrgrm/chkListForm.html";    //체크리스트
        var prevUrl = "/front/dsgnPrgrm/ldrQlfcForm.html";    //지도자 의 자격 및 배치
        var reUrl = "/front/dsgnPrgrm/sftyMngForm.html";      //안전관리

        var uploadFileCnt=0;

        function validate(){

            $("#sftyMngForm").validate({
                 ignore: [],
                 rules: {
                     filegrpid      : { required: true }
                 },
                 messages: {
                	 filegrpid : { required: "안전관리 메뉴얼 첨부파일을 입력해 주십시오."}
                 }
              });

          }

        function goPrev(){
            document.dstnctnForm.action = prevUrl
            $("#sftyMngForm").submit();
        }

        function goNext(){

            if(!$("#sftyMngForm").valid()) return false;

        	//첨부파일
            var fileCnt = $("#multipleFileUploadSuccess1 li").length;

            if(fileCnt==0){
                //$("[fileid]").length
                var msg="첨부파일을 입력해 주십시오";
                if (!$("#fileTr").find(".feedback.invalid").length) {
                    $("#fileTr").append(`<p class="feedback invalid">${msg}</p>`);
                }
                var offset = $("#multipleFileUploadSuccess1").offset();
                if($("#multipleFileUploadSuccess1").length>0)
                	{
                        $('html, body').animate({scrollTop : offset.top - 300}, 300);
                        $("#multipleFileUploadSuccess1").focus();
                	}
                return false;
            } else {
                $("#multipleFileUploadSuccess1").find(".feedback.invalid").remove();
            }

            doSave("next");
        }

        function doSave(call){

        	if(call!="next") if(!confirm("저장하시겠습니까?")) return;

            var data =  $("#sftyMngForm").serialize() ;

            $.ajax({
                url : insertUrl,
                type: 'POST',
                cache : false,
                dataType: 'json',
                data: data,
                success : function (data){
                    if(data.result=="success"){

                        if(call == "next") {
                                location.href = nextUrl+"?prgrmid=" + $("#prgrmid").val()+"&opner="+$("#opner").val();
                        }else{
                        	alert(data.msg);
                            document.sftyMngForm.action = reUrl;
                            location.href = reUrl+"?prgrmid=" + $("#prgrmid").val()+"&opner="+$("#opner").val();
                        }
                    }else{
                        alert(data.msg);
                    }
                },
                error : function (error){
                }
            });
        }

        $(function() {

        	validate();

            $("textArea").keyup(function (e) {
                var inTxt = $(this).val();
                if($("#"+this.id).next().prop("class")=="desc ar size"){
                    $("#"+this.id).next().children().prop("innerHTML",inTxt.length);
                }
            });
            $("textArea").trigger("keyup");


            $("[id^=bfrCertYn]").on("change",function(e){

            	if(this.value=='Y'){
            		$("#multiFileInput2").prop("disabled",false);
            	}else{
            		$("#multiFileInput2").prop("disabled",true);
            	}
            });
        });

        // 파일업로드
        $('#multiFileInput1,#multiFileInput2').on("change", function(event) {

        	var trgtGrpid = (this.id == "multiFileInput1") ? "filegrpid" : "bfrCertFilegrpid";

            var objFile = document.querySelector('#'+this.id);
            var formData = new FormData();
            var content = "";

            for( i = 0 ; i < objFile.files.length ; i++) {
                formData.append("files", objFile.files[i]);
                uploadFileCnt++;
            }

            formData.append("filegrpid", $("#"+trgtGrpid).val());
            formData.append("filegrpNm", "asgsysSrng_file");

            if(uploadFileCnt > 0){
                $.ajax({
                    url : '/uploadMultipleFiles.do',
                    processData : false,
                    contentType : false,
                    data : formData,
                    type : 'POST',
                    success : function(response) {

                        if(response.result == 'fail'){
                            alert(response.msg);
                        }else{
                        	if($("#"+trgtGrpid).val()=='0' || $("#"+trgtGrpid).val()==''  || $("#"+trgtGrpid).val()==null){
                                $("#"+trgtGrpid).val( response[0].filegrpid );
                            }

                            for(i = 0 ;i < response.length; i++ ){
                                content = '<li class="file-block" data_ext="' + response[i].fileExtsn.replace(".", '') + '" id="fileid' + response[i].fileid + '">'
                                content += '<span class="name">'
                                content += ' <a href="javascript:void(0)" fileid="' + response[i].fileid + '" fileIdntfcKey="' + response[i].fileIdntfcKey + '" onclick="downloadFileByFileid(this.getAttribute(\'' + response[i].fileid + '\'), this.getAttribute(\'' + response[i].fileIdntfcKey + '\'))">' + response[i].orginlFileNm + '</a>'
                                content += '</span>'
                                content += ' <button type="button" class="file-delete" title="삭제" fileid="' + response[i].fileid + '" fileIdntfcKey="' + response[i].fileIdntfcKey + '" onclick="fn_deleteFileList(\'' + response[i].fileid + '\',\'' + response[i].fileIdntfcKey + '\')">'
                                content += ' <span class="icon icon-circle-close"></span>'
                                content += ' </button>'
                                content += '</li>'
                                $('#multipleFileUploadSuccess').append(content);
                                if(trgtGrpid == "filegrpid") {
                                    $('#multipleFileUploadSuccess1').append(content);
                                }else{
                                    $('#multipleFileUploadSuccess2').append(content);
                                }
                            }
                        }
                    }
                });
            }
        });

        // 파일삭제
        function fn_deleteFileList(fileid, fileIdntfcKey){
            if(!confirm("파일을 삭제하시겠습니까?")){return;}
            fn_deleteFile(fileid, fileIdntfcKey);
            $("#"+fileid).remove();
        }

        // 파일삭제
        function fn_deleteFile(fileid, fileIdntfcKey){
            var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;
            $.ajax({
                url : deleteFileUrl,
                type: 'GET',
                cache : false,
                dataType: 'json',
                success : function (data){
                    if(data.result=="success"){
                        $("#"+fileid).remove();
                        alert("파일삭제가 완료 되었습니다.");
                    }else{
                        alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                    }
                },
                error : function (error){
                }
            });
        }

        </script>
    </div>

</body>
</html>