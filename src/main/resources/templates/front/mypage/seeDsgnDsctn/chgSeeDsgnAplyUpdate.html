<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
    layout:decorator="layout/front/subLayout" >
<body>
    <div layout:fragment="content">
        <form id="chgSeeDsgnAplyDtlForm" name="chgSeeDsgnAplyDtlForm" method="post">
            <input type="hidden" id="dmndid" name="dmndid" th:value="${chgSeeDsgnAplyInfo.dmndid}">
            <input type="hidden" id="sttsCd" name="sttsCd" th:value="${chgSeeDsgnAplyInfo.sttsCd}">
            <input type="hidden" id="aplcntid" name="aplcntid" th:value="${chgSeeDsgnAplyInfo.aplcntid}">

            <!-- content -->

            <div class="tab-content tab-sub dropDown">
                <button type="button" class="tab-mobile-trigger trigger"  aria-expanded="true">변경내역</button>
                <ul class="tab-list tab-list-pc target" >
                    <li class="tab"><a th:href="@{/front/mypage/seeDsgnDsctn/seeDsgnDsctnDetailForm.html}" >지정내역</a></li>
                    <li class="tab active"><a id="chgDsctnTab" th:href="@{/front/mypage/seeDsgnDsctn/chgSeeDsgnDsctnForm.html}" >변경내역</a></li>
                </ul>
            </div>
            <div class="table-caption">
                <div class="left">
                    <h3 class="sub-title">기본정보</h3>
                </div>
            </div>

            <div class="table-row">
                <table>
                    <caption>기본정보  - 접수번호, 시도, 지정번호, 기관명, 지정획득일</caption>
                    <colgroup>
                        <col style="width:140px;">
                        <col>
                        <col style="width:140px;">
                        <col>
                    </colgroup>
                    <tbody>
                        <tr>
                            <th scope="row">접수번호</th>
                            <td colspan="3"><th:block th:text="${chgSeeDsgnAplyInfo.rcptno}" /></td>
                        </tr>
                        <tr>
                            <th scope="row">시도</th>
                            <td><th:block th:text="${chgSeeDsgnAplyInfo.ctprvnNm}" /></td>
                            <th scope="row">지정번호</th>
                            <td><th:block th:text="${chgSeeDsgnAplyInfo.dsgnno}" /></td>
                        </tr>
                        <tr>
                            <th scope="row">기관명</th>
                            <td><th:block th:text="${chgSeeDsgnAplyInfo.instNm}" /></td>
                            <th scope="row">지정획득일</th>
                            <td><th:block th:text="${chgSeeDsgnAplyInfo.dsgnDe}" /></td>
                        </tr>
                    </tbody>
                </table>
            </div>


            <div class="table-caption">
                <div class="left">
                    <h3 class="sub-title">변경내용</h3>
                </div>
            </div>

            <div class="table-row table-row-mo">
                <table>
                    <caption>변경내용 - 변경사유, 첨부파일, 진행상태</caption>
                    <colgroup>
                        <col style="width:140px;">
                        <col>
                    </colgroup>
                    <tbody>
                        <tr>
                            <th scope="row">변경사유</th>
                            <td>
                                <textarea maxlength="500" title="변경 사유" id="dmndCn" name="dmndCn"><th:block th:text="${chgSeeDsgnAplyInfo.dmndCn}" /></textarea>
                                <div class="desc ar size"><span>0</span> / 500자</div>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">첨부파일</th>
                            <td>
                                <div class="form-input-file">
                                    <span class="form-input">
                                        <input type="file" id="multiFileInput" name="files" class="blind" multiple="multiple" accept=".jpeg,.jpg,.png,.gif,.tif,.tiff,.hwp,.hwpx,.pdf,.ppt,.pptx,.doc,.docx,.xls,.xlsx,.zip" title="파일첨부" maxcount="5">
                                    </span>
                                    <button class="btn-medium btn-gray" type="button" title="파일선택" onclick="javascript:$('#multiFileInput').click()">파일선택</button>
                                    <div class="upload-response">
                                        <div id="multipleFileUploadError"></div>
                                        <div id="multipleFileUploadSuccess">
                                        <th:block th:if="${fileList != null}">
                                            <div th:each="item : ${fileList}" th:id="${item.fileid}" class="col-auto">
                                                <ul th:if="${item.orginlFileNm != null}">
                                                    <li th:fileid='${item.fileid}'
                                                        th:fileIdntfcKey="${item.fileIdntfcKey}"
                                                        th:onclick="downloadFileByFileid(this.getAttribute('fileid'),this.getAttribute('fileIdntfcKey'))"
                                                        class='label label-inverse'
                                                        th:data_ext="${#strings.replace(item.ext, '.', '')}">
                                                        <th:block th:text="${item.orginlFileNm}" />&nbsp;&nbsp;
                                                        <a href="javascript:void(0)" th:name="${item.fileid}" th:attr="data-idntfc-key=${item.fileIdntfcKey}" th:onclick="fn_deleteFileList(this.name, this.dataset.idntfcKey)" class='text-white'>
                                                        <th:block th:text="X"></th:block></a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </th:block>
                                        <input type="hidden" id="filegrpid" name="filegrpid" th:value="${(chgSeeDsgnAplyInfo.filegrpid == '' or chgSeeDsgnAplyInfo.filegrpid == null) ? 0 : chgSeeDsgnAplyInfo.filegrpid}"/>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">진행상태</th>
                            <td>[[${chgSeeDsgnAplyInfo.sttsNm}]]</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="btn-wrap">
                <div class="center">
                    <button type="button" class="btn-medium btn-gray" onclick="chgSeeDsgnAplyUpdate.cancel()">취소</button>
                    <button type="button" class="btn-medium btn-green" onclick="chgSeeDsgnAplyUpdate.save()">저장</button>
                </div>
            </div>
            <!-- //content -->
        </form>
        <script th:inline="javascript">

            var atchfileCnt = 5;
            var uploadFileCnt = 0;

            var chgSeeDsgnAplyUpdate = {
                updateUrl:"/front/mypage/seeDsgnDsctn/updateChgSeeDsgnAply.do",

                cancel(){
                    if(!confirm("취소 하시겠습니까?")){return;}
                    $("#chgDsctnTab").get(0).click();
                },

                save(){
                    if(!$("#chgSeeDsgnAplyDtlForm").valid()) return false;

                    if(!confirm("저장 하시겠습니까?")){return;}

                    let data = $('#chgSeeDsgnAplyDtlForm').serialize();
//                     $('input[name=tmplatIds]').each(function (){
//                         if($(this).siblings().find('input[name=useYn'+$(this).val()+']:checked').val() === 'Y'){
//                             data += '&tmplatIds='+$(this).val();
//                         }
                    $.ajax({
                         url: chgSeeDsgnAplyUpdate.updateUrl,
                        type: 'POST',
                        cache : false,
                        dataType: 'json',
                        data : data,
                        success : function (data){
                            if(data.result=="success"){
                                alert(data.msg);
                                $("#chgDsctnTab").get(0).click();
                            }
                            closeWorkProgress();
                        }
                    });
                }
            }

            $(function () {

                $("textarea").keyup(function (e) {
                    var inTxt = $(this).val();
                    if($("#"+this.id).next().prop("class")=="desc ar size"){
                        $("#"+this.id).next().children().prop("innerHTML",inTxt.length);
                    }
                });

                $("textarea").trigger("keyup");

                validator = $("#chgSeeDsgnAplyDtlForm").validate({
                    ignore: [],
                    rules: {
                        dmndCn: { maxlength:500 }
                    } ,
                    messages: {
                        dmndCn: { maxlength:"변경시 : 변경내용은 500자를 넘을 수 없습니다."  }
                    }

                });

                // 파일업로드
                $('#multiFileInput').on("change", function(event) {
                    debugger;
                    var objFile = document.querySelector('#multiFileInput');
                    var formData = new FormData();
                    var content = "";

                    for( i = 0 ; i < objFile.files.length ; i++) {
                        if(uploadFileCnt >= atchfileCnt){
                            alert("첨부파일은  "+atchfileCnt+ " 개 까지 가능합니다." ); break;
                        } else {
                            formData.append("files", objFile.files[i]);
                            uploadFileCnt++;
                        }
                    }

                    formData.append("filegrpid", $("#filegrpid").val());
                    formData.append("filegrpNm", "eduInst_file");

                    if(uploadFileCnt > 0){
                        $.ajax({
                            url : '/uploadMultipleFiles.do',
                            processData : false,
                            contentType : false,
                            data : formData,
                            type : 'POST',
                            success : function(response) {
                                if(response.result == 'fail'){
                                    alert(response.msg);
                                }else{
                                    if($("#filegrpid").val()=='0' || $("#filegrpid").val()==''  || $("#filegrpid").val()==null){
                                        $("#filegrpid").val( response[0].filegrpid );
                                    }

                                    for(i = 0 ;i < response.length; i++ ){
                                        content = '<ul>';
                                        content +=  '<li class="file-block" data_ext="'+response[i].fileExtsn.replace(".", '')+'" id="'+response[i].fileid+'"><span class="name">'+response[i].orginlFileNm
                                        content += '&nbsp;&nbsp;<a href="javascript:uploadFileCnt--;fn_deleteFileList("'+response[i].fileid+'","'+response[i].fileIdntfcKey+'")>X</a></span></li>'
                                        content += '</ul>';
                                        $('#multipleFileUploadSuccess').append(content);
                                    }
                                }
                            }
                        });
                    }
                });
            });

            // 파일삭제
            function fn_deleteFileList(fileid, fileIdntfcKey){
                if(!confirm("파일을 삭제하시겠습니까?")){return;}
                fn_deleteFile(fileid, fileIdntfcKey);
                $("#"+fileid).remove();
            }

            // 파일삭제
            function fn_deleteFile(fileid, fileIdntfcKey){
                var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;
                $.ajax({
                    url : deleteFileUrl,
                    type: 'GET',
                    cache : false,
                    dataType: 'json',
                    success : function (data){
                        if(data.result=="success"){
                            $("#"+fileid).remove();
                            alert("파일삭제가 완료 되었습니다.");
                        }else{
                            alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                        }
                    },
                    error : function (error){
                    }
                });
            }

        </script>
    </div>
</body>
</html>