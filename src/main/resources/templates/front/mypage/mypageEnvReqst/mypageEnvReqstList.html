<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="layout/front/subLayout">

<div layout:fragment="content">
    <div id="content" class="content">
        <form class="search-filter" id="searchForm" name="searchForm" onsubmit="return false;">
            <div class="form-input-wrap">
                <div class="form-row">
                    <div class="form-header"><strong class="label">키워드</strong></div>
                    <div class="form-body">
                        <div class="form-input">
                            <select title="키워드" name="searchType" id="searchType"  th:value="${params.searchType}">
                                <option value="fcltNm">시설명</option>
                                <option value="spceNm">공간명</option>
                            </select>
                            <input type="search" title="키워드" name="searchKeyword" id="searchKeyword" placeholder="키워드를 입력해 주세요."  th:value="${params.searchKeyword}">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-header"><strong class="label">상태</strong></div>
                    <div class="form-body">
                         <select  id="searchAplySttsCd" name="searchAplySttsCd" title="상태" >
                            <option value="" >전체 </option>
                            <option value="161101" th:selected ="${params.searchAplySttsCd eq '161101'}">입금대기</option>
                            <option value="161102" th:selected ="${params.searchAplySttsCd eq '161102'}">입금완료</option>
                            <option value="160103" th:selected ="${params.searchAplySttsCd eq '160103'}">예약취소</option>
                            <option value="161103" th:selected ="${params.searchAplySttsCd eq '161103'}">환불요청</option>
                            <option value="161104" th:selected ="${params.searchAplySttsCd eq '161104'}">환불완료</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-header"><strong class="label">이용일</strong></div>
                    <div class="form-body">
                        <div class="form-input">
                            <input type="date" title="시작일" name="searchBgngDt" id="searchBgngDt">
                            <div class="bul">~</div>
                            <input type="date" title="종료일" name="searchEndDt" id="searchEndDt">
                        </div>
                    </div>
                </div>
            </div>
            <div class="search-filter-submit">
                <button type="button" class="btn-medium btn-gray btn-before-refresh"  onclick = "initSearchFilter()">초기화</button>
                <button type="submit" class="btn-medium btn-green btn-before-search" onclick = "search()">검색</button>
            </div>
            <input type="hidden" id="aplyid" name="aplyid" value="0">
	        <input type="hidden" id="rsvtdeid" name="rsvtdeid" value="0">
	        <input type="hidden" id="pageNumber" name="pageNumber" th:value="${ (params.pageNumber==null || params.pageNumber==0 )? 1:params.pageNumber}">
	        <input type="hidden" id="orderField" name="orderField" value=MDFCN_DT>
	        <input type="hidden" id="rowPerPage" name="rowPerPage" value="12"/>
        </form>
        
        <div class="table-caption flex-nowrap">
            <div class="left">
                <p>총 <b id="totalCount">0</b> 개</p>
            </div>
        </div>
        <div id="listArea" class="card-section"></div>

        <div class="pagination" aria-label="pagination" id="pagination"></div>

    </div>

    <!-- layerpopup -->
    <div class="layer-popup layer-large" data-layer-id="lendHistoryPopup">
        <div class="layer-dimmed" title="레이어팝업 닫기"></div>
        <div class="layer-wrap" id="lendHistoryPopup">
        </div>
    </div>
    
    <script src="/js/common/handlebars/handlebars-v4.7.7.js"></script>
    <script src="/js/common/handlebars/handlebars.helper.js"></script>
    <script id="histListTemplate" type="text/x-handlebars-template"> 
            <ul class="n3">
            {{#each histList}}
                <li>
                    <div class="flag {{sttsBgColor}}">{{sttsTxt}}</div>
                    <div class="thumb">
                        <img src="{{src}}" alt="" onerror="this.src='/images/front/bg/bg-noimage.png'; this.style.objectFit='none';"> 
                    </div>
                    <div class="cont mt0">
                        <a href="javascript:moveToView('{{aplyid}}')" class="title ellipsis" data-ellipsis="2">[{{fcltNm}}] {{spceNm}}</a>
                        <ul class="df">
                            <li class="d-flex">
                                <span class="tit">주소 :</span>
                                <span class="dc"> {{addr}} {{addrDtl}}</span>
                            </li>
                            <li class="d-flex">
                                <span class="tit">인원 :</span>
                                <span class="dc">최대 {{maxNope}} 인</span>
                            </li>
                            <li class="d-flex">
                                <span class="tit">면적 :</span>
                                <span class="dc">{{size}} 평형</span>
                            </li>
                            <li class="d-flex">
                                <span class="tit">날짜 :</span>
                                <span class="dc">{{finalDate}}</span>
                            </li>
                            <li class="d-flex j-between">
                                <div class="d-flex">
                                    <span class="tit">가격 :</span>
                                    <span class="dc">{{amt}} </span>
                                </div>
                                {{#btnWait}}
                                 <button type="button" class="btn-small btn-outline-blue" onclick="openModal(event,'W','{{aplyid}}')">입금정보</button>
                                {{/btnWait}}
                                {{#btnReply}}
                                 <button type="button" class="btn-small btn-outline-blue" onclick="openModal(event,'R','{{aplyid}}')">후기작성</button>
                                {{/btnReply}}
                                {{#btnComplete}}
                                 <button type="button" class="btn-small btn-outline-blue" onclick="openModal(event,'RC','{{aplyid}}')">작성완료</button>
                                {{/btnComplete}}
                                {{#btnCancel}}
                                 <button type="button" class="btn-small btn-outline-blue" onclick="openModal(event,'C','{{aplyid}}')">사유확인</button>
                                {{/btnCancel}}

                            </li>
                        </ul>
                    </div>
              </li> 
           {{/each}}
        </ul>
    </script>
  
    <script th:inline="javascript">
        var listUrl = "/front/mypage/mypageEnvReqst/selectMypageEnvReqstList.do";
        var viewUrl = '/front/mypage/mypageEnvReqst/mypageResveEnvView.html';
        var formUrl = '/front/mypage/mypageEnvReqst/mypage/mypageEnvReqstForm.html';
        var loginUserid = /*[[${loginUserid}]]*/null;

        // 사유확인 팝업
        var rsnPopupUrl = "/front/mypage/mypageEnvReqst/rsnPopup.html";
        var dpstInfoPopupUrl = "/front/mypage/mypageEnvReqst/dpstInfoPopup.html";
        var insertRvwPopupUrl = "/front/mypage/mypageEnvReqst/insertRvwPopup.html";
        var selectRvwPopupUrl = "/front/mypage/mypageEnvReqst/selectRvwPopup.html";

        var searchBgngDt = /*[[${params.searchBgngDt}]]*/null;
        var searchEndDt = /*[[${params.searchEndDt}]]*/null;

        var noDataMsg = '<div class="nodata" style="border:none;" ><p><span class="icon icon-notice bg-black9"></span> 예약 이력이 없습니다.</p></div>';
        var listTemplet = Handlebars.compile($("#histListTemplate").html());

        $(function () {
            if(searchBgngDt!= null ){ $('#searchBgngDt').val(searchBgngDt);}
            if(searchEndDt!= null ){ $('#searchEndDt').val(searchEndDt);}
            selectEnvReqstList();
        });

        function search() {
            $('#pageNumber').val(1);
            selectEnvReqstList();
        }

        function initSearchFilter() {
            $("#searchType").val('fcltNm'); 
            $("#searchBgngDt").val(''); 
            $("#searchEndDt").val(''); 
            $("#searchKeyword").val(''); 
            $("#searchAplySttsCd").val(''); 
        }
        function selectEnvReqstList() {

            if (displayWorkProgress(true)) {
                $.ajax({
                    url: listUrl,
                    cache: false,
                    dataType: 'json',
                    data: formData = $('#searchForm').serializeArray(),
                    type: 'GET',
                    success: function (data) {
                        
                        makeListHtml(data.list);
                        $("#totalCount").text(data.totalCount);
                        
                        if(data.totalCount == 0) {
                            $("#listArea").html(noDataMsg);
                            $("#pagination").html('');
                        }else{
                            $("#pagination").html(data.pagination);
                        };
                        closeWorkProgress();
                    }
                });
            }
        }

        function makeListHtml(list) {
            
            list.forEach(function(item){

            	let finalDate = '';
                let target1 = new Date(item.bgngDt);
                let target2 = new Date(item.endDt);
                if( !( target1.getFullYear() === target2.getFullYear() &&
                    target1.getMonth() === target2.getMonth() &&
                    target1.getDate()=== target2.getDate() ) ) {
                    item.finalDate = date2str(parseDate(item.bgngDt), 'yyyy-mm-dd') +' ~ '+ date2str(parseDate(item.endDt), 'yyyy-mm-dd');
                }else{
                	item.finalDate = date2str(parseDate(item.bgngDt), 'yyyy-mm-dd HH:MM') +' ~ '+ date2str(parseDate(item.endDt), 'HH:MM');
                }
                
                if(item.rprsImgFileid != null && item.rprsImgFileKey != null){
                    item.src = '/downloadFileByFileid.do?fileid=' + item.rprsImgFileid + '&file_idntfc_key=' + item.rprsImgFileKey; 
                }else{
                    item.src = '/images/mng/admin_logo.png'; 
                }

                
                switch(item.totalStts){
                case '161101' :
                    item.sttsTxt = '입금대기';
                    item.sttsBgColor = ' bg-green';
                    if(item.amt > 0)item.btnWait = true;
                    break;
                case '161102' :
                	item.sttsTxt = '입금완료';
                	item.sttsBgColor = ' bg-blue';
                	
            		if( item.rvwCn != null && item.rvwCn != '' && item.rvwDt != null ){
                        item.btnComplete = true;
                	}else{
	                    item.btnReply = true;
                    }
                    break;
                case '160103' :
                	item.sttsTxt = '예약취소';
                	item.sttsBgColor = ' bg-red';
                    break;
                case '161103' :
                	item.sttsTxt = '환불요청';
                	item.sttsBgColor = ' bg-green';
                    break;
                case '161104' :
                	item.sttsTxt = '환불완료';
                	item.sttsBgColor = ' bg-blue';
                    break;
                default :
                	item.sttsTxt = '';
             }
                
             item.amt = ( Number(item.amt) > 0 )? addComma3(item.amt)+" 원" : "무료"; 

             if(item.rfndRejectRsn != null && item.rfndRejectRsn !="" ){item.btnCancel = true;}
                
           })
            $("#listArea").html(listTemplet({histList:list}));
        }

        var rsnPopupUrl = "/front/mypage/mypageEnvReqst/rsnPopup.html";
        var dpstInfoPopupUrl = "/front/mypage/mypageEnvReqst/dpstInfoPopup.html";
        var insertRvwPopupUrl = "/front/mypage/mypageEnvReqst/insertRvwPopup.html";
        var selectRvwPopupUrl = "/front/mypage/mypageEnvReqst/selectRvwPopup.html";
        
        function openModal(event, mode , aplyid){
            
            let modalUrl = "";
        	if(mode =='W')      {modalUrl = dpstInfoPopupUrl+"?aplyid="+aplyid; }
        	else if(mode =='R' ){modalUrl = insertRvwPopupUrl+"?aplyid="+aplyid; }
        	else if(mode =='RC'){modalUrl = selectRvwPopupUrl+"?aplyid="+aplyid; }
        	else if(mode =='C' ){modalUrl = rsnPopupUrl+"?aplyid="+aplyid; }
        	fn_openPopup(event,modalUrl)
        }
        
        function fn_openPopup(event , url){
            $("#lendHistoryPopup").load(url, function(response, status, xhr) { 
                if (status == "success") {
                    layerPopup.open({target:'lendHistoryPopup'},event);
                }
            });
        }

        function moveToInsertForm() {
            var f = document.forms.searchForm;
            f.action = formUrl;
            f.submit();
        }

        function moveToView(aplyid, rsvtdeid) {
            var f = document.forms.searchForm;
            f.aplyid.value = aplyid;
            f.rsvtdeid.value = rsvtdeid;
            f.action = viewUrl;
            f.submit();
        }

        function goPage(num) {
            $("#pageNumber").val(num);
            selectEnvReqstList();
        }

        function date2str(x, y) {
            var z = {
                m: x.getMonth() + 1,
                d: x.getDate(),
                H: x.getHours(),
                M: x.getMinutes(),
                S: x.getSeconds()
            };

            y = y.replace(/(m+|d+|H+|M+|S+)/g, function(v) {
                return ((v.length > 1 ? "0" : "") + z[v.slice(-1)]).slice(-2)
            });

            return y.replace(/(y+)/g, function(v) {
                return x.getFullYear().toString().slice(-v.length)
            });
        }

        function parseDate(strDate) {
            var _strDate = strDate;
            var _dateObj = new Date(_strDate);
            if (_dateObj.toString() == 'Invalid Date') {
                _strDate = _strDate.split('.').join('-');
                _dateObj = new Date(_strDate);
            }
            if (_dateObj.toString() == 'Invalid Date') {
                var _parts = _strDate.split(' ');

                var _dateParts = _parts[0];
                _dateObj = new Date(_dateParts);

                if (_parts.length > 1) {
                    var _timeParts = _parts[1].split(':');
                    _dateObj.setHours(_timeParts[0]);
                    _dateObj.setMinutes(_timeParts[1]);
                    if (_timeParts.length > 2) {
                        _dateObj.setSeconds(_timeParts[2]);
                    }
                }
            }

            return _dateObj;
        }
    </script>
</div>