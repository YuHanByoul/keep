<!DOCTYPE html>
<html
        xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
        layout:decorator="layout/front/subLayout">
<body>
<div layout:fragment="content">
    <div class="table-view">
        <div class="table-view-header">
            <h3><span>[[${cmntyPstInfo.ttl}]]</span></h3>
            <dl>
                <div class="list">
                    <dt>등록자</dt>
                    <dd>[[${cmntyPstInfo.rgtrNm}]]</dd>
                </div>
                <div class="list">
                    <dt>등록일</dt>
                    <dd>[[${#dates.format(cmntyPstInfo.regDt, 'yyyy-MM-dd')}]]</dd>
                </div>
                <div class="list">
                    <dt>조회수</dt>
                    <dd>[[${cmntyPstInfo.hits}]]</dd>
                </div>
            </dl>
            <dl>
                <div class="list">
                    <dt>첨부파일</dt>
                    <dd>
                        <div class="form-input-file">
                            <ul th:each="file : ${fileMap}">
                                <li class="file-block" th:data_ext="${#strings.substring(file.fileExtsn,1)}">
                                    <span class="name">
                                        <a href="javascript:void(0)" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                                           th:onclick="|javascript:downloadFileByFileid(this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'))|">
                                            [[${file.orginlFileNm}]]
                                        </a>
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </dd>
                </div>
            </dl>
        </div>
        <div class="table-view-body">
            <div class="table-view-content">
                <th:block th:utext="${cmntyPstInfo.cn}"></th:block>
            </div>
        </div>

        <div class="cmnt-wrap" th:if="${cmntyPstInfo.cmntUseYn eq 'Y'}">
            <th:block th:replace="front/cmnty/cmntyWrap"></th:block>
        </div>

        <div class="btn-wrap">
            <div class="center">
                <button th:if="${cmntyPstInfo.rgtrid eq paramVo.user.userid}" type="button" class="btn-medium btn-gray delete-btn" data-del-yn="Y">삭제</button>
                <button th:if="${cmntyPstInfo.rgtrid eq paramVo.user.userid}" type="button" class="btn-medium btn-gray action-btn" data-action="cmntyPstUpdateForm.html">수정</button>
                <button type="button" class="btn-medium btn-gray action-btn" data-action="cmntyPstList.html">목록</button>
                <button th:if="${bbsInfo.cmntUseYn eq 'Y'}" type="button" class="btn-medium btn-gray action-btn" data-action="cmntyPstInsertForm.html">답글</button>
            </div>
        </div>

        <!--<div class="page-navigation">
            <a class="move-pst-btn" th:if="${cmntyPstInfo.prevPstid ne null}" th:data-pstid="${cmntyPstInfo.prevPstid}">
                <dl>
                    <dt>다음글</dt>
                    <dd><span class="ellipsis">[[${cmntyPstInfo.prevTitle}]]</span></dd>
                </dl>
            </a>

            <a class="move-pst-btn" th:if="${cmntyPstInfo.nextPstid ne null}" th:data-pstid="${cmntyPstInfo.nextPstid}">
                <dl>
                    <dt>이전글</dt>
                    <dd><span class="ellipsis">[[${cmntyPstInfo.nextTitle}]]</span>
                    </dd>
                </dl>
            </a>
        </div>-->
    </div>

    <div class="clone-tmps" style="display: none;">
        <li class="common-cmnt">
            <div class="reply-container">
                <div class="top">
                    <div class="profile"></div>
                    <div class="date"></div>
                    <div class="pc-only">
                        <div class="btn-wrap btn-wrap-medium">
                            <div class="left">
                                <button type="button" class="btn-xsmall btn-outline-blue reply-btn">답글</button>
                                <button type="button" class="btn-xsmall btn-outline-black update-form-btn">수정</button>
                                <button type="button" class="btn-xsmall btn-outline-black cmnt-delete-btn">삭제</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="reply-input">
                    <div class="reply-textarea">
                        <pre></pre>
                    </div>
                </div>
                <div class="mo-only">
                    <div class="btn-wrap btn-wrap-medium">
                        <div class="left">
                            <button type="button" class="btn-xsmall btn-outline-blue reply-btn">답글</button>
                            <button type="button" class="btn-xsmall btn-outline-black update-form-btn">수정</button>
                            <button type="button" class="btn-xsmall btn-outline-black cmnt-delete-btn">삭제</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="dep02">
                <ul></ul>
            </div>
        </li>

        <li class="reply-cmnt-input">
            <div class="reply-container">
                <div class="reply-input">
                    <div class="reply-textarea">
                        <textarea title="답글" placeholder="답글 내용을 입력해주세요."></textarea>
                        <div class="desc ar size"><span>0</span> / 1,000자</div>
                    </div>
                    <div class="btn-wrap">
                        <button type="button" class="btn-medium btn-green cmnt-insert-btn">등록</button>
                    </div>
                </div>
            </div>
        </li>

        <li class="update-cmnt-input">
            <div class="reply-container">
                <div class="top">
                    <div class="profile"></div>
                    <div class="date"></div>
                </div>
                <div class="reply-input">
                    <div class="reply-textarea">
                        <textarea title="답글" placeholder="답글 내용을 입력해주세요."></textarea>
                        <div class="desc ar size"><span>0</span> / 1,000자</div>
                    </div>
                    <div class="btn-wrap">
                        <button type="button" class="btn-medium btn-green cmnt-update-btn">수정</button>
                    </div>
                </div>
            </div>
        </li>

        <div class="relpy-more-view">
            <button type="button" class="btn-small btn-outline-black bg-grayd reply-more-btn">답글 더보기</button>
            <input type="hidden" id="pageIndex" value="1" />
        </div>
    </div>

    <form name="searchForm" id="searchForm">
        <input type="hidden" id="pageNumber" name="pageNumber" th:value="${paramVo.pageNumber}">
        <input type="hidden" id="rowPerPage" name="rowPerPage" th:value="${paramVo.rowPerPage}">
        <input type="hidden" id="searchType" name="searchType" th:value="${paramVo.searchType}">
        <input type="hidden" id="searchKeyword" name="searchKeyword" th:value="${paramVo.searchKeyword}">
        <input type="hidden" id="cmntyid" name="cmntyid" th:value="${cmntyid}">
        <input type="hidden" id="bbsid" name="bbsid" th:value="${paramVo.bbsid}">
        <input type="hidden" id="pstid" name="pstid" th:value="${cmntyPstInfo.pstid}">
    </form>

    <script th:inline="javascript">
        window.addEventListener('DOMContentLoaded',function (){
            const $searchForm = $('#searchForm');
            const $replyLength = $('.reply-length > span');
            const $cmntWrap = $('.reply-list .dep01 > ul');
            const $commonCmnt = $('.clone-tmps .common-cmnt');
            const $replyCmntInput = $('.clone-tmps .reply-cmnt-input');
            const $updateCmntInput = $('.clone-tmps .update-cmnt-input');
            const $replyMoreView = $('.clone-tmps .relpy-more-view');
            const pstid = $searchForm[0].pstid.value;
            const bbsid = $searchForm[0].bbsid.value;
            const userid = /*[[${paramVo.user.userid}]]*/null;
            let rowPerPage = 20;

            /*$('.move-pst-btn').on('click', function(){
                const pstid = $(this).data('pstid');
                if(pstid == null) return;
                $searchForm[0].action = 'cmntyPstView.html';
                $searchForm[0].pstid.value = pstid;
                $searchForm[0].submit();
            });*/

            $('.cmnt-wrap').on('change, keyup', 'textarea', function (){
                const textSize = $(this).val().length;
                $(this).siblings('.size').find('span').text(textSize);
            });

            $('.action-btn').on('click',function(){
                $searchForm[0].action = $(this).data('action');
                $searchForm[0].submit();
            });

            $('.delete-btn').on('click', function (){
                if(confirm('등록하신 게시글을 삭제 하시겠습니까?')){
                    if(displayWorkProgress(true)) {
                        $.ajax({
                            method: 'post',
                            cache: false,
                            url: 'updateCmntyPst.do',
                            data: {
                                pstid : pstid,
                                delYn : $(this).data('delYn')
                            },
                            dataType: 'json',
                            success: function (response) {
                                alert(response.msg);
                                if (response.result) {
                                    $searchForm[0].action = 'cmntyPstList.html';
                                    $searchForm[0].submit();
                                }
                                closeWorkProgress();
                            }
                        })
                    }
                }
            });

            //댓글/대댓글 등록 ajax
            $('.cmnt-wrap').on('click', '.cmnt-insert-btn',function(){
                const $textarea = $(this).closest('.reply-input').find('textarea');
                const rslYn = 'Y'; //추후 비밀글 생기면 조작할 수 있도록 수정바람
                const parntsCmntid = $(this).data('parnts-cmntid'); //대댓글일시
                const $cmntReplyWrap = $(this).closest('.dep02').find('ul'); //대댓글일시
                if($textarea.val() === ''){
                    alert('댓글 내용을 입력해주세요.');
                    return;
                }
                if(displayWorkProgress(true)){
                    $.ajax({
                        type: 'POST',
                        url : "insertCmnt.do",
                        data : {
                            pstid : pstid,
                            bbsid : bbsid,
                            parntsCmntid : parntsCmntid,
                            cn : $textarea.val(),
                            rlsYn : rslYn
                        },
                        success : function (response){
                            if(response.result !== 'fail'){
                                const $item = $commonCmnt.clone(true);
                                const isRgtr = response.data.rgtrid === userid;
                                if(parntsCmntid === undefined){
                                    $cmntWrap.prepend( // 댓글 등록 후 html 추가
                                        $item.find('.profile').text(response.data.rgtrNm + ' (' + response.data.rgtrAcnt + ')').end()
                                            .find('.date').text(response.data.regDt).end()
                                            .find('.reply-btn').data({'parntsCmntid':response.data.cmntid}).end()
                                            .find('.update-form-btn, .cmnt-delete-btn').data({'cmntid': (isRgtr ? response.data.cmntid : null)})
                                                .prop({disabled:(isRgtr ? false : true)})
                                                .css({display:(isRgtr ? 'block' : 'none')}).end()
                                            .find('.reply-textarea > pre').text(response.data.cn).end()
                                    );
                                    $replyLength.text(Number($replyLength.text())+1);
                                    $textarea.val('');
                                    const rowPerPageSet = Number($cmntWrap.siblings('.relpy-more-view').find('#pageIndex').val()); //현재 rowPage 계산
                                    if(Number($replyLength.text()) > Number(rowPerPage*rowPerPageSet)){ //rowPerPage 넘어갈 시 마지막 답글 사라짐
                                        $cmntWrap.children().last().find('.more-btn').remove();
                                        if(!$cmntWrap.closest('.dep01').children().last().children().is('button')){
                                            $cmntWrap.closest('.dep01').find('.relpy-more-view').prepend(
                                                $replyMoreView.find('button').clone(true)
                                                    .find('.bg-grayd').removeClass('bg-grayd').end()
                                                    .find('button').removeClass('reply-more-btn').addClass('more-btn').end()
                                            );
                                        }
                                    }
                                }else{
                                    $cmntReplyWrap.find('.reply-cmnt-input').before( // 대댓글 등록 후 html 추가
                                        $item.find('.profile').text(response.data.rgtrNm + ' (' + response.data.rgtrAcnt + ')').end()
                                            .find('.date').text(response.data.regDt).end()
                                            .find('.reply-btn').remove().end()
                                            .find('.update-form-btn, .cmnt-delete-btn').data({'cmntid': (isRgtr ? response.data.cmntid : null)})
                                                .prop({disabled:(isRgtr ? false : true)})
                                                .css({display:(isRgtr ? 'block' : 'none')}).end()
                                            .find('.reply-textarea > pre').text(response.data.cn).end()
                                            .find('.dep02').remove().end()
                                    );
                                    $textarea.val('');
                                    const rowPerPageSet = Number($cmntReplyWrap.siblings('.relpy-more-view').find('#pageIndex').val()); //현재 rowPage 계산
                                    if(response.data.cmntReplyCnt > Number(rowPerPage*rowPerPageSet)){ //rowPerPage 넘어갈 시 마지막 답글 사라짐
                                        $cmntReplyWrap.children().first().remove();
                                        if(!$cmntReplyWrap.closest('.dep02').children().last().children().is('button')){
                                            $cmntReplyWrap.closest('.dep02').find('.relpy-more-view').prepend($replyMoreView.find('button').clone(true).data({'parntsCmntid':parntsCmntid}));
                                        }
                                    }
                                }
                            }
                            closeWorkProgress();
                        }
                    });
                }
            });
            //댓글/대댓글 수정 버튼 클릭 시 수정 입력 창 생성
            $('.cmnt-wrap').on('click', '.update-form-btn', function (){
                const $item = $updateCmntInput.clone(true);
                const cmntid = $(this).data('cmntid');
                const cn = $(this).closest('.reply-container').find('pre').text();
                const rgtrInfo = $(this).closest('.reply-container').find('.profile').text();
                const regDt = $(this).closest('.reply-container').find('.date').text();
                $(this).closest('li').before(
                    $item.find('.profile').text(rgtrInfo).end()
                        .find('.date').text(regDt).end()
                        .find('textarea').val(cn).end()
                        .find('.cmnt-update-btn').data({'cmntid':cmntid}).end()
                );
                $(this).closest('li').remove();
            });
            //댓글/대댓글 삭제 ajax 수정도
            $('.cmnt-wrap').on('click', '.cmnt-update-btn, .cmnt-delete-btn', function (){
                const isDelete = $(this).is('.cmnt-delete-btn'); //true 삭제로직, false 수정로직
                const isReply = $(this).closest('.dep02').length > 0 ? true : false; //답글 여부
                const delYn = isDelete ? 'Y' : 'N';
                const cn = $(this).closest('.reply-input').find('textarea').val();
                const cmntid = $(this).data('cmntid');
                const rgtrInfo = $(this).closest('.reply-container').find('.profile').text();
                const regDt = $(this).closest('.reply-container').find('.date').text();
                const $this = $(this);
                if(!isDelete && cn === ''){
                    alert('댓글 내용을 입력해주세요.');
                    return;
                }
                if(confirm(isDelete ? '작성한 댓글을 삭제하시겠습니까?' : '작성한 댓글을 수정하시겠습니까?')){
                    if(displayWorkProgress(true)){
                        $.ajax({
                            type: 'POST',
                            url : "updateCmnt.do",
                            data : {
                                pstid : pstid,
                                delYn : delYn,
                                cmntid : cmntid,
                                cn : cn,
                            },
                            success : function (response){
                                if(response.result !== 'fail'){
                                    if(isDelete){
                                        $this.closest('.reply-container').text('삭제된 댓글입니다.');
                                    }else{
                                        const $item = $commonCmnt.clone(true);
                                        $this.closest('li').before(
                                            $item.find('.profile').text(rgtrInfo).end()
                                                .find('.date').text(regDt).end()
                                                .find('.reply-btn').data({'parntsCmntid':cmntid}).end()
                                                .find('.update-form-btn, .cmnt-delete-btn').data({'cmntid':cmntid}).end()
                                                .find('.reply-textarea > pre').text(cn).end()
                                        );
                                        if(isReply){
                                            $this.closest('li').prev().find('.reply-btn').remove();
                                        }
                                        $this.closest('li').remove();
                                    }
                                }
                                closeWorkProgress();
                            }
                        });
                    }
                }
            });
            //댓글 > 답글 클릭
            $('.cmnt-wrap').on('click', '.reply-btn', function (){
                const $this = $(this);
                const $cmntReplyWrap = $(this).closest('.reply-container').siblings('.dep02').find('ul');
                if(!$this.is('.active')){
                    const parntsCmntid = $(this).data('parnts-cmntid');
                    if(displayWorkProgress(true)){
                        $.ajax({
                            type: 'POST',
                            url : "selectCmntReplyList.do",
                            data : {
                                pstid : pstid,
                                parntsCmntid : parntsCmntid,
                                rowPerPage : rowPerPage,
                                pageNumber : 1
                            },
                            success : function (result){
                                if(result.data != null){
                                    let cmntReplyCnt = '';
                                    for(let item of result.data){
                                        cmntReplyCnt = item.cmntReplyCnt;
                                        const $item = $commonCmnt.clone(true);
                                        const isRgtr = item.rgtrid === userid;
                                        if(item.delYn === 'Y'){
                                            $cmntReplyWrap.prepend(
                                                $item.find('.reply-container').text('삭제된 댓글입니다.').end()
                                                    .find('.dep02').remove().end()
                                            );
                                        }else{
                                            $cmntReplyWrap.prepend(
                                                $item.find('.profile').text(item.rgtrNm + ' (' + item.rgtrAcnt + ')').end()
                                                    .find('.date').text(item.regDt).end()
                                                    .find('.reply-btn').remove().end()
                                                    .find('.update-form-btn, .cmnt-delete-btn').data({'cmntid': (isRgtr ? item.cmntid : null)})
                                                    .prop({disabled:(isRgtr ? false : true)})
                                                    .css({display:(isRgtr ? 'block' : 'none')}).end()
                                                    .find('.reply-textarea > pre').text(item.cn).end()
                                                    .find('.dep02').remove().end()
                                            );
                                        }
                                    }
                                    const $replyInputClone = $replyCmntInput.clone(true);
                                    $cmntReplyWrap.append($replyInputClone.find('.cmnt-insert-btn').data({'parntsCmntid':parntsCmntid}).end());
                                    $cmntReplyWrap.closest('.dep02').append($replyMoreView.clone(true).find('button').remove().end());

                                    if(cmntReplyCnt > rowPerPage){
                                        $cmntReplyWrap.closest('.dep02').find('.relpy-more-view').prepend($replyMoreView.find('button').clone(true).data({'parntsCmntid':parntsCmntid}));
                                    }
                                    $this.addClass('active');
                                }else{
                                    alert('답글을 불러오는데 오류가 발생했습니다.');
                                }
                                closeWorkProgress();
                            }
                        });
                    }
                }else{
                    $cmntReplyWrap.children().remove();
                    $cmntReplyWrap.siblings('.relpy-more-view').remove();
                    $this.removeClass('active');
                }
            });
            //댓글 더보기
            $('.cmnt-wrap').on('click', '.more-btn', function (){
                const $this = $(this);
                const $pageIndex = $(this).siblings('#pageIndex');
                let pageNumber = Number($pageIndex.val());
                const pageSetNum = Number(pageNumber+1);
                const nextLimit = Number(pageSetNum*rowPerPage);
                if(displayWorkProgress(true)){
                    $.ajax({
                        type: 'POST',
                        url : "selectCmntReplyList.do",
                        data : {
                            pstid : pstid,
                            parntsCmntid : null,
                            rowPerPage : rowPerPage,
                            pageNumber : pageSetNum
                        },
                        success : function (result){
                            if(result.data != null){
                                for(let item of result.data){
                                    const $item = $commonCmnt.clone(true);
                                    const isRgtr = item.rgtrid === userid;
                                    $cmntWrap.append(
                                        $item.find('.profile').text(item.rgtrNm + ' (' + item.rgtrAcnt + ')').end()
                                            .find('.date').text(item.regDt).end()
                                            .find('.reply-btn').data({'parntsCmntid':item.cmntid}).end()
                                            .find('.update-form-btn, .cmnt-delete-btn').data({'cmntid': (isRgtr ? item.cmntid : null)})
                                            .prop({disabled:(isRgtr ? false : true)})
                                            .css({display:(isRgtr ? 'block' : 'none')}).end()
                                            .find('.reply-textarea > pre').text(item.cn).end()
                                    )
                                }
                                if(Number($replyLength.text()) <= nextLimit){ //nextLimit 보다 댓굴의 총개수가 작을 경우 더보기 버튼 필요없음
                                    $this.closest('.relpy-more-view').find('button').remove();
                                }
                                $pageIndex.val(Number(pageNumber+1)); //페이지 증가
                            }else{
                                alert('더보기를 불러오는데 오류가 발생했습니다.');
                            }
                            closeWorkProgress();
                        }
                    });
                }
            });
            //대댓글 더보기
            $('.cmnt-wrap').on('click', '.reply-more-btn', function (){
                const $this = $(this);
                const $pageIndex = $(this).siblings('#pageIndex');
                let pageNumber = Number($pageIndex.val());
                const $cmntReplyWrap = $(this).closest('.dep02').find('ul'); //대댓글의 경우
                const parntsCmntid = $(this).data('parntsCmntid'); //대댓글의 경우
                const pageSetNum = Number(pageNumber+1);
                const nextLimit = Number(pageSetNum*rowPerPage);
                if(displayWorkProgress(true)){
                    $.ajax({
                        type: 'POST',
                        url : "selectCmntReplyList.do",
                        data : {
                            pstid : pstid,
                            parntsCmntid : parntsCmntid,
                            rowPerPage : rowPerPage,
                            pageNumber : pageSetNum
                        },
                        success : function (result){
                            if(result.data != null){
                                let cmntReplyCnt = null;
                                for(let item of result.data){
                                    cmntReplyCnt = item.cmntReplyCnt;
                                    const $item = $commonCmnt.clone(true);
                                    const isRgtr = item.rgtrid === userid;
                                    $cmntReplyWrap.children().first().prepend(
                                        $item.find('.profile').text(item.rgtrNm + ' (' + item.rgtrAcnt + ')').end()
                                            .find('.date').text(item.regDt).end()
                                            .find('.reply-btn').remove().end()
                                            .find('.update-form-btn, .cmnt-delete-btn').data({'cmntid': (isRgtr ? item.cmntid : null)})
                                            .prop({disabled:(isRgtr ? false : true)})
                                            .css({display:(isRgtr ? 'block' : 'none')}).end()
                                            .find('.reply-textarea > pre').text(item.cn).end()
                                            .find('.dep02').remove().end()
                                    )
                                }
                                if(cmntReplyCnt <= nextLimit){ //nextLimit보다 댓굴의 총개수가 작을 경우 더보기 버튼 필요없음
                                    $this.closest('.relpy-more-view').find('button').remove();
                                }
                                $pageIndex.val(Number(pageNumber+1)); //페이지 증가
                            }else{
                                alert('더보기를 불러오는데 오류가 발생했습니다.');
                            }
                            closeWorkProgress();
                        }
                    });
                }
            });
        });
    </script>
</div>
</body>