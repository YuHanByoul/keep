<!DOCTYPE html>
<html
        xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
        layout:decorator="layout/front/subLayout">
<body>
<div layout:fragment="content">
    <th:block th:if="${cmntyInfo.mbrSttsCd eq '118100' and (bbsInfo.cmntyBbsTmplatid != 1 or cmntyInfo.authrtCd eq '117100')}">
        <form id="pstForm" name="pstForm">
            <input type="hidden" id="atchfileCnt" th:value="${bbsInfo.atchfileCnt}">
            <input type="hidden" id="atchfileSize" th:value="${bbsInfo.atchfileSize}">
            <input type="hidden" id="currentFileCnt" th:value="${currentFileCnt eq null ? 0 : currentFileCnt}">
            <input type="hidden" name="pstid" th:value="${paramVo.pstid}">
            <input type="hidden" name="bbsid" th:value="${paramVo.bbsid}">
            <input type="hidden" id="formType" th:value="${formType}">
            <div class="table-caption">
                <div class="left">
                    <h3 class="sub-title"><th:block th:text="${bbsInfo.nm + (formType eq 'INSERT' ? ' 등록' : ' 수정')}"></th:block></h3>
                </div>
                <div class="right">
                    <p class="desc"><span class="ast">*</span>표시는 필수 입력 정보입니다.</p>
                </div>
            </div>

            <div class="table-row table-row-mo">
                <table class="board-input">
                    <caption><span>게시글 작성</span></caption>
                    <colgroup>
                        <col style="width:140px;">
                        <col>
                        <col style="width:140px;">
                        <col>
                    </colgroup>
                    <tr>
                        <th scope="row"><label for="ttl">제목</label></th>
                        <td colspan="3">
                            <div class="form-input">
                                <input type="text" title="제목" placeholder="제목을 입력해주세요." id="ttl" name="ttl" th:value="${cmntyPstInfo.ttl}">
                            </div>
                            <div class="col">
                                <p class="feedback"></p>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${bbsInfo.fxNtcUseYn eq 'Y'}">
                        <th scope="row">공지여부</th>
                        <td colspan="3">
                            <div class="form-check-list">
                                <label class="inp"><input type="radio" name="fxNtcYn" value="Y" th:checked="${cmntyPstInfo.fxNtcYn eq 'Y'}"><b>사용</b></label>
                                <label class="inp"><input type="radio" name="fxNtcYn" value="N" th:checked="${cmntyPstInfo.fxNtcYn eq 'N' or cmntyPstInfo.fxNtcYn eq null}"><b>사용안함</b></label>
                            </div>
                            <div class="col">
                                <p class="feedback"></p>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${bbsInfo.fxNtcUseYn eq 'Y'}">
                        <th scope="row">공지 시작 일시<i class="ast" title="필수입력">*</i></th>
                        <td>
                            <div class="form-input">
                                <input type="datetime-local" title="시작일" id="fxNtcBgngDt" name="fxNtcBgngDt" th:value="${cmntyPstInfo.fxNtcBgngDt}">
                            </div>
                            <div class="col">
                                <p class="feedback"></p>
                            </div>
                        </td>
                        <th scope="row">공지 종료 일시<i class="ast" title="필수입력">*</i></th>
                        <td>
                            <div class="form-input">
                                <input type="datetime-local" title="종료일" id="fxNtcEndDt" name="fxNtcEndDt" th:value="${cmntyPstInfo.fxNtcEndDt}">
                            </div>
                            <div class="col">
                                <p class="feedback"></p>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><label for="cn">내용</label></th>
                        <td colspan="3">
                            <textarea cols="40" id="cn" name="cn" rows="5" placeholder="내용을 입력해주세요." title="내용입력" class="textarea" th:text="${cmntyPstInfo.cn}"></textarea>
                            <div class="col">
                                <p class="feedback"></p>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${bbsInfo.atchfileUseYn eq 'Y'}">
                        <th scope="row">첨부파일</th>
                        <td colspan="3">
                            <div class="form-input-file">
                                <span class="form-input">
                                    <input id="multiFileInput" name="files" type="file" multiple class="blind" title="파일첨부" maxcount="5" 
                                           th:attr="accept=${acceptUploadFileExt}">
                                </span>
                                <button class="btn-medium btn-gray" type="button" title="파일선택" onclick="javascript:$('#multiFileInput').click()">파일선택</button>
                                <!-- <label for="multiFileInput" class="btn-medium btn-gray">파일선택</label> -->
                                <ul id="multipleFileUploadSuccess">
                                    <th:block th:if="${fileMap ne null}" th:each="file : ${fileMap}">
                                        <li class="file-block" th:data_ext="${#strings.substring(file.fileExtsn,1)}" th:id="${file.fileid}">
                                        <span class="name">
                                            <a th:href="|javascript:downloadFileByFileid('${file.fileid}','${file.fileIdntfcKey}')|">   
                                                [[${file.orginlFileNm}]]
                                            </a>
                                        </span>
                                            <button type="button" class="file-delete" title="삭제" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                                                    th:onclick="|javascript:deleteFile(this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'))|">
                                                <span class="icon icon-circle-close"></span>
                                            </button>
                                        </li>
                                    </th:block>
                                </ul>
                                <input type="hidden" id="filegrpid" name="filegrpid" th:value="${cmntyPstInfo.filegrpid eq null ? 0 : cmntyPstInfo.filegrpid}"/>
                            </div>
                        </td>
                    </tr>
                    <!--<th:block  th:if ="${bbsInfo.clUseYn == 'Y'}">-->
                    <!--                            <tr>-->
                    <!--                                <th scope="row"><label for="title">분류</label></th>-->
                    <!--                                <td>-->
                    <!--                                    <fieldset>-->
                    <!--                                        <legend>-->
                    <!--                                            <span>검색</span>-->
                    <!--                                        </legend>-->

                    <!--                                        <div class="search-board-in">-->
                    <!--                                            <select title="구분" class="form-select" id="bbsClid" name="bbsClid">-->
                    <!--                                                <option value="">분류선택</option>-->
                    <!--                                                <th:block th:each="item : ${clList}">-->
                    <!--                                                    <option th:value="${item.bbsClid}"><th:block th:text="${item.clNm}"/></option>-->
                    <!--                                                </th:block>-->
                    <!--                                            </select>-->
                    <!--                                            <span class="form-msg"></span>-->
                    <!--                                        </div>-->
                    <!--                                    </fieldset>-->

                    <!--                                </td>-->
                    <!--                            </tr>-->
                    <!--</th:block>-->
                </table>
            </div>

            <div class="box-desc-list bg7 mt10">
                <ul>
                    <li>첨부 가능 확장자 :
                        <th:block>
                            <th:block th:each="item, itemStat : ${fileConfiguration.uploadFileExtsn}">
                                [[${item.value}]]
                                <th:block th:if="${!itemStat.last}">,&nbsp;</th:block>
                            </th:block>
                        </th:block>
                    </li>
                    <li>첨부 가능 개수 : [[${bbsInfo.atchfileCnt}]]개</li>
                    <li>첨부 가능 개별 용량 : [[${bbsInfo.atchfileSize}]]Mbyte</li>
                </ul>
            </div>

            <div class="btn-wrap">
                <div class="center">
                    <button th:if="${paramVo.pstid eq null}" type="button" class="btn-medium btn-gray list-btn" data-action="cmntyPstList.html">이전</button>
                    <button th:if="${paramVo.pstid ne null}" type="button" class="btn-medium btn-gray list-btn" data-action="cmntyPstView.html">이전</button>
                    <button th:if="${formType eq 'INSERT'}" type="button" class="btn-medium btn-blue save-btn">등록</button>
                    <button th:if="${formType eq 'MODIFY'}" type="button" class="btn-medium btn-blue save-btn">수정</button>
                </div>
            </div>
        </form>

        <form name="searchForm" id="searchForm">
            <input type="hidden" id="pageNumber" name="pageNumber" th:value="${paramVo.pageNumber}">
            <input type="hidden" id="rowPerPage" name="rowPerPage" th:value="${paramVo.rowPerPage}">
            <input type="hidden" id="searchType" name="searchType" th:value="${paramVo.searchType}">
            <input type="hidden" id="searchKeyword" name="searchKeyword" th:value="${paramVo.searchKeyword}">
            <input type="hidden" id="cmntyid" name="cmntyid" th:value="${cmntyid}">
            <input type="hidden" id="bbsid" name="bbsid" th:value="${paramVo.bbsid}">
            <input type="hidden" id="pstid" name="pstid" th:value="${paramVo.pstid}">
        </form>
    </th:block>

    <script src="/js/ckeditor/ckeditor.js"></script>
    <script th:inline="javascript">
    window.addEventListener('DOMContentLoaded', function (){
        let mbrSttsCd = /*[[${cmntyInfo.mbrSttsCd}]]*/null;
        let cmntyBbsTmplatid = /*[[${bbsInfo.cmntyBbsTmplatid}]]*/null;
        let authrtCd = /*[[${cmntyInfo.authrtCd}]]*/null;
        let operYn = /*[[${cmntyInfo.operYn}]]*/null;
        let useYn = /*[[${bbsInfo.useYn}]]*/null;
        let isMbr = mbrSttsCd === '118100';
        let isAdmin = cmntyBbsTmplatid !== 1 || authrtCd === '117100';
        let isOper = operYn === 'Y';
        let isUse = useYn === 'Y';

        if(!isMbr || !isAdmin){
            alert(!isMbr ? '게시글 등록은 가입전에는 입장하실 수 없습니다.':'공지시항은 관리자만 등록할 수 있습니다.');
            history.back();
        }
        if(!isOper || !isUse){
            alert(!isOper ? '미운영 동아리입니다.':'사용중인 게시판이 아닙니다.');
            history.back();
        }

        const $searchForm = $('#searchForm');
        const formType = $('#formType').val();
        const $fxNtcYn = $('input[name=fxNtcYn]');
        const $fxNtcBgngDt = $('input[name=fxNtcBgngDt]');
        const $fxNtcEndDt = $('input[name=fxNtcEndDt]');
        //에디터 엔터키 두줄 바꿈 제거 (shift + enter 처럼 바로 한줄 밑으로 떨어지게 함 )
        const editor = CKEDITOR.replace('cn', {enterMode: CKEDITOR.ENTER_BR});
        const atchfileCnt = $('#atchfileCnt').val();
        const atchfileSize = $('#atchfileSize').val();
        const $currentFileCnt = $('#currentFileCnt');

        fxNtcChProc();
        addFileUploadEvent('multiFileInput', 'cmntyPst_file', 'multipleFileUploadSuccess', atchfileCnt, atchfileSize, $currentFileCnt);

        $('input[name=fxNtcYn]').on('change', function(){
           fxNtcChProc();
        });

        $('.save-btn').on('click',function (){
            let editorData = editor.getData();
            $("#cn").val(editorData);
            validate();
            if (!$("#pstForm").valid()) return;
            if(confirm(formType === 'MODIFY' ? '수정하시겠습니까?' : '등록하시겠습니까?')){
                var data =  $("#pstForm").serialize();
                if(displayWorkProgress(true)) {
                    $.ajax({
                        method: 'post',
                        cache: false,
                        url: formType === 'MODIFY' ? 'updateCmntyPst.do' : 'insertCmntyPst.do',
                        data: data,
                        dataType: 'json',
                        success: function (response) {
                            alert(response.msg);
                            if (response.result) {
                                if(formType === 'MODIFY'){
                                    $searchForm[0].action = 'cmntyPstView.html';
                                    $searchForm[0].submit();
                                }else{
                                    $searchForm[0].action = 'cmntyPstList.html';
                                    $searchForm[0].submit();
                                }
                            }
                            closeWorkProgress();
                        }
                    })
                }
            }
        });

        $('.list-btn').on('click',function(){
            $searchForm[0].action = $(this).data('action');
            $searchForm[0].submit();
        });

        function fxNtcChProc(){
            if($fxNtcYn.filter(":checked").val() === 'N'){
                $fxNtcBgngDt.prop({disabled:true});
                $fxNtcEndDt.prop({disabled:true});
            }else{
                $fxNtcBgngDt.prop({disabled:false});
                $fxNtcEndDt.prop({disabled:false});
            }
        }
        function validate(){
            const fxNtcFg = $fxNtcYn.filter(":checked").val() === "Y";
            const rules =  {
                ttl      : { required: true , maxlength:100}
            }

            if (fxNtcFg) {
                rules.fxNtcBgngDt = {required: true, max: $fxNtcEndDt.val()};
                rules.fxNtcEndDt =  {required: true};
            }

            $("#pstForm").data('validator', null).validate({
                rules,
                messages: {
                    ttl      : { required: "제목을 입력해 주십시오."  , maxlength : "제목은 100자를 넘을 수 없습니다."  },
                    fxNtcBgngDt : { required: "공지시작일시를 입력해 주십시오.",max: "공지시작/종료일시를 올바르게 입력해 주십시오."},
                    fxNtcEndDt : { required: "공지종료일시를 입력해 주십시오."}
                }
            });
        }
    });
    </script>
</div>
</body>