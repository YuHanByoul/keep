<!DOCTYPE html>
<html
        xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
        layout:decorator="layout/front/subLayout">
<body>
<div layout:fragment="content">
    <div class="tab-content tab-sub dropDown">
        <button type="button" class="tab-mobile-trigger trigger" aria-haspopup="listbox" aria-expanded="true">전체 커뮤니티</button>
        <ul class="tab-list tab-list-pc target" role="tablist">
            <li class="tab" th:classappend="${cmntyVo.esterid eq null} ? 'active'"><a href="cmntyList.html" role="tab" aria-selected="true">전체 커뮤니티</a></li>
            <li class="tab" th:classappend="${cmntyVo.esterid ne null} ? 'active'"><a th:href="${'cmntyList.html?esterid='+ cmntyVo.user.userid}" role="tab">나의 환경동아리</a></li>
        </ul>
    </div>

    <div class="table-caption">
        <div class="right">
            <p class="desc"><span class="ast">*</span>표시는 필수 입력 정보입니다.</p>
        </div>
    </div>

    <form name="cmntyForm" id="cmntyForm">
        <div class="table-row table-row-mo">
            <table>
                <caption>커뮤니티 개설 - 커뮤니티명, 커뮤니티 사진, 커뮤니티 소개, 개설자, 가입승인 방식, 공개여부 설정, 검색 노출 동의 여부, 카테고리 설정</caption>
                <colgroup>
                    <col style="width:140px;">
                    <col>
                </colgroup>
                <tbody>
                <tr>
                    <th scope="row">커뮤니티명<i class="ast" title="필수입력">*</i></th>
                    <td>
                        <input name="cmntyNm" type="text" title="커뮤니티명">
                        <div class="col">
                            <p class="feedback"></p>
                        </div>
                    </td>
                </tr>
                <tr>
                    <th scope="row">커뮤니티 사진<i class="ast" title="필수입력">*</i></th>
                    <td>
                        <div class="form-input-file form-input-thumb">
                            <div class="form-input">
                                <div class="logo-image">
                                    <img src="" alt="" id="cmntyLogoImage">
                                    <span class="logo-text">LOGO IMAGE</span>
                                    <input type="hidden" id="cmntyLogoFileid" name="cmntyLogoFileid">
                                </div>
                                <label>
                                    <input id="cmntyLogo" name="cmntyLogo" type="file" class="blind" accept=".jpeg,.jpg,.png" title="파일첨부" maxcount="1">
                                    <span class="btn-medium btn-gray">파일선택</span>
                                </label>
                            </div>
                        </div>
                        <div class="col">
                            <p class="feedback"></p>
                        </div>
                        <p class="desc">* 로고사진 파일은 10MB 미만의 JPG, PNG, GIF파일만 업로드 가능</p>
                        <p class="desc">* 권장사이즈 : 가로 126px, 세로 40px</p>
                        
                    </td>
                </tr>
                <tr>
                    <th scope="row">커뮤니티 소개<i class="ast" title="필수입력">*</i></th>
                    <td>
                        <textarea name="cmntyIntrcn" title="커뮤니티 소개" placeholder="커뮤니티 소개를 입력해주세요."></textarea>
                        <div class="col">
                            <p class="feedback"></p>
                        </div>
                    </td>
                </tr>
                <tr>
                    <th scope="row">개설자</th>
                    <td th:text="${cmntyVo.user.nm}"></td>
                </tr>
                <tr>
                    <th scope="row">가입승인 방식</th>
                    <td>
                        <div class="form-check-list">
                            <label th:each="item : ${joinaprvmthdCdList}" class="inp"><input type="radio" name="joinaprvmthdCd" th:value="${item.cd}" checked="checked"><b th:text="${item.cdNm}"></b></label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <th scope="row">공개여부 설정</th>
                    <td>
                        <div class="form-check-list">
                            <label class="inp"><input type="radio" name="rlsYn" value="Y" checked="checked"><b>공개</b></label>
                            <label class="inp"><input type="radio" name="rlsYn" value="N"><b>비공개</b></label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <th scope="row">검색노출 동의 여부</th>
                    <td>
                        <div class="form-check-list">
                            <label class="inp"><input type="radio" name="srchExpsrYn" value="Y" checked="checked"><b>동의함</b></label>
                            <label class="inp"><input type="radio" name="srchExpsrYn" value="N"><b>동의하지 않음</b></label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <th scope="row">카테고리 설정</th>
                    <td>
                        <button type="button" class="btn-medium btn-green" data-layer-href="layer-popup10">카테고리 설정</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="btn-wrap">
            <div class="center">
                <button type="button" class="btn-medium btn-gray" onclick="fn_list()">목록</button>
                <button type="button" class="btn-medium btn-blue" onclick="fn_insert()">저장</button>
            </div>
        </div>
    </form>

    <div class="layer-popup layer-large" data-layer-id="layer-popup10">
        <div class="layer-dimmed" title="레이어팝업 닫기"></div>
        <div class="layer-wrap">
            <div class="layer-header">
                <strong class="tit">카테고리 설정 </strong>
                <button type="button" class="btn-layer-close" title="레이어팝업 닫기" data-layer-close=""></button>
            </div>
            <div class="layer-content">
                <div class="table-col">
                    <table>
                        <caption>카테고리 설정 - 카테고리명, 사용여부</caption>
                        <thead>
                        <tr>
                            <th scope="col">카테고리명</th>
                            <th scope="col">사용여부</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="item : ${tmplatList}">
                            <td th:text="${item.tmplatNm}"></td>
                            <td>
                                <div class="form-check-list j-center">
                                    <input type="hidden" name="tmplatIds" th:value="${item.cmntyBbsTmplatid}" />
                                    <label class="inp"><input type="radio" th:name="|useYn${item.cmntyBbsTmplatid}|" checked="checked" value="Y"><b>Y</b></label>
                                    <label class="inp"><input type="radio" th:name="|useYn${item.cmntyBbsTmplatid}|" value="N"><b>N</b></label>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="layer-footer">
                <div class="btn-wrap">
                    <div class="center">
                        <button type="button" class="btn-medium btn-gray" data-layer-close="">닫기</button>
                        <button type="button" class="btn-medium btn-green" data-layer-close="">저장</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form name="searchForm" action="cmntyList.html">
        <input type="hidden" name="pageNumber" th:value="${cmntyVo.pageNumber}" />
        <input type="hidden" name="rowPerPage" th:value="${cmntyVo.rowPerPage}" />
        <input th:if="${cmntyVo.esterid ne null}" type="hidden" name="esterid" th:value="${cmntyVo.esterid}" />
        <input type="hidden" name="searchKeyword" th:value="${cmntyVo.searchKeyword}" />
    </form>

    <script th:inline="javascript">
        var validator= $("#cmntyForm").validate({
            rules:{
                cmntyNm:{ required: true, maxlength: 20 },
                cmntyLogoFileid:{ required: true },
                cmntyIntrcn:{ required: true }
            },
            messages:{
                cmntyNm:{ required: "커뮤니티명을 입력 해주십시오.", maxlength: "커뮤니티명은 20자를 초과할 수 없습니다." },
                cmntyLogoFileid:{ required: "커뮤니티 사진을 등록해주세요." },
                cmntyIntrcn:{ required: "커뮤니티 소개를 입력 해주십시오." }
            }
        });

        function fn_list(){
            const $searchForm = $('[name=searchForm]');
            $searchForm[0].submit()
        }

        function fn_insert(){
            if($('#cmntyForm').valid()){
                let data = $('#cmntyForm').serialize();
                $('input[name=tmplatIds]').each(function (){
                    if($(this).siblings().find('input[name=useYn'+$(this).val()+']:checked').val() === 'Y'){
                        data += '&tmplatIds='+$(this).val();
                    }
                });
                if(displayWorkProgress(true)){
                    $.ajax({
                        url : "insertCmnty.do",
                        type: 'POST',
                        cache : false,
                        dataType: 'json',
                        data : data,
                        success : function (data){
                            alert(data.msg);
                            if(data.result=="success"){
                                fn_list();
                            }
                            closeWorkProgress();
                        }
                    });
                }
            }
        }

        $('#cmntyLogo').on("change", function (event) {
            var objFile = event.target;
            var formData = new FormData();

            formData.append("file", objFile.files[0]);
            formData.append("filegrpNm", "cmnty_logo");

            if (displayWorkProgress(true)) {
                $.ajax({
                    url: '/registFile.do',
                    processData: false,
                    contentType: false,
                    data: formData,
                    type: 'POST',
                    success: function (response) {
                        if (response.result == 'fail') {
                            alert(response.msg);
                        }else if(response.filegrpid != undefined && response.filegrpid != ''){
                            $("#cmntyLogoFileid").val(response.fileid);
                            $("#cmntyLogoImage").attr("src",`/downloadFileByFileid.do?fileid=${response.fileid}&file_idntfc_key=${response.fileIdntfcKey}`);
                        }
                        closeWorkProgress();
                    }
                });
                $("#cmntyLogo").val("");
            }
        });
    </script>
</div>
</body>