<style>
    #canvas {
      width: 100%;
    }
</style>

    <!-- [íŒì—…] ê°œì²´ì„ íƒ -->
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content type_2">
            <div class="modal-header">
                <h4 class="modal-title">ê°œì²´ì„ íƒ</h4>
                <button type="button" class="btn-close" onclick="closeQRModal()">
                    <span aria-hidden="true"></span>
                </button>
            </div>
            <div class="modal-body">
            
                <div class="card m-b-10">
                    <div class="card-header pt-2 p-b-0">
                        <ul class="nav nav-tabs tabs mo-only" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#tap01" role="tab" onclick="startQR()" >QR ìŠ¤ìº”</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tap02" role="tab" onclick="stopQR()" >ì§ì ‘ ì„ íƒ</a>
                            </li>
                        </ul>
                    </div>
                    <div class="tab-content tabs">
                        <div class="tab-pane active" id="tap01" role="tabpanel">
                            <div class="card-block">
                                <div class="text-center p-b-20">
                                  <div id="loadingMessage">ğŸ¥ ì¹´ë©”ë¼ì— ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.<br/>(ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì„ í™œì„±í™” ì‹œì¼œì£¼ì‹­ì‹œì˜¤.)</div>
								  <canvas id="canvas" hidden></canvas>
								  <div id="output" hidden>
								    <div id="outputMessage">No QR code detected.</div>
								    <div hidden><b>Data:</b> <span id="outputData"></span></div>
								  </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane" id="tap02" role="tabpanel">
                        <form id="packSearchForm">
                            <div class="card-block pt-0">
                                <ul class="desc-list" id="packListArea" style="width: 100%; max-height:400px; overflow-y: scroll;">
                                </ul>
                            </div>
                        </form>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
</div>

<!-- //[íŒì—…] ê°œì²´ì„ íƒ -->
<script type="text/javascript" src="/js/jsQR/jsQR.js"></script>
<script src="/js/common/handlebars/handlebars-v4.7.7.js"></script>   
<script src="/js/common/handlebars/handlebars.helper.js"></script>

<script type="text/javascript">
    // ìŠ¤ìº”
    var videoPlay = null;
    var video = document.createElement("video");        
    var canvasElement = document.getElementById("canvas");
    var canvas = canvasElement.getContext("2d");
    var loadingMessage = document.getElementById("loadingMessage");
    var outputContainer = document.getElementById("output");
    var outputMessage = document.getElementById("outputMessage");
    var outputData = document.getElementById("outputData");
        
    function startScan() {

        function drawLine(begin, end, color) {
            canvas.beginPath();
            canvas.moveTo(begin.x, begin.y);
            canvas.lineTo(end.x, end.y);
            canvas.lineWidth = 4;
            canvas.strokeStyle = color;
            canvas.stroke();
        }

        // ì¹´ë©”ë¼ ì‚¬ìš©ì‹œ
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
                video.srcObject = stream;
                video.setAttribute("playsinline", true);      // iOS ì‚¬ìš©ì‹œ ì „ì²´ í™”ë©´ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒì„ ì „ë‹¬
                video.play();
                requestAnimationFrame(tick);
        });

        function tick() {
            loadingMessage.innerText = "âŒ› ìŠ¤ìº” ê¸°ëŠ¥ì„ í™œì„±í™” ì¤‘ì…ë‹ˆë‹¤."

            if(video.readyState === video.HAVE_ENOUGH_DATA) {
                loadingMessage.hidden = true;
                canvasElement.hidden = false;
                //outputContainer.hidden = false;

                // ì½ì–´ë“¤ì´ëŠ” ë¹„ë””ì˜¤ í™”ë©´ì˜ í¬ê¸°
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                
                var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                var code = jsQR(imageData.data, imageData.width, imageData.height, {
                                inversionAttempts : "dontInvert",
                });
                
                // QRì½”ë“œ ì¸ì‹ì— ì„±ê³µí•œ ê²½ìš°
                if(code) {
                    // ì¸ì‹í•œ QRì½”ë“œì˜ ì˜ì—­ì„ ê°ì‹¸ëŠ” ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì§€ëŠ” í…Œë‘ë¦¬ ìƒì„±
                    drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF0000");
                    drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF0000");
                    drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF0000");
                    drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF0000");
                    //outputMessage.hidden = true;
                    //outputData.parentElement.hidden = false;
                    getQrData(code.data)
                    // returnì„ ì¨ì„œ í•¨ìˆ˜ë¥¼ ë¹ ì ¸ë‚˜ê°€ë©´ QRì½”ë“œ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œëœë‹¤.
                    return;
                }
                // QRì½”ë“œ ì¸ì‹ì— ì‹¤íŒ¨í•œ ê²½ìš°
                else {
                    //outputMessage.hidden = false;
                    //outputData.parentElement.hidden = true;
                    console.log("failed");
                }
            }
            videoPlay = requestAnimationFrame(tick);
        }
    }
    function closeQRModal(){
    	stopQR();
    	lendModal.hide();
    }
    function startQR(){
    	startScan();
    }
    function stopQR(){
    	cancelAnimationFrame(videoPlay);
    }
</script>
<script id="packListTemplate" type="text/x-handlebars-template">
  {{#each packList}}
  <li>
      <h5><strong><a href="javascript:choosePackageindvd('{{packageindvdid}}','{{indvdno}}')" class="stretched-link">{{packageindvdNm}}({{indvdno}})</a></strong></h5>
      <dl>
          <dt>ìƒíƒœ :</dt>
          <dd>[{{sttsCdNm}}] [{{prductSttsCdNm}} ê¾¸ëŸ¬ë¯¸]</dd>
      </dl>
  </li>
  {{/each}}
</script>

<script th:inline="javascript">

	/*<![CDATA[*/
	 var params =/*[[${params}]]*/null;
	/*]]>*/
	
	var noDataMeg = '<li style="padding-top:25px; text-align:center;"><h5><strong>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</a></strong></h5></li>';
    var packListTemplet = Handlebars.compile($("#packListTemplate").html());
    $(function(){
    	startQR();
    	selectPackList();
    });
    
    function selectPackList() {
        if (displayWorkProgress()){
            $.ajax({
                url : "/mng/eduResrce/selectPackageindvdList.do", 
                cache : false,
                dataType : 'json',
                data : {packageid : lendAplyInfo.packageid},
                success : function(data) {
                    $("#packListArea").html("");
                    if(data.totalCount == 0) {
                        $("#packListArea").html(noDataMeg);
                    }else{
                        renderingPackListData(data.list);
                    }
                    closeWorkProgress();
                }
            });
        }
    }
    function renderingPackListData(list){
        $("#packListArea").append(packListTemplet({packList:list}));
    }
    function getQrData(data){
        if(data==null || data=="undefined" || !data.includes('/')){
            alert("QR ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ì¸ì‹ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n ë‹¤ì‹œ ìŠ¤ìº” í•´ì£¼ì‹­ì‹œì˜¤");
            cancelAnimationFrame(videoPlay);
            startScan();
            return;
        }
        var dataArr = data.split("/");
        choosePackageindvd(dataArr[0],dataArr[1]);
    }
    
    function choosePackageindvd(packageindvdid,indvdno){

    	var targetVal = $("#packageindvd"+params.ordr).val();
        if( targetVal!= null && targetVal!="" && targetVal > 0) {return;}
        
    	var selectedVal1 = $("#packageindvd1").val();
    	var selectedVal2 = $("#packageindvd2").val();
    	
    	if(selectedVal1 == packageindvdid || selectedVal2 == packageindvdid){
            alert("ì´ë¯¸ ì„ íƒ ëœ ê¾¸ëŸ¬ë¯¸ ê°œì²´ì…ë‹ˆë‹¤.");
            return;	
        }
        
        if(displayWorkProgress()){
            $.ajax({
                url : "/mng/eduResrce/checkPackageindvdValidation.do", 
                cache : false,
                dataType : 'json',
                data : { packageid       : lendAplyInfo.packageid
                         ,rndid          : lendAplyInfo.rndid
                         ,packageindvdid : packageindvdid 
                       },
                success : function(data) {
                    
                    if(data.isOtherPackageYn == 'Y') {
                        alert("ì‹ ì²­ ê¾¸ëŸ¬ë¯¸ì˜ ê°œì²´ê°€ ì•„ë‹™ë‹ˆë‹¤.");
                        startQR();
                    }if(data.duplicationPackInSameRndYn == 'Y') {
                        alert("ë™ì¼ ëŒ€ì—¬ëª¨ì§‘ ì°¨ì‹œì— ì´ë¯¸ ìŠ¹ì¸ëœ ê¾¸ëŸ¬ë¯¸ ê°œì²´ì…ë‹ˆë‹¤.");
                        startQR();
                    }else{
                        var packageindvdStr  = '<span class="label label-inverse" id="packOrd'
                            packageindvdStr += params.ordr+'">'+indvdno
                            packageindvdStr += '<a href="javascript:removePackageIndvd('+params.ordr+')" class="text-white">X</a></span>';
	                    $("#packageindvd"+params.ordr).val(packageindvdid);
	                    $("#packageSpan"+params.ordr).append(packageindvdStr);
                        closeQRModal();
                    }
                    closeWorkProgress();
                }
            });
        }
    }
</script>




