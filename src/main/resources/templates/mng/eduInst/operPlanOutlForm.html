<div class="card">
    <form id="operPlanOutlForm">
        <input type="hidden" id="aplyid" name="aplyid" th:value="${planOutlInfo.aplyid}"/>
        <input type="hidden" id="planKey" name="planKey" th:value="${planOutlInfo.planKey}"/>
        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>기관·단체의 설립목적 및 주요사업</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="form-group mb-3 required">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>기관·단체의 설립목적 및 주요사업</strong></label>
                <div class="col-sm-12">
                    <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="500자 이하의 기관·단체의 설립목적 및 주요사업 표시" id="mainBsns" name="mainBsns">[[${planOutlInfo.mainBsns}]]</textarea>
                    <p class="feedback"></p>
                </div>
            </div>
            <div class="form-group mb-3 required">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>증빙서류</strong></label>
                <div class="col-sm-12">
                    <input id="multiFileInput" type="file" name="files" multiple="multiple"
                           accept=".jpeg,.jpg,.png,.gif,.tif,.tiff,.hwp,.hwpx,.pdf,.ppt,.pptx,.doc,.docx,.xls,.xlsx,.zip" class="form-control form-control-sm"/>
                    <input type="hidden" id="atchFilegrpid" name="atchFilegrpid"
                           th:value="${(planOutlInfo.atchFilegrpid == '' or planOutlInfo.atchFilegrpid == null) ? 0 : planOutlInfo.atchFilegrpid}"/>
                </div>
                <div class="mt-2 row">
                    <div class="col-auto">
                        <th:block th:if="${fileList != null}">
                            <th:block th:if="${fileList != null}">
                                <th:block th:each="item : ${fileList}" th:id="${item.fileid}">
                                    <th:block th:if="${item.orginlFileNm != null}">
                                    <span th:fileid='${item.fileid}'
                                          th:fileIdntfcKey="${item.fileIdntfcKey}"
                                          th:onclick="downloadFileByFileid(this.getAttribute('fileid'),this.getAttribute('fileIdntfcKey'))"
                                          href="javascript:void(0)" class='label label-inverse'>
                                        <th:block th:text="${item.orginlFileNm}"/> <a
                                            th:name="${item.fileid}"
                                            th:attr="data-idntfc-key=${item.fileIdntfcKey}"
                                            th:onclick="fn_deleteFileList(this.name, this.dataset.idntfcKey)"
                                            class='text-white'> <th:block th:text="X"></th:block></a>
                                    </span>
                                    </th:block>
                                </th:block>
                            </th:block>
                        </th:block>
                        <div id="multipleFileUploadError"></div>
                        <div id="multipleFileUploadSuccess"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-header p-t-0 p-b-0">
            <h3 class="sub-title"><strong>운영계획</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="form-group mb-3 required">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>교육 운영방안</strong></label>
                <div class="col-sm-12">
                    <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="500자 이하의 교육 운영방안 표시" id="operMthd"
                              name="operMthd">[[${planOutlInfo.operMthd}]]</textarea>
                    <p class="feedback"></p>
                </div>
            </div>
            <div class="form-group mb-3">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>세부 운영계획</strong></label>
                <div class="col-sm-12">
                    <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="500자 이하의 세부 운영계획을 입력해 주세요." id="operPlan" name="operPlan">[[${planOutlInfo.operPlan}]]</textarea>
                    <p class="feedback"></p>
                </div>
            </div>
            <div class="form-group mb-3">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>참가자 모집 및 홍보, 관리 계획</strong></label>
                <div class="col-sm-12">
                    <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="500자 이하의 참가자 모집 및 홍보, 관리 계획 표시" id="mngPlan" name="mngPlan">[[${planOutlInfo.mngPlan}]]</textarea>
                    <p class="feedback"></p>
                </div>
            </div>
        </div>
        <div class="card-header p-t-0 p-b-0">
            <h3 class="sub-title"><strong>소요예산 확보 방안 및 집행계획</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="form-group mb-3 required">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>소요예산 확보 방안 및 집행계획</strong></label>
                <div class="col-sm-12">
                    <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="500자 이하의 소요예산 확보 방안 및 집행계획 표시" id="bgtPlan" name="bgtPlan">[[${planOutlInfo.bgtPlan}]]</textarea>
                    <p class="feedback"></p>
                </div>
            </div>
        </div>
        <div class="card-header p-t-0 p-b-0">
            <h3 class="sub-title"><strong>기대효과</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="form-group mb-3 required">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>기대효과</strong></label>
                <div class="col-sm-12">
                    <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="500자 이하의 기대효과 표시" id="expcEffect"
                              name="expcEffect">[[${planOutlInfo.expcEffect}]]</textarea>
                    <p class="feedback"></p>
                </div>
            </div>
        </div>
        <div class="card-header p-t-0 p-b-0">
            <h3 class="sub-title"><strong>기타자료</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="form-group mb-3">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>기타자료</strong></label>
                <div class="col-sm-12">
                    <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="500자 이하의 기타자료 표시" id="etcDta" name="etcDta">[[${planOutlInfo.etcDta}]]</textarea>
                    <p class="feedback"></p>
                </div>
            </div>
        </div>
        <div class="card-block-small">
            <button type="button" class="btn btn-disabled" onclick="gridHelper1.toggleContent();">취소</button>
            <button type="button" class="btn btn-primary" onclick="fn_insertOperPlanOutlInfo()" id="saveBtn">저장</button>
        </div>
    </form>
</div>
<script type="text/javascript">
    var insertUrl = "/mng/eduInst/insertOperPlan.do";
    var updateUrl = "/mng/eduInst/updateOperPlan.do";
    var uploadFileCnt = 0;

    function fn_insertOperPlanOutlInfo() {
        if (!$("#operPlanOutlForm").valid()) return;

        if($('#operPlanOutlForm #atchFilegrpid').val() == 0) {
            alert('증빙서류를 첨부해 주십시오.');
            showErrorMark('#operPlanOutlForm #multiFileInput');
            return;
        }

        if (!confirm("저장하시겠습니까?")) return;
        var key = $("#planKey").val();
        var url = "";
        if (key == null || key == 0 || key == '') {
            url = insertUrl;
            $("#sttsCd").val("248101");    //작성중
        } else {
            url = updateUrl;
        }

        var param = {};

        param = $("#operPlanOutlForm").serializeArray();

        if (displayWorkProgress()) {
            $.ajax({
                url: url,
                type: 'POST',
                cache: false,
                dataType: 'json',
                data: param,
                success: function (data) {
                    if (data.result == "success") {
                        alert(data.msg);
                        gridHelper1.resetPageContent();
                    } else {
                        alert(data.msg);
                    }
                    closeWorkProgress();
                }
            });
        }
    }


    $(function () {
        var validator = $("#operPlanOutlForm").validate({
            rules: {
                mainBsns: {required: true, maxlength: 500}
                , operMthd: {required: true, maxlength: 500}
                , operPlan: {maxlength: 500}
                , mngPlan: {maxlength: 500}
                , bgtPlan: {required: true, maxlength: 500}
                , expcEffect: {required: true, maxlength: 500}
                , etcDta: {maxlength: 500}
            },
            messages: {
                mainBsns: {required: "기관·단체의 설립목적 및 주요사업을 입력해 주십시오.", maxlength: "기관·단체의 설립목적 및 주요사업은 500자 이하여야 합니다."}
                , operMthd: {required: "교육 운영방안을 입력해 주십시오.", maxlength: "교육 운영방안은 500자 이하여야 합니다."}
                , operPlan: {maxlength: "세부 운영계획은 500자 이하여야 합니다."}
                , mngPlan: {maxlength: "참가자 모집 및 홍보, 관리계획은 500자 이하여야 합니다."}
                , bgtPlan: {required: "소요예산 확보 방안 및 집행계획을 입력해 주십시오.", maxlength: "소요예산 확보 방안 및 집행계획은 500자 이하여야 합니다."}
                , expcEffect: {required: "기대효과를 입력해 주십시오.", maxlength: "기대효과는 500자 이하여야 합니다."}
                , etcDta: {maxlength: "기타자료는 500자 이하여야 합니다."}
            }
        })

        // 파일업로드
        $('#operPlanOutlForm #multiFileInput').on("change", function (event) {
            //var fileOjbId = $(this).prop("id");
            //var objFile = document.querySelector('#'+fileOjbId);
            var objFile = document.querySelector('#operPlanOutlForm #multiFileInput');
            var formData = new FormData();
            var content = "";
            for (i = 0; i < objFile.files.length; i++) {
                if (uploadFileCnt >= atchfileCnt) {
                    alert("첨부파일은  " + atchfileCnt + " 개 까지 가능합니다.");
                    break;
                } else {
                    formData.append("files", objFile.files[i]);
                    uploadFileCnt++;
                }
            }

            formData.append("filegrpid", $("#operPlanOutlForm #atchFilegrpid").val());
            formData.append("filegrpNm", "eduInst_file");

            if (uploadFileCnt > 0) {
                $.ajax({
                    url: '/uploadMultipleFiles.do',
                    processData: false,
                    contentType: false,
                    data: formData,
                    type: 'POST',
                    success: function (response) {
                        if (response.result == 'fail') {
                            alert(response.msg);
                        } else {
                            if ($("#atchFilegrpid").val() == '0' || $("#atchFilegrpid").val() == '' || $("#atchFilegrpid").val() == null) {
                                $("#atchFilegrpid").val(response[0].filegrpid);
                            }

                            for (i = 0; i < response.length; i++) {
                                content = "<span id='" + response[i].fileid + "' class='label label-inverse' href=javascript:downloadFileByFileid('" + response[i].fileid + "','" + response[i].fileIdntfcKey + "')>" + response[i].orginlFileNm
                                content += "&nbsp;&nbsp;<a href='javascript:void(0)' onclick =uploadFileCnt--;fn_deleteFileList('" + response[i].fileid + "','" + response[i].fileIdntfcKey + "') class='text-white'>X</a></span>"
                                $('#operPlanOutlForm #multipleFileUploadSuccess').append(content);
                            }
                        }
                    }
                });
            }
        });
    });

    // 파일삭제
    function fn_deleteFileList(fileid, fileIdntfcKey) {
        if (!confirm("파일을 삭제하시겠습니까?")) {
            return;
        }
        fn_deleteFile(fileid, fileIdntfcKey);
        $("#" + fileid).remove();
//            $("#sftyMngMnlFile").val("");
    }

    // 파일삭제
    function fn_deleteFile(fileid, fileIdntfcKey) {
        var deleteFileUrl = "/deleteFile.do?fileid=" + fileid + "&file_idntfc_key=" + fileIdntfcKey;
        $.ajax({
            url: deleteFileUrl,
            type: 'GET',
            cache: false,
            dataType: 'json',
            success: function (data) {
                console.log(data);
                if (data.result == "success") {
                    $("#" + fileid).remove();
                    alert("파일삭제가 완료 되었습니다.");
                } else {
                    alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                }
            },
            error: function (error) {
            }
        })
    };
</script>