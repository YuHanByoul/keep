<div class="card">
    <form id="mnPwrSttusForm" >
        <input type="hidden"  id="aplyid" name="aplyid" th:value="${eduInstVo.aplyid}" />
        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>교육전문인력 현황</strong></h3>
        </div>
        <div class="card-block-small p-t-0" id="exprtListDiv">
            <div class="row" th:id="'exprtDiv'+${i.count}" th:if="${#lists.size(eduExprtList) > 0}" th:each="exprt, i: ${eduExprtList}">
                <input type="hidden" name="hdofBgngDe" th:id="'hdofBgngDe'+${i.count}" th:value="${exprt.hdofBgngDe}" />
                <input type="hidden" name="hdofEndDe" th:id="'hdofEndDe'+${i.count}" th:value="${exprt.hdofEndDe}" />
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>구분</strong></div>
                        <div class="col-sm-12">
                            <span kattr:select_code="seCd" th:attr='grpcd=249,selectedCd=${exprt.seCd}' firstOptTxt="- 선택 -" addClass="form-select form-select-sm form-control-sm"></span>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>성명</strong></label>
                        <div class="col-sm-12">
                            <input type="text"class="form-control form-control-sm" title="성명" placeholder="성명을 입력해 주세요." maxlength="60" id="nm" name="nm" th:value="${exprt.nm}">
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>생년월일</strong></label>
                        <div class="col-sm-12">
                            <input type="date" class="form-control form-control-sm" title="생년월일" placeholder="생년월일을 입력해 주세요." maxlength="10" id="brdt" name="brdt" th:value="${exprt.brdt}">
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>담당업무</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" title="담당업무" placeholder="담당업무을 입력해 주세요." maxlength="100" id="chrgtask" name="chrgtask" th:value="${exprt.chrgtask}">
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>소지자격증</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" title="소지자격증" placeholder="소지자격증을 입력해 주세요." maxlength="100" id="crtfct" name="crtfct" th:value="${exprt.crtfct}">
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>재직기간</strong></label>
                        <div class="col-sm-12">
                            <input type="text" id="hdofDe" name="hdofDe" class="form-control form-control-sm icon-date" th:value="${exprt.hdofDe}">
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>주요경력</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" title="주요경력" placeholder="주요경력을 입력해 주세요." maxlength="200" id="career" name="career" th:value="${exprt.career}">
                        </div>
                    </div>
                </div>
                <div class="col-12 mb-3">
                    <div class="form-group mb-0">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>증빙서류</strong></label>
                        <div class="col-sm-12">
                            <input th:id="'multiFileInput'+${i.count}" type="file" th:name="'files'+${i.count}" multiple="multiple" accept=".jpeg,.jpg,.png,.gif,.tif,.tiff,.hwp,.hwpx,.pdf,.ppt,.pptx,.doc,.docx,.xls,.xlsx,.zip" class="form-control form-control-sm" maxcount="10"/>
                            <input type="hidden" th:id="'atchFilegrpid'+${i.count}" th:name="'atchFilegrpid'+${i.count}" th:value="${(exprt.atchFilegrpid == '' or exprt.atchFilegrpid == null) ? 0 : exprt.atchFilegrpid}"/>
                        </div>
                        <div class="mt-2 row">
                            <div class="col-auto">
                                <th:block th:if="${exprt.fileList != null}">
                                    <th:block th:if="${exprt.fileList != null}">
                                        <th:block th:each="item : ${exprt.fileList}" th:id="${item.fileid}">
                                            <th:block th:if="${item.orginlFileNm != null}">
                                        <span th:fileid='${item.fileid}'
                                              th:fileIdntfcKey="${item.fileIdntfcKey}"
                                              th:onclick="downloadFileByFileid(this.getAttribute('fileid'),this.getAttribute('fileIdntfcKey'))"
                                              href="javascript:void(0)" class='label label-inverse'>
                                            <th:block th:text="${item.orginlFileNm}" /> <a
                                                th:name="${item.fileid}"
                                                th:attr="data-idntfc-key=${item.fileIdntfcKey}"
                                                th:onclick="fn_deleteFileList(this.name, this.dataset.idntfcKey)"
                                                class='text-white'> <th:block th:text="X"></th:block></a>
                                        </span>
                                            </th:block>
                                        </th:block>
                                    </th:block>
                                </th:block>
                            </div>
                            <div id="multipleFileUploadError"></div>
                            <div th:id="'multipleFileUploadSuccess'+${i.count}"></div>
                        </div>
                    </div>
                </div>
                <div th:id="'buttonDiv'+${i.count}" class="row mx-0 btn-group-sm mb-4">
                    <button type="button" class="btn btn-inverse col" onclick="delRow()" th:if="${i.count > 1}">삭제</button>
                    <button type="button" class="btn btn-primary col" onclick="addRow()">추가</button>
                </div>
            </div>
        </div>
        <div class="card-block-small">
            <button type="button" class="btn btn-disabled" onclick="gridHelper1.toggleContent();">취소</button>
            <button type="button" class="btn btn-primary" onclick="fn_insertMnPwrSttusInfo()" id="saveBtn">저장</button>
        </div>
    </form>
</div>
<script th:inline="javascript">

    var insertUrl="/mng/eduInst/insertEduExprt.do";

    $("input[name='hdofDe']").daterangepicker({
        autoUpdateInput: false,
        locale: {
            format: "YYYY-MM-DD",
        },
    });

    $("input[name^='hdofDe']").on('apply.daterangepicker', function(ev, picker) {
        $(this).parent().parent().parent().parent().find("[name=hdofBgngDe]").val(picker.startDate.format('YYYY-MM-DD'));
        $(this).parent().parent().parent().parent().find("[name=hdofEndDe]").val(picker.endDate.format('YYYY-MM-DD'));
        $(this).val(picker.startDate.format('YYYY-MM-DD') + ' ~ ' + picker.endDate.format('YYYY-MM-DD'));
    });

    var uploadFileCnt = 0;

    function addRow() {
        var lastRow = $('#exprtListDiv div[id^="exprtDiv"]:last');
        var idx = lastRow.index() + 2;

        if ($('#exprtListDiv div[id^="exprtDiv"]').length >= 2) {
            alert("최대 2행까지만 추가 가능합니다.");
            return false;
        }
        var newRow = lastRow.clone(true).attr('id', 'exprtDiv' + idx);

        newRow.find('input').val('');
        newRow.find('[id^=atchFilegrpid]').val(0);
        newRow.find('select').val('');
        newRow.find('[id^=multipleFileUploadSuccess] span').remove();
        newRow.find('.col-auto .label-inverse').each(function() {
            $(this).remove();
        });

        newRow.find('[id^=buttonDiv]').each(function() {
            $(this).remove();
        });

        newRow.find('[id^=multiFileInput]').attr('id','multiFileInput' + idx);
        newRow.find('[id^=multiFileInput]').attr('name','files' + idx);
        newRow.find('[id^=multipleFileUploadSuccess]').attr('id','multipleFileUploadSuccess' + idx);
        newRow.find('[id^=atchFilegrpid]').attr('id','atchFilegrpid' + idx);
        newRow.find('[id^=atchFilegrpid]').attr('name','atchFilegrpid' + idx);

        //lastRow.after(newRow);
        lastRow.after(newRow);
        //lastRow.parent().append(newRow);

        if ($('#exprtListDiv div[id^="exprtDiv"]').length == 2) {
            $('#exprtListDiv div[id^="exprtDiv"]:last').after(`<div id="buttonDiv"+ idx class="row mx-0 btn-group-sm mb-4">
                        <button type="button" class="btn btn-inverse col" onclick="delRow()">삭제</button>
                        <button type="button" class="btn btn-primary col" onclick="addRow()">추가</button>
                    </div>`);
        }else if($('#exprtListDiv div[id^="exprtDiv"]').length < 2){
            $('#exprtListDiv div[id^="exprtDiv"]:last').after(`<div id="buttonDiv"+ idx class="row mx-0 btn-group-sm mb-4">
                        <button type="button" class="btn btn-primary col" onclick="addRow()">추가</button>
                    </div>`);
        }

        $(document).find("input[name^=hdofDe]").removeClass('hasDaterangepicker').daterangepicker({
            autoUpdateInput: false,
            locale: {
                format: "YYYY-MM-DD",
            },
        });
        $(document).find("input[name^=hdofDe]").on('apply.daterangepicker', function(ev, picker) {
            $(this).val(picker.startDate.format('YYYY-MM-DD') + ' ~ ' + picker.endDate.format('YYYY-MM-DD'));
        });

    }

    function delRow(){
        var lastRow = $('#exprtListDiv div[id^="exprtDiv"]:last');
        if(lastRow.index() > 0) {
            lastRow.remove();
            $('#buttonDiv').remove();
        }

    }

    function fn_insertMnPwrSttusInfo(){
        if(!$("#mnPwrSttusForm").valid())return;
        var param = {};

        if(!confirm("저장하시겠습니까?")) return;

        var exprtList = [];
        $('#exprtListDiv div[id^="exprtDiv"]').each(function(index, value){
            var nm         = $(this).find('input[name="nm"]').val();
            var seCd       = $(this).find('select[name=seCd]').val();
            var brdt       = $(this).find('input[name="brdt"]').val();
            var chrgtask   = $(this).find('input[name="chrgtask"]').val();
            var crtfct     = $(this).find('input[name="crtfct"]').val();
            var hdofBgngDe = $(this).find('input[name="hdofBgngDe"]').val();
            var hdofEndDe  = $(this).find('input[name="hdofEndDe"]').val();
            var career     = $(this).find('input[name="career"]').val();
            var atchFilegrpid = $(this).find('[id^="atchFilegrpid"]').val();
            exprtList.push({nm:nm, seCd:seCd, brdt:brdt, chrgtask:chrgtask, crtfct:crtfct, hdofBgngDe:hdofBgngDe, hdofEndDe:hdofEndDe, career:career,atchFilegrpid:atchFilegrpid});
        });

        param = {
            aplyid: $("#aplyid").val(),
            eduExprtList: exprtList
        };
        if(displayWorkProgress()){
            $.ajax({
                url : insertUrl,
                type: 'POST',
                cache : false,
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(param),
                success : function (data){
                    if(data.result=="success"){
                        alert(data.msg);
                        gridHelper1.resetListContent();
                    }else{
                        alert(data.msg);
                    }
                    closeWorkProgress();
                }
            });
        }
    }

    $(function(){
        var validator= $("#mnPwrSttusForm").validate({
            rules: {
                nm        : {isBlank:true , maxlength: 60}
                ,chrgtask  : { maxlength: 100}
                ,crtfct    : { maxlength: 100}
                ,career    : { maxlength: 200}
                ,brdt : {maxlength: 10}
                ,hdofBgngDe: {maxlength: 10}
                ,hdofEndDe: {maxlength: 10}
            },
            messages: {
                nm         : { isBlank : "입력값에 공백이 있습니다." , maxlength: "이름은 60자 이하여야 합니다."}
                ,chrgtask   : { maxlength: "담당업무는 100자 이하여야 합니다."}
                ,crtfct     : { maxlength: "소지자격증은 100자 이하여야 합니다."}
                ,career     : { maxlength: "주요경력은 200자 이하여야 합니다."}
                ,brdt : {maxlength: '생년월일은 10자 이하여야 합니다.'}
                ,hdofBgngDe: {maxlength: '재직 시작 일자는 10자 이하여야 합니다.'}
                ,hdofEndDe: {maxlength: '재직 종료 일자는 10자 이하여야 합니다.'}
            }
        })
        // 파일업로드
        $('#mnPwrSttusForm [id^=multiFileInput]').on("change", function(event) {
            //var fileOjbId = $(this).prop("id");
            //var objFile = document.querySelector('#'+fileOjbId);

            var objFile = document.querySelector('#'+this.id);
            var no = this.id.replace('multiFileInput','');

            var formData = new FormData();
            var content = "";
            uploadFileCnt = 0;

            for( i = 0 ; i < objFile.files.length ; i++) {

                formData.append("files", objFile.files[i]);

                uploadFileCnt++;
            }

            formData.append("filegrpid", $("#atchFilegrpid"+no).val());
            formData.append("filegrpNm", "eduInst_file");

            if(uploadFileCnt > 0){
                $.ajax({
                    url : '/uploadMultipleFiles.do',
                    processData : false,
                    contentType : false,
                    data : formData,
                    type : 'POST',
                    success : function(response) {
                        if(response.result == 'fail'){
                            alert(response.msg);
                        }else{
                            if($("#atchFilegrpid"+no).val()=='0' || $("#atchFilegrpid"+no).val()==''  || $("#atchFilegrpid"+no).val()==null){
                                $("#atchFilegrpid"+no).val( response[0].filegrpid );
                            }

                            for(i = 0 ;i < response.length; i++ ){
                                content =  "<span id='"+response[i].fileid+"' class='label label-inverse' href=javascript:downloadFileByFileid('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"')>"+response[i].orginlFileNm
                                content += "&nbsp;&nbsp;<a href='javascript:void(0)' onclick =fn_deleteFileList('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"') class='text-white'>X</a></span>"
                                $('#mnPwrSttusForm #multipleFileUploadSuccess'+no).append(content);
                            }
                        }
                    }
                });
            }
        });
    });
    // 파일삭제
    function fn_deleteFileList(fileid, fileIdntfcKey){
        if(!confirm("파일을 삭제하시겠습니까?")){return;}
        fn_deleteFile(fileid, fileIdntfcKey);
        $("#"+fileid).remove();
    }

    // 파일삭제
    function fn_deleteFile(fileid, fileIdntfcKey){
        var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;
        $.ajax({
            url : deleteFileUrl,
            type: 'GET',
            cache : false,
            dataType: 'json',
            success : function (data){
                console.log(data);
                if(data.result=="success"){
                    $("#"+fileid).remove();
                    alert("파일삭제가 완료 되었습니다.");
                }else{
                    alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                }
            },
            error : function (error){
            }
        })
    };
</script>

