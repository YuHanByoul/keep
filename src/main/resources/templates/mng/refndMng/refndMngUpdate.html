<form id="refndMngUpdate" >
    <input type="hidden" id="refndid" name="refndid" th:value="${refndMng.refndid}">
    <!--탭영역 start --> 
    <div class="tab-content tabs p-t-20">
    
      <div class="tab-pane active" id="agencyInfo" role="tabpanel">
         <div class="card-header p-t-0 p-b-0">
             <h3 class="sub-title"><strong>기본정보</strong></h3>
         </div>
         <div class="card-block-small p-t-0">
             <div class="mb-2 row align-items-end">
             <div class="mb-2 row">
                 <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="instNm"><strong>운영기관</strong></label>
                        <div class="col-12 row">
                            <div class="col-8">
                                <th:block th:if ="${inst != null}">
                                    <p th:text ="${refndMng.instNm}">기관명</p>
                                    <input type="hidden" name="instid" id="instid" th:value="${refndMng.instid}"/>
                                 </th:block>
                                 <th:block th:if ="${inst == null}">
                                    <input type="text" class="form-control form-control-sm" name="instNm" id="instNm" th:value="${refndMng.instNm}" placeholder="운영기관" readonly/>
                                    <input type="hidden" name="instid" id="instid"/>
                                 </th:block>
                            </div>
                            <th:block th:if ="${inst == null}">
                                <div class="col-4 btn-group-sm">
                                    <button type="button" class="btn btn-inverse" onclick="fn_openInstSearchModal();">
                                        기관검색
                                    </button>
                                </div>
                             </th:block>
                        </div>
                    </div>
                </div>
                 <div class="col-12 col-lg-6">
                     <div class="mb-0 form-group required">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="refndNm"><strong>시설</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="refndNm" id="refndNm" placeholder="시설명" th:value="${refndMng.refndNm}"/>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="mb-2 row">
                 <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                     <div class="mb-0 form-group">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="refndNo"><strong>시설번호</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="refndNo" id="refndNo" placeholder="시설번호" readonly th:value="${refndMng.refndNo}"/>
                         </div>
                     </div>
                 </div>
                 <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                     <div class="mb-0 form-group row required">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="addr"><strong>주소</strong></label>
                         <div class="col-sm-12">
                             <input type="hidden" name="zip" id="zip" th:value="${refndMng.zip}">
                             <input type="text" class="form-control form-control-sm" name="addr" id="addr" placeholder="주소" onclick="daumPostcode()" readonly th:value="${refndMng.addr}"/>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="mb-2 row">
                 <div class="col-12 col-lg-6">
                     <div class="mb-0 form-group row">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="addrDtl"><strong>상세주소</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="addrDtl" id="addrDtl" placeholder="상세주소" th:value="${refndMng.addrDtl}"/>
                         </div>
                     </div>
                 </div>
                 <div class="col-12 col-lg-6">
                     <div class="mb-0 form-group row required">
                           <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"  for="aplyMthdCd"><strong>예약신청방법</strong></label>
                           <div class="col-sm-12 row">
                               <div class="col-sm-6">
                                   <span kattr:radio_code="aplyMthdCd" th:attr="grpCd=153, selectedCd=${refndMng.aplyMthdCd}" isAdmin="true" addStyle="margin-top:4px" addClass="col-sm-6"></span>
                               </div>
                               <div class="col-sm-6">
                                   <input type="text" class="form-control form-control-sm" name="extnlUrl" id="extnlUrl" placeholder="외부 URL" th:value="${refndMng.extnlUrl}"/>
                               </div>
                           </div>
                       </div>
                 </div>
             </div>
             <div class="mb-2 row">
                 <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                     <div class="mb-0 form-group required">
                         <span class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>입금계좌정보</strong></span>
                         <div class="col-sm-12 row">
                             <div class="col-sm-4">
                                 <span kattr:select_code="bankCd" grpCd="154" firstOptTxt="- 선택 -" th:attr="selectedCd=${refndMng.bankCd}" addClass="form-select form-select-sm form-control-sm" ></span>
                             </div>
                             <div class="col-sm-5">
                                 <input type="text" class="form-control form-control-sm" name="bacntNo" id="bacntNo" placeholder="입금계좌번호" th:value="${refndMng.bacntNo}"/>
                             </div>
                             <div class="col-sm-3">
                                 <input type="text" class="form-control form-control-sm" name="dpstrNm" id="dpstrNm" placeholder="예금주명" th:value="${refndMng.dpstrNm}"/>
                             </div>
                         </div>
                     </div>
                 </div>
                 <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                     <div class="form-group  col-md-12 row">
                        <label class="col-md-2 control-label"><span class="text-danger"> </span>작성자</label>
                        <div class="col-md-10 form-control-static" style="text-align:left;">
                           <label class="form-control-static"><th:block th:text="${refndMng.nm}"/></label>
                         </div>
                      </div>
                 </div>
             </div>
             <div class="mb-2 row">
                 <div class="col-12 col-lg-6">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="requestDate"><strong>등록일</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" th:value="${#dates.format(refndMng.regDt, 'yyyy-MM-dd')}" readonly/>
                        </div>
                    </div>
                </div>
                 <div class="col-12 col-lg-6">
                    <div class="mb-2 form-group row">
                        <div class="col-12">
                            <input type="hidden" class="js-single"/>
                            <input type="checkbox" class="js-single-small" name="useYnChk" id="useYnChk" th:checked = "${refndMng.useYn == 'Y' }"/>
                            <label for="useYn" class="v-middle">사용여부</label>
                        </div>
                    </div>
                </div>
             </div>
             <div class="mb-2 row">
                 <div class="col-12 col-lg-6">
                     <div class="mb-0 form-group row required">
                        <div class="col-12 p-t-0 pb-1">
                            <label class="col-form-label p-t-0 pb-1"><strong>대표 이미지</strong></label>
                            <strong>(권장 사이즈 : 000x000)</strong>
                        </div>
                        <div class="col-sm-12">
                            <input type="file" class="form-control form-control-sm" id="rprsImgFile" name="rprsImgFile"/>
                            <input type="hidden" name="rprsImgFilegrpid" id="rprsImgFilegrpid" value="0">
                            <input type="hidden" name="rprsImgFileid" id="rprsImgFileid" th:value="${refndMng.rprsImgFileid}">
                        </div>
                        <div class="mt-2 row">
                            <div class="col-auto">
                                <div id="fileUploadRprsSuccess">
                                    <!-- 파일 명 및 삭제 버튼 영역-->
                                         <th:block th:if = "${rprsImgFileMap} != null ">
                                            <span th:each="item:${rprsImgFileMap}" class ='label label-inverse ' th:id="'rprsImgFile_'+${item.fileid}">
                                                <th:block th:text="${item.orginlFileNm}"></th:block>
                                                &nbsp;&nbsp;
                                                <a  class = 'text-white' href = "javascript:void(0)"
                                                           th:name="${item.fileid}" th:attr="data-idntfc-key=${item.fileIdntfcKey}" 
                                                           th:onclick="fn_deleteRprsImgFile(this.name, this.dataset.idntfcKey)">X</a>
                                            </span>
                                       </th:block>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
                 <div class="col-12 col-lg-6">
                     <div class="mb-2 form-group row">
                        <div class="col-12 p-t-0 pb-1">
                            <label class="col-form-label p-t-0 pb-1"><strong>상세 이미지</strong></label>
                            <strong>(권장 사이즈 : 000x000)</strong>
                        </div>
                        <div class="col-sm-12">
                             <input type="file" multiple id="multiFileInput" name="dtlImgFiles" class="form-control form-control-sm"/>
                             <input type="hidden" name="dtlImgFilegrpid" id="dtlImgFilegrpid" th:value="${refndMng.dtlImgFilegrpid}">
                         </div>
                    </div>
                    <div class="mb-2 row">
                         <div class="col-12 col-lg-12">
                             <div class="mb-0 form-group row">
                                 <div class="col-auto" >
                                     <span id="fileListArea">
                                        <!-- 파일 명 및 삭제 버튼 영역-->
                                         <th:block th:if = "${dtlImgFileMap} != null ">
                                            <span th:each="item:${dtlImgFileMap}" class ='label label-inverse ' th:id="'dtlImgFile_'+${item.fileid}">
                                                <th:block th:text="${item.orginlFileNm}"></th:block>
                                                &nbsp;&nbsp;
                                                <a  class = 'text-white' href = "javascript:void(0)"
                                                           th:name="${item.fileid}" th:attr="data-idntfc-key=${item.fileIdntfcKey}" 
                                                           th:onclick="fn_deleteDtlImgFile(this.name, this.dataset.idntfcKey)">X</a>
                                            </span>
                                       </th:block>
                                      </span> 
                                 </div>
                             </div>
                         </div>
                    </div>
                 </div>
            </div>
            <div class="col-12">
                <div class="mb-2 form-group row">
                   <div class="col-12 col-lg-12">
                      <div class="mb-0 form-group row">
                          <label class="form-label col-sm-6 col-form-label p-t-0 pb-1" for="gdncFile"><strong>안내자료</strong></label>
                          <div class="col-sm-12">
                              <input type="file" class="form-control form-control-sm" id="gdncFile" name="gdncFile"/>
                                <input type="hidden" name="gdncFilegrpid" id="gdncFilegrpid" value="0">
                                <input type="hidden" name="gdncFileid" id="gdncFileid" th:value="${refndMng.gdncFileid}">
                          </div>
                          <div class="mt-2 row">
                            <div class="col-auto">
                                <div id="fileUploadGdncSuccess">
                                    <!-- 파일 명 및 삭제 버튼 영역-->
                                         <th:block th:if = "${gdncFileMap} != null ">
                                            <span th:each="item:${gdncFileMap}" class ='label label-inverse ' th:id="'gdncFile_'+${item.fileid}">
                                                <th:block th:text="${item.orginlFileNm}"></th:block>
                                                &nbsp;&nbsp;
                                                <a  class = 'text-white' href = "javascript:void(0)"
                                                           th:name="${item.fileid}" th:attr="data-idntfc-key=${item.fileIdntfcKey}" 
                                                           th:onclick="fn_deleteGdncFile(this.name, this.dataset.idntfcKey)">X</a>
                                            </span>
                                       </th:block>
                                </div>
                            </div>
                        </div>
                      </div>
                  </div>
               </div>
            </div>
            <div class="col-12">
                <div class="form-group row m-b-0">
                     <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="dtlCn"><strong>상세 정보</strong></label>
                     <div class="col-sm-12">
                         <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="" id="dtlCn" name="dtlCn"><th:block th:text="${refndMng.dtlCn}"/></textarea>
                     </div>
                 </div>
            </div>
         </div>
         
         <div class="card-block-small">
             <button type="button" class="btn btn-inverse waves-effect waves-light" onclick="deleteItem();">삭제</button>
             <button type="button" class="btn btn-disabled m-r-5" onclick = "gridHelper1.toggleContent()" > 취소</button>
             <button type="button" class="btn btn-primary" onclick="fn_updateRefndMng()">저장</button>
         </div>
         
     </div>
     
     <div class="tab-pane" id="managerInfo" role="tabpanel"></div>
     
    </div>
    <!-- 탭영역 end -->
    <input type="hidden" id="rgnCd" name="rgnCd" th:value="${refndMng.rgnCd}"/>
    <!-- 탭영역 end -->
    <div style="display:none;">
        <span kattr:select_code="rgnCdOption" grpCd="143" addClass="form-select form-select-sm form-control-sm" ></span>
    </div>
</form>

<!-- 임시비밀번호발급 Start -->
<div class="modal fade" id="popCon1" tabindex="-1" role="dialog" aria-labelledby="popCon1Title" aria-hidden="true"></div>
<!-- 임시비밀번호발급 End -->

<script type="text/javascript" src="/files/assets/pages/advance-elements/swithces.js"></script>
<script type="text/javascript" src="/files/assets/pages/advance-elements/select2-custom.js"></script>
<div class="modal fade" id="instSearchPopup" data-bs-backdrop="static"></div>

<script th:inline="javascript">
    // 기관검색 팝업
    var instSearchPopupUrl = "/mng/refndMng/instSearchPopup.html";
    var instSearchAddModal;
    var rgnCdList = [];
    var rgnTxtList = [];
    
    init();
    
    
    var fn_openInstSearchModal = () => {
        $("#instSearchPopup").load(instSearchPopupUrl, function(response, status, xhr) {
            if (status == "success") {
                instSearchAddModal = new bootstrap.Modal($('#instSearchPopup'));
                instSearchAddModal.show();
            }
        });
    }
    
    function init() {
        var option = $('#rgnCdOption option');
        
        for( var i=0; i<option.length; i++ ){
            rgnCdList.push($(option[i]).val());
            rgnTxtList.push($(option[i]).text());
        }
        
        changeAplyMthdCdYn();
        
        $('input:radio[name=aplyMthdCd]').on('change', function(){
            changeAplyMthdCdYn();
        })
    }
    
    // 예약신청방법
    function changeAplyMthdCdYn() {
        
        if($('input:radio[name=aplyMthdCd]:checked').val() == "153102"){
            $('#extnlUrl').show();
        }else{
            $('#extnlUrl').val('');
            $('#extnlUrl').hide();
        }
    } 
    
    // 대표이미지 파일 첨부 (단일 파일)
    $('#rprsImgFile').change(function(event) {
        var formData = new FormData();
        var objFile = event.target;
        var content = "";

        formData.append("file", objFile.files[0]);
        formData.append("filegrpNm", "rprsImg_file");
        if($('#rprsImgFilegrpid').val() != '')
            formData.append("filegrpid", $('#rprsImgFilegrpid').val());

        if(displayWorkProgress()){
            $.ajax({
                url : '/uploadFile.do',
                processData : false,
                contentType : false,
                data : formData,
                type : 'POST',
                success : function(response) {
                    if(response.result == 'fail'){
                        alert(response.msg);
                    }else if(response.filegrpid != undefined && response.filegrpid != ''){
                        $("#rprsImgFileid").val(response.filegrpid);
                        content = "<div class ='label label-inverse text-white' id='"+response.fileid+"'><a href=javascript:downloadFileByFileid('"+response.fileid+"','"+response.fileIdntfcKey+"') class='text-white'>"+response.orginlFileNm+"&nbsp;&nbsp;</a>";
                        content +="<a href=javascript:fn_deleteRprsImgFile('"+response.fileid+"','"+response.fileIdntfcKey+"') class='text-white'>X</a></div>";
                        $('#fileUploadRprsSuccess').html(content);
                    }
                    closeWorkProgress();
                }
            });
            $("#rprsImgFile").val("");
        }

        event.preventDefault();
    });
    
    // 상세 이미지 파일 첨부 (멀티 파일) 
    $('#multiFileInput').on("change", function(event) {
       
       var objFile = document.querySelector('#multiFileInput');
       var formData = new FormData();
       var content = "";
       var uploadFileCnt = 0;
       
       for( i = 0 ; i < objFile.files.length ; i++) {
           formData.append("files", objFile.files[i]);
           uploadFileCnt++;
       }
       formData.append("dtlImgFilegrpid", $("#dtlImgFilegrpid").val());
       formData.append("filegrpNm", "biz_file");
       
           $.ajax({
               url : '/uploadMultipleFiles.do',
               processData : false,
               contentType : false,
               data : formData,
               type : 'POST',
               success : function(response) {
                   if(response.result == 'fail'){
                      alert(response.msg);
                   }else{
                       if($("#dtlImgFilegrpid").val()=='0' || $("#dtlImgFilegrpid").val()==''  || $("#dtlImgFilegrpid").val()==null){
                           $("#dtlImgFilegrpid").val( response[0].dtlImgFilegrpid );
                       }
                       
                       for(i = 0 ;i < response.length; i++ ){
                           content = "<span class ='label label-inverse mb-2' id='dtImgFile_"+response[i].fileid+"'>"+response[i].orginlFileNm ;
                           content +="&nbsp;&nbsp;  <a  class = 'btn text-white' href = javascript:fn_deleteDtlImgFile('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"')>X</a></span>&nbsp;&nbsp;";
                           $('#fileListArea').append(content);
                       }
                   }
               }
           })
           
          if (detectBrowser() == "other") { 
              $("#multiFileInput").val("");
          } else {   
             $("#multiFileInput").replaceWith( $("#multiFileInput").clone(true)) 
          }
           
    });
    
    // 안내자료 파일 첨부 (단일 파일)
    $('#gdncFile').change(function(event) {
        var formData = new FormData();
        var objFile = event.target;
        var content = "";

        formData.append("file", objFile.files[0]);
        formData.append("filegrpNm", "gdnc_file");
        if($('#gdncFilegrpid').val() != '')
            formData.append("filegrpid", $('#gdncFilegrpid').val());

        if(displayWorkProgress()){
            $.ajax({
                url : '/uploadFile.do',
                processData : false,
                contentType : false,
                data : formData,
                type : 'POST',
                success : function(response) {
                    if(response.result == 'fail'){
                        alert(response.msg);
                    }else if(response.filegrpid != undefined && response.filegrpid != ''){
                        $("#gdncFileid").val(response.filegrpid);
                        content = "<div class ='label label-inverse text-white' id='"+response.fileid+"'><a href=javascript:downloadFileByFileid('"+response.fileid+"','"+response.fileIdntfcKey+"') class='text-white'>"+response.orginlFileNm+"&nbsp;&nbsp;</a>";
                        content +="<a href=javascript:fn_deleteGdncFile('"+response.fileid+"','"+response.fileIdntfcKey+"') class='text-white'>X</a></div>";
                        $('#fileUploadGdncSuccess').html(content);
                    }
                    closeWorkProgress();
                }
            });
            $("#gdncFile").val("");
        }

        event.preventDefault();

    });

    function fn_deleteFileList(fileid, fileIdntfcKey){
        if(!confirm("파일을 삭제하시겠습니까?")){return;}
        fn_deleteFile(fileid, fileIdntfcKey);
        $("#"+fileid).remove();
        $('#rprsImgFile').val('');
    };
    
    function fn_deleteFile(fileid, fileIdntfcKey){
                   
        var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey; 
          $.ajax({
            url : deleteFileUrl,
            type: 'GET',
            cache : false,
            dataType: 'json',
            success : function (data){
                if(data.result=="success"){
                    $("#"+fileid).remove();
                    $('#rprsImgFileid').val(0);
                    $('#rprsImgFilegrpid').val(0);
                    $('#rprsImgFile').val('');
                    alert("파일삭제가 완료 되었습니다.");
                }else{
                    alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                }
            },
            error : function (error){
            } 
         })
    };
    
    
    // 데이터 submit
    function fn_updateRefndMng(){
        
        if(!($("#refndMngUpdate").valid())) return;
        
        if(!confirm("저장하시겠습니까?")) return;
        
        let data =  $("#refndMngUpdate").serialize() ;
        let tailStr = "&useYn="+($('#useYnChk').is(':checked'))?"Y":"N";
        let useYn = ( $('#useYnChk').is(':checked') )? "Y" : "N" ;
        // 지역
        // let rgnCdPoint = $('#addr').val().indexOf(' ');
        // let rgnCd = $('#addr').val().substr(0, rgnCdPoint);
        data = data+"&useYn="+useYn;
         
        if(displayWorkProgress()){
            $.ajax({
                url : "/mng/refndMng/updateRefndMng.do",
                type: 'POST',
                cache : false,
                dataType: 'json',
                data : data,
                success : function (data){
                    if(data.result=="success"){
                        alert(data.msg);
                        gridHelper1.resetListContent();
                    }else{
                        alert(data.msg);
                    }
                    closeWorkProgress();
                }
            });
        }
    }
            
    // 다음주소
    function daumPostcode(){
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = '';
                if (data.userSelectedType === 'R') {
                    addr = data.roadAddress;
                } else {
                    addr = data.jibunAddress;
                }
                
                for( var i=0; i<rgnTxtList.length; i++ ){
                    if( rgnTxtList[i] == data.query.split(' ')[0] ){
                        $('#rgnCd').val(rgnCdList[i]);
                    }
                }
                $('#zip').val(data.zonecode);
                $('#addr').val(addr);
                $('#addrDtl').focus();
            }
        }).open();
   }
    
    // 대표 이미지 삭제
   var fn_deleteRprsImgFile = (fileid,fileIdntfcKey) =>{
        $("#rprsImgFile_"+fileid).remove();
        fn_deleteFile(fileid, fileIdntfcKey);
    }
    
    // 상세 이미지 삭제
    var fn_deleteDtlImgFile = (fileid,fileIdntfcKey)=>{
        $("#dtlImgFile_"+fileid).remove();
        fn_deleteFile(fileid, fileIdntfcKey);
    }
    
    // 안내자료 파일 삭제
   var fn_deleteGdncFile = (fileid,fileIdntfcKey) =>{
        $("#gdncFile_"+fileid).remove();
        fn_deleteFile(fileid, fileIdntfcKey);
    }
    
    // 삭제
    function deleteItem(){
        if(!confirm("삭제하시겠습니까?")) return;
        var msg;
        var refndid = $('#refndid').val();
        if(displayWorkProgress()){
            $.ajax({
                url: "/mng/refndMng/deleteRefndMng.do",
                type: 'POST',
                cache : false,
                traditional : true,
                dataType: 'json',
                data: {refndid:refndid},
                success: function(data){
                    if(data.result=="success"){
                        alert(data.msg);
                        gridHelper2.resetListContent();
                    }else{
                        alert(data.msg);
                    }
                    closeWorkProgress();
                }
            });
        }
    }

</script>

