<form id="refndMngFrm" >
    <!--탭영역 start --> 
    <div class="tab-content tabs p-t-20">
    
      <div class="tab-pane active" id="agencyInfo" role="tabpanel">
         <div class="card-header p-t-0 p-b-0">
             <h3 class="sub-title"><strong>기본정보</strong></h3>
         </div>
         <div class="card-block-small p-t-0">
             <div class="mb-2 row align-items-end">
             <div class="mb-2 row">
                 <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="instNm"><strong>운영기관</strong></label>
                        <div class="col-12 row">
                            <div class="col-8">
                                <th:block th:if ="${inst != null}">
                                    <p th:text ="${inst.instNm}">기관명</p>
                                    <input type="hidden" name="instNm" id="instNm"/>
                                    <input type="hidden" name="instid" id="instid" th:value="${inst.instid}"/>
                                 </th:block>
                                 <th:block th:if ="${inst == null}">
                                    <input type="text" class="form-control form-control-sm" name="instNm" id="instNm" placeholder="운영기관" readonly onclick="fn_openInstSearchModal();"/>
                                    <input type="hidden" name="instid" id="instid"/>
                                 </th:block>
                            </div>
                            <th:block th:if ="${inst == null}">
                                <div class="col-4 btn-group-sm">
                                    <button type="button" class="btn btn-inverse" onclick="fn_openInstSearchModal();">
                                        기관검색
                                    </button>
                                </div>
                             </th:block>
                        </div>
                    </div>
                </div>
                 <div class="col-12 col-lg-6">
                     <div class="mb-0 form-group required">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="refndNm"><strong>시설</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="refndNm" id="refndNm" placeholder="시설명"/>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="mb-2 row">
                 <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                     <div class="mb-0 form-group row required">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="addr"><strong>주소</strong></label>
                         <div class="col-sm-12">
                             <input type="hidden" name="zip" id="zip">
                             <input type="text" class="form-control form-control-sm" name="addr" id="addr" placeholder="주소" onclick="daumPostcode()" readonly/>
                         </div>
                     </div>
                 </div>
                 <div class="col-12 col-lg-6">
                     <div class="mb-0 form-group row">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="addrDtl"><strong>상세주소</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="addrDtl" id="addrDtl" placeholder="상세주소" />
                         </div>
                     </div>
                 </div>
             </div>
             <div class="mb-2 row">
                 <div class="col-12 col-lg-6">
                     <div class="mb-0 form-group row required">
                           <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="aplyMthdCd"><strong>예약신청방법</strong></label>
                           <div class="col-sm-12 row">
                               <div class="col-sm-6">
                                   <span kattr:radio_code="aplyMthdCd" grpCd="153" isAdmin="true" addStyle="margin-top:4px"></span>
                               </div>
                               <div class="col-sm-6">
                                   <input type="text" class="form-control form-control-sm" name="extnlUrl" id="extnlUrl" placeholder="외부 URL" />
                               </div>
                           </div>
                       </div>
                 </div>
                 <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                     <div class="mb-0 form-group required bankCon">
                         <span class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>입금계좌정보</strong></span>
                         <div class="col-sm-12 row">
                             <div class="col-sm-4">
                                 <span kattr:select_code="bankCd" grpCd="154" firstOptTxt="-선택 -"  addClass="form-select form-select-sm form-control-sm" ></span>
                             </div>
                             <div class="col-sm-5">
                                 <input type="text" class="form-control form-control-sm" name="bacntNo" id="bacntNo" placeholder="입금계좌번호" />
                             </div>
                             <div class="col-sm-3">
                                 <input type="text" class="form-control form-control-sm" name="dpstrNm" id="dpstrNm" placeholder="예금주명" />
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="mb-2 row">
                 <div class="col-12 col-lg-6">
                    <div class="mb-2 form-group row">
                        <div class="col-12">
                            <input type="hidden" class="js-single"/>
                            <input type="checkbox" class="js-single-small" name="useYnChk" id="useYnChk" checked/>
                            <label for="useYn" class="v-middle">사용여부</label>
                        </div>
                    </div>
                </div>
             </div>
             <div class="mb-2 row">
                 <div class="col-12 col-lg-6">
                     <div class="mb-0 form-group row required">
                        <div class="col-12 p-t-0 pb-1">
                            <label class="col-form-label p-t-0 pb-1"><strong>대표 이미지</strong></label>
                            <strong>(권장 사이즈 : 000x000)</strong>
                        </div>
                        <div class="col-sm-12">
                            <input type="file" class="form-control form-control-sm" id="rprsImgFile" name="rprsImgFile"/>
                            <input type="hidden" name="rprsImgFilegrpid" id="rprsImgFilegrpid" value="0">
                            <input type="hidden" name="rprsImgFileid" id="rprsImgFileid" value="0">
                        </div>
                        <div class="mt-2 row">
                            <div class="col-auto">
                                <div id="fileUploadRprsSuccess">
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
                 <div class="col-12 col-lg-6">
                     <div class="mb-2 form-group row">
                        <div class="col-12 p-t-0 pb-1">
                            <label class="col-form-label p-t-0 pb-1"><strong>상세 이미지</strong></label>
                            <strong>(권장 사이즈 : 000x000)</strong>
                        </div>
                        <div class="col-sm-12">
                             <input type="file" multiple id="multiFileInput" name="dtlImgFiles" class="form-control form-control-sm"/>
                         </div>
                    </div>
                    <div class="mb-2 row">
                         <div class="col-12">
                             <div class="mb-0 form-group row">
                                 <div class="col-auto">
                                     <!-- 파일 명 및 삭제 버튼 영역-->
                                     <span id="fileListArea"></span>
                                 </div>
                             </div>
                         </div>
                    </div>
                 </div>
            </div>
            <div class="col-12">
                <div class="mb-2 form-group row">
                   <div class="col-12 col-lg-12">
                      <div class="mb-0 form-group row">
                          <label class="form-label col-sm-6 col-form-label p-t-0 pb-1" for="gdncFile"><strong>안내자료</strong></label>
                          <div class="col-sm-12">
                              <input type="file" class="form-control form-control-sm" id="gdncFile" name="gdncFile"/>
                                <input type="hidden" name="gdncFilegrpid" id="gdncFilegrpid" value="0">
                                <input type="hidden" name="gdncFileid" id="gdncFileid" value="0">
                          </div>
                          <div class="mt-2 row">
                             <div class="col-auto">
                                 <div id="fileUploadGdncSuccess">
                                 </div>
                             </div>
                         </div>
                      </div>
                  </div>
               </div>
            </div>
            <div class="col-12">
                <div class="form-group row m-b-0">
                     <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="dtlCn"><strong>상세 정보</strong></label>
                     <div class="col-sm-12">
                         <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="" id="dtlCn" name="dtlCn"></textarea>
                     </div>
                 </div>
            </div>
         </div>
         
         <div class="card-block-small">
             <button type="button" class="btn btn-disabled m-r-5" onclick = "gridHelper2.toggleContent()" > 취소</button>
             <button type="button" class="btn btn-primary" onclick="fn_insertFcltMng()">저장</button>
         </div>
         
     </div>
     
     <div class="tab-pane" id="managerInfo" role="tabpanel"></div>
     
    </div>
    <!-- 탭영역 end -->
    <div style="display:none;">
        <span kattr:select_code="rgnCd" grpCd="143" addClass="form-select form-select-sm form-control-sm" ></span>
    </div>
    
    <input type="hidden" id="dtlImgFilegrpid" name="dtlImgFilegrpid" value="0"/>
    <input type="hidden" id="filegrpid" name="filegrpid" value="0"/>
</form>

<!-- 임시비밀번호발급 Start -->
<div class="modal fade" id="popCon1" tabindex="-1" role="dialog" aria-labelledby="popCon1Title" aria-hidden="true"></div>
<!-- 임시비밀번호발급 End -->

<script type="text/javascript" src="/files/assets/pages/advance-elements/swithces.js"></script>
<script type="text/javascript" src="/files/assets/pages/advance-elements/select2-custom.js"></script>
<div class="modal fade" id="instSearchPopup" data-bs-backdrop="static"></div>

<script th:inline="javascript">
    // 기관검색 팝업
    var instSearchPopupUrl = "/mng/refndMng/instSearchPopup.html";
    var instSearchAddModal;
    var rgnCdList = [];
    var rgnTxtList = [];
    
    init();
    
    var fn_openInstSearchModal = () => {
        $("#instSearchPopup").load(instSearchPopupUrl, function(response, status, xhr) {
            if (status == "success") {
                instSearchAddModal = new bootstrap.Modal($('#instSearchPopup'));
                instSearchAddModal.show();
            }
        });
    }
    
    function init() {
        var option = $('#rgnCd option');
        
        for( var i=0; i<option.length; i++ ){
            rgnCdList.push($(option[i]).val());
            rgnTxtList.push($(option[i]).text());
        }
        
        changeAplyMthdCdYn();
        
        $('input:radio[name=aplyMthdCd]').on('change', function(){
            changeAplyMthdCdYn();
        })
    }
    
    // 예약신청방법
    function changeAplyMthdCdYn() {
        if($('input:radio[name=aplyMthdCd]:checked').val() == "153102"){
            // 외부 URL 입력 창 활성화
            $('#extnlUrl').show();
            
            // 입금계좌정보 비활성화
            $('#bankCon').removeClass('required');
            $('#bankCd').val('');
            $('#bankCd').attr('disabled', true);
            $('#bacntNo').val('');
            $('#bacntNo').attr('disabled', true);
            $('#dpstrNm').val('');
            $('#dpstrNm').attr('disabled', true);
        }else{
            // 외부 URL 입력 창 비활성화
            $('#extnlUrl').val('');
            $('#extnlUrl').hide();
            
            // 입금계좌정보 활성화
            $('#bankCon').addClass('required');
            $('#bankCd').attr('disabled', false);
            $('#bacntNo').attr('disabled', false);
            $('#dpstrNm').attr('disabled', false);
        }
    } 
    
    function fn_deleteFileList(fileid, fileIdntfcKey){
        if(!confirm("파일을 삭제하시겠습니까?")){return;}
        fn_deleteFile(fileid, fileIdntfcKey);
        $("#"+fileid).remove();
        $('#dtlImgFile').val('');
    };
    
    function fn_deleteFile(fileid, fileIdntfcKey){
                   
        var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey; 
          $.ajax({
            url : deleteFileUrl,
            type: 'GET',
            cache : false,
            dataType: 'json',
            success : function (data){
                if(data.result=="success"){
                    $("#"+fileid).remove();
                    $('#dtlImgFileid').val(0);
                    $('#dtlImgFile').val('');
                    alert("파일삭제가 완료 되었습니다.");
                }else{
                    alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                }
            },
            error : function (error){
            } 
         })
    };
    
    // 대표이미지 파일 첨부 (단일 파일)
    $('#rprsImgFile').change(function(event) {
        var formData = new FormData();
        var objFile = event.target;
        var content = "";

        formData.append("file", objFile.files[0]);
        formData.append("filegrpNm", "rprsImg_file");
        if($('#rprsImgFilegrpid').val() != '')
            formData.append("filegrpid", $('#rprsImgFilegrpid').val());

        if(displayWorkProgress()){
            $.ajax({
                url : '/uploadFile.do',
                processData : false,
                contentType : false,
                data : formData,
                type : 'POST',
                success : function(response) {
                    if(response.result == 'fail'){
                        alert(response.msg);
                    }else if(response.filegrpid != undefined && response.filegrpid != ''){
                        $("#rprsImgFileid").val(response.filegrpid);
                        content = "<div class ='label label-inverse text-white' id='"+response.fileid+"'><a href=javascript:downloadFileByFileid('"+response.fileid+"','"+response.fileIdntfcKey+"') class='text-white'>"+response.orginlFileNm+"&nbsp;&nbsp;</a>";
                        content +="<a href=javascript:fn_deleteRprsImgFile('"+response.fileid+"','"+response.fileIdntfcKey+"') class='text-white'>X</a></div>";
                        $('#fileUploadRprsSuccess').html(content);
                    }
                    closeWorkProgress();
                }
            });
            $("#rprsImgFile").val("");
        }

        event.preventDefault();
    });
    
    // 상세 이미지 파일 첨부 (멀티 파일) 
    $('#multiFileInput').on("change", function(event) {
       
       var objFile = document.querySelector('#multiFileInput');
       var formData = new FormData();
       var content = "";
       var uploadFileCnt = 0;
       
       for( i = 0 ; i < objFile.files.length ; i++) {
           formData.append("files", objFile.files[i]);
           uploadFileCnt++;
       }
       formData.append("filegrpid", $("#dtlImgFilegrpid").val());
       formData.append("filegrpNm", "dtlImg_file");
       
           $.ajax({
               url : '/uploadMultipleFiles.do',
               processData : false,
               contentType : false,
               data : formData,
               type : 'POST',
               success : function(response) {
                   if(response.result == 'fail'){
                      alert(response.msg);
                   }else{
                       if($("#dtlImgFilegrpid").val()=='0' || $("#dtlImgFilegrpid").val()==''  || $("#dtlImgFilegrpid").val()==null){
                           $("#dtlImgFilegrpid").val( response[0].filegrpid );
                       }
                       
                       for(i = 0 ;i < response.length; i++ ){
                           content = "<span class ='label label-inverse mb-2' id='dtlImgFile_"+response[i].fileid+"'>"+response[i].orginlFileNm ;
                           content +="&nbsp;&nbsp;  <a  class = 'btn text-white' href = javascript:fn_deleteDtlImgFile('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"')>X</a></span>&nbsp;&nbsp;";
                           $('#fileListArea').append(content);
                       }
                   }
               }
           })
           
          if (detectBrowser() == "other") { 
              $("#multiFileInput").val("");
          } else {   
             $("#multiFileInput").replaceWith( $("#multiFileInput").clone(true)) 
          }
           
    });

    // 안내자료 파일 첨부 (단일 파일)
    $('#gdncFile').change(function(event) {
        var formData = new FormData();
        var objFile = event.target;
        var content = "";

        formData.append("file", objFile.files[0]);
        formData.append("filegrpNm", "gdnc_file");
        if($('#gdncFilegrpid').val() != '')
            formData.append("filegrpid", $('#gdncFilegrpid').val());

        if(displayWorkProgress()){
            $.ajax({
                url : '/uploadFile.do',
                processData : false,
                contentType : false,
                data : formData,
                type : 'POST',
                success : function(response) {
                    if(response.result == 'fail'){
                        alert(response.msg);
                    }else if(response.filegrpid != undefined && response.filegrpid != ''){
                        $("#gdncFileid").val(response.filegrpid);
                        content = "<div class ='label label-inverse text-white' id='"+response.fileid+"'><a href=javascript:downloadFileByFileid('"+response.fileid+"','"+response.fileIdntfcKey+"') class='text-white'>"+response.orginlFileNm+"&nbsp;&nbsp;</a>";
                        content +="<a href=javascript:fn_deleteFileList('"+response.fileid+"','"+response.fileIdntfcKey+"') class='text-white'>X</a></div>";
                        $('#fileUploadGdncSuccess').html(content);
                    }
                    closeWorkProgress();
                }
            });
            $("#gdncFile").val("");
        }

        event.preventDefault();

    });
    
    // 데이터 submit
 	function fn_insertFcltMng(){
 	 	
	 	if(!($("#refndMngFrm").valid())) return;
	 	
  	 	if(!confirm("저장하시겠습니까?")) return;
  	 	
  	 	let data =  $("#refndMngFrm").serialize() ;
  	 	let tailStr = "&useYn="+($('#useYnChk').is(':checked'))?"Y":"N";
  	 	let useYn = ( $('#useYnChk').is(':checked') )? "Y" : "N" ;
  	 	let aplyMthdCd = $('input:radio[name=aplyMthdCd]:checked').val();
  	 	let extnlUrl = $('#extnlUrl').val();
  	 	
  	 	if( aplyMthdCd == "153102" ){
            if( extnlUrl == '' ){
                alert('외부 URL을 입력해주세요.');
                return false;
            }
        }
  	 	
  	 	// 지역
  	 	// let rgnCdPoint = $('#addr').val().indexOf(' ');
  	 	// let rgnCd = $('#addr').val().substr(0, rgnCdPoint);
  	 	data = data+"&useYn="+useYn;
  	 	 
	    if(displayWorkProgress()){
			$.ajax({
				url : "/mng/refndMng/insertFcltMng.do",
				type: 'POST',
				cache : false,
				dataType: 'json',
				data : data,
				success : function (data){
					if(data.result=="success"){
						alert(data.msg);
						gridHelper2.resetPageContent();
					}else{
						alert(data.msg);
					}
					closeWorkProgress();
				}
			});
		}
	}
		    
	// 다음주소
	function daumPostcode(){
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = '';
                if (data.userSelectedType === 'R') {
                    addr = data.roadAddress;
                } else {
                    addr = data.jibunAddress;
                }
                
                for( var i=0; i<rgnTxtList.length; i++ ){
                    if( rgnTxtList[i] == data.query.split(' ')[0] ){
                        $('#rgnCd').val(rgnCdList[i]);
                    }
                }
                $('#zip').val(data.zonecode);
                $('#addr').val(addr);
                $('#addrDtl').focus();
            }
        }).open();
   }
   
   // 대표 이미지 삭제
   var fn_deleteRprsImgFile = (fileid,fileIdntfcKey) =>{
        $("#rprs_img_"+fileid).remove();
        fn_deleteFile(fileid, fileIdntfcKey);
    }

    // 상세 이미지 삭제
    var fn_deleteDtlImgFile = (fileid,fileIdntfcKey)=>{
    	$("#dtlImgFile_"+fileid).remove();
    	fn_deleteFile(fileid, fileIdntfcKey);
    }
    
</script>