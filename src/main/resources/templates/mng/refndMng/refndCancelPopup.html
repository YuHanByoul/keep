<form id="refndCancelFrm">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content type_2">
            <div class="modal-header">
                <h4 class="modal-title">환불요청 취소사유</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card m-b-10">
                    <div class="card-block-small">
                        <div class="mb-3 form-group row">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="cnclRsnCd"><strong>사유</strong></label>
                            <div class="col-12">
                                <span kattr:select_code="rfndRejectRsnCd" th:value="${aplyVo?.rfndRejectRsnCd}" id="rfndRejectRsnCd" name="rfndRejectRsnCd" onchange="changeCnclRsnCd" 
                                th:attr="grpCd=243,selectedCd=${aplyVo?.rfndRejectRsnCd}" firstOptTxt="- 전체 -" addClass="form-select form-control" isAdmin="true">
                            </div>
                        </div>
                        <!-- [case] 사유 기타 선택 시 -->
                        <div class="mb-0 form-group row required" id="rfndRejectRsnCon" style="display:none;">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="rfndRejectRsn"><strong>기타 사유</strong></label>
                            <div class="col-12">
                                <textarea rows="5" cols="5" class="form-control form-control-sm" id="rfndRejectRsn" name="rfndRejectRsn"><th:block th:utext="${aplyVo?.rfndRejectRsn}"/></textarea>
                            </div>
                        </div>
                        <!-- // -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary waves-effect waves-light" onclick="cancelRefund()">저장</button>
            </div>
        </div>
    </div>
</form>
<script th:inline="javascript">

	/*<![CDATA[*/
	var paramAplyids = /*[[${param.aplyids}]]*/null;
	/*]]>*/

	var validator = $("#refndCancelFrm").validate({
            onsubmit: false,
            rules: {
        	    rfndRejectRsnCd  : { required :true }
                ,rfndRejectRsn   : { required :true ,maxlength:100}
            },
            messages: {
            	rfndRejectRsnCd  : { required : "취소사유를 선택해주십시오."}
                ,rfndRejectRsn   : { required : "사유를 입력해주십시오.",maxlength:"환불 취소 사유는 100글자 이하여야 합니다."}
            }
    })
	
    function changeCnclRsnCd(){
        var val = $('select[name="rfndRejectRsnCd"]').val();
        if( val == '243103' ){
            $('#rfndRejectRsnCon').show();
        }else{
            $('#rfndRejectRsnCon').hide();
        }
    }

    var cancelRefund = () => {
        
        if(!($("#refndCancelFrm").valid())) return;
        
        if(!confirm('환불요청을 취소 하시겠습니까?\n이미 다른 예약신청이 있는 요청건을 제외하고 예약승인 및 입금완료 상태로 전환됩니다.') )return;
        
        var data = {
        		"aplyids" : paramAplyids.join(",")
                , "rfndRejectRsnCd": $("#refndCancelFrm #rfndRejectRsnCd").val()
                , "rfndRejectRsn"  : $("#refndCancelFrm #rfndRejectRsn").val()
        }

        if(displayWorkProgress()){
              $.ajax({
                  url: "/mng/refndMng/updateRefndCancel.do",
                  type: 'POST',
                  cache : false,
                  dataType: 'json',
                  data : data,
                  success : function (data){
                      closeWorkProgress();
                      if(data.result=="success"){
                          alert(data.msg);
                          refndModal.hide();
                          gridHelper2.resetPageContent();
                      }else{
                          alert(data.msg);
                      }
                  },
                  error : function (error){
                  }
             });
        }
   }
</script>