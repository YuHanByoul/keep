<div class="card">
    <div class="card-header p-b-0">
        <h3 class="sub-title"><strong>기본 정보</strong></h3>
    </div>
    <form method="post" id="registerForm" name="registerForm" onsubmit="return false;">
        <div class="card-block-small p-t-0">
            <div class="row">
                <div class="col-lg-6 mb-3">
                    <div class="mb-0 form-group required">
                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>분류</strong></div>
                        <div class="border-checkbox-section">
                            <span kattr:check_code="clsfCds" grpCd="228" th:attr="selectedCd=${spcltyDta.clsfCd}" isAdmin="true"/>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="yy"><strong>발행년도</strong></label>
                        <div class="col-12">
                            <input type="number" class="form-control form-control-sm" name="yy" id="yy" th:value="${spcltyDta.yy}"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="writr"><strong>저자</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" name="writr" id="writr" th:value="${spcltyDta.writr}">
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-3">
                    <div class="mb-0 form-group required">
                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>저작권</strong></div>
                        <span kattr:select_code="cpyrhtCd" grpCd="241" firstOptTxt="- 선택 -" th:attr="selectedCd=${spcltyDta.cpyrhtCd}" isAdmin="true"></span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="pdfFile"><strong>PDF 파일</strong></label>
                        <div class="col-12">
                            <input type="file" name="pdfFile" id="pdfFile" multiple accept="image/jpeg,image/gif,image/png,application/pdf" class="form-control form-control-sm"/>
                        </div>
                        <div class="mt-2 row">
                            <div class="col-auto">
                                <div id="pdfFileUploadError"></div>
                                <div id="pdfFileUploadSuccess">
                                    <th:block th:if="${spcltyDta.pdfFileList}">
                                        <th:block th:each="file : ${spcltyDta.pdfFileList}" th:id="${file.fileid}">
                                            <span class='label label-inverse' th:id="${file.fileid}">[[${file.orginlFileNm}]]
                                                <a class='text-white' href="javascript:void(0)"
                                                   th:name="${file.fileid}" th:attr="data-idntfc-key=${file.fileIdntfcKey}"
                                                   th:onclick="deleteFile(this.name, this.dataset.idntfcKey)">X
                                                </a>
                                            </span>
                                        </th:block>
                                    </th:block>
                                </div>
                                <input type="hidden" id="pdfFileid" name="pdfFileid" th:value="${spcltyDta.pdfFileid == null ? 0 : spcltyDta.pdfFileid }"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="ttl"><strong>제목</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" name="ttl" id="ttl" th:value="${spcltyDta.ttl}">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="cn"><strong>내용</strong></label>
                        <div class="col-12">
                            <textarea rows="5" cols="5" class="form-control form-control-sm" id="cn" name="cn"><th:block th:text="${spcltyDta.cn}"></th:block></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="atchFile"><strong>첨부파일</strong></label>
                        <div class="col-12">
                            <input type="file" name="atchFile" id="atchFile" multiple accept="image/jpeg,image/gif,image/png,application/pdf" class="form-control form-control-sm"/>

                        </div>
                        <div class="mt-2 row">
                            <div class="col-auto">
                                <div id="atchFileUploadSuccess">
                                    <th:block th:if="${spcltyDta.atchFileList}">
                                        <th:block th:each="file : ${spcltyDta.atchFileList}" th:id="${file.fileid}">
                                            <span class='label label-inverse' th:id="${file.fileid}"> [[${file.orginlFileNm}]]
                                                <a class='text-white' href="javascript:void(0)"
                                                   th:name="${file.fileid}" th:attr="data-idntfc-key=${file.fileIdntfcKey}"
                                                   th:onclick="deleteFile(this.name, this.dataset.idntfcKey)">X
                                                </a>
                                            </span>
                                        </th:block>
                                    </th:block>
                                </div>
                                <input type="hidden" id="atchFilegrpid" name="atchFilegrpid" th:value="${spcltyDta.atchFilegrpid == null ? 0 : spcltyDta.atchFilegrpid }"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="regD"><strong>등록일</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" name="regD" id="regD" readonly
                                   th:value="${spcltyDta.regDt != null? #dates.format(spcltyDta.regDt,'yyyy-MM-dd') : #dates.format(#dates.createNow(), 'yyyy-MM-dd')}"/>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="rgtrNm"><strong>작성자ID(이름)</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" name="rgtrNm" id="rgtrNm" readonly
                                   th:value="${spcltyDta.rgtrNm != null
                                   ? spcltyDta.rgtrAcnt + '(' + spcltyDta.rgtrNm + ')'
                                   : spcltyDta.user.acnt + '(' + spcltyDta.user.nm + ')'}"/>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>최종수정일</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" readonly
                                   th:value="${spcltyDta.mdfcnDt != null? #dates.format(spcltyDta.mdfcnDt,'yyyy-MM-dd') : ''}"/>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>삭제여부</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" readonly th:value="${spcltyDta.delYn}"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-block-small">
            <th:block sec:authorize-url="/mng/spcltyDta/deleteSpcltyDta.do">
                <button th:if="${spcltyDta.dtaid != null and spcltyDta.delYn == 'N'}" type='button' class="btn btn-inverse" th:dtaid="${spcltyDta.dtaid}" th:onclick="|deleteSpcltyDta(this.getAttribute('dtaid'))|">삭제</button>
            </th:block>
            <button type='button' class="btn btn-disabled m-r-5" onclick="spcltyDtaGridHelper.removeHighlight(); spcltyDtaGridHelper.toggleContent()">취소</button>
            <th:block sec:authorize-url="/mng/spcltyDta/insertSpcltyDta.do">
                <button type='button' class="btn btn-primary" onclick="insertSpcltyDta()">저장</button>
            </th:block>
        </div>

        <input type="hidden" name="dtaid" id="dtaid" th:value="${spcltyDta.dtaid}"/>
    </form>

    <script th:inline="javascript">
        var spcltyDta = /*[[${spcltyDta}]]*/null;
        var editor = CKEDITOR.replace('cn', {enterMode: CKEDITOR.ENTER_BR});

        $(function () {
            pdfFileEvent();
            atchFileEvent();
            validateForm();
        })

        var deleteSpcltyDta = (dtaid) => {
            var deleteDtaids = dtaid;

            if (confirm('해당 게시물을 삭제하시겠습니까?')) {
                if (displayWorkProgress()) {
                    $.ajax({
                        method: 'post',
                        url: '/mng/spcltyDta/deleteSpcltyDta.do',
                        dataType: 'json',
                        data: {deleteDtaids: deleteDtaids},
                        success: function (response) {
                            alert(response.msg);
                            closeWorkProgress();
                            if (response.result == "success") {
                                bsnsOperDtaGridHelper.resetPageContent();
                            }
                        }
                    });
                }
            }
        }

        var insertSpcltyDta = () => {
            if ($('input[name=clsfCds]:checked').length == 0) {
                alert('분류를 선택해 주십시오.');
                return;
            }

            var editorData = editor.getData()
            $("#cn").val(editorData);

            if (!$('#registerForm').valid()) {
                return;
            }

            let url = '/mng/spcltyDta/insertSpcltyDta.do';

            if (!!$('#dtaid').val()) {
                url = '/mng/spcltyDta/updateSpcltyDta.do';
            }

            if (url == '/mng/spcltyDta/insertSpcltyDta.do') {
                var isSec = false;
                /*[# sec:authorize-url="/mng/spcltyDta/insertSpcltyDta.do"]*/
                isSec = true;
                /*[/]*/
                if (!isSec) {
                    alert('접근권한이 없습니다.');
                    return;
                }
            } else if (url == '/mng/spcltyDta/updateSpcltyDta.do') {
                var isSec = false;
                /*[# sec:authorize-url="/mng/spcltyDta/updateSpcltyDta.do"]*/
                isSec = true;
                /*[/]*/
                if (!isSec) {
                    alert('접근권한이 없습니다.');
                    return;
                }
            }

            if (displayWorkProgress()) {
                $.ajax({
                    method: 'post',
                    url: url,
                    dataType: 'json',
                    data: $('#registerForm').serializeArray(),
                    success: function (response) {
                        alert(response.msg);
                        closeWorkProgress();
                        if (response.result == "success") {
                            if(url == '/mng/spcltyDta/insertSpcltyDta.do') {
                                spcltyDtaGridHelper.resetListContent();
                            } else {
                                spcltyDtaGridHelper.resetPageContent();
                            }
                        }
                    }
                });
            }
        }

        var validateForm = () => {
            $('#registerForm').validate({
                ignore: [],
                rules: {
                    ttl: {required: true, maxlength: 200},
                    writr: {required: true, maxlength: 60},
                    yy: {number: true},
                    cn: {required: true, ckRequired: true},
                    cpyrhtCd: {required: true}

                },
                messages: {
                    ttl: {required: '제목을 입력해 주십시오.', maxlength: '제목은 200자를 넘을 수 없습니다.'},
                    yy: {number:'발행년도는 숫자만 입력 가능합니다.'},
                    writr: {required: '저자를 입력해 주십시오.', maxlength: '저자는 60자를 넘을 수 없습니다.'},
                    cn: {required: '내용을 입력해 주십시오.', ckRequired: '내용을 입력해 주십시오.'},
                    cpyrhtCd: {required: '저작권 종류를 선택해 주십시오.'}
                }
            });
        }

        var pdfFileEvent = () => {
            $('#pdfFile').on("change", function (event) {

                var objFile = document.querySelector('#pdfFile');
                var formData = new FormData();
                var content = "";

                for (i = 0; i < objFile.files.length; i++) {
                    formData.append("files", objFile.files[i]);
                }

                formData.append("filegrpid", $("#pdfFileid").val());
                formData.append("filegrpNm", "pdf_view_file");

                if (displayWorkProgress()) {
                    $.ajax({
                        url: '/uploadMultipleFiles.do',
                        processData: false,
                        contentType: false,
                        data: formData,
                        type: 'POST',
                        success: function (response) {
                            if (response.result == 'fail') {
                                alert(response.msg);
                            } else {
                                if ($("#pdfFileid").val() == '0' || $("#pdfFileid").val() == '' || $("#pdfFileid").val() == null) {
                                    $("#pdfFileid").val(response[0].filegrpid);
                                }
                                for (i = 0; i < response.length; i++) {
                                    content = "<span class ='label label-inverse' id='" + response[i].fileid + "'>" + response[i].orginlFileNm;
                                    content += "<a class='text-white' href=javascript:deleteFile('" + response[i].fileid + "','" + response[i].fileIdntfcKey + "')>X</a></span>";
                                    $('#pdfFileUploadSuccess').append(content);
                                }
                            }
                            closeWorkProgress();
                        }
                    })

                    if (detectBrowser() == "other") {
                        $("#pdfFile").val("");
                    } else {
                        $("#pdfFile").replaceWith($("#pdfFile").clone(true))
                    }
                }
            });
        }

        var atchFileEvent = () => {
            $('#atchFile').on("change", function (event) {

                var objFile = document.querySelector('#atchFile');
                var formData = new FormData();
                var content = "";

                for (i = 0; i < objFile.files.length; i++) {
                    formData.append("files", objFile.files[i]);
                }

                formData.append("filegrpid", $("#atchFilegrpid").val());
                formData.append("filegrpNm", "spcltyDta_file");

                if (displayWorkProgress()) {
                    $.ajax({
                        url: '/uploadMultipleFiles.do',
                        processData: false,
                        contentType: false,
                        data: formData,
                        type: 'POST',
                        success: function (response) {
                            if (response.result == 'fail') {
                                alert(response.msg);
                            } else {
                                if ($("#atchFilegrpid").val() == '0' || $("#atchFilegrpid").val() == '' || $("#atchFilegrpid").val() == null) {
                                    $("#atchFilegrpid").val(response[0].filegrpid);
                                }
                                for (i = 0; i < response.length; i++) {
                                    content = "<span class ='label label-inverse' id='" + response[i].fileid + "'>" + response[i].orginlFileNm;
                                    content += "<a class='text-white' href=javascript:deleteFile('" + response[i].fileid + "','" + response[i].fileIdntfcKey + "')>X</a></span>";
                                    $('#atchFileUploadSuccess').append(content);
                                }
                            }
                            closeWorkProgress();
                        }
                    })

                    if (detectBrowser() == "other") {
                        $("#atchFile").val("");
                    } else {
                        $("#atchFile").replaceWith($("#atchFile").clone(true))
                    }
                }
            });
        }
    </script>
</div>
