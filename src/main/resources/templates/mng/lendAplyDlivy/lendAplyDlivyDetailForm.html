<form id="dlivyForm">
    <div class="card-header p-b-0">
        <h3 class="sub-title"><strong>신청자 정보</strong></h3>
    </div>
    <div class="card-block-small p-t-0">
        <div class="row">
            <div class="col-lg-3 mb-3">
                <div class="mb-0 form-group ">
                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>신청상태</strong></div>
                    <th:block kattr:select_code="searchSttsCd" grpCd="231" upprCd="0" th:attr="selectedCd=${lendAplyInfo.sttsCd}" disabled onchange="" firstOptTxt="- 전체 -" addClass="form-select form-select-sm form-control-sm" isAdmin="true"></th:block>
                </div>
            </div>
            <div class="col-lg-9 mb-3">
                <div class="mb-0 form-group ">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>대여불가 사유</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" th:value="${lendAplyInfo.rejectRsn}" readonly/>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>신청자</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" th:value="${lendAplyInfo.aplcntNm}" readonly/>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-3">
                <div class="mb-0 form-group required">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>전화번호</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="telno" th:value="${lendAplyInfo.telno}" readonly/>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-3">
                <div class="mb-0 form-group required">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>이메일</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="eml" th:value="${lendAplyInfo.eml}" readonly/>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6 col-lg-3 mb-3">
                <div class="mb-0 form-group required">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>단체명</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="grpNm" placeholder="단체명" th:value="${lendAplyInfo.grpNm}" readonly/>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-3">
                <div class="mb-0 form-group required">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>교육횟수</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="eduCnt" placeholder="교육횟수" th:value="${lendAplyInfo.eduCnt}" readonly/>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-3">
                <div class="mb-0 form-group required">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>교육인원수</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="eduNope" placeholder="교육 인원수 " th:value="${lendAplyInfo.eduNope}" readonly/>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6 col-lg-3 mb-3">
                <div class="mb-0 form-group required">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>수령인</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="recptr" placeholder="수령인" th:value="${lendAplyInfo.recptr}" readonly/>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-3">
                <div class="mb-0 form-group required">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>수령인 전화번호</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="recptrTelno" placeholder="수령인 전화번호" th:value="${lendAplyInfo.recptrTelno}" readonly/>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-3">
                <div class="mb-0 form-group required">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>수령인 이메일</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="recptrEml" placeholder="수령인 전화번호" th:value="${lendAplyInfo.recptrEml}" readonly/>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3 col-lg-2 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>배송지 우편번호</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="dlvyZip" placeholder="배송지 우편번호" th:value="${lendAplyInfo.dlvyZip}" readonly/>
                    </div>
                </div>
            </div>
            <div class="col-md-9 col-lg-4 mb-3">
                <div class="mb-0 form-group required">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>배송지 주소</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="dlvyAddr" placeholder="배송지 주소" th:value="${lendAplyInfo.dlvyAddr}" readonly/>
                    </div>
                </div>
            </div>
            <div class=" col-lg-6 mb-3">
                <div class="mb-0 form-group required">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>배송지 주소 상세</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="dlvyAddrDtl" placeholder="배송지 주소 상세" th:value="${lendAplyInfo.dlvyAddrDtl}" readonly/>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-header p-t-0 p-b-0">
        <h3 class="sub-title"><strong>꾸러미 정보</strong></h3>
    </div>
    <div class="card-block-small p-t-0">
        <div class="row">
            <div class="col-lg-6 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>배송상태</strong></label>
                    <div class="align-items-end row">
                        <div class="col-sm-6">
                            <th:block kattr:select_code="dlvySttsCd" grpCd="230" upprCd="0" th:attr="selectedCd=${lendAplyInfo.dlvySttsCd}" disabled  firstOptTxt="없음" addClass="form-select form-select-sm form-control-sm" isAdmin="true"></th:block>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6 mb-3">
                <div class="mb-0 form-group">
                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>대여모집</strong></div>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" th:value="${lendInfo.rcritNm}" readonly>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>신청수량</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" placeholder="Text Input Validation" th:value="${lendAplyInfo.qnty}" readonly>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>대여기간</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" th:value="${lendAplyInfo.lendBgngDe+' ~ ' + lendAplyInfo.lendEndDe}" readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-3 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>꾸러미명</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" th:value="${lendInfo.packageNm}" readonly>
                    </div>
                </div>
            </div>
            <div class="col-lg-9 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>꾸러미 정보</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" placeholder="꾸러미 정보"
                               th:value="'*유형 : '+${lendInfo.typeCdNm} + '   *교육주제 : '+ ${lendInfo.eduSbjctCdNm} + '   *교육대상 :' + ${lendInfo.eduTrgtCdNm}
                                     +'   *모둠구성 : '+ ${lendInfo.teamCmpstnCdNm} +'   *교육유형 : '+ ${lendInfo.eduTypeCdNm}"
                               readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="card-header p-t-0 p-b-0">
                <h3 class="sub-title"><strong>출고정보</strong></h3>
            </div>
            <div class="card-block-small p-t-0">
                <div th:if="${aplyDlivyList.size() > 0}" th:each="item : ${aplyDlivyList}" class="row align-items-end mb-3 indvd-no" th:id="${'packageIndvdNo' + itemStat.count}">
                    <div class="col-auto">
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" th:onclick="fn_openSearchModal([[${itemStat.count}]]);" ><i class="icofont icofont-check-circled"></i>개체선택</button>
                    </div>
                    <div class="col ps-0 package-indvd-id-body">
                        <input type="hidden" name="packageindvdids" class="package-indvd-id" th:value="${item.packageindvdid}"/>
                        <span class="label label-inverse">
                            <span>[[${item.indvdno}]]</span> <a class="text-white delete-btn cursor-pointer">X</a>
                        </span>
                    </div>
                </div>
                <div th:unless="${aplyDlivyList.size() > 0}" th:each="item : ${#numbers.sequence(1,lendAplyInfo.qnty)}" class="row align-items-end mb-3 indvd-no" th:id="${'packageIndvdNo' + itemStat.count}">
                    <div class="col-auto">
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" th:onclick="fn_openSearchModal([[${itemStat.count}]]);" ><i class="icofont icofont-check-circled"></i>개체선택</button>
                    </div>
                    <div class="col ps-0 package-indvd-id-body">
                        <input type="hidden" name="packageindvdids" class="package-indvd-id" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-6 col-lg-3 mb-3">
                        <div class="mb-0 form-group required">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>택배사</strong></label>
                            <div class="col-12">
                                <th:block kattr:select_code="hdryInstCd" grpCd="235" upprCd="0" selectedCd="" onchange="" firstOptTxt="- 선택 -" addClass="form-select form-select-sm form-control-sm" isAdmin="true" th:attr="selectedCd=${lendAplyInfo.hdryInstCd}"></th:block>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3 mb-3">
                        <div class="mb-0 form-group required">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>송장번호</strong></label>
                            <div class="col-12">
                                <input type="text" class="form-control form-control-sm" name="invcnoDlivy" id="invcnoDlivy" placeholder="송장번호 입력해주세요." th:value="${lendAplyInfo.invcnoDlivy}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-block-small">
        <button type="button" class="btn btn-disabled m-r-5" onclick="javascript:gridHelper1.removeHighlight(); gridHelper1.toggleContent();">취소</button>
        <th:block sec:authorize-url="/mng/lendAplyDlivy/updateLendAplyDlivy.do">
            <button th:if="${lendAplyInfo.dlvySttsCd eq '230102'}" type="button" class="btn btn-primary" onclick="savePrc();">출고정보 수정</button>
        </th:block>
        <th:block sec:authorize-url="/mng/lendAplyDlivy/insertLendAplyDlivy.do">
            <button th:if="${lendAplyInfo.dlvySttsCd eq '230101'}" type="button" class="btn btn-primary" onclick="savePrc();">출고처리</button>
        </th:block>
    </div>

    <input type="hidden" id="aplyid"   name="aplyid"    th:value="${lendAplyInfo.aplyid}" />
    <input type="hidden" id="rndid"   name="rndid"    th:value="${lendAplyInfo.rndid}" />
    <input type="hidden" id="packSttsCd"   name="packSttsCd" value="216102" />
    <input type="hidden" id="dlvySttsCd"  name="dlvySttsCd" value="230102" />
    <input type="hidden" id="packageid"  th:value="${lendAplyInfo.packageid}" />
</form>

<div class="clone-indvd" style="display: none;">
    <span class="label label-inverse">
        <span></span><a class="text-white delete-btn cursor-pointer">X</a>
    </span>
</div>


<div class="modal fade" id="packageIndvdSearchPopup" aria-hidden="true" data-bs-backdrop="static"></div>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script type="text/javascript" src="/files/assets/pages/advance-elements/select2-custom.js"></script>
<script th:inline="javascript">
    var dlvySttsCd = /*[[${lendAplyInfo.dlvySttsCd}]]*/null;
    var deletePackageindvdid = "";

    $(function (){
        $('.delete-btn').on('click', function (){
            deletePackageindvdid += '&deletePackageindvdids='+$(this).parent().siblings('.package-indvd-id').val();
            $(this).closest('.package-indvd-id-body').find('.package-indvd-id').val('');
            $(this).closest('.label-inverse').remove();
        });
    })

    var validator= $("#dlivyForm").validate({
        onsubmit: false,
        rules:{
            hdryInstCd:{ required: true },
            invcnoDlivy:{ required: true }
        },
        messages:{
            hdryInstCd:{ required: "택배사 코드를 선택해주세요." },
            invcnoDlivy:{ required: "송장번호를 입력해주세요." },
        }
    });

    function savePrc(){
        let indvdValid = true;
        $('input[name=packageindvdids]').each(function (item){
            let indvdid = $(this).val();
            if(indvdid === ''){
                indvdValid = false;
            }
        });
        if(!indvdValid){
            alert("개체선택을 해주세요.");
            return;
        }
        if(!$('#dlivyForm').valid()) return;
        let data = $('#dlivyForm').serialize();
        data += deletePackageindvdid;
        if(!confirm(dlvySttsCd === '230101' ? '출고처리하겠습니까?' : '출고정보를 수정하겠습니까?')) return;
        if(displayWorkProgress()) {
            $.ajax({
                url : dlvySttsCd === '230101' ? '/mng/lendAplyDlivy/insertLendAplyDlivy.do' : '/mng/lendAplyDlivy/updateLendAplyDlivy.do',
                type: "POST",
                cache: false,
                dataType: "json",
                data: data,
                success: function(response) {
                    if(response.result == "success") {
                        alert(response.msg);
                        gridHelper1.resetListContent();
                    } else {
                        alert(response.msg);
                    }
                    closeWorkProgress();
                }
            });
        }
    }


    var popupUrl = "/mng/lendAplyDlivy/packageIndvdSearchPopup.html?";
    var userAddModal;
    var instManagerSearchModal;

    function fn_openSearchModal(idx){
        const idxParam = '&idx='+idx;
        const packageid = '&packageid='+$("#packageid").val();
        let packageindvdidParam = '';
        $('input[name=packageindvdids]').each(function (item){
            packageindvdidParam += '&packageindvdids='+ $(this).val();
        });
        var url = popupUrl + idxParam + packageid + packageindvdidParam;
        $("#packageIndvdSearchPopup").load(url, function(response, status, xhr) {
            if (status == "success") {
                instManagerSearchModal = new bootstrap.Modal($('#packageIndvdSearchPopup'));
                instManagerSearchModal.show();
            }
        });
    }

    function fn_packageChose(idx){
        const $modalBody = $("#packageListBody");
        const $checked = $modalBody.find(".singleRadiobox:checked");
        const $cloneIndvd = $('.clone-indvd .label');
        const $appendBody = $('#packageIndvdNo'+idx);
        const no = $checked.data('indvdno');
        const id = $checked.data('packageindvdid');
        if ($checked.length === 0) {
            alert("개체을 선택해주세요.");
            return;
        }

        let $item = $cloneIndvd.clone(true);
        if($appendBody.find('.package-indvd-id-body').children().length > 1){
            $appendBody.find('.package-indvd-id-body').children().last().remove();
        }
        $appendBody.find('.package-indvd-id-body').append($item);
        $appendBody.find('input[name=packageindvdids]').val(id);
        $appendBody.find('.label-inverse span').text(no);
        instManagerSearchModal.hide();
    }
</script>