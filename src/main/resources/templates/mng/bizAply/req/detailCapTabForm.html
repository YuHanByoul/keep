<form id="insertForm">
    <input type="hidden" name="aplyid" id="aplyid" th:value="${detail.aplyid}" />
    <!-- [탭] 기관역량 -->
    <div class="tab-pane" id="tab_02" role="tabpanel">
        <div class="card">
            <!-- 사업계획요약 -->
            <div class="card-header p-b-0">
                <h3 class="sub-title"><strong>사업계획요약</strong></h3>
            </div>
            <div class="card-block-small p-t-0">
                <div class="form-group required mb-3">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="popupContents"><strong>사업목적(필요성)</strong></label>
                    <div class="col-sm-12">
                        <textarea rows="3" cols="5" class="form-control form-control-sm" placeholder="50자 이하의 사업목적(필요성) 표시" id="bsnsPrps" name="bsnsPrps"><th:block th:text="${detail.bsnsPrps}"></textarea>
                    </div>
                </div>
                <div class="form-group required mb-3">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="popupContents"><strong>사업개요</strong></label>
                    <div class="col-sm-12">
                        <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="200자 이하의 사업개요 표시" id="bsnsSumry" name="bsnsSumry"><th:block th:text="${detail.bsnsSumry}"></textarea>
                    </div>
                </div>
            </div>

            <!-- 환경교육의 전문성 -->
            <div class="card-header p-t-0 p-b-0">
                <h3 class="sub-title"><strong>환경교육의 전문성</strong></h3>
            </div>
            <div class="card-block-small p-t-0">
                <div class="row">
                    <div class="col-12 col-md-6 col-lg-3 mb-3">
                        <div class="mb-0 form-group">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="a"><strong>기관설립일</strong></label>
                            <div class="col-sm-12">
                                <input type="date" class="form-control form-control-sm" id="fondDe" name="fondDe" th:value="${detail.fondDe}">
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3 mb-3">
                        <div class="mb-0 form-group">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>환경교육 운영기간</strong></label>
                            <div class="col-sm-12">
                                <input type="text" class="form-control form-control-sm" id="operPrd" name="operPrd" placeholder="Text Input Validation"  th:value="${detail.operPrd}">
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3 mb-3">
                        <div class="mb-0 form-group">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>보유강사 및 경력</strong></label>
                            <div class="col-12">
                                <input type="text" class="form-control form-control-sm" id="instrctrCareer" name="instrctrCareer" placeholder="Text Input Validation"  th:value="${detail.instrctrCareer}">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-6 col-lg-3 mb-3">
                        <div class="mb-0 form-group">
                            <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>우수 환경교육프로그램 지정 여부</strong></div>
                            <div class="form-radio">
                                <span kattr:radio_yn="dsgnYn" label1="지정" label2="미지정" isAdmin="true" th:attr="defaultVal=${detail.dsgnYn == null ? 'Y' : detail.dsgnYn}"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3 mb-3">
                        <div class="mb-0 form-group">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>지정번호</strong></label>
                            <div class="col-sm-12">
                                <input type="text" class="form-control form-control-sm" id="dsgnNo" name="dsgnNo" placeholder="Text Input Validation"  th:value="${detail.dsgnNo}">
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3 mb-3">
                        <div class="mb-0 form-group">
                            <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>사회환경교육 지도사 보유여부</strong></div>
                            <div class="form-radio">
                                <span kattr:radio_yn="instrctrHoldYn" label1="보유" label2="미보유" isAdmin="true" th:attr="defaultVal=${detail.instrctrHoldYn == null ? 'Y' : detail.instrctrHoldYn}"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3 mb-3">
                        <div class="mb-0 form-group">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>자격번호</strong></label>
                            <div class="col-12">
                                <input type="text" class="form-control form-control-sm" id="qlfcNo" name="qlfcNo" placeholder="Text Input Validation"  th:value="${detail.qlfcNo}">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-md-6 col-lg-3 mb-3">
                        <div class="mb-0 form-group">
                            <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>전년도 지원사업 운영여부</strong></div>
                            <div class="form-radio">
                                <span kattr:radio_yn="bfryySportbsnsOperYn" label1="운영" label2="미운영" isAdmin="true" th:attr="defaultVal=${detail.bfryySportbsnsOperYn == null ? 'Y' : detail.bfryySportbsnsOperYn}"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6 mb-3">
                        <div class="mb-0 form-group">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>운영사업명</strong></label>
                            <div class="col-sm-12">
                                <input type="text" class="form-control form-control-sm" id="operbsnsNm" name="operbsnsNm" placeholder="Text Input Validation"  th:value="${detail.operbsnsNm}">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="mb-0 form-group">
                            <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>전년도 지원사업 프로그램 주제</strong></div>
                            <div class="dynamicDiv" th:if="${#lists.size(prgrmList) > 0}" >
	                            <div th:class="${i.index == 0 ? 'row subjectCode' : 'row subjectCode mt-1'}" th:each="list, i : ${prgrmList}">
	                                <div class="col-sm-3">                                
	                                    <span kattr:select_code="prgrmSbjctCd1" th:attr="selectedCd=${list.prgrmSbjctCd1}" grpCd="163" firstOptTxt="- 선택 -" addClass="input-sm" isAdmin="true">
	                                </div>
	                                <div class="col-sm-3 mt-1 mt-sm-0">
		                                <select name="prgrmSbjctCds" th:id="'prgrmSbjctCd_'+${i.index+1}" class="form-select form-select-sm">
			                            </select>
		                            </div>
		                            <!-- 기타내용 -->
	<!--                                 <div class="col-sm-3 mt-1 mt-sm-0"> -->
	<!--                                     <input type="text" class="form-control form-control-sm" id="" name="" placeholder="Text Input Validation"> -->
	<!--                                 </div> -->
	                                <div class="col-sm-3 mt-2 mt-sm-0 btnList" th:if="${i.last}">
	                                    <button onclick="addCode();" class="input-group-text btn btn-primary btn-sm">+</button>
	                                    <button onclick="removeCode();" class="input-group-text btn btn-primary btn-sm" th:if="${i.index > 0}">-</button>
	                                </div>
	                            </div>
                            </div>
                            <div class="dynamicDiv" th:unless="${#lists.size(prgrmList) > 0}">
	                            <div class="row subjectCode">
		                            <div class="col-sm-3 mt-1 mt-sm-0">
		                                <select name="prgrmSbjctCd1" id="prgrmSbjctCd1_1" class="form-select form-select-sm">
				                            <option value="" selected>- 선택 -</option>
				                        </select>
		                            </div>
		                            <div class="col-sm-3 mt-1 mt-sm-0">
		                                <select name="prgrmSbjctCds" id="prgrmSbjctCd_1" class="form-select form-select-sm">
		                                    <option value="" selected>- 선택 -</option>
		                                </select>
		                            </div>
		                            <div class="col-sm-3 mt-1 mt-sm-0 btnList">
		                                <button onclick="addCode();" class="input-group-text btn btn-primary btn-sm">+</button>
		                            </div>
	                            </div>
                            </div>            
                        </div>
                    </div>
                </div>
            </div>

            <!-- 환경교육 운영성과 -->
            <div class="card-header p-t-0 p-b-0">
                <h3 class="sub-title"><strong>환경교육 운영성과</strong></h3>
            </div>
            <div class="card-block-small p-t-0">
                <div class="table-responsive">
                    <table class="table table-framed table-bordered">
                        <thead>
                        <tr class="border-bottom-inverse">
                            <th colspan="2" class="text-center v-middle">구분</th>
                            <th class="text-center v-middle">사업명</th>
                            <th class="text-center v-middle">사업기간</th>
                            <th class="text-center v-middle">교육인원</th>
                            <th class="text-center v-middle">사업예산<br>(단위 : 백만원)</th>
                            <th class="text-center v-middle">주요 운영내용</th>
                            <th class="text-center v-middle" style="width:121px;">설정</th>
                        </tr>
                        </thead>
                        <tbody id="eduTable" th:if="${#lists.size(eduList) > 0}">
	                        <tr th:each="list, i: ${eduList}">
	                            <td th:if="${i.index == 0}" th:rowspan="${list.rowSpan}" class="table-active v-middle text-center"><th:block th:text="${list.seNm}"/></td>
	                            <td class="v-middle text-center"><th:block th:text="${list.ordr}"/></td>
	                            <td>
	                                <input type="hidden" name="seCd" id="seCd" th:value="${list.seCd}"/>
	                                <input type="text" class="form-control form-control-sm" placeholder="" id="bsnsNm" name="bsnsNm" th:value="${list.bsnsNm}">
	                            </td>
	                            <td>
	                                <input type="text" class="form-control form-control-sm" placeholder="" id="bsnsPrd" name="bsnsPrd" th:value="${list.bsnsPrd}">
	                            </td>
	                            <td>
	                                <input type="text" class="form-control form-control-sm" placeholder="" id="eduNope" name="eduNope" th:value="${list.eduNope}">
	                            </td>
	                            <td>
	                                <input type="text" class="form-control form-control-sm" placeholder="" id="bsnsBgt" name="bsnsBgt" th:value="${list.bsnsBgt}">
	                            </td>
	                            <td>
	                                <input type="text" class="form-control form-control-sm" placeholder="" id="operCn" name="operCn" th:value="${list.operCn}">
	                            </td>
	                            <td class="v-middle">
	                                <button onclick="addRow(this);" type="button" class="btn btn-primary btn-sm" th:if="${i.last}">추가</button>
	                                <button onclick="removeRow(this);" type="button" class="btn btn-inverse btn-sm">삭제</button>
	                            </td>
	                        </tr>
	                    </tbody>
                        <tbody id="eduTable" th:unless="${#lists.size(eduList) > 0}">
                            <tr>
                                <td rowspan="" class="table-active v-middle text-center">환경교육사업</td>
                                <td class="v-middle text-center">1</td>
                                <td>
                                    <input type="hidden" name="seCd" id="seCd" value="213101"/>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="bsnsNm" name="bsnsNm">
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="bsnsPrd" name="bsnsPrd">
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="eduNope" name="eduNope">
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="bsnsBgt" name="bsnsBgt">
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="operCn" name="operCn">
                                </td>
                                <td class="v-middle eduBtnArea">
                                    <button onclick="addRow(this);" type="button" class="btn btn-primary btn-sm">추가</button>
                                </td>
                            </tr>
                       </tbody>
                       <tbody id="etcTable" th:if="${#lists.size(etcList) > 0}">
                            <tr th:each="list, i: ${etcList}">
                                <td th:if="${i.index == 0}" th:rowspan="${list.rowSpan}" class="table-active v-middle text-center"><th:block th:text="${list.seNm}"/></td>
                                <td class="v-middle text-center"><th:block th:text="${list.ordr}"/></td>
                                <td>
                                    <input type="hidden" name="seCd" id="seCd" th:value="${list.seCd}"/>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="bsnsNm" name="bsnsNm" th:value="${list.bsnsNm}">
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="bsnsPrd" name="bsnsPrd" th:value="${list.bsnsPrd}">
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="eduNope" name="eduNope" th:value="${list.eduNope}">
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="bsnsBgt" name="bsnsBgt" th:value="${list.bsnsBgt}">
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="operCn" name="operCn" th:value="${list.operCn}">
                                </td>
                                <td class="v-middle">
                                    <button onclick="addRow(this);" type="button" class="btn btn-primary btn-sm" th:if="${i.last}">추가</button>
                                    <button onclick="removeRow(this);" type="button" class="btn btn-inverse btn-sm">삭제</button>
                                </td>
                            </tr>
                        </tbody>
                        <tbody id="etcTable" th:unless="${#lists.size(etcList) > 0}">
                            <tr>
                                <td rowspan="" class="table-active v-middle text-center">기타 공익사업</td>
                                <td class="v-middle text-center">1</td>
                                <td>
                                    <input type="hidden" name="seCd" id="seCd" value="213102"/>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="bsnsNm" name="bsnsNm">
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="bsnsPrd" name="bsnsPrd">
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="eduNope" name="eduNope">
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="bsnsBgt" name="bsnsBgt">
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" placeholder="" id="operCn" name="operCn">
                                </td>
                                <td class="v-middle">
                                    <button onclick="addRow(this);" type="button" class="btn btn-primary btn-sm">추가</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- // -->
            <div class="card-block-small">
                <button class="btn btn-disabled m-r-5" onclick="">취소</button>
                <button class="btn btn-primary" onclick="fn_save(); return false;">저장</button>
            </div>
        </div>
    </div>
</form>

<script th:inline="javascript">
	/*<![CDATA[*/
	var prgrmListSize = /*[[${#lists.size(prgrmList)}]]*/null;
	var prgrmList = /*[[${prgrmList}]]*/null;
	/*]]>*/
    var updateUrl = "/mng/bizAply/req/updateInst.do";
	/* 커스텀태그(공통코드) : 교육주제 */
    var getCodeListUrl = "/mng/customAttr/grpCodeList.do"
    
    $(function(){
        if (prgrmListSize == 0) {
            fn_getNextDepthList(163 , 0, 'prgrmSbjctCd1_1');
        }
        
        $("select[name='prgrmSbjctCd1']").each(function(i){
        	$(this).prop("id", "prgrmSbjctCd1_"+(i+1));
        	setNextDepth('163', $(this).val(), 'prgrmSbjctCd_'+(i+1));
        });
        
       	$(prgrmList).each(function(i){
            setTimeout(function(){
                $('#prgrmSbjctCd_'+(i+1)).val(prgrmList[i].prgrmSbjctCd).prop("selected", true);              
            }, 300);
        });
        
        $(".subjectCode").each(function(idx){
        	$(this).eq(idx).find("select[name=prgrmSbjctCd1]").on('change', function(){
        		setNextDepth('163',$(this).val(),'prgrmSbjctCd_'+(idx+1));
        	});
        });
    });

    function addCode() {
    	var codeSize = $(".subjectCode").length;
        for (var i = 0; i < codeSize; i++) {
            $(".btnList").remove();
            if (i+1 == codeSize) {
                var html = "<div class='row mt-2 subjectCode'>";
                    html +=   "<div class='col-sm-3 mt-1 mt-sm-0'>";
                    html +=       '<select name="prgrmSbjctCd1" id="prgrmSbjctCd1_'+(i+2)+'" class="form-select form-select-sm" onchange="setNextDepth(\'163\', this.value, \'prgrmSbjctCd_'+(i+2)+'\');">';
                    html +=           $("#prgrmSbjctCd1_1").html();
                    html +=       "</select>";
                    html +=   "</div>";
                    html += "<div class='col-sm-3 mt-1 mt-sm-0'>";
                    html +=   "<select name='prgrmSbjctCds' id='prgrmSbjctCd_"+(i+2)+"' class='form-select form-select-sm'>";
                    html +=       "<option value='' selected>- 선택 -</option>";
                    html +=       "</select>";
                    html +=   "</div>";
                    html += "<div class='col-sm-3 mt-1 mt-sm-0 btnList'>";
                    html +=     "<button onclick='addCode();' class='input-group-text btn btn-primary btn-sm'>+</button>";
                    html +=     "<button onclick='removeCode();' class='input-group-text btn btn-primary btn-sm'>-</button>";                     
                    html += "</div>";
                $(".dynamicDiv").append(html);
            }
        }
    }
    
    function removeCode() {
    	var codeSize = $(".subjectCode").length;
        for (var i = 0; i < codeSize; i++) {
            if (i+1 == codeSize) {
                $(".subjectCode").eq(i).remove();
                var html = "";
                    html += "<div class='col-sm-3 mt-1 mt-sm-0 btnList'>";
                    html +=     "<button onclick='addCode();' class='input-group-text btn btn-primary btn-sm'>+</button>";
                    if (codeSize > 2) {
                        html += "<button onclick='removeCode();' class='input-group-text btn btn-primary btn-sm'>-</button>";                           
                    }
                    html += "</div>";
                $(".subjectCode").eq(i-1).append(html);
            }
        }
    }
    
    // 테이블 로우 추가
    function addRow(obj) {
        var html = '<button onclick="addRow(this);" type="button" class="btn btn-primary btn-sm">추가</button>';
        html += '<button onclick="removeRow(this);" type="button" class="btn btn-inverse btn-sm">삭제</button>';
        var clickedRow = $(obj).parent().parent();
        var tbody = clickedRow.parent().attr("id");
        var rowspan = clickedRow.parent().find("tr:first").find("td").attr("rowspan");
        $(obj).remove();
        var newrow = clickedRow.clone();
        newrow.find("td > input").val("");
        newrow.find("td:last").html(html);
        console.log(tbody, ", rowspan=> ", rowspan);
        if (Number(rowspan) == 1) {
        	newrow.find("td:first").remove();
        }
        $("#"+tbody).find("tr:first").find("td:first").attr("rowspan", Number(rowspan)+1);
        newrow.insertAfter($("#"+tbody).find("tr:last"));
    }

    // 테이블 로우 삭제
    function removeRow(obj) {
        var html = '<button onclick="addRow(this);" type="button" class="btn btn-primary btn-sm">추가</button>';
        html += '<button onclick="removeRow(this);" type="button" class="btn btn-inverse btn-sm">삭제</button>';
        var tableObj = $(obj).parent().parent().parent();
        var clickedRow = $(obj).parent().parent();
        var tbody = clickedRow.parent().attr("id");
        
        if (Number(clickedRow.find("td:eq(1)").text()) == 1) {
        	return;
        }
        
        $(obj).parent().parent().remove();
        tableObj.find("tr:last").find("td:last").html(html);
    }
    
    function fn_getNextDepthList(grpcd , upprcd, targetId){
        $.ajax({
            url : getCodeListUrl,
            type: 'GET',
            cache : false,
            dataType: 'json',
            data: {
                  grpcd  : grpcd
                , upprcd : upprcd
            }, 
            success : function (data){
                writeHtml(grpcd,targetId,data,"");
            },
            error : function (error){
            }
        });
    }
    
    function writeHtml(grpcd,targetId,list,selected){
        var cntArr = targetId.split("_");
        var nextCnt = Number(cntArr[1])+1;
        var nextTarget = cntArr[0]+"_"+nextCnt;
           
        var html ="<select id='"+targetId+"' class ='form-control'>";
            html +="    <option value='' selected>- 전체 -</option>";
           
          for(var i=0 ; i < list.length;i++){
            if(list[i].cdid==selected){
            html +="    <option value="+list[i].cd+" selected>"+ list[i].cdNm+ "</option>";
            }else{
            html +="    <option value="+list[i].cd+">"+ list[i].cdNm+ "</option>";
            }
          }
          if(list.length == 0 && jQuery("#"+nextTarget)[0] != undefined){
        	  writeHtml(grpcd,nextTarget,list,selected);
          }
          html +="    </select>";
          $("#"+targetId).html(html);
    }
    
    function setNextDepth(grpcd , upprcd , targetId) {
    	fn_getNextDepthList(grpcd , upprcd , targetId);
    }
    
    // 저장
    function fn_save(){
        if(!($("#insertForm").valid())) return;
        
        if(!confirm("저장하시겠습니까?")) return;
        
        var data =  $("#insertForm").serialize();
        
        if(displayWorkProgress()){
            $.ajax({
                url : updateUrl,
                type: 'POST',
                cache : false,
                dataType: 'json',
                data : data,
                success : function (data){
                    if(data.result=="success"){
                        alert(data.msg);
//                         gridHelper1.loadContent("/mng/bizAply/req/reqUserTabForm.html?aplyid=" + $("#aplyid").val() + '&pcntstid=' + $("#pcntstid").val());
                    }else{
                        alert(data.msg);
                    }
                    closeWorkProgress();
                }
            });
        }
    }

</script>