<form id="mdlRptSbmsnFrm">
<input type="hidden" id="reportid" name="reportid" value="0">
<input type="hidden" id="aplyid" name="aplyid">
<input type="hidden" id="reportSeCd" name="reportSeCd" th:value="${bizRptVo.reportSeCd}">
<input type="hidden" id="atchFilegrpid" name="atchFilegrpid" value="0">
<input type="hidden" id="cnsltngTrgtCn" name="cnsltngTrgtCn">
<input type="hidden" id="reportBgngDt" name="reportBgngDt">
<input type="hidden" id="reportEndDt" name="reportEndDt">
<input type="hidden" name="jsonString" id="jsonString" />
    <div class="card">
        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>신청정보</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="row">
                <div class="col-12 col-md-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>접수번호</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="cmpnt-input" selectsearchcondition="rcptno" id="rcptno" name="rcptno" style="position:absolute;width:0px;margin:0px;padding:0px;visibility:hidden;">
                            <select class="select2-hidden-accessible" name="selectRcptno" id="selectRcptno" tabindex="-1" aria-hidden="true" ></select>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>기관명</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="instNm" name="instNm" placeholder="기관명" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>프로그램명</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" id="prgrmNm" name="prgrmNm" placeholder="프로그램명" readonly>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-md-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>신청자</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="userNmAcnt" name="userNmAcnt" placeholder="신청자" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>대상</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="trgt" name="trgt" placeholder="대상" maxlength="100">
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>프로그램 주제</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="sbjct" name="sbjct" placeholder="프로그램 주제" maxlength="150">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-md-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>제출일시</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="regDt" name="regDt" placeholder="제출 일시" th:value="${#calendars.format(#calendars.createNow(), 'yyyy-MM-dd HH:mm:ss')}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>제출상태</strong></label>
                        <div class="col-sm-12">
                            <span  kattr:select_code="reportSttsCd" th:attr="grpcd=203, selectedCd=203102" isAdmin="true" disabled></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>교육운영</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="table-responsive">
                <table class="table table-framed table-bordered" id="dataList">
                    <thead>
                    <tr class="border-bottom-inverse">
                        <th class="text-center v-middle" style="width: 60px;">구분</th>
                        <th class="text-center v-middle">일시</th>
                        <th class="text-center v-middle">차시</th>
                        <th class="text-center v-middle">인원</th>
                        <th class="text-center v-middle">시간(분)</th>
                        <th class="text-center v-middle">비고</th>
                        <th class="text-center v-middle">설정</th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th class="text-center v-middle">계획</th>
                            <td class="text-center v-middle">
                                <input type="hidden" name="seCd" value="209101"/>
                                <div class="row align-items-center">
                                    <div class="col-12 col-md-auto">
                                        <input type="date" name="bgngDe" class="form-control form-control-sm" title="시작일">
                                    </div>
                                    <div class="col-12 col-md-auto">
                                        <input type="date" name="endDe" class="form-control form-control-sm" title="종료일">
                                    </div>
                                </div>
                            </td>
                            <td class="text-center v-middle"><input type="text" name="rnd" class="form-control form-control-sm" title="차시"></td>
                            <td class="text-center v-middle"><input type="text" name="nope" class="form-control form-control-sm" title="인원"></td>
                            <td class="text-center v-middle"><input type="text" name="mnt" class="form-control form-control-sm" title="시간(분)"></td>
                            <td class="text-center v-middle"><input type="text" name="rmrk" class="form-control form-control-sm" title="비고"></td>
                            <td class="v-middle">-</td>
                        </tr>
                    </tbody>
                    <tbody id="nowTable">
                        <tr>
                            <th class="text-center v-middle" rowspan="2">현재</th>
                            <td class="text-center v-middle">
                                <input type="hidden" name="seCd" value="209102"/>
                                <div class="row align-items-center">
                                    <div class="col-12 col-md-auto">
                                        <input type="date" name="bgngDe" class="form-control form-control-sm" title="시작일">
                                    </div>
                                    <div class="col-12 col-md-auto">
                                        <input type="date" name="endDe" class="form-control form-control-sm" title="종료일">
                                    </div>
                                </div>
                            </td>
                            <td class="text-center v-middle"><input type="text" name="rnd" class="form-control form-control-sm" title="차시"></td>
                            <td class="text-center v-middle"><input type="text" name="nope" class="form-control form-control-sm" title="인원"></td>
                            <td class="text-center v-middle"><input type="text" name="mnt" class="form-control form-control-sm" title="시간(분)"></td>
                            <td class="text-center v-middle"><input type="text" name="rmrk" class="form-control form-control-sm" title="비고"></td>
                            <td class="v-middle"><button onclick="removeRow(this);" type="button" class="btn btn-inverse btn-sm">삭제</button></td>
                        </tr>
                        <tr>
                            <td class="text-center v-middle">
                                <input type="hidden" name="seCd" value="209102"/>
                                <div class="row align-items-center">
                                    <div class="col-12 col-md-auto">
                                        <input type="date" name="bgngDe" class="form-control form-control-sm" title="시작일">
                                    </div>
                                    <div class="col-12 col-md-auto">
                                        <input type="date" name="endDe" class="form-control form-control-sm" title="종료일">
                                    </div>
                                </div>
                            </td>
                            <td class="text-center v-middle"><input type="text" name="rnd" class="form-control form-control-sm" title="차시"></td>
                            <td class="text-center v-middle"><input type="text" name="nope" class="form-control form-control-sm" title="인원"></td>
                            <td class="text-center v-middle"><input type="text" name="mnt" class="form-control form-control-sm" title="시간(분)"></td>
                            <td class="text-center v-middle"><input type="text" name="rmrk" class="form-control form-control-sm" title="비고"></td>
                            <td class="v-middle">
                                <button onclick="addRow(this);" type="button" class="btn btn-primary btn-sm">추가</button>
                                <button onclick="removeRow(this);" type="button" class="btn btn-inverse btn-sm">삭제</button>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td class="text-center v-middle table-active" colspan="2"><strong>합계</strong></td>
                            <td class="text-center v-middle table-active"><strong id="rndSum"></strong></td>
                            <td class="text-center v-middle table-active"><strong id="nopeSum"></strong></td>
                            <td class="text-center v-middle table-active"><strong id="mntSum"></strong></td>
                            <td class="text-center v-middle table-active" colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>기타 및 증빙서류 첨부</strong></h3>
        </div>

        <div class="card-block-small p-t-0">
            <div class="row form-group mb-3">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="popupContents"><strong>기타</strong></label>
                <div class="col-sm-12">
                    <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="기타 내용" id="etcCn" name="etcCn" maxlength="500"></textarea>
                </div>
            </div>
        </div>

        <div class="card-block-small p-t-0">
            <div class="row form-group mb-3">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="popupContents"><strong>증빙서류</strong></label>
                <div class="col-sm-12">
                    <input id="multiFileInput" type="file" name="files" multiple accept="image/jpeg,image/gif,image/png,application/pdf" class="form-control form-control-sm"/>
                    <div class="mt-2 row">
                        <div class="col-auto">
                            <div id="multipleFileUploadError"></div>
                            <div id="multipleFileUploadSuccess">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-block-small">
            <button type="button" class="btn btn-disabled m-r-5" onclick="rptSbmsnGridHelper1.toggleContent();">목록</button>
            <button type="button" class="btn btn-primary" onclick="mdlRptSbmsnDtl.insert();">저장</button>
        </div>
    </div>
</form>

<script th:inline="javascript">
   /*<![CDATA[*/ 
   var aplyList = /*[[${aplyList}]]*/null; 
   /*]]>*/
   var selectedItem = null;
   setPackageSelectBox=()=>{
       var selectList = [ {id:' ', text:'- 선택 -', value:'',option:"selected"} ];
       aplyList.forEach(function(item){
           selectList.push({
                'id':item.aplyid
                , 'instNm':item.instNm
                , 'prgrmNm' : item.prgrmNm
                , 'userNmAcnt':item.userNmAcnt
                , 'text': item.rcptno
                , 'value' : item.rcptno
                , 'reportBgngDt' : item.reportBgngDt
                , 'reportEndDt' : item.reportEndDt
           })
       })
       $('#selectRcptno').select2({
           language: {
               noResults: function () {
                   return '검색결과가 없습니다.';
               }
           },
           data: selectList,
           templateSelection: function (item) {
               return item.text;
           }
     });
     //change event  
     $('#selectRcptno').on('select2:select', function(e){
           var item = e.params.data;
           $("#aplyid").val(item.id);
           $("#instNm").val(item.instNm);
           $("#prgrmNm").val(item.prgrmNm);
           $("#userNmAcnt").val(item.userNmAcnt);
           $("#rcptno").val(item.value);
           $("#reportBgngDt").val(item.reportBgngDt);
           $("#reportEndDt").val(item.reportEndDt);
           if(item.id==" " || item.id <= 0){
               selectedItem = null;   
           }else{
               selectedItem = item;
           }
           return item.text;
     })
     $('#selectRcptno').val(' ').trigger('change');
   }
   
   $(document).on("keyup", "input[name='rnd'],input[name='nope'],input[name='mnt']", function(){
       $(this).val($(this).val().replace(/[^0-9]/g, ''));
       rndSum();
       nopeSum();
       mntSum();
   });

   var validator = $("#mdlRptSbmsnFrm").validate({
       rules: {
    	   rcptno : {required: true }
           , trgt : { required: true, maxlength: 100 }
           , sbjct : { required: true, maxlength: 150 } 
       },
       messages: {
    	   rcptno : { required: "접수번호를 선택해주십시오." }
           , trgt    :   { required: "대상을 입력해주십시오.", maxlength: "대상은 100자 이상 입력할수 없습니다." }
           , sbjct    :   { required: "프로그램 주제를 입력해주십시오.", maxlength: "프로그램 주제는 150자 이상 입력할수 없습니다." }  
       }
   });
   
   var mdlRptSbmsnDtl= {
        insertUrl : "/mng/bizAply/bizRpt/insertReport.do",
        init : function(){
    		setPackageSelectBox();
        },
        fn_deleteFileList : function (fileid, fileIdntfcKey) {

    	    if(!confirm("파일을 삭제하시겠습니까?")){return;}
    	    fn_deleteFile(fileid, fileIdntfcKey);
    	    $("#file_"+fileid).remove();
    	},
    	fn_deleteFile : function (fileid, fileIdntfcKey){
    		  var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;

              $.ajax({
                 url : deleteFileUrl,
                 type: 'GET',
                 cache : false,
                 dataType: 'json',
                 success : function (data){
                     if(data.result=="success"){
                    	 $("#file_"+fileid).remove();
                         alert("파일삭제가 완료 되었습니다.");
                     }else{
                         alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                     }
                 },
                 error : function (error){
                 }
            })
        },
        insert : function () {
        	if(!($("#mdlRptSbmsnFrm").valid())) return;
        	var valid = true;
        	var jsonString = {"data" : []};
            $("#dataList").find("tr").each(function(i){
                if ($(this).find("input[name='bgngDe']").val() == "") {
                    alert("시작일시를 입력해 주십시오.");
                    showErrorMark($(this).find("input[name='bgngDe']"));
                    valid = false;
                    return false;
                }
                if ($(this).find("input[name='endDe']").val() == "") {
                    alert("종료일시를 입력해 주십시오.");
                    showErrorMark($(this).find("input[name='endDe']"));
                    valid = false;
                    return false;
                }
                if ($(this).find("input[name='bgngDe']").val() > $(this).find("input[name='endDe']").val()) {
                    alert("종료일은 시작일 이후여야 합니다.");
                    showErrorMark($(this).find("input[name='endDe']"));
                    valid = false;
                    return false;
                }
                if ($(this).find("input[name='rnd']").val() == "") {
                    alert("차시를 입력해 주십시오.");
                    showErrorMark($(this).find("input[name='rnd']"));
                    valid = false;
                    return false;
                }
                if ($(this).find("input[name='nope']").val() == "") {
                    alert("인원을 입력해 주십시오.");
                    showErrorMark($(this).find("input[name='nope']"));
                    valid = false;
                    return false;
                }
                if ($(this).find("input[name='mnt']").val() == "") {
                    alert("시간(분)을 입력해 주십시오.");
                    showErrorMark($(this).find("input[name='mnt']"));
                    valid = false;
                    return false;
                }
//                 if ($(this).find("input[name='rmrk']").val() == "") {
//                     alert("비고를 입력해 주십시오.");
//                     showErrorMark($(this).find("input[name='rmrk']"));
//                     valid = false;
//                     return false;
//                 }
            });
            
//             if ($.trim($("#multipleFileUploadSuccess").text()) == "") {
//                 alert("증빙서류를 첨부해주십시오");
//                 return;
//             }
            
            if (!valid) return;
            if(!confirm("저장 하시겠습니까?")) return;
            
            $("#dataList").find("tr").each(function(i){
                if ($(this).find("input[name='seCd']").val() == undefined) return true;
                jsonString.data.push({
                    operid: $(this).find("input[name='operid']").val() == undefined ? "0" : $(this).find("input[name='operid']").val()
                    , seCd: $(this).find("input[name='seCd']").val()
                    , bgngDe: $(this).find("input[name='bgngDe']").val()
                    , endDe: $(this).find("input[name='endDe']").val()
                    , rnd: $(this).find("input[name='rnd']").val()
                    , nope: $(this).find("input[name='nope']").val()
                    , mnt: $(this).find("input[name='mnt']").val()
                    , rmrk: $(this).find("input[name='rmrk']").val()
                });
            });
            
            if (jsonString.data.length == 0) jsonString = "";
            $("#jsonString").val(JSON.stringify(jsonString));
            console.log($("#jsonString").val());
            var data =  $("#mdlRptSbmsnFrm").serialize();
            if(displayWorkProgress()){
                $.ajax({
                    url : mdlRptSbmsnDtl.insertUrl,
                    type: 'POST',
                    cache : false,
                    traditional : true,
                    dataType: 'json',
                    data: data,
                    success : function (data){
                        if(data.result=="success"){
                            alert(data.msg);
                            rptSbmsnGridHelper1.resetListContent();
                        }else{
                            alert(data.msg);
                        }
                        closeWorkProgress();
                    }
                });
            }
        },
    };

    $(function() {

    	mdlRptSbmsnDtl.init();

        $('#multiFileInput').on("change", function(event) {

            var objFile = document.querySelector('#multiFileInput');
            var formData = new FormData();
            var content = "";

            for( i = 0 ; i < objFile.files.length ; i++) {
                formData.append("files", objFile.files[i]);
            }

            formData.append("filegrpid", $("#atchFilegrpid").val());
            formData.append("filegrpNm", "bizRptMng_file");


            $.ajax({
                url : '/uploadMultipleFiles.do',
                processData : false,
                contentType : false,
                data : formData,
                type : 'POST',
                success : function(response) {
                    if(response.result == 'fail'){
                        alert(response.msg);
                    }else{
                        if($("#atchFilegrpid").val()=='0' || $("#atchFilegrpid").val()==''  || $("#atchFilegrpid").val()==null){
                            $("#atchFilegrpid").val( response[0].filegrpid );
                        }

                        for(i = 0 ;i < response.length; i++ ){
                            content = "<span class ='label label-inverse mb-2' id='file_"+response[i].fileid+"'>"+response[i].orginlFileNm ;
                            content +="&nbsp;&nbsp;  <a  class = 'text-white' href = javascript:mdlRptSbmsnDtl.fn_deleteFile('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"')>X</a></span>&nbsp;&nbsp;";
                            $('#multipleFileUploadSuccess').append(content);
                        }
                    }
                }
            });

           if (detectBrowser() == "other") {
               $("#multiFileInput").val("");
           } else {
              $("#multiFileInput").replaceWith( $("#multiFileInput").clone(true))
           }


        });

    });

    // 테이블 로우 추가
    function addRow(obj) {
        var html = '<button onclick="addRow(this);" type="button" class="btn btn-primary btn-sm">추가</button>';
        html += '<button onclick="removeRow(this);" type="button" class="btn btn-inverse btn-sm">삭제</button>';
        var clickedRow = $(obj).parent().parent();
        var tbody = clickedRow.parent().attr("id");
        var rowspan = clickedRow.parent().find("tr:first").find("th").attr("rowspan");
        $(obj).remove();
        var newrow = clickedRow.clone();
        newrow.find("td > input").val("");
        newrow.find("td:last").html(html);
        if (Number(rowspan) == 1) {
            newrow.find("th:first").remove();
        }
        $("#"+tbody).find("tr:first").find("th:first").attr("rowspan", Number(rowspan)+1);
        newrow.insertAfter($("#"+tbody).find("tr:last"));
        
        $("#"+tbody).find("tr").each(function(i){
            $(this).find("input[name='seCd']").val("209102");   
        });
    }

    // 테이블 로우 삭제
    function removeRow(obj) {
        var addHtml = '<button onclick="addRow(this);" type="button" class="btn btn-primary btn-sm">추가</button>';
        var delHtml = '<button onclick="removeRow(this);" type="button" class="btn btn-inverse btn-sm">삭제</button>';
        var tableObj = $(obj).parent().parent().parent();
        var clickedRow = $(obj).parent().parent();
        var tbody = clickedRow.parent().attr("id");
        
        if (clickedRow.index() == 0) {
            alert("구분값의 첫번째 항목은 삭제할수 없습니다.");
            return;
        }
        
        clickedRow.remove();
//         console.log("삭제 후 => ", tbody, ", length ==> ", $("#"+tbody).find("tr").length, ", index => ", clickedRow.index());
        
        $("#"+tbody).find("tr:first").find("th:first").attr("rowspan", $("#"+tbody).find("tr").length);
        if ($("#"+tbody).find("tr").length == 1) {
            $("#"+tbody).find("tr:last").find("td:last").html(addHtml);
        } else {
            var html = addHtml + delHtml;           
            $("#"+tbody).find("tr:last").find("td:last").html(html);
        }
        
	     rndSum();
	     nopeSum();
	     mntSum();
    }
    
    function rndSum() {
        var retVal = 0;
        $("input[name='rnd']").each(function(i){
            retVal += Number($(this).val());
        });
        $("#rndSum").text(retVal);
    }
    function nopeSum() {
        var retVal = 0;
        $("input[name='nope']").each(function(i){
            retVal += Number($(this).val());
        });
        $("#nopeSum").text(retVal);
    }
    function mntSum() {
        var retVal = 0;
        $("input[name='mnt']").each(function(i){
            retVal += Number($(this).val());
        });
        $("#mntSum").text(retVal);
    }
</script>
