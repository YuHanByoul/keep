<div class="card">
    <div class="row p-20 p-b-0">
        <div class="col-12 col-md-8 mb-2 mb-md-0">
            <h5><strong>결과보고관리</strong></h5>
        </div>
    </div>
    <div class="card-block-small">
        <div class="table-responsive">
            <table class="table table-framed table-bordered mb-0">
                <thead>
                <tr class="border-bottom-inverse">
                    <th class="text-center v-middle">사업분야</th>
                    <th class="text-center v-middle">공모명</th>
                    <th class="text-center v-middle">진행상태</th>
                    <th class="text-center v-middle">제출기간</th>
                    <th class="text-center v-middle">선정 사업</th>
                    <th class="text-center v-middle">제출</th>
                    <th class="text-center v-middle">컨설팅 대상</th>
                </tr>
                </thead>
                <tbody>
                <tr>

                    <td class="text-center v-middle"><th:block th:text="${bizMngInfo.fldCdNm}"></th:block></td>
                    <td class="text-center v-middle"><th:block th:text="${bizMngInfo.pcntstNm}"></th:block></td>
                    <td class="text-center v-middle"><th:block th:text="${bizMngInfo.prgrsSttsCdNm}"></th:block></td>
                    <td class="text-center v-middle"><th:block th:text="${bizMngInfo.mdlReportPrd}"></th:block></td>
                    <td class="text-center v-middle"><th:block th:text="${bizMngInfo.slctnBizCnt}"></th:block></td>
                    <td class="text-center v-middle"><th:block th:text="${bizMngInfo.sbmsnCnt}"></th:block></td>
                    <td class="text-center v-middle"><th:block th:text="${bizMngInfo.cnsltngUseCnt}"></th:block></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<form name="searchFrm2" id="searchFrm2" action="" onsubmit="return false;" class="card">
<input type="hidden" id="pcntstid" name="pcntstid" th:value="${bizMngInfo.pcntstid}">
<input type="hidden" id="searchBgngDt2" name="searchBgngDt" value="">
<input type="hidden" id="searchEndDt2"  name="searchEndDt"  value="">
<input type="hidden" id="reportSeCd"  name="reportSeCd"  value="204102"><!-- 결과보고 -->

    <div class="card-block-small">
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="mb-0 form-group row">
                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>제출상태</strong></div>
                    <div class="col-12">
                        <th:block kattr:select_code="searchReportSttsCd" grpCd="203" upprCd="0" selectedCd="" onchange="" firstOptTxt="- 전체 -" addClass="form-select form-select-sm form-control-sm" isAdmin="true"></th:block>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="mb-0 form-group row">
                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>키워드</strong></div>
                    <div class="input-group input-group-sm input-group-dropdown mb-0">
                        <select id="searchType" name="searchType" class="form-select form-control">
                            <option value="instNm">신청기관명</option>
                            <option value="userNm">신청자명</option>
                            <option value="prgrmNm">프로그램명</option>
                        </select>
                        <input type="text" class="form-control" aria-label="Text input with dropdown button" id="searchKeyword" name="searchKeyword" />
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="mb-0 form-group row">
                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>증빙서류 첨부</strong></div>
                    <div class="col-12">
                        <select id="evdncDcmntYn" name="evdncDcmntYn" firstOptTxt="- 전체 -" class="form-select form-select-sm form-control-sm">
                            <option value="Y">첨부</option>
                            <option value="N">미첨부</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="mb-0 form-group row">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="reportDt"><strong>제출일시</strong></label>
                    <div class="col-sm-12">
                        <input type="text" name="reportDt" id="reportDt" class="form-control form-control-sm" value=""/>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-1 p-t-20 text-center border-top">
            <button type="button" class="btn btn-disabled m-r-5" onclick="rsltRptSbmsn.initSearch();">초기화</button>
            <button type="submit" class="btn btn-primary" onclick="rsltRptSbmsn.onSearch();">검색</button>
            </div>
        </div>
    </div>
</form>

<div class="card">
    <div class="row p-20 p-b-0">
        <div class="col-12 col-md-8 mb-2 mb-md-0">
            <h5><strong>결과보고제출 검색결과</strong></h5>
        </div>
        <div class="col-12 col-md-4 text-right">
            <button type="button" class="btn btn-primary" onclick="rsltRptSbmsn.doCmptn();">완료</button>
            <button type="button" class="btn btn-primary" onclick="rsltRptSbmsn.downGridExcel();">엑셀다운로드</button>
        </div>
    </div>
    <div class="card-block-small">
        <table id="rsltRptSbmsnGrid" class="dt-responsive table-responsive"></table>
        <div id="rsltRptSbmsnPager" class="text-center"></div>
    </div>
</div>

<!-- 상세 -->
<div id="rsltRptSbmsnGridPanel" class="" style="display: none;"></div>
<!-- 상세 -->

<!-- 컨설팅대상팝업 -->
<div class="modal fade" id="cnsltngTrgtPopup" aria-hidden="true" data-bs-backdrop="static"/>


<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="/files/bower_components/bootstrap-daterangepicker/daterangepicker.js"></script>
<script th:inline="javascript">
    var rsltRptSbmsnGridHelper1;

    var rsltRptSbmsn = {
          listUrl  : "/mng/bizAply/bizRpt/selectRsltRptSbmsnList.do"
        , excelUrl : "/mng/bizAply/bizRpt/selectRsltRptSbmsnListExcel.do"
        , doCmptnUrl : "/mng/bizAply/bizRpt/updateRptSttsCd.do"
        , dtlUrl   : "/mng/bizAply/bizRpt/rsltRptSbmsnDetailForm.html"
        , selectedItems: []
        , init :
            function() {

        	//alert(" pcntstid : " + $("#pcntstid").val());
                //$("#searchFrm").prop("onsubmit","return false;")
                rsltRptSbmsnGridHelper1 = new GridHelper('rsltRptSbmsnGrid','rsltRptSbmsnGridPanel');

                rsltRptSbmsn.initSearch();
                rsltRptSbmsn.setGrid();
            }
        , initSearch :
            function() {

                $("#searchReportSttsCd, #searchType, #searchKeyword, #evdncDcmntYn, #reportDt, #searchBgngDt2, #searchEndDt2").val('');

                $("#searchType").val("instNm");

                $("#reportDt").daterangepicker({
                    autoUpdateInput: false,
                    locale: {
                        format: "YYYY-MM-DD",
                    },
                });

                $("#reportDt").on('apply.daterangepicker', function(ev, picker) {
                    $("#searchBgngDt2").val(picker.startDate.format('YYYY-MM-DD'));
                    $("#searchEndDt2").val(picker.endDate.format('YYYY-MM-DD'));
                    $(this).val(picker.startDate.format('YYYY-MM-DD') + ' - ' + picker.endDate.format('YYYY-MM-DD'));
                });

            }
        , onSearch :
            function() {

                rsltRptSbmsnGridHelper1.resetListContent();
            }
        , setGrid :
            function() {

                $("#rsltRptSbmsnGrid").jsGrid({
                    height: "auto"
                   , width: "100%"
                   , autoload: true
                   , sorting: false
                   , paging: true
                   , pagerContainer: "#rsltRptSbmsnPager"
                   , pagerFormat: "{first} {prev} {pages} {next} {last}"
                   , pagePrevText: "이전"
                   , pageNextText: "다음"
                   , pageFirstText: "< 처음 ㅣ"
                   , pageLastText: "ㅣ 마지막 >"
                   , noDataContent: "데이터가 없습니다."
                   , pageSize: 10
                   , pageButtonCount: 10
                   , pageLoading: true
                   , pageIndex: 1
                   , controller: {
                         loadData: function(filter) {
                             var data = $.Deferred();
                             var formData = $('#searchFrm2').serializeArray();
                             var params = [
                                 {name:"pageNumber", value:filter.pageIndex}
                               , {name:"rowPerPage", value:filter.pageSize}
                               , {name:"orderField", value:"reportid"}
                               , {name:"orderDirection", value:"desc"} ]
                             formData = formData.concat(params);

                             $.ajax({
                               type: "GET"
                             , contentType: "application/json; charset=utf-8"
                             , url      : rsltRptSbmsn.listUrl
                             , data     : formData
                             , dataType : "json"
                             }).done(function(response) {
                                 var da = {
                                     data       : escapeGridData(response.list)
                                   , itemsCount : response.totalCount
                                 };
                                 data.resolve(da);
                             });
                             return data.promise();
                         }
                     },
                     fields: [
                        {
                             headerTemplate: function() {
                                 return $("<input>").attr("type", "checkbox").attr("id", "selectAllCheckbox").on("change", function() {
                                    rsltRptSbmsn.allSelectItem($(this).is(":checked"), $(this).parent().next().text());
                                 });
                             },
                             itemTemplate: function(value, item) {
                                 return $("<input>").attr("type", "checkbox").attr("class", "singleCheckbox").attr("reportid", item.reportid).prop("checked", $.inArray(item, rsltRptSbmsn.selectedItems) > -1).on("change", function() {
                                     $(this).is(":checked") ? rsltRptSbmsn.selectItem($(this).attr("reportid")) : rsltRptSbmsn.unselectItem($(this).attr("reportid"));
                                 });
                             },
                             align: "center", width: "30", sorting: false
                        }
                        , {name: "aplyid"       , css: 'hide'}
                        , {name: "reportid"     , css: 'hide'}
                        , {title: "No."         , name: "rowNumber"      , type: "number", width: "80"     , align: "center", sorting: false}
                        , {title: "접수번호"    , name: "rcptno"         , type: "text"  , align: "center" , width: "50"}
                        , {title: "제출상태"    , name: "reportSttsCdNm" , type: "text"  , align: "center" , width: "50"}
                        , {title: "신청기관명"  , name: "instNm"         , type: "text"  , align: "lef"    , width: "150" }
                        , {title: "신청자"      , name: "userNmAcnt"     , type: "text"  , align: "lef"    , width: "100"}
                        , {title: "프로그램명"  , name: "prgrmNm"        , type: "text"  , align: "lef"    , width: "150" }
                        , {title: "제출일시"    , name: "sbmsnDt"        , type: "text"  , align: "center" , width: "80" }
                        , {title: "증빙서류"    , name: "evdncDcmntYn"   , type: "text"  , align: "center" , width: "80" }
                        , {title: "컨설팅 대상" , name: "cnsltngTrgtYn"  , type: "text"  , align: "center" , width: "80" }
                     ]
                     , rowClick: function(args) {

                         if(args.event.originalEvent.target.cellIndex == 0 || isNaN(args.event.originalEvent.target.cellIndex)) return;

                         if(args.event.originalEvent.target.cellIndex == 8 ){

                             var detailUrl = rsltRptSbmsn.dtlUrl + "?reportid=" + args.item.reportid;
                             rsltRptSbmsnGridHelper1.loadContent(detailUrl);
                             rsltRptSbmsnGridHelper1.rowClick(args);
                         }

                         if(args.event.originalEvent.target.cellIndex == 11 && args.item.cnsltngTrgtYn == "Y"){

                        	 fn_opencnsltngTrgtModal(args.item.reportid);
                         }


                     }
                     , resetGrid: function() {
                         rsltRptSbmsnGridHelper1.resetListContent();
                     }
                });
            }
        , allSelectItem: function(isChecked) {
            this.selectedItems = [];
            if(isChecked) {
                $('.singleCheckbox').each(function() {
                    this.checked = true;
                    rsltRptSbmsn.selectItem($(this).attr("reportid"));
                });
            } else {
                $('.singleCheckbox').each(function() {
                    this.checked = false;
                    rsltRptSbmsn.unselectItem($(this).attr("reportid"));
                });
                this.selectedItems = [];
            }
        },

        selectItem: function(reportid) {

            this.selectedItems.push(reportid);

            if($(".singleCheckbox").length == $(".singleCheckbox:checked").length) {
                $("#selectAllCheckbox").prop("checked", true);
            } else {
                $("#selectAllCheckbox").prop("checked", false);
            }
        },

        unselectItem: function(reportid) {
            this.selectedItems = $.grep(this.selectedItems, function(i) {
                return i !== reportid;
            });
            if(this.selectedItems.length == 0) {
                $('#selectAllCheckbox').attr("checked", false);
            }
            if($(".singleCheckbox").length == $(".singleCheckbox:checked").length) {
                $("#selectAllCheckbox").prop("checked", true);
            } else {
                $("#selectAllCheckbox").prop("checked", false);
            }
        }
        , doCmptn :
            function () {

        	    var chkData = rsltRptSbmsn.selectedItems;

                if(displayWorkProgress()){
                    $.ajax({
                        url : rsltRptSbmsn.doCmptnUrl,
                        type: 'POST',
                        cache : false,
                        traditional : true,
                        dataType: 'json',
                        data: { reportids : chkData},
                        success : function (data){
                            if(data.result=="success"){
                                alert(data.msg);
                                rsltRptSbmsnGridHelper1.resetListContent();
                            }else{
                                alert(data.msg);
                            }
                            closeWorkProgress();
                        }
                    });
                }
            }
        , downGridExcel :
            function () {
                var f = document.searchFrm2;
                f.action = rsltRptSbmsn.excelUrl;
                f.submit();
            }
    }


    //컨설팅대상 팝업
    var cnsltngTrgtUrl = "/mng/bizAply/bizRpt/cnsltngTrgtPopup.html";
    var cnsltngTrgtModal;
    var fn_opencnsltngTrgtModal =(id)=> {
debugger;
        var keyid = id;
        //$("#reportid").val();
        var url = cnsltngTrgtUrl + "?reportid="+keyid+"&mode=req";

        $("#cnsltngTrgtPopup").load(url, function(response, status, xhr) {
            if (status == "success") {
                cnsltngTrgtModal = new bootstrap.Modal($('#cnsltngTrgtPopup'));
                cnsltngTrgtModal.show();
            }
        });
    }


    $(function() {
        rsltRptSbmsn.init();
    });
</script>

