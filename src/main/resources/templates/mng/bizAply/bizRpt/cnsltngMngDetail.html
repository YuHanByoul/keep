<form id="cnsltngMngDetailFrm">
    <input type="hidden" id="aplyid" name="aplyid" th:value="${cnsltngDtlInfo.aplyid}">
    <input type="hidden" id="cnsltngid" name="cnsltngid" th:value="${cnsltngDtlInfo.cnsltngid}">
    <input type="hidden" id="cnstntid" name="cnstntid" th:value="${cnsltngDtlInfo.cnstntid}">
    <input type="hidden" id="atchFilegrpid" name="atchFilegrpid" th:value="${cnsltngDtlInfo.atchFilegrpid}">
    <input type="hidden" id="rgnCd" name="rgnCd" th:value="${cnsltngDtlInfo.rgnCd}">

    <div class="card-header p-b-0">
        <h3 class="sub-title"><strong>신청정보</strong></h3>
    </div>
    <div class="card-block-small p-t-0">
        <div class="row">
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>접수번호</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" id="rcptno" name="rcptno" placeholder="" th:value="${cnsltngDtlInfo.rcptno}" readonly>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>기관명</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" id="instNm" name="instNm" placeholder="" th:value="${cnsltngDtlInfo.instNm}" readonly>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>프로그램명</strong></label>
                    <div class="col-12">
                        <input type="text" class="form-control form-control-sm" id="prgrmNm" name="prgrmNm" placeholder="" th:value="${cnsltngDtlInfo.prgrmNm}" readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>신청자</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" id="userNmAcnt" name="userNmAcnt" placeholder="" th:value="${cnsltngDtlInfo.userNmAcnt}" readonly>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>신청자 연락처</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" id="aplcntTelno" name="aplcntTelno" placeholder="" th:value="${cnsltngDtlInfo.aplcntTelno}" readonly>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>신청자 이메일</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" id="aplcntEml" name="aplcntEml" placeholder="" th:value="${cnsltngDtlInfo.aplcntEml}" readonly>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>권역</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" id="instSareaCdNm" name="instSareaCdNm" placeholder="" th:value="${cnsltngDtlInfo.instSareaCdNm}" readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>지역</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" id="rgnCdNm" name="rgnCdNm" placeholder="" th:value="${cnsltngDtlInfo.rgnCdNm}" readonly>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>교육대상</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" id="eduTrgt" name="eduTrgt" placeholder="" th:value="${cnsltngDtlInfo.eduTrgt}" readonly>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>프로그램 주제</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" id="essntlSbjctNm" name="essntlSbjctNm" placeholder="" th:value="${cnsltngDtlInfo.essntlSbjctNm}" readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-lg-6 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>주소</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" id="instAddr" name="instAddr" placeholder="" th:value="${cnsltngDtlInfo.instAddr}" readonly>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>상세주소</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" id="instAddrDtl" name="instAddrDtl" placeholder="" th:value="${cnsltngDtlInfo.instAddrDtl}" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-header p-t-0 p-b-0">
        <h3 class="sub-title"><strong>현장방문 정보</strong></h3>
    </div>
    <div class="card-block-small p-t-0">
        <div class="row">
            <div class="col-12 col-md-6 col-lg-3 mb-3">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="date01"><strong>현장방문일시</strong></label>
                    <div class="col-sm-12">
                        <input type="datetime-local" class="form-control form-control-sm" id="vstDt" name="vstDt" th:value="${cnsltngDtlInfo.vstDt}">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-header p-t-0 p-b-0">
        <h3 class="sub-title"><strong>컨설팅결과</strong></h3>
    </div>
    <div class="card-block-small p-t-0">
        <div class="form-group mb-3">
            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="rslt"><strong>종합의견</strong></label>
            <div class="col-sm-12">
                <textarea rows="5" cols="5" class="form-control form-control-sm" maxlength="500" placeholder="종합의견 입력 (500자 이내)" id="rslt" name="rslt" ><th:block th:text="${cnsltngDtlInfo.rslt}" /></textarea>
            </div>
        </div>
        <div class="form-group mb-3">
            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="cnBfr"><strong>컨설팅 내용(사전)</strong></label>
            <div class="col-sm-12">
                <textarea rows="5" cols="5" class="form-control form-control-sm" maxlength="500" placeholder="컨설팅 내용(사전) 입력 (500자 이내)" id="cnBfr" name="cnBfr" ><th:block th:text="${cnsltngDtlInfo.cnBfr}" /></textarea>
            </div>
        </div>
        <div class="form-group mb-3">
            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="cnAftr"><strong>컨설팅 내용(사후)</strong></label>
            <div class="col-sm-12">
                <textarea rows="5" cols="5" class="form-control form-control-sm" maxlength="500" placeholder="컨설팅 내용(사후) 입력 (500자 이내)" id="cnAftr" name="cnAftr" ><th:block th:text="${cnsltngDtlInfo.cnAftr}" /></textarea>
            </div>
        </div>
        <div class="form-group mb-3">
            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>첨부파일</strong></label>
            <div class="col-sm-12">
                <input id="multiFileInput" type="file" name="files" multiple accept="image/jpeg,image/gif,image/png,application/pdf" class="form-control form-control-sm"/>
            </div>
            <div class="mt-2">

                <div id="multipleFileUploadError"></div>
                <div id="multipleFileUploadSuccess">
                    <th:block th:if = "${fileList} != null" >
                        <th:block th:each="item:${fileList}" th:if = "${item.fileid} > 0">
                            <span class ='label label-inverse mb2' th:id="'file_'+${item.fileid}">
                                <th:block th:text="${item.orginlFileNm}"></th:block>&nbsp;&nbsp;
                                <a  class = 'text-white' href = "javascript:void(0)" th:name="${item.fileid}" th:attr="data-idntfc-key=${item.fileIdntfcKey}" th:onclick="cnsltngMngDtl.fn_deleteFile(this.name, this.dataset.idntfcKey)">X</a>
                            </span>
                        </th:block>
                    </th:block>
                </div>

            </div>
        </div>
    </div>
    <div class="card-block-small">
        <button type="button" class="btn btn-disabled m-r-5" onclick="cnsltngMngGridHelper.toggleContent();">목록</button>
        <button type="button" class="btn btn-inverse m-r-5" onclick="cnsltngMngDtl.printFrm()">인쇄</button>
        <button type="button" class="btn btn-primary" onclick="cnsltngMngDtl.saveFrm()">저장</button>
    </div>
</form>

<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="/files/bower_components/bootstrap-daterangepicker/daterangepicker.js"></script>
<script th:inline="javascript">

    var cnsltngMngDtl = {

    	insertUrl: "/mng/bizAply/bizRpt/insertCnsltngMng.do",
    	printFrm: function(){
    		var id = $("#aplyid").val();
    	    var popUrl = "/cmm/reporting/cnsltngResult_online.html?id="+id;

    	    var popupOption="scrollbars=yes,top=300, left=900,width=1000, height=600";
    	    vPrint = window.open(popUrl, "_blank", popupOption);
    	},
    	saveFrm : function(){

    		if(!confirm("저장 하시겠습니까?")){return;}

    		var formData = $("#cnsltngMngDetailFrm").serialize();

    		if(displayWorkProgress()){
                $.ajax({
                    url : cnsltngMngDtl.insertUrl,
                    type: 'POST',
                    cache : false,
                    traditional : true,
                    dataType: 'json',
                    data: formData,
                    success : function (data){
                        if(data.result=="success"){
                            alert(data.msg);
                            cnsltngMngGridHelper.resetPageContent();
                        }else{
                            alert(data.msg);
                        }
                        closeWorkProgress();
                    }
                });
    		}
    	},
        fn_deleteFileList : function (fileid, fileIdntfcKey) {

            if(!confirm("파일을 삭제하시겠습니까?")){return;}
            fn_deleteFile(fileid, fileIdntfcKey);
            $("#file_"+fileid).remove();

        },
        fn_deleteFile : function (fileid, fileIdntfcKey){
              var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;

              $.ajax({
                 url : deleteFileUrl,
                 type: 'GET',
                 cache : false,
                 dataType: 'json',
                 success : function (data){
                     if(data.result=="success"){
                         $("#file_"+fileid).remove();
                         alert("파일삭제가 완료 되었습니다.");
                     }else{
                         alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                     }
                 },
                 error : function (error){
                 }
            })
        }
    }


    var validator= $("#cnsltngMngDetailFrm").validate({
        rules: {

            rslt   : { maxlength:500 }
          , cnBfr  : { maxlength:500 }
          , cnAftr : { maxlength:500 }
        },
        messages: {
            rslt   : { maxlength:"종합의견은 500자 이하여야 합니다."}
          , cnBfr  : { maxlength:"컨설팅 내용(사전)은 500자 이하여야 합니다."}
          , cnAftr : { maxlength:"컨설팅 내용(사후)은 500자 이하여야 합니다."}
        }
    });

    $(function() {

        $('#multiFileInput').on("change", function(event) {

            var objFile = document.querySelector('#multiFileInput');
            var formData = new FormData();
            var content = "";

            for( i = 0 ; i < objFile.files.length ; i++) {
                formData.append("files", objFile.files[i]);
            }

            formData.append("filegrpid", $("#atchFilegrpid").val());
            formData.append("filegrpNm", "bizRptMng_file");

            $.ajax({
                url : '/uploadMultipleFiles.do',
                processData : false,
                contentType : false,
                data : formData,
                type : 'POST',
                success : function(response) {
                    if(response.result == 'fail'){
                        alert(response.msg);
                    }else{
                        if($("#atchFilegrpid").val()=='0' || $("#atchFilegrpid").val()==''  || $("#atchFilegrpid").val()==null){
                            $("#atchFilegrpid").val( response[0].filegrpid );
                        }

                        for(i = 0 ;i < response.length; i++ ){
                            content = "<span class ='label label-inverse mb-2' id='file_"+response[i].fileid+"'>"+response[i].orginlFileNm ;
                            content +="&nbsp;&nbsp;  <a  class = 'text-white' href = javascript:cnsltngMngDtl.fn_deleteFile('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"')>X</a></span>&nbsp;&nbsp;";
                            $('#multipleFileUploadSuccess').append(content);
                        }
                    }
                }
            });

           if (detectBrowser() == "other") {
               $("#multiFileInput").val("");
           } else {
              $("#multiFileInput").replaceWith( $("#multiFileInput").clone(true))
           }
        });

    });

</script>

