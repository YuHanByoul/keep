<form id="mdlRptSbmsnFrm">
<input type="hidden" id="reportid" name="reportid" th:value="${rsltRptSbmsnInfo.reportid}">
<input type="hidden" id="atchFilegrpid" name="atchFilegrpid" th:value="${rsltRptSbmsnInfo.atchFilegrpid}">
    <div class="card">
        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>신청정보</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="row">
                <div class="col-12 col-md-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>접수번호</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="rcptno" name="rcptno" placeholder="접수번호" th:value="${rsltRptSbmsnInfo.rcptno}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>기관명</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="instNm" name="instNm" placeholder="기관명" th:value="${rsltRptSbmsnInfo.instNm}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>프로그램명</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" id="prgrmNm" name="prgrmNm" placeholder="프로그램명" th:value="${rsltRptSbmsnInfo.prgrmNm}" >
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-md-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>신청자</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="userNmAcnt" name="userNmAcnt" placeholder="신청자" th:value="${rsltRptSbmsnInfo.userNmAcnt}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>대상</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="trgt" name="trgt" placeholder="대상" th:value="${rsltRptSbmsnInfo.trgt}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>프로그램 주제</strong></label>
                        <div class="col-sm-12">
<!--                             <input type="text" class="form-control form-control-sm" id="essntlSbjctNm" name="essntlSbjctNm" placeholder="프로그램 주제" th:value="${rsltRptSbmsnInfo.essntlSbjctNm}" readonly> -->
                            <input type="text" class="form-control form-control-sm" id="sbjct" name="sbjct" placeholder="프로그램 주제" th:value="${rsltRptSbmsnInfo.sbjct}" readonly>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-md-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>제출일시</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="regDt" name="regDt" placeholder="제출 일시" th:value="${rsltRptSbmsnInfo.regDt}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>제출상태</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="reportSttsCdNm" name="reportSttsCdNm" placeholder="제출 상태" th:value="${rsltRptSbmsnInfo.reportSttsCdNm}" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>교육운영</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="table-responsive">
                <table class="table table-framed table-bordered">
                    <thead>
                    <tr class="border-bottom-inverse">
                        <th class="text-center v-middle" style="width: 60px;">구분</th>
                        <th class="text-center v-middle">일시</th>
                        <th class="text-center v-middle">차시</th>
                        <th class="text-center v-middle">인원</th>
                        <th class="text-center v-middle">시간(분)</th>
                        <th class="text-center v-middle">비고</th>
                    </tr>
                    </thead>
                    <tbody>

                        <th:block th:if="${reportOperList != null}">
<!--                             <th:block th:each="row,  i : ${reportOperList}"> -->
                                <tr th:each="row,  i : ${reportOperList}">

                                    <th class="text-center v-middle" th:if="${i.count==1}" th:rowspan="${row.planCnt}"><th:block th:text="${row.seCdNm}" /></th></th:if>
                                    <th class="text-center v-middle" th:if="${i.count==row.planCnt+1}" th:rowspan="${row.nowCnt}"><th:block th:text="${row.seCdNm}" /></th></th:if>
                                    <td class="text-center v-middle"><th:block th:text="${row.bgngDe +'~'+ row.endDe}" /></th>
                                    <td class="text-center v-middle"><th:block th:text="${row.rnd}" /></th>
                                    <td class="text-center v-middle"><th:block th:text="${row.nope}" /></th>
                                    <td class="text-center v-middle"><th:block th:text="${row.mnt}" /></th>
                                    <td class="text-center v-middle"><th:block th:text="${row.rmrk}"/></th>
                                </tr>
<!--                             </th:block> -->
                        </th:block>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td class="text-center v-middle table-active" colspan="2"><strong>합계</strong></td>
                        <th:block th:if="${reportOperList != null and #lists.size(reportOperList) > 0 }">
                            <td class="text-center v-middle table-active"><strong><th:block th:text="${reportOperList[0].sumRnd}"/></strong></td>
                            <td class="text-center v-middle table-active"><strong><th:block th:text="${reportOperList[0].sumNope}"/></strong></td>
                            <td class="text-center v-middle table-active"><strong><th:block th:text="${reportOperList[0].sumMnt}"/></strong></td>
                            <td class="text-center v-middle table-active"></td>
                        </th:block>
                        <th:block th:unless="${reportOperList != null and #lists.size(reportOperList) > 0 }">
                            <td class="text-center v-middle table-active"><strong></strong></td>
                            <td class="text-center v-middle table-active"><strong></strong></td>
                            <td class="text-center v-middle table-active"><strong></strong></td>
                            <td class="text-center v-middle table-active"></td>
                        </th:block>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>기타 및 증빙서류 첨부</strong></h3>
        </div>

        <div class="card-block-small p-t-0">
            <div class="row form-group mb-3">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="popupContents"><strong>기타</strong></label>
                <div class="col-sm-12">
                    <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="기타 내용" id="etcCn" name="etcCn" readonly><th:block th:text="${rsltRptSbmsnInfo.etcCn}"></th:block></textarea>
                </div>
            </div>
        </div>

        <div class="card-block-small p-t-0">
            <div class="row form-group mb-3">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="popupContents"><strong>증빙서류</strong></label>
                <div class="col-sm-12">
                    <input id="multiFileInput" type="file" name="files" multiple accept="image/jpeg,image/gif,image/png,application/pdf" class="form-control form-control-sm"/>
                    <div class="mt-2 row">
                        <div class="col-auto">
                            <div id="multipleFileUploadError"></div>
                            <div id="multipleFileUploadSuccess">
                                <th:block th:if = "${fileList} != null" >
                                    <th:block th:each="item:${fileList}" th:if = "${item.fileid} > 0">
                                        <span class ='label label-inverse ' th:id="'file_'+${item.fileid}">
                                            <th:block th:text="${item.orginlFileNm}"></th:block>&nbsp;&nbsp;
                                            <a  class = 'text-white' href = "javascript:void(0)" th:name="${item.fileid}" th:attr="data-idntfc-key=${item.fileIdntfcKey}" th:onclick="mdlRptSbmsnDtl.fn_deleteFile(this.name, this.dataset.idntfcKey)">X</a>
                                        </span>
                                    </th:block>
                                </th:block>
                            </div>
                        </div>
                    </div>

                </div>



        <div class="card-block-small">
            <button type="button" class="btn btn-disabled m-r-5" onclick="mdlRptSbmsnGridHelper1.toggleContent();">목록</button>
            <button type="button" class="btn btn-inverse m-r-5" onclick="mdlRptSbmsnDtl.openPopupCnsltngTrgt();" >컨설팅 대상</button>
            <button type="button" class="btn btn-primary" onclick="mdlRptSbmsnDtl.doCmptn();">완료</button>
        </div>


        <div class="row p-20 p-b-0">
            <div class="col-12 col-md-8 mb-2 mb-md-0">
                <h5><strong>보완요청</strong></h5>
            </div>
            <div class="col-12 col-md-4 text-right">
                <button type="button" class="btn btn-primary" onclick="fn_openRptSplmntDmndModal();">보완요청</button>
            </div>
        </div>
        <div class="card-block-small">
            <table id="splmntDmndGrid" class="dt-responsive table-responsive"></table>
            <div id="splmntDmndPager" class="text-center"></div>
        </div>

    </div>
</form>
<!-- 보안요청팝업 -->
<div class="modal fade" id="rptSplmntDmndPopup" aria-hidden="true" data-bs-backdrop="static"/>

<!-- 컨설팅대상팝업 -->
<!-- <div class="modal fade" id="cnsltngTrgtPopup" aria-hidden="true" data-bs-backdrop="static"/> -->

<script th:inline="javascript">


    var mdlRptSbmsnDtl= {
        listUrl  : "/mng/bizAply/bizRpt/selectSplmntDmndList.do",
        doCmptnUrl : "/mng/bizAply/bizRpt/updateRptSttsCd.do",
        init : function(){

    		mdlRptSbmsnDtl.setGrid();
        },
        setGrid : function() {

    	    $("#splmntDmndGrid").jsGrid({
    	        height: "auto"
                , width: "100%"
                , autoload: true
                , sorting: false
                , paging: true
                , pagerContainer: "#splmntDmndPager"
                , pagerFormat: "{first} {prev} {pages} {next} {last}"
                , pagePrevText: "이전"
                , pageNextText: "다음"
                , pageFirstText: "< 처음 ㅣ"
                , pageLastText: "ㅣ 마지막 >"
                , noDataContent: "데이터가 없습니다."
                , pageSize: 5
                , pageButtonCount: 10
                , pageLoading: true
                , pageIndex: 1
                , controller: {
                      loadData: function(filter) {
                          var data = $.Deferred();
                          var formData = [{name:"reportid", value:$("#reportid").val()}];
                          var params = [
                              {name:"pageNumber", value:filter.pageIndex}
                            , {name:"rowPerPage", value:filter.pageSize}
                            , {name:"orderField", value:"splmntid"}
                            , {name:"orderDirection", value:"desc"} ]
                          formData = formData.concat(params);

                          $.ajax({
                            type: "GET"
                          , contentType: "application/json; charset=utf-8"
                          , url      : mdlRptSbmsnDtl.listUrl
                          , data     : formData
                          , dataType : "json"
                          }).done(function(response) {

                              var da = {
                                  data       : escapeGridData(response.list)
                                , itemsCount : response.totalCount
                              };
                              data.resolve(da);
                          });
                          return data.promise();
                      }
                  },
                  fields: [
                       {name: "splmntid"    , css: 'hide'}
                     , {name: "reportid"    , css: 'hide'}
                     , {title: "No."        , name: "rowNumber"   , type: "number", align: "center" , width: "80", sorting: false}
                     , {title: "상태"       , name: "ansSttsCdNm" , type: "text"  , align: "center" , width: "80"}
                     , {title: "요청내용"   , name: "dmndCn"      , type: "text"  , align: "left"   , width: "300"}
                     , {title: "요청일"     , name: "dmndDt"      , type: "text"  , align: "center" , width: "100" }
                     , {title: "완료처리일" , name: "ansDt"       , type: "text"  , align: "center" , width: "100"}
                  ]
            });
        },
        fn_deleteFileList : function (fileid, fileIdntfcKey) {

    	    if(!confirm("파일을 삭제하시겠습니까?")){return;}
    	    fn_deleteFile(fileid, fileIdntfcKey);
    	    $("#file_"+fileid).remove();

    	},
    	fn_deleteFile : function (fileid, fileIdntfcKey){
    		  var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;

              $.ajax({
                 url : deleteFileUrl,
                 type: 'GET',
                 cache : false,
                 dataType: 'json',
                 success : function (data){
                     if(data.result=="success"){
                    	 $("#file_"+fileid).remove();
                         alert("파일삭제가 완료 되었습니다.");
                     }else{
                         alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                     }
                 },
                 error : function (error){
                 }
            })
        },
        doCmptn : function () {
            var chkData = [];
            chkData.push($("#reportid").val());

            if(displayWorkProgress()){
                $.ajax({
                    url : mdlRptSbmsnDtl.doCmptnUrl,
                    type: 'POST',
                    cache : false,
                    traditional : true,
                    dataType: 'json',
                    data: { reportids : chkData},
                    success : function (data){
                        if(data.result=="success"){
                            alert(data.msg);
                            mdlRptSbmsnGridHelper1.resetPageContent();
                        }else{
                            alert(data.msg);
                        }
                        closeWorkProgress();
                    }
                });
            }
        },
        openPopupCnsltngTrgt : function(){
        	//부모창 팝업 호출
        	var keyid = $("#reportid").val();
        	fn_opencnsltngTrgtModal(keyid);
        }
    };

    //보안요청팝업
    var rptSplmntDmndUrl = "/mng/bizAply/bizRpt/rptSplmntDmndPopup.html";
    var rptSplmntDmndModal;
    var fn_openRptSplmntDmndModal =()=> {

    	var keyid = $("#reportid").val();
        var url = rptSplmntDmndUrl + "?reportid="+keyid+"&mode=req";

        $("#rptSplmntDmndPopup").load(url, function(response, status, xhr) {
            if (status == "success") {
            	rptSplmntDmndModal = new bootstrap.Modal($('#rptSplmntDmndPopup'));
            	rptSplmntDmndModal.show();
            }
        });
    }

//     //컨설팅대상 팝업
//     var cnsltngTrgtUrl = "/mng/bizAply/bizRpt/cnsltngTrgtPopup.html";
//     var cnsltngTrgtModal;
//     var fn_opencnsltngTrgtModal =()=> {

//     	var keyid = $("#reportid").val();
//         var url = cnsltngTrgtUrl + "?reportid="+keyid+"&mode=req";

//         $("#cnsltngTrgtPopup").load(url, function(response, status, xhr) {
//             if (status == "success") {
//             	cnsltngTrgtModal = new bootstrap.Modal($('#cnsltngTrgtPopup'));
//             	cnsltngTrgtModal.show();
//             }
//         });
//     }

    $(function() {

        $('#multiFileInput').on("change", function(event) {

            var objFile = document.querySelector('#multiFileInput');
            var formData = new FormData();
            var content = "";

            for( i = 0 ; i < objFile.files.length ; i++) {
                formData.append("files", objFile.files[i]);
            }

            formData.append("filegrpid", $("#atchFilegrpid").val());
            formData.append("filegrpNm", "bizRptMng_file");


            $.ajax({
                url : '/uploadMultipleFiles.do',
                processData : false,
                contentType : false,
                data : formData,
                type : 'POST',
                success : function(response) {
                    if(response.result == 'fail'){
                        alert(response.msg);
                    }else{
                        if($("#atchFilegrpid").val()=='0' || $("#atchFilegrpid").val()==''  || $("#atchFilegrpid").val()==null){
                            $("#atchFilegrpid").val( response[0].filegrpid );
                        }

                        for(i = 0 ;i < response.length; i++ ){
                            content = "<span class ='label label-inverse mb-2' id='file_"+response[i].fileid+"'>"+response[i].orginlFileNm ;
                            content +="&nbsp;&nbsp;  <a  class = 'text-white' href = javascript:mdlRptSbmsnDtl.fn_deleteFile('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"')>X</a></span>&nbsp;&nbsp;";
                            $('#multipleFileUploadSuccess').append(content);
                        }
                    }
                }
            });

           if (detectBrowser() == "other") {
               $("#multiFileInput").val("");
           } else {
              $("#multiFileInput").replaceWith( $("#multiFileInput").clone(true))
           }


        });
    	mdlRptSbmsnDtl.init();
    });

</script>
