<!-- 담당자정보 회원검색 팝업 -->
<style>
.hide{display:none;}
</style>

<form id="cnsntngExprtModalFrm" action="" onsubmit="return false;">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content type_2" style="width: 1000px;">
            <div class="modal-header">
                <h4 class="modal-title">담당자 배정</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"></span>
                </button>
            </div>

            <div class="modal-body">
                <div class="card">
                    <div class="card-block-small">

                        <div class="mb-2 form-group row">
                            <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>배정 방식</strong></div>
                            <div class="col-12">
                                <div class="form-radio">
                                    <div class="radio radio-inline">
                                        <label class="mb-0 form-label">
                                            <input type="radio" name="checkExprtKnd" value="P" checked/>
                                            <i class="helper"></i>전문가 검색
                                        </label>
                                    </div>
                                    <div class="radio radio-inline">
                                        <label class="mb-0 form-label">
                                            <input type="radio" name="checkExprtKnd" value="G" />
                                            <i class="helper"></i>심사위원 그룹 검색
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row searchExprtArea" >

                            <div class="col-12 col-lg-3 mb-2 mb-lg-0">
                                <div class="mb-0 form-group">
                                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="popupFilterIdNameInput"><strong>아이디/이름</strong></label>
                                    <div class="input-group input-group-sm input-group-dropdown mb-0">
                                        <input type="text" class="form-control form-control-sm" aria-label="Text input with dropdown button" name="searchNm" id="searchNm"/>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-lg-3 mb-2 mb-lg-0">
                                <div class="mb-0 form-group">
                                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="popupFilterIdNameInput"><strong>자격증명</strong></label>
                                    <div class="input-group input-group-sm input-group-dropdown mb-0">
                                        <input type="text" class="form-control form-control-sm" aria-label="Text input with dropdown button" name="searchCrtfctNm" id="searchCrtfctNm"/>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-lg-3 mb-2 mb-lg-0">
                                <div class="mb-0 form-group">
                                    <span class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>전문분야(환경주제)</strong></span>
                                    <div class="input-group input-group-sm input-group-dropdown mb-0">
                                        <span kattr:select_code="searchSbjctCd" grpCd="126" isAdmin="true" firstOptTxt="- 전체 - "></span>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-lg-3 mb-2 mb-lg-0">
                                <div class="mb-0 form-group">
                                    <span class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>활동가능지역</strong></span>
                                    <div class="col-12">
                                        <select name="searchRgnCd" id="searchRgnCd" class="form-select form-select-sm form-control-sm">
                                            <option value="">- 전체 -</option>
                                            <option th:each="item:${sidoList}" th:value="${item.ctprvnCd}" ><th:block th:text="${item.ctprvnNm}" ></th:block></option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row searchExprtGrpArea" >
                            <div class="col-12 col-lg-3 mb-2 mb-lg-0">
                                <div class="mb-0 form-group">
                                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="popupFilterIdNameInput"><strong>심사위원 그룹명 </strong></label>
                                    <div class="input-group input-group-sm input-group-dropdown mb-0">
                                        <input type="text" class="form-control form-control-sm" aria-label="Text input with dropdown button" name="searchGrpNm" id="searchGrpNm"/>
                                    </div>
                                </div>
                            </div>
                       </div>
                       <div class="m-t-20 text-center">
                           <button type="button" class="btn btn-disabled m-r-5" onclick="initSearchCondition()">초기화</button>
                           <button type="button" class="btn btn-primary" onclick="searchManagerList()">검색</button>
                       </div>
                </div>

                <!--임시 그리드-->
                <div class="card m-b-10">
                    <div class="row p-20 p-b-0">
                        <div class="col-12 col-md-6">
                            <h5><strong>전문가 검색결과</strong></h5>
                        </div>
                        <div class="col-12 col-md-6 text-right">
                            <button type="button" class="btn btn-primary waves-effect waves-light" onclick="insertCnslngExprt()">등록</button>
                        </div>
                    </div>

                    <div class="card-block-small">
                        <div class="row">
                            <div id="order-table_wrapper" class="col-12  " >
                                <table id="cnslngExprtModalGrid" class="table-responsive"></table>
                                <div id="listPager3" class="text-center"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--//임시 그리드-->
            </div>
        </div>
      </div>
  </div>
  </form>

  <!-- 담당자정보 회원검색 팝업 -->
  <script th:inline="javascript">
    var selectedItems = [];
    var gridHelper1;
    var checkedMode;

    $(function(){
        checkSeachArea();
    });

    $("input[name=checkExprtKnd]").change(function(){
        checkSeachArea();
    })

    checkSeachArea = () =>{

        checkedMode = $("input[name=checkExprtKnd]:checked").val();

        initSearchCondition();

        if(checkedMode == 'P'){
            $(".searchExprtGrpArea").hide();
            $(".searchExprtArea").show();
        }else{
            $(".searchExprtGrpArea").show();
            $(".searchExprtArea").hide();
        }
        writeModalGridData();
    }

    searchManagerList = () =>{
        $("#cnslngExprtModalGrid").jsGrid("reset");
    }

    initSearchCondition = () =>{
        $("#searchNm").val("");
        $("#searchCrtfctNm").val("");
        $("#searchSbjctCd").val("");
        $("#searchRgnCd").val("");
        $("#searchGrpNm").val("");
    }

    var filter ;
    var expFilter = [
            {
                itemTemplate: function(_, item) {
                    return $("<input>").attr("type", "radio").attr("class", "singleCheckbox3").attr("name","memchk")
                           .attr("value",item.userid).attr("id","memchk_"+item.userid)
                },
                align: "center",
                width: "30",
                sorting: false
            }
           ,{ name: 'userid', css: 'hide' }
           ,{ title: 'No.'    ,name: 'rowNumber'     ,type: "number" ,width: "80"   ,align:"center",  sorting :false }
           ,{ title: '아이디'   ,name: 'acnt'     ,type: "text" , width: "150" ,align:"center"}
           ,{ title: '이름'    ,name: 'nm'       ,type: "text"  , width: "100" ,align:"center"}
           ,{ title: '이메일'   ,name: 'eml'      ,type: "text" , width: "150" ,align:"center"}
           ,{ title: '전화번호' ,name: 'moblphon' ,type: "text"  , width: "150" ,align:"center"}
           ,{ title: '자격증명' ,name: 'crtfctNm' ,type: "text"  , width: "200" ,align:"center"
               ,itemTemplate: function(_, item) {
                   return (item.crtfctNm == null || item.crtfctNm =="")? "-":item.crtfctNm;
                }
           }
           ,{ title: '전문분야'  ,name: 'sbjctNm',type: "text" , width: "150" ,align:"center"
               ,itemTemplate: function(_, item) {
                   return (item.sbjctNm == null || item.sbjctNm =="")? "-":item.sbjctNm;
                }
           }
           ,{ title: '활동가능지역'  ,name: 'rgnNm',type: "text" , width: "150" ,align:"center"
               ,itemTemplate: function(_, item) {
                   return (item.rgnNm == null || item.rgnNm =="")? "-":item.rgnNm;
                }
           }
    ]
    var expGrpFilter = [
            {
                itemTemplate: function(_, item) {
                    return $("<input>").attr("type", "radio").attr("class", "singleCheckbox3").attr("name","memchk")
                           .attr("value",item.grpId).attr("id","memchk_"+item.grpId)
                },
                align: "center",
                width: "30",
                sorting: false
            }
           ,{ name: 'grpId', css: 'hide' }
           ,{ name: 'grpExprtStr', css: 'hide' }
           ,{ title: 'No.'    ,name: 'rowNumber'     ,type: "number" ,width: "80"   ,align:"center",  sorting :false }
           ,{ title: '심사위원 그룹명'  ,name: 'grpNm' ,type: "text" , width: "300" ,align:"center"
               ,itemTemplate: function(_, item) {   return item.grpNm+"("+item.grpExprtNm+")";}
            }
           ,{ title: '등록전문가수'  ,name: 'grpExprtCnt'   ,type: "text" , width: "100" ,align:"center"}
           ,{ title: '사용여부'  ,name: 'useYn',type: "text" , width: "100" ,align:"center"
               ,itemTemplate: function(_, item) {   return (item.useYn =="Y")? "사용":"미사용";}
           }
           ,{ title: '등록일'  ,name: 'regDt',type: "text" , width: "100" ,align:"center"
               ,itemTemplate: function(_, item) {return (item.regDt!=null && item.regDt !='undefiend')?item.regDt.substring(0,10):"-";}
           }
    ]

    var expUrl = "/mng/cnsltng/selectExpertList.do";
    var expGrpUrl = "/mng/cnsltng/selectJudgeList.do";


    function writeModalGridData(){

        var url = "/mng/cnsltng/selectExpertList.do";

        if(checkedMode=='P'){
            filter = expFilter;
            url = expUrl;
        }else{
            filter = expGrpFilter;
            url = expGrpUrl;
        }

        $("#cnslngExprtModalGrid").jsGrid({
            height: "auto",
            width: "100%",
            autoload: true,
            sorting: true,
            paging: true,
            pagerContainer: "#listPager3",
            pagerFormat: "{first} {prev} {pages} {next} {last}",
            pagePrevText: "이전",
            pageNextText: "다음",
            pageFirstText: " < 처음 ㅣ",
            pageLastText: " | 마지막 >",
            pageSize: 10,
            pageButtonCount: 10,
            pageLoading: true,
            pageIndex: 1,
            noDataContent: "데이터가 없습니다.",

            controller: {
                loadData: function (filter) {
                    var data = $.Deferred();

                    var formData = $('#cnsntngExprtModalFrm').serializeArray();
                    var params = [
                            {name: "pageNumber", value: filter.pageIndex},
                            {name: "rowPerPage", value: filter.pageSize},
                    ]

                    if(filter.sortField != undefined){
                        params.push({name: "orderField", value: filter.sortField});
                        params.push({name: "orderDirection", value: filter.sortOrder});
                    }else{
                        if(checkedMode=='P'){
                            params.push({name: "orderField", value: 'NM'});
                        }else{
                            params.push({name: "orderField", value: 'GRP_NM'});
                        }
                    }

                    params.push({name: "cnsltngid", value: cnsltngid});

                    formData = formData.concat(params);

                    $.ajax({
                      type: "GET",
                      contentType: "application/json; charset=utf-8",
                      url: url,
                      dataType: "json",
                      data: formData,
                    }).done(function(response){
                        var da = {
                                data : escapeGridData(response.list)
                                ,itemsCount : response.totalCount
                            };
                      data.resolve(da);
                    });
                    return data.promise();
                },
            },
            fields: filter,
            rowClick: function(args) {

                 if(checkedMode=='P'){
                     $("#memchk_"+args.item.userid).prop("checked",true);
                 }else{
                     $("#memchk_"+args.item.grpId).prop("checked",true);
                 }
            }
        });
    }

    makeCnstntHtml= (userid,introduceStr)=> {

        let html  = '<span class="label label-inverse mb-2" id="cnstnt_list_'+userid+'" >';
        html += introduceStr
        html += '&nbsp;&nbsp;&nbsp;<a href="javascript:deleteCnstnt('+userid+')" class="text-white delete-manager">X</a>';
        html += '<input type="hidden" id="cnstnt'+userid+'"  name="cnstntids"  value="'+userid+'">';
        html += '</span>';

        return html;
    }

    var insertCnslngExprt = () =>{

       var selectedItem ;
       var params ;

       if($('input[name=memchk]:checked').length <= 0){
           alert("담당자를 선택해주세요");
           return;
       }

       let compareId = $('input[name=memchk]:checked').val();
       $("#cnslngExprtModalGrid").jsGrid("search", {}).done(function(data) {


           data.data.forEach(function(item){

                if(checkedMode=='P' ){
                    if(compareId == item.userid){selectedItem = item;}
                }else {
                    if(compareId == item.grpId){selectedItem = item;}
                }
           })

           if(checkedMode=='P'){

               let introStr= selectedItem.nm+' ( '+selectedItem.acnt+' ) |'+selectedItem.eml+' | '+selectedItem.moblphon;
               $("#cnstnt_list_area").append(makeCnstntHtml(selectedItem.userid,introStr))

           }else{

               let strArr = selectedItem.grpExprtStr.split(":");

               if(strArr.length > 0){
                   strArr.forEach(function(item){
                       let idArr = item.split(",");
                       $("#cnstnt_list_area").append(makeCnstntHtml(idArr[0],idArr[1]))
                   })
               }
           }

       });
       cnstntSearchModal.hide();
  }
</script>
