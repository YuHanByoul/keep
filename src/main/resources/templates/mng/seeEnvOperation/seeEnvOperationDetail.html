<form id="insertForm">
	<input type="hidden" name="aplyid" id="aplyid" th:value="${detail.aplyid}" /> 
	<input type="hidden" name="instid" id="instid" th:value="${detail.instid}" /> 
	<input type="hidden" name="aplcntid" id="aplcntid" th:value="${detail.aplcntid}" /> 
	<input type="hidden" name="aplcntNm" id="aplcntNm" th:value="${detail.aplcntNm}" /> 
    <div class="card">
        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>지정정보</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="row">
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>시도</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="" placeholder="" th:value="${detail.ctprvnNm}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>지정번호</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="" placeholder="" th:value="${detail.dsgnno}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>기관명</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="" placeholder="" th:value="${detail.instNm}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>기관유형</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="" placeholder="" th:value="${detail.instTypeNm}" readonly>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>대표자명</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="" placeholder="" th:value="${detail.rprsvNm}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>대표자 생년월일</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="rprsvBrdt" name="rprsvBrdt" placeholder="" th:value="${detail.rprsvBrdt}" maxlength="10">
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>법인등록번호(사업자등록번호)</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="" placeholder="" th:value="${detail.brno}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>기관 이메일</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="" placeholder="" th:value="${detail.instEml}" readonly>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>기관 연락처</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="" placeholder="" th:value="${detail.instCntct}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>신청자</strong></label>
                        <div class="d-flex align-items-center">
	                        <div class="col">
	                            <input type="text" class="form-control form-control-sm" id="makeAplcntNm" name="makeAplcntNm" placeholder="" th:value="${detail.aplcntNm + '(' + detail.acnt + ')'}" readonly>
	                        </div>
	                        <div class="col-auto ps-2">
	                            <button type="button" class="btn btn-inverse btn-sm" onclick="openChgAltmntModal();">담당자 변경</button>
	                        </div>
	                    </div>
                        <div class="col-sm-12">
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>신청자 이메일</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="aplcntEml" name="aplcntEml" placeholder="" th:value="${detail.aplcntEml}" maxlength="50">
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>신청자 연락처</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="aplcntMoblphon" name="aplcntMoblphon" placeholder="" th:value="${detail.aplcntMoblphon}" maxlength="15">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>기관주소</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="" placeholder="" th:value="${'우)' + detail.zip + ' ' + detail.addr}" readonly>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>상세주소</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="" placeholder="" th:value="${detail.addrDtl}" readonly>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group mb-3">
	            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for=""><strong>증빙서류</strong></label>
	            <div class="mt-2 row">
	                <div class="col-auto">
                        <th:block th:if="${fileList != null}">
	                        <th:block th:each="item : ${fileList}" th:id="${item.fileid}">
	                            <th:block th:if="${item.orginlFileNm != null}">
	                                <span th:fileid='${item.fileid}' th:fileIdntfcKey="${item.fileIdntfcKey}" th:onclick="downloadFileByFileid(this.getAttribute('fileid'),this.getAttribute('fileIdntfcKey'))" href="javascript:void(0)" class='label label-inverse'>
	                                    <th:block th:text="${item.orginlFileNm}" /> 
	                                </span>
	                            </th:block>
	                        </th:block>
	                    </th:block>
	                </div>
	            </div>
	        </div>
	        <div class="row">
	            <div class="col-12 col-md-6 col-lg-3 mb-3">
	                <div class="mb-0 form-group">
	                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>지정상태</strong></div>
	                    <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" id="" placeholder="" th:value="${detail.sttsNm}" readonly>
                        </div>
	                </div>
	            </div>
	        </div>
        </div>
        <div class="card-block-small">
            <button type="button" class="btn btn-disabled" onclick="gridHelper1.toggleContent(); return false;">목록</button>
            <button type="button" class="btn btn-primary" onclick="updateInfo(); return false;">저장</button>
            <button type="button" class="btn btn-primary" th:if="${detail.sttsCd == '248104'}" onclick="openCancelModal(); return false;">지정취소</button>
        </div>
    </div>
    
    <!-- 지정 내역 -->
    <div class="card">
        <div class="row p-20 p-b-0">
            <div class="col-12 col-md-8 mb-2 mb-md-0">
                <h5><strong>지정 내역</strong></h5>
            </div>
            <div class="col-12 col-md-4 text-right">
                <button type="button" class="btn btn-primary" onclick="openInsertModal(); return false;">지정 정보 변경</button>
            </div>
        </div>
        <div class="card-block-small">
	        <div class="dt-responsive table-responsive">
	            <div id="order-table_wrapper" class="dataTables_wrapper dt-bootstrap4">
	                <table id="jsGrid2" class="table-responsive"></table>
	            </div>
	        </div>
	    </div>
    </div>
    <!-- //지정 내역 -->
</form>

<!-- 담당자변경 회원검색 팝업 -->
<div class="modal fade" id="chgAltmntPopup" aria-hidden="true" data-bs-backdrop="static"></div>
<!-- 지정취소 팝업 -->
<div class="modal fade" id="cancelPopup" aria-hidden="true" data-bs-backdrop="static"></div>
<!-- 지정정보변경 팝업 -->
<div class="modal fade" id="insertPopup" aria-hidden="true" data-bs-backdrop="static"></div>

<script th:inline="javascript">
	/*<![CDATA[*/
	var aplyid = /*[[${detail.aplyid}]]*/null;
	/*]]>*/
	var dsgnListUrl = "/mng/seeEnvOperation/selectDsgnList.do";
	var updateUrl = "/mng/seeEnvOperation/updateInfo.do";
	var saveUrl = "/mng/seeEnvOperation/saveDsgn.do";
	
	$(function(){
        $("#jsGrid2").jsGrid({
            height: "auto",
            width: "100%",
            autoload: true,
            sorting: false,
            paging: false,
            pageLoading: true,
            noDataContent: "데이터가 없습니다.",
            
            controller: {
                loadData: function (filter) {
                    var data = $.Deferred();
                    $.ajax({
                        type: "GET",
                        contentType: "application/json; charset=utf-8",
                        url: dsgnListUrl,
                        dataType: "json",
                        data: {
                        	aplyid: aplyid
                        }
                    }).done(function(response){
                        var da = {
                            data : escapeGridData(response.list)
                        };
                        data.resolve(da);
                    });
                    
                    return data.promise();
                }
            },
            fields: [ 
                { title: '번호'      ,name: 'rowNumber' ,type: "number", width: "80" , align:"center", sorting :false }
                , { title: '지정상태'   ,name: 'sttsNm'    ,type: "text"  , width: "100" , align:"center"}
                , { title: '지정번호' ,name: 'dsgnno'     ,type: "text"  , width: "100" , align:"center"}
                , { title: '지정획득일' ,name: 'dsgnDe'     ,type: "text"  , width: "150" , align:"center",
                    itemTemplate: function(value, item) { 
                        return value == null || value == '' ? '-' : value;
                    }
                }
                , { title: '지정취소일'   ,name: 'dsgnCnclDe'        ,type: "text"  , width: "150", align:"center",
                    itemTemplate: function(value, item) { 
                        return value == null || value == '' ? '-' : value;
                    }
                }
                , { title: '등록일'   ,name: 'regDt'   ,type: "text"  , width: "150" , align:"center"}
                , { title: '등록자'   ,name: 'aplcntNm'   ,type: "text"  , width: "150" , align:"center"}
            ]
        });
    });
	
    //담당자 변경 팝업
    var chgAltmntModal;
    var openChgAltmntModal = () => {
        var url = "/mng/seeEnvOperation/userSrchPopup.html?aplyid="+aplyid+"&instid="+$("#instid").val();    //회원검색

        $("#chgAltmntPopup").load(url, function(response, status, xhr) {
            if (status == "success") {
                chgAltmntModal = new bootstrap.Modal($('#chgAltmntPopup'));
                chgAltmntModal.show();
            }
        });

    }
    
    //지정취소 팝업
    var cancelModal;
    var openCancelModal = () => {
        var url = "/mng/seeEnvOperation/cancelPopup.html?aplyid="+aplyid;

        $("#cancelPopup").load(url, function(response, status, xhr) {
            if (status == "success") {
            	cancelModal = new bootstrap.Modal($('#cancelPopup'));
            	cancelModal.show();
            }
        });
    }
    
    //지정정보변경 팝업
    var insertModal;
    var openInsertModal = () => {
        var url = "/mng/seeEnvOperation/insertPopup.html?aplyid="+aplyid;

        $("#insertPopup").load(url, function(response, status, xhr) {
            if (status == "success") {
            	insertModal = new bootstrap.Modal($('#insertPopup'));
            	insertModal.show();
            }
        });
    }
    
    var validator = $("#insertForm").validate({
        rules: {
        	aplcntid: { required: true }
        },
        messages: {
        	aplcntid: { required: "담당자를 선택해주십시오." }  
        }
    });
    
    function updateInfo() {
    	if(!($("#insertForm").valid())) return;
    	if(!confirm("저장하시겠습니까?")) return;
        var data =  $("#insertForm").serialize();
        if(displayWorkProgress()){
            $.ajax({
                url : updateUrl,
                type: 'POST',
                cache : false,
                dataType: 'json',
                data : data,
                success : function (data){
                    if(data.result=="success"){
                        alert(data.msg);
                        gridHelper1.resetListContent();                         
                    }else{
                        alert(data.msg);
                    }
                    closeWorkProgress();
                }
            });
        }
    }
    
    
</script>