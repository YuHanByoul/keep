<form id="evntForm" name="evntForm">
    <div class="card-header p-b-0">
        <h3 class="sub-title"><strong>기본정보</strong></h3>
    </div>
    <div class="card-block-small p-t-0">
        <div class="row">
            <div class="col-lg-6 mb-3">
                <div class="mb-0 form-group required">
                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>접수기간</strong></div>
                    <div class="row">
                        <div class="col-sm-6">
                            <input type="date" id="bgngDe" name="bgngDe" class="form-control form-control-sm" aria-label="접수기간 시작일"/>
                        </div>
                        <div class="col-sm-6">
                            <input type="date" id="endDe" name="endDe" class="form-control form-control-sm" aria-label="접수기간 종료일"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6 mb-3">
                <div class="mb-0 form-group required">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="prsntnDe"><strong>당첨자발표일</strong></label>
                    <div class="row">
                        <div class="col-sm-6">
                            <input type="date" class="form-control form-control-sm" id="prsntnDe" name="prsntnDe"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row form-group required mb-3">
            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="aplyUrl"><strong>신청버튼 링크</strong></label>
            <div class="col-sm-12">
                <input type="text" class="form-control form-control-sm" name="aplyUrl" id="aplyUrl" placeholder="신청페이지 URL을 입력해 주세요."/>
            </div>
        </div>
        <div class="row form-group required mb-3">
            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="ttl"><strong>제목</strong></label>
            <div class="col-sm-12">
                <input type="text" class="form-control form-control-sm" name="ttl" id="ttl" placeholder="제목"/>
            </div>
        </div>
        <div class="row form-group required mb-3">
            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="cn"><strong>내용</strong></label>
            <div class="col-sm-12">
                <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="내용" id="cn" name="cn"></textarea>
            </div>
        </div>
        <div class="row col-lg-6 mb-3">
            <div class="mb-0 form-group">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="multiFileInput"><strong>첨부파일</strong></label>
                <div class="col-sm-12">
                    <input id="multiFileInput" type="file" name="files" multiple accept="image/jpeg,image/gif,image/png,application/pdf" class="form-control form-control-sm"/>
                </div>
                <div class="mt-2 row">
                    <div class="col-auto">
                        <div id="multipleFileUploadError"></div>
                        <div id="multipleFileUploadSuccess">
                        </div>
                    </div>
                </div>
                <input type="hidden" id="filegrpid" name="filegrpid" value='0'/>
            </div>
        </div>
    </div>
    <!-- 버튼영역 -->
    <div class="card-block-small">
        <button class="btn btn-disabled m-r-5" onclick="evntList.gridHelper.toggleContent()">취소</button>
        <th:block sec:authorize-url="/mng/evnt/insertEvnt.do">
            <button type='button' class="btn btn-primary" onclick="evntForm.save()">저장</button>
        </th:block>
    </div>
</form>


<script th:inline="javascript">
    var evntForm = {
        editor: null,
        insertUrl: '/mng/evnt/insertEvnt.do',
        updateUrl: '/mng/evnt/updateEvnt.do',
        /* <![CDATA[ */
        evntid: /*[[${evntInfo.evntid}]] */ null,
        /* ]]> */

        init() {
            this.validateForm();
            this.editor = CKEDITOR.replace('cn', {enterMode: CKEDITOR.ENTER_BR});
        },

        /*
        * (form안의 항목들이 display none인 경우 유효성 체크를 진행 하지 않습니다.
        * 이 부분은 ignore: [] 옵션을 넣어줘서 예외처리 하지 않고 모두 검증 할 수 있습니다.
        *
        */
        validateForm() {
            $('#evntForm').validate({
                ignore : [],
                rules: {
                    bgngDe: {required: true},
                    endDe: {required: true},
                    prsntnDe: {required: true},
                    aplyUrl: {required: true},
                    ttl: {required: true},
                    cn: {required: true}
                },
                messages: {
                    bgngDe: {required: "접수기간 시작 일자를 입력해 주십시오."},
                    endDe: {required: "접수기간 종료 일자를 입력해 주십시오."},
                    prsntnDe: {required: "당첨자 발표일을 입력해 주십시오."},
                    aplyUrl: {required: "신청버튼 링크를 입력해 주십시오."},
                    ttl: {required: "제목을 입력해 주십시오."},
                    cn: {required: "내용을 입력해 주십시오."}
                }
            })
        },

        save() {
            var url = evntForm.insertUrl;
            if (this.evntid != null) {
                url = evntForm.updateUrl;
            }

            var editorData = editor.getData();
            $("#cn").val(editorData);

            if (!this.validateForm()) return;
            /* 시작일자와 종료일자 valid 추가 */
            var $bgngDe = $("#bgngDe").val();
            var $endDe = $("#endDe").val();
            var $prsntnDe = $('#prsntnDe').val();

            if(Date.parse($bgngDe) > Date.parse($endDe)){
                alert('시작 일자는 종료 일자보다 클 수 없습니다.');
                return ;
            }

            if(Date.parse($endDe) > Date.parse($prsntnDe)){
                alert('종료 일자는 발표 일자보다 클 수 없습니다.');
                return ;
            }

            if (!confirm('이벤트를 등록하시겠습니까?')) return;

            if (displayWorkProgress()) {
                $.ajax({
                    type: 'post',
                    data: $('#evntForm').serializeArray(),
                    url: url,
                    dataType: "json",
                    success: function (response) {
                        closeWorkProgress();
                    }
                })
            }
        },
    };

    $(function () {
        evntForm.init();

        $('#multiFileInput').on("change", function (event) {

            var objFile = document.querySelector('#multiFileInput');
            var formData = new FormData();
            var content = "";

            for (i = 0; i < objFile.files.length; i++) {
                formData.append("files", objFile.files[i]);
            }

            formData.append("filegrpid", $("#filegrpid").val());
            formData.append("filegrpNm", "evnt_file");

            if (displayWorkProgress()) {
                $.ajax({
                    url: '/uploadMultipleFiles.do',
                    processData: false,
                    contentType: false,
                    data: formData,
                    type: 'POST',
                    success: function (response) {
                        if (response.result == 'fail') {
                            alert(response.msg);
                        } else {
                            if ($("#filegrpid").val() == '0' || $("#filegrpid").val() == '' || $("#filegrpid").val() == null) {
                                $("#filegrpid").val(response[0].filegrpid);
                            }

                            for(i = 0 ;i < response.length; i++ ){
                                content = "<span class ='label label-inverse' id='"+response[i].fileid+"'>"+response[i].orginlFileNm ;
                                content +="<a class='text-white' href=javascript:fn_deleteFile('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"')>X</a></span>";
                                $('#multipleFileUploadSuccess').append(content);
                            }
                        }
                        closeWorkProgress();
                    }
                });
                $("#multiFileInput").val("");
            }
        });
    });

    function fn_deleteFileList(fileid, fileIdntfcKey){
        if(!confirm("파일을 삭제하시겠습니까?")){return;}
        fn_deleteFile(fileid, fileIdntfcKey);
    }

    function fn_deleteFile(fileid, fileIdntfcKey){

        var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;
        $.ajax({
            url : deleteFileUrl,
            type: 'GET',
            cache : false,
            dataType: 'json',
            success : function (data){
                console.log(data);
                if(data.result=="success"){
                    $("#"+fileid).remove();
                    alert("파일삭제가 완료 되었습니다.");
                }else{
                    alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                }
            },
            error : function (error){
            }
        })
    };
</script>
<!-- // -->