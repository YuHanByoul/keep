<!-- 대여 일괄 등록 설정    -->
<div class="con-pane" id="useStatusSelectAll2" >
    <div class="card-header p-b-0">
        <h3 class="sub-title"><strong>예약일 설정</strong></h3>
    </div>
    
    
    <div class="card-block-small p-t-0">
        <div class="mb-0 row">
        
           <div class="card-block-small p-t-0">
               <div class="mb-0 row">
               
                   <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                       <div class="col-12">
                           <div class="row">
                               <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                                   <div class="mb-0 form-group required">
                                       <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="rsvtStrtDt"><strong>예약 시작일</strong></label>
                                       <div class="col-12">
                                           <input type="date" class="form-control form-control-sm" name="rsvtStrtDt" id="rsvtStrtDt" placeholder="Text Input Validation">
                                       </div>
                                   </div>
                               </div>
                               <div class="col-12 col-lg-6">
                                   <div class="mb-0 form-group required">
                                       <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="rsvtEndtDt"><strong>예약 종료일</strong></label>
                                       <div class="col-12">
                                           <input type="date" class="form-control form-control-sm" name="rsvtEndtDt" id="rsvtEndtDt" placeholder="Text Input Validation">
                                       </div>
                                   </div>
                               </div>
                           </div>
                       </div>
                   </div>
      
                   <div class="col-12 col-lg-6">
                        <div class="mb-0 form-group ">
                        
                            <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>제외 요일선택</strong></div>
                            
                            <div class="border-checkbox-section">
                                <div class="border-checkbox-group border-checkbox-group-inverse d-inline-block">
                                    <input class="border-checkbox limit-day" type="checkbox" name="exceptDay1" id="exceptDay1" value="1">
                                    <label class="form-label form-label-sm border-checkbox-label" for="exceptDay1">
                                        월
                                    </label>
                                </div>
                                <div class="border-checkbox-group border-checkbox-group-inverse d-inline-block">
                                    <input class="border-checkbox limit-day" type="checkbox" name="exceptDay2" id="exceptDay2" value="2">
                                    <label class="form-label form-label-sm border-checkbox-label" for="exceptDay2">
                                        화
                                    </label>
                                </div>
                                <div class="border-checkbox-group border-checkbox-group-inverse d-inline-block">
                                    <input class="border-checkbox limit-day" type="checkbox" name="exceptDay3" id="exceptDay3" value="3">
                                    <label class="form-label form-label-sm border-checkbox-label" for="exceptDay3">
                                        수
                                    </label>
                                </div>
                                <div class="border-checkbox-group border-checkbox-group-inverse d-inline-block">
                                    <input class="border-checkbox limit-day" type="checkbox" name="exceptDay4" id="exceptDay4" value="4">
                                    <label class="form-label form-label-sm border-checkbox-label" for="exceptDay4">
                                        목
                                    </label>
                                </div>
                                <div class="border-checkbox-group border-checkbox-group-inverse d-inline-block">
                                    <input class="border-checkbox limit-day" type="checkbox" name="exceptDay5" id="exceptDay5" value="5">
                                    <label class="form-label form-label-sm border-checkbox-label" for="exceptDay5">
                                        금
                                    </label>
                                </div>
                                <div class="border-checkbox-group border-checkbox-group-inverse d-inline-block">
                                    <input class="border-checkbox limit-day" type="checkbox" name="exceptDay6" id="exceptDay6" value="6">
                                    <label class="form-label form-label-sm border-checkbox-label" for="exceptDay6">
                                        토
                                    </label>
                                </div>
                                <div class="border-checkbox-group border-checkbox-group-inverse d-inline-block">
                                    <input class="border-checkbox limit-day" type="checkbox" name="exceptDay0" id="exceptDay0" value="0">
                                    <label class="form-label form-label-sm border-checkbox-label" for="exceptDay0">
                                        일
                                    </label>
                                </div>
                            </div>
                            
                        </div>
                    </div>
      
            
            
        </div>
    </div>
    <div class="card-header p-b-0">
        <h3 class="sub-title"><strong>시간별 금액설정</strong></h3>
    </div>
    
    <div class="card-block-small p-t-0">
        <div class="col-12 table-border-style">
            <div class="table-responsive">
            
                <table class="table">
                    <colgroup>
                        <col style="width:40%">
                        <col style="width:40%">
                        <col style="width:20%">
                    </colgroup>
                    <thead>
                    <tr>
                        <th class="text-center v-middle">예약시간</th>
                        <th class="text-center v-middle">금액</th>
                        <th class="text-center v-middle">사용여부<input type="hidden" class="js-single"></th>
                    </tr>
                    </thead>
                    
                    <tbody id="inserFrmListArea">
                    
                    <tr>
                        <td class="text-center v-middle">
                            <div class="col-12 row m-0 justify-content-center">
                                <div class="col-auto p-0">
                                    <input type="time" class="form-control form-control-sm" name="strtTm1" id="strtTm1" >
                                </div>
                                <div class="col-auto p-l-5 p-r-5">
                                    -
                                </div>
                                <div class="col-auto p-0">
                                    <input type="time" class="form-control form-control-sm" name="endTm1" id="endTm1" >
                                </div>
                            </div>
                          </td>
                          <td class="text-center v-middle">
                               <div class="align-items-center col-12 justify-content-center m-0 row">
                                      <div class="col-auto p-l-0">
                                      <input type="number" class="col-lg-auto form-control form-control-sm text-right" name="payment1" id="payment1" style="width:88px;">
                                      </div>
                                       <div class="col-auto p-l-0 p-r-0">
                                           원
                                       </div>
                                       <div class="col-auto p-r-0">
                                           <div class="border-checkbox-section">
                                               <div class="border-checkbox-group border-checkbox-group-inverse">
                                                   <input class="border-checkbox payment-free-check" type="checkbox" name="paymentFreeCheck1" id="paymentFreeCheck1" value="1">
                                                   <label class="form-label form-label-sm border-checkbox-label m-0" for="paymentFreeCheck1">
                                                       무료
                                                   </label>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                               </td>
                               <td class="text-center v-middle">
                                   <input type="checkbox" class="js-single-small payment-checkbox" name="paymentStatus1" id="paymentStatus1" checked value="1">
                               </td>
                           </tr>
                           
                           </tbody>
                       </table>
                       
                   </div>
               </div>
           </div>
       </div>

<!--    <div class="modal-footer">
       <button type="button" class="btn btn-primary waves-effect waves-light" onclick="save()">저장</button>
   </div> -->
   
  <script  id="insertForm" type="text/x-handlebars-template">
         <tr>
             <td class="text-center v-middle">
                 <div class="col-12 row m-0 justify-content-center">
                     <div class="col-auto p-0">
                         <input type="time" class="form-control form-control-sm" name="strtTm{{frmNum}}" id="strtTm{{frmNum}}" disabled >
                     </div>
                     <div class="col-auto p-l-5 p-r-5">
                         -
                     </div>
                     <div class="col-auto p-0">
                         <input type="time" class="form-control form-control-sm" name="endTm{{frmNum}}" id="endTm{{frmNum}}" disabled>
                     </div>
                 </div>
               </td>
             
                <td class="text-center v-middle">
                    <div class="align-items-center col-12 justify-content-center m-0 row">
                        <div class="col-auto p-l-0">
                        <input type="number" class="col-lg-auto form-control form-control-sm text-right" name="payment{{frmNum}}" id="payment{{frmNum}}" style="width:88px;" disabled>
                        </div>
                         <div class="col-auto p-l-0 p-r-0">
                             원
                         </div>
                         <div class="col-auto p-r-0">
                             <div class="border-checkbox-section">
                                 <div class="border-checkbox-group border-checkbox-group-inverse">
                                     <input class="border-checkbox payment-free-check " type="checkbox" name="paymentFreeCheck{{frmNum}}" id="paymentFreeCheck{{frmNum}}"  value="{{frmNum}}" disabled>
                                     <label class="form-label form-label-sm border-checkbox-label m-0" for="paymentFreeCheck{{frmNum}}">
                                         무료
                                     </label>
                                 </div>
                             </div>
                         </div>
                      </div>
                 </td>
                 <td class="text-center v-middle">
                      <input type="checkbox" class="js-single-small payment-checkbox" name="paymentStatus{{frmNum}}" id="paymentStatus{{frmNum}}"  value="{{frmNum}}">
                 </td>
          </tr>
  </script>
  
  <script th:inline="javascript">

    var switchCherryArr1=[] ;
    var possibleDayArr = [] ;
    
    $(document).ready(function () {
        
    	addInsertForm();
    	
        var elemsingleSmallList = document.querySelectorAll('.js-single-small');
        for(var i=0; i < elemsingleSmallList.length; i++){
            switchCherryArr1[elemsingleSmallList[i].getAttribute('id')]  = new Switchery(elemsingleSmallList[i], { color: '#4680ff', jackColor: '#fff', size : 'small'});
        }
        if(switchCherryCallback != undefined && typeof switchCherryCallback === 'function'){
            switchCherryCallback();
        }


        $(".payment-checkbox").bind("change",function(){
            
            let isChecked = $(this).is(":checked");
            let frmNum = $(this).val();
            
            if(isChecked){
                $("#strtTm"+frmNum      ).attr("disabled",false);
                $("#endTm"+frmNum       ).attr("disabled",false);
                
                $("#paymentFreeCheck"+frmNum).attr("disabled",false);
                $("#paymentFreeCheck"+frmNum).prop("checked",false);
                $("#payment"+frmNum     ).val("");
                $("#payment"+frmNum     ).attr("disabled",false);
                $("#payment"+frmNum     ).attr("readonly",false);
            }else{
                $("#strtTm"+frmNum      ).val("");
                $("#endTm"+frmNum       ).val("");
                $("#strtTm"+frmNum      ).attr("disabled",true);
                $("#endTm"+frmNum       ).attr("disabled",true);
                $("#paymentFreeCheck"+frmNum).attr("disabled",true);
                $("#paymentFreeCheck"+frmNum).prop("checked",false);
                $("#payment"+frmNum     ).val("");
                $("#payment"+frmNum     ).attr("disabled",true);
                $("#payment"+frmNum     ).attr("readonly" ,true);
            }
       })
       
       $(".payment-free-check").bind("change",function(){
           
           let isChecked = $(this).is(":checked");
           let frmNum = $(this).val();
           
           if(isChecked){
        	   $("#payment"+frmNum     ).val("0");
               $("#payment"+frmNum     ).attr("readonly" ,true);
           }else{
        	   $("#payment"+frmNum     ).val("");
               $("#payment"+frmNum     ).attr("readonly" ,false);
           }
       })
    })
    
    function addInsertForm(){
        
         var source = $("#insertForm").html(); 
         var template = Handlebars.compile(source);

         for(let i= 2; i<= 10;i++){
	         var data = {frmNum:i}
	         var html = template(data);
	         $("#inserFrmListArea").append(html);
         }
    }

    save=()=>{

        var rsvtStrtDt = $("#rsvtStrtDt").val();
        var rsvtEndtDt = $("#rsvtEndtDt").val();

        if(rsvtStrtDt == null || rsvtStrtDt == ""){
            alert("예약시작일을 입력해주십시오")
            showErrorMark("#rsvtStrtDt")
            return;
        }
        if(rsvtEndtDt == null || rsvtEndtDt == "" ){
            alert("예약종료일을 입력해주십시오")
            showErrorMark("#rsvtEndtDt")
            return;
        }
        
        let today = moment().format('YYYYMMDD');
        
        if(rsvtStrtDt.replaceAll("-","") < today ){
            alert("예약시작일은 금일보다 이후여야 합니다.")
            showErrorMark("#rsvtStrtDt")
            return;
        }
        
        if(rsvtEndtDt.replaceAll("-","") < today ){
            alert("예약종료일은 금일보다 이후여야 합니다.")
            showErrorMark("#rsvtEndtDt")
            return;
        }
        
        if( rsvtStrtDt.replaceAll("-","") > rsvtEndtDt.replaceAll("-","")){
            alert("예약종료일은 예약시작일 이후여야 합니다.")
            showErrorMark("#rsvtEndtDt")
            return;
        }

        //요일  validation check
        possibleDayArr=[];
        $(".limit-day").each(function(){
            if(!$(this).is(":checked")){
                possibleDayArr.push($(this).val())
            }
        })
        
        if(possibleDayArr.length == 0){
            alert("모든 요일을 제외 할 수 없습니다.")
            return;
        }
        
        //체크된 폼 확인 
        let checkedFrms = [];
        $(".payment-checkbox").each(function(){
            if( $(this).is(":checked") ){
            	checkedFrms.push($(this).val())
            }
        })
        
        if(checkedFrms.length <= 0){
            alert("예약시간 및 금액설정을 해주십시오.")
            return;
        }
        
        //예약시간 및 금액 설정 사용여부 validation 
        var isValid = true;
        for(let y =0; y < checkedFrms.length;y++){

        	let frmNum = checkedFrms[y];
        	
            var strtTm  = $("#strtTm"+frmNum ).val();
            var endTm   = $("#endTm"+frmNum  ).val();
            var payment = $("#payment"+frmNum).val();
            var paymentFreeCheck = $("#paymentFreeCheck"+frmNum).is(":checked");
            
            if(strtTm==null || strtTm==''){
                alert("예약시간 시작일시를 입력 하세요");
                showErrorMark("#strtTm"+frmNum);
                isValid = false;
                break;
            }
            if(endTm==null || endTm==''){
                alert("예약시간 종료일시를 입력 하세요");
                showErrorMark("#endTm"+frmNum);
                isValid = false;
                break;
            }
            if(strtTm.replaceAll(":","") > endTm.replaceAll(":","") ){
                alert("예약시간 종료일시는 시작일시보다 이후여야 합니다.");
                showErrorMark("#endTm"+frmNum);
                isValid = false;
                break;
            } 
            if(payment==null || payment==''){
                alert("입력되지 않은 금액정보가 있습니다");
                showErrorMark("#payment"+frmNum);
                isValid = false;
                break;
            }
            if( !paymentFreeCheck && payment <=0 ){
                alert("금액은 0 이상이어야 합니다.");
                showErrorMark("#payment"+frmNum);
                isValid = false;
                break;
            }
        }
        if(!isValid)return;

        //하루중 시간 중복 여부 확인
        var frmArr = []
        checkedFrms.forEach(function(frmNumber){
        	frmArr.push(
                	{ 
                       'strtTm' :$("#strtTm"+frmNumber ).val()
                       ,'endTm' :$("#endTm"+frmNumber ).val()
                       ,'amt'   :$("#payment"+frmNumber ).val()
                    }
             );
        })
        
        let isThereDuplTime = false;
        
        frmArr.forEach(function(map){
            
        	frmArr.forEach(function(item){
		        
	        	let  strtTm = (map.strtTm).replaceAll(":","") 
	        	let  endTm  = (map.endTm).replaceAll(":","")
	        	let  compareStrtTm= (item.strtTm).replaceAll(":","") 
	        	let  compareEndTm= (item.endTm).replaceAll(":","")
	        	
	        	if( strtTm > compareStrtTm && strtTm < compareEndTm ){
	        		isThereDuplTime = true;
		        } 
	        	if( endTm > compareStrtTm && endTm < compareEndTm ){
	        		isThereDuplTime = true;
		        } 
	        })
        })
        
        if(isThereDuplTime){
            alert("중복되는 시간이 있습니다. 다시 설정해주십시오.")
            return;
        }

        if(!confirm("일괄등록 하시겠습니까?"))return;

        //Parameter 생성
        var start = moment(rsvtStrtDt).format('YYYY-MM-DD');
        var end = moment(rsvtEndtDt).format('YYYY-MM-DD');
        var days = moment(rsvtEndtDt).diff(moment(rsvtStrtDt), "days") //moment.duration(end.diff(start)).asDays();
        var daysArr =[];
        var paramDays = [];
        var pushDt = null;
        for(var x=0; x <= days ; x++){
            pushDt = (moment(start).add(x,'d')).format('YYYY-MM-DD');
            daysArr.push(pushDt);
        }

        var rsvtdeList=[];

        possibleDayArr.forEach(function(day_num){
            var dateArr = daysArr.filter(function(index){
                if(moment(index).day() == day_num) {return moment(index).format('YYYY-MM-DD')}
            })
            dateArr.forEach(function(d){paramDays.push(d)})
        });

        paramDays.forEach(function(de){
            
        	frmArr.forEach(function(item){
            	
                rsvtdeList.push(
                        { 'amt': item.amt
                          ,'de' : de
                          ,'alldayYn' :'N'
                          ,'spceid' : spceVo.spceid
                          ,'utztnSeCd' : '169102'
                          ,'bgngDt'   :de +" "+item.strtTm 
                          ,'endDt'    :de +" "+item.endTm
                          ,'rsvtPsbltyYn' :'Y'  
                        }
                )
            })
        })
        
        var params={
            'rsvtdeList' : rsvtdeList
            ,'spceid' : spceVo.spceid   
        }
        
        if(displayWorkProgress()){
            $.ajax({
                url : "/mng/spce/InsertSpceTotalStayInfo.do",
                type: 'POST',
                cache : false,
                traditional : true, //필수
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                data :JSON.stringify(params),
                success : function (data){
                    if(data.result=='success'){
                        alert(data.msg);
		                $('#calendar').fullCalendar('gotoDate', moment(rsvtStrtDt).format('YYYY-MM-DD'));
                        setTimeout(function(){makeCalendarEvent();},1000)
                        spceModal.hide();
                    }else{
                        alert(data.msg);
                    }
                    closeWorkProgress();
                }
            });
        }
        
    }
</script>
