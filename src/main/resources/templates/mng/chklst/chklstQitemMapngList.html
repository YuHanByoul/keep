<link rel="stylesheet" type="text/css" href="/files/assets/pages/nestable/nestable.css">
<script src="/files/assets/pages/nestable/jquery.nestable.js"></script>
<!--<script src="/files/assets/pages/nestable/custom-nestable.js"></script>-->
<div class="card-block-small p-t-0">
    <div class="mb-2 row">
        <div class="col-12 btn-group-sm" id="nestableMenu">
            <button type="button" class="col-auto btn btn-inverse m-r-5" data-action="expandAll">모두 펼치기</button>
            <button type="button" class="col-auto btn btn-disabled m-r-5" data-action="collapseAll">모두 접기</button>
            <button type="button" class="col-auto btn btn-primary" data-action="qitemLoad">문항 불러오기</button>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-12 col-sm-12">
            <div class="cf nestable-lists">
                <div class="dd" id="nestable">
                    <ol class="dd-list">
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="card-block-small">
    <!--
    <button type="button" class="btn btn-disabled m-r-5" onclick="chklstUpdate.offUpdateChklst();">취소</button>
    <th:block sec:authorize-url="/mng/chklst/updateChklst.do"><button type="button" class="btn btn-primary" onclick="chklstUpdate.onUpdateChklst();">저장</button></th:block>
    onInsertQitemMapngList
    -->
    <button class="btn btn-disabled m-r-5" onclick="qitemMapng.offQitemMapngList();">취소</button>
    <button class="btn btn-primary" onclick="qitemMapng.onInsertQitemMapngList();">저장</button>
</div>

<div class="modal fade" id="qitemListPopup" aria-hidden="true" data-bs-backdrop="static"></div>

<script th:inline="javascript">
    var qitemMapng = {
        qitemMapngList: /*[[${qitemMapngList}]]*/
        , chklstid: /*[[${param.chklstid}]]*/ 
        , init: function() {
            this.setNestable();
            this.registEvent();
        },
        
        setNestable: function() {
            var _this = this;
            var list = this.qitemMapngList;
            
            $(list).each(function(index, item) {
                _this.addItem(item);
            });
            
            $('#nestable').nestable({
                maxDepth: 3
            }).on("change", function(e) {
                _this.updateOutput(e);
            });
          
            _this.updateOutput($('#nestable').data("output", $("#nestable-output")));
        }
        
        , addItem: function(data) {
            if(data.treeOrd == 1) {
                $("#nestable > ol").append(
                    '<li class="dd-item" data-cd="' + data.lv2key + '"><div class="dd-handle" style="pointer-events: none;">' + data.cn + '</li></div>'
                );
            } else if(data.treeOrd == 2) {
                var parentLi = data.treeOrd == 2 ? $("[data-cd=" + data.lv1key + "]") : $("[data-cd=" + data.lv2key + "]"); // 상위 li
                var childLen = parentLi.find("> ol > li").length;
                if(childLen == 0) { // 하위 li를 처음 생성하는 경우
                    parentLi.append(
                        '<ol class="dd-list"><li class="dd-item" data-cd="' + data.lv2key + '"><div class="dd-handle" style="pointer-events: none;">' + data.cn + '</li></div></ol>'
                    );
                } else {
                    parentLi.find(" > ol").append(
                        '<li class="dd-item" data-cd="' + data.lv2key + '"><div class="dd-handle" style="pointer-events: none;">' + data.cn + '</li></div>'
                    );
                }
            } else {
                var parentLi = $("[data-cd=" + data.lv2key + "]");
                var childLen = parentLi.find("> ol > li").length;
                var newYn = data.newYn ? data.newYn : "N";
                if(childLen == 0) { // 하위 li를 처음 생성하는 경우
                    parentLi.append(
                        '<ol class="dd-list"><li class="dd-item" data-cd="' + data.lv2key + '"><div class="dd-handle" data-newYn="' + newYn + '" data-qitemid="' + data.qitemid + '">' + data.cn + '</li></div></ol>'
                    );
                } else {
                    parentLi.find(" > ol").append(
                        '<li class="dd-item" data-cd="' + data.lv2key + '"><div class="dd-handle" data-newYn="' + newYn + '" data-qitemid="' + data.qitemid + '">' + data.cn + '</li></div>'
                    );
                }
            }
        }
        
        , updateOutput: function(e) {
            var list = e.length ? e : $(e.target);
            var output = list.data("output");
            if(JSON) {
                output.val(JSON.stringify(list.nestable("serialize")));
            } else {
                output.val("JSON browser support required for this demo.");
            }
        }
            
        , registEvent: function() {
            $("#nestableMenu").on("click", function(e) {
                var target = $(e.target);
                var action = target.data("action");
                if(action == "qitemLoad") {
                    var url = "/mng/chklst/chklstQitemListPopup.html";
                    $("#qitemListPopup").load(url, function(response, status, xhr) {
                        if(status == "success") {
                            qitemListModal = new bootstrap.Modal($('#qitemListPopup'));
                            qitemListModal.show();
                        }
                    });
                } else {
                    $(".dd").nestable(action);
                }
            });
        }
        
        , onInsertQitemMapngList: function() {
            console.log($("[data-qitemid]").length);
            var param = {};
            var chklstid = this.chklstid[0];
            
            if($("[data-qitemid]").length == 0) {
                alert("추가된 문항이 없습니다.");
                return false;
            }
            
            $("[data-qitemid]").each(function(index, item) {
                param["qitemList[" + index + "].chklstid"] = chklstid;
                param["qitemList[" + index + "].ordr"] = index + 1;
                param["qitemList[" + index + "].qitemid"] = $(item).attr("data-qitemid");
                param["qitemList[" + index + "].newYn"] = $(item).attr("data-newyn");
            });
            
            if(displayWorkProgress()) {
                $.ajax({
                    url : "/mng/chklst/updateChklstQitemMapng.do",
                    type: "POST",
                    cache: false,
                    dataType: "json",
                    data: param,
                    success: function(response) {
                        if(response.result == "success") {
                            alert(response.msg);
                            chklstGrid.resetListContent();
                        } else {
                            alert(response.msg);
                        }
                        closeWorkProgress();
                    }
                });
            }
            
            return false;
            if(!($("#chklstUpdateForm").valid())) return;
            $("input[name='useYn']").val($("#useYn").is(":checked") ? "Y" : "N");
            var param = $("#chklstUpdateForm").serialize();
            
            if(displayWorkProgress()) {
                $.ajax({
                    url : "/mng/chklst/updateChklst.do",
                    type: "POST",
                    cache: false,
                    dataType: "json",
                    data: param,
                    success: function(response) {
                        if(response.result == "success") {
                            alert(response.msg);
                            chklstGrid.resetListContent();
                        } else {
                            alert(response.msg);
                        }
                        closeWorkProgress();
                    }
                });
            }
        }
        
        , offQitemMapngList: function() {
            chklstGrid.toggleContent();
        }
    };
    
    $(function() {
        qitemMapng.init();
    });
</script>