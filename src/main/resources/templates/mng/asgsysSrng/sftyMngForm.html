<form id="sftyMngFrm">
<input type="hidden" id="prgrmid" name="prgrmid" th:value="${sftyMngInfo.prgrmid}">
<input type="hidden" id="filegrpid" name="filegrpid" th:value="${sftyMngInfo.filegrpid == null or sftyMngInfo.filegrpid == ''}? 0: ${sftyMngInfo.filegrpid}"/>
<input type="hidden" id="bfrCertFilegrpid" name="bfrCertFilegrpid" th:value="${sftyMngInfo.bfrCertFilegrpid == null or sftyMngInfo.bfrCertFilegrpid == ''}? 0: ${sftyMngInfo.bfrCertFilegrpid}"/>

	<div class="card-header p-t-0 p-b-0">
	    <h3 class="sub-title"><strong>안전관리 메뉴얼</strong></h3>
	</div>
    <div class="card-block-small p-t-0">
        <div class="mb-3 form-group row">
            <div class="mb-0 form-group">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>첨부파일</strong></label>
                <div class="col-sm-12">
                    <input type="file" multiple id="sftyMngMnlFile" name="sftyMngMnlFile" class="form-control form-control-sm" />
                </div>
                <div class="mt-2 row">
                    <div class="col-auto">
                        <th:block th:if="${mnlFileList} != null">
                            <th:block th:each="item:${mnlFileList}" th:if="${item.fileid} > 0">
                                <span class='label label-inverse ' th:id="'file_'+${item.fileid}">
                                    <th:block th:text="${item.orginlFileNm}"></th:block>&nbsp;&nbsp;
                                    <a class='text-white' href="javascript:void(0)"
                                    th:name="${item.fileid}"
                                    th:attr="data-idntfc-key=${item.fileIdntfcKey}"
                                    th:onclick="fn_deleteFile(this.name, this.dataset.idntfcKey)">X</a>
                                </span>
                            </th:block>
                        </th:block>
                        <div id="mnlFileUploadError"></div>
                        <div id="mnlFileUploadSuccess"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-header p-t-0 p-b-0">
	    <h3 class="sub-title"><strong>프로그램 지도자 대상 교육</strong>
	    </h3>
	</div>
	<div class="card-block-small p-t-0">
	    <div class="mb-2 row">
	        <div class="col-12 col-lg-6 mb-2 mb-lg-0">
	            <div class="mb-0 form-group row">
	                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"
	                       for="sftyMngProgramLeaderEduDate"><strong>교육시기</strong></label>
					<div class="col-12">
						<input type="text" class="form-control form-control-sm" name="ldrEduSess" id="ldrEduSess" placeholder=""  th:value="${sftyMngInfo.ldrEduSess}" emode="mod" />
					</div>
				</div>
	        </div>
	        <div class="col-12 col-lg-6">
	            <div class="mb-0 form-group row">
	                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"
	                       for="sftyMngProgramLeaderEduManager"><strong>담당자</strong></label>
					<div class="col-12">
						<input type="text" class="form-control form-control-sm" name="ldrEduPic" id="ldrEduPic" placeholder="" th:value="${sftyMngInfo.ldrEduPic}" emode="mod" />
					</div>
				</div>
	        </div>
	    </div>
	    <div class="mb-0 form-group row">
			<label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="sftyMngProgramLeaderEduContents"><strong>교육내용 개요</strong></label>
			<div class="col-12">
				<textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="" id="prtcpntEduCn" name="prtcpntEduCn" emode="mod" ><th:block th:text="${sftyMngInfo.prtcpntEduCn}"></th:block></textarea>
			</div>
	    </div>
	</div>
	<div class="card-header p-t-0 p-b-0">
	    <h3 class="sub-title"><strong>프로그램 참가자 대상 교육</strong></h3>
	</div>
	<div class="card-block-small p-t-0">
	    <div class="mb-2 row">
	        <div class="col-12 col-lg-6 mb-2 mb-lg-0">
	            <div class="mb-0 form-group row">
	                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"
	                       for="sftyMngProgramApplicantEduDate"><strong>교육시기</strong></label>
	                <div class="col-12">
						<input type="text" class="form-control form-control-sm" name="prtcpntEduSess" id="prtcpntEduSess" placeholder="" th:value="${sftyMngInfo.prtcpntEduSess}" emode="mod" />
					</div>
	            </div>
	        </div>
	        <div class="col-12 col-lg-6">
	            <div class="mb-0 form-group row">
	                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"
	                       for="sftyMngProgramApplicantEduManager"><strong>담당자</strong></label>
					<div class="col-12">
						<input type="text" class="form-control form-control-sm" name="prtcpntEduPic" id="prtcpntEduPic" placeholder="" th:value="${sftyMngInfo.prtcpntEduPic}" emode="mod" />
					</div>
				</div>
	        </div>
	    </div>
	    <div class="mb-0 form-group row">
			<label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="sftyMngProgramApplicantEduContents"><strong>교육내용 개요</strong></label>
			<div class="col-12">
				<textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="" id="ldrEduCn" name="ldrEduCn" emode="mod" ><th:block th:text="${sftyMngInfo.ldrEduCn}"></th:block></textarea>
			</div>
	    </div>
	</div>
	<div class="card-header p-t-0 p-b-0">
	    <h3 class="sub-title"><strong>안전관리 사전인증</strong></h3>
	</div>
	<div class="card-block-small p-t-0">
	    <div class="mb-2 form-group row">
	        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
	            <strong>인증여부</strong></div>
	        <div class="col-12">
            <div class="form-radio">
	           <div class="radio radio-inline" >
	               <span kattr:radio_yn="bfrCertYn" label1="예" label2="아니오" th:attr="defaultVal=${sftyMngInfo.bfrCertYn == null ? 'N':sftyMngInfo.bfrCertYn}" addStyle="margin-top:4px" addClass="col-sm-3" isAdmin="true" />
	           </div>
	       </div>
	    </div>
	    <div class="mb-0 form-group row">
	        <div class="mb-0 form-group">
	            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>첨부파일</strong></label>
	            <div class="col-sm-12">
                    <input type="file" multiple id="bfrCertFile" name="bfrCertFile" class="form-control form-control-sm" />
				</div>
                <!-- 안전관리 첨부파일 -->
	            <div class="mt-2 row">
                    <div class="col-auto" id="sftyFileListDiv">
                        <th:block th:unless="${#lists.isEmpty(bfrCertFileList)}" th:each="item, i : ${bfrCertFileList}" th:if = "${item.fileid} > 0">
                        <span class ='label label-inverse ' th:id="'bfrCertFile_'+${item.fileid}">
                            <th:block th:text="${item.orginlFileNm}"></th:block>&nbsp;&nbsp;
                            <a  class = 'text-white' href = "javascript:void(0)" th:name="${item.fileid}" th:attr="data-idntfc-key=${item.fileIdntfcKey}" th:onclick="fn_deleteFile(this.name, this.dataset.idntfcKey)">X</a>
                        </span>
                    </div>
	            </div>
                <div id="sftyFileUploadError"></div>
                <div id="sftyFileUploadSuccess"></div>
                <!-- 안전관리 첨부파일 -->
	        </div>
	    </div>
	</div>
	<div class="card-block-small">

        <button type="button" id="sftyMngLstBtn"  class="btn btn-inverse m-r-5" onclick="gridHelper1.resetListContent()">목록</button>
	    <button type="button" id="sftyMngSaveBtn" class="btn btn-primary m-r-5" onclick="fn_saveSftyMngFrm()">저장</button>
        <button type="button" id="sftyMngNextBtn" class="btn btn-primary" onclick="fn_sftyMngNextbtn()">다음</button>
	</div>

</form>
<script th:inline="javascript">

function fn_sftyMngFrmInit(){

}

function fn_sftyMngNextbtn(){

    $("#jdsgTab5Link").removeClass("active");
    $("#jdsgTab6Link").addClass("active");
    selectJdsgTab("jdsgTab6Link");
}

function fn_saveSftyMngFrm(){

	if(!confirm("저장 하시겠습니까?")){return;}

    var data =  $("#sftyMngFrm").serialize() ;

    $.ajax({
        url : "/mng/asgsysSrng/updateSftyMng.do",
        type: 'POST',
        cache : false,
        dataType: 'json',
        data : data,
        success : function (data){
            if(data.result=="success"){
                alert("수정이 완료 되었습니다.");
                loadJdsgTabContent("/mng/asgsysSrng/sftyMngForm.html?prgrmid=" + prgrmid);
            }else{
                alert("수정중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
            }
        },
        error : function (error){
        }
    });
}

//안전관리 메뉴얼 첨부파일

$('#sftyMngMnlFile, #bfrCertFile').on("change", function(event) {
    var trgtGrpid = (this.id == "sftyMngMnlFile") ? "filegrpid" : "bfrCertFilegrpid";

    var formData = new FormData();
    var objFile = event.target;
    var content = "";

    for( i = 0 ; i < objFile.files.length ; i++) {
        formData.append("files", objFile.files[i]);
    }

    if($("#"+trgtGrpid).val() != '0' && $("#"+trgtGrpid).val()!='' && $("#"+trgtGrpid).val()!=null){
        formData.append("filegrpid", $('#'+trgtGrpid).val());
    }
    formData.append("filegrpNm", "asgsysSrng_file");

    $.ajax({
    	url : '/uploadMultipleFiles.do',
        processData : false,
        contentType : false,
        data : formData,
        type : 'POST',
        success : function(response) {
            if(response.result == 'fail'){
                alert(response.msg);
            }else{
debugger;
                if($("#"+trgtGrpid).val()=='0' || $("#"+trgtGrpid).val()==''  || $("#"+trgtGrpid).val()==null){
                    $("#"+trgtGrpid).val( response[0].filegrpid );
                }

                for(i = 0 ;i < response.length; i++ ){
                    content =  "<span id='"+response[i].fileid+"' class='label label-inverse' href=javascript:downloadFileByFileid('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"')>"+response[i].orginlFileNm
                    content += "&nbsp;&nbsp;<a href='javascript:void(0)' onclick =fn_deleteFileList('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"') class='text-white'>X</a></span>"
                }

                if(trgtGrpid == "filegrpid") {
                    $('#mnlFileUploadSuccess').append(content);
                    $("#sftyMngMnlFile").val("");
                }else{
                    $('#sftyFileUploadSuccess').append(content);
                    $("#bfrCertFile").val("");
                }
            }
        }
    });

});

function fn_deleteFileList(fileid, fileIdntfcKey){
    if(!confirm("파일을 삭제하시겠습니까?")){return;}
    fn_deleteFile(fileid, fileIdntfcKey);
    $("#"+fileid).remove();
}

function fn_deleteFile(fileid, fileIdntfcKey){

    var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;
      $.ajax({
        url : deleteFileUrl,
        type: 'GET',
        cache : false,
        dataType: 'json',
        success : function (data){
            console.log(data);
            if(data.result=="success"){
                $("#"+fileid).remove();
                alert("파일삭제가 완료 되었습니다.");
            }else{
                alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
            }
        },
        error : function (error){
        }
     })
};


fn_sftyMngFrmInit();
</script>