<form id="sprtgrpSrngFrm">
<input type="hidden" id="prgrmid"      name="prgrmid"       th:value="${sprtgrpSrngInfo.prgrmid}"><!-- 프로그램id -->
<input type="hidden" id="splmntDmndid" name="splmntDmndid"  th:value="${sprtgrpSrngInfo.splmntDmndid}"><!-- 보완요청id -->
<input type="hidden" id="sbmsnid"      name="sbmsnid"       th:value="${sprtgrpSrngInfo.sbmsnid}"><!-- 체크리스트 제출 id -->
<input type="hidden" id="sbmsnSttsCd"  name="sbmsnSttsCd"   th:value="${sprtgrpSrngInfo.sbmsnSttsCd}"><!-- 제출상태코드 -->
<input type="hidden" id="scr"          name="scr"           th:value="${sprtgrpSrngInfo.scr}"><!-- 점수 -->
<input type="hidden" id="sprtgrpid"    name="sprtgrpid"     th:value="${sprtgrpSrngInfo.sprtgrpid}"><!-- 지원단id -->
<input type="hidden" id="rsltid"       name="rsltid"        th:value="${sprtgrpSrngInfo.rsltid}"><!-- 결과id -->
<input type="hidden" id="formid"       name="formid"        th:value="${sprtgrpSrngInfo.formid}"><!-- 심사양식id -->

	<div class="col-12">
	    <div class="card">
	        <div class="card-header p-b-0">
	            <h3 class="sub-title"><strong>신청 정보</strong></h3>
	        </div>
	        <div class="card-block-small p-t-0">
	            <div class="mb-2 row">
	                <div class="col-12 col-lg-6 mb-2 mb-lg-0">
	                    <div class="mb-0 form-group">
	                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="sprtgrpSrngProgramName"><strong>프로그램명</strong></label>
	                        <div class="col-sm-12">
	                            <input type="text" class="form-control form-control-sm" name="sprtgrpSrngProgramName" id="sprtgrpSrngProgramName" placeholder="" th:value="${sprtgrpSrngInfo.prgrmNm}" readonly="">
	                        </div>
	                    </div>
	                </div>
	                <div class="col-12 col-lg-6">
	                    <div class="mb-0 form-group">
	                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="sprtgrpSrngAgencyName"><strong>기관명</strong></label>
	                        <div class="col-sm-12">
	                            <input type="text" class="form-control form-control-sm" name="sprtgrpSrngAgencyName" id="sprtgrpSrngAgencyName" placeholder="" th:value=${sprtgrpSrngInfo.instNm} readonly="">
	                        </div>
	                    </div>
	                </div>
	            </div>
	            <div class="mb-2 row">
	                <div class="col-12 col-lg-6 mb-2 mb-lg-0">
	                    <div class="mb-0 form-group">
	                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
	                            <strong>숙박여부</strong></div>
	                        <div class="col-12 row align-items-center">
	                            <div class="col-12 col-lg-auto mb-2 mb-lg-0">
	                                <div class="form-radio">
	                                   <span kattr:radio_yn="styYn" label1="숙박" label2="비숙박" th:attr="defaultVal=${sprtgrpSrngInfo.styYn == null ? 'N':sprtgrpSrngInfo.styYn}" addStyle="margin-top:4px" addClass="col-sm-3" onchange="" isAdmin="true" disabled></span>
	                                </div>
	                            </div>
	                            <div class="col-12 col-lg-auto row align-items-center">
	                                <div class="col-auto">
	                                    <input type="text" class="form-control form-control-sm" name="styNight" id="styNight" placeholder="" th:value=${sprtgrpSrngInfo.styNight} style="width: 40px;" readonly>
	                                </div>
	                                <div class="col-auto p-l-0">박</div>
	                                <div class="col-auto">
	                                    <input type="text" class="form-control form-control-sm" name="styDaytm" id="styDaytm" placeholder="" th:value=${sprtgrpSrngInfo.styDaytm} style="width: 40px;" readonly>
	                                </div>
	                                <div class="col-auto p-l-0">일</div>
	                            </div>
	                        </div>
	                    </div>
	                </div>
	                <div class="col-12 col-lg-6">
	                    <div class="mb-0 form-group">
	                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
	                            <strong>운영형태</strong></div>
	                        <div class="col-12">
	                            <div class="form-radio">
	                                <div class="radio radio-inline">
	                                   <span id="operFrmCd" kattr:radio_code="operFrmCd" th:attr="grpCd=120, selectedCd=${sprtgrpSrngInfo.operFrmCd}" addStyle="margin-top:4px" addClass="col-sm-3" isAdmin="true" disabled>
	                                </div>
	                            </div>
	                        </div>
	                    </div>
	                </div>
	            </div>
	            <div class="mb-2 row">
	                <div class="col-12 col-lg-6 mb-2 mb-lg-0">
	                    <div class="mb-0 form-group">
	                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
	                            <strong>안전관리 사전인증여부</strong></div>
	                        <div class="col-12">
	                            <div class="form-radio">
	                                <div class="radio radio-inline">
	                                    <span kattr:radio_yn="sftyMngYn" label1="예" label2="아니오" th:attr="selectedCd=${sprtgrpSrngInfo.sftyMngYn}" addStyle="margin-top:4px" addClass="col-sm-3" onchange="" isAdmin="true"></span>
	                                </div>
	                            </div>
	                        </div>
	                    </div>
	                </div>
	                <div class="col-12 col-lg-6">
	                    <div class="mb-0 form-group">
	                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
	                            <strong>첨부파일</strong></div>
	                        <div class="row">
	                            <div class="col-auto">
	                                    <span class="label label-inverse">
	                                        sampleFile.pptx <a href="javascript:void(0)" class="text-white">X</a>
	                                    </span>
	                            </div>
	                        </div>
	                    </div>
	                </div>
	            </div>
	            <div class="mb-2 row">
	                <div class="col-12 col-lg-6 mb-2 mb-lg-0">
	                    <div class="mb-0 form-group">
	                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
	                            <strong>증빙서류</strong></div>
	                        <div class="row">
	                            <div class="col-auto">
	                                    <span class="label label-inverse">
	                                        sampleFile.pptx <a href="javascript:void(0)" class="text-white">X</a>
	                                    </span>
	                            </div>
	                        </div>
	                    </div>
	                </div>
	                <div class="col-12 col-lg-6">
	                    <div class="mb-0 form-group">
	                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
	                            <strong>진행상태</strong></div>
	                        <div class="col-12">
                                <span kattr:select_code="srgnSttsCd" th:attr="grpCd=114,selectedCd=${sprtgrpSrngInfo.srgnSttsCd}" firstOptTxt="- 전체 -" addClass="form-select form-select-sm form-control-sm" isAdmin="true">
	                        </div>
	                    </div>
	                </div>
	            </div>
	       </div>
<!--  -->
           <div class="card-header p-t-0 p-b-0">
               <h3 class="sub-title"><strong>지원단 정보</strong></h3>
           </div>
           <div class="card-block-small p-t-0">
               <div class="mb-0 row">
                   <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                       <div class="mb-0 form-group">
                           <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="supportGroupJudgingSupportGroupName"><strong>지원단 성명</strong></label>
                           <div class="col-sm-12">
                               <input type="text" class="form-control form-control-sm" name="supportGroupJudgingSupportGroupName" id="supportGroupJudgingSupportGroupName" placeholder="" th:value="${sprtgrpSrngInfo.srgnSttsCd}" readonly="">
                           </div>
                       </div>
                   </div>
                   <div class="col-12 col-lg-6">
                       <div class="mb-0 form-group">
                           <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="supportGroupJudgingSupportGroupDate"><strong>지원단 방문일정</strong></label>
                           <div class="col-sm-12">
                               <input type="text" class="form-control form-control-sm" name="vstDt" id="vstDt" placeholder="" th:value="${sprtgrpSrngInfo.vstDt}" readonly="">
                           </div>
                       </div>
                   </div>
               </div>
           </div>
           <div class="card-header p-t-0 p-b-0">
               <div class="sub-title row m-l-0 m-r-0 m-b-0 align-items-center">
                   <div class="col-12 col-lg-6 mb-2 mb-lg-0 p-l-0">
                       <strong>보완요청</strong>
                   </div>
                   <div class="col-12 col-lg-6 text-right p-r-0 btn-group-sm">
                       <button type="button" class="btn btn-primary" id="splmntDmnd" onclick="fn_reqSplmntDmndBtn(this.id)">보완요청</button>
                   </div>
               </div>
           </div>

            <div class="card-block-small p-t-0">
                <div class="col-12 table-border-style">
                    <div class="table-responsive">
                        <table id="splmntDmndGrid" class="table"></table>
                    </div>
                </div>
            </div>

            <!-- 체크리스트 -->
            <th:block th:each="item , i : ${sprtgrpCheckList}">

                <th:block th:switch="${item.treeOrd}">

                    <div class="card-header p-t-0 p-b-0" th:case="1" >
                        <div class="sub-title row m-l-0 m-r-0 align-items-center">
                            <div class="col-12 col-lg-6 mb-2 mb-lg-0 p-l-0"><strong><th:block th:text="${item.cn}"</th:block></strong></div>
                            <div class="col-12 col-lg-6 text-right p-r-0"><strong><span class="text-danger d-inline fs-6">15</span> /15점</strong></div>
                        </div>
                    </div>


                    <div name="chkLv2block" class="col-12 table-border-style mb-2" th:case="2" th:with="sum=0, temp=0">
                       <div class="col-12 table-responsive">
                           <table class="table table-border-style table-columned">
                               <thead>
                               <tr class="border-bottom-inverse border-top" style="border-top-color: #404E67 !important;">
                                   <th colspan="2" class="text-center v-middle"><th:block th:text="${item.cn}"</th:block></th>
                                   <th class="text-center v-middle" style="width: 60px;">배점
                                   </th>
                                   <th class="text-center v-middle" style="width: 60px;">예
                                   </th>
                                   <th class="text-center v-middle" style="width: 60px;">아니오
                                   </th>
                               </tr>
                               </thead>
                               <tbody>

                               <th:block th:each="item2 , k : ${sprtgrpCheckList}" >


                                    <tr class="border-bottom" th:if="${item2.treeOrd == 3 && sprtgrpCheckList[i.index].lv2key == sprtgrpCheckList[k.index].lv2key }" >
                                        <td class="text-center v-middle" style="width: 60px;" >
                                            <th:block th:text="${item2.ordr}"</th:block>
                                        </td>
                                        <td th:id="${'cnY' + item2.lv1key}">
                                            <th:block th:text="${item2.cn}"</th:block>
                                        </td>
                                        <td class="text-center v-middle"><th:block th:text="${item2.altm}"</th:block></td>

                                        <td class="text-center v-middle">

                                            <label class="mb-0 form-label'" >
                                                <input class="form-check-input" type="radio" th:checked="${item2.scr > 0 ? true:false}" th:data-ordr="${item2.ordr}"
                                                    th:name="${'cRdoY' + item2.lv2key + '_'+ item2.qitemid}" th:id="${'cRdoY' + item2.lv2key + '_'+  item2.qitemid}" th:attr="altm=${item2.altm}" value="Y" >
                                            </label>
                                        </td>
                                        <td class="text-center v-middle">
                                            <label class="mb-0 form-label'" >
                                                <input class="form-check-input" type="radio" th:checked="${item2.scr <= 0 ? true:false}"
                                                    th:name="${'cRdoN' + item2.lv2key + '_'+  item2.qitemid}" th:id="${'cRdoN' + item2.lv2key + '_'+  item2.qitemid}" th:attr="altm=${item2.altm}" value="N" >
                                            </label>
                                        </td>
                                   </tr>
                               </th:block>

                                   <tr>
                                       <th colspan="2" class="table-active text-center">총점</th>
                                       <th colspan="3" class="table-active text-center">
                                           <span class="text-danger" th:id="${'scrSum'+item.lv2key} ">0점</span>
                                       </th>
                                   </tr>

                               </tbody>
                           </table>
                       </div>
                    </div>

                </th:block>
            </th:block>


            <div class="card-header p-t-0 p-b-0">
                <h3 class="sub-title"><strong>현장점검 결과</strong></h3>
            </div>
            <div class="card-block-small p-t-0">
                <div class="mb-0 form-group row">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="supportGroupJudgingOnSiteInspectionResult"><strong>위
                        지표 점수부여에 대한 평가 근거, 조정사유 및 추가의견을 기술하여
                        주십시오.</strong></label>
                    <div class="col-12">
                        <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="" id="srngOpnn" name="srngOpnn"><th:block th:text="${sprtgrpSrngInfo.srngOpnn}"</th:block></textarea>
                    </div>
                </div>
            </div>
            <div class="card-header p-t-0 p-b-0">
                <h3 class="sub-title"><strong>최종심사평</strong></h3>
            </div>
            <div class="card-block-small p-t-0">
                <div class="mb-0 form-group row">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="supportGroupJudgingFinalEvaluation"><strong>위 지표
                        점수부여에 대한 평가 근거, 조정사유 및 추가의견을 기술하여 주십시오.</strong></label>
                    <div class="col-12">
                        <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="" id="chklstRsltCn" name="chklstRsltCn"><th:block th:text="${sprtgrpSrngInfo.chklstRsltCn}"</th:block></textarea>
                    </div>
                </div>
            </div>
	        <div class="card-block-small">
	            <button class="btn btn-inverse m-r-5">목록</button>
	            <button type="button" class="btn btn-primary" onclick="fn_insertSprtgrpSrng()">저장</button>
	        </div>
	    </div>
	</div>
</form>

<!--서류요청(보완요청)팝업-->
<div class="modal fade" id="splmntDmndPopup" aria-hidden="true" data-bs-backdrop="static"></div>

<script th:inline="javascript">

    var sprtgrpCheckList = /*[[${sprtgrpCheckList}]]*/null;
    var prgrmid;

    var splmntDmndGridHelper;

    var gridArgs;



    initSprtgrpSrngFrm();

    function initSprtgrpSrngFrm() {

    	initScrSum();

    	prgrmid = $("#prgrmid").val();
    	splmntDmndGridHelper = new GridHelper('splmntDmndGrid','splmntDmndContentPanel');

    	writeSplmntDmndGridData();

        $("#styYn"    ).attr("disabled", true);
        $("#sftyMngYn").attr("disabled", true);
        $("#operFrmCd").attr("disabled", true);

        $("div[name='chkLv2block'").wrapAll("<div class='card-block-small p-t-0'></div>")
        //$("[id^='scrSum']")   //총점
    }


    //보완요청 버튼
    function fn_reqSplmntDmndBtn(id){

        var key = $("#splmntDmndid").val();
        var cd;
        var mode;

        //보완요청
        if("splmntDmnd"==id){
            cd = "111108"
            mode = "splmntDmnd"
        }

        openSplmntDmndModal(key, cd, mode)
    };

    //보완요청 팝업 호출
    var splmntDmndAddModal;
    var openSplmntDmndModal = ( key, cd, mode) => {

        var vSttsCd = cd;
        var vMode = mode;

        var vKey1 = prgrmid;
        var vKey2 = key;
        if(vSttsCd == null || vSttsCd == "undefined" || vSttsCd == "") vSttsCd = '';

        var url = "/mng/asgsysSrng/splmntDmndPopup.html?prgrmid="+ vKey1+"&splmntDmndid=" + vKey2+ "&sttsCd="+vSttsCd+"&mode="+vMode;

        $("#splmntDmndPopup").load(url, function(response, status, xhr) {

            if (status == "success") {

                splmntDmndAddModal = new bootstrap.Modal($('#splmntDmndPopup'));
                splmntDmndAddModal.show();

            }
        });
    }

    //보완요청 그리드
    function writeSplmntDmndGridData(){

        $("#splmntDmndGrid").jsGrid({
            height       : "220px",
            width        : "100%",
            autoload     : true,
            sorting      : true,
            paging       : false,
            pageLoading  : true,
            pageIndex    : 1,
            noDataContent: "데이터가 없습니다.",
            controller: {
                loadData: function (filter) {
                    var data = $.Deferred();

                    var formData = $('#searchFrm').serializeArray();
                    var params = [
                            {name: "pageNumber", value: filter.pageIndex},
                            {name: "rowPerPage", value: filter.pageSize},
                            {name: "prgrmid"   , value: prgrmid},
                    ]

                    params.push({name: "orderField", value: 'reg_dt'});

                    formData = formData.concat(params);

                    $.ajax({
                      type: "GET",
                      contentType: "application/json; charset=utf-8",
                      url: "/mng/asgsysSrng/selectSplmntDmndList.do",
                      dataType: "json",
                      data: formData
                    }).done(function(response){

                        var da = {
                                data : escapeGridData(response.splmntDmndList)
                                ,itemsCount : response.totalCount
                            };
                      data.resolve(da);
                    });
                    return data.promise();
                },
            },
            fields: [
                { name : 'splmntDmndid', css:'hide'}
              , { name : 'prgrmid',      css:'hide'}
              , { title: 'No.'           ,name: 'rowNumber',   type: "number", width : "80", align:"center",  sorting :false }
              , { title: '등록 진행상태' ,name: 'sttsCd',      type: "text"  , width: "100", align:"center"}
              , { title: '요청내용'      ,name: 'opnnCn',      type: "text"  , width: "100", align:"left"}
              , { title: '요청일'        ,name: 'regDt',       type: "text"  , width: "100", align:"center" }
              , { title: '완료처리일'    ,name: 'cmptnPrcsDe', type: "text"  , align:"center" }
            ],

            rowClick: function(args) {

                if(args.event.originalEvent.target.cellIndex == 0 || isNaN(args.event.originalEvent.target.cellIndex)) return;

                if(args.event.originalEvent.target.cellIndex == 4) {

                    var key = args.item.splmntDmndid
                    var cd  = args.item.sttsCd;
                    openSplmntDmndModal(key, cd);

                }
            }
        });
    }

    function initScrSum(){

    	var allScr = $("[id^='scrSum']");
    	var totalscore = 0;

    	for (var i=0; i< allScr.length;i++ ){

    		var scrId = allScr[i].id;
    		var lvCd  = scrId.substr(6,6);

    		var rdoGrp = $("[name^='cRdoY"+lvCd+"']");
    		var sumScr = 0;

    		for(var k=0; k< rdoGrp.length; k++){
    			var rdoId = rdoGrp[k].id

    			if($("#"+rdoId).prop("checked") && false == isNaN( $("#"+rdoId).attr("altm")) ) {

    				sumScr = Number(sumScr)+ Number($("#"+rdoId).attr("altm"));
    			}

    		}
    		$("#scrSum"+lvCd).text(sumScr+"점");

    		totalscore = Number(totalscore) + Number(sumScr);
    	}

    	$("#scr").val(totalscore);


    }


    //체크리스트 라디오 클릭
    $("[name^='cRdo']").on('click', function() {

    	//라디오 id,name = cRdo+ lv2Cd + qitemid

        var rdoId = this.id;
        var lvCd = rdoId.substr(5,6)
        var tail = rdoId.split("_")[1];

        var opponentRdoId = rdoId.substr(4, 1) == "N" ? "cRdoY"+lvCd+"_"+tail: "cRdoN"+lvCd+"_"+tail;
        $("#"+rdoId).prop("checked",true);
        $("#"+opponentRdoId).prop("checked",false);

        //$("[id^='scrSum']")

        initScrSum();

    });

    function fn_insertSprtgrpSrng(){

    	var param = {};

        if(!($("#sprtgrpSrngFrm").valid())) return;

    	$("[id^=cRdoY]").each(function(index, item) {

    		param["ansLst[" + index + "].sbmsnid"] = $("#sbmsnid").val();

    		param["ansLst[" + index + "].seCd"] = $(item).attr("id").split("_")[0].replace("cRdoY","");
    		param["ansLst[" + index + "].qitemid"] = $(item).attr("id").split("_")[1];
    		//param["ansLst[" + index + "].cn"] = $(item).attr("id").split("_")[0].replace("cRdoY","");
    		//param["ansLst[" + index + "].idntyMttr"] = $(item).attr("id").split("_")[1].replace("cRdoY","");

    		param["ansLst[" + index + "].scr"] = $(item).prop("checked") ? $(item).attr("altm"): 0
    		param["ansLst[" + index + "].ordr"] = $(item).attr("data-ordr");

    	});

    	$("[id^=cnY]").each(function(index, item) {
    		param["ansLst[" + index + "].cn"] = item.innerText;
    	});

        param["prgrmid"     ]= prgrmid;
        param["sbmsnid"     ]= $("#sbmsnid").val();
        param["rsltid"      ]= $("#rsltid").val();
        param["sbmsnSttsCd" ]= "128102";    //제출
        param["sprtgrpid"   ]= $("#sprtgrpid").val();
        param["srngOpnn"    ]= $("#srngOpnn").val();
        param["chklstRsltCn"]= $("#chklstRsltCn").val();
        param["scr"         ]= $("#scr").val();

        if(!confirm("저장하시겠습니까?")) return;

        if(displayWorkProgress()){
            $.ajax({
                url      : "/mng/asgsysSrng/insertSprtgrpSrng.do",
                type     : 'POST',
                cache    : false,
                dataType : 'json',
                data     : param,
                success  : function (data){
                    if(data.result=="success"){

                        alert(data.msg);
                        closeWorkProgress();
                        gridHelper1.resetPageContent();

                    }else{
                        alert(data.msg);
                    }

                }
            });
        }
    }

</script>