<form id="jdgsSrngInfoFrm" >
    <input type="hidden" id="loginUserid"  name="loginUserid"  th:value="${loginUserid}" ><!-- 로그인사용자id-->
    <input type="hidden" id="prgrmid" name="prgrmid" th:value="${jdgsSrngInfo.prgrmid}"><!-- 프로그램id -->
    <input type="hidden" id="rsltid"  name="rsltid"  th:value="${jdgsSrngInfo.rsltid }" ><!-- 결과id -->
    <input type="hidden" id="jdgsid"  name="jdgsid"  th:value="${jdgsSrngInfo.jdgsid }" ><!-- 심사위원id -->
    <input type="hidden" id="formid"  name="formid"  th:value="${jdgsSrngInfo.formid }" ><!-- 심사양식id -->
    <input type="hidden" id="sbmsnid" name="sbmsnid" th:value="${jdgsSrngInfo.sbmsnid}"><!-- 제출id-->

    <div class="card-header p-b-0">
        <h3 class="sub-title">
            <strong>신청 정보</strong>
        </h3>
    </div>
    <div class="card-block-small p-t-0">
        <div class="mb-3 row">
            <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="judgeJudgingProgramName"><strong>프로그램명</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" name="prgrmNm" id="prgrmNm" placeholder="" th:value="${jdgsSrngInfo.prgrmNm}" readonly="">
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="mb-0 form-group">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="judgeJudgingAgencyName"><strong>기관명</strong></label>
                    <div class="col-sm-12">
                        <input type="text" class="form-control form-control-sm" name="instNm" id="instNm" placeholder="" th:value=${jdgsSrngInfo.instNm} readonly="">
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3 row">
			<div class="col-12 col-lg-6 mb-2 mb-lg-0">
				<div class="mb-0 form-group">
					<div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
						<strong>숙박여부</strong>
					</div>
					<div class="col-12 row align-items-center">
                        <div class="col-12 col-lg-auto mb-2 mb-lg-0">
                            <span kattr:radio_yn="styYn" label1="숙박" label2="비숙박" isAdmin="true" th:attr="defaultVal=${jdgsSrngInfo.styYn == null ? 'N':jdgsSrngInfo.styYn}"></span>
                        </div>

    					<div class="col-12 col-lg-auto row align-items-center">
    						<div class="col-auto">
    							<input type="text" class="form-control form-control-sm" name="styNight" id="styNight" placeholder="" th:value=${jdgsSrngInfo.styNight} style="width: 40px;" readonly>
    						</div>
    						<div class="col-auto p-l-0">박</div>
    						<div class="col-auto">
    							<input type="text" class="form-control form-control-sm" name="styDaytm" id="styDaytm" placeholder="" th:value=${jdgsSrngInfo.styDaytm} style="width: 40px;" readonly>
    						</div>
    						<div class="col-auto p-l-0">일</div>
    					</div>
                    </div>
				</div>
            </div>

			<div class="col-12 col-lg-6">
				<div class="mb-0 form-group">
					<div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
						<strong>운영형태</strong>
					</div>
					<div class="col-12">
						<div class="form-radio bg-form"><!-- [230125] class bg-form 추가 -->
							<div class="radio radio-inline">
                                <span kattr:radio_code="operFrmCd" th:attr="grpCd=120, selectedCd=${jdgsSrngInfo.operFrmCd}" addStyle="margin-top:4px" addClass="col-sm-3" isAdmin="true" >
			                 </div>
					    </div>
				   </div>
			    </div>
            </div>
        </div>


			<div class="mb-3 row">
				<div class="col-12 col-lg-6 mb-2 mb-lg-0">
					<div class="mb-0 form-group">
						<div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
							<strong>안전관리 사전인증여부</strong>
						</div>
						<div class="col-12">
							<div class="form-radio">
								<div class="radio radio-inline">
								    <span kattr:radio_yn="sftyMngYn" label1="예" label2="아니오" th:attr="selectedCd=${jdgsSrngInfo.sftyMngYn}" addStyle="margin-top:4px" addClass="col-sm-3" onchange="changeSftyMngYn()" isAdmin="true" readonly></span>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-12 col-lg-6">
					<div class="mb-0 form-group">
						<div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
							<strong>첨부파일</strong>
						</div>
                        <div class="mb-2 col-12">
<!--                              <input type="file" multiple id="evdncDcmntFile1" name="evdncDcmntFile1" class="form-control form-control-sm" th:if="${#lists.isEmpty(bfrCertFileList)}" disabled/> -->
                            <span th:unless="${!#lists.isEmpty(bfrCertFileList) && bfrCertFileList[0].fileid!=0 && bfrCertFileList[0].fileid!=null}">선택된 파일 없음.</span>
                        </div>

                        <div class="row">
                            <div class="col-auto" id="sftyFileListDiv">
                                <th:block th:unless="${#lists.isEmpty(bfrCertFileList)}" th:each="item, i : ${bfrCertFileList}" th:if = "${item.fileid} > 0">
                                <span class ='label label-inverse ' th:id="'bfrCertFile_'+${item.fileid}">
                                    <span class='text-white' href="javascript:void(0)" th:name="${item.fileid}" th:onclick="downloadFileByFileid([[${item.fileid}]],[[${item.fileIdntfcKey}]])"><th:block th:text="${item.orginlFileNm}"></th:block>&nbsp;&nbsp;</a></span>
                                </span>
                            </div>
                        </div>
					</div>
				</div>
			</div>

			<div class="mb-3 row">
				<div class="col-12 col-lg-6 mb-2 mb-lg-0">
					<div class="mb-0 form-group">
						<div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
							<strong>증빙서류</strong>
						</div>
                        <div class="mb-2 col-12">
                            <span th:unless="${!#lists.isEmpty(aplyFileList) && aplyFileList[0].fileid!=0 && aplyFileList[0].fileid!=null}">선택된 파일 없음.</span>
                        </div>
						<div class="row">
                            <div class="col-auto" id="aplyFileListDiv">
                                <th:block th:unless="${#lists.isEmpty(aplyFileList)}" th:each="item, i : ${aplyFileList}" th:if = "${item.fileid} > 0">
                                <span class ='label label-inverse ' th:id="'aplyFile_'+${item.fileid}">
                                    <span class='text-white' href="javascript:void(0)" th:name="${item.fileid}" th:onclick="downloadFileByFileid([[${item.fileid}]],[[${item.fileIdntfcKey}]])"><th:block th:text="${item.orginlFileNm}"></th:block>&nbsp;&nbsp;</a></span>
                                </span>
                            </div>
                        </div>
					</div>
				</div>
				<div class="col-12 col-lg-6">
					<div class="mb-0 form-group">
						<div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
							<strong>진행상태</strong>
						</div>
						<div class="col-12">
			                <span kattr:select_code="sttsCd" th:attr="grpCd=111, selectedCd=${jdgsSrngInfo.sttsCd}" firstOptTxt="- 전체 -" addClass="form-select form-select-sm form-control-sm" isAdmin="true" disabled>
						</div>
					</div>
				</div>
			</div>
			<div class="mb-3 row">
				<div class="col-12 btn-group-sm">
                    <!-- 파일 확정후 수정 필요 -->
                    <a type="button" href="/cmmFile/aplyInfoFormFile/tempFile.xlsx" class="col-auto btn btn-primary" download="심사세부기준표.xlsx" >심사세부기준표 다운로드</a>
				</div>
			</div>
        </div>

        <div class="card-header p-t-0 p-b-0">
            <h3 class="sub-title"><strong>심사위원심사</strong></h3>
        </div>

        <div class="card-block-small p-t-0">
            <div class="mb-3 col-12 table-border-style">
                <div class="col-12 table-responsive">
                    <table class="table table-framed table-bordered">
                        <thead>
                            <tr class="border-bottom-inverse">
                                <th class="text-center v-middle" style="width: 60px;"><strong>No</strong></th>
                                <th class="text-center v-middle"><strong>지정기준</strong></th>
                                <th class="text-center v-middle"><strong>확인사항</strong></th>
                                <th class="text-center v-middle" style="width: 100px;"><strong>배점</strong></th>
                                <th class="text-center v-middle" style="width: 130px;"><strong>심사점수</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            <th:block th:if="${!#lists.isEmpty(dsgnSrgnFormList)}">
                                <th:block th:each="item , i : ${dsgnSrgnFormList}">
                                    <tr class="border-bottom">
                                        <td class="text-center v-middle">[[${i.count}]]</td>
                                        <td th:if="${item.rnk=='1'}" th:rowspan="${item.rowSpan}" class="text-center v-middle">[[${item.cdNm }]]</td>
                                        <td class="text-center v-middle">[[${item.idntyMttr}]]</td>
                                        <td class="text-center v-middle">[[${item.altm}]]</td>
                                        <td class="text-center v-middle">
                                            <input th:if     ="${item.chklstSeCd != ''}" type="number" class="text-center v-middle form-control form-control-sm" th:max="${item.altm}" th:name="${'scr'+ i.count}" th:id="${'scr'+ i.count}" placeholder="0" th:value="${item.chkLstScr}" disabled/>
                                            <input th:unless ="${item.chklstSeCd != ''}" type="number" class="text-center v-middle form-control form-control-sm" th:max="${item.altm}"th:name="${'scr'+ i.count}" th:id="${'scr'+ i.count}" placeholder="0" th:value="${item.scr}" />
                                            <input type="hidden" th:id="${'srngData' + i.count}"
                                                                 th:data-formid     = "${item.formid    }"
                                                                 th:data-qitemid    = "${item.qitemid   }"
                                                                 th:data-dsgncrtrCd = "${item.dsgncrtrCd}"
                                                                 th:data-idntyMttr  = "${item.idntyMttr }"
                                                                 th:data-chklstSeCd = "${item.chklstSeCd}"
                                                                 th:data-scr        = "${item.scr       }"
                                                                 th:data-ordr       = "${item.ordr      }"
                                                                 th:data-altm       = "${item.altm      }" >
                                        </td>
                                    </tr>
                                </th:block>
                            </th:block>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="table-active text-center">총 총점</th>
                                <th class="table-active text-center" id="sumAltm"><strong>000</th>
                                <th class="table-active text-center" id="sumScr">000</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="mb-3 form-group row">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="srngOpnn"><strong>심사의견</strong></label>
				<div class="col-12">
					<textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="심사의견 입력(1000자 이내)" id="srngOpnn" name="srngOpnn"><th:block th:text="${jdgsSrngInfo.srngOpnn}"></th:block></textarea>
				</div>
            </div>
    	</div>
		<div class="card-block-small">
			<button type="button" class="btn btn-inverse m-r-5" onclick="gridHelper1.toggleContent();">목록</button>
			<button type="button" class="btn btn-primary" onclick="fn_insertJdgsSrngInfo()" id="saveBtn" >저장</button>
		</div>
    </div>
</form>
<script th:inline="javascript">

var ansList = /*[[${ansList}]]*/null;

function fn_insertJdgsSrngInfo() {

	if(!$("#jdgsSrngInfoFrm").valid())return;
	if(!confirm("저장하시겠습니까?")) return;

	var param={};
	 //프로그램 일정
    $("#jdgsSrngInfoFrm input").each(function(index, item) {

        if("checkbox" == item.type && "on" == item.value) {
            param[item.id] = "Y";
        }
        else{
            param[item.id] = item.value;
        }
    });

	/*심사자id*/
	param["userid"] = $("#jdgsid").val();
	/*심사의견*/
    param["srngOpnn"] = $("#srngOpnn").val()

    param["sbmsnSttsCd"] = "203102"    /*제출완료*/

	//총점
    param["scr"] = Number($("#sumScr").prop("innerText"));

    $("[id^=srngData]").each(function(index, item) {

        if(index==0) param["formid"] = $(item).attr("data-formid");
    	param["dsgnSrngFormLst[" + index + "].prgrmid"    ] = $("#prgrmid").val();    //프로그램 id (key)
    	param["dsgnSrngFormLst[" + index + "].sbmsnid"    ] = $("#sbmsnid").val();    //프로그램 id (key)
    	param["dsgnSrngFormLst[" + index + "].qitemid"    ] = $(item).attr("data-qitemid"    );    //프로그램 id (key)
    	param["dsgnSrngFormLst[" + index + "].dsgncrtrCd" ] = $(item).attr("data-dsgncrtrCd" );
    	param["dsgnSrngFormLst[" + index + "].idntyMttr"  ] = $(item).attr("data-idntyMttr"  );
    	param["dsgnSrngFormLst[" + index + "].chklstSeCd" ] = $(item).attr("data-chklstSeCd" );
//     	param["dsgnSrngFormLst[" + index + "].scr"        ] = $(item).attr("data-scr"        );
    	param["dsgnSrngFormLst[" + index + "].scr"        ] = $(item).parent().find('[id^=scr]').val();
    	param["dsgnSrngFormLst[" + index + "].ordr"       ] = $(item).attr("data-ordr"       );

    });


	if(displayWorkProgress()){
        $.ajax({

            url : "/mng/asgsysSrng/updateJdgsSrngDetail.do",
            type: 'POST',
            cache : false,
            dataType: 'json',
            data : param,
            success : function (data){
                if(data.result=="success"){

                    alert(data.msg);
                    gridHelper1.resetPageContent();
                }else{
                    alert(data.msg);
                }
                closeWorkProgress();
            }
        });
    }
}

function setAns(){
	$("#jdgsSrngInfoFrm [id^=srngData]").each(function(index, item){

        for(var idx in ansList){
            if(ansList[idx].qitemid == $(this).attr('data-qitemid')) {
                $(item).parent().find('[id^=scr]').val(ansList[idx].scr);
            }
        }
    });
};

function setSumScr(){
	var vSumScr = 0;
    var vSumAltm = 0;
    $("#jdgsSrngInfoFrm [id^=srngData]").each(function(index, item){

        for(var idx in ansList){
            if(ansList[idx].qitemid == $(this).attr('data-qitemid')) {
                $(item).parent().find('[id^=scr]').val(ansList[idx].scr);
            }
        }

        vSumScr  += Number($(item).parent().find('[id^=scr]').val());
        vSumAltm += Number($("#"+item.id).attr("data-altm"))
    });

    $("#sumScr").prop("innerText", vSumScr)
    $("#sumAltm").prop("innerText",vSumAltm)
}

function fn_jdgsSrngInfoFrmInit(){
	if($("#loginUserid").val() == $("#jdgsid").val()){
		$("#saveBtn").prop("disabled",false);
	}else{
		$("#saveBtn").prop("disabled",true);
	}

	$("#jdgsSrngInfoFrm [id^=operFrmCd]").prop("disabled", true);
    $("#jdgsSrngInfoFrm [id^=styYn]").prop("disabled", true);
    $("#jdgsSrngInfoFrm [id^=sftyMngYn]").prop("disabled", true);

	setAns();
	setSumScr();
}

$(function(){
	fn_jdgsSrngInfoFrmInit();

	$("[id^=scr]").focusout("change",function(){

	    var sumScore=0;

	    $("[id^=scr]").each(function(idx,item) {

	        var altm = Number($("#srngData"+(idx+1)).attr("data-altm"));

	        if(item.value > altm){

	            $("#scr"+(idx+1)).val(altm);
	        }
	        sumScore += Number(item.value);
	    })

	    $("#sumScr").prop("innerText",sumScore)

	});

    var validator = $("#jdgsSrngInfoFrm").validate({
        rules: {
            srngOpnn : { maxlength: 1000 }
        },
        messages: {
            srngOpnn : { maxlength: "심사의견 1000자를 넘을 수 없습니다." }
        }
    });
});

</script>
