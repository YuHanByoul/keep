<div class="modal-dialog modal-lg" role="document">
    <div class="modal-content type_2">
        <div class="modal-header">
            <h4 class="modal-title">담당자 배정</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                <span aria-hidden="true"></span>
            </button>
        </div>
        <div class="modal-body">

            <form name="picAltmntFrm" id="picAltmntFrm" action="" onsubmit="return false;" class="card">
                <div class="card-block-small">
                    <div class="mb-2 form-group row">
                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>배정 방식</strong></div>
                        <div class="col-12">
                            <div class="form-radio">
                                <div class="radio radio-inline">
                                    <label class="mb-0 form-label">
                                        <span kattr:radio_yn="picYn" id="picYn" name="picYn" label1="전문가 검색" label2="심사위원 그룹 검색" th:attr="defaultVal=${mode}=='Y' ? 'Y': 'N'" addStyle="margin-top:4px" addClass="col-sm-3" onchange="" isAdmin="true" disabled></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-lg-3 mb-2 mb-lg-0">
                            <div class="mb-0 form-group">
                                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="popupFilterIdNameInput"><strong>아이디/이름</strong></label>
                                <div class="input-group input-group-sm input-group-dropdown mb-0">
                                    <input type="text" class="form-control form-control-sm" aria-label="Text input with dropdown button" name="popupFilterIdNameInput" id="popupFilterIdNameInput">
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-3 mb-2 mb-lg-0">
                            <div class="mb-0 form-group">
                                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="popupFilterCredentialInput"><strong>자격증명</strong></label>
                                <div class="input-group input-group-sm input-group-dropdown mb-0">
                                    <input type="text" class="form-control form-control-sm" aria-label="Text input with dropdown button" name="popupFilterCredentialInput" id="popupFilterCredentialInput">
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-3 mb-2 mb-lg-0">
                            <div class="mb-0 form-group">
                                <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>전문분야</strong></div>
                                <div class="col-12">
                                    <span kattr:select_code="instTypeCd" th:attr="grpCd=104" firstOptTxt="- 전체 -" addClass="form-select form-select-sm form-control-sm" isAdmin="true">
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-lg-3">
                            <div class="mb-0 form-group">
                                <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>활동가능지역</strong></div>
                                <div class="col-12">
                                    <span kattr:select_code="instTypeCd" th:attr="grpCd=125" firstOptTxt="- 전체 -" addClass="form-select form-select-sm form-control-sm" isAdmin="true">
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="mt-1 p-t-20 text-center border-top">
                        <button class="btn btn-disabled m-r-5" onclick="fn_initPopup()" >초기화</button>
                        <button class="btn btn-primary" onclick="fn_searchPopup()" >검색</button>
                    </div>
                </div>
            </form>
            </div>
            <div class="card m-b-10">
                <div class="row p-20 p-b-0">
                    <div class="col-12 col-md-6">
                        <h5><strong>전문가 검색결과</strong></h5>
                    </div>
                    <div class="col-12 col-md-6 text-right">
                        <button type="button" class="btn btn-primary waves-effect waves-light " onclick="fn_picChct()">등록</button>
                    </div>
                </div>
                <div class="card-block-small">
                    <div class="row">
                        <div class="col-12">


                            <table id="picGrid" class="table-responsive"></table>
                            <div id="picListPager" class="text-center"></div>

                        </div>
                    </div>
                </div>
            </div>
        <div class="modal-footer">
<!--             <button type="button" class="btn btn-primary waves-effect waves-light " onclick="fn_picChct()">선택</button> -->
        </div>
    </div>
</div>


<script th:inline="javascript">

    var selectedItems;
	var picGridHelper;

	var picSe = /*[[${param.mode}]]*/ null;    // 담당자 구분


	$(function(){
		selectedItems=[];
		picGridHelper = new GridHelper('picGrid','picContentPanel');

	    $("input[name=picYn]").attr("disabled", true);    //담당자 구분

	    modeGridWrite();

	    //writePicGridData();
	});

    function modeGridWrite() {

    	var gb;
    	var fieldsA=[];
    	var fieldsB=[];
    	var url = "/mng/asgsysSrng/selectPicList.do";
    	;
        if("Y" == picSe) {
            //지원단
        	gb = true;

        	fieldsA = [
        		{
                    headerTemplate: function() {
                            return $("<input>").attr("type", "checkbox").attr("id", "selectAllCheckbox")
                    },
                    itemTemplate: function(_, item) {
                        return $("<input>").attr("type", "checkbox").attr("class", "singleCheckbox").attr("id","userid-"+item.userid)
                            .prop("checked", $.inArray(item, selectedItems) > -1)
                            .on("change", function () {

                            $(this).is(":checked") ? selectItem( $(this).parent().next().next().text()
							                                    , $(this).parent().next().next().next().text()
							                                    , $(this).parent().next().next().next().next().text()
							                                    , $(this).parent().next().next().next().next().next().text()
							                                    , $(this).parent().next().next().next().next().next().next().text())
							                       : unselectItem($(this).parent().next().text()
								                    		    , $(this).parent().next().next().next().text()
	                                                            , $(this).parent().next().next().next().next().text()
	                                                            , $(this).parent().next().next().next().next().next().text()
                                                                , $(this).parent().next().next().next().next().next().next().text())
                            });
                        },
                        align: "center",
                        width: "30",
                        sorting: false
                }
               ,{ title: 'No.'          ,name: 'rowNumber', type: "number", width : "80", align:"center",  sorting :false }
               ,{ name: 'userid', type: "text", css:'hide'}
               ,{ title: '아이디'       ,name: 'acnt',      type: "text",   width: "120", align:"left"}
               ,{ title: '이름'         ,name: 'nm',        type: "text",   width: "120", align:"left"}
               ,{ title: '이메일'       ,name: 'eml',       type: "text",   width: "180", align:"left"}
               ,{ title: '전화번호'     ,name: 'telno',     type: "number", align:"center" }
               ,{ title: '자격증명'     ,name: 'crtfctNm',  type: "text",   width: "200", align:"left" }
               ,{ title: '전문분야'     ,name: 'sbjctCdNm', type: "text",   width: "120", align:"center" }
               ,{ title: '활동가능지역' ,name: 'rgnCdNm',   type: "text",   width: "120", align:"center" }
           ]

	    }else{
	    	//심사위원그룹
	    	gb = false;
	    	fieldsB = [
                {
                    headerTemplate: function() {
                            return $("<input>").attr("type", "checkbox").attr("id", "selectAllCheckbox")
                    },
                    itemTemplate: function(_, item) {
                        return $("<input>").attr("type", "checkbox").attr("class", "singleCheckbox").attr("id","grpId-"+item.grpId)
                            .prop("checked", $.inArray(item, selectedItems) > -1)
                            .on("change", function () {

                            $(this).is(":checked") ? selectItem( $(this).parent().next().text()
                            		                            , $(this).parent().next().next().text()
                            		                            , $(this).parent().next().next().next().text()
                            		                            , $(this).parent().next().next().next().next().text()
                            		                            , $(this).parent().next().next().next().next().next().text())
                                                   : unselectItem($(this).parent().next().text()
                                                		        , $(this).parent().next().next().text()
                                                                , $(this).parent().next().next().next().text()
                                                                , $(this).parent().next().next().next().next().text()
                                                                , $(this).parent().next().next().next().next().next().text())
                            });
                        },
                        align: "center",
                        width: "30",
                        sorting: false
                }
               ,{ name: 'useridGrp', type: "text", css:'hide'}
               ,{ title: '아이디'          ,name: 'userAcntGrp', type: "text",   width: "100", align:"left", css:'hide'}
               ,{ title: '이름'            ,name: 'userNmGrp',   type: "text",   width: "100", align:"left", css:'hide'}
               ,{ title: '이메일'          ,name: 'userEmlGrp',  type: "text",   width: "100", align:"left", css:'hide'}
               ,{ title: '전화번호'        ,name: 'userMoblphonGrp', type: "text", align:"center" , css:'hide'}
               ,{ title: 'No.'             ,name: 'rowNumber',   type: "number", width : "80", align:"center",  sorting :false }
               ,{ title: '심사위원그룹명'  ,name: 'grpNm',       type: "text", width : "120", align:"center",  sorting :false }
               ,{ title: '등록전문가 수'   ,name: 'regExprtCnt', type: "number", width : "100", align:"right",  sorting :false }
               ,{ title: '사용여부'        ,name: 'useYn',       type: "text", width : "80", align:"center",  sorting :false }
               ,{ title: '등록일'          ,name: 'regDt',       type: "text", width : "100", align:"center",  sorting :false }
               ,{ title: '자격증명심사상태',name: 'crtfctNm',    type: "text",   width: "120", align:"center" }
               ,{ title: '전문분야'        ,name: 'sbjctCd',     type: "text",   width: "150", align:"left" }
               ,{ title: '활동가능지역'    ,name: 'rgnCd',       type: "text",   width: "100", align:"center" }
               ,{ name: 'grpId', type: "text", css:'hide'}
           ]

	    }

        $("#picGrid").jsGrid({
            height: "auto",
            width: "100%",
            autoload: true,
            sorting: true,
            paging: true,
            pagerContainer: "#picListPager",
            pagerFormat: "{first} {prev} {pages} {next} {last}",
            pagePrevText: "이전",
            pageNextText: "다음",
            pageFirstText: " < 처음 ㅣ",
            pageLastText: " | 마지막 >",
            pageSize: 10,
            pageButtonCount: 10,
            pageLoading: true,
            pageIndex: 1,
            noDataContent: "데이터가 없습니다.",
            controller: {
                loadData: function (filter) {

                    var data = $.Deferred();

                    var formData = $('#picAltmntFrm').serializeArray();
                    var params = [
                            {name: "pageNumber", value: filter.pageIndex},
                            {name: "rowPerPage", value: filter.pageSize},
                    ]

                    if(filter.sortField != undefined){
                        params.push({name: "orderField", value: filter.sortField});
                        params.push({name: "orderDirection", value: filter.sortOrder});
                    }else{
                    	/*ORDER BY*/
                        params.push({name: "orderField", value: gb?'userid':'reg_dt'});
                    }

                    formData = formData.concat(params);

                    $.ajax({
                      type: "GET",
                      contentType: "application/json; charset=utf-8",
                      url: gb ? url+"?picSe="+picSe : url ,
                      dataType: "json",
                      data: formData
                    }).done(function(response){

                        var da = {
                                data : escapeGridData(response.picList)
                                ,itemsCount : response.totalCount
                            };
                      data.resolve(da);
                    });
                    return data.promise();
                },
            },
            fields: gb ? fieldsA : fieldsB,

            rowClick: function(args) {

                if(args.event.originalEvent.target.cellIndex == 0 || isNaN(args.event.originalEvent.target.cellIndex)) return;

                var detailUrl = "/mng/asgsysSrng/dsgnAplyDetailForm.html?prgrmid=" + args.item.prgrmid;

                picGridHelper.loadContent(detailUrl);
                picGridHelper.rowClick(args);
            },

            onPageChanged: function(args) {
            selectedItems = [];
        }
    });

        var selectItem = function(id, acnt, name, eml, telno) {

            var index = selectedItems.findIndex(item => item.userid === id);

            if(index == -1) {
            	selectedItems.push({"userid": id, "acnt":acnt, "nm" : name, "eml":eml, "telno":telno});
            }

            if($(".singleCheckbox").length == $(".singleCheckbox:checked").length) {
                $("#selectAllCheckbox").prop("checked", true);
            } else {
                $("#selectAllCheckbox").prop("checked", false);
            }
        };

        var unselectItem = function(item) {
            selectedItems = $.grep(selectedItems, function(i) {
            return i !== item;
            });
            if(selectedItems.length == 0) {
                $('#selectAllCheckbox').attr('checked', false);
            }
            if($(".singleCheckbox").length == $(".singleCheckbox:checked").length) {
                $("#selectAllCheckbox").prop("checked", true);
            } else {
                $("#selectAllCheckbox").prop("checked", false);
            }
        };

        $("#selectAllCheckbox").click(function(item) {
            selectedItems = [];
            if(this.checked) { // check select status
                $('#picAltmntPopup .singleCheckbox').each(function() {
                    this.checked = true;
                    selectItem($(this).parent().next().next().text(), $(this).parent().next().next().next().text());
                });
            }else {
                $('#picAltmntPopup .singleCheckbox').each(function() {
                    this.checked = false;
                    unselectItem(item);
                });

                selectedItems = [];
            }
        });

	}

	//초기화 버튼
	function fn_init() {
	    $("#searchType").val("searchPrgrmNm");
	    $("#searchKeyword").val('');
	    $("#searchSttsCd").val('');
	    $("#searchAplyStartDt").val('');
	    $("#searchAplyEndDt").val('');
	    $("#searchSrngSttsCd").val('');
	    $("#searchSrgnSttsCd").val('');
	    $("#searchChckDsgnStartDt").val('');
	    $("#searchChckDsgnEndDt").val('');
	}

	//검색버튼
	function fn_searchForm(){
	    picGridHelper.resetListContent();
	}

    function fn_picChct(){

        var duplicate = false;

        var splitId   ;
        var splitAcnt ;
        var splitNm   ;
        var splitEml  ;
        var splitTelno;



        if("Y" != picSe && selectedItems.length == 1) {

        	splitId    = selectedItems[0].userid.split(",");
        	splitAcnt  = selectedItems[0].acnt.split(",");
        	splitNm    = selectedItems[0].nm.split(",");
        	splitEml   = selectedItems[0].eml.split(",");
        	splitTelno = selectedItems[0].telno.split(",");

        	selectedItems = [];
            for(var i=0; i<splitId.length;i++) {



            	selectedItems.push({"userid": splitId[i], "acnt":splitAcnt[i], "nm" : splitNm[i], "eml":splitEml[i], "telno":splitTelno[i]});
            }
        }


        var data = {}

        data= {
                "mode"         : "Y" == picSe ? "sprtgrp":"jdgs"
              , "prgrmid"      : prgrmid
              , "jdgsid"       : ""
              , "sprtgrpid"    : ""
              , "bfrSprtgrpid" : ""
              , "srngSttsCd"   : "114102"    //심사전
              , "srgnSttsCd"   : "114102"    //심사전
              }

        for(var item of selectedItems) {

            var tempNo="";

        	if(item.telno != "" && item.telno.length == 11) {
                tempNo = item.telno;
                item.telno = tempNo.substr(0,3)+"-"+tempNo.substr(3,4)+"-"+tempNo.substr(7,4);
            }

            if(item.telno != "" && item.telno.length == 10) {
                tempNo = item.telno;
                item.telno = tempNo.substr(0,3)+"-"+tempNo.substr(3,3)+"-"+tempNo.substr(7,4);
            }

            if($("#picId-"+item.userid).length > 0  ) {
                duplicate = true;
            } else {
                var content = "<span class='label label-inverse' id='picId-" + item.userid
                content    += "' name='picInfo' id='"+item.userid+"'>" + item.nm + "("+ item.acnt+ ") | " + item.eml +" | " +item.telno
                content    += "&nbsp; <a href='javascript:void(0)' onclick='removePicInfo(" + item.userid+ ")' class='text-white'>X</a> </span>";


                if("Y" != picSe){
                	$("#jdgsPicList").append(content);    //심사위원

                	if(data.jdgsid == "" ) {
                		data.jdgsid = item.userid;

                	}else{
                		data.jdgsid = data.jdgsid +"," + item.userid;
                	}
                }
                else{


                	data.sprtgrpid=item.userid;

                	var bfrSprtgrpid = $("#sprtgrpPicList").children().prop("id");

                	if(bfrSprtgrpid != "" && bfrSprtgrpid != item.userid){
                		data.bfrSprtgrpid = bfrSprtgrpid;
                		$("#"+bfrSprtgrpid).remove();
                	}

                	//$("#"+$("#sprtgrpPicList").children().prop("id")).remove()
                	$("#sprtgrpPicList").append(content);    //지원단



                }
            }
        }

        if(data.jdgsid != "" || data.sprtgrpid != ""){

            $.ajax({
                url :"/mng/asgsysSrng/insertPicInfo.do",
                type: 'POST',
                cache : false,
                dataType: 'json',
                data : data,
                success : function (data){

                    if(data.result=="success"){

                    }else{
                        //alert("진행상태변경중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                    }
                    closeWorkProgress();
                },
                error : function (error){
                }
            })
        }

        if(duplicate) {
            alert('이미 등록한 담당자를 제외하고 추가하였습니다.')
        }

        picAltmntModal.hide();
    }


</script>