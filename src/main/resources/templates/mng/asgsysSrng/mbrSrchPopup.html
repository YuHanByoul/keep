<!-- 담당자정보 회원검색 팝업 -->
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content type_2">
            <div class="modal-header">
                <h4 class="modal-title">회원검색</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"></span>
                </button>
            </div>

            <div class="modal-body">
                <div class="card">
                    <div class="card-block-small">
			            <form id="searchManagerModalFrm" action="" onsubmit="return false;">

                        <div class="row">
                            <div class="col-12 col-lg-6 mb-3">
                                <div class="mb-0 form-group">
                                    <span class="form-label col-sm-12 col-form-label p-t-0 pb-1 mb-2"><strong>키워드</strong></span>
                                    <div class="input-group input-group-sm input-group-dropdown mb-0">
                                        <select name="searchType" id="searchType" class="form-select form-control form-control-sm ">
                                            <option value="">- 선택 -</option>
                                            <option value="searchUserNm">이름</option>
                                            <option value="searchInstNm">기관명</option>
                                        </select>
                                        <input type="text" name="searchKeyword" id="searchKeyword" class="form-control" aria-label="Text input with dropdown button">
                                    </div>
                                </div>
                            </div>
                        </div>
                       </form>

                        <div class="mt-1 p-t-20 text-center border-top">
                            <button type="button" class="btn btn-disabled m-r-5" onclick="initSearchManager()">초기화</button>
                            <button type="submit" class="btn btn-primary" onclick="searchManagerList()">검색</button>
                        </div>

                    </div>
                </div>

                <!--임시 그리드-->
                <div class="card m-b-10">
                    <div class="card-block-small">
                        <div class="dt-responsive table-responsive">

                        <div id="order-table_wrapper" class="dataTables_wrapper dt-bootstrap4">
                            <table id="instManagerModalGrid" class="table-responsive"></table>
                            <div id="listPager3" class="text-center"></div>
                       </div>
                        </div>
                    </div>
                </div>
                <!--//임시 그리드-->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary waves-effect waves-light" onclick="applyInstManager()">선택</button>
            </div>
        </div>
  </div>
  <!-- 담당자정보 회원검색 팝업 -->
  <script th:inline="javascript">

    var selectedItems;
    var mbrGrd;
    $(function(){

        mbrGrd = new GridHelper('instManagerModalGrid','contentPanel');
        writeManagerModalGridData();
    });

    searchManagerList = () =>{
    	mbrGrd.resetListContent();
    }

    initSearchManager = () =>{
    	$("#searchManagerModalFrm #searchType").val("");
    	$("#searchManagerModalFrm  #searchKeyword").val("");
    }

    function writeManagerModalGridData(){

        $("#instManagerModalGrid").jsGrid({
            height: "auto",
            width: "100%",
            autoload: true,
            sorting: true,
            paging: true,
            pagerContainer: "#listPager3",
            pagerFormat: "{first} {prev} {pages} {next} {last}",
            pagePrevText: "이전",
            pageNextText: "다음",
            pageFirstText: " < 처음 ㅣ",
            pageLastText: " | 마지막 >",
            pageSize: 10,
            pageButtonCount: 10,
            pageLoading: true,
            pageIndex: 1,
            noDataContent: "데이터가 없습니다.",

            controller: {
                loadData: function (filter) {

                    var data = $.Deferred();

                    var formData = $('#searchManagerModalFrm').serializeArray();
                    var params = [
                            {name: "pageNumber", value: filter.pageIndex},
                            {name: "rowPerPage", value: filter.pageSize},
                    ]

                    if(filter.sortField != undefined){
                        params.push({name: "orderField", value: filter.sortField});
                        params.push({name: "orderDirection", value: filter.sortOrder});
                    }else{
                        params.push({name: "orderField", value: 'reg_dt'});
                    }
                    var paramid = {
                    	name:"instid" ,value: $("#aplyFrm #instid").val()
                    }

                    formData = formData.concat(params);
                    formData = formData.concat(paramid);

//                       url: "/mng/inst/selectInstUser.do",
                    $.ajax({
                      type: "GET",
                      contentType: "application/json; charset=utf-8",
                      url: "/mng/asgsysSrng/selectMbrList.do",
                      dataType: "json",
                      data: formData,
                    }).done(function(response){

                        var da = {
                                data : escapeGridData(response.mbrList)
                                ,itemsCount : response.totalCount
                            };
                      data.resolve(da);
                    });
                    return data.promise();
                },
            },
            fields: [
                 {
                     itemTemplate: function(_, item) {
                         return $("<input>").attr("type", "radio").attr("class", "singleCheckbox3").attr("name","memchk")
                                .attr("value",item.userid).attr("id","memchk_"+item.userid)
                     },
                     align: "center",
                     width: "30",
                     sorting: false
                 }
                ,{ name: 'userid', css: 'hide' }
                ,{ name: 'acnt', css: 'hide' }
                ,{ name: 'nm', css: 'hide' }
                ,{ title: '사용자'   ,name: 'nm'    ,type: "text" , width: "200"
                    ,itemTemplate:function(value,item){return item.nm +" ( "+item.eml+" )"}
                    }
                ,{ title: '핸드폰'  ,name: 'moblphon',type: "text" , width: "150" ,align:"center"}
                ,{ title: '메일'   ,name: 'eml'     ,type: "text" , width: "200" }
            ],
            rowClick: function(args) {
                $("#memchk_"+args.item.userid).prop("checked",true);

                selectedItems = {"userid"    : args.item.userid
                		        , "nm"       : args.item.nm
                		        , "moblphon" : args.item.moblphon
                		        , "eml"      : args.item.eml
                		        , "acnt"     : args.item.acnt
                		        };
            }
        });

    }

  var applyInstManager = () =>{

      if($('input[name=memchk]:checked').length <= 0){
          alert("담당자를 선택해주세요");
          return;
      }


      if($('#instFrm').length >0){
    	  $('#instFrm #aplcntid').val(selectedItems.userid);
    	  dsgnAply.selectInstInfo();

    	  $('#instFrm #nm').val(selectedItems.nm);
    	  instManagerSearchModal.hide();

      }


      if($('#aplyFrm').length>0){

    	  var data = {
    	         prgrmid  : $('#aplyFrm #prgrmid').val()
    	       , aplcntid : selectedItems.userid
    	       , aplcntNm : selectedItems.nm
    	       , aplcntEml : selectedItems.eml
    	       , aplcntMoblphon : selectedItems.moblPhon
    	    }
    	  debugger;
    	//담당자 변경시 바로 update
          $.ajax({
              url :"/mng/asgsysSrng/updateMbr.do",
              type: 'POST',
              cache : false,
              dataType: 'json',
              data : data,
              success : function (data){

                  if(data.result=="success"){
                      alert("담당자가 변경 되었습니다.");
debugger;
                      //gridHelper1.resetPageContent();
                      //gridHelper1.showContent();
                      gridHelper1.loadContent("/mng/asgsysSrng/dsgnAplyDetailForm.html?prgrmid="+$("#prgrmid").val());
                      instManagerSearchModal.hide();

                  }else{
                      alert("담당자가 변경중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                  }
                  closeWorkProgress();

              },
              error : function (error){
              }
          })


      }

  }

</script>
</body>
</html>