<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="layout/mng/mobileSubLayout"
>
<body>
<div layout:fragment="content">
<form id="test">
    <div class="page-body">
        <ul class="nav nav-tabs tabs gray-tabs" role="tablist" id="tabTitle">
            <!-- 체크리스트 -->
            <li class="nav-item" th:each="title , a : ${checkList}" th:if="${title.treeOrd == 1}" th:tablv2key="${title.lv2key}">
            	<th:block th:if="${a.index == 0}">
	            	<a class="nav-link active" data-bs-toggle="tab" th:href="'#tab'+${title.lv2key}" role="tab" th:text="${title.cn}" name="tab" th:id="'tabList'+${title.lv2key}"></a>
            	</th:block>
            	<th:block th:unless="${a.index == 0}">
	            	<a class="nav-link" data-bs-toggle="tab" th:href="'#tab'+${title.lv2key}" role="tab" th:text="${title.cn}" name="tab" th:id="'tabList'+${title.lv2key}"></a>
            	</th:block> 
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#rslt" role="tab" name="tab" id="rsltList">결과 및 심사평</a>
            </li>
        </ul>

        <div class="tab-content tabs" id="tabContent">
            <!-- 체크리스트 -->
            <div class="tab-pane" th:each="title , a : ${checkList}" name="tab-pane" th:id="'tab'+${title.lv2key}" role="tabpanel" th:if="${title.treeOrd == 2 and title.cnt != 0}" th:panelv1key="${title.lv1key}" th:panelv2key="${title.lv2key}">
                <div class="card">
                    <div class="card-header p-b-0">
                        <h3 class="sub-title">
                            <div class="col"><strong th:text="${title.cn}"></strong></div>
                        </h3>
                    </div>
                    <div class="card-block">
                        <div class="row">
                        	<th:block th:each="row, b : ${checkList}">
	                            <div class="col-12 mb-3" th:if="${row.treeOrd==3 and title.lv2key==row.lv2key}">
	                                <div class="mb-0 form-group row">
	                                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong th:id="${'cnY' + row.lv1key}"><th:block  th:text="${row.ordr +1} + '. ' + ${row.cn} + ' ('+${row.altm} + '점)'"/><br><th:block th:if="${row.aplcntScr > 0}">사용자 : O</th:block><th:block th:if="${row.aplcntScr == 0}">사용자 : X</th:block></strong></div>
	                                    <div class="col-12">
	                                        <div class="btn-group-sm">
	                                            <input type="radio"
	                                            	   class="btn-check"
	                                            	   th:name="${'cRdoN' + row.lv2key + '_'+  row.qitemid}"
	                                            	   th:id="${'chkY' + row.lv2key + '_'+  row.qitemid}"
	                                            	   th:qitemid="${row.qitemid}"
	                                            	   th:seCd="${row.lv2key}"
	                                            	   th:cn="${row.cn}"
	                                            	   th:ordr="${row.ordr}"
	                                            	   th:altm="${row.altm}"
	                                            	   th:scr="${row.altm}"
	                                            	   th:chkYn="${row.aplcntScr > 0 ? true:false}"
	                                            	   th:checked="${row.aplcntScr > 0 ? true:false}"
	                                            	   autocomplete="off">
	                                            <label class="btn btn-disabled d-block" th:for="${'chkY' + row.lv2key + '_'+  row.qitemid}">예</label>
	                                        </div>
	                                        <div class="btn-group-sm mt-1">
	                                            <input type="radio"
	                                            	   class="btn-check"
	                                            	   th:name="${'cRdoN' + row.lv2key + '_'+  row.qitemid}"
	                                            	   th:id="${'chkN' + row.lv2key + '_'+  row.qitemid}"
	                                            	   th:qitemid="${row.qitemid}"
	                                            	   th:seCd="${row.lv2key}"
	                                            	   th:cn="${row.cn}"
	                                            	   th:ordr="${row.ordr}"
	                                            	   th:altm="${row.altm}"
	                                            	   th:scr="0"
	                                            	   th:chkYn="${row.aplcntScr > 0 ? true:false}"
	                                            	   th:checked="${row.aplcntScr == 0 ? true:false}"
	                                            	   autocomplete="off">
	                                            <label class="btn btn-disabled d-block" th:for="${'chkN' + row.lv2key + '_'+  row.qitemid}">아니오</label>
	                                        </div>
	                                    </div>
	                                </div>
	                            </div>                            
                        	</th:block>                            
                        </div>
                    </div>
                </div>
                <div class="card-block-small row justify-content-between">
                    <div class="col-auto">
		                <th:block th:if="${a.index == 1}">
	                        <button class="btn btn-disabled prevBtn">이전</button>
		                </th:block>
		                <th:block th:unless="${a.index == 1}">
		                	<button class="btn btn-disabled prevBtn" th:onclick="prevBtn([[${title.lv2key}]]);">이전</button>
		                </th:block>                    
                    </div>
                    <div class="col-auto">
						<th:block>
	                        <button class="btn btn-primary notifications nextBtn" data-type="danger" data-from="bottom" data-align="center" data-message="점검하지 않은 문항이 있습니다." th:onclick="nextBtn([[${title.lv2key}]]);">다음</button>
		                </th:block>
                    </div>
                </div>
            </div>
            <!-- [탭] 결과 및 심사평 -->
            <div class="tab-pane" id="rslt" name="tab-pane" role="tabpanel">
                <div class="card">
                    <div class="card-header p-b-0">
                        <h3 class="sub-title"><strong>점검 점수</strong></h3>
                    </div>
                    <div class="card-block">
                        <div class="col-12 table-responsive">
                            <table class="table table-framed table-bordered result_table">
                                <tbody class="result_body">
                                	<th:block th:each="title , a : ${checkList}" th:if="${title.treeOrd == 1 or title.treeOrd == 2}">
	                                    <tr class="border-bottom-inverse" th:if="${title.treeOrd == 1 and !a.first}">
	                                        <th class="text-center table-light">소계</th>
	                                        <th class="text-center table-light" id="subTotAltm"></th>
	                                        <th class="text-center table-light text-c-blue" id="subTotScr"></th>
	                                    </tr>	                                
		                                <tr class="border-bottom-inverse" style="border-top:1px solid #404E67;" th:if="${title.treeOrd == 1}">
		                                    <th class="text-center table-active" colspan="3" th:text="${title.cn}"></th>
		                                </tr>
		                                <tr th:if="${a.first}">
		                                    <th class="text-center table-light">항목</th>
		                                    <th class="text-center table-light">배점</th>
		                                    <th class="text-center table-light">획득</th>
		                                </tr>
		                                <tr th:if="${title.treeOrd == 2 and title.cnt != 0}">
		                                    <td class="text-center v-middle" th:text="${title.cn}"></td>
		                                    <td class="text-center v-middle rsltAltm" th:name="altm+${title.lv1key}" th:id="altm+${title.lv2key}"></td>
		                                    <td class="text-center v-middle text-c-blue rsltScr" th:name="scr+${title.lv1key}" th:id="scr+${title.lv2key}"></td>
		                                </tr>	                                
		                                <tr th:if="${a.last}">
		                                    <th class="text-center table-light">총점</th>
		                                    <th class="text-center table-light" id="totalAltm"></th>
		                                    <th class="text-center table-light text-c-blue" id="totalScr"></th>
		                                </tr>
                                	</th:block>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header p-b-0">
                        <h3 class="sub-title"><strong>현장점검 결과 및 최종 심사평</strong></h3>
                    </div>
                    <div class="card-block">
                        <div class="row form-group mb-3 required">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="srngOpnn"><strong>현장점검 결과</strong></label>
                            <div class="col-sm-12">
                                <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="위 지표 점수부여에 대한 평가 근거, 조정사유 및 추가의견을 기술하여 주십시오." id="srngOpnn" name="srngOpnn" th:value="${mobileAsgsysSrngInfo.srngOpnn}" th:text="${mobileAsgsysSrngInfo.srngOpnn}"></textarea>
                            </div>
                        </div>
                        <div class="row form-group mb-3 required">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="chklstRsltCn"><strong>최종 심사평</strong></label>
                            <div class="col-sm-12">
                                <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="현장점검 결과 총평을 적어주세요." id="chklstRsltCn" name="chklstRsltCn"  th:value="${mobileAsgsysSrngInfo.chklstRsltCn}" th:text="${mobileAsgsysSrngInfo.chklstRsltCn}"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row justify-content-between">
                    <div class="col-auto">
                        <button class="btn btn-disabled" onclick="prevBtn();">이전</button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary notifications" data-type="danger" data-from="bottom" data-align="center" id ="insertBtn" onclick="insertChkLst();">심사완료</button>
                    </div>
                </div>
            </div>
            <!-- // [탭] 결과 및 심사평 -->
        </div>

        <input type="hidden" id="prgrmid"      name="prgrmid"       th:value="${mobileAsgsysSrngInfo.prgrmid}"><!-- 프로그램id -->
        <input type="hidden" id="chklstid"     name="chklstid"      th:value="${mobileAsgsysSrngInfo.chklstid}"><!-- 체크리스트 id -->
        <input type="hidden" id="sbmsnid"      name="sbmsnid"       th:value="${mobileAsgsysSrngInfo.sbmsnid}"><!-- 체크리스트 제출 id -->
        <input type="hidden" id="sprtgrpid"    name="sprtgrpid"     th:value="${mobileAsgsysSrngInfo.sprtgrpid}"><!-- 지원단id -->
        
    </div>
</form>    
    <script type="text/javascript" src="/files/assets/js/bootstrap-growl.min.js"></script>
    <script th:inline="javascript">
	</script>    
    
    <script th:inline="javascript">
    	var checkList = /*[[${checkList}]]*/ null;
    	
    	// Tab click
       	$('a[name="tab"]').click(function(e){
       		e.preventDefault();
       		
       		var btn = $(".nextBtn")
			var nFrom = btn.attr('data-from');
			var nAlign = btn.attr('data-align');
			var nIcons = btn.attr('data-icon');
			var nType = btn.attr('data-type');
			var nAnimIn = btn.attr('data-animation-in');
			var nAnimOut = btn.attr('data-animation-out');
			var nMessage = btn.attr('data-message');
			
			/* check vaildation - start */
			// Tab을 클릭시 선택이 안된 체크리스트를 검증한다.
			var isChecked = true;
			if(this.id == "rsltList") {
				for(var i = 0; i < $(".tab-pane input:radio").length;) {
					var name = $($(".tab-pane input:radio")[i]).prop("name");
					if(!$("input:radio[name='"+name+"']").is(":checked")) {
						isChecked = false;
						$($($("input:radio[name='"+name+"']").parents()).find($("#tab"+$("input:radio[name='"+name+"']").attr("seCd")))).addClass("active")
						$("#rslt").removeClass("active");
						break;
					}
					i += 2;
				}
			}else {
				for(var i = 0; i < $(".tab-pane.active input:radio").length;) {
					var name = $($(".tab-pane.active input:radio")[i]).prop("name");
					if(!$("input:radio[name='"+name+"']").is(":checked")) {
						isChecked = false;
						break;
					}
					
					i += 2;
				}
				
				if(isChecked) {
					var nextChklst = $($(".tab-pane.active").next()).find($("input:radio"));
					for(var j = 0; j < nextChklst.length;) {
						var name = $(nextChklst[j]).prop("name");
						
						if(!$("input:radio[name='"+name+"']").is(":checked")) {
							$(".tab-pane.active").next().addClass("active")
							$(".tab-pane.active").prev().removeClass("active")
							isChecked = false;
							break;
						}				
						j += 2;
					}
				}
			}
			
			if(!isChecked) {
				notify(nFrom, nAlign, nIcons, nType, nAnimIn, nAnimOut,nMessage);
				
				$(".nav-link").removeClass('active');
				for(var i = 0; i < $(".nav-link").length; i++) {
					if('#tab' + $(".tab-pane.active").attr("panelv1key") == $($(".nav-link")[i]).attr("href")) {
						$($(".nav-link")[i]).addClass("active")
						break;
					}
				}
				
				return false;
			}
			/* check vaildation - end */
			
       		if($(this).attr("id") == "tabList140100") {
       			$('.tab-pane.active').removeClass('active');
       			$('#tab140110').addClass('active');
       			$('#tab140210').removeClass('active');
       			$('#rslt').removeClass('active');
       		}else if($(this).attr("id") == "tabList140200") {
       			$('.tab-pane.active').removeClass('active');
       			$('#tab140110').removeClass('active');
       			$('#tab140210').addClass('active');
       			$('#rslt').removeClass('active');
       		}else if($(this).attr("id") == "rsltList") {
       		}
       	});
       	
    	// 이전 버튼
       	function prevBtn(id) {       		
       		$("#tab"+id).prev().addClass('active');
       		$("#tab"+id).removeClass('active');
       		
       		var tabid = $("#tab"+id).attr('panelv1key');
       		var prevTabid = $($("#tab"+id).prev()).attr('panelv1key');
       		$("#tabList"+tabid).removeClass('active');
       		$("#tabList"+prevTabid).addClass('active');
       	}
       	
       	// 다음버튼
       	function nextBtn(id, stts) {
       		var e = window.event
       		e.preventDefault();
       		
       		var btn = $(".nextBtn")
			var nFrom = btn.attr('data-from');
			var nAlign = btn.attr('data-align');
			var nIcons = btn.attr('data-icon');
			var nType = btn.attr('data-type');
			var nAnimIn = btn.attr('data-animation-in');
			var nAnimOut = btn.attr('data-animation-out');
			var nMessage = btn.attr('data-message');
			
			/* check vaildation - start */
			// 다음버튼을 누를시 선택이 안된 체크리스트를 검증한다.
			var isChecked = true;
			for(var i = 0; i < $(".tab-pane.active input:radio").length;) {
				var name = $($(".tab-pane.active input:radio")[i]).prop("name");
				
				
				if(!$("input:radio[name='"+name+"']").is(":checked")) {
					isChecked = false;
				}
				
				i += 2;
			}
			
			if(!isChecked) {
				notify(nFrom, nAlign, nIcons, nType, nAnimIn, nAnimOut,nMessage);
				return false;
			}
			/* check vaildation - end */
			
       		var tabid = $("#tab"+id).attr('panelv1key');
       		var nextTabid = $($("#tab"+id).next()).attr('panelv1key');
       		
       		if($(".tab-pane.active").next().prop("id") == 'rslt') {
       			$("#rslt").addClass('active');

	       		$("#tabList"+tabid).removeClass('active');
	       		$("#rsltList").addClass('active');
       		}else {
	       		$("#tab"+id).next().addClass('active');
       			
	       		$("#tabList"+tabid).removeClass('active');
	       		$("#tabList"+nextTabid).addClass('active');
       		}
       		
       		$("#tab"+id).removeClass('active');
       	};
       	
       	// alert
		function notify(from, align, icon, type, animIn, animOut,message){
			$.growl({
				message: message,
			},{
				element: 'body',
				type: type,
				allow_dismiss: true,
				placement: {
					from: from,
					align: align
				},
				offset: {
					x: 30,
					y: 30
				},
				spacing: 10,
				z_index: 999999,
				delay: 2500,
				timer: 1000,
				url_target: '_blank',
				mouse_over: false,
				animate: {
					enter: animIn,
					exit: animOut
				},
				icon_type: 'class',
				template:'<div data-growl="container" class="alert" role="alert">' +
						 '<span data-growl="icon"></span>' +
						 '<span data-growl="title"></span>' +
						 '<span data-growl="message"></span>' +
						 '<a href="#" data-growl="url"></a>' +
						 '</div>'
			});
		};	
        
		// 결과 및 심사평 - 점검 점수
		// 페이지 진입시 setting 값
        var subTotAltm = 0;
        var subTotScr = 0;
        
        var totalAltm = 0;
        var totalScr = 0;
        
        var item = null;
        
        for(var i = 0; i < checkList.length; i++) {
        	item = checkList[i];
        	
        	if($("#altm"+item.lv2key).text() != "") {
	        	$("#altm"+item.lv2key).text(parseInt($("#altm"+item.lv2key).text())+item.altm);
        	}else {
        		$("#altm"+item.lv2key).text(item.altm);
        	}
        	
        	if($("#scr"+item.lv2key).text() != "") {
	        	$("#scr"+item.lv2key).text(parseInt($("#scr"+item.lv2key).text())+item.aplcntScr);        		
        	}else {
        		$("#scr"+item.lv2key).text(item.aplcntScr);
        	}
        	
        	totalAltm += item.altm;
        	totalScr += item.aplcntScr;
        }
		
		var altm = 0;
		var scr = 0;
        for(var i = 0; i < $("td[name='altm140100']").length; i++) {
			altm += parseInt($($("td[name='altm140100']")[i]).text()); 
			scr += parseInt($($("td[name='scr140100']")[i]).text());
        }
        
        $("#subTotAltm").html(altm);
        $("#subTotScr").html(scr);
        
        $("#totalAltm").html(totalAltm);
        $("#totalScr").html(totalScr);
        
        // 체크리스트 라디오버튼 클릭 이벤트
        // 체크리스트의 점수를 합산하여 결과페이지에 반환한다.
        $("[name^='cRdo']").on('click', function() {
            var rdoId = this.id;
            var lvCd = rdoId.substr(4,6)
            var tail = rdoId.split("_")[1];
			
            var yn = $("#"+rdoId).attr('chkYn');
            var altm = $("#"+rdoId).attr('altm');
            var scr = $("#"+rdoId).attr('scr');
            
            if(yn) {
	            if(scr == 0) {
		            $("#scr"+lvCd).text(parseInt($("#scr"+lvCd).text()) - parseInt(altm));            	
	            }else if(scr > 0){
		            $("#scr"+lvCd).text(parseInt($("#scr"+lvCd).text()) + parseInt(altm));            	
	            }            	
            }else {
            	if(scr == 0) {
		            $("#scr"+lvCd).text(parseInt($("#scr"+lvCd).text()) - 0);            	
	            }else if(scr > 0){
		            $("#scr"+lvCd).text(parseInt($("#scr"+lvCd).text()) + parseInt(altm));            	
	            }
            }
            
    		var subTotScr = 0;
    		var totalScr = 0;
            for(var i = 0; i < $("td[name='altm140100']").length; i++) { 
            	subTotScr += parseInt($($("td[name='scr140100']")[i]).text());
            }
            $("#subTotScr").html(subTotScr);
            
            for(var i = 0; i < $("td[name='altm140200']").length; i++) { 
            	subTotScr += parseInt($($("td[name='scr140200']")[i]).text());
            }
            $("#totalScr").html(subTotScr);
            
			
        });
        
        // 결과 등록
        function insertChkLst() {
       		var e = window.event
       		e.preventDefault();
       		
       		var btn = $("#insertBtn")
			var nFrom = btn.attr('data-from');
			var nAlign = btn.attr('data-align');
			var nIcons = btn.attr('data-icon');
			var nType = btn.attr('data-type');
			var nAnimIn = btn.attr('data-animation-in');
			var nAnimOut = btn.attr('data-animation-out');
			
			if($("#srngOpnn").val() == "") {
				var nMessage = "현장점검 결과를 입력해주십시오.";
				
				notify(nFrom, nAlign, nIcons, nType, nAnimIn, nAnimOut,nMessage);
				
				return false;
			}else if($("#chklstRsltCn").val() == "") {
				var nMessage = "최종 심사평을 입력해주십시오.";
				
				notify(nFrom, nAlign, nIcons, nType, nAnimIn, nAnimOut,nMessage);
				
				return false;
			}
			
			var obj = {};
			var chkLst = [];
			for(var i = 0; i < $("input:radio").length; i += 2) {
				var name = $($("input:radio")[i]).prop("name");
				obj = {
					  qitemid : $("input:radio[name='"+name+"']:checked").attr("qitemid")
					, seCd	  : $("input:radio[name='"+name+"']:checked").attr("seCd")
					, cn	  : $("input:radio[name='"+name+"']:checked").attr("cn")
					, scr	  : $("input:radio[name='"+name+"']:checked").attr("altm")
					, ordr	  : $("input:radio[name='"+name+"']:checked").attr("ordr")
				}
				chkLst.push(obj);
			}
			
			var chklstSeOrdrAns = []
			var ordr = 1;
			for(var i = 0; i < checkList.length; i++) {
				if(checkList[i].treeOrd == 2 && checkList[i].cnt != 0) {
					obj = {	
		                seCd	: checkList[i].lv2key
		                , ordr	: ordr
					}
					chklstSeOrdrAns.push(obj);
					ordr++
				}
			}
			
			var params = {
					  prgrmid			:	$("#prgrmid").val()
					, chklstid			:	$("#chklstid").val()					  
					, sbmsnid			:	$("#sbmsnid").val()
					, sbmsnSeCd			:	"242102"	//제출 구분 코드	
					, sbmsnSttsCd		:	"203102"	//제출 상태 코드
					, srngSttsCd		:	"114104"	//심사 상태 코드
					, chklstRsltCn		:   $("#chklstRsltCn").val()
					, srngOpnn			:	$("#srngOpnn").val()
					, totScr			:	$("#totalScr").text()
					, chkLst			:	chkLst
					, chklstSeOrdrAns	:	chklstSeOrdrAns
			};
            
			if(!confirm("저장하시겠습니까?")) return;
			
            if(displayWorkProgress()){
                $.ajax({
                    url : "/mng/mobileAsgsysSrng/insertSprtgrpSrng.do",
                    type : 'POST',
                    cache : false,
                    traditional : true, //필수
                    dataType : 'json',
                    contentType : "application/json; charset=utf-8",
                    data : JSON.stringify(params),
                    success : function (data){
                        if(data.result=="success"){
                            alert(data.msg);
                            closeWorkProgress();
                            location.href='/mng/mobileAsgsysSrng/asgsysSrngList.html';
                        }else{
                            alert(data.msg);
                        }

                    }
                });
            }
        }
        
        $(function(){
        	// 모바일 화면 뒤로가기 버튼
            $("#mobile-btn-back").html("<a class='btn-back' href='/mng/mobileAsgsysSrng/asgsysSrngList.html'><i class='fa fa-angle-left'></i></a>");
            
        	// 첫번째 탭 활성화
            $('#tabContent > .tab-pane:first-child').addClass('active');
         	// 첫번째 페이지 뒤로가기 버튼 비활성화
            $('#tabContent > .tab-pane:first-child .prevBtn').attr('disabled', true);
        })
    </script>
</div>
</body>
</html>