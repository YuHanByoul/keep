<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="layout/mng/mobileSubLayout"
>
<body>
<div layout:fragment="content">

    <div class="page-body">
        <ul class="nav nav-tabs tabs gray-tabs" role="tablist" id="tabTitle">
            <!-- 체크리스트 -->
            <li class="nav-item" th:each="title , a : ${checkList}" th:if="${title.treeOrd == 1}" th:tablv2key="${title.lv2key}">
                <a class="nav-link" data-bs-toggle="tab" href="#home1" role="tab" th:text="${title.cn}"></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#messages1" role="tab">결과 및 심사평</a>
            </li>
        </ul>

        <div class="tab-content tabs" id="tabContent">
            <!-- 체크리스트 -->
            <div class="tab-pane" role="tabpanel" th:each="title , a : ${checkList}" th:if="${title.treeOrd == 2}" th:panelv1key="${title.lv1key}" th:panelv2key="${title.lv2key}">
                <div class="card">
                    <div class="card-header p-b-0">
                        <h3 class="sub-title">
                            <div class="col"><strong th:text="${title.cn}"></strong></div>
                        </h3>
                    </div>
                    <div class="card-block">
                        <div class="row">
                            <div class="col-12 mb-3" th:each="row, b : ${checkList}" th:if="${row.treeOrd==3 and title.lv2key==row.lv2key}">
                                <div class="mb-0 form-group row">
                                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong th:id="${'cnY' + row.lv1key}" th:text="${row.cn} + ' ('+${row.altm} + '점)'"></strong></div>
                                    <div class="col-12">
                                        <div class="btn-group-sm">
                                            <input type="radio" class="btn-check" th:checked="${row.scr > 0 ? true:false}" th:data-ordr="${row.ordr}"
                                                   th:name="${'cRdoY' + row.lv2key + '_'+ row.qitemid}" th:id="${'cRdoY' + row.lv2key + '_'+  row.qitemid}"
                                                   th:altm="${row.altm}"
                                                   th:attr="altm=${row.altm}, lv1key=${row.lv1key} " value="Y" autocomplete="off">
                                            <label class="btn btn-disabled d-block" th:for="${'cRdoY' + row.lv2key + '_'+  row.qitemid}">예</label>
                                        </div>
                                        <div class="btn-group-sm mt-1">
                                            <input type="radio" class="btn-check" th:checked="${row.scr == 0 ? true:false}"
                                                   th:altm="${row.altm}"
                                                   th:name="${'cRdoN' + row.lv2key + '_'+  row.qitemid}" th:id="${'cRdoN' + row.lv2key + '_'+  row.qitemid}" th:attr="altm=${row.altm}" value="N" autocomplete="off">
                                            <label class="btn btn-disabled d-block" th:for="${'cRdoN' + row.lv2key + '_'+  row.qitemid}">아니오</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-block-small row justify-content-between">
                    <div class="col-auto">
                        <button class="btn btn-disabled prevBtn" th:btnlv1key="${title.lv1key}" th:btnlv2key="${title.lv2key}">이전</button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary notifications nextBtn" data-type="danger" data-from="bottom" data-align="center" data-message="점검하지 않은 문항이 있습니다." th:btnlv1key="${title.lv1key}" th:btnlv2key="${title.lv2key}">다음</button>
                    </div>
                </div>
            </div>
            <!-- [탭] 결과 및 심사평 -->
            <div class="tab-pane" id="messages1" role="tabpanel">
                <div class="card">
                    <div class="card-header p-b-0">
                        <h3 class="sub-title"><strong>점검 점수</strong></h3>
                    </div>
                    <div class="card-block">
                        <div class="col-12 table-responsive">
                            <table class="table table-framed table-bordered result_table">
                                <tbody class="result_body" th:each="title , a : ${checkList}" th:if="${title.treeOrd == 1 or title.treeOrd == 2}" th:resultlv1key="${title.lv1key}" th:resultlv2key="${title.lv2key}">
                                <tr class="border-bottom-inverse" style="border-top:1px solid #404E67;" th:if="${title.treeOrd == 1}">
                                    <th class="text-center table-active" colspan="3" th:text="${title.cn}"></th>
                                </tr>
                                <tr th:if="${a.first}">
                                    <th class="text-center table-light">항목</th>
                                    <th class="text-center table-light">배점</th>
                                    <th class="text-center table-light">획득</th>
                                </tr>
                                <tr th:if="${title.treeOrd == 2}" th:class="showTr">
                                    <td class="text-center v-middle" th:text="${title.cn}">프로그램 예산의 적절성</td>
                                    <td class="text-center v-middle" th:id="originSum+${title.lv2key}" th:attr="lv1key=${title.lv1key}">5</td>
                                    <td class="text-center v-middle text-c-blue" th:id="scrSum+${title.lv2key}" th:attr="lv1key=${title.lv1key}">5</td>
                                </tr>
                                <tr th:if="${a.last == true}" th:class="showTr" th:id="chkTitle+${title.lv2key}" th:attr="lv2key=${title.lv2key}">
                                    <th class="text-center table-light">소계</th>
                                    <th class="text-center table-light">30</th>
                                    <th class="text-center table-light text-c-blue">23</th>
                                </tr>
                                </tbody>
                                <tbody>
                                <tr>
                                    <th class="text-center table-light">총점</th>
                                    <th class="text-center table-light" id="originTotalSum">30</th>
                                    <th class="text-center table-light text-c-blue" id="chkTitelSum">23</th>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header p-b-0">
                        <h3 class="sub-title"><strong>현장점검 결과 및 최종 심사평</strong></h3>
                    </div>
                    <div class="card-block">
                        <div class="row form-group mb-3">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="srngOpnn"><strong>현장점검 결과</strong></label>
                            <div class="col-sm-12">
                                <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="위 지표 점수부여에 대한 평가 근거, 조정사유 및 추가의견을 기술하여 주십시오." id="srngOpnn" name="srngOpnn"></textarea>
                            </div>
                        </div>
                        <div class="row form-group mb-3">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="chklstRsltCn"><strong>최종 심사평</strong></label>
                            <div class="col-sm-12">
                                <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="현장점검 결과 총평을 적어주세요." id="chklstRsltCn" name="chklstRsltCn"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row justify-content-between">
                    <div class="col-auto">
                        <button class="btn btn-disabled">이전</button>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-primary notifications" data-type="danger" data-from="bottom" data-align="center" data-message="점검 결과를 입력해주세요"
                                onclick="fn_insertCheckList()" id="srngBtnSave">심사완료</button>
                    </div>
                </div>
            </div>
            <!-- // [탭] 결과 및 심사평 -->
        </div>

        <input type="hidden" id="prgrmid"      name="prgrmid"       th:value="${mobileAsgsysSrngInfo.prgrmid}"><!-- 프로그램id -->
        <input type="hidden" id="splmntDmndid" name="splmntDmndid"  th:value="${mobileAsgsysSrngInfo.splmntDmndid}"><!-- 보완요청id -->
        <input type="hidden" id="chklstid"     name="chklstid"      th:value="${mobileAsgsysSrngInfo.chklstid}"><!-- 체크리스트 id -->
        <input type="hidden" id="sbmsnid"      name="sbmsnid"       th:value="${mobileAsgsysSrngInfo.sbmsnid}"><!-- 체크리스트 제출 id -->
        <input type="hidden" id="sbmsnSttsCd"  name="sbmsnSttsCd"   th:value="${mobileAsgsysSrngInfo.sbmsnSttsCd}"><!-- 제출상태코드 -->
        <input type="hidden" id="scr"          name="scr"           th:value="${mobileAsgsysSrngInfo.scr}"><!-- 점수 -->
        <input type="hidden" id="sprtgrpid"    name="sprtgrpid"     th:value="${mobileAsgsysSrngInfo.sprtgrpid}"><!-- 지원단id -->
        <input type="hidden" id="rsltid"       name="rsltid"        th:value="${mobileAsgsysSrngInfo.rsltid}"><!-- 결과id -->
        <input type="hidden" id="formid"       name="formid"        th:value="${mobileAsgsysSrngInfo.formid}"><!-- 심사양식id -->

    </div>
    <style type="text/css">
        .showTr{display:table-row;}
        .hiddenTr{display:none;}
    </style>
    <script th:inline="javascript">
        let panelv1key = {};
        let panelv2key = {};

        $(function(){
            $('#tabTitle > li:first-child').addClass('active');
            $('#tabTitle > li:first-child .nav-link').addClass('active');

            $('#tabContent > .tab-pane:first-child').addClass('active');
            $('#tabContent > .tab-pane:first-child .prevBtn').attr('disabled', true);


            for( var i=0; i<$('.tab-pane').length; i++ ){
                let panekey = $($('.tab-pane')[i]).attr('panelv1key');
                if( panekey == undefined ) continue; /* 마지막 점검결과 패널 */

                let panekey2 = $($('.tab-pane')[i]).attr('panelv2key');

                let keys = Object.keys(panelv1key);

                if( keys.length > 0 ){
                    for( var j=0; j<keys.length; j++ ){
                        if( keys[j] == panekey ){
                            panelv1key[panekey] = parseInt(panelv1key[panekey])+1;
                        }else{
                            if( panelv1key[panekey] == undefined ){
                                panelv1key[panekey] = 1;
                            }
                        }
                    }
                }else{
                    panelv1key[panekey] = 1;
                }

                let keys2 = Object.keys(panelv2key);

                if( keys2.length > 0 ){
                    for( var z=0; z<keys2.length; z++ ){
                        if( keys2[z] == panekey2 ){
                            panelv2key[panekey2] = 0;
                        }else{
                            if( panelv2key[panekey2] == undefined ){
                                panelv2key[panekey2] = 0;
                            }
                        }
                    }
                }else{
                    panelv2key[panekey2] = 0;
                }

            }

            for( var i=0; i<$('.result_table tbody.result_body').length; i++ ){
                let panekey = $($('.result_table tbody.result_body')[i]).attr('resultlv1key');
                let panekey2 = $($('.result_table tbody.result_body')[i]).attr('resultlv2key');
                if( panekey == 0 ){
                    if( i == 0 ) continue;
                    panekey = $($('.result_table tbody.result_body')[i-1]).attr('resultlv1key')
                    panekey2 = $($('.result_table tbody.result_body')[i-1]).attr('resultlv2key')
                    var str = '<tbody id="scr_'+panekey+'">' +
    '                               <tr>\n' +
    '                                    <th class="text-center table-light">소계</th>\n' +
    '                                    <th class="text-center table-light" lv2key="'+panekey+'" id="originTotal'+panekey+'">0</th>\n' +
    '                                    <th class="text-center table-light text-c-blue" lv2key="'+panekey+'" id="chkTitle'+panekey+'">0</th>\n' +
    '                                </tr>'+
                                '</tbody>';

                    $($('.result_table tbody.result_body')[i]).before(str);
                }
            }

            // $('.tab-pane').attr('panelv1key')
        })

        //체크리스트 라디오 클릭
        $("[name^='cRdo']").on('click', function() {

            //라디오 id,name = cRdo+ lv2Cd + qitemid

            var rdoId = this.id;
            var lvCd = rdoId.substr(5,6)
            var tail = rdoId.split("_")[1];

            var opponentRdoId = rdoId.substr(4, 1) == "N" ? "cRdoY"+lvCd+"_"+tail: "cRdoN"+lvCd+"_"+tail;
            $("#"+rdoId).prop("checked",true);
            $("#"+opponentRdoId).prop("checked",false);

            var scr = $("#"+rdoId).attr('altm');
            //$("[id^='scrSum']")

            initScrSum(scr, lvCd, rdoId.substr(4, 1));

        });

        /* 문항 넘어가기 전 다 체크했는지 확인 */
        function radioValidCheck(){
            if( parseInt($('.tab-pane.active input[type=radio]').length) / 2 == $('.tab-pane.active input[type=radio]:checked').length ){
                return true;
            }else{
                return true;
                /* 테스트하느라 잠시 return true */
                // return false;
            }
        }

        /* 점수 더하기 */
        /*function scrSum(){
            var panekey = Object.keys(panelv2key);
            var inputRadio = $("[name^='cRdo']");
            for( var i=0; i<panekey.length; i++ ){
                for( var j=0; j<inputRadio.length; j++ ){
                    if( inputRadio[j] )
                }
            }
        }*/

        /* 다음 버튼 */
        $('button.nextBtn').on('click', function(){
            if( !radioValidCheck() ) {
                alert('선택하지 않은 문항이 존재합니다.');
            }else{
                let lv1key = $(this).attr('btnlv1key');
                let resultStatus = false;

                let keys = Object.keys(panelv1key);

                if( panelv1key[lv1key] > 1 ){
                    panelv1key[lv1key] = panelv1key[lv1key]-1;
                    $('.tab-pane.active').next().addClass('active');
                    $($('.tab-pane.active')[0]).removeClass('active');
                }else if( panelv1key[lv1key] == 1 ){
                    $('.tab-pane.active').next().addClass('active');
                    $($('.tab-pane.active')[0]).removeClass('active');
                    $('.nav-item.active').next().addClass('active');
                    $($('.nav-item.active')[0]).find('.nav-link').removeClass('active');
                    $($('.nav-item.active')[0]).removeClass('active');
                    $('.nav-item.active .nav-link').addClass('active');
                }

                for( var i=0; i<keys.length; i++ ){
                    if( panelv1key[keys[i]] == 1 ){
                        resultStatus = true;
                    }else{
                        resultStatus = false;
                    }
                }
                console.log(resultStatus);
                if( resultStatus ){

                }
            }
        });

        /* 이전 버튼 */
        $('button.prevBtn').on('click', function(){
            let lv1key = $(this).attr('btnlv1key');
            let lv2key = $(this).attr('btnlv2key');

            let keys = Object.keys(panelv1key);

            if( panelv1key[lv1key] < 3 ){
                panelv1key[lv1key] = panelv1key[lv1key]+1;
                $('.tab-pane.active').prev().addClass('active');
                $($('.tab-pane.active')[1]).removeClass('active');
            }else if( panelv1key[lv1key] == 3 ){
                $('.tab-pane.active').prev().addClass('active');
                $($('.tab-pane.active')[1]).removeClass('active');
                $('.nav-item.active').prev().addClass('active');
                $($('.nav-item.active')[1]).find('.nav-link').removeClass('active');
                $($('.nav-item.active')[1]).removeClass('active');
                $('.nav-item.active .nav-link').addClass('active');
            }
        });

        function initScrSum(scr, lvCd, type){
            if( type == 'Y' ){

            }
            console.log('asdf');

            var allScr = $("[id^='scrSum']");
            var originSum = $("[id^='originSum']");
            var totalscore = 0;
            var originTotalscore = 0;

            for (var i=0; i< allScr.length;i++ ){

                var scrId = allScr[i].id;
                var scrId2 = $(allScr[i]).attr('lv1key');
                var originId = originSum[i].id;
                var lvCd  = scrId.substr(6,6);

                var rdoGrp = $("[name^='cRdoY"+lvCd+"']");
                var sumScr = 0;
                var originScr = 0;

                for(var k=0; k< rdoGrp.length; k++){
                    var rdoId = rdoGrp[k].id

                    originScr += Number($("#"+rdoId).attr('altm'));

                    if($("#"+rdoId).prop("checked") && false == isNaN( $("#"+rdoId).attr("altm")) ) {
                        sumScr = Number(sumScr)+ Number($("#"+rdoId).attr("altm"));
                    }
                }

                $("#scrSum"+lvCd).text(sumScr);
                $("#originSum"+lvCd).text(originScr);
                originTotalscore = Number(originTotalscore) + Number(originScr);
                totalscore = Number(totalscore) + Number(sumScr);
                $('#originTotal'+scrId2).text(originTotalscore);
            }

            $("#chkTitelSum").text(totalscore);
            $("#originTotalSum").text(originTotalscore);

            //title sum
            $("[id^=chkTitle]").each(
                function(index1, item1){

                    var lv1key = item1.getAttribute("lv1key");
                    var lvkey = item1.getAttribute("lv2key");
                    var vAltm = 0;
                    var vScr = 0;
                    var vHtml = "";

                    $("[id^='cRdoY'][lv1key="+lvkey+"]").each(
                        function(index2, item2){

                            vAltm = vAltm + Number(item2.getAttribute("altm"));
                        });
                    $("[id^='scrSum'][lv1key="+lvkey+"]").each(
                        function(index3, item3){

                            vScr = vScr + Number(item3.innerText);
                        });


                    $("#"+item1.id).text(vScr)

                });

        }

        function fn_insertCheckList(){

            if( $("#srngOpnn").val() == '' || $("#chklstRsltCn").val() == '' ){
                alert('점검 결과를 입력해주세요');
                return;
            }

            var param = {};

            // if(!($("#sprtgrpSrngFrm").valid())) return;

            $("[id^=cRdoY]").each(function(index, item) {

                param["ansLst[" + index + "].sbmsnid"] = $("#sbmsnid").val();

                param["ansLst[" + index + "].seCd"] = $(item).attr("id").split("_")[0].replace("cRdoY","");
                param["ansLst[" + index + "].qitemid"] = $(item).attr("id").split("_")[1];
                //param["ansLst[" + index + "].cn"] = $(item).attr("id").split("_")[0].replace("cRdoY","");
                //param["ansLst[" + index + "].idntyMttr"] = $(item).attr("id").split("_")[1].replace("cRdoY","");

                param["ansLst[" + index + "].scr"] = $(item).prop("checked") ? $(item).attr("altm"): 0
                param["ansLst[" + index + "].ordr"] = $(item).attr("data-ordr");

            });

            $("[id^=cnY]").each(function(index, item) {
                param["ansLst[" + index + "].cn"] = item.innerText;
            });

            param["prgrmid"     ]= $('#prgrmid').val();
            param["sbmsnid"     ]= $("#sbmsnid").val();
            param["rsltid"      ]= $("#rsltid").val();
            param["sbmsnSttsCd" ]= "128102";    //제출
            param["sprtgrpid"   ]= $("#sprtgrpid").val();
            param["srngOpnn"    ]= $("#srngOpnn").val();
            param["chklstRsltCn"]= $("#chklstRsltCn").val();
            param["scr"         ]= $("#scr").val();

            if(!confirm("저장하시겠습니까?")) return;

            if(displayWorkProgress()){
                $.ajax({
                    url      : "/mng/mobileAsgsysSrng/insertSprtgrpSrng.do",
                    type     : 'POST',
                    cache    : false,
                    dataType : 'json',
                    data     : param,
                    success  : function (data){
                        if(data.result=="success"){

                            alert(data.msg);
                            closeWorkProgress();
                            location.href='/mng/mobileAsgsysSrng/asgsysSrngList.html';

                        }else{
                            alert(data.msg);
                        }

                    }
                });
            }
        }
    </script>
</div>
</body>
</html>