<div class="card">
    <div class="card-header p-b-0">
        <h3 class="sub-title"><strong>기본 정보</strong></h3>
    </div>

    <form method="post" id="registerForm" name="registerForm" onsubmit="return false;">

        <div class="card-block-small p-t-0">
            <div class="row">
                <div class="col-lg-6 mb-3">
                    <div class="mb-0 form-group required">
                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>분류</strong></div>
                        <div class="border-checkbox-section">
                            <span kattr:check_code="clsfCds" grpCd="227" th:attr="selectedCd=${bsnsOperDta.clsfCd}" isAdmin="true"/>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="yy"><strong>발간년도</strong></label>
                        <div class="col-12">
                            <input type="number" class="form-control form-control-sm" name="yy" id="yy" th:value="${bsnsOperDta.yy}"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="instNm"><strong>운영기관</strong></label>
                        <div class="row">
                            <div class="col">
                                <input type="text" class="form-control form-control-sm" name="instNm" id="instNm" readonly th:value="${bsnsOperDta.instNm}"/>
                            </div>
                            <div class="col-auto p-l-0">
                                <button type="button" class="btn btn-inverse btn-sm" onclick="openInstSearchPopup()">
                                    기관검색
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-3">
                    <div class="mb-0 form-group required">
                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>저작권</strong></div>
                        <span kattr:select_code="cpyrhtCd" grpCd="241" firstOptTxt="- 선택 -" th:attr="selectedCd=${bsnsOperDta.cpyrhtCd}" isAdmin="true"></span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="pdfFile"><strong>PDF 파일</strong></label>
                        <div class="col-12">
                            <input type="file" name="pdfFile" id="pdfFile" multiple accept="application/pdf" class="form-control form-control-sm"/>
                        </div>
                        <div class="mt-2 row">
                            <div class="col-auto">
                                <div id="pdfFileUploadError"></div>
                                <div id="pdfFileUploadSuccess">
                                    <th:block th:if="${bsnsOperDta.pdfFileList}">
                                        <th:block th:each="file : ${bsnsOperDta.pdfFileList}" th:id="${file.fileid}">
                                            <span class='label label-inverse' th:id="${file.fileid}">[[${file.orginlFileNm}]]
                                                <a class='text-white' href="javascript:void(0)"
                                                   th:name="${file.fileid}" th:attr="data-idntfc-key=${file.fileIdntfcKey}"
                                                   th:onclick="deleteFile(this.name, this.dataset.idntfcKey)">X
                                                </a>
                                            </span>
                                        </th:block>
                                    </th:block>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="pdfFilegrpid" name="pdfFilegrpid" th:value="${bsnsOperDta.pdfFilegrpid == null ? 0 : bsnsOperDta.pdfFilegrpid }"/>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="ttl"><strong>제목</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" name="ttl" id="ttl" th:value="${bsnsOperDta.ttl}">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="cn"><strong>내용</strong></label>
                        <div class="col-12">
                            <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="Default textarea" id="cn" name="cn">
                                <th:block th:text="${bsnsOperDta.cn}"></th:block>
                            </textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="atchFile"><strong>첨부파일</strong></label>
                        <div class="col-12">
                            <input type="file" name="atchFile" id="atchFile" multiple accept="*/*" class="form-control form-control-sm"/>
                        </div>
                        <div class="mt-2 row">
                            <div class="col-auto">
                                <div id="atchFileUploadError"></div>
                                <div id="atchFileUploadSuccess">
                                    <th:block th:if="${bsnsOperDta.atchFileList}">
                                        <th:block th:each="file : ${bsnsOperDta.atchFileList}" th:id="${file.fileid}">
                                            <span class='label label-inverse' th:id="${file.fileid}"> [[${file.orginlFileNm}]]
                                                <a class='text-white' href="javascript:void(0)"
                                                   th:name="${file.fileid}" th:attr="data-idntfc-key=${file.fileIdntfcKey}"
                                                   th:onclick="deleteFile(this.name, this.dataset.idntfcKey)">X
                                                </a>
                                            </span>
                                        </th:block>
                                    </th:block>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="atchFilegrpid" name="atchFilegrpid" th:value="${bsnsOperDta.atchFilegrpid == null ? 0 : bsnsOperDta.atchFilegrpid }"/>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="regD"><strong>등록일</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" name="regD" id="regD" readonly
                                   th:value="${bsnsOperDta.regDt != null? #dates.format(bsnsOperDta.regDt,'yyyy-MM-dd') : #dates.format(#dates.createNow(), 'yyyy-MM-dd')}"/>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="rgtrNm"><strong>작성자ID(이름)</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" name="rgtrNm" id="rgtrNm" readonly
                                   th:value="${bsnsOperDta.rgtrNm != null
                                   ? bsnsOperDta.rgtrAcnt + '(' + bsnsOperDta.rgtrNm + ')'
                                   : bsnsOperDta.user.acnt + '(' + bsnsOperDta.user.nm + ')'}"/>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>최종수정일</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" readonly
                                   th:value="${bsnsOperDta.mdfcnDt != null ? #dates.format(bsnsOperDta.mdfcnDt,'yyyy-MM-dd') : ''}"/>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6 mb-3">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>삭제여부</strong></label>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" readonly th:value="${bsnsOperDta.delYn}"/>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="card-block-small">
            <th:block sec:authorize-url="/mng/bsnsOperDta/deleteBsnsOperDta.do">
                <button th:if="${bsnsOperDta.dtaid != null and bsnsOperDta.delYn == 'N' }" type='button' class="btn btn-inverse" th:dtaid="${bsnsOperDta.dtaid}" th:onclick="|deleteBsnsOperDta(this.getAttribute('dtaid'))|">삭제</button>
            </th:block>
            <button type='button' class="btn btn-disabled m-r-5" onclick="bsnsOperDtaGridHelper.removeHighlight();bsnsOperDtaGridHelper.toggleContent()">취소</button>
            <th:block sec:authorize-url="/mng/bsnsOperDta/insertBsnsOperDta.do">
                <button type='button' class="btn btn-primary" onclick="showPopup()">저장</button>
            </th:block>

        </div>

        <input type="hidden" name="instid" id="instid" th:value="${bsnsOperDta.instid != null ? bsnsOperDta.instid : ''}"/>
        <input type="hidden" name="rgtrid" id="rgtrid" th:value="${bsnsOperDta.rgtrid != null ? bsnsOperDta.rgtrid : ''}"/>
        <input type="hidden" name="dtaid" id="dtaid" th:value="${bsnsOperDta.dtaid != null ? bsnsOperDta.dtaid : ''}"/>
    </form>

    <div class="modal fade" id="cmmCntntsQlityPopup" aria-hidden="true" data-bs-backdrop="static">


    <script th:inline="javascript">
        var bsnsOperDta = /*[[${bsnsOperDta}]]*/null;
        var editor = CKEDITOR.replace('cn', {enterMode: CKEDITOR.ENTER_BR});
        var cmmCntntsQlityModal;
        var cntntsQlityFormData;

        var deleteBsnsOperDta = (dtaid) => {
            var deleteDtaids = dtaid;

            if (confirm('해당 게시물을 삭제하시겠습니까?')) {
                if (displayWorkProgress()) {
                    $.ajax({
                        method: 'post',
                        url: '/mng/bsnsOperDta/deleteBsnsOperDta.do',
                        dataType: 'json',
                        data: {deleteDtaids: deleteDtaids},
                        success: function (response) {
                            alert(response.msg);
                            closeWorkProgress();
                            if (response.result == "success") {
                                bsnsOperDtaGridHelper.resetPageContent();
                            }
                        }
                    });
                }
            }
        }

        var showPopup = () => {

            if ($('input[name=clsfCds]:checked').length == 0) {
                alert('분류를 선택해 주십시오.');
                return;
            }

            var editorData = editor.getData();
            $("#cn").val(editorData);

            if (!$('#registerForm').valid()) {
                return;
            }

            var trgtCd = '246003';
            var evntCd = $('#dtaid').val() == '' ? '247001' : '247002';
            var cntntsid = $('#dtaid').val() == '' ? '0' : $('#dtaid').val();
            var functionName = 'insertBsnsOperDta';
            var cmmCntntsQlityPopupUrl = "/mng/cmmCntnts/cmmCntntsQlityPopup.html?trgtCd=" + trgtCd + "&evntCd="+ evntCd+ "&functionName="+functionName + "&cntntsid="+ cntntsid;

            $("#cmmCntntsQlityPopup").load(cmmCntntsQlityPopupUrl, function(response, status, xhr) {
                if (status == "success") {
                    cmmCntntsQlityModal = new bootstrap.Modal($('#cmmCntntsQlityPopup'));
                    cmmCntntsQlityModal.show();
                }
            });
        }

        var insertBsnsOperDta = () => {
            var url = '/mng/bsnsOperDta/insertBsnsOperDta.do';

            if (!!$('#dtaid').val()) {
                url = '/mng/bsnsOperDta/updateBsnsOperDta.do';
            }

            if (url == '/mng/bsnsOperDta/insertBsnsOperDta.do') {
                var isSec = false;
                /*[# sec:authorize-url="/mng/bsnsOperDta/insertBsnsOperDta.do"]*/
                isSec = true;
                /*[/]*/
                if (!isSec) {
                    alert('접근권한이 없습니다.');
                    return;
                }
            } else if (url == '/mng/bsnsOperDta/updateBsnsOperDta.do') {
                var isSec = false;
                /*[# sec:authorize-url="/mng/bsnsOperDta/updateBsnsOperDta.do"]*/
                isSec = true;
                /*[/]*/
                if (!isSec) {
                    alert('접근권한이 없습니다.');
                    return;
                }
            }

            var formData = $('#registerForm').serializeArray();
            formData = formData.concat(cntntsQlityFormData);

            if (displayWorkProgress()) {
                $.ajax({
                    method: 'post',
                    url: url,
                    dataType: 'json',
                    data: formData,
                    success: function (response) {
                        alert(response.msg);
                        closeWorkProgress();
                        if (response.result == "success") {
                            if(url == '/mng/bsnsOperDta/insertBsnsOperDta.do') {
                                bsnsOperDtaGridHelper.resetListContent();
                            } else {
                                bsnsOperDtaGridHelper.resetPageContent();
                            }
                        }
                    }
                });
            }
        }

        $(function () {
            pdfFileEvent();
            atchFileEvent();
            validateForm();
        })

        var validateForm = () => {
            $('#registerForm').validate({
                ignore: [],
                rules: {
                    ttl: {required: true, maxlength: 100},
                    instNm: {required: true},
                    cpyrhtCd: {required: true}
                },
                messages: {
                    ttl: {required: '제목을 입력해 주십시오.', maxlength: '제목은 100자를 넘을 수 없습니다.'},
                    instNm: {required: '기관을 선택해 주십시오.'},
                    cpyrhtCd: {required: '저작권 종류를 선택해 주십시오.'}
                }
            });
        }

        var pdfFileEvent = () => {
            $('#pdfFile').on("change", function (event) {

                var objFile = document.querySelector('#pdfFile');
                var formData = new FormData();
                var content = "";

                for (i = 0; i < objFile.files.length; i++) {
                    formData.append("files", objFile.files[i]);
                }

                formData.append("filegrpid", $("#pdfFilegrpid").val());
                formData.append("filegrpNm", "pdf_view_file");

                if (displayWorkProgress()) {
                    $.ajax({
                        url: '/uploadMultipleFiles.do',
                        processData: false,
                        contentType: false,
                        data: formData,
                        type: 'POST',
                        success: function (response) {
                            if (response.result == 'fail') {
                                alert(response.msg);
                            } else {
                                if ($("#pdfFilegrpid").val() == '0' || $("#pdfFilegrpid").val() == '' || $("#pdfFilegrpid").val() == null) {
                                    $("#pdfFilegrpid").val(response[0].filegrpid);
                                }
                                for (i = 0; i < response.length; i++) {
                                    content = "<span class ='label label-inverse' id='" + response[i].fileid + "'>" + response[i].orginlFileNm;
                                    content += "<a class='text-white' href=javascript:deleteFile('" + response[i].fileid + "','" + response[i].fileIdntfcKey + "')>X</a></span>";
                                    $('#pdfFileUploadSuccess').append(content);
                                }
                            }
                            closeWorkProgress();
                        }
                    })

                    if (detectBrowser() == "other") {
                        $("#pdfFile").val("");
                    } else {
                        $("#pdfFile").replaceWith($("#pdfFile").clone(true))
                    }
                }
            });
        }

        var atchFileEvent = () => {
            $('#atchFile').on("change", function (event) {

                var objFile = document.querySelector('#atchFile');
                var formData = new FormData();
                var content = "";

                for (i = 0; i < objFile.files.length; i++) {
                    formData.append("files", objFile.files[i]);
                }

                formData.append("filegrpid", $("#atchFilegrpid").val());
                formData.append("filegrpNm", "bsnsOperDta_file");

                if (displayWorkProgress()) {
                    $.ajax({
                        url: '/uploadMultipleFiles.do',
                        processData: false,
                        contentType: false,
                        data: formData,
                        type: 'POST',
                        success: function (response) {
                            if (response.result == 'fail') {
                                alert(response.msg);
                            } else {
                                if ($("#atchFilegrpid").val() == '0' || $("#atchFilegrpid").val() == '' || $("#atchFilegrpid").val() == null) {
                                    $("#atchFilegrpid").val(response[0].filegrpid);
                                }
                                for (i = 0; i < response.length; i++) {
                                    content = "<span class ='label label-inverse' id='" + response[i].fileid + "'>" + response[i].orginlFileNm;
                                    content += "<a class='text-white' href=javascript:deleteFile('" + response[i].fileid + "','" + response[i].fileIdntfcKey + "')>X</a></span>";
                                    $('#atchFileUploadSuccess').append(content);
                                }
                            }
                            closeWorkProgress();
                        }
                    })

                    if (detectBrowser() == "other") {
                        $("#atchFile").val("");
                    } else {
                        $("#atchFile").replaceWith($("#atchFile").clone(true))
                    }
                }
            });
        }

        var openInstSearchPopup = () => {
            var url = "/mng/bsnsOperDta/instSearchPopup.html";
            $("#instSearchPopup").load(url, function (response, status, xhr) {
                if (status == "success") {
                    instSearchPopup = new bootstrap.Modal($('#instSearchPopup'));
                    instSearchPopup.show();
                }
            });
        }

    </script>
</div>
