<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<form id="cntstForm">
    <input type="hidden" name="cntstid" th:value="${cntstInfo.cntstid}"/>
    <div class="card">
        <!-- 기본정보 -->
        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>기본정보</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="row">
                <div class="col-lg-6 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="clsfCd">분류</label>
                        <div class="col-sm-12">

                        <th:block th:if="${cntstInfo.cntstid==null}">
                             <span
                                     kattr:select_code="clsfCd"
                                     th:attr="selectedCd=${cntstInfo.clsfCd}"
                                     grpCd="165"
                                     firstOptTxt="- 선택 -"
                                     addClass="form-select form-select-sm form-control-sm"
                                     isAdmin="true"
                             ></span>
                        </th:block>
                        <th:block th:if="${cntstInfo.cntstid!=null}">
                            <input type="text" class="form-control form-control-sm" readonly th:value="${cntstClsfCdMap[cntstInfo.clsfCd]}">
                            <input type="hidden" id="clsfCd" th:value="${cntstInfo.clsfCd}">
                        </th:block>

                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-3">
                    <div class="mb-0 form-group required">
                        <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>중복참여</strong></div>
                        <div class="mt-1">
                            <div class="form-radio">
                                <div class="radio radio-inline">
                                    <label class="mb-0 form-label">
                                        <input type="radio" name="dpcnPsbltyYn" value="Y" th:checked="${cntstInfo.dpcnPsbltyYn == 'Y'}">
                                        <i class="helper"></i>가능
                                    </label>
                                </div>
                                <div class="radio radio-inline">
                                    <label class="mb-0 form-label">
                                        <input type="radio" name="dpcnPsbltyYn" value="N" th:checked="${cntstInfo.dpcnPsbltyYn == 'N'}">
                                        <i class="helper"></i>불가능
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-4 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="date_01"><strong>접수시작일시 설정</strong></label>
                        <div class="col-sm-12">
                            <input type="datetime-local" class="form-control form-control-sm" id="date_01" name="aplyBgngDt" th:value="${cntstInfo.aplyBgngDt}"/>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="date_02"><strong>접수종료일시 설정</strong></label>
                        <div class="col-sm-12">
                            <input type="datetime-local" class="form-control form-control-sm" id="date_02" name="aplyEndDt" th:value="${cntstInfo.aplyEndDt}"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-4 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="date_03"><strong>당첨자발표 / 마감일시 설정</strong></label>
                        <div class="col-sm-12">
                            <input type="datetime-local" class="form-control form-control-sm" id="date_03"  name="prsntnDt" th:value="${cntstInfo.prsntnDt}"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row form-group required mb-3">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="ttl"><strong>제목</strong></label>
                <div class="col-sm-12">
                    <input type="text" class="form-control form-control-sm" name="ttl"  th:value="${cntstInfo.ttl}" id="ttl" placeholder="제목을 입력해 주세요."/>
                </div>
            </div>
            <div class="row form-group mb-3">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="cn"><strong>내용</strong></label>
                <div class="col-sm-12">
                    <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="내용을 입력해 주세요." id="cn" name="cn" th:text="${cntstInfo.cn}"></textarea>
                </div>
            </div>
            <div class="row form-group mb-3 required">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>썸네일 이미지</strong></label>
                <p class="text-warning m-b-0">* 10MB 미만의 JPG, PNG, GIF파일만 업로드 가능(권장사이즈 : 가로 296px, 세로 197px)</p>
                <div class="col-12">
                   <input type="file" id="cntstThmbnFile" name="cntstThmbnFile" class="form-control form-control-sm"/>
                </div>
                <div class="mt-2 row">
                    <div class="col-auto">
                        <input type="hidden" id="thmbnFilegrpid" name="thmbnFilegrpid" value="0"/>
                        <input type="hidden" id="thmbnFileid" name="thmbnFileid" th:value="${cntstInfo.thmbnFileid}"/>
                        <!-- 파일 명 및 삭제 버튼 영역-->
                        <span id="thmbnFileArea">
                            <th:block th:if ="${thmbnFile !=null}">
                                <span th:id="'thmbnFile' + ${thmbnFile.fileid}" class="label label-inverse">
                                    <th:block th:text = "${thmbnFile.orginlFileNm}"></th:block>&nbsp;&nbsp;&nbsp;
                                    <a href="javascript:void(0);" onclick="deleteFile(this.getAttribute('spanid'), this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'));" th:spanid="'thmbnFile' + ${thmbnFile.fileid}" th:fileid="${thmbnFile.fileid}" th:fileIdntfcKey="${thmbnFile.fileIdntfcKey}" class="text-white">X</a>
                                </span>
                            </th:block>
                        </span>
                    </div>
                </div>
            </div>
            <div class="row form-group mb-3">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>첨부파일</strong></label>
                <div class="col-sm-12">
                    <input type="file" multiple id="cntstAtchFile" name="cntstAtchFile" class="form-control form-control-sm"/>
                </div>
                <div class="mt-2 row">
                    <div class="col-auto">
                        <th:block th:if = "${cntstInfo.atchFilegrpid} != null ">
                            <input type="hidden" id="atchFilegrpid" name="atchFilegrpid" th:value="${cntstInfo.atchFilegrpid}"/>
                            <input type="hidden" id="atchFileid" name="atchFileid" />
                        </th:block>
                        <th:block th:unless = "${cntstInfo.atchFilegrpid} != null ">
                            <input type="hidden" id="atchFilegrpid" name="atchFilegrpid" th:value="0"/>
                            <input type="hidden" id="atchFileid" name="atchFileid" />
                        </th:block>
                        <!-- 파일 명 및 삭제 버튼 영역-->
                        <span id="atchFileArea">
                            <th:block th:if = "${atchFileList} != null ">
                                <th:block th:if = "${atchFileList} != null ">
                                    <span th:each="item: ${atchFileList}" th:id="'atchFile' + ${item.fileid}" class="label label-inverse">
                                        <th:block th:text = "${item.orginlFileNm}"></th:block>&nbsp;&nbsp;&nbsp;
                                        <a href="javascript:void(0);" onclick="deleteFile(this.getAttribute('spanid'), this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'));" th:spanid="'atchFile' + ${item.fileid}" th:fileid="${item.fileid}" th:fileIdntfcKey="${item.fileIdntfcKey}" class="text-white">X</a>
                                    </span>
                                </th:block>
                            </th:block>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <!-- 접수 정보 -->
        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>접수 정보</strong></h3>
        </div>
        <div class="card-block-small p-t-0" id="cntstRcptInfoArea">
            <div class="row form-group required mb-3">
                <div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
                    <strong class="not-diary-cntst">공모분야</strong>
                    <strong class="is-diary-cntst">신청대상</strong>
                </div>
                <div class="col-12">
                    <div class="border-checkbox-section bg-form">
                        <span kattr:check_code="cntstFldCdArr"
                              grpCd="166"
                              th:attr="selectedCd=${#strings.listJoin(cntstFldCdList,',')}"
                              isAdmin="true">
                        </span>
                    </div>
                </div>
            </div>
            <div class="row form-group mb-3 not-diary-cntst">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="gdnc"><strong>업로드 안내</strong></label>
                <div class="col-sm-12">
                    <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="내용을 입력해 주세요." id="gdnc" name="gdnc" th:text="${cntstInfo.gdnc}"></textarea>
                </div>
            </div>
            <div class="row form-group mb-3 not-diary-cntst">
                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="trms"><strong>참가서약 약관</strong></label>
                <div class="col-sm-12">
                    <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="내용을 입력해 주세요." id="trms" name="trms" th:text="${cntstInfo.trms}"></textarea>
                </div>
            </div>
        </div>
        <!-- 버튼영역 -->
        <div class="card-block-small">
            <button type="button" class="btn btn-disabled m-r-5" onclick="gridHelper1.toggleContent();">취소</button>
            <button type="submit" class="btn btn-primary">저장</button>
        </div>
        <!-- // -->
    </div>
</form>


<script th:inline="javascript">
    $(function () {
        const $form = $("#cntstForm");
        const $cn = $form.find('[name=cn]');
        const $gdnc = $form.find('[name=gdnc]');
        const $trms = $form.find('[name=trms]');
        const $cntstRcptInfoArea = $("#cntstRcptInfoArea");
        const $cntstRcptInfoAreaIsDiary = $cntstRcptInfoArea.find(".is-diary-cntst");
        const $cntstRcptInfoAreaNotDiary = $cntstRcptInfoArea.find(".not-diary-cntst");
        const $clsfCd = $("#clsfCd");
        const isUpdate = !!$form.find("[name=cntstid]").val();
        const editor = CKEDITOR.replace($cn[0]);
        const editor_gdnc = CKEDITOR.replace($gdnc[0]);
        const editor_trms = CKEDITOR.replace($trms[0]);

        $form.validate({
            ignore: '',
            rules: {
                ...(!isUpdate ? {clsfCd: 'required'}: {} ),
                dpcnPsbltyYn: 'required',
                aplyBgngDt: 'required',
                aplyEndDt: 'required',
                prsntnDt: 'required',
                ttl: {required: true, maxlength: 200},
                thmbnFileid: 'required',
                cntstFldCdArr: {
                    required: {depends: () => $clsfCd.val() === '165105'},
                    required2: {depends: () => $clsfCd.val() !== '165105'},
                },
            },
            messages: {
                clsfCd: '분류를 선택해 주십시오.',
                dpcnPsbltyYn: '중복참여여부를 선택해 주십시오.',
                aplyBgngDt: '접수시작일시를 설정해 주십시오.',
                aplyEndDt: '접수종료일시를 설정해 주십시오.',
                prsntnDt: '당첨자발표일시를 설정해 주십시오.',
                ttl: {required: "제목을 입력해 주십시오.", maxlength: "게시판 제목은 200자를 넘을 수 없습니다."},
                thmbnFileid: '썸네일 파일을 첨부해 주십시오.',
                cntstFldCdArr: {
                    required: '신청대상을 선택해 주십시오.',
                    required2: '공모분야를 선택해 주십시오.',
                },
            },
            submitHandler: function(){
                $cn.val(editor.getData())
                $gdnc.val(editor_gdnc.getData())
                $trms.val(editor_trms.getData())
                const actionUrl = isUpdate ? "/mng/prtpn/cntst/updateCntst.do" : "/mng/prtpn/cntst/insertCntst.do";
                if (displayWorkProgress()) {
                    $.ajax({
                        url: actionUrl,
                        type: 'POST',
                        cache: false,
                        dataType: 'json',
                        data: $form.serialize(),
                        success: function (data) {
                            if (data.success) {
                                alert("저장이 완료 되었습니다.");
                                if (isUpdate) {
                                    gridHelper1.resetPageContent();
                                } else {
                                    gridHelper1.resetListContent();
                                }
                            } else {
                                alert("등록중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                            }
                            closeWorkProgress();
                        }
                    });
                }
            }
        });
        
        // 썸네일
        $("#cntstThmbnFile").on("change", function(e) {
            var fileInput = e.target;
            var inputid = $(e.target).attr("id");
            var grpid = "thmbnFilegrpid";
            var fileid = "thmbnFileid"; 
            var areaid = "thmbnFileArea";
            var formData = new FormData();
            formData.append("file", fileInput.files[0]); 
            formData.append("filegrpNm", inputid);
            
            if($("#" + grpid).val() != "") {
                formData.append("Filegrpid", $("#" + grpid).val());
            } 
            
            if(displayWorkProgress()) {
                $.ajax({
                    url: '/uploadFile.do'
                    , processData: false
                    , contentType: false
                    , data: formData
                    , type: "POST"
                    , success: function(response) {
                        if(response.result == "fail") {
                            alert(response.msg);
                        } else if(response.filegrpid != undefined && response.filegrpid != "") {
                            $("#" + grpid).val(response.filegrpid);
                            $("#" + fileid).val(response.fileid);
                            var displayFile = '<span id="' + inputid + response.fileid + '" class="label label-inverse">' + response.orginlFileNm;
                            displayFile += ' &nbsp;&nbsp;&nbsp;<a href="javascript:deleteFile(' + "'" + inputid + response.fileid + "', "; 
                            displayFile += response.fileid + ", '" + response.fileIdntfcKey + "'" + ');" class="text-white">X</a>';
                            displayFile += '</span>';
                            $("#" + areaid).html(displayFile);
                        }
                        initFileInput(inputid);
                        closeWorkProgress();
                    }
                });
            }
        });
        
        // 첨부파일
        $("#cntstAtchFile").on("change", function(e) {
            var fileInput = e.target;
            var inputid = $(e.target).attr("id");
            var grpid = "atchFilegrpid";
            var fileid = "atchFileid";
            var areaid = "atchFileArea";
            var formData = new FormData();
            for(var i = 0; i < fileInput.files.length; i++) {
                formData.append("files", fileInput.files[i]);
            }
            formData.append("filegrpNm", inputid);
            formData.append("filegrpid", $("#" + grpid).val());
            if(displayWorkProgress()) {
                $.ajax({
                    url: '/uploadMultipleFiles.do'
                    , processData: false
                    , contentType: false
                    , data: formData
                    , type: "POST"
                    , success: function(response) {
                        if(response.result == "fail") {
                            alert(response.msg);
                        } else {
                            if($("#" + grpid).val() == "0" || $("#" + grpid).val() == "" || $("#" + grpid).val() == null) {
                                $("#" + grpid).val(response[0].filegrpid);
                            }
                            var displayFile = "";
                            for(var i = 0; i < response.length; i++) {
                                displayFile = '<span id="' + inputid + response[i].fileid + '" class="label label-inverse">' + response[i].orginlFileNm;
                                displayFile += ' &nbsp;&nbsp;&nbsp;<a href="javascript:deleteFile(' + "'" + inputid + response[i].fileid + "', "; 
                                displayFile += response[i].fileid + ", '" + response[i].fileIdntfcKey + "'" + ');" class="text-white">X</a>';
                                displayFile += '</span>';
                                console.log(areaid)
                                $("#" + areaid).append(displayFile);                                    
                            }
                        }
                        initFileInput(inputid);
                        closeWorkProgress();
                    }
                });
            }
        });
        
    })
    
    // 파일인풋 초기화
    function initFileInput(inputid) {
        if(detectBrowser() == "other") {
            $("#" + inputid).val("");
        } else {
            $("#" + inputid).replaceWith($("#" + inputid).clone(true));
        }
    }
    
    // 파일 삭제
    function deleteFile(inputid, fileid, fileIdntfcKey) {
        var path = "/deleteFile.do?fileid=" + fileid + "&file_idntfc_key=" + fileIdntfcKey;
        $.ajax({
            url: path
            , type: "GET"
            , cache: false
            , dataType: "json"
            , success: function(result) {
                $("#" + inputid).remove();
            }
            , error: function(error) {
            }
        });
    }
</script>
