<form id ="eduSareaUpdateForm">
<input type="hidden" id="sareaId" name="sareaId" th:value="${eduSarea.sareaId}">
<input type="hidden" id="useYn" name="useYn" th:value="${eduSarea.useYn}">
        <!-- update -->
        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>기본정보</strong></h3>
        </div>

        <!-- Tab Container Start -->
         <div class="card-block-small p-t-0">
             <div class="row">
                 <div class="col-lg-6 mb-3">                                                                    
                     <div class="mb-0 form-group required" >
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="sareaNm"><strong>운영권역명</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="sareaNm" id="sareaNm" th:value="${eduSarea.sareaNm}" placeholder="" >
                         </div>
                     </div>
                 </div>
             </div>
             <div class="row">
                 <div class="col-md-6 col-lg-3 mb-3">
                     <div class="mb-0 form-group required">
                         <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>운영기관</strong></div>
                         <div class="col-12 row">
                             <div class="col-8">
                                 <input type="text" class="form-control form-control-sm" name="cnsgnInstNm" id="instNm" th:value="${eduSarea.cnsgnInstNm}" placeholder="기관" />
                                 <input type="hidden" name="cnsgnInstId" id="instid" th:value="${eduSarea.cnsgnInstId}"/>
                             </div>
                             <div class="col-4 btn-group-sm">
                                 <button type="button" class="btn btn-inverse" onclick="fn_openInstSearchModal();">
                                     기관검색
                                 </button>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="row">
                 <div class="col-12 mb-3">
                     <div id="ctprvnDiv" class="mb-0 form-group required">
                         <div class="form-label col-sm-12 col-form-label p-t-0"><strong>지역</strong></div>
                         <div id="ctprvnHtmlDiv">
                             <div class="row pt-1">
                                 <div class="col col-md-6 col-lg-3">
                                    <th:block kattr:select_code="ctprvnCd" grpCd="143" upprCd="0" selectedCd="" onchange="" firstOptTxt="- 선택 -" isAdmin="true"></th:block>
                                 </div>
                                 <div class="col-auto ps-0">
                                     <button class="input-group-text btn btn-primary btn-sm" onclick="fn_delRowCtprvnCds(this)">-</button>
                                     <button type="button" id="addRowCtprvnCds" class="input-group-text btn btn-primary btn-sm addRowCtprvn" onclick="fn_addRowCtprvnCds(this)">+</button>
                                 </div>    
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="row">                 
                 <div class="col-lg-6 mb-3">
                     <div class="mb-0 form-group required">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="aplyLmtCnt"><strong>연도별 기관당 신청 횟수 제한</strong></label>
                         <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" name="aplyLmtCnt" id="aplyLmtCnt" th:value="${eduSarea.aplyLmtCnt}" placeholder="신청 가능 횟수를 입력하세요.">
                         </div> 
                     </div>
                 </div>
             </div> 
             <div class="row form-group mb-3">
                 <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="expln"><strong>설명</strong></label>
                 <div class="col-sm-12">
                     <input type="text" class="form-control form-control-sm" name="expln" id="expln" th:value="${eduSarea.expln}" placeholder=""/>
                 </div>
             </div>  
             <div class="row form-group mb-3">    
                 <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="sareaUseYn"><strong>사용여부</strong></label>
                 <div class="col-12">
                     <input type="hidden" class="js-single"/>
                     <span kattr:switch_yn="sareaUseYn" label="사용여부" th:attr="defaultVal=${eduSarea.useYn}"  onchange="useSwitch()" isAdmin="true"></span>
                 </div>
             </div>
        </div>
        <div class="card-block-small">
            <button type="button" class="btn btn-disabled m-r-5" id="canceeduSarea" onclick="gridHelper1.toggleContent()">취소</button>
            <th:block sec:authorize-url="/mng/prtpn/eduSarea/updateEduSarea.do"><button type="button" class="btn btn-primary" id="updateeduSarea" onclick="fn_updateEduSarea()">저장</button></th:block>
        </div>
        <!-- Tab Container End -->
</form>
<div class="modal fade" id="instSearchPopup" data-bs-backdrop="static"></div>
<script th:inline="javascript">

    var instSearchPopupUrl = "/mng/bsnsOperDta/instSearchPopup.html";
    var instSearchAddModal;
    var ctprvnCdSelectedItems = [];

    /* 기관검색 팝업 load */
    fn_openInstSearchModal = () => {
        $("#instSearchPopup").load(instSearchPopupUrl, function(response, status, xhr) {
            if (status == "success") {
                instSearchAddModal = new bootstrap.Modal($('#instSearchPopup'));
                instSearchAddModal.show();
            }
        });
    }

    /* 초기화 함수: 세부 지역 목록 조회 */
    function init() {
        var elemsingleSmallList = document.querySelectorAll('.js-single-small');
        for(var i = 0; i < elemsingleSmallList.length; i++) {
            new Switchery(elemsingleSmallList[i], {color: "#93BE52", jackColor: "#fff", size: "small"});
       }
       $(".switchery").css({pointerEvents: "block"});

       var ctprvnCds = [[${eduSarea.ctprvnCd}]];
       
       if(ctprvnCds.indexOf(",") >= 0) {            
           var ctprvnCdsArr = ctprvnCds.split(",");
           for(var i=0; i<ctprvnCdsArr.length;i++) {
               ctprvnCdSelectedItems.push(ctprvnCdsArr[i]);
           }
       }else{
           ctprvnCdSelectedItems.push(ctprvnCds);
       }
       $("#ctprvnHtmlDiv").html( fn_makeCtprvnCdsDivHtml() );
    }
    
    function useSwitch() {
        if ($("#sareaUseYn").is(":checked")) {
            $('#eduSareaUpdateForm').find('#useYn').val("Y");
        } else {
            $('#eduSareaUpdateForm').find('#useYn').val("N");
        }
    }

    //지역 행추가
    function fn_addRowCtprvnCds(item){
        var delBtn = `<button type="button" class="input-group-text btn btn-primary btn-sm" onclick="fn_delRowCtprvnCds(this)">-</button>`;
        var $parent = $(item).parent().parent();
        $(item).parent().append(delBtn);
        $(item).remove();
        $parent.last().after( fn_makeCtprvnCdsListHtml() );
    }

    //지역 행삭제
    function fn_delRowCtprvnCds(item){
        $(item).parent().parent().remove();
    }
    
    function fn_makeCtprvnCdsListHtml() {
        var ctprvnCdsHtml = "";
        var rowCnt =  $("#ctprvnDiv").find('.row').length;
        var ctprvnCdsList = /*[[${ctprvnCdList}]]*/;
        ctprvnCdsHtml += '<div class="row pt-1">   '
        ctprvnCdsHtml += '  <div class="col col-md-6 col-lg-3">';                         
        ctprvnCdsHtml += '      <select class="form-select form-select-sm form-control-sm" style="" id="ctprvnCd" name="ctprvnCd">';
        ctprvnCdsHtml += '          <option value="">- 선택 -</option>';
        for(var i=0; i<ctprvnCdsList.length; i++){
            ctprvnCdsHtml += '      <option value="'+ctprvnCdsList[i].ctprvnCd+'">'+ctprvnCdsList[i].ctprvnNm+'</option>';            
        }
        ctprvnCdsHtml += '      </select>';
        ctprvnCdsHtml += '  </div>';        
        ctprvnCdsHtml += '  <div class="col-auto ps-0">';
        ctprvnCdsHtml += '      <button type="button" id="addRowCtprvnCds" class="input-group-text btn btn-primary btn-sm addRowCtprvn" onclick="fn_addRowCtprvnCds(this)">+</button>';
        ctprvnCdsHtml += '  </div>';                             
        ctprvnCdsHtml += '</div>';                             
        
        return ctprvnCdsHtml;
    }    
    
    function fn_updateEduSarea(){
        if(!($("#eduSareaUpdateForm").valid())) return;

        if(!confirm("수정하시겠습니까?")) return;

        var ctprvnCds = $('[name=ctprvnCd] option:selected').map(function(){ return $(this).val();}).get().join(",");
        var setCtprvnCd = new Set($('[name=ctprvnCd] option:selected').map(function(){ return $(this).val();}));
        var isDuplicate = setCtprvnCd.size < $('[name=ctprvnCd] option:selected').length;

        if(isDuplicate === true){
        	alert("타 운영권역과 중복되는 지역이 있습니다.");
        	return;
        }

        var data =  $("#eduSareaUpdateForm").serialize();
        data = data + "&ctprvnCds="+ctprvnCds;
        
        if(displayWorkProgress()){
            $.ajax({
                url : "/mng/prtpn/eduSarea/updateEduSarea.do",
                type: 'POST',
                cache : false,
                dataType: 'json',
                data : data,
                success : function (data){
                    if(data.result=="success"){
                        alert(data.msg);
                        gridHelper1.resetListContent();
                    }else{
                        alert(data.msg);
                    }
                    closeWorkProgress();
                }
            });
        }
    }

    /* 세부 목록 렌더링 */
    function fn_makeCtprvnCdsDivHtml() {
        var ctprvnCdsHtml = "";
        var ctprvnCdsList = /*[[${ctprvnCdList}]]*/null;
        for(var i=0; i<ctprvnCdSelectedItems.length; i++){
            ctprvnCdsHtml += '<div class="row pt-1">   ';
            ctprvnCdsHtml += '  <div class="col col-md-6 col-lg-3">';                         
            ctprvnCdsHtml += '      <select class="form-select form-select-sm form-control-sm" style="" id="ctprvnCd" name="ctprvnCd">';
            for(var j=0; j<ctprvnCdsList.length; j++){
                ctprvnCdsHtml += ctprvnCdSelectedItems[i] == ctprvnCdsList[j].ctprvnCd ? '<option value="'+ctprvnCdsList[j].ctprvnCd+'" selected>'+ctprvnCdsList[j].ctprvnNm+'</option>' : '<option value="'+ctprvnCdsList[i].ctprvnCd+'">'+ctprvnCdsList[j].ctprvnNm+'</option>'; 
            }
            ctprvnCdsHtml += '      </select>';
            ctprvnCdsHtml += '  </div>';        
            ctprvnCdsHtml += '  <div class="col-auto ps-0">';

            if( i == ctprvnCdSelectedItems.length-1) {
                ctprvnCdsHtml += '      <button type="button" id="addRowCtprvnCds" class="input-group-text btn btn-primary btn-sm addRowCtprvn" onclick="fn_addRowCtprvnCds(this)">+</button>';
            } else {
                ctprvnCdsHtml += '      <button type="button" class="input-group-text btn btn-primary btn-sm" onclick="fn_delRowCtprvnCds(this)">-</button>   '
            }

            ctprvnCdsHtml += '  </div>';
            ctprvnCdsHtml += '</div>';          
        }
         return ctprvnCdsHtml;
    }
    
    $(function () {
        init(); 
        validForm();
    })
    
    function validForm() {
        $("#eduSareaUpdateForm").validate({
            onsubmit: false,
            rules: {
                sareaNm: {required: true, maxlength: 100},
                cnsgnInstNm: {required: true},
                ctprvnCd: {required: true},
                aplyLmtCnt: {required: true, maxlength: 11},
                expln: {required: false, maxlength: 200}

            },
            messages: {
                sareaNm: {required: "운영권역명을 입력해주십시오.", maxlength: "운영권역명은 100자를 넘을 수 없습니다."},
                cnsgnInstNm: {required: "운영기관을 입력해주십시오."},
                ctprvnCd: {required: "지역을 선택해주십시오."},
                aplyLmtCnt: {required: "연도별 기관당 신청 횟수 제한을 입력해주십시오.", maxlength: "연도별 기관당 신청 횟수 제한은 11자를 넘을 수 없습니다."},
                expln: {maxlength: "설명은 200자를 넘을 수 없습니다."}
            }
        });    
    }    
    
</script>