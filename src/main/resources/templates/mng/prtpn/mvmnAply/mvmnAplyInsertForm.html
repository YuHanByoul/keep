<form id ="mvmnAplyInsertForm">
<input type="hidden" id="prgrmId" name="prgrmId" th:value="${mvmnAplyVo.prgrmId}" />
<input type="hidden" id="operFomCd" name="operFomCd" th:value="${mvmnAplyVo}" />
        <!-- INSERT -->
        <div class="card-header p-b-0">
            <h3 class="sub-title"><strong>교육신청자 정보</strong></h3>
        </div>
        <!-- Tab Container Start -->
         <div class="card-block-small p-t-0">
             <div class="row">
                 <div class="col-lg-6 mb-3">                 
                     <div class="mb-0 form-group required">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="eduYr"><strong>교육년도</strong></label>
                         <div class="col-sm-12">
                             <select name="eduYr" id="eduYr" class="form-select form-select-sm form-control-sm" disabled>
                                 <option value="">- 선택 -</option>
                                 <th:block th:each="year : ${years}">
                                     <option th:value="${year}" th:selected="${mvmnAplyVo.eduYr} == ${year}"><th:block th:text="${year}" /></option>
                                 </th:block>
                             </select>
                         </div>
                     </div>
                 </div>
                 <div class="col-lg-6 mb-3">                 
                     <div class="mb-0 form-group required">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>운영권역</strong></label>
                         <div class="col-sm-12">
                             <select name="sareaId" id="sareaId" class="form-select form-select-sm form-control-sm" onchange="fn_changeSareaId(this);" disabled>
                                 <option value="">- 선택 -</option>
                                 <th:block th:each="item : ${sareaList}">
                                     <option th:value="${item.sareaId}" th:selected="${item.sareaId} == ${mvmnAplyVo.sareaId}"><th:block th:text="${item.sareaNm}" /></option>
                                 </th:block>
                             </select>
                         </div>
                     </div>
                 </div>
                 
             </div>                 
             <div class="row">
                 <div class="col-lg-6 mb-3">                                                                    
                     <div class="mb-0 form-group required" >
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="prgrmNm"><strong>프로그램명</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="prgrmNm" id="prgrmNm" placeholder="" th:value="${mvmnAplyVo.prgrmNm}" disabled>
                         </div>
                     </div>
                 </div>
                 <div class="col-lg-6">
                     <div class="row">
                         <div class="col-sm-6 mb-3 form-group required">
                             <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="ctprvnCd_1"><strong>신청지역</strong></label>
<!--                              <th:block kattr:select_code="ctprvnCd_1" grpCd="143" upprCd="0" selectedCd="" onchange='setNextDepth(143,this.value,"ctprvnCd_2" )' firstOptTxt="- 선택 -" isAdmin="true"></th:block> -->
                             <select name="ctprvnCd_1" id="ctprvnCd_1" class="form-select form-select-sm form-control-sm"  onchange="fn_changeCtprvnCd(this);" disabled>
                                 <option value="">- 선택 -</option>
                             </select>
                             
                         </div>
                         <div class="col-sm-6 mb-3 form-group required">
                             <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="ctprvnCd_2"><strong>시군구</strong></label>
                             <select id="ctprvnCd_2" name="ctprvnCd_2" class="form-select form-select-sm form-control-sm" disabled>
                                  <option value="">- 선택 -</option>
                             </select>
                         </div>
                     </div>
                 </div>                 
             </div>
             <div class="row">
                 <div class="col-lg-6 mb-3">
                     <div class="mb-0 form-group required">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="instNm"><strong>신청기관</strong></label>
                         <div class="col-12">
                             <input type="hidden" name="instid" id="instid"/>
                             <input type="text" class="form-control form-control-sm" name="instNm" id="instNm" placeholder="" disabled/>
                         </div>
                     </div>
                 </div>
                 <div class="col-lg-6 mb-3">
                     <div class="mb-0 form-group required">
                         <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>신청인</strong></div>
                         <div class="col-12 row">
                             <div class="col-8">
                                 <input type="text" class="form-control form-control-sm" name="userNm" id="userNm" placeholder="신청인을 선택하세요" readonly/>
                                 <input type="hidden" name="aplyUserid" id="userid" />
                             </div>
                             <div class="col-4 btn-group-sm">
                                 <button type="button" class="btn btn-inverse btn-sm" onclick="fn_openUserSearchModal();">사용자 검색</button>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="row">
                 <div class="col-lg-6 mb-3">
                     <div class="mb-0 form-group required">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="addr"><strong>기관주소</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="addr" id="addr" disabled/>
                         </div>
                     </div>
                 </div>
                 <div class="col-lg-6 mb-3">
                     <div class="mb-0 form-group">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="addrDtl"><strong>상세주소</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="addrDtl" id="addrDtl" disabled/>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="row">
                 <div class="col-lg-6 mb-3">
                     <div class="mb-0 form-group">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="telno"><strong>기관 전화번호</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="telno" id="telno" disabled/>
                         </div>
                     </div>
                 </div>
                 <div class="col-lg-6 mb-3">
                     <div class="mb-0 form-group">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="fxno"><strong>기관 FAX번호</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="fxno" id="fxno" placeholder="" disabled/>
                         </div>
                     </div>
                 </div>
             </div>
             <div class="row">
                 <div class="col-lg-6 mb-3">
                     <div class="mb-0 form-group required">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="eml"><strong>신청자 이메일</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="eml" id="eml" disabled/>
                         </div>
                     </div>
                 </div>
                 <div class="col-lg-6 mb-3">
                     <div class="mb-0 form-group required">
                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="trgtCd"><strong>접수번호</strong></label>
                         <div class="col-sm-12">
                             <input type="text" class="form-control form-control-sm" name="eml" id="eml" disabled/>
                         </div>
                     </div>
                 </div>
             </div>
             
             <th:block th:if="${mvmnAplyVo.operFomCd != '197102'}">
	             <div class="row">
	                 <div class="col-lg-6">
	                     <div class="row">
	                         <div class="col-sm-6 mb-3 form-group required">
	                             <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="tmeDe"><strong>교육일자</strong></label>
	                             <select name="tmeDe" class="form-select form-select-sm form-control-sm" id="tmeDe" onchange="fn_changeSelectDe(this);">
	                                <!--
	                                 <option value="">- 선택 -</option>
	                                 <th:block th:each="item : ${tmeSchdlList}">
	                                     <option th:value="${item.tmeSchdlid}"><th:block th:text="${item.de}" /></option>
	                                 </th:block>
	                                 -->
	                             </select>
	                         </div>
	                         <div class="col-sm-6 mb-3 form-group required">
	                             <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="tmeSchdlid"><strong>회차</strong></label>
	                             <select name="tmeSchdlid" class="form-select form-select-sm form-control-sm" id="tmeSchdlid" onchange="fn_changeSelectTme(this);" disabled>
	                                 <option value="">- 선택 -</option>
	                                 <th:block th:each="item : ${tmeSchdlList}">
	                                     <option th:value="${item.tmeSchdlid}" th:data-de="${item.de}"><th:block th:text="${item.tmeNm}" /></option>
	                                 </th:block>
	                             </select>
	                         </div>
	                     </div>
	                 </div>
	                 <div class="col-lg-6 mb-3">
	                     <div class="mb-0 form-group required">
	                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="sttsCd"><strong>신청상태</strong></label>
	                         <div class="col-sm-12">
	                             <th:block kattr:select_code="sttsCd" grpCd="180" upprCd="0" selectedCd="" onchange="" firstOptTxt="- 선택 -" isAdmin="true"></th:block>
	                         </div>
	                     </div>
	                 </div>
	             </div>
	             <div class="row">
	                 <div class="col-lg-6 mb-3">
	                     <div class="mb-0 form-group required">
	                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="eduNope"><strong>교육인원(명)</strong></label>
	                         <div class="col-sm-12">
	                             <input type="number" class="form-control form-control-sm" name="eduNope" id="eduNope" placeholder="교육인원(명)을 숫자로 입력하세요." onchange="" min="1">
	                         </div>
	                     </div>
	                 </div>
	                 <div class="col-lg-6 mb-3">
	                     <div class="mb-0 form-group required">
	                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="trgtCd"><strong>교육대상</strong></label>
	                         <div class="col-sm-12">
	                             <div class="border-checkbox-section">
	                                 <span kattr:check_code="trgtCd" grpCd="199" isAdmin="true" addClass="trgtCds">
	                             </div>
	                         </div>
	                     </div>
	                 </div>
	             </div>
	             <div class="row">
				     <div class="col-lg-6 mb-3">
				         <div class="mb-0 form-group row required">
				             <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="hopeEduBgngTm"><strong>희망 교육시간</strong></label>
				             <div class="col-md-6">
				                 <input type="time" class="form-control form-control-sm" id="hopeEduBgngTm" name="hopeEduBgngTm">
				             </div>
				             <div class="col-md-6 mt-1 mt-md-0">
				                 <input type="time" class="form-control form-control-sm" id="hopeEduEndTm" name="hopeEduEndTm">
				             </div>
				         </div>
				     </div>	                 
	             </div>	             	             
             </th:block>
             
             <th:block th:unless="${mvmnAplyVo.operFomCd != '197102'}">
	             <div class="row">
	                 <div class="col-lg-12">
	                     <div class="row">
	                         <div class="col-sm-12 mb-3 form-group required">
	                             <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="tmeSchdlid"><strong>회차</strong></label>
	                             <select name="tmeSchdlid" class="form-select form-select-sm form-control-sm" id="tmeSchdlid">
	                                 <option value="">- 선택 -</option>
	                                 <th:block th:each="item : ${tmeSchdlList}">
	                                     <option th:value="${item.tmeSchdlid}" th:data-de="${item.de}"><th:block th:utext="${item.tmeNm} + '&lt;br /&gt; 일정 : ' + ${item.de}" /></option>
	                                 </th:block>
	                             </select>
	                         </div>
	                     </div>
	                 </div>
	             </div>             
	             <div class="row">
	                 <div class="col-lg-6 mb-3">
	                     <div class="mb-0 form-group required">
	                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="sttsCd"><strong>신청상태</strong></label>
	                         <div class="col-sm-12">
	                             <th:block kattr:select_code="sttsCd" grpCd="180" upprCd="0" selectedCd="" onchange="" firstOptTxt="- 선택 -" isAdmin="true"></th:block>
	                         </div>
	                     </div>
	                 </div>
	                 <div class="col-lg-6 mb-3">
	                     <div class="mb-0 form-group required">
	                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="eduNope"><strong>교육인원(명)</strong></label>
	                         <div class="col-sm-12">
	                             <input type="number" class="form-control form-control-sm" name="eduNope" id="eduNope" placeholder="교육인원(명)을 숫자로 입력하세요." onchange="" min="1">
	                         </div>
	                     </div>
	                 </div>	                 
	             </div>
	             <div class="row">
	                 <div class="col-lg-6 mb-3">
	                     <div class="mb-0 form-group required">
	                         <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="trgtCd"><strong>교육대상</strong></label>
	                         <div class="col-sm-12">
	                             <div class="border-checkbox-section">
	                                 <span kattr:check_code="trgtCd" grpCd="199" isAdmin="true" addClass="trgtCds">
	                             </div>
	                         </div>
	                     </div>
	                 </div>
				     <div class="col-lg-6 mb-3">
				         <div class="mb-0 form-group row required">
				             <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="hopeEduBgngTm"><strong>희망 교육시간</strong></label>
				             <div class="col-md-6">
				                 <input type="time" class="form-control form-control-sm" id="hopeEduBgngTm" name="hopeEduBgngTm">
				             </div>
				             <div class="col-md-6 mt-1 mt-md-0">
				                 <input type="time" class="form-control form-control-sm" id="hopeEduEndTm" name="hopeEduEndTm">
				             </div>
				         </div>
				     </div>	                 
	             </div>	                          
             </th:block>

             <div class="row form-group mb-3">
                 <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="input10"><strong>비고</strong></label>
                 <div class="col-sm-12">
                     <textarea class="form-control form-control-sm" name="rmrk" id="rmrk" ></textarea>
                 </div>
             </div>
             <div class="row form-group mb-3">
                 <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="input10"><strong>메모</strong></label>
                 <div class="col-sm-12">
                     <input type="text" class="form-control form-control-sm" name="memo" id="memo" />
                 </div>
             </div>
         </div>
        <div class="card-block-small">
            <button type="button" class="btn btn-disabled m-r-5" id="canceMvmnAply" onclick="gridHelper2.toggleContent()">취소</button>
            <th:block sec:authorize-url="/mng/prtpn/mvmnAply/insertMvmnAply.do"><button type="button" class="btn btn-primary" id="insertMvmnAply" onclick="fn_insertMvmnAply()">저장</button></th:block>
        </div>
        <!-- Tab Container End -->
</form>
<form id="searchManagerFrm" >
   <input type="hidden" id="instid" name="instid" value="0"/>   
</form>
<div class="modal fade" id="userSearchPopup" data-bs-backdrop="static"></div>
<script th:inline="javascript">
    var prgrmTmeSelectedItems = [];
    var sareaViewngMaxAplyNope = 0;
    var userSearchPopupUrl = "/mng/prtpn/mvmnAply/mvmnAplyUserSearchPopup.html";
    var userSearchAddModal;
    var tmeSchdlList = /*[[${tmeSchdlList}]]*/null;

    fn_openUserSearchModal = () => {

        $("#userSearchPopup").load(userSearchPopupUrl, function(response, status, xhr) {
            if (status == "success") {
                userSearchAddModal = new bootstrap.Modal($('#userSearchPopup'));
                userSearchAddModal.show();
            }
        });
    }

    function init() {
        prgrmTmeSelectedItems = [];
        sareaViewngMaxAplyNope = 0;
    
        setTmeSchdlList();
        $('#eduYr').val(eduYr);
        $('#sareaId').val(sareaId).prop("selected", true);
        
        fn_changeSareaId($('#sareaId'));
        $("#ctprvnCd_1").attr("disabled",false);
        $("#ctprvnCd_2").attr("disabled",true);
            
    }
    
    function fn_insertMvmnAply(){
        if(!($("#mvmnAplyInsertForm").valid())) return;
        // 교육대상확인
        if($("input[name='trgtCd']:checked").length == 0) {
            alert("교육대상을 확인해주세요.");
            return;
        }
        
        if(!confirm("저장하시겠습니까?")) return;
        
        var zip = ""; //$('#zip').val();
        var addr = $('#addr').val();
        var addrDtl = $('#addrDtl').val();
        var telno = $('#telno').val();
        var fxno = $('#fxno').val();
        var eml = $('#eml').val();
        var signguCd = $('#ctprvnCd_2').val();
        
        var trgtCds = $('.trgtCds:checked').map(function(){ return $(this).val();}).get().join(",");
        
        var data =  $("#mvmnAplyInsertForm").serialize();
        data = data+"&zip="+zip+"&addr="+addr+"&addrDtl="+addrDtl+"&telno="+telno+"&fxno="+fxno+"&eml="+eml+"&signguCd="+signguCd+"&trgtCds="+trgtCds;
        if(displayWorkProgress()){
            $.ajax({
                url : "/mng/prtpn/mvmnAply/insertMvmnAply.do",
                type: 'POST',
                cache : false,
                dataType: 'json',
                data : data,
                success : function (data){
                    if(data.result=="success"){
                        alert(data.msg);
                        gridHelper2.resetListContent();
                    }else{
                        alert(data.msg);
                    }
                    closeWorkProgress();
                }
            });
        }
    }
/*     function fn_changeSareaId(item){
        var getCodeUrl = "/mng/prtpn/eduSarea/selectSareaEduTypeCd.do";
        var url = getCodeUrl + "?sareaId=" + $(item).val();
        if (displayWorkProgress()) {
            $.ajax({
                url: url,
                type: 'POST',
                cache: false,
                success: function (data) {
                    $("#eduTypeCd").val(data.eduTypeCd);
                    $("#eduNope").val(data.sareaViewngMaxAplyNope);
                    //교육관 최대 신청 인원수 세팅.
                    sareaViewngMaxAplyNope = data.sareaViewngMaxAplyNope;
                }
            });
        }
    } */
    
    function fn_changeSareaId(item){
        var getCodeUrl = "/mng/prtpn/mvmnAply/selectMvmnAplyCtprvnCd.do";
        var url = getCodeUrl + "?sareaId=" + $(item).val();
        if (displayWorkProgress()) {
            $.ajax({
                url: url,
                type: 'POST',
                cache: false,
                success: function (data) {
                	var html = `<option value="">- 선택 -</option>`;
                	data.ctprvnCdList.forEach(function (item) {
               		   html += ` <option value="${item.ctprvnCd}">${item.ctprvnNm}</option>`;
                	});
                    $("#ctprvnCd_1").html(html);
                    $("#ctprvnCd_1").attr("disabled",false);
                    $("#ctprvnCd_2").attr("disabled",true);
                    closeWorkProgress();                    
                }
            });
        }
    }
    
    function fn_changeCtprvnCd(item){
        var getCodeUrl = "/mng/prtpn/mvmnAply/selectMvmnAplySignguCd.do";
        var url = getCodeUrl + "?sareaId=" + $("#sareaId").val() +"&ctprvnCd=" + $(item).val() ;
        if (displayWorkProgress()) {
            $.ajax({
                url: url,
                type: 'POST',
                cache: false,
                success: function (data) {
                	var html = `<option value="">- 선택 -</option>`;
                	data.signguCdList.forEach(function (item) {
               		   html += ` <option value="${item.signguCd}">${item.signguNm}</option>`;
                	});
                    $("#ctprvnCd_2").html(html);
                    $("#ctprvnCd_2").attr("disabled",false);
                    closeWorkProgress();                    
                }
            });
        }
    }
    
    function setTmeSchdlList() {
        $("#tmeDe").empty();
        var el = '<option value="">- 선택 -</option>';
        var deList = [];
        $(tmeSchdlList).each(function(index, item) {
            var de = item.de;
            if(deList.indexOf(de) == -1) {
                //el += '<option value="' + item.tmeSchdlid + '"' + ' data-dt="' + item.de + '">' + item.de + '</option>';
                el += '<option value="' + item.de + '">' + item.de + '</option>';
                deList.push(de);
            }
        });
        $("#tmeDe").append(el);
    }
    
    function setTme(de) {
        $('#tmeSchdlid option').each(function() {
            if($(this).attr("data-de") != de) {
                $(this).addClass("d-none");
            } else {
                $(this).removeClass("d-none");                
            }
        });
    }
    
    function fn_changeSelectDe(item){
        var de = $(item).val();
        if(de) {
            $('#tmeSchdlid').prop("disabled", false);
            setTme(de);
        } else {
            $('#tmeSchdlid').prop("disabled", true).val("");
        }
    }
    
    function fn_changeSelectTme(item){
        /*
        var tmeSchdlid = $(item).val();
        $('#tmeSchdlid').val(tmeSchdlid).prop("selected", true);
        */
    }
    
    $(function () {
        init(); 
        validForm();
    })
    
    function validForm() {
        $("#mvmnAplyInsertForm").validate({
            onsubmit: false,
            rules: {
            	sareaId			: { required: true },
                eduYr			: { required: true },
                prgrmNm			: { required: true },
                ctprvnCd_1		: { required: true },
                ctprvnCd_2		: { required: true },
                userNm			: { required: true },
                tmeDe			: { required: true },
                tmeSchdlid		: { required: true },
                signguDesc		: { required: true },
                instNm			: { required: true },
                addr			: { required: true },
                eml				: { required: true },
                sttsCd			: { required: true },
                eduNope			: { required: true, number: true },
                hopeEduBgngTm	: { required: true },
                hopeEduEndTm	: { required: true }
                
            },
            messages: {
                sareaId			: { required: "운영권역을 선택해주십시오." },
                eduYr			: { required: "교육년도를 선택해주십시오." },
                prgrmNm			: { required: "프로그램명을 입력해주십시오." },
                ctprvnCd_1		: { required: "신청지역을 선택해주십시오." },
                ctprvnCd_2		: { required: "시군구를 선택해주십시오." },
                userNm			: { required: "신청인을 선택해주십시오." },
                tmeDe			: { required: "교육일자를 선택해주십시오." },
                tmeSchdlid		: { required: "회차를 선택해주십시오." },
                signguDesc		: { required: "신청인 지역을 선택해주십시오." },
                instNm			: { required: "신청기관을 입력해주십시오." },
                addr			: { required: "기관주소를 입력해주십시오." },
                eml				: { required: "신청자 이메일을 입력해주십시오." },
                sttsCd			: { required: "신청상태를 선택해주십시오." },
                eduNope			: { required: "교육인원(명)을 입력해주십시오.", number: "숫자만 입력가능합니다." },
                hopeEduBgngTm	: { required: "희망 교육시작시간을 입력해주십시오." },
                hopeEduEndTm	: { required: "희망 교육종료시간을 입력해주십시오." }
            }
        });
    }     
</script>