<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<div class="col-12 col-lg-6 ">
    <div class="card">
        <div class="card-header p-b-0">
            <h4 class="sub-title"><strong>문의</strong></h4>
        </div>
        <div class="card-block-small p-t-0">
            <p>
                <strong th:text="|[${helpDeskInfo.clsfNm}] ${helpDeskInfo.ttl}|">[분류] 제목</strong>
            </p>
            <p>
                <th:block th:if="${not #strings.isEmpty(helpDeskInfo.instNm)}">
                    <th:block th:text="${helpDeskInfo.instNm} "></th:block>
                </th:block>

                <th:block th:text="|${helpDeskInfo.nm}(${helpDeskInfo.acnt})|"></th:block><br/>
                <th:block th:text="${#dates.format(helpDeskInfo.regDt, 'yyyy-MM-dd')}"/>
            </p>
        </div>
        <div class="card-header p-t-0 p-b-0">
            <h4 class="sub-title"><strong>문의 내용</strong></h4>
        </div>
        <div class="card-block-small p-t-0">
            <p>
                <th:block th:utext="${#strings.replace(#strings.escapeXml(helpDeskInfo.cn),T(java.lang.System).getProperty('line.separator'),'&lt;br /&gt;')}"></th:block>
            </p>
            <div class="mt-2 row">
                <ul th:if="${fileList != null}">
                    <th:block th:each="file : ${fileList}">
                        <li>
                            <a href="javascript:void(0)" th:fileid="${file.fileid}" th:fileIdntfcKey="${file.fileIdntfcKey}"
                               th:onclick="|javascript:downloadFileByFileid(this.getAttribute('fileid'), this.getAttribute('fileIdntfcKey'))|">
                                <i class="ion-paperclip f-18"></i> [[${file.orginlFileNm}]]
                            </a>
                        </li>
                    </th:block>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="col-12 col-lg-6">
    <form action="post" name="helpDeskAnswrForm" id="helpDeskAnswrForm" onsubmit="return false;">
        <input type="hidden" name="inqryid" id="inqryid" th:value="${helpDeskInfo.inqryid }" />
        <input type="hidden" name="ansid" id="ansid" th:value="${helpDeskAnswrInfo.ansid}" />
        <input type="hidden" name="oldSttsCd" id="oldSttsCd" th:value="${helpDeskInfo.sttsCd}"/>
        <div class="card">

            <div class="card-header p-b-0">
                <h4 class="sub-title"><strong>답변</strong></h4>
            </div>
            <div class="card-block-small p-t-0">
                <div class="mb-2 form-group row required">
                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>상태</strong></div>
                    <div class="col-sm-12">
                        <span kattr:select_code="sttsCd" th:attr="grpCd=${helpDeskInfo.sttsCdgrpid},selectedCd=${helpDeskInfo.sttsCd}" isAdmin="true">
                    </div>
                </div>

                <div class="mb-2 form-group row">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="ttl"><strong>답변 제목</strong></label>
                    <div class="col-sm-12">
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" name="ttl" id="ttl" th:value="${helpDeskAnswrInfo.ttl}"/>
                        </div>
                    </div>
                </div>

                <div class="mb-2 form-group row">
                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"
                           for="cn"><strong>답변 내용</strong></label>
                    <div class="col-sm-12">
                        <textarea rows="5" cols="5" class="form-control form-control-sm" id="cn" name="cn" th:utext="${helpDeskAnswrInfo.cn}" ></textarea>
                    </div>
                </div>
                <div class="mb-2 form-group row">
                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>담당자 지정</strong></div>
                    <div class="col-sm-12 btn-group-sm">
                        <button type="button" class="btn btn-inverse" onclick="openHelpDeskManagerSearchModal()">담당자 검색</button>
                    </div>
                    <div class="mt-2 row">
                        <div class="col-auto" id="managerList">
                            <th:block th:each="helpDeskManager : ${helpDeskManagerInfo}">
                            <span class="label label-inverse " th:id="|managerId-${helpDeskManager.userid}|" name="managerInfo" th:data-id="${helpDeskManager.userid}">
                                    [[${helpDeskManager.nm}]] <a href="javascript:void(0)" th:onclick="|removeManagerInfo(${helpDeskManager.userid})|" class="text-white">X</a>
                            </span>
                            </th:block>
                        </div>
                    </div>
                </div>
                <div class="mb-2 row">
                    <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                        <div class="mb-0 form-group">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"
                                   for="opetrNm"><strong>답변자</strong></label>
                            <div class="col-sm-12">
                                <input type="text" class="form-control form-control-sm" name="opetrNm" id="opetrNm" readonly
                                       th:value="${helpDeskAnswrInfo.prcrNm != null ? helpDeskAnswrInfo.prcrNm : session.user.nm}"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <div class="mb-0 form-group">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"
                                   for="regDt"><strong>답변일자</strong></label>
                            <div class="col-sm-12">
                                <input type="text" class="form-control form-control-sm" name="regDt" id="regDt" readonly
                                       th:value="${helpDeskAnswrInfo.ansDe != null ? helpDeskAnswrInfo.ansDe : #dates.format(#dates.createNow(), 'yyyy-MM-dd')}"/>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-0 form-group row">
                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>답변공개</strong></div>
                    <div class="col-12">
                        <span kattr:radio_yn="rlsYn" label1="공개 " label2="비공개 " addClass=" form-control-static" th:attr="defaultVal=${helpDeskAnswrInfo.rlsYn == null ? 'Y':helpDeskAnswrInfo.rlsYn }" ></span>
                    </div>
                </div>
            </div>
            <div class="p-t-0 card-block-small">
                <button class="btn btn-disabled m-r-5" onclick="gridHelper1.toggleContent()">취소</button>
                <th:block sec:authorize-url="/mng/helpDesk/insertHelpDeskAnswr.do">
                    <button type="button" class="btn btn-primary" onclick="saveHelpDeskAnswr()">저장</button>
                </th:block>
            </div>
        </div>
    </form>

</div>

<script th:inline="javascript">
    var insertHelpDeskAnswrUrl = "/mng/helpDesk/insertHelpDeskAnswr.do";
    var updateHelpDeskAnswrUrl = "/mng/helpDesk/updateHelpDeskAnswr.do";
    var managerSearchModal;

    var openHelpDeskManagerSearchModal =()=> {
        var url = "/mng/helpDesk/helpDeskManagerSearchModal.html";
        $("#helpDeskManagerSearchModal").load(url, function(response, status, xhr) {
            if (status == "success") {
                managerSearchModal = new bootstrap.Modal($('#helpDeskManagerSearchModal'));
                managerSearchModal.show();
            }
        });
    }
    $(function(){
        checkValidation();
        addClassRequired();
        $("#helpDeskAnswrForm #sttsCd").change(function(){
            addClassRequired();
        })
    })

    function checkValidation(){
        $("#helpDeskAnswrForm").validate({
            rules: {
                ttl: {
                    maxlength: 50
                },
                cn: {
                    maxlength: 2000
                }
            },
            messages: {
                ttl: {
                    maxlength: "답변 제목은 50자를 넘을 수 없습니다."
                },
                cn: {
                    maxlength: "답변 내용은 2000자를 넘을 수 없습니다."
                }
            }
        });
    }

    function addClassRequired() {
        if($('#helpDeskAnswrForm #sttsCd option:selected').val() == '113104') {
                $('#ttl').closest('.form-group').addClass('required');
                $('#cn').closest('.form-group').addClass('required');
        }    else {
            $('#ttl').closest('.form-group').removeClass('required');
            $('#cn').closest('.form-group').removeClass('required');
        }
    }

    function removeManagerInfo(userid) {
        $("#managerId-"+userid).remove();
    }

    function saveHelpDeskAnswr() {
        var url = insertHelpDeskAnswrUrl;
        if ($('#ansid').val() != '') {
            url = updateHelpDeskAnswrUrl;
        }

        if (url == insertHelpDeskAnswrUrl) {
            var isSec = false;
            /*[# sec:authorize-url="/mng/helpDesk/insertHelpDeskAnswr.do"]*/
            isSec = true;
            /*[/]*/
            if (!isSec) {
                alert('접근권한이 없습니다.');
                return;
            }
        }
        else if (url == updateHelpDeskAnswrUrl) {
            var isSec = false;
            /*[# sec:authorize-url="/mng/helpDesk/updateHelpDeskAnswr.do"]*/
            isSec = true;
            /*[/]*/
            if (!isSec) {
                alert('접근권한이 없습니다.');
                return;
            }
        }

        var sttsCd = $('#helpDeskAnswrForm').find('#sttsCd').val();

        /*
            - 답변 최초 등록 시 상태가 ＂접수완료“,”접수취소＂인 경우 답변으로 입력하지 않음.
            - 답변 최초 등록 시 상태가 ＂답변중“,”답변완료＂인 경우만 답변으로 입력.
        */
        if (sttsCd == '113101' || sttsCd == '113102') {
            alert('답변중 또는 답변완료 상태인 경우에만 입력이 가능합니다.');
            return;
        }

        /*
            - 상태가 “접수완료”인 경우 : 필수 없음.
            - 상태가 “접수취소＂인 경우 : 필수 없음.
            - 상태가 “답변중“ 인 경우 : 필수 없음.
            - 상태가 “답변완료＂인 경우 : 답변제목, 답변내용 필수.
        */
        if (sttsCd == '113104') {
            var $ttl = $("#ttl");
            var $cn = $("#cn");
            if($ttl.val() == '' || $ttl.val() == null){
                alert('답변 제목을 입력해주십시오.');
                $ttl.css("border","2px solid #ff0000");
                setTimeout(function() { $ttl.css("border","")}, 1000);
                return;
            }
            if($cn.val() == '' || $cn.val() == null) {
                alert('답변 내용을 입력해주십시오.');
                $cn.css("border","2px solid #ff0000");
                setTimeout(function() { $cn.css("border","")}, 1000);
                return;
            }
        }

        if (!$('#helpDeskAnswrForm').valid()) return;

        var formData = $('#helpDeskAnswrForm').serializeArray();
        var helpDeskManagerIds = [];

        $("[name=managerInfo]").each(function(index,item){
            helpDeskManagerIds.push($(this).data('id'));
        });
        formData = formData.concat({name:"helpDeskManager", value:helpDeskManagerIds});
        if (displayWorkProgress()) {
            $.ajax({
                url: url,
                cache: false,
                dataType: 'json',
                type:'post',
                data: formData,
                success: function (data) {
                    alert(data.msg);
                    closeWorkProgress();
                    gridHelper1.resetListContent();
                }
            });
        }

    }


</script>
<script type="text/javascript" src="/files/assets/pages/advance-elements/swithces.js"></script>
<script type="text/javascript" src="/files/assets/pages/advance-elements/select2-custom.js"></script>

</html>