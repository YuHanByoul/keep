<form id="chgAplyFrm">
    <input type="hidden" id="prgrmid" name="prgrmid" th:value="${chgAplyPrgrmInfo.prgrmid}">
    <input type="hidden" id="aplcntid" name="aplcntid" th:value="${chgAplyPrgrmInfo.aplcntid}">

    <div class="tab-pane" id="updateRequest" role="tabpanel">
        <div class="card-header p-t-0 p-b-0">
            <h3 class="sub-title"><strong>기본 정보</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="mb-2 row">
                <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="prgrmNm"><strong>프로그램명</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" name="prgrmNm" id="prgrmNm" placeholder="" th:value="${chgAplyPrgrmInfo.prgrmNm}" readonly="">
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="instNm"><strong>기관명</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" name="instNm" id="instNm" placeholder="" th:value="${chgAplyPrgrmInfo.instNm}"  readonly="">
                        </div>
                    </div>
                </div>
            </div>
            <div class="mb-0 row">
                <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="cyclNo"><strong>차수 / 지정번호</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" name="cyclNo" id="cyclNo" placeholder="" th:value="${chgAplyPrgrmInfo.cyclNo}"  readonly="">
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="mb-0 form-group">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="dsgnPrd"><strong>지정유효기간</strong></label>
                        <div class="col-sm-12">
                            <input type="text" class="form-control form-control-sm" name="dsgnPrd" id="dsgnPrd" placeholder="" th:value="${chgAplyPrgrmInfo.dsgnPrd}"  readonly="">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-header p-b-0">
            <div class="sub-title row m-l-0 m-r-0 m-b-0 align-items-center">
                <div class="col-12 col-lg-6 mb-2 mb-lg-0 p-l-0">
                    <strong>변경 신청</strong>
                </div>
                <div class="col-12 col-lg-6 text-right p-r-0 btn-group-sm">
                    <button type="button" class="btn btn-primary" onclick="chgAply.showModal('')">변경신청등록</button>
                </div>
            </div>
        </div>

        <div class="card-block-small p-t-0">
            <div class="col-12 table-border-style">
                <div class="table-responsive">
                    <table id="chgAplyGrid" class="table"></table>
                </div>
            </div>
        </div>
    </div>
</form>

<!--변경신청 상세보기 팝업-->
<div class="modal fade" id="chgAplyDtlPopup" aria-hidden="true" data-bs-backdrop="static"></div>

<script th:inline="javascript">
    var chgAply={
    	selectListUrl:"/mng/dsgnPrgrm/selectChgAplyList.do",
    	modalUrl:"/mng/dsgnPrgrm/chgAplyDtlPopup.html",
    	gridHelper:null,

    	init(){
    		this.writeChgAplyListData();
            this.gridHelper = new GridHelper('chgAplyGrid');
    	},

    	writeChgAplyListData(){
            $("#chgAplyGrid").jsGrid({
                height: "220px",
                width: "100%",
                autoload: true,
                sorting:false,
                paging: false,
                pageLoading: true,
                pageIndex: 1,
                noDataContent: "데이터가 없습니다.",

                controller: {
                    loadData: function (filter) {
                        var data = $.Deferred();

                        var formData = $('#searchFrm').serializeArray();
                        var params = [
                                {name: "pageNumber", value: filter.pageIndex},
                                {name: "rowPerPage", value: filter.pageSize},
                                {name: "prgrmid", value: prgrmid},
                        ]

                        if(filter.sortField != undefined){
                            params.push({name: "orderField", value: filter.sortField});
                            params.push({name: "orderDirection", value: filter.sortOrder});
                        }else{
                            params.push({name: "orderField", value: 'reg_dt'});
                        }

                        formData = formData.concat(params);

                        $.ajax({
                          type: "GET",
                          contentType: "application/json; charset=utf-8",
                          url: chgAply.selectListUrl,
                          dataType: "json",
                          data: formData
                        }).done(function(response){
                            var da = {
                                    data : escapeGridData(response.chgAplyList)
                                    ,itemsCount : response.totalCount
                                };
                          data.resolve(da);
                        });
                        return data.promise();
                    },
                },
                fields: [
                     { name: 'aplyid', css:'hide'}
                    ,{ title: 'No.'        ,name: 'rowNumber',   type: "number", width : "80", align:"center",  sorting :false }
                    ,{ title: '상태'       ,name: 'aplySttsCdNm',  type: "text", width: "40", align:"center"}
                    ,{ title: '변경사유'   ,name: 'chgRsn',      type: "text", width: "250", align:"center"}
                    ,{ title: '등록일시'   ,name: 'regDt',       type: "text", width: "50", align:"center" }
                    ,{ title: '완료처리일' ,name: 'sttsMdfcnDe', type: "text", width: "50", align:"center" }

                ],

                rowClick: function(args) {

                    if(args.event.originalEvent.target.cellIndex == 0 || isNaN(args.event.originalEvent.target.cellIndex)) return;


                    if(args.event.originalEvent.target.cellIndex == 3){

                    	chgAply.showModal(args.item.aplyid);
                    }

                },
                onPageChanged: function(args) {
                    selectedItems = [];
                }
            });

    	},

        //변경신청상세보기 모달
    	showModal: function (keyid) {
            var aplyid = keyid ?? 0;
            var prgrmid = $('#prgrmid').val();
            var aplcntid = $('#aplcntid').val();
            var url = chgAply.modalUrl + "?prgrmid="+prgrmid+"&aplyid=" + aplyid+'&aplcntid='+aplcntid;
            $("#chgAplyDtlPopup").load(url, function (response, status, xhr) {
                if (status == "success") {
                    chgAply.modal = new bootstrap.Modal($('#chgAplyDtlPopup'));
                    chgAply.modal.show();
                }
            });
        }
    }

    $(function () {
        chgAply.init();
    });

</script>
</div>
</body>
</html>