<form id="mbrSrchPopupFrm" name="mbrSrchPopupFrm" action="" onsubmit="return false;" >

    <input type="hidden" id="prgrmid" name="prgrmid" th:value="${prgrmid}"/>
    <input type="hidden" id="instid" name="instid" th:value="${instid}"/>

    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content type_2">
            <div class="modal-header">
                <h4 class="modal-title">회원검색</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-block-small">
                        <div class="row">
                            <div class="col-12 col-lg-6 mb-2 mb-lg-0">
                                <div class="mb-0 form-group">
                                    <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>키워드</strong></div>
                                    <div class="input-group input-group-sm input-group-dropdown mb-0">
                                        <select id="searchType" name="searchType" class="form-select form-control form-control-sm ">
                                            <option value="searchUserNm">이름</option>
                                            <option value="searchInstNm">기관명</option>
                                        </select>
                                        <input type="text" name="searchKeyword" id="searchKeyword" class="form-control" aria-label="">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-1 p-t-20 text-center border-top">
                            <button type="button" class="btn btn-disabled m-r-5" onclick="mbrSrch.fn_initPop()" >초기화</button>
                            <button type="submit" class="btn btn-primary" onclick="mbrSrch.fn_searchPop()" >검색</button>
                        </div>
                    </div>
                </div>
                <div class="card m-b-10">
                    <div class="card-block-small">
                        <div class="row">
                            <div class="col-12">
                                <table id="mbrGrid" class="table-responsive"></table>
                                <div id="mbrListPager" class="text-center"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="mbrSrch.selectMbrBtn()">선택</button>
            </div>
        </div>
    </div>
</form>

<script th:inline="javascript">

var selectedItem;
var mbrGridHelper;

var mbrSrch = {
	init(){
		mbrGridHelper = new GridHelper('mbrGrid','mprPanel');
		mbrSrch.writeMbrGridData();
	} ,

	fn_initPop() {
		//초기화 버튼

	    $("#mbrSrchPopupFrm #searchType :first").prop("selected","selected")
	    $("#mbrSrchPopupFrm #searchKeyword").val("");
	} ,

	fn_searchPop(){
	    mbrGridHelper.resetListContent();
	} ,

	writeMbrGridData(){

	    $("#mbrGrid").jsGrid({
	        height       : "220px",
	        width        : "100%",
	        autoload     : true,
	        sorting      : true,
	        paging       : false,
	        pageLoading  : true,
	        pagerContainer: "#mbrListPager",
	        pageIndex    : 1,
	        noDataContent: "데이터가 없습니다.",

	        controller: {
	            loadData: function (filter) {
	                var data = $.Deferred();

	                var formData = $('#mbrSrchPopupFrm').serializeArray();
	                var params = [
	                        {name: "pageNumber", value: filter.pageIndex},
	                        {name: "rowPerPage", value: filter.pageSize},
	                        {name: "instid", value: instid},

	                ]

	                if(filter.sortField != undefined){
	                    params.push({name: "orderField", value: filter.sortField});
	                    params.push({name: "orderDirection", value: filter.sortOrder});
	                }else{
	                    params.push({name: "orderField", value: 'instid'});
	                }

	                formData = formData.concat(params);

	                $.ajax({
	                  type: "GET",
	                  contentType: "application/json; charset=utf-8",
	                  url: "/mng/asgsysSrng/selectMbrList.do",
	                  dataType: "json",
	                  data: formData
	                }).done(function(response){

	                    var da = {
	                            data : escapeGridData(response.mbrList)
	                            ,itemsCount : response.totalCount
	                        };
	                  data.resolve(da);
	                });
	                return data.promise();
	            },
	        },
	        fields: [
	            {

	                headerTemplate: function() {
	                        //return $("<input>").attr("type", "checkbox").attr("id", "selectAllCheckbox")
	                },
	                itemTemplate : function(_, item) {

	                                   return $("<input>").attr("type", "checkbox").attr("class", "singleCheckbox").attr("id","userid-"+item.userid)
	                                                       .on("change" , function () {
	                                                         $(this).is(":checked") ? selectItem(
	                                                                                     $(this).parent().next().text()
	                                                                                   , $(this).parent().next().next().text()
	                                                                                   , $(this).parent().next().next().next().next().text()
	                                                                                   , $(this).parent().next().next().next().next().next().text()
	                                                                                   , $(this).parent().next().next().next().next().next().next().text() )
	                                                                                 : unselectItem(
	                                                                                     $(this).parent().next().text()
	                                                                                     , $(this).parent().next().next().text()
	                                                                                     , $(this).parent().next().next().next().next().text() )
	                                       });
	                    },
	                    align: "center",
	                    width: "30",
	                    sorting: false
	                    /*
	                    */

	             }
	           , { name: 'userid', css:'hide'}
	           , { name: 'acnt', css:'hide'}
	           , { title: 'No.'    ,name: 'rowNumber', type: "number", width : "80",  align:"center",  sorting :false }
	           , { title: '이름'   ,name: 'nm'       , type: "text",   width : "50",  align:"center" }
	           , { title: '휴대폰' ,name: 'moblphon' , type: "text",   width : "80",  align:"center" }
	           , { title: '이메일' ,name: 'eml'      , type: "text",   width : "100", align:"center" }
	           , { title: '기관명' ,name: 'instNm'   , type: "text",   width : "100", align:"center" }
	           , { name: 'instid', css:'hide'}
	        ],

	        rowClick: function(args) {
	            if(args.event.originalEvent.target.cellIndex == 0 || isNaN(args.event.originalEvent.target.cellIndex)) return;
	        },

	    });
	    var selectItem = function(id, acnt, name, moblphon, eml ) {
	        selectedItem= {"userid" : id, "acnt" : acnt, "nm" : name, "moblphon":moblphon, "eml":eml};


	        $(".singleCheckbox:checked").prop("checked",false);
	        $("#userid-"+id).prop("checked",true);

	    };

	    var unselectItem = function(item) {

	        selectedItem = "";
	        $('#selectAllCheckbox').attr('checked', false);

	    };
	} ,

	selectMbrBtn(){

	    var data = {
	    		prgrmid  : $('#mbrSrchPopupFrm #prgrmid').val()
	          , aplcntid : selectedItem.userid
	          , aplcntNm : selectedItem.nm
	          , aplcntEml : selectedItem.eml
	          , aplcntMoblphon : selectedItem.moblphon
	    }

	    //담당자 변경시 바로 update
	    $.ajax({
	        url :"/mng/dsgnPrgrm/updateMbr.do",
	        type: 'POST',
	        cache : false,
	        dataType: 'json',
	        data : data,
	        success : function (data){

	            if(data.result=="success"){
	                alert("담당자가 변경 되었습니다.");

	                selectTab("tabCon1Link");
	                chgAltmntModal.hide();

	            }else{
	                alert("담당자가 변경중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
	            }
	            closeWorkProgress();

	        },
	        error : function (error){
	        }
	    })
	}
}

$(function() {
	mbrSrch.init();
});


</script>
</body>
</html>