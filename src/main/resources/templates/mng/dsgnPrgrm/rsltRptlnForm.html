<form id="rsltRptlnFrm">
    <input type="hidden" id="srngid" name="srngid" th:value="${rsltRptln.srngid}">
    <input type="hidden" id="srngid" name="dmndid" th:value="${rsltRptln.dmndid}">
    <div class="card-header p-t-0 p-b-0">
        <h3 class="sub-title"><strong>결과보고서</strong></h3>
    </div>
    <div class="card-block-small p-t-0">
        <div class="mb-2 form-group row required">
            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="gnrlzOpnn"><strong>이행확인심사 종합의견</strong></label>
            <div class="col-12">
                <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="이행확인심사 종합의견 입력" id="gnrlzOpnn" name="gnrlzOpnn">[[${rsltRptln.gnrlzOpnn}]]</textarea>
            </div>
        </div>
        <div class="mb-2 form-group row required">
            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="dmndCn"><strong>보완개선요청</strong></label>
            <div class="col-12">
                <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="Default textarea" id="dmndCn" name="dmndCn" readonly>[[${rsltRptln.dmndCn}]]</textarea>
            </div>
        </div>
        <div class="mb-2 form-group row required">
            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="cn"><strong>보완개선계획</strong></label>
            <div class="col-12">
                <textarea rows="5" cols="5" class="form-control form-control-sm" placeholder="Default textarea" id="cn" name="cn" readonly>[[${rsltRptln.cn}]]</textarea>
            </div>
        </div>
        <div class="mb-2 form-group row required">
            <div class="form-label col-sm-12 col-form-label p-t-0 pb-1">
                <strong>종합평가</strong></div>
            <div class="col-12 col-lg-6">
                <span kattr:select_code="grdCd" th:attr="grpCd=170, selectedCd=${rsltRptln.grdCd}" firstOptTxt="- 전체 -" addClass="form-select form-select-sm form-control-sm" isAdmin="true">
            </div>
        </div>
        <div class="mb-0 form-group row">
            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>첨부파일</strong></label>
            <div class="col-12 col-lg-6">
                <input id="multiFileInput" type="file" name="files" multiple accept="image/jpeg,image/gif,image/png,application/pdf" class="form-control form-control-sm"/>
                <input type="hidden" name="filegrpid" id="filegrpid" th:value="${rsltRptln.filegrpid ==null?0:rsltRptln.filegrpid }">
            </div>
            <div class="m-0 row">
                <div class="col-12 row border rounded pt-1 pb-2 m-0">
                    <div class="col-auto" id="fileListArea">
                        <th:block th:if = "${fileList} != null" >
                            <th:block th:each="item:${fileList}" th:if = "${item.fileid} > 0">
                                <span class ='label label-inverse ' th:id="${item.fileid}">
                                    <span class='text-white' href="javascript:void(0)" th:name="${item.fileid}" th:onclick="downloadFileByFileid([[${item.fileid}]],[[${item.fileIdntfcKey}]])"><th:block th:text="${item.orginlFileNm}"></th:block>&nbsp;&nbsp;</a></span>
                                    <a class='text-white' href="javascript:void(0)" th:onclick="fn_deleteFileList([[${item.fileid}]],[[${item.fileIdntfcKey}]])">X</a>
                                </span>
                            </th:block>
                        </th:block>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-block-small">
        <button type="button" class="btn btn-inverse m-r-5" onclick="gridHelper1.resetListContent()">목록</button>
        <button type="button" class="btn btn-primary" onclick="rsltRptln.doSave()">저장</button>
    </div>
</form>
<script th:inline="javascript">
    var rsltRptln = {
    	init: function(){

    		this.setValid();
    	} ,
        setValid: function() {

            var validator = $('#rsltRptlnFrm').validate({
                rules: {
                	gnrlzOpnn : {required: true, maxlength: 1000},
                	cn        : {required: true, maxlength: 1000},
                	grdCd     : {required: true}
                },
                messages: {
                	gnrlzOpnn : {required: "이행확인심사 종합의견을 입력해주세요.", maxlength: "이행확인심사 종합의견은 1000자 이하여야 합니다."},
                	cn        : {required: "보완개선 계획을 입력해주세요."    , maxlength: "보완개선 계획은 1000자 이하여야 합니다."},
                	grdCd     : {required: "종합평가를 선택 해주세요."}
                }
            });
        },
    	doSave: function() {

            if(!($('#dtlTabFrm').valid())) return;
            if(!($("#rsltRptlnFrm").valid())) return;

            if(!confirm("저장 하시겠습니까?")){return;}

            var url ="";
            var keyid = $("#dmndid").val();

            if("" == keyid || null == keyid) {
                url +="insertRsltRptln.do";
            }else{
                url +="updateRsltRptln.do";
            }

            var param = $("#rsltRptlnFrm").serialize();
            var hr= $("#vstHr").val();
            var mnt= $("#vstMnt").val();
            param+= "&vstDe="+$("#vstDe").val() + "&vstHr="+hr+"&vstMnt="+mnt;

            if(displayWorkProgress()) {
                $.ajax({
                    url : url,
                    type: "POST",
                    cache: false,
                    dataType: "json",
                    data: param,
                    success: function(response) {
                        if(response.result == "success") {

                            alert(response.msg);
                            gridHelper1.resetListContent();

                        } else {
                            alert(response.msg);
                        }
                        closeWorkProgress();
                    }
                });
            }
        },
    };

    $(function() {
    	rsltRptln.init();

        $('#multiFileInput').change(function(event) {

            var objFile = document.querySelector('#multiFileInput');
            var formData = new FormData();
            var content = "";
            var uploadFileCnt = 0;
            for( i = 0 ; i < objFile.files.length ; i++) {
                formData.append("files", objFile.files[i]);
                uploadFileCnt++;
            }

            formData.append("filegrpid", $("#filegrpid").val());
            formData.append("filegrpNm", "dsgnPrgrm_file");

            $('#multiFileInput').val("");

            $.ajax({
                url : '/uploadMultipleFiles.do',
                processData : false,
                contentType : false,
                data : formData,
                type : 'POST',
                success : function(response) {
                    if(response.result == 'fail'){
                        alert(response.msg);
                    }else{
                        if($("#filegrpid").val()=='0' || $("#filegrpid").val()=='' || $("#filegrpid").val()==null){
                            debugger;
                            $("#filegrpid").val( response[0].filegrpid );
                        }

                        for(i = 0 ;i < response.length; i++ ){
                            content = "<div class='label label-inverse text-white' id='"+response[i].fileid+"'><a href=javascript:downloadFileByFileid('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"') class='text-white'>"+response[i].orginlFileNm+"&nbsp;&nbsp;</a>";
                            content +="<a href=javascript:fn_deleteFileList('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"') class='text-white'>X</a></div>";
                            $('#fileListArea').append(content);
                        }
                    }
                }
            })

            if (detectBrowser() == "other") {
                $("#atchFile").val("");
            } else {
                $("#atchFile").replaceWith( $("#atchFile").clone(true))
            }
        });
    });

    /* 파일삭제 */
    function fn_deleteFileList(fileid, fileIdntfcKey){
        if(!confirm("파일을 삭제하시겠습니까?")){return;}
        fn_deleteFile(fileid, fileIdntfcKey);
        $("#"+fileid).remove();
        $('#multiFileInput').val('');
    }

    function fn_deleteFile(fileid, fileIdntfcKey){

        var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey;
          $.ajax({
            url : deleteFileUrl,
            type: 'GET',
            cache : false,
            dataType: 'json',
            success : function (data){
                if(data.result=="success"){
                    $("#"+fileid).remove();
                    $('#filegrpid').val(0);
                    $('#multiFileInput').val('');
                    alert("파일삭제가 완료 되었습니다.");
                }else{
                    alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
                }
            },
            error : function (error){
            }
         })
    };


</script>