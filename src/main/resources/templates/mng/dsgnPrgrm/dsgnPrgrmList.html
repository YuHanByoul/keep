<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
    layout:decorator="layout/mng/mainLayout"
>

<body>
<div layout:fragment="content">
<style>
.hide{display:none;}
</style>

<!-- Page-body start -->
<link rel="stylesheet" type="text/css" href="/files/bower_components/bootstrap-daterangepicker/daterangepicker.css">
<div class="page-body">
    <div class="row">

        <div class="col-12">
            <form name="searchFrm" id="searchFrm" action="" onsubmit="return false;" class="card">
                <input type="hidden" id="searchStartDsgnDe" name="searchStartDsgnDe" value="" />
                <input type="hidden" id="searchEndDsgnDe"   name="searchEndDsgnDe"   value="" />
            <!-- 필터 부분 -->
                <div class="card-block-small">
                    <!-- 키워드 filter -->
                    <div class="row">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="mb-0 form-group row">
                                <span class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>키워드</strong></span>
                                <div class="input-group input-group-sm input-group-dropdown mb-0">

                                    <select name="searchType" id="searchType" class="form-select form-control ">
                                      <option value="">- 전체 -</option>
                                      <option value="prgrmNm">프로그램명</option>
                                      <option value="instNm">기관명</option>
                                      <option value="dsgnNo">지정번호</option>
                                    </select>
                                    <input type="text" name="searchKeyword" id="searchKeyword" class="form-control" aria-label="Text input with dropdown button">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="mb-0 form-group row">
                                <span class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>지정상태</strong></span>
                                <div class="col-sm-12">
                                  <span kattr:select_code="searchSttsCd" th:attr="grpCd=132" firstOptTxt="- 전체 -" addClass="form-select form-select-sm form-control-sm" isAdmin="true">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="mb-0 form-group row">
                                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="filterSearchSelectDate"><strong>지정일</strong></label>
                                <div class="col-sm-12">
                                    <input type="text" name="filterSearchSelectDate" id="filterSearchSelectDate" class="form-control form-control-sm" value=""/>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="mb-0 form-group row">
                                <span class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>차수</strong></span>
                                <div class="col-sm-12">
                                    <input class="form-control form-control-sm" name="searchDsgnCycl" id="searchDsgnCycl" type="text" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- //키워드 filter -->
                    <!-- 키워드 filter-btn -->
                    <div class="mt-1 p-t-20 text-center border-top">
                        <button class="btn btn-disabled m-r-5" onclick="fn_init()" >초기화</button>
                        <button class="btn btn-primary" onclick="fn_searchForm()">검색</button>
                    </div>
                </div>
            </form>
        </div>
        <!-- //필터 부분 -->
        <div class="col-12">
            <div class="card">
                <div class="row p-20 p-b-0">
                    <div class="col-12 col-md-6 mb-2 mb-md-0">
                        <h5><strong>지정 프로그램 검색결과</strong></h5>
                    </div>
                    <div class="col-12 col-md-6 text-right">
                        <th:block sec:authorize-url="/mng/dsgnPrgrm/selectDsgnPrgrmList.do">
                            <button type="button" class="btn btn-primary waves-effect waves-light m-r-5"  onclick='openSrngCalenderModal()'>심사일정 캘린더</button>
                        </th:block>
                        <th:block sec:authorize-url="/mng/dsgnPrgrm/selectDsgnPrgrmList.do">
                            <button type="button" class="btn btn-primary waves-effect waves-light m-r-5" onclick='clearBlackList()' >엑셀다운로드</button>
                        </th:block>
                    </div>
                </div>
                <div class="card-block-small">
                    <div class="dt-responsive table-responsive">
                        <div  class="dataTables_wrapper dt-bootstrap4">
                            <table id="jsGrid" class="table-responsive"></table>
                            <div id="listPager" class="text-center"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div id="contentPanel" style="display:none"></div>
    </div>
</div>

<!-- 지정정보 변경 팝업 -->
<div class="modal fade" id="dsgnInfoChgListPopup" aria-hidden="true" data-bs-backdrop="static"></div>

<!-- 심사일정 팝업 -->
<div class="modal fade" id="srngCalenderPopup" aria-hidden="true" data-bs-backdrop="static"></div>

<!-- Date-range picker js -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="/files/bower_components/bootstrap-daterangepicker/daterangepicker.js"></script>
<script th:inline="javascript">
  var gridHelper1;

  $(function(){
      gridHelper1 = new GridHelper('jsGrid','contentPanel');
      writeJsGridData();

      $("#filterSearchSelectDate").daterangepicker({
          autoUpdateInput: false,
          locale: {
              format: "YYYY-MM-DD",
          },
      });

      $("#filterSearchSelectDate").on('apply.daterangepicker', function(ev, picker) {
          $("#searchStartDsgnDe").val(picker.startDate.format('YYYY-MM-DD'));
          $("#searchEndDsgnDe").val(picker.endDate.format('YYYY-MM-DD'));
          $(this).val(picker.startDate.format('YYYY-MM-DD') + ' - ' + picker.endDate.format('YYYY-MM-DD'));
      });

  });

  function fn_init() {
    $("#searchKeyword").val("");
    $("#searchType").val("");
    $("#searchSttsCd").val("");
    $("#searchStartDsgnDe").val("");
    $("#searchEndDsgnDe").val("");
    $("#searchDsgnCycl").val("");
    $("#filterSearchSelectDate").val("");
  }
  //검색버튼
    function fn_searchForm(){
        gridHelper1.resetListContent();
    }

  //목록
    function writeJsGridData(){
        $("#jsGrid").jsGrid({
            height: "auto",
            width: "100%",
            autoload: true,
            sorting: true,
            paging: true,
            pagerContainer: "#listPager",
            pagerFormat: "{first} {prev} {pages} {next} {last}",
            pagePrevText: "이전",
            pageNextText: "다음",
            pageFirstText: " < 처음 ㅣ",
            pageLastText: " | 마지막 >",
            pageSize: 10,
            pageButtonCount: 10,
            pageLoading: true,
            pageIndex: 1,
            noDataContent: "데이터가 없습니다.",
            cellRenderer:true ,

            controller: {
                loadData: function (filter) {
                    var data = $.Deferred();

                    var formData = $('#searchFrm').serializeArray();
                    var params = [
                            {name: "pageNumber", value: filter.pageIndex},
                            {name: "rowPerPage", value: filter.pageSize},
                    ]

                    if(filter.sortField != undefined){
                        params.push({name: "orderField", value: filter.sortField});
                        params.push({name: "orderDirection", value: filter.sortOrder});
                    }else{
                        params.push({name: "orderField", value: 'dsgn_bgng_de'});
                    }

                    formData = formData.concat(params);

                    $.ajax({
                      type: "GET",
                      contentType: "application/json; charset=utf-8",
                      url: "/mng/dsgnPrgrm/selectDsgnPrgrmList.do",
                      dataType: "json",
                      data: formData
                    }).done(function(response){

                        var da = {
                                data : escapeGridData(response.list)
                                ,itemsCount : response.totalCount
                            };
                      data.resolve(da);
                    });
                    return data.promise();
                },
            },
            fields: [
                 { name: 'prgrmid', css:'hide'}
                ,{ name: 'hstryid', css:'hide'}
                ,{ title: 'No.'           ,name: 'rowNumber',     type: "number", width : "80", align:"center",  sorting :false }
                ,{ title: '차수'          ,name: 'dsgnCycl',      type: "number", width : "40", align:"center"}
                ,{ title: '지정번호'      ,name: 'dsgnNo',        type: "text", width: "60", align:"center"}
                ,{ title: '프로그램명'    ,name: 'prgrmNm',       type: "text", width: "100", align:"left"}
                ,{ title: '기관명'        ,name: 'instNm',        type: "text", width: "100", align:"left"}
                ,{ title: '지정상태'      ,name: 'sttsCdNm',      type: "text", width: "60", align:"center"}
                ,{ title: '변경신청'      ,name: 'chgAplyCnt',    type: "text", width: "60", align:"center"}
                ,{ title: '운영결과'      ,name: 'operRsltCnt',   type: "text", width: "60", align:"center"}
                ,{ title: '이행심사'      ,name: 'implmntIdntyCnt',  type: "text", width: "60", align:"center"}
                ,{ title: '이의신청'      ,name: 'objcInfoCnt',   type: "text", width: "60", align:"center"}
                ,{ title: '지정기간'      ,name: 'dsgnPrd',       type: "text", align:"center" }
            ],

            rowClick: function(args) {

                if(args.event.originalEvent.target.cellIndex == 0 || isNaN(args.event.originalEvent.target.cellIndex)) return;

                var detailUrl = "/mng/dsgnPrgrm/dsgnPrgrmDetailForm.html?prgrmid=" + args.item.prgrmid+"&hstryid="+args.item.hstryid;
                //프로그램명 클릭 - 상세전환
                if(args.event.target.cellIndex==5){
                  detailUrl+="&tabIndex=1";
                  gridHelper1.loadContent(detailUrl);
                  gridHelper1.rowClick(args);
                }

                //지정상태 클릭 - 지정정보 변경 모달 팝업
                else if(args.event.target.cellIndex==7){

                  openDsgnInfoChgModal(args);
                }
                //변경신청 클릭 - 변경신청 tab으로 화면 전환
                else if(args.event.target.cellIndex==8){
                  detailUrl+="&tabIndex=2";
                  gridHelper1.loadContent(detailUrl);
                    gridHelper1.rowClick(args);
                }
                //운영결과 클릭 - 운영결과 tab으로 화면 전환
                else if(args.event.target.cellIndex==9){
                  detailUrl+="&tabIndex=3";
                  gridHelper1.loadContent(detailUrl);
                    gridHelper1.rowClick(args);
                }
                //이행심사 클릭 - 이행심사 tab으로 화면 전환
                else if(args.event.target.cellIndex==10){
                  detailUrl+="&tabIndex=4";
                  gridHelper1.loadContent(detailUrl);
                    gridHelper1.rowClick(args);
                }
                //이의신청 클릭 - 이의신청 tab으로 화면 전환
                else if(args.event.target.cellIndex==11){
                  detailUrl+="&tabIndex=5";
                  gridHelper1.loadContent(detailUrl);
                    gridHelper1.rowClick(args);
                }

            },
            onPageChanged: function(args) {
                selectedItems = [];
            }
        });

        var selectItem = function(item) {
            selectedItems.push(item);
            if($(".singleCheckbox").length == $(".singleCheckbox:checked").length) {
                $("#selectAllCheckbox").prop("checked", true);
            } else {
                $("#selectAllCheckbox").prop("checked", false);
            }
        };

        var unselectItem = function(item) {
            selectedItems = $.grep(selectedItems, function(i) {
            return i !== item;
            });
            if(selectedItems.length == 0) {
                $('#selectAllCheckbox').attr('checked', false);
            }
            if($(".singleCheckbox").length == $(".singleCheckbox:checked").length) {
                $("#selectAllCheckbox").prop("checked", true);
            } else {
                $("#selectAllCheckbox").prop("checked", false);
            }
        };

        $("#selectAllCheckbox").click(function(item) {
            selectedItems = [];
            if(this.checked) { // check select status
                $('.singleCheckbox').each(function() {
                    this.checked = true;
                    selectItem($(this).parent().next().text());
                });
            }else {
                $('.singleCheckbox').each(function() {
                    this.checked = false;
                    unselectItem(item);
                });
                selectedItems = [];
            }
        });
    }

    //fn_openSrngCalender
    //담당자 변경 팝업
    var srngCalenderModal;
    var openSrngCalenderModal = () => {

        var url = "/mng/dsgnPrgrm/sprtgrpCalenderPopup.html";    //회원검색

        $("#srngCalenderPopup").load(url, function(response, status, xhr) {
            if (status == "success") {
            	srngCalenderModal = new bootstrap.Modal($('#srngCalenderPopup'));
            	srngCalenderModal.show();
            }
        });
    }

  //지정 정보 변경/재지정
    var dsgnInfoChgListModal;
    var openDsgnInfoChgModal = (args) => {

      var vPrgrmid = args.item.prgrmid;
      var vHstryid = args.item.hstryid;
        var url ="/mng/dsgnPrgrm/dsgnInfoChgPopup.html?prgrmid="+vPrgrmid+"&hstryid="+vHstryid+"&callSe=dsgnInfoChgA";

        $("#dsgnInfoChgListPopup").load(url, function(response, status, xhr) {
            if (status == "success") {
                dsgnInfoChgListModal = new bootstrap.Modal($('#dsgnInfoChgListPopup'));
                dsgnInfoChgListModal.show();
            }
        });
    }

</script>
</div>
</body>
</html>
