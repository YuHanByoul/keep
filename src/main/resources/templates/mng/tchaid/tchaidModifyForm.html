<form id="modifyFrm" action="" onsubmit="return false;">
   <div class="tab-pane active" id="tablist01" role="tabpanel">
       <div class="card-header p-t-0 p-b-0">
           <h3 class="sub-title"><strong>기본 정보</strong></h3>
       </div>
       <div class="card-block-small p-t-0">
           <div class="row">
               <div class="col-lg-6 mb-3">
                   <div class="mb-0 form-group required">
                       <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>교구유형</strong></div>
                       <div class="col-12">
                           <span kattr:select_code="tchaidTypeCd" grpCd="184" firstOptTxt="-선택 -"  addClass="form-select form-select-sm"  th:attr="selectedCd=${tchaidVo.tchaidTypeCd}"></span>
                       </div>
                   </div>
               </div>
               
               <div class="col-lg-6 mb-3">
                   <div class="mb-0 form-group required">
                       <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>교육유형</strong></div>
                       
                       <div class="form-radio">
                           <span kattr:radio_code="eduTypeCd" grpCd=187 th:attr="selectedCd=${tchaidVo.eduTypeCd}" isAdmin="true">
                       </div>
                       
                   </div>
               </div>
               
           </div>
           <div class="row">
               <div class="col-12 mb-3">
                   <div class="mb-0 form-group required">
                       <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="tchaidNm"><strong>교구명</strong></label>
                       <div class="col-12">
                           <input type="text" class="form-control form-control-sm" name="tchaidNm" id="tchaidNm" th:value="${tchaidVo.tchaidNm}" />
                       </div>
                   </div>
               </div>
           </div>
           
           <div class="row">
               <div class="col-12 mb-3">
                   <div class="mb-0 form-group required">
                       <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>교육주제</strong></div>
                       
                       <div id="sbjctArea" >
                       
                       <th:block th:each="sbjct,stat : ${mySbjctLsit}">
                       <div class="row mb-3 mb-md-2 subject-form" th:id="subject+${stat.count}">
                           <div class="col-md-auto">
                               <button class="input-group-text btn btn-primary btn-sm"  onclick="plusSubjectForm()" >+</button>
                               <button class="input-group-text btn btn-primary btn-sm"  th:count ="${stat.count}"  th:onclick="removeSubjectForm(this.getAttribute('count'))" th:disabled="${stat.count == 1}">-</button>
                           </div>
                           <div class="col-md-5 mt-1 mt-md-0">
                               <select th:id="subjectSelect+${stat.count}" name="eduSbjctCds" class="form-select form-select-sm" th:count ="${stat.count}" th:onchange="duplCheck(this.getAttribute('count'))">
                                   <option value="" >-선택-</option>
                                   <option th:each="item : ${sbjctCdLsit}"   th:value="${item.CD}" th:selected="${sbjct.eduSbjctCd == item.CD}"> <th:block th:text="${item.CD_NM}" /> </option>
                               </select>
                           </div>
                       </div>
                       </th:block>
                       
                       </div>
                       
                   </div>
               </div>
           </div>
           
           <div class="row">
               <div class="col-12 mb-3">
                   <div class="mb-0 form-group required">
                       <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>교육대상</strong></div>
                       <div class="border-checkbox-section">
                       <span kattr:check_code="eduTrgtCds" grpCd="185"  th:attr="selectedCd=${mytrgtCds}" isAdmin="true">
                       </div>
                   </div>
               </div>
           </div>
           <div class="row">
               <div class="col-lg-6 mb-3">
                   <div class="mb-0 form-group required">
                       <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>모둠구성</strong></div>
                       <div class="col-12">
                           <span kattr:select_code="teamCmpstnCd" th:attr="selectedCd=${tchaidVo.teamCmpstnCd}" grpCd="186" firstOptTxt="-선택 -"  addClass="form-select form-select-sm" ></span>
                       </div>
                   </div>
               </div>
               <div class="col-lg-6 mb-3">
                   <div class="mb-0 form-group required">
                       <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>사용여부</strong></div>
                       <div class="col-12">
                           <div class="form-radio">
                               <div class="radio radio-inline">
                                   <label class="mb-0 form-label">
                                       <input type="radio" name="useYn" value="Y" th:checked ="${tchaidVo.useYn eq 'Y'}" >
                                       <i class="helper"></i>사용
                                   </label>
                               </div>
                               <div class="radio radio-inline">
                                   <label class="mb-0 form-label">
                                       <input type="radio" name="useYn" value="N" th:checked ="${tchaidVo.useYn eq 'N'}">
                                       <i class="helper"></i>사용안함
                                   </label>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       </div>
       
       <div class="card-header p-t-0 p-b-0">
           <h3 class="sub-title"><strong>교구 구성</strong></h3>
       </div>
       
       <div class="card-block-small p-t-0" id="cmpntArea" >
       
           <th:block th:each="item,stat : ${myCmpntLsit}">
           <div class="row mb-3 mb-md-2 cmpnt-form " id="cmpntForm1">
               <div class="col-md-auto align-self-end">
                   <button type="button" class="input-group-text btn btn-primary btn-sm" disabled>+</button>
                   <button type="button" class="input-group-text btn btn-primary btn-sm" disabled>-</button>
               </div>
               <div class="col-md-5 mt-1 mt-md-0 required" >
                   <div class="col-form-label col-sm-12 p-t-0 pb-1"><strong>구성품 선택</strong></div>
                   
                   <div class="col-12" >
                      <input type="text" class="form-control form-control-sm" th:value="${item.cmpntNm}" readonly style="color:white;background-color:#15875f;">
                   </div>
                   
               </div>
               <div class="col-md-auto mt-1 mt-md-0">
                   <div class="col-form-label col-sm-12 p-t-0 pb-1"><strong>수량</strong></div>
                   <div class="col-12">
                       <input type="number"  class="form-control form-control-sm" th:value="${item.qntyCmpstn}" aria-label="수량" style="width:60px" readonly>
                   </div>
               </div>
           </div>
           </th:block>
           
       </div>

       <div class="card-block-small">
       
           <th:block sec:authorize-url="/mng/tchaid/updateTchaid.do">
           <button type="button" class="btn btn-primary" onclick = "save()" >저장</button>
           </th:block>
           <button type="button" class="btn btn-disabled m-r-5" onclick="javascript:gridHelper1.removeHighlight();gridHelper1.toggleContent();">취소</button>
           <th:block sec:authorize-url="/mng/tchaid/deleteTchaid.do">
           <button type="button" class="btn btn-inverse" onclick = "deleteTchaid()">삭제</button>
           </th:block>
           
       </div>
       
   </div>
</form>

<script type="text/javascript" src="/files/assets/pages/advance-elements/select2-custom.js"></script>


<script  id="subjectFrm" type="text/x-handlebars-template">

    <div class="row mb-3 mb-md-2 subject-form" id="subject{{frmNum}}">
         <div class="col-md-auto">
            <button class="input-group-text btn btn-primary btn-sm"  onclick="plusSubjectForm()" >+</button>
            <button class="input-group-text btn btn-primary btn-sm"  onclick="removeSubjectForm('{{frmNum}}')">-</button>
         </div>
         <div class="col-md-5 mt-1 mt-md-0">

             <select id="subjectSelect{{frmNum}}" name="eduSbjctCds" class="form-select form-select-sm" onchange="duplCheck('{{frmNum}}')">
                 <option value="" >-선택-</option>
                 {{#each list}}
                 <option value="{{CD}}">{{CD_NM}}</option>
                 {{/each}}
             </select>

         </div>
     </div>
</script>
<script th:inline="javascript">

    /*<![CDATA[*/ 
	var sbjctCdLsit = /*[[${sbjctCdLsit}]]*/null; 
	var cmpntLsit = /*[[${cmpntLsit}]]*/null;
	var tchaidVo = /*[[${tchaidVo}]]*/null; 
	var mySbjctLsit = /*[[${mySbjctLsit}]]*/null; 
	var mytrgtLsit = /*[[${mytrgtLsit}]]*/null; 
	var myCmpntLsit = /*[[${myCmpntLsit}]]*/null; 
    /*]]>*/
    
    var subjectLength = 0; 
    var subjectNum = []; 
     
    var cmpntLength = 0; 
    var cmpntNumArr = [1]; 
    var cmpntNum = 0;
	
    $(function(){

    	if(sbjctCdLsit!= null && sbjctCdLsit.length > 0 ){
	    	subjectLength = sbjctCdLsit.length 
        }
        //등록되어 있는 교육 주제 폼 넘버   
    	for(var i = 0;i < mySbjctLsit.length;i++){
    		subjectNum.push((i+1));
        }
        
    })
    
    
    
    duplCheck=(frmNum)=>{
        var isDupl = false;
    	var selectCd = $("#subjectSelect"+frmNum).val();
    	if(selectCd==""){return;}

    	$(".subject-form").each(function(){
    		var itemId = ($(this).attr("id")).replace("subject","")
        	if( itemId != frmNum  &&  $("#subjectSelect"+itemId).val() == selectCd){
        		isDupl = true;
            }
        })
        if(isDupl){
        	$("#subjectSelect"+frmNum).val("");
            alert("교육주제는 중복 선택 할 수 없습니다."); 
            return; 
        }
    }
    
    plusSubjectForm =()=>{

    	var subjectFormCnt = 0 ; 
    	$(".subject-form").each(function(){	subjectFormCnt++ })
    	
    	if(subjectFormCnt >= subjectLength){
        	alert("더이상 생성 할수 없습니다.");
        	return;
        }
    	var maxValue = Math.max.apply(null, subjectNum);
    	subjectNum.push(maxValue+1);
        
	    var source = $("#subjectFrm").html();
        var template = Handlebars.compile(source);
        var data = {
                    'frmNum' : maxValue+1
                    ,'list':sbjctCdLsit 
                   };
        $("#sbjctArea").append(template(data));
    }

    removeSubjectForm=(frmNum)=>{
    	$("#subject"+frmNum).remove();
    	var filterArr = subjectNum.filter(function(data) {return data != frmNum;});
    	subjectNum = filterArr;
    }

    var validator= $("#modifyFrm").validate({
		    onsubmit: false,
	          rules: {
	        	     tchaidTypeCd :   { required: true }
	        	    ,tchaidNm     :   { required: true , maxlength: 100}
	        	    ,eduTrgtCds     :   { required: true }
	        	    ,teamCmpstnCd     :   { required: true }
	            },
	            messages: {
	        	     tchaidTypeCd : { required: " 교구 유형을 선택 해주십시오" }
	        	    ,tchaidNm     : { required: "교구명을 입력해주십시오" ,maxlength :"교구명은  100자를 넘을 수 없습니다."}
	        	    ,eduTrgtCds   : { required: "교육대상을 체크해주십시오" }
	        	    ,teamCmpstnCd : { required: "모둠구성을 선택 해주십시오" }
	            }
	})
    
 	function save(){
     	
	 	if(!($("#modifyFrm").valid())) return;


  	 	var subjectParamArr=[];
  	 	var errorFrmNum = 0;
  	 	if(subjectNum.length<=0){
  	  	 	alert("교육 주제를 선택해주십시오.")
  	  	 	return;
  	  	}else{
  	  	    for(var i=0 ; i<subjectNum.length;i++){
  	  	        subjectParamArr.push($("#subjectSelect"+subjectNum[i]).val())
	  	  	    if($("#subjectSelect"+subjectNum[i]).val() == ""){
	  	  	        errorFrmNum = (errorFrmNum > 0)? errorFrmNum:subjectNum[i];
	  	  	  	}
  	  	    }
  	  	}
  	  	  	
  	  	if(errorFrmNum > 0){
  	  	   alert("교육 주제를 선택해주십시오.");
  	  	   showErrorMark("#subjectSelect"+errorFrmNum);
           return;
  	  	}

  	    var errorCmpntFrmNum = 0;
  	    var cmpntCntErrorNum = 0;
        for(var i=0 ; i < cmpntNumArr.length;i++){

            if($("#cmpnt"+cmpntNumArr[i]).val() == null || $("#cmpnt"+cmpntNumArr[i]).val() == "" || $("#cmpnt"+cmpntNumArr[i]).val() == null){
            	errorCmpntFrmNum = cmpntNumArr[i];
                break;
            }
            
            if($("#cmpntCnt"+cmpntNumArr[i]).val() == null || $("#cmpntCnt"+cmpntNumArr[i]).val() == "" || $("#cmpntCnt"+cmpntNumArr[i]).val() < 0){
            	cmpntCntErrorNum = cmpntNumArr[i];
                break;
            }
        }
        
  	 	if(!confirm("저장하시겠습니까?")) return;

  	  	var trgtParamArr=[]
  	  	$("input[name=eduTrgtCds]").each(function(){
  	  	  	if($(this).is(":checked")){trgtParamArr.push($(this).val())}
  	  	})
  	  	
  	 	let params={
  	  	    tchaidid  : tchaidVo.tchaidid, 
  	 		tchaidTypeCd : $("#tchaidTypeCd").val(),
  	 		tchaidNm : $("#tchaidNm").val(),
  	 		useYn : $("input[name=useYn]:checked").val(),
  	 		eduTypeCd : $("input[name=eduTypeCd]:checked").val(),
  	 		teamCmpstnCd : $("#teamCmpstnCd").val(),
  	 		eduSbjctCds : subjectParamArr,
  	 		eduTrgtCds : trgtParamArr,
  	 		qntyInvntry :0
  	  	}
  	 	
	    if(displayWorkProgress()){
			$.ajax({
				url : "/mng/tchaid/updateTchaid.do",
				type: 'POST',
				cache : false,
				traditional : true, //필수
				dataType: 'json',
				contentType: "application/json; charset=utf-8",
				data : JSON.stringify(params),
				success : function (data){
					if(data.result=="success"){
						alert(data.msg);
						//clickedTchaidid = tchaidVo.tchaidid;
                        //var curPage = $("#jsGrid").jsGrid("option", "pageIndex");
                        //$("#jsGrid").jsGrid("openPage", curPage);
						gridHelper1.resetPageContent();
					}else{
						alert(data.msg);
					}
					closeWorkProgress();
				}
			});
		}
	}
	
    deleteTchaid=()=>{
        
        if(!confirm("삭제 하시겠습니까?")) return;
        
        if(displayWorkProgress()){
            $.ajax({
                url : "/mng/tchaid/deleteTchaid.do",
                type: 'POST',
                cache : false,
                traditional : true, //필수
                dataType: 'json',
                data : {tchaidid  : tchaidVo.tchaidid },
                success : function (data){
                    if(data.result=="success"){
                        alert(data.msg);
                        gridHelper1.resetListContent();
                    }else{
                        alert(data.msg);
                    }
                    closeWorkProgress();
                }
            });
        }
   }
    
</script>