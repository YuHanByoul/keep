<!--탭영역 start -->
<div class="tab-content tabs p-t-20">

    <div class="tab-pane active" id="updateRecord" role="tabpanel">
        <div class="card-header p-t-0 p-b-0">
            <h3 class="sub-title"><strong>상태변경 이력</strong></h3>
        </div>
        <div class="card-block-small p-t-0">
            <div class="col-12 table-border-style">
                <div class="col-12 table-responsive" id="resveReqstHstryGrid">
                    <div class="table table-framed table-bordered">
                    </div>
                </div>
                <div id="resveReqstHstryListPager" class="text-center"></div>
            </div>
        </div>
    </div>

    <div id="resveReqstHstryGridPanel" style="display: none" class="card"></div>
</div>

<div class="modal fade" id="resveCnclRsnPopup" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content type_2">
            <div class="modal-header">
                <h4 class="modal-title">사유확인</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" >
                    <span aria-hidden="true"></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card m-b-10">
                    <div class="card-block-small">
                        <div class="mb-0 form-group row">
                            <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="reserveCancelCompanionReasonPopupReason"><strong>사유</strong></label>
                            <div class="col-12">
                                <textarea rows="5" cols="5" class="form-control form-control-sm" 
                                   id="reserveCancelCompanionReasonPopupReason" name="reserveCancelCompanionReasonPopupReason" readonly=""></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary waves-effect waves-light" data-bs-dismiss="modal" aria-label="Close">확인</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">

    // 사유확인 팝업
    var resveCnclRsnPopupUrl = "/mng/resveReqst/resveCnclRsnPopup.html";
    var resveCnclRsnAddModal;

    var selectedItems = [];
    var gridHelper1;
    $(function(){
        gridHelper1 = new GridHelper('resveReqstHstryGrid','resveReqstHstryGridPanel');
        writeSpceMemGridData();
    });

    var fn_openResveCnclRsnModal = (hstryid) => {
        
        var items = $("#resveReqstHstryGrid").jsGrid("option", "data");
        for(var i = 0; i < items.length; i++) {
            if(items[i].hstryid == hstryid){
                let reasonStr="";
            	if( items[i].cnclRsnCd != null && items[i].cnclRsnCd=="215104" ){//기타
            		reasonStr = (items[i].rsvtCnclRsn==null || items[i].rsvtCnclRsn=="")?items[i].cnclRsnCdNm:items[i].rsvtCnclRsn;
                }else if( items[i].cnclRsnCd != null && items[i].cnclRsnCd=="215102" ){//예약 거절
            		reasonStr = (items[i].rsvtRejectRsn==null || items[i].rsvtRejectRsn=="")?items[i].cnclRsnCdNm:items[i].rsvtRejectRsn;
                }else if( items[i].cnclRsnCd != null && items[i].cnclRsnCd !="" ){
                	reasonStr = items[i].cnclRsnCdNm;
                }else if( items[i].rfndRejectRsnCd!=""&& items[i].rfndRejectRsnCd == "243103"){
            		reasonStr = (items[i].rfndRejectRsn==null || items[i].rfndRejectRsn=="")?items[i].rfndRejectRsnCdNm:items[i].rfndRejectRsn;
                }else{
                	reasonStr = items[i].rfndRejectRsnCdNm;
                }
                $("#reserveCancelCompanionReasonPopupReason").val(reasonStr);
                $("#resveCnclRsnPopup").modal("show");
            }
        }
    }
        
    function date2str(x, y) {
        var z = {
            m: x.getMonth() + 1,
            d: x.getDate(),
            H: x.getHours(),
            M: x.getMinutes(),
            S: x.getSeconds()
        };

        y = y.replace(/(m+|d+|H+|M+|S+)/g, function(v) {
            return ((v.length > 1 ? "0" : "") + z[v.slice(-1)]).slice(-2)
        });

        return y.replace(/(y+)/g, function(v) {
            return x.getFullYear().toString().slice(-v.length)
        });
    }

    function parseDate(strDate) {
        var _strDate = strDate;
        var _dateObj = new Date(_strDate);
        if (_dateObj.toString() == 'Invalid Date') {
            _strDate = _strDate.split('.').join('-');
            _dateObj = new Date(_strDate);
        }
        if (_dateObj.toString() == 'Invalid Date') {
            var _parts = _strDate.split(' ');

            var _dateParts = _parts[0];
            _dateObj = new Date(_dateParts);

            if (_parts.length > 1) {
                var _timeParts = _parts[1].split(':');
                _dateObj.setHours(_timeParts[0]);
                _dateObj.setMinutes(_timeParts[1]);
                if (_timeParts.length > 2) {
                    _dateObj.setSeconds(_timeParts[2]);
                }
            }
        }

        return _dateObj;
    }

    function writeSpceMemGridData(){
        $("#resveReqstHstryGrid").jsGrid({
            height: "auto",
            width: "100%",
            autoload: true,
            sorting: true,
            paging: true,
            pagerContainer: "#resveReqstHstryListPager", 
            pagerFormat: "{first} {prev} {pages} {next} {last}",
            pagePrevText: "이전",
            pageNextText: "다음",
            pageFirstText: " < 처음 ㅣ",
            pageLastText: " | 마지막 >",
            pageSize: 10,
            pageButtonCount: 10,
            pageLoading: true,
            pageIndex: 1,
            noDataContent: "데이터가 없습니다.",
            controller: {
                loadData: function (filter) {
                    var data = $.Deferred();

                    var formData = $('#searchManagerFrm').serializeArray();
                    var params = [
                        {name: "pageNumber", value: filter.pageIndex},
                        {name: "rowPerPage", value: filter.pageSize},
                        {name: "aplyid", value: aplyid[0]},
                    ]

                    if(filter.sortField != undefined){
                        params.push({name: "orderField", value: filter.sortField});
                        params.push({name: "orderDirection", value: filter.sortOrder});
                    }else{
                        params.push({name: "orderField", value: 'reg_dt'});
                    }
                    formData = formData.concat(params);

                    $.ajax({
                        type: "GET",
                        contentType: "application/json; charset=utf-8",
                        url: "/mng/resveReqst/selectResveReqstHstryList.do",
                        dataType: "json",
                        data: formData,
                    }).done(function(response){
                        var da = {
                            data : escapeGridData(response.list)
                            ,itemsCount : response.totalCount
                        };
                        data.resolve(da);
                    });
                    return data.promise();
                },
            },
            fields: [
                 {name: 'cnclRsnCd',     css:"hide"}
                ,{name: 'rsvtRejectRsn', css:"hide"}
                ,{name: 'rsvtCnclRsn',    css:"hide"}
                ,{name: 'rfndRejectRsnCd', css:"hide"}
                ,{name: 'rfndRejectRsn',   css:"hide"}
                ,{ title: '번호'   ,name: 'rowNumber'       ,type: "number", width : "80", align:"center",  sorting :false }
                ,{ title: '예약상태(결제상태)'   ,name: ''              ,type: "text" , width: "100" ,align:"center"
                    , itemTemplate: function(value, item){
                        return item.aplySttsCdNm+'('+item.stlmSttsCdNm+')';
                    }
                }
                ,{ title: '변경일시' ,name: 'mdfcnDt',  type: "text", width: "150", align:"center"
                    , itemTemplate: function(value, item){
                        return date2str(parseDate(item.mdfcnDt), 'yyyy-mm-dd HH:MM');
                    }
                }
                ,{ title: '처리자'   ,name: 'rgtrid'             ,type: "text" , width: "200" ,align:"center"
                    , itemTemplate: function(value, item){
                        return item.acnt+'('+item.nm+')';
                    }
                }
                ,{ title: '사유확인'   ,name: 'rsn' ,type: "text" , align:"center"
                    , itemTemplate: function(value, item){
                        var str = '-';
                        if( (item.cnclRsnCd != null  && item.cnclRsnCd != "")|| (item.rfndRejectRsnCd!=null && item.rfndRejectRsnCd!="" )){
                            str = '<div class="btn-group-sm text-center">\n' +
                            '<button type="button" class="btn btn-primary" onclick="fn_openResveCnclRsnModal('+item.hstryid+');">\n' +
                              '확인\n' +
                            '</button>\n' +
                            '</div>';
                        }
                        return str;
                    }
                }
            ]
        });
    }
</script>