<form id="insertForm">
    <input type="hidden" name="formid" id="formid" th:value="${formid}" />
    <!-- [탭] 문항정보 -->
    <div class="tab-pane" id="tab_02" role="tabpanel">
        <div class="card-block-small p-t-0">
            <div class="row align-items-center mb-1">
                <div class="col">
                    <strong class="d-inline-block">문항수 : <span id="totalQcnt"><th:block th:text="${#lists.size(list)}"/></span>개,</strong> 
                    <strong class="d-inline-block">배점 : <span id="totalScr" class="text-c-pink">
                        <span id="sumAltm"><th:block th:text="${totalAltm}"/></span>/<span><th:block th:text="${totScr}"/></span></span>
                    </strong>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-inverse btn-sm" onclick="addRow();">문항추가</button>
                </div>
            </div>
            <!-- 임시그리드 -->
            <div class="col-12 table-responsive">
                <table id="qTable" class="table table-framed">
                    <thead>
                    <tr>
                        <th class="text-center v-middle" style="width: 60px;">-</th>
                        <th class="text-center v-middle">문항구분</th>
                        <th class="text-center v-middle">문항</th>
                        <th class="text-center v-middle" style="width: 100px;">배점</th>
                        <th class="text-center v-middle" style="width: 100px;">순서</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.size(list) > 0}" th:each="list, i: ${list}">
                        <td class="v-middle text-center"><button class="input-group-text btn btn-disabled btn-sm" aria-label="delete" onclick="removeRow(this); return false;">X</button></td>
                        <td class="v-middle text-center">
<!--                             <input type="text" class="form-control form-control-sm" name="qitemSeCdArr" id="qitemSeCdArr" th:value="${list.qitemSeCd}"> 221 -->
                            <span kattr:select_code="qitemSeCdArr" th:attr="selectedCd=${list.qitemSeCd}" grpCd="221" addClass="input-sm" isAdmin="true">
                        </td>
                        <td class="v-middle text-center">
                            <input type="text" class="form-control form-control-sm" title="문항" maxlength="100" name="qitemArr" id="qitemArr" th:value="${list.qitem}">
                        </td>
                        <td class="v-middle text-center">
                            <input type="text" class="form-control form-control-sm" title="배점" maxlength="3" name="altmArr" id="altmArr" th:value="${list.altm}" onkeyup="scrSum();">
                        </td>
                        <td class="v-middle text-center">
                            <input type="hidden" name="ordrArr" id="ordrArr" th:value="${list.ordr}">
                            <button class="input-group-text btn btn-primary btn-sm" onclick="rowUp(this); return false;"><i class="fa fa-angle-up me-0"></i></button>
                            <button class="input-group-text btn btn-primary btn-sm" onclick="rowDown(this); return false;"><i class="fa fa-angle-down me-0"></i></button>
                        </td>
                    </tr>
                    <tr th:unless="${#lists.size(list) > 0}">
                        <td class="v-middle text-center"><button class="input-group-text btn btn-disabled btn-sm" aria-label="delete" onclick="removeRow(this); return false;">X</button></td>
                        <td class="v-middle text-center">
                            <span kattr:select_code="qitemSeCdArr" grpCd="221" addClass="input-sm" isAdmin="true">
                        </td>
                        <td class="v-middle text-center">
                            <input type="text" class="form-control form-control-sm" title="문항" maxlength="100" name="qitemArr" id="qitemArr">
                        </td>
                        <td class="v-middle text-center">
                            <input type="text" class="form-control form-control-sm" title="배점" maxlength="3" name="altmArr" id="altmArr" onkeyup="scrSum();">
                        </td>
                        <td class="v-middle text-center">
                            <input type="hidden" class="form-control form-control-sm" name="ordrArr" id="ordrArr" value="1">
                            <button class="input-group-text btn btn-primary btn-sm" onclick="rowUp(this); return false;"><i class="fa fa-angle-up me-0"></i></button>
                            <button class="input-group-text btn btn-primary btn-sm" onclick="rowDown(this); return false;"><i class="fa fa-angle-down me-0"></i></button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!-- //임시그리드 -->
        </div>

        <div class="card-block-small">
            <button class="btn btn-disabled m-r-5" onclick="resetPageContent(); return false;">취소</button>
            <button class="btn btn-primary" onclick="fn_save(); return false;">저장</button>
        </div>
    </div>
    <!-- // [탭] -->
</form>

<script th:inline="javascript">
    var saveUrl = "/mng/score/saveQuestion.do";
    /*<![CDATA[*/
    var srngSize = /*[[${#lists.size(list) > 0 ? list[0].cnt : 0}]]*/null;
    var totScr = /*[[${totScr}]]*/null;
    /*]]>*/
    var checkScr = 0;
    $(document).ready(function(){
        $("#qTable").find("tr").find("input[name='altmArr']").each(function(){
        	checkScr += Number($(this).val());
        });
        $("#sumAltm").text(checkScr);
        $("#totalScr").attr("class", totScr == checkScr ? "text-c-blue" : "text-c-pink");
    });
    
    var moveRowUp = function(element) {
        if( element.prev().html() != null  && element.prev().attr("id") != "header"){
            element.insertBefore(element.prev());
            changNum();
        } else {
            alert("첫번째 행은 위로 이동할수 없습니다.");
            return;
        }
    };
    
    var moveRowDown = function(element) {
        if( element.next().html() != null ){
            element.insertAfter(element.next());
            changNum();
        }  else {
            alert("마지막 행은 아래로 이동할수 없습니다.");
            return;
        }
    };
    
    var changNum = function() {
        var num = 0;
        $('input[name=ordrArr]').each(function(){
            num++;
            $(this).val(num);
        });
    };
    
    function rowUp(obj) {
    	if (srngSize > 0) {
            alert("이미 심사된 양식은 수정할 수 없습니다.");
            return false;
        }
        var clickRow = $(obj).parent().parent();
        moveRowUp(clickRow);
    }
    
    function rowDown(obj) {
    	if (srngSize > 0) {
            alert("이미 심사된 양식은 수정할 수 없습니다.");
            return false;
        }
    	var clickRow = $(obj).parent().parent();
    	moveRowDown(clickRow);
    }
    
    var validator= $("#insertForm").validate({
    });
    
    // 테이블 로우 추가
    function addRow(obj) {
    	if (srngSize > 0) {
            alert("이미 심사된 양식은 수정할 수 없습니다.");
            return false;
        }
        var trObj = $("#qTable").find("tr:last");
        var newrow = trObj.clone();
        newrow.find("td > input").val("");
        newrow.insertAfter(trObj);
        $('input[name=ordrArr]').each(function(i){
            $(this).val(i+1);
        });
        $("#totalQcnt").text($("#qTable").find("tr").length-1);
    }

    // 테이블 로우 삭제
    function removeRow(obj) {
    	if (srngSize > 0) {
            alert("이미 심사된 양식은 수정할 수 없습니다.");
            return false;
        }
    	if ($(obj).parent().parent().index() == 0) {
    		alert("첫번째 행은 삭제할수 없습니다.");
    		return;
    	}
        $(obj).parent().parent().remove();
        $('input[name=ordrArr]').each(function(i){
            $(this).val(i+1);
        });
        $("#totalQcnt").text($("#qTable").find("tr").length-1);
        scrSum();
    }
    
    // 저장
    function fn_save(){
    	if (srngSize > 0) {
            alert("이미 심사된 양식은 수정할 수 없습니다.");
            return false;
        }
    	
        if(!isValid()) return;
    	if (checkScr != totScr) {
    		alert("배점을 확인해 주십시오.");
            return;
    	}
        
        if(!confirm("저장하시겠습니까?")) return;
        
        var data =  $("#insertForm").serialize();        
        
        if(displayWorkProgress()){
            $.ajax({
                url : saveUrl,
                type: 'POST',
                cache : false,
                dataType: 'json',
                data : data,
                success : function (data){
                    if(data.result=="success"){
                        alert(data.msg);
                        if (Number(formid) == 0) {
                            gridHelper1.resetListContent();                         
                        } else {
                            gridHelper1.resetPageContent();                         
                        }
                    }else{
                        alert(data.msg);
                    }
                    closeWorkProgress();
                }
            });
        }
    }

    function scrSum() {
        var sum = 0;
        $("#qTable").find("tr").find("input[name='altmArr']").each(function(){
        	$(this).val($(this).val().replace(/[^0-9]/g, ''));
        	sum += Number($(this).val());
        });
       	$("#sumAltm").text(sum);
       	if (totScr == sum) {
       		$("#totalScr").prop("class", "text-c-blue");
       	} else {
       		$("#totalScr").prop("class", "text-c-pink");
       	}
       	checkScr = sum;
    }
    
    function isValid() {
    	var result = false;
    	$("#qTable").find("tr").find("select,input").each(function(){
    		if ($(this).val() == "" || $(this).val() == null) {
    			alert($(this).attr("title") == "" ? "문항구분을 선택하십시오." : $(this).attr("title") + "을 입력하십시오.");
    			result = false;
    			return false;
    		}
    		result = true;
    	});
    	
    	return result;
    }
</script>