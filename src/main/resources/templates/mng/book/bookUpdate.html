<form id ="bookUpdateForm" onsubmit="return false;">
<input type="hidden" id="bookid"  name="bookid" th:value="${book.bookid}">
<input type="hidden" id="bookids" name="bookids" th:value="${book.bookid}">
		<!-- INSERT -->
		<div class="card-header p-b-0">
        	<h3 class="sub-title"><strong>우수환경도서 정보</strong></h3>
        </div>

		<!-- Tab Container Start -->
		<div class="card-block-small p-t-0">
		    <div class="row">
		        <div class="col-lg-6 mb-3">
		            <div class="mb-0 form-group required">
		                <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>교육주제</strong></div>
		                
		                <div id="sbjctArea" >
		                
                           <th:block th:each="sbjct,stat : ${bookSbjctList}">
                               <div class="row mt-1 subject-form " th:id="subject+${stat.count}" th:name="${stat.count}">
                                   <div class="col">
                                       <select th:id="subjectSelect+${stat.count}" name="eduSbjctCds" class="form-select form-select-sm" th:count ="${stat.count}" th:onchange="duplCheck(this.getAttribute('count'))">
                                           <option value="" >-선택-</option>
                                           <option th:each="item : ${sbjctCdLsit}"   th:value="${item.CD}" th:selected="${sbjct.eduSbjctCd == item.CD}"> <th:block th:text="${item.CD_NM}" /> </option>
                                       </select>
                                   </div>
                                   <div class="mt-sm-0" style="width:100px;">
                                       <button type="button" class="input-group-text btn btn-primary btn-sm"  onclick="plusSubjectForm()" >+</button>
                                       <button type="button" class="input-group-text btn btn-primary btn-sm"  th:count ="${stat.count}"  th:onclick="removeSubjectForm(this.getAttribute('count'))" th:disabled="${stat.count == 1}">-</button>
                                   </div>
                               </div>
                           </th:block>
                           
                           
                           
                       </div>
		            </div>
		        </div>
		        <div class="col-lg-6 mb-3">
		            <div class="mt-1 mb-0 form-group required">
		                <div class="form-label col-sm-12 col-form-label p-t-0 pb-1"><strong>교육대상</strong></div>
		                <span kattr:select_code="eduTrgtCd" grpCd="178" firstOptTxt="- 선택 -" isAdmin="true" th:attr="selectedCd=${book.eduTrgtCd}"></span>
		            </div>
		        </div>
		    </div>
		    <div class="row">
		        <div class="col-lg-6 mb-3">
		            <div class="mb-0 form-group">
		                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="writr"><strong>작가(글)</strong></label>
		                <div class="col-12">
		                    <input type="text" class="form-control form-control-sm" name="writr" id="writr" placeholder="작가(글)" th:value="${book.writr}"/>
		                </div>
		            </div>
		        </div>
		        <div class="col-lg-6 mb-3">
		            <div class="mb-0 form-group">
		                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="writrPictr"><strong>작가(그림)</strong></label>
		                <div class="col-12">
		                    <input type="text" class="form-control form-control-sm" name="writrPictr" id="writrPictr" placeholder="작가(그림)" th:value="${book.writrPictr}"/>
		                </div>
		            </div>
		        </div>
		    </div>
		    <div class="row">
		        <div class="col-lg-6 mb-3">
		            <div class="mb-0 form-group">
		                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="plscmpn"><strong>출판사</strong></label>
		                <div class="d-flex align-items-center">
		                    <div class="col">
		                        <input type="text" class="form-control form-control-sm" name="plscmpn" id="plscmpn" placeholder="출판사" th:value="${book.plscmpn}"/>
		                    </div>
		                    <span class="ms-3">년</span>
		                </div>
		            </div>
		        </div>
		        <div class="col-lg-6 mb-3">
		            <div class="mb-0 form-group">
		                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="amt"><strong>정가</strong></label>
		                <div class="d-flex align-items-center">
		                    <div class="col">
		                        <input type="text" class="form-control form-control-sm" name="amt" id="amt" placeholder="정가" th:value="${book.amt}"/>
		                    </div>
		                    <span class="ms-3">원</span>
		                </div>
		            </div>
		        </div>
		    </div>
            <div class="row">
                <div class="col-lg-6 mb-3">
                    <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="plscmpn"><strong>저작권</strong></label>
                        <div class="col-12">
                            <span kattr:select_code="cpyrhtCd" th:attr="grpCd=241,selectedCd=${book.cpyrhtCd}" firstOptTxt="- 전체 -" isAdmin="true" ></span>
                        </div>
                    </div>
                </div>
            </div>
		    <div class="row">
		        <div class="col-12 mb-3">
		            <div class="mb-0 form-group required">
		                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="ttl"><strong>도서명</strong></label>
		                <div class="col-12">
		                    <input type="text" class="form-control form-control-sm" name="ttl" id="ttl" placeholder="제목" th:value="${book.ttl}">
		                </div>
		            </div>
		        </div>
		    </div>
		    <div class="row">
		        <div class="col-12 mb-3">
		            <div class="mb-0 form-group required">
                        <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="cn"><strong>내용</strong></label>
                        <div class="col-12">
                            <textarea class="form-control form-control-sm" name="cn" id="cn" th:value="${book.cn}"><th:block th:text="${book.cn}"></th:block></textarea>
                        </div>
		            </div>
		        </div>
		    </div>
		    <div class="row">
		        <div class="col-12 col-lg-6 mb-3">
		            <div class="mb-0 form-group required">
	                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="rentalRecruitmentMainImage"><strong>대표 이미지 (권장 사이즈 : 000x000)</strong></label>
						<div class="col-sm-12">
						    <input type="file" class="form-control form-control-sm" id="rprsImgFile" name="rprsImgFile"/>
						    <input type="hidden" name="rprsImgFilegrpid" id="rprsImgFilegrpid" th:value="${book.filegrpid}"      >
						    <input type="hidden" name="rprsImgFileid"    id="rprsImgFileid"    th:value="${book.rprsImgFileid}"  >
						</div>
						<div class="mt-2 row">
						    <div class="col-auto">
			                   	<th:block th:if="${fileBtn}">
			                       <div id="fileUploadSuccess" th:utext="${fileBtn}">
			                       </div>
		                        </th:block>
		           		    	<th:block th:unless="${fileBtn}">
			                       <div id="fileUploadSuccess">
			                       </div>
		                    	</th:block>
						    </div>
						</div>
		            </div>
		        </div>
		        <div class="col-12 col-lg-6 mb-3">
		            <div class="mb-0 form-group">
		                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="rentalRecruitmentDetailFile"><strong>첨부파일</strong></label>
		                <div class="col-12">
		                    <input type="file" multiple class="form-control form-control-sm" id="atchFile" name="atchFile"/>
						    <input type="hidden" name="atchFilegrpid" id="atchFilegrpid" value="0">
		                </div>
		                <div class="mt-2 row">
		                    <div class="col-auto">
			                	<div id="multiFileUploadSuccess">
									<th:block th:if="${fileMap} != null">
										<div th:each="item:${fileMap}" class ="label label-inverse text-white" th:id="${item.fileid}">
											<a class='text-white' href="javascript:void(0)" th:name="${item.fileid}" th:onclick="downloadFileByFileid([[${item.fileid}]],[[${item.fileIdntfcKey}]])"><th:block th:text="${item.orginlFileNm}"></th:block>&nbsp;&nbsp;</a>
											<a class='text-white' href="javascript:void(0)" th:onclick="fn_deleteFileList([[${item.fileid}]],[[${item.fileIdntfcKey}]])">X</a>
										</div>
									</th:block>
									<th:block th:unless="${fileMap} != null">
									</th:block>	
			                	</div>
		                    </div>
		                </div>
		            </div>
		        </div>
		    </div>
		    <div class="row">
		        <div class="col-12 col-lg-6 mb-3">
		            <div class="mb-0 form-group">
		                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="registDate"><strong>등록일</strong></label>
		                <div class="col-12">
		                    <input type="text" class="form-control form-control-sm" name="regDt" id="regDt" placeholder="등록일" th:value="${book.regDt}" readonly/>
		                </div>
		            </div>
		        </div>
		        <div class="col-12 col-lg-6 mb-3">
		            <div class="mb-0 form-group">
		                <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="writer"><strong>작성자ID(이름)</strong></label>
		                <div class="col-12">
		                    <input type="text" class="form-control form-control-sm" name="writer" id="writer" placeholder="작성자ID(이름)" th:value="${book.rgtridNm}" readonly/>
		                    <input type="hidden" id="rgtrid" name="rgtrid" th:value="${book.rgtrid}">
		                </div>
		            </div>
		        </div>
		    </div>
		</div>
	    <div class="card-block-small">
	        <button type="button" class="btn btn-disabled m-r-5" id="cancelInsertRgnEnveduCntr" onclick="gridHelper1.toggleContent()">취소</button>
	        <th:block sec:authorize-url="/mng/book/updateBook.do">
	        	<button type="button" class="btn btn-primary" id="updateBook" onclick="fn_updateBook()">저장</button>
	        </th:block>
	    </div>
		<!-- Tab Container End -->
</form>
<script type="text/javascript" src="/files/bower_components/handlebars/handlebars.min.js" charset="utf-8" ></script>
<script  id="subjectFrm" type="text/x-handlebars-template">
    <div class="row mt-1 subject-form" id="subject{{frmNum}}" name="{{frmNum}}"  > 
         <div class="col">
             <select id="subjectSelect{{frmNum}}" name="eduSbjctCds" class="form-select form-select-sm" onchange="duplCheck('{{frmNum}}')">
                 <option value="" >-선택-</option>
                 {{#each list}}
                 <option value="{{CD}}">{{CD_NM}}</option>
                 {{/each}}
             </select>
         </div>
         <div class="mt-sm-0" style="width:100px;">
            <button type="button" class="input-group-text btn btn-primary btn-sm"  onclick="plusSubjectForm()" >+</button>
            <button type="button" class="input-group-text btn btn-primary btn-sm"  onclick="removeSubjectForm('{{frmNum}}')"  {{#if firstKey}}disabled {{/if}}>-</button>
         </div>
     </div>
</script>
<script th:inline="javascript">
	/* 커스텀태그(공통코드) : 교육주제 */
	/*<![CDATA[*/
	var eduSbjctCd = /*[[${book.eduSbjctCd}]]*/null;
	var mainEduSbjctCd = /*[[${book.mainEduSbjctCd}]]*/null;
	var sbjctCdLsit = /*[[${sbjctCdLsit}]]*/null;
	var bookSbjctList = /*[[${bookSbjctList}]]*/null;
	/*]]>*/
	
	/* updateForm setting */
	setUpdateSelectBox.fn_getNextDepthList(155 , 0, 'eduSbjctCd_1', mainEduSbjctCd);
	setUpdateSelectBox.fn_getNextDepthList(155 , mainEduSbjctCd, 'eduSbjctCd_2', eduSbjctCd);
	
	/* editor */
	var editor;

    var subjectLength = 0; 
    var subjectNum = [1]; 
	
	$(function () {
	    editor = CKEDITOR.replace('cn');

	    if(sbjctCdLsit!= null && sbjctCdLsit.length > 0 ){
	         subjectLength = sbjctCdLsit.length 
	     }
	     if(bookSbjctList!= null && bookSbjctList.length >0){
		     //등록되어 있는 교육 주제 폼 넘버   
		     for(var i = 0;i < bookSbjctList.length;i++){
		         subjectNum.push((i+1));
		     }
		 }else{
			 plusSubjectForm('first');
		 }
	});
    duplCheck=(frmNum)=>{
        var isDupl = false;
        var selectCd = $("#subjectSelect"+frmNum).val();
        if(selectCd==""){return;}

        $(".subject-form").each(function(){
            var itemId = ($(this).attr("id")).replace("subject","")
            if( itemId != frmNum  &&  $("#subjectSelect"+itemId).val() == selectCd){
                isDupl = true;
            }
        })
        if(isDupl){
            $("#subjectSelect"+frmNum).val("");
            alert("교육주제는 중복 선택 할 수 없습니다."); 
            return; 
        }
    }
    plusSubjectForm =(firstKey)=>{

        var subjectFormCnt = 0 ; 
        $(".subject-form").each(function(){ subjectFormCnt++ })
        
        if(subjectFormCnt >= subjectLength){
            alert("더이상 생성 할수 없습니다.");
            return;
        }
        var maxValue = Math.max.apply(null, subjectNum);
        subjectNum.push(maxValue+1);
        
        var source = $("#subjectFrm").html();
        var template = Handlebars.compile(source);
        var data = {
                    'frmNum' : maxValue+1
                    ,'list':sbjctCdLsit
                    ,'firstKey':(firstKey==null)? false:true 
                   };
        $("#sbjctArea").append(template(data));
    }

    removeSubjectForm=(frmNum)=>{
        $("#subject"+frmNum).remove();
        var filterArr = subjectNum.filter(function(data) {return data != frmNum;});
        subjectNum = filterArr;
    }
    
	/* validator */
    var validator= $("#bookUpdateForm").validate({
        rules: {
            mainEduSbjctCd   :  { required: true }
            ,eduSbjctCd      :  { required: true }
            ,eduTrgtCd       :  { required: true }
            ,plscmpn         :  { required: true }
            ,amt             :  { number: true }
            ,ttl             :  { required: true }
            ,cn              :  { required: true }
            ,cpyrhtCd        :  { required: true }
        },
        messages: {
            mainEduSbjctCd   :  { required: "교육주제(대분류)를 선택해주십시오." }
            ,eduSbjctCd      :  { required: "교육주제(중분류)를 선택해주십시오." }
            ,eduTrgtCd       :  { required: "교육대상을 선택해주십시오." }
            ,plscmpn         :  { required: "출판사를 입력해주십시오." }
            ,amt             :  { number: "정가는 숫자만 입력해주십시오." }
            ,ttl             :  { required: "제목을 입력해주십시오." }
            ,cn              :  { required: "내용을 입력해주십시오." }
            ,cpyrhtCd        :  { required: "저작권 코드를 선택해주십시오." }
        }
    })
	
	/* 대표이지미 : 단건 */
	$('#rprsImgFile').change(function(event) {
	    var formData = new FormData();
	    var objFile = event.target;
	    var content = "";
	
	    formData.append("file", objFile.files[0]);
	    formData.append("filegrpNm", "book_rprs_img_file");
	    if($('#rprsImgFilegrpid').val() != '')
	        formData.append("filegrpid", $('#rprsImgFilegrpid').val());
	
	    if(displayWorkProgress()){
		    $.ajax({
		        url : '/uploadFile.do',
		        processData : false,
		        contentType : false,
		        data : formData,
		        type : 'POST',
		        success : function(response) {
		            if(response.result == 'fail'){
				        alert(response.msg);
				    }else if(response.filegrpid != undefined && response.filegrpid != ''){
				        $("#rprsImgFilegrpid").val(response.filegrpid);
				        $("#rprsImgFileid").val(response.fileid);
				        content = "<div class ='label label-inverse text-white' id='"+response.fileid+"'><a href=javascript:downloadFileByFileid('"+response.fileid+"','"+response.fileIdntfcKey+"') class='text-white'>"+response.orginlFileNm+"&nbsp;&nbsp;</a>";
	                    content +="<a href=javascript:fn_deleteFileList('"+response.fileid+"','"+response.fileIdntfcKey+"') class='text-white'>X</a></div>";
	                    $('#fileUploadSuccess').html(content);
				    }
				    closeWorkProgress();
		        }
		    });
		}
	    event.preventDefault();
	});
	
	/* 첨부파일 : 다건 */
	$('#atchFile').change(function(event) {
        var objFile = document.querySelector('#atchFile');
        var formData = new FormData();
        var content = "";
        var uploadFileCnt = 0;
        for( i = 0 ; i < objFile.files.length ; i++) {
        	formData.append("files", objFile.files[i]);
            uploadFileCnt++;
        }
        formData.append("filegrpid", $("#atchFilegrpid").val());
        formData.append("filegrpNm", "book_atch_file");
        
		$.ajax({
			url : '/uploadMultipleFiles.do',
			processData : false,
			contentType : false,
			data : formData,
			type : 'POST',
			success : function(response) {
				if(response.result == 'fail'){
					alert(response.msg);
				}else{
					if($("#atchFilegrpid").val()=='0' || $("#atchFilegrpid").val()==''  || $("#atchFilegrpid").val()==null){
						$("#atchFilegrpid").val( response[0].filegrpid );
					}
				
					for(i = 0 ;i < response.length; i++ ){
						content = "<div class='label label-inverse text-white' id='"+response[i].fileid+"'><a href=javascript:downloadFileByFileid('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"') class='text-white'>"+response[i].orginlFileNm+"&nbsp;&nbsp;</a>";
	                    content +="<a href=javascript:fn_deleteFileList('"+response[i].fileid+"','"+response[i].fileIdntfcKey+"') class='text-white'>X</a></div>";
						$('#multiFileUploadSuccess').append(content);
					}
				}
			}
		})
        
		if (detectBrowser() == "other") { 
			$("#atchFile").val("");
		} else {   
			$("#atchFile").replaceWith( $("#atchFile").clone(true)) 
		}
    });
	
	/* 파일삭제 */
	function fn_deleteFileList(fileid, fileIdntfcKey){
	    if(!confirm("파일을 삭제하시겠습니까?")){return;}
	    fn_deleteFile(fileid, fileIdntfcKey);
	    $("#"+fileid).remove();
	    $('#rprsImgFile').val('');
	} 

	function fn_deleteFile(fileid, fileIdntfcKey){
	               
	   var deleteFileUrl="/deleteFile.do?fileid="+fileid+"&file_idntfc_key=" + fileIdntfcKey; 
	   $.ajax({
	       url : deleteFileUrl,
	       type: 'GET',
	       cache : false,
	       dataType: 'json',
	       success : function (data){
	           if(data.result=="success"){
	               $("#"+fileid).remove();
	               $('#rprsImgFileid').val('');
	               $('#rprsImgFilegrpid').val('');
	               $('#rprsImgFile').val('');
	               alert("파일삭제가 완료 되었습니다.");
	           }else{
	               alert("파일삭제중 에러가 발생하였습니다. 관리자에게 문의 부탁드립니다.");
	           }
	       },
	       error : function (error){
	       } 
	   })
	};
	
	/* 수정 */
 	function fn_updateBook(){ 		
  	 	var subjectParamArr=[];
        var errorFrmNum = 0;
        if(subjectNum.length<=0){
            alert("교육 주제를 선택해주십시오.")
            return;
        }else{
           $(".subject-form").each(function(){
                var frmNum = $(this).attr("name");
                subjectParamArr.push($("#subjectSelect"+frmNum).val());
                if($("#subjectSelect"+frmNum).val() == ""){
                    errorFrmNum = (errorFrmNum > 0)? errorFrmNum : frmNum;
                }
           })
        }
        
        if(errorFrmNum > 0){
           alert("교육 주제를 선택해주십시오.");
           showErrorMark("#subjectSelect"+errorFrmNum);
           return;
        }
 		
		if(!$("#bookUpdateForm").valid()) return;
		
 		if($("#rprsImgFileid").val() == '' || $("#rprsImgFileid").val() == null) {
 	 		alert("대표이미지를 첨부해주십시오.");
 	 		showErrorMark("rprsImgFile");
 	 		return;
 		}
        
  	 	if(!confirm("저장하시겠습니까?")) return;
  	 	
  	 	var editorData = editor.getData();
        $("#cn").val(editorData);
  	 	
	    var data =  $("#bookUpdateForm").serialize();

	    if(displayWorkProgress()){
			$.ajax({
				url : "/mng/book/updateBook.do",
				type: 'POST',
				cache : false,
				dataType: 'json',
				data : data,
				success : function (data){
					if(data.result=="success"){
						alert(data.msg);
						gridHelper1.resetPageContent();
					}else{
						alert(data.msg);
					}
					closeWorkProgress();
				}
			});
		}
	}
</script>